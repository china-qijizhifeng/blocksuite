{"version":3,"file":"manager.js","sourceRoot":"","sources":["../../src/selection/manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { DisposableGroup, Slot } from '@blocksuite/global/utils';\nimport type { StackItem } from '@blocksuite/store';\n\nimport type { BaseSelection } from './base.js';\nimport {\n  BlockSelection,\n  CursorSelection,\n  SurfaceSelection,\n  TextSelection,\n} from './variants/index.js';\n\ninterface SelectionConstructor {\n  type: string;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  new (...args: any[]): BaseSelection;\n  fromJSON(json: Record<string, unknown>): BaseSelection;\n}\n\nexport class SelectionManager {\n  private get _store() {\n    return this.std.collection.awarenessStore;\n  }\n\n  get value() {\n    return this._store\n      .getLocalSelection(this.std.doc.blockCollection)\n      .map(json => {\n        return this._jsonToSelection(json);\n      });\n  }\n\n  get remoteSelections() {\n    const map = new Map<number, BaseSelection[]>();\n    this._store.getStates().forEach((state, id) => {\n      if (id === this._store.awareness.clientID) return;\n      const selection = Object.entries(state.selectionV2)\n        .filter(([key]) => key === this.std.doc.id)\n        .flatMap(([_, selection]) => selection);\n      const selections = selection\n        .map(json => {\n          try {\n            return this._jsonToSelection(json);\n          } catch (error) {\n            console.error('Parse remote selection failed:', id, json, error);\n            return null;\n          }\n        })\n        .filter((sel): sel is BaseSelection => !!sel);\n      map.set(id, selections);\n    });\n    return map;\n  }\n\n  private _selectionConstructors: Record<string, SelectionConstructor> = {};\n\n  disposables = new DisposableGroup();\n\n  slots = {\n    changed: new Slot<BaseSelection[]>(),\n    remoteChanged: new Slot<Map<number, BaseSelection[]>>(),\n  };\n\n  constructor(public std: BlockSuite.Std) {\n    this._setupDefaultSelections();\n  }\n\n  private _setupDefaultSelections() {\n    this.register([\n      TextSelection,\n      BlockSelection,\n      SurfaceSelection,\n      CursorSelection,\n    ]);\n  }\n\n  private _jsonToSelection = (json: Record<string, unknown>) => {\n    const ctor = this._selectionConstructors[json.type as string];\n    if (!ctor) {\n      throw new Error(`Unknown selection type: ${json.type}`);\n    }\n    return ctor.fromJSON(json);\n  };\n\n  private _itemAdded = (event: { stackItem: StackItem }) => {\n    event.stackItem.meta.set('selection-state', this.value);\n  };\n\n  private _itemPopped = (event: { stackItem: StackItem }) => {\n    const selection = event.stackItem.meta.get('selection-state');\n    if (selection) {\n      this.set(selection as BaseSelection[]);\n    }\n  };\n\n  register(ctor: SelectionConstructor | SelectionConstructor[]) {\n    [ctor].flat().forEach(ctor => {\n      this._selectionConstructors[ctor.type] = ctor;\n    });\n    return this;\n  }\n\n  create<T extends BlockSuite.SelectionType>(\n    type: T,\n    ...args: ConstructorParameters<BlockSuite.Selection[T]>\n  ): BlockSuite.SelectionInstance[T] {\n    const ctor = this._selectionConstructors[type];\n    if (!ctor) {\n      throw new Error(`Unknown selection type: ${type}`);\n    }\n    return new ctor(...args) as BlockSuite.SelectionInstance[T];\n  }\n\n  fromJSON(json: Record<string, unknown>[]) {\n    const selections = json.map(json => {\n      return this._jsonToSelection(json);\n    });\n    return this.set(selections);\n  }\n\n  set(selections: BaseSelection[]) {\n    this._store.setLocalSelection(\n      this.std.doc.blockCollection,\n      selections.map(s => s.toJSON())\n    );\n    this.slots.changed.emit(selections);\n  }\n\n  setGroup(group: string, selections: BaseSelection[]) {\n    const current = this.value.filter(s => s.group !== group);\n    this.set([...current, ...selections]);\n  }\n\n  getGroup(group: string) {\n    return this.value.filter(s => s.group === group);\n  }\n\n  update(fn: (currentSelections: BaseSelection[]) => BaseSelection[]) {\n    const selections = fn(this.value);\n    this.set(selections);\n  }\n\n  clear(types?: string[]) {\n    if (types) {\n      const values = this.value.filter(\n        selection => !types.includes(selection.type)\n      );\n      this.set(values);\n    } else {\n      this.set([]);\n    }\n  }\n\n  find<T extends BlockSuite.SelectionType>(type: T) {\n    return this.value.find((sel): sel is BlockSuite.SelectionInstance[T] =>\n      sel.is(type)\n    );\n  }\n\n  filter<T extends BlockSuite.SelectionType>(type: T) {\n    return this.value.filter((sel): sel is BlockSuite.SelectionInstance[T] =>\n      sel.is(type)\n    );\n  }\n\n  mount() {\n    if (this.disposables.disposed) {\n      this.disposables = new DisposableGroup();\n    }\n    this.std.doc.history.on('stack-item-added', this._itemAdded);\n    this.std.doc.history.on('stack-item-popped', this._itemPopped);\n    this.disposables.add(\n      this._store.slots.update.on(({ id }) => {\n        if (id === this._store.awareness.clientID) return;\n        this.slots.remoteChanged.emit(this.remoteSelections);\n      })\n    );\n  }\n\n  unmount() {\n    this.std.doc.history.off('stack-item-added', this._itemAdded);\n    this.std.doc.history.off('stack-item-popped', this._itemPopped);\n    this.slots.changed.dispose();\n    this.disposables.dispose();\n    this.clear();\n  }\n\n  dispose() {\n    Object.values(this.slots).forEach(slot => slot.dispose());\n    this.disposables.dispose();\n  }\n}\n"]}