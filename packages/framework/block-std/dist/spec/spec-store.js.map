{"version":3,"file":"spec-store.js","sourceRoot":"","sources":["../../src/spec/spec-store.ts"],"names":[],"mappings":"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","sourcesContent":["import { DisposableGroup, Slot } from '@blocksuite/global/utils';\n\nimport { BlockService } from '../service/index.js';\nimport type { BlockSpec } from './index.js';\nimport { getSlots } from './slots.js';\n\nexport class SpecStore {\n  private _specs = new Map<string, BlockSpec>();\n\n  private _services = new Map<string, BlockService>();\n\n  private _disposables = new DisposableGroup();\n\n  readonly slots = {\n    beforeApply: new Slot(),\n    beforeMount: new Slot(),\n    beforeUnmount: new Slot(),\n    afterApply: new Slot(),\n    afterMount: new Slot(),\n    afterUnmount: new Slot(),\n  };\n\n  constructor(public std: BlockSuite.Std) {}\n\n  private _diffServices(\n    oldSpecs: Map<string, BlockSpec>,\n    newSpecs: Map<string, BlockSpec>\n  ) {\n    oldSpecs.forEach((oldSpec, flavour) => {\n      if (\n        newSpecs.has(flavour) &&\n        newSpecs.get(flavour)?.service === oldSpec.service\n      ) {\n        return;\n      }\n\n      const service = this._services.get(flavour);\n      if (service) {\n        service.dispose();\n        service.unmounted();\n      }\n      this._services.delete(flavour);\n    });\n    newSpecs.forEach((newSpec, flavour) => {\n      if (this._services.has(flavour)) {\n        return;\n      }\n\n      const Service = newSpec.service ?? BlockService;\n\n      const slots = getSlots();\n      const service = new Service({\n        flavour,\n        std: this.std,\n        slots,\n      });\n\n      newSpec.setup?.(slots, this._disposables);\n      this._services.set(flavour, service);\n      service.mounted();\n    });\n  }\n\n  private _buildSpecMap(specs: Array<BlockSpec>) {\n    const specMap = new Map<string, BlockSpec>();\n    specs.forEach(spec => {\n      specMap.set(spec.schema.model.flavour, spec);\n    });\n    return specMap;\n  }\n\n  mount() {\n    this.slots.beforeMount.emit();\n\n    if (this._disposables.disposed) {\n      this._disposables = new DisposableGroup();\n    }\n\n    this.slots.afterMount.emit();\n  }\n\n  unmount() {\n    this.slots.beforeUnmount.emit();\n\n    this._services.forEach(service => {\n      service.dispose();\n      service.unmounted();\n    });\n    this._services.clear();\n    this._disposables.dispose();\n\n    this.slots.afterUnmount.emit();\n  }\n\n  applySpecs(specs: BlockSpec[]) {\n    this.slots.beforeApply.emit();\n\n    const oldSpecs = this._specs;\n    const newSpecs = this._buildSpecMap(specs);\n    this._diffServices(oldSpecs, newSpecs);\n    this._specs = newSpecs;\n\n    this.slots.afterApply.emit();\n  }\n\n  getView(flavour: string) {\n    const spec = this._specs.get(flavour);\n    if (!spec) {\n      return null;\n    }\n\n    return spec.view;\n  }\n\n  getService<Key extends BlockSuite.ServiceKeys>(\n    flavour: Key\n  ): BlockSuite.BlockServices[Key];\n  getService<Service extends BlockService>(flavour: string): Service;\n  getService(flavour: string): BlockService {\n    return this._services.get(flavour) as never;\n  }\n}\n\ndeclare global {\n  namespace BlockSuite {\n    interface BlockServices {}\n\n    type ServiceKeys = string & keyof BlockServices;\n  }\n}\n"]}