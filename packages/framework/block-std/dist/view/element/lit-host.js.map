{"version":3,"file":"lit-host.js","sourceRoot":"","sources":["../../../src/view/element/lit-host.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable lit/binding-positions, lit/no-invalid-html */\n\nimport { handleError } from '@blocksuite/global/exceptions';\nimport { assertExists, Slot } from '@blocksuite/global/utils';\nimport { type BlockModel, BlockViewType, type Doc } from '@blocksuite/store';\nimport {\n  css,\n  LitElement,\n  nothing,\n  type PropertyValues,\n  type TemplateResult,\n} from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport type { StaticValue } from 'lit/static-html.js';\nimport { html, unsafeStatic } from 'lit/static-html.js';\n\nimport type { CommandManager } from '../../command/index.js';\nimport type { UIEventDispatcher } from '../../event/index.js';\nimport { BlockStdScope } from '../../scope/index.js';\nimport type { SelectionManager } from '../../selection/index.js';\nimport type { BlockSpec, SpecStore } from '../../spec/index.js';\nimport { RangeManager } from '../utils/range-manager.js';\nimport { WithDisposable } from '../utils/with-disposable.js';\nimport type { ViewStore } from '../view-store.js';\nimport { ShadowlessElement } from './shadowless-element.js';\n\n@customElement('editor-host')\nexport class EditorHost extends WithDisposable(ShadowlessElement) {\n  get command(): CommandManager {\n    return this.std.command;\n  }\n\n  get event(): UIEventDispatcher {\n    return this.std.event;\n  }\n\n  get selection(): SelectionManager {\n    return this.std.selection;\n  }\n\n  get view(): ViewStore {\n    return this.std.view;\n  }\n\n  get spec(): SpecStore {\n    return this.std.spec;\n  }\n\n  static override styles = css`\n    editor-host {\n      outline: none;\n      isolation: isolate;\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor specs!: BlockSpec[];\n\n  @property({ attribute: false })\n  accessor doc!: Doc;\n\n  @property({ attribute: false })\n  accessor blockIdAttr = 'data-block-id';\n\n  @property({ attribute: false })\n  accessor widgetIdAttr = 'data-widget-id';\n\n  std!: BlockSuite.Std;\n\n  rangeManager: RangeManager | null = null;\n\n  readonly slots = {\n    unmounted: new Slot(),\n  };\n\n  private _renderModel = (model: BlockModel): TemplateResult => {\n    const { flavour } = model;\n    const block = this.doc.getBlock(model.id);\n    if (block?.blockViewType === BlockViewType.Hidden) {\n      return html``;\n    }\n    const schema = this.doc.schema.flavourSchemaMap.get(flavour);\n    const view = this.std.spec.getView(flavour);\n    if (!schema || !block || !view) {\n      console.warn(`Cannot find render flavour ${flavour}.`);\n      return html`${nothing}`;\n    }\n\n    const tag = view.component;\n    const widgets: Record<string, TemplateResult> = view.widgets\n      ? Object.entries(view.widgets).reduce((mapping, [key, tag]) => {\n          const template = html`<${tag}\n            ${unsafeStatic(this.widgetIdAttr)}=${key}\n            .host=${this}\n            .model=${model}\n            .doc=${this.doc}></${tag}>`;\n\n          return {\n            ...mapping,\n            [key]: template,\n          };\n        }, {})\n      : {};\n\n    return html`<${tag}\n      ${unsafeStatic(this.blockIdAttr)}=${model.id}\n      .host=${this}\n      .doc=${this.doc}\n      .model=${model}\n      .widgets=${widgets}\n      .viewType=${block.blockViewType}\n    ></${tag}>`;\n  };\n\n  override willUpdate(changedProperties: PropertyValues) {\n    if (changedProperties.has('specs')) {\n      this.std.spec.applySpecs(this.specs);\n    }\n    super.willUpdate(changedProperties);\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    try {\n      const result = await super.getUpdateComplete();\n      const rootModel = this.doc.root;\n      assertExists(rootModel);\n      const view = this.std.spec.getView(rootModel.flavour);\n      assertExists(view);\n      const widgetTags = Object.values(view.widgets ?? {});\n      const elementsTags = [view.component, ...widgetTags];\n      await Promise.all(\n        elementsTags.map(tag => {\n          const element = this.renderRoot.querySelector(tag._$litStatic$);\n          if (element instanceof LitElement) {\n            return element.updateComplete;\n          }\n          return;\n        })\n      );\n      return result;\n    } catch (e) {\n      if (e instanceof Error) {\n        handleError(e);\n      } else {\n        console.error(e);\n      }\n      return true;\n    }\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (!this.doc.root) {\n      throw new Error(\n        'This doc is missing root block. Please initialize the default block structure before connecting the editor to DOM.'\n      );\n    }\n\n    this.std = new BlockStdScope({\n      host: this,\n      doc: this.doc,\n    });\n\n    this.std.mount();\n    this.std.spec.applySpecs(this.specs);\n    this.rangeManager = new RangeManager(this);\n    this.tabIndex = 0;\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this.std.unmount();\n    this.rangeManager = null;\n    this.slots.unmounted.emit();\n  }\n\n  override render() {\n    const { root } = this.doc;\n    if (!root) return nothing;\n\n    return this._renderModel(root);\n  }\n\n  /**\n   * @deprecated\n   *\n   * This method is deprecated. Use `renderSpecPortal` instead.\n   */\n  renderModel = (model: BlockModel): TemplateResult => {\n    return this._renderModel(model);\n  };\n\n  renderSpecPortal = (doc: Doc, specs: BlockSpec[]) => {\n    return html`\n      <editor-host\n        .doc=${doc}\n        .specs=${specs}\n        contenteditable=\"false\"\n      ></editor-host>\n    `;\n  };\n\n  renderChildren = (model: BlockModel): TemplateResult => {\n    return html`${repeat(\n      model.children,\n      child => child.id,\n      child => this._renderModel(child)\n    )}`;\n  };\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'editor-host': EditorHost;\n  }\n\n  namespace BlockSuite {\n    interface ComponentType {\n      lit: StaticValue;\n    }\n  }\n}\n"]}