{"version":3,"file":"block-element.js","sourceRoot":"","sources":["../../../src/view/element/block-element.ts"],"names":[],"mappings":"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","sourcesContent":["import { assertExists } from '@blocksuite/global/utils';\nimport type { Doc } from '@blocksuite/store';\nimport { type BlockModel, BlockViewType } from '@blocksuite/store';\nimport { nothing, type PropertyValues, render, type TemplateResult } from 'lit';\nimport { property, state } from 'lit/decorators.js';\nimport { choose } from 'lit/directives/choose.js';\nimport { when } from 'lit/directives/when.js';\nimport { html } from 'lit/static-html.js';\n\nimport type { EventName, UIEventHandler } from '../../event/index.js';\nimport type { BaseSelection } from '../../selection/index.js';\nimport type { BlockService } from '../../service/index.js';\nimport { WithDisposable } from '../utils/with-disposable.js';\nimport type { EditorHost } from './lit-host.js';\nimport { ShadowlessElement } from './shadowless-element.js';\nimport type { WidgetElement } from './widget-element.js';\n\nexport class BlockElement<\n  Model extends BlockModel = BlockModel,\n  Service extends BlockService = BlockService,\n  WidgetName extends string = string,\n> extends WithDisposable(ShadowlessElement) {\n  get parentBlockElement(): BlockElement {\n    const el = this.parentElement;\n    // TODO(mirone/#6534): find a better way to get block element from a node\n    return el?.closest('[data-block-id]') as BlockElement;\n  }\n\n  get childBlockElements() {\n    const childModels = this.model.children;\n    return childModels\n      .map(child => {\n        return this.std.view.getBlock(child.id);\n      })\n      .filter((x): x is BlockElement => !!x);\n  }\n\n  get rootElement(): BlockElement | null {\n    const rootId = this.doc.root?.id;\n    if (!rootId) {\n      return null;\n    }\n    const rootElement = this.host.view.getBlock(rootId);\n    return rootElement ?? null;\n  }\n\n  get topContenteditableElement(): BlockElement | null {\n    return this.rootElement;\n  }\n\n  get flavour(): string {\n    return this.model.flavour;\n  }\n\n  get widgetElements(): Partial<Record<WidgetName, WidgetElement>> {\n    return Object.keys(this.widgets).reduce((mapping, key) => {\n      return {\n        ...mapping,\n        [key]: this.host.view.viewFromPath('widget', [...this.path, key]),\n      };\n    }, {});\n  }\n\n  get selection() {\n    return this.host.selection;\n  }\n\n  get std() {\n    return this.host.std;\n  }\n\n  get blockId() {\n    return this.dataset.blockId as string;\n  }\n\n  get isVersionMismatch() {\n    const schema = this.doc.schema.flavourSchemaMap.get(this.model.flavour);\n    assertExists(\n      schema,\n      `Cannot find schema for flavour ${this.model.flavour}`\n    );\n    const expectedVersion = schema.version;\n    const actualVersion = this.model.version;\n    if (expectedVersion !== actualVersion) {\n      console.warn(\n        `Version mismatch for block ${this.model.id}, expected ${expectedVersion}, actual ${actualVersion}`\n      );\n      return true;\n    }\n\n    return false;\n  }\n\n  @state()\n  protected accessor _renderers: Array<(content: unknown) => unknown> = [\n    this.renderBlock,\n    this._renderMismatchBlock,\n    this._renderViewType,\n  ];\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor model!: Model;\n\n  @property({ attribute: false })\n  accessor content: TemplateResult | null = null;\n\n  @property({ attribute: false })\n  accessor viewType: BlockViewType = BlockViewType.Display;\n\n  @property({\n    attribute: false,\n    hasChanged(value, oldValue) {\n      if (!value || !oldValue) {\n        return value !== oldValue;\n      }\n      // Is empty object\n      if (!Object.keys(value).length && !Object.keys(oldValue).length) {\n        return false;\n      }\n      return value !== oldValue;\n    },\n  })\n  accessor widgets!: Record<WidgetName, TemplateResult>;\n\n  @property({ attribute: false })\n  accessor doc!: Doc;\n\n  @property({ attribute: false })\n  accessor dirty = false;\n\n  @state({\n    hasChanged(value: BaseSelection | null, oldValue: BaseSelection | null) {\n      if (!value || !oldValue) {\n        return value !== oldValue;\n      }\n\n      return !value?.equals(oldValue);\n    },\n  })\n  accessor selected: BaseSelection | null = null;\n\n  service!: Service;\n\n  path!: string[];\n\n  private _renderViewType(content: unknown) {\n    return choose(this.viewType, [\n      [BlockViewType.Display, () => content],\n      [BlockViewType.Hidden, () => nothing],\n      [BlockViewType.Bypass, () => this.renderChildren(this.model)],\n    ]);\n  }\n\n  private _renderMismatchBlock(content: unknown) {\n    return when(\n      this.isVersionMismatch,\n      () => {\n        const schema = this.doc.schema.flavourSchemaMap.get(this.model.flavour);\n        assertExists(\n          schema,\n          `Cannot find schema for flavour ${this.model.flavour}`\n        );\n        const expectedVersion = schema.version;\n        const actualVersion = this.model.version;\n        return this.renderVersionMismatch(expectedVersion, actualVersion);\n      },\n      () => content\n    );\n  }\n\n  protected override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    await Promise.all(this.childBlockElements.map(el => el.updateComplete));\n    return result;\n  }\n\n  protected override update(changedProperties: PropertyValues): void {\n    // In some cases, the DOM structure is directly modified, causing Lit to lose synchronization with the DOM structure.\n    // We can restore this state through the `dirty` property.\n    if (this.dirty) {\n      // Here we made some hacks by referring to the source code of Lit.\n      // https://github.com/lit/lit/blob/273ad4e23b8ec97f1a5015dbf398104f535f9c34/packages/lit-element/src/lit-element.ts#L162-L163\n      // https://github.com/lit/lit/blob/273ad4e23b8ec97f1a5015dbf398104f535f9c34/packages/reactive-element/src/reactive-element.ts#L1586-L1589\n      // https://github.com/lit/lit/blob/273ad4e23b8ec97f1a5015dbf398104f535f9c34/packages/reactive-element/src/reactive-element.ts#L1509-L1512\n      //@ts-ignore\n      this.__reflectingProperties &&= this.__reflectingProperties.forEach(p =>\n        //@ts-ignore\n        this.__propertyToAttribute(p, this[p as keyof this])\n      ) as undefined;\n      //@ts-ignore\n      this._$changedProperties = new Map();\n      this.isUpdatePending = false;\n      //@ts-ignore\n      this.__childPart = render(nothing, this.renderRoot);\n\n      this.updateComplete\n        .then(() => {\n          this.dirty = false;\n        })\n        .catch(console.error);\n    } else {\n      super.update(changedProperties);\n    }\n  }\n\n  handleEvent = (\n    name: EventName,\n    handler: UIEventHandler,\n    options?: { global?: boolean; flavour?: boolean }\n  ) => {\n    assertExists(this.path, 'Cannot bind block level hotkey without path');\n    const config = {\n      flavour: options?.global\n        ? undefined\n        : options?.flavour\n          ? this.model.flavour\n          : undefined,\n      path: options?.global || options?.flavour ? undefined : this.path,\n    };\n    this._disposables.add(this.host.event.add(name, handler, config));\n  };\n\n  bindHotKey(\n    keymap: Record<string, UIEventHandler>,\n    options?: { global?: boolean; flavour?: boolean }\n  ) {\n    assertExists(this.path, 'Cannot bind block level hotkey without path');\n    const config = {\n      flavour: options?.global\n        ? undefined\n        : options?.flavour\n          ? this.model.flavour\n          : undefined,\n      path: options?.global || options?.flavour ? undefined : this.path,\n    };\n    const dispose = this.host.event.bindHotkey(keymap, config);\n    this._disposables.add(dispose);\n    return dispose;\n  }\n\n  renderChildren = (model: BlockModel): TemplateResult => {\n    return this.host.renderChildren(model);\n  };\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.std.view.setBlock(this);\n    const disposable = this.std.doc.slots.blockUpdated.on(({ type, id }) => {\n      if (id === this.model.id && type === 'delete') {\n        this.std.view.deleteBlock(this);\n        disposable.dispose();\n      }\n    });\n\n    this.service = this.host.std.spec.getService(this.model.flavour);\n    this.path = this.host.view.calculatePath(this.model);\n\n    this._disposables.add(disposable);\n\n    this._disposables.add(\n      this.model.propsUpdated.on(() => {\n        this.requestUpdate();\n      })\n    );\n\n    this._disposables.add(\n      this.model.childrenUpdated.on(() => {\n        this.requestUpdate();\n      })\n    );\n\n    this._disposables.add(\n      this.host.selection.slots.changed.on(selections => {\n        const selection = selections.find(selection => {\n          return selection.blockId === this.blockId;\n        });\n\n        if (!selection) {\n          this.selected = null;\n          return;\n        }\n\n        this.selected = selection;\n      })\n    );\n\n    this.service.specSlots.viewConnected.emit({\n      service: this.service,\n      component: this,\n    });\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n\n    this.service.specSlots.viewDisconnected.emit({\n      service: this.service,\n      component: this,\n    });\n  }\n\n  renderBlock(): unknown {\n    return nothing;\n  }\n\n  renderVersionMismatch(\n    expectedVersion: number,\n    actualVersion: number\n  ): TemplateResult {\n    return html`\n      <dl class=\"version-mismatch-warning\" contenteditable=\"false\">\n        <dt>\n          <h4>Block Version Mismatched</h4>\n        </dt>\n        <dd>\n          <p>\n            We can not render this <var>${this.model.flavour}</var> block\n            because the version is mismatched.\n          </p>\n          <p>Editor version: <var>${expectedVersion}</var></p>\n          <p>Data version: <var>${actualVersion}</var></p>\n        </dd>\n      </dl>\n    `;\n  }\n\n  addRenderer(renderer: (content: unknown) => unknown) {\n    this._renderers.push(renderer);\n  }\n\n  override render() {\n    return this._renderers.reduce(\n      (acc, cur) => cur.call(this, acc),\n      nothing as unknown\n    );\n  }\n}\n"]}