{"version":3,"file":"view-store.js","sourceRoot":"","sources":["../../src/view/view-store.ts"],"names":[],"mappings":"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","sourcesContent":["import { assertExists } from '@blocksuite/global/utils';\nimport type { BlockModel } from '@blocksuite/store';\n\nimport type { BlockElement, WidgetElement } from './element/index.js';\n\nexport class ViewStore {\n  private readonly _blockMap = new Map<string, BlockElement>();\n\n  private readonly _widgetMap = new Map<string, WidgetElement>();\n\n  constructor(public std: BlockSuite.Std) {}\n\n  setBlock = (node: BlockElement) => {\n    this._blockMap.set(node.model.id, node);\n  };\n\n  setWidget = (node: WidgetElement) => {\n    const id = node.dataset.widgetId as string;\n    const widgetIndex = `${node.model.id}|${id}`;\n    this._widgetMap.set(widgetIndex, node);\n  };\n\n  getBlock = (id: string): BlockElement | null => {\n    return this._blockMap.get(id) ?? null;\n  };\n\n  getWidget = (\n    widgetName: string,\n    hostBlockId: string\n  ): WidgetElement | null => {\n    const widgetIndex = `${hostBlockId}|${widgetName}`;\n    return this._widgetMap.get(widgetIndex) ?? null;\n  };\n\n  deleteBlock = (node: BlockElement) => {\n    this._blockMap.delete(node.id);\n  };\n\n  deleteWidget = (node: WidgetElement) => {\n    const id = node.dataset.widgetId as string;\n    const widgetIndex = `${node.model.id}|${id}`;\n    this._widgetMap.delete(widgetIndex);\n  };\n\n  calculatePath = (model: BlockModel): string[] => {\n    const path: string[] = [];\n    let current: BlockModel | null = model;\n    while (current) {\n      path.push(current.id);\n      current = this.std.doc.getParent(current);\n    }\n    return path.reverse();\n  };\n\n  fromPath = (path: string | undefined | null): BlockElement | null => {\n    const id = path ?? this.std.doc.root?.id;\n    if (!id) {\n      return null;\n    }\n    return this._blockMap.get(id) ?? null;\n  };\n\n  viewFromPath(type: 'block', path: string[]): null | BlockElement;\n  viewFromPath(type: 'widget', path: string[]): null | WidgetElement;\n  viewFromPath(\n    type: 'block' | 'widget',\n    path: string[]\n  ): null | BlockElement | WidgetElement {\n    if (type === 'block') {\n      return this.fromPath(path[path.length - 1]);\n    }\n    const temp = path.slice(-2) as [string, string];\n    const widgetId = temp.join('|');\n    return this._widgetMap.get(widgetId) ?? null;\n  }\n\n  walkThrough = (\n    fn: (\n      nodeView: BlockElement,\n      index: number,\n      parent: BlockElement\n    ) => undefined | null | true,\n    path?: string | undefined | null\n  ) => {\n    const tree = this.fromPath(path);\n    assertExists(tree, `Invalid path to get node in view: ${path}`);\n\n    const iterate =\n      (parent: BlockElement) => (node: BlockElement, index: number) => {\n        const result = fn(node, index, parent);\n        if (result === true) {\n          return;\n        }\n        const children = node.model.children;\n        children.forEach(child => {\n          const childNode = this._blockMap.get(child.id);\n          if (childNode) {\n            iterate(node)(childNode, children.indexOf(child));\n          }\n        });\n      };\n\n    tree.model.children.forEach(child => {\n      const childNode = this._blockMap.get(child.id);\n      if (childNode) {\n        iterate(childNode)(childNode, tree.model.children.indexOf(child));\n      }\n    });\n  };\n\n  mount() {}\n\n  unmount() {\n    this._blockMap.clear();\n    this._widgetMap.clear();\n  }\n}\n"]}