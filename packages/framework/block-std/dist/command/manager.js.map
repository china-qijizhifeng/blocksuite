{"version":3,"file":"manager.js","sourceRoot":"","sources":["../../src/command/manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { cmdSymbol } from './consts.js';\nimport type {\n  Chain,\n  Command,\n  ExecCommandResult,\n  IfAllKeysOptional,\n  InDataOfCommand,\n  InitCommandCtx,\n} from './types.js';\n\nexport class CommandManager {\n  private _commands = new Map<string, Command>();\n\n  constructor(public std: BlockSuite.Std) {}\n\n  private _getCommandCtx = (): InitCommandCtx => {\n    return {\n      std: this.std,\n    };\n  };\n\n  private _createChain = (\n    methods: Record<BlockSuite.CommandName, unknown>,\n    _cmds: Command[]\n  ): Chain => {\n    const getCommandCtx = this._getCommandCtx;\n    const createChain = this._createChain;\n    const chain = this.chain;\n\n    return {\n      [cmdSymbol]: _cmds,\n      run: function (this: Chain) {\n        let ctx = getCommandCtx();\n        let success = false;\n        try {\n          const cmds = this[cmdSymbol];\n          ctx = runCmds(ctx as BlockSuite.CommandContext, [\n            ...cmds,\n            (_, next) => {\n              success = true;\n              next();\n            },\n          ]);\n        } catch (err) {\n          console.error(err);\n        }\n\n        return [success, ctx];\n      },\n      with: function (this: Chain, value) {\n        const cmds = this[cmdSymbol];\n        return createChain(methods, [\n          ...cmds,\n          (_, next) => next(value),\n        ]) as never;\n      },\n      inline: function (this: Chain, command) {\n        const cmds = this[cmdSymbol];\n        return createChain(methods, [...cmds, command]) as never;\n      },\n      try: function (this: Chain, fn) {\n        const cmds = this[cmdSymbol];\n        return createChain(methods, [\n          ...cmds,\n          (beforeCtx, next) => {\n            let ctx = beforeCtx;\n            const chains = fn(chain());\n\n            chains.some(chain => {\n              // inject ctx in the beginning\n              chain[cmdSymbol] = [\n                (_, next) => {\n                  next(ctx);\n                },\n                ...chain[cmdSymbol],\n              ];\n\n              const [success] = chain\n                .inline((branchCtx, next) => {\n                  ctx = { ...ctx, ...branchCtx };\n                  next();\n                })\n                .run();\n              if (success) {\n                next(ctx);\n                return true;\n              }\n              return false;\n            });\n          },\n        ]) as never;\n      },\n      tryAll: function (this: Chain, fn) {\n        const cmds = this[cmdSymbol];\n        return createChain(methods, [\n          ...cmds,\n          (beforeCtx, next) => {\n            let ctx = beforeCtx;\n            const chains = fn(chain());\n\n            let allFail = true;\n            chains.forEach(chain => {\n              // inject ctx in the beginning\n              chain[cmdSymbol] = [\n                (_, next) => {\n                  next(ctx);\n                },\n                ...chain[cmdSymbol],\n              ];\n\n              const [success] = chain\n                .inline((branchCtx, next) => {\n                  ctx = { ...ctx, ...branchCtx };\n                  next();\n                })\n                .run();\n              if (success) {\n                allFail = false;\n              }\n            });\n            if (!allFail) {\n              next(ctx);\n            }\n          },\n        ]) as never;\n      },\n      ...methods,\n    } as Chain;\n  };\n\n  add<N extends BlockSuite.CommandName>(\n    name: N,\n    command: BlockSuite.Commands[N]\n  ): CommandManager;\n  add(name: string, command: Command) {\n    this._commands.set(name, command);\n    return this;\n  }\n\n  chain = (): Chain<InitCommandCtx> => {\n    const methods = {} as Record<\n      string,\n      (data: Record<string, unknown>) => Chain\n    >;\n    const createChain = this._createChain;\n    for (const [name, command] of this._commands.entries()) {\n      methods[name] = function (\n        this: { [cmdSymbol]: Command[] },\n        data: Record<string, unknown>\n      ) {\n        const cmds = this[cmdSymbol];\n        return createChain(methods, [\n          ...cmds,\n          (ctx, next) => command({ ...ctx, ...data }, next),\n        ]);\n      };\n    }\n\n    return createChain(methods, []) as never;\n  };\n\n  exec<K extends keyof BlockSuite.Commands>(\n    command: K,\n    ...args: IfAllKeysOptional<\n      Omit<InDataOfCommand<BlockSuite.Commands[K]>, keyof InitCommandCtx>,\n      [\n        inData: void | Omit<\n          InDataOfCommand<BlockSuite.Commands[K]>,\n          keyof InitCommandCtx\n        >,\n      ],\n      [\n        inData: Omit<\n          InDataOfCommand<BlockSuite.Commands[K]>,\n          keyof InitCommandCtx\n        >,\n      ]\n    >\n  ): ExecCommandResult<K> {\n    const cmdFunc = this._commands.get(command);\n\n    if (!cmdFunc) {\n      throw new Error(`The command \"${command}\" not found`);\n    }\n\n    const inData = args[0];\n    const ctx = {\n      ...this._getCommandCtx(),\n      ...inData,\n    };\n\n    let execResult: ExecCommandResult<K> = {} as ExecCommandResult<K>;\n\n    cmdFunc(ctx, result => {\n      // @ts-ignore\n      execResult = result ?? {};\n    });\n\n    return execResult;\n  }\n}\n\nfunction runCmds(ctx: BlockSuite.CommandContext, [cmd, ...rest]: Command[]) {\n  let _ctx = ctx;\n  if (cmd) {\n    cmd(ctx, data => {\n      _ctx = runCmds({ ...ctx, ...data }, rest);\n    });\n  }\n  return _ctx;\n}\n"]}