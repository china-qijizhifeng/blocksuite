{"version":3,"file":"pointer.js","sourceRoot":"","sources":["../../../src/event/control/pointer.ts"],"names":[],"mappings":"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","sourcesContent":["import { assertExists } from '@blocksuite/global/utils';\n\nimport { UIEventState, UIEventStateContext } from '../base.js';\nimport type { UIEventDispatcher } from '../dispatcher.js';\nimport { PointerEventState } from '../state/index.js';\nimport { EventScopeSourceType, EventSourceState } from '../state/source.js';\nimport { isFarEnough } from '../utils.js';\n\nexport class PointerControl {\n  private get _rect() {\n    return this._dispatcher.host.getBoundingClientRect();\n  }\n\n  private _lastPointerDownEvent: PointerEvent | null = null;\n\n  private _startDragState: PointerEventState | null = null;\n\n  private _lastDragState: PointerEventState | null = null;\n\n  private _pointerDownCount = 0;\n\n  private _dragging = false;\n\n  private _startX = -Infinity;\n\n  private _startY = -Infinity;\n\n  constructor(private _dispatcher: UIEventDispatcher) {}\n\n  private _reset = () => {\n    this._startX = -Infinity;\n    this._startY = -Infinity;\n    this._lastDragState = null;\n    this._dragging = false;\n  };\n\n  private _createContext(event: Event, pointerState: PointerEventState) {\n    return UIEventStateContext.from(\n      new UIEventState(event),\n      new EventSourceState({\n        event,\n        sourceType: EventScopeSourceType.Target,\n      }),\n      pointerState\n    );\n  }\n\n  private _down = (event: PointerEvent) => {\n    if (\n      this._lastPointerDownEvent &&\n      event.timeStamp - this._lastPointerDownEvent.timeStamp < 500 &&\n      !isFarEnough(event, this._lastPointerDownEvent)\n    ) {\n      this._pointerDownCount++;\n    } else {\n      this._pointerDownCount = 1;\n    }\n\n    const pointerEventState = new PointerEventState({\n      event,\n      rect: this._rect,\n      startX: this._startX,\n      startY: this._startY,\n      last: null,\n    });\n\n    this._startX = pointerEventState.point.x;\n    this._startY = pointerEventState.point.y;\n    this._startDragState = pointerEventState;\n    this._lastDragState = pointerEventState;\n    this._lastPointerDownEvent = event;\n\n    this._dispatcher.run(\n      'pointerDown',\n      this._createContext(event, pointerEventState)\n    );\n\n    this._dispatcher.disposables.addFromEvent(\n      document,\n      'pointermove',\n      this._move\n    );\n    this._dispatcher.disposables.addFromEvent(document, 'pointerup', this._up);\n  };\n\n  private _up = (event: PointerEvent) => {\n    const pointerEventState = new PointerEventState({\n      event,\n      rect: this._rect,\n      startX: this._startX,\n      startY: this._startY,\n      last: this._lastDragState,\n    });\n    const context = this._createContext(event, pointerEventState);\n\n    const run = () => {\n      if (this._dragging) {\n        this._dispatcher.run('dragEnd', context);\n        return;\n      }\n      this._dispatcher.run('click', context);\n      if (this._pointerDownCount === 2) {\n        this._dispatcher.run('doubleClick', context);\n      }\n      if (this._pointerDownCount === 3) {\n        this._dispatcher.run('tripleClick', context);\n      }\n    };\n\n    run();\n    this._dispatcher.run('pointerUp', context);\n\n    this._reset();\n    document.removeEventListener('pointermove', this._move);\n    document.removeEventListener('pointerup', this._up);\n  };\n\n  private _move = (event: PointerEvent) => {\n    const last = this._lastDragState;\n    const state = new PointerEventState({\n      event,\n      rect: this._rect,\n      startX: this._startX,\n      startY: this._startY,\n      last,\n    });\n    this._lastDragState = state;\n\n    assertExists(this._startDragState);\n\n    if (!this._dragging && isFarEnough(this._startDragState.raw, state.raw)) {\n      this._dragging = true;\n      this._dispatcher.run(\n        'dragStart',\n        this._createContext(event, this._startDragState)\n      );\n    }\n\n    if (this._dragging) {\n      this._dispatcher.run('dragMove', this._createContext(event, state));\n    }\n  };\n\n  private _moveOn = (event: PointerEvent) => {\n    const state = new PointerEventState({\n      event,\n      rect: this._rect,\n      startX: this._startX,\n      startY: this._startY,\n      last: this._lastDragState,\n    });\n\n    this._dispatcher.run('pointerMove', this._createContext(event, state));\n  };\n\n  private _out = (event: PointerEvent) => {\n    const state = new PointerEventState({\n      event,\n      rect: this._rect,\n      startX: -Infinity,\n      startY: -Infinity,\n      last: null,\n    });\n\n    this._dispatcher.run('pointerOut', this._createContext(event, state));\n  };\n\n  listen() {\n    this._dispatcher.disposables.addFromEvent(\n      this._dispatcher.host,\n      'pointerdown',\n      this._down\n    );\n    this._dispatcher.disposables.addFromEvent(\n      this._dispatcher.host,\n      'pointermove',\n      this._moveOn\n    );\n    this._dispatcher.disposables.addFromEvent(\n      this._dispatcher.host,\n      'pointerout',\n      this._out\n    );\n  }\n}\n"]}