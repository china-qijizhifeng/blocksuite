{"version":3,"file":"dispatcher.js","sourceRoot":"","sources":["../../src/event/dispatcher.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,eAAe,EAAE,IAAI,EAAE,MAAM,0BAA0B,CAAC;AAGjE,OAAO,EAAE,UAAU,EAAE,MAAM,mBAAmB,CAAC;AAE/C,OAAO,EAEL,YAAY,EACZ,mBAAmB,GACpB,MAAM,WAAW,CAAC;AACnB,OAAO,EAAE,gBAAgB,EAAE,MAAM,wBAAwB,CAAC;AAC1D,OAAO,EAAE,eAAe,EAAE,MAAM,uBAAuB,CAAC;AACxD,OAAO,EAAE,cAAc,EAAE,MAAM,sBAAsB,CAAC;AACtD,OAAO,EAAE,YAAY,EAAE,MAAM,oBAAoB,CAAC;AAClD,OAAO,EAAE,oBAAoB,EAAE,gBAAgB,EAAE,MAAM,mBAAmB,CAAC;AAC3E,OAAO,EAAE,WAAW,EAAE,MAAM,YAAY,CAAC;AAEzC,MAAM,gBAAgB,GAAG;IACvB,aAAa;IAEb,MAAM;IACN,OAAO;IACP,MAAM;IACN,aAAa;IACb,OAAO;CACC,CAAC;AAEX,MAAM,UAAU,GAAG;IACjB,OAAO;IACP,aAAa;IACb,aAAa;IAEb,aAAa;IACb,aAAa;IACb,WAAW;IACX,YAAY;IAEZ,WAAW;IACX,UAAU;IACV,SAAS;IAET,SAAS;IACT,OAAO;IAEP,iBAAiB;IACjB,kBAAkB;IAClB,mBAAmB;IACnB,gBAAgB;IAEhB,KAAK;IACL,MAAM;IACN,OAAO;IAEP,GAAG,gBAAgB;CACX,CAAC;AAmBX,MAAM,OAAO,iBAAiB;IAC5B,IAAI,MAAM;QACR,OAAO,IAAI,CAAC,OAAO,CAAC;IACtB,CAAC;IAED,IAAI,IAAI;QACN,OAAO,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC;IACvB,CAAC;IAED,IAAY,kBAAkB;QAC5B,OAAO,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,KAAK,CAAC;IAClC,CAAC;IA4BD,YAAmB,GAAmB;QAAnB,QAAG,GAAH,GAAG,CAAgB;QA1B9B,iBAAY,GAAG,MAAM,CAAC,WAAW,CACvC,UAAU,CAAC,GAAG,CAAC,CAAC,IAAI,EAA0C,EAAE,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC,CAC7B,CAAC;QAU1C,YAAO,GAAG,KAAK,CAAC;QAExB,gBAAW,GAAG,IAAI,eAAe,EAAE,CAAC;QAEpC;;;;WAIG;QACH,UAAK,GAAG;YACN,kBAAkB,EAAE,IAAI,IAAI,EAAU;YACtC,gBAAgB,EAAE,IAAI,IAAI,EAAE;SAC7B,CAAC;QA4DM,mBAAc,GAAG,CAAC,KAAiB,EAAY,EAAE;YACvD,MAAM,IAAI,GAAa,EAAE,CAAC;YAC1B,IAAI,OAAO,GAAsB,KAAK,CAAC;YACvC,OAAO,OAAO,EAAE,CAAC;gBACf,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;gBACtB,OAAO,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;YAC5C,CAAC;YACD,OAAO,IAAI,CAAC,OAAO,EAAE,CAAC;QACxB,CAAC,CAAC;QA4IF,eAAU,GAAG,CAAC,GAAG,IAA+C,EAAE,EAAE,CAClE,IAAI,CAAC,gBAAgB,CAAC,UAAU,CAAC,GAAG,IAAI,CAAC,CAAC;QA9M1C,IAAI,CAAC,eAAe,GAAG,IAAI,cAAc,CAAC,IAAI,CAAC,CAAC;QAChD,IAAI,CAAC,gBAAgB,GAAG,IAAI,eAAe,CAAC,IAAI,CAAC,CAAC;QAClD,IAAI,CAAC,aAAa,GAAG,IAAI,YAAY,CAAC,IAAI,CAAC,CAAC;QAC5C,IAAI,CAAC,iBAAiB,GAAG,IAAI,gBAAgB,CAAC,IAAI,CAAC,CAAC;IACtD,CAAC;IAEO,cAAc,CAAC,IAAe,EAAE,KAAuB;QAC7D,MAAM,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;QACzC,IAAI,CAAC,QAAQ;YAAE,OAAO;QAEtB,IAAI,MAA8B,CAAC;QAEnC,QAAQ,KAAK,CAAC,UAAU,EAAE,CAAC;YACzB,KAAK,oBAAoB,CAAC,SAAS,CAAC,CAAC,CAAC;gBACpC,MAAM,GAAG,IAAI,CAAC,2BAA2B,CAAC,IAAI,CAAC,CAAC;gBAChD,MAAM;YACR,CAAC;YACD,KAAK,oBAAoB,CAAC,MAAM,CAAC,CAAC,CAAC;gBACjC,MAAM,GAAG,IAAI,CAAC,wBAAwB,CACpC,IAAI,EACJ,KAAK,CAAC,KAAK,CAAC,MAAc,CAC3B,CAAC;gBACF,MAAM;YACR,CAAC;YACD,OAAO,CAAC,CAAC,CAAC;gBACR,MAAM,IAAI,KAAK,CAAC,+BAA+B,KAAK,CAAC,UAAU,EAAE,CAAC,CAAC;YACrE,CAAC;QACH,CAAC;QAED,OAAO,MAAM,CAAC;IAChB,CAAC;IAEO,wBAAwB,CAAC,IAAe,EAAE,MAAY;QAC5D,MAAM,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;QACzC,IAAI,CAAC,QAAQ;YAAE,OAAO;QAEtB,yEAAyE;QACzE,MAAM,EAAE,GAAG,MAAM,YAAY,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,MAAM,CAAC,aAAa,CAAC;QACrE,MAAM,KAAK,GAAG,EAAE,EAAE,OAAO,CAAe,iBAAiB,CAAC,CAAC;QAE3D,MAAM,IAAI,GAAG,KAAK,EAAE,IAAI,CAAC;QACzB,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,OAAO,IAAI,CAAC,2BAA2B,CAAC,IAAI,CAAC,CAAC;QAChD,CAAC;QAED,MAAM,QAAQ,GAAG,IAAI;aAClB,GAAG,CAAC,OAAO,CAAC,EAAE;YACb,OAAO,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC,OAAO,CAAC,EAAE,OAAO,CAAC;QACrD,CAAC,CAAC;aACD,MAAM,CAAC,CAAC,OAAO,EAAqB,EAAE;YACrC,OAAO,CAAC,CAAC,OAAO,CAAC;QACnB,CAAC,CAAC;aACD,OAAO,EAAE,CAAC;QAEb,OAAO,IAAI,CAAC,eAAe,CAAC,IAAI,EAAE,QAAQ,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC;IACtD,CAAC;IAYO,2BAA2B,CAAC,IAAe;QACjD,MAAM,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;QACzC,IAAI,CAAC,QAAQ;YAAE,OAAO;QAEtB,MAAM,UAAU,GAAG,IAAI,CAAC,kBAAkB,CAAC;QAC3C,MAAM,IAAI,GAA4B,EAAE,CAAC;QAEzC,MAAM,KAAK,GAAG,UAAU;aACrB,GAAG,CAAC,SAAS,CAAC,EAAE,CAAC,SAAS,CAAC,OAAO,CAAC;aACnC,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC;aACxC,MAAM,CAAC,CAAC,KAAK,EAAuB,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC;aAC/C,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC,CAAC;QAE5C,MAAM,QAAQ,GAAG,KAAK;aACnB,OAAO,CAAC,IAAI,CAAC,EAAE,CACd,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC,OAAO,CAAC,EAAE,OAAO,CAAC,CACjE;aACA,MAAM,CAAC,CAAC,OAAO,EAAqB,EAAE;YACrC,IAAI,CAAC,OAAO;gBAAE,OAAO,KAAK,CAAC;YAC3B,IAAI,IAAI,CAAC,OAAO,CAAC;gBAAE,OAAO,KAAK,CAAC;YAChC,IAAI,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC;YACrB,OAAO,IAAI,CAAC;QACd,CAAC,CAAC;aACD,OAAO,EAAE,CAAC;QAEb,OAAO,IAAI,CAAC,eAAe,CAAC,IAAI,EAAE,QAAQ,EAAE,KAAK,CAAC,CAAC;IACrD,CAAC;IAEO,WAAW;QACjB,gBAAgB,CAAC,OAAO,CAAC,SAAS,CAAC,EAAE;YACnC,IAAI,CAAC,WAAW,CAAC,YAAY,CAC3B,IAAI,CAAC,IAAI,EACT,WAAW,CAAC,SAAS,CAAC,EACtB,KAAK,CAAC,EAAE;gBACN,IAAI,CAAC,GAAG,CACN,SAAS,EACT,mBAAmB,CAAC,IAAI,CACtB,IAAI,YAAY,CAAC,KAAK,CAAC,EACvB,IAAI,gBAAgB,CAAC;oBACnB,KAAK;oBACL,UAAU,EAAE,oBAAoB,CAAC,SAAS;iBAC3C,CAAC,CACH,CACF,CAAC;YACJ,CAAC,EACD,SAAS,KAAK,OAAO;gBACnB,CAAC,CAAC;oBACE,OAAO,EAAE,KAAK;iBACf;gBACH,CAAC,CAAC,SAAS,CACd,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,eAAe,CAAC,MAAM,EAAE,CAAC;QAC9B,IAAI,CAAC,gBAAgB,CAAC,MAAM,EAAE,CAAC;QAC/B,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE,CAAC;QAC5B,IAAI,CAAC,iBAAiB,CAAC,MAAM,EAAE,CAAC;QAEhC,IAAI,SAAS,GAAG,KAAK,CAAC;QACtB,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE,aAAa,EAAE,GAAG,EAAE;YAC3D,SAAS,GAAG,IAAI,CAAC;YACjB,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;QACtB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE,WAAW,EAAE,GAAG,EAAE;YACzD,SAAS,GAAG,KAAK,CAAC;QACpB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE,OAAO,EAAE,GAAG,EAAE;YACrD,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;QACtB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE,SAAS,EAAE,GAAG,EAAE;YACvD,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;QACtB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE,UAAU,EAAE,CAAC,CAAC,EAAE;YACvD,IAAI,CAAC,CAAC,aAAa,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,aAAqB,CAAC,EAAE,CAAC;gBACpE,IAAI,CAAC,OAAO,GAAG,KAAK,CAAC;YACvB,CAAC;QACH,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE,cAAc,EAAE,GAAG,EAAE;YAC5D,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;QACtB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,EAAE,cAAc,EAAE,GAAG,EAAE;YAC5D,IACE,CAAC,CAAC,QAAQ,CAAC,aAAa;gBACtB,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,aAAa,CAAC,CAAC;gBAC9C,CAAC,SAAS,EACV,CAAC;gBACD,IAAI,CAAC,OAAO,GAAG,KAAK,CAAC;YACvB,CAAC;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,KAAK;QACH,IAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE,CAAC;YAC9B,IAAI,CAAC,WAAW,GAAG,IAAI,eAAe,EAAE,CAAC;QAC3C,CAAC;QACD,IAAI,CAAC,WAAW,EAAE,CAAC;IACrB,CAAC;IAED,OAAO;QACL,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC;IAC7B,CAAC;IAED,GAAG,CAAC,IAAe,EAAE,OAA4B,EAAE,KAAkB;QACnE,IAAI,CAAC,IAAI,CAAC,MAAM;YAAE,OAAO;QAEzB,MAAM,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;QAC/C,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,KAAK,GAAG,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,WAAW,CAAC,CAAC;YAC/C,IAAI,CAAC,KAAK,EAAE,CAAC;gBACX,OAAO;YACT,CAAC;QACH,CAAC;QACD,KAAK,MAAM,MAAM,IAAI,KAAK,CAAC,OAAO,EAAE,CAAC;YACnC,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,CAAC;YACtB,MAAM,MAAM,GAAG,EAAE,CAAC,OAAO,CAAC,CAAC;YAC3B,IAAI,MAAM,EAAE,CAAC;gBACX,OAAO,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC,KAAK,CAAC,eAAe,EAAE,CAAC;gBACpD,OAAO;YACT,CAAC;QACH,CAAC;IACH,CAAC;IAED,GAAG,CAAC,IAAe,EAAE,OAAuB,EAAE,OAAsB;QAClE,MAAM,MAAM,GAAuB;YACjC,EAAE,EAAE,OAAO;YACX,OAAO,EAAE,OAAO,EAAE,OAAO;YACzB,IAAI,EAAE,OAAO,EAAE,IAAI;SACpB,CAAC;QACF,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;QACxC,OAAO,GAAG,EAAE;YACV,IAAI,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC;gBAC7C,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,MAAM,CACtD,CAAC,CAAC,EAAE,CAAC,CAAC,KAAK,MAAM,CAClB,CAAC;YACJ,CAAC;QACH,CAAC,CAAC;IACJ,CAAC;IAKD,eAAe,CACb,IAAe,EACf,QAAkB,EAClB,KAAiB;QAEjB,MAAM,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;QACzC,IAAI,CAAC,QAAQ;YAAE,OAAO;QAEtB,MAAM,YAAY,GAAG,QAAQ,CAAC,MAAM,CAClC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO,KAAK,SAAS,IAAI,OAAO,CAAC,IAAI,KAAK,SAAS,CACvE,CAAC;QAEF,MAAM,UAAU,GAAG,QAAQ,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE;YAC3C,MAAM,KAAK,GAAG,OAAO,CAAC,IAAI,CAAC;YAC3B,IAAI,KAAK,KAAK,SAAS;gBAAE,OAAO,KAAK,CAAC;YACtC,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,QAAQ,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC;QAC9D,CAAC,CAAC,CAAC;QAEH,MAAM,aAAa,GAAG,QAAQ,CAAC,MAAM,CACnC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO,IAAI,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,CAAC,CACjE,CAAC;QAEF,OAAO;YACL,OAAO,EAAE,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,MAAM,CAAC,YAAY,CAAC;YAC9D,QAAQ;YACR,KAAK;SACN,CAAC;IACJ,CAAC;CACF","sourcesContent":["import { DisposableGroup, Slot } from '@blocksuite/global/utils';\nimport type { BlockModel } from '@blocksuite/store';\n\nimport { PathFinder } from '../utils/index.js';\nimport type { BlockElement } from '../view/index.js';\nimport {\n  type UIEventHandler,\n  UIEventState,\n  UIEventStateContext,\n} from './base.js';\nimport { ClipboardControl } from './control/clipboard.js';\nimport { KeyboardControl } from './control/keyboard.js';\nimport { PointerControl } from './control/pointer.js';\nimport { RangeControl } from './control/range.js';\nimport { EventScopeSourceType, EventSourceState } from './state/source.js';\nimport { toLowerCase } from './utils.js';\n\nconst bypassEventNames = [\n  'beforeInput',\n\n  'blur',\n  'focus',\n  'drop',\n  'contextMenu',\n  'wheel',\n] as const;\n\nconst eventNames = [\n  'click',\n  'doubleClick',\n  'tripleClick',\n\n  'pointerDown',\n  'pointerMove',\n  'pointerUp',\n  'pointerOut',\n\n  'dragStart',\n  'dragMove',\n  'dragEnd',\n\n  'keyDown',\n  'keyUp',\n\n  'selectionChange',\n  'compositionStart',\n  'compositionUpdate',\n  'compositionEnd',\n\n  'cut',\n  'copy',\n  'paste',\n\n  ...bypassEventNames,\n] as const;\n\nexport type EventName = (typeof eventNames)[number];\nexport type EventOptions = {\n  flavour?: string;\n  path?: string[];\n};\nexport type EventHandlerRunner = {\n  fn: UIEventHandler;\n  flavour?: string;\n  path?: string[];\n};\n\nexport type EventScope = {\n  runners: EventHandlerRunner[];\n  flavours: string[];\n  paths: string[][];\n};\n\nexport class UIEventDispatcher {\n  get active() {\n    return this._active;\n  }\n\n  get host() {\n    return this.std.host;\n  }\n\n  private get _currentSelections() {\n    return this.std.selection.value;\n  }\n\n  private _handlersMap = Object.fromEntries(\n    eventNames.map((name): [EventName, Array<EventHandlerRunner>] => [name, []])\n  ) as Record<EventName, Array<EventHandlerRunner>>;\n\n  private _pointerControl: PointerControl;\n\n  private _keyboardControl: KeyboardControl;\n\n  private _rangeControl: RangeControl;\n\n  private _clipboardControl: ClipboardControl;\n\n  private _active = false;\n\n  disposables = new DisposableGroup();\n\n  /**\n   * @deprecated\n   *\n   * This property is deprecated and will be removed in the future.\n   */\n  slots = {\n    parentScaleChanged: new Slot<number>(),\n    editorHostPanned: new Slot(),\n  };\n\n  constructor(public std: BlockSuite.Std) {\n    this._pointerControl = new PointerControl(this);\n    this._keyboardControl = new KeyboardControl(this);\n    this._rangeControl = new RangeControl(this);\n    this._clipboardControl = new ClipboardControl(this);\n  }\n\n  private _getEventScope(name: EventName, state: EventSourceState) {\n    const handlers = this._handlersMap[name];\n    if (!handlers) return;\n\n    let output: EventScope | undefined;\n\n    switch (state.sourceType) {\n      case EventScopeSourceType.Selection: {\n        output = this._buildEventScopeBySelection(name);\n        break;\n      }\n      case EventScopeSourceType.Target: {\n        output = this._buildEventScopeByTarget(\n          name,\n          state.event.target as Node\n        );\n        break;\n      }\n      default: {\n        throw new Error(`Unknown event scope source: ${state.sourceType}`);\n      }\n    }\n\n    return output;\n  }\n\n  private _buildEventScopeByTarget(name: EventName, target: Node) {\n    const handlers = this._handlersMap[name];\n    if (!handlers) return;\n\n    // TODO(mirone/#6534): find a better way to get block element from a node\n    const el = target instanceof Element ? target : target.parentElement;\n    const block = el?.closest<BlockElement>('[data-block-id]');\n\n    const path = block?.path;\n    if (!path) {\n      return this._buildEventScopeBySelection(name);\n    }\n\n    const flavours = path\n      .map(blockId => {\n        return this.std.doc.getBlockById(blockId)?.flavour;\n      })\n      .filter((flavour): flavour is string => {\n        return !!flavour;\n      })\n      .reverse();\n\n    return this.buildEventScope(name, flavours, [path]);\n  }\n\n  private _calculatePath = (model: BlockModel): string[] => {\n    const path: string[] = [];\n    let current: BlockModel | null = model;\n    while (current) {\n      path.push(current.id);\n      current = this.std.doc.getParent(current);\n    }\n    return path.reverse();\n  };\n\n  private _buildEventScopeBySelection(name: EventName) {\n    const handlers = this._handlersMap[name];\n    if (!handlers) return;\n\n    const selections = this._currentSelections;\n    const seen: Record<string, boolean> = {};\n\n    const paths = selections\n      .map(selection => selection.blockId)\n      .map(id => this.std.doc.getBlockById(id))\n      .filter((block): block is BlockModel => !!block)\n      .map(block => this._calculatePath(block));\n\n    const flavours = paths\n      .flatMap(path =>\n        path.map(blockId => this.std.doc.getBlockById(blockId)?.flavour)\n      )\n      .filter((flavour): flavour is string => {\n        if (!flavour) return false;\n        if (seen[flavour]) return false;\n        seen[flavour] = true;\n        return true;\n      })\n      .reverse();\n\n    return this.buildEventScope(name, flavours, paths);\n  }\n\n  private _bindEvents() {\n    bypassEventNames.forEach(eventName => {\n      this.disposables.addFromEvent(\n        this.host,\n        toLowerCase(eventName),\n        event => {\n          this.run(\n            eventName,\n            UIEventStateContext.from(\n              new UIEventState(event),\n              new EventSourceState({\n                event,\n                sourceType: EventScopeSourceType.Selection,\n              })\n            )\n          );\n        },\n        eventName === 'wheel'\n          ? {\n              passive: false,\n            }\n          : undefined\n      );\n    });\n\n    this._pointerControl.listen();\n    this._keyboardControl.listen();\n    this._rangeControl.listen();\n    this._clipboardControl.listen();\n\n    let _dragging = false;\n    this.disposables.addFromEvent(this.host, 'pointerdown', () => {\n      _dragging = true;\n      this._active = true;\n    });\n    this.disposables.addFromEvent(this.host, 'pointerup', () => {\n      _dragging = false;\n    });\n    this.disposables.addFromEvent(this.host, 'click', () => {\n      this._active = true;\n    });\n    this.disposables.addFromEvent(this.host, 'focusin', () => {\n      this._active = true;\n    });\n    this.disposables.addFromEvent(this.host, 'focusout', e => {\n      if (e.relatedTarget && !this.host.contains(e.relatedTarget as Node)) {\n        this._active = false;\n      }\n    });\n    this.disposables.addFromEvent(this.host, 'pointerenter', () => {\n      this._active = true;\n    });\n    this.disposables.addFromEvent(this.host, 'pointerleave', () => {\n      if (\n        (!document.activeElement ||\n          !this.host.contains(document.activeElement)) &&\n        !_dragging\n      ) {\n        this._active = false;\n      }\n    });\n  }\n\n  mount() {\n    if (this.disposables.disposed) {\n      this.disposables = new DisposableGroup();\n    }\n    this._bindEvents();\n  }\n\n  unmount() {\n    this.disposables.dispose();\n  }\n\n  run(name: EventName, context: UIEventStateContext, scope?: EventScope) {\n    if (!this.active) return;\n\n    const sourceState = context.get('sourceState');\n    if (!scope) {\n      scope = this._getEventScope(name, sourceState);\n      if (!scope) {\n        return;\n      }\n    }\n    for (const runner of scope.runners) {\n      const { fn } = runner;\n      const result = fn(context);\n      if (result) {\n        context.get('defaultState').event.stopPropagation();\n        return;\n      }\n    }\n  }\n\n  add(name: EventName, handler: UIEventHandler, options?: EventOptions) {\n    const runner: EventHandlerRunner = {\n      fn: handler,\n      flavour: options?.flavour,\n      path: options?.path,\n    };\n    this._handlersMap[name].unshift(runner);\n    return () => {\n      if (this._handlersMap[name].includes(runner)) {\n        this._handlersMap[name] = this._handlersMap[name].filter(\n          x => x !== runner\n        );\n      }\n    };\n  }\n\n  bindHotkey = (...args: Parameters<KeyboardControl['bindHotkey']>) =>\n    this._keyboardControl.bindHotkey(...args);\n\n  buildEventScope(\n    name: EventName,\n    flavours: string[],\n    paths: string[][]\n  ): EventScope | undefined {\n    const handlers = this._handlersMap[name];\n    if (!handlers) return;\n\n    const globalEvents = handlers.filter(\n      handler => handler.flavour === undefined && handler.path === undefined\n    );\n\n    const pathEvents = handlers.filter(handler => {\n      const _path = handler.path;\n      if (_path === undefined) return false;\n      return paths.some(path => PathFinder.includes(path, _path));\n    });\n\n    const flavourEvents = handlers.filter(\n      handler => handler.flavour && flavours.includes(handler.flavour)\n    );\n\n    return {\n      runners: pathEvents.concat(flavourEvents).concat(globalEvents),\n      flavours,\n      paths,\n    };\n  }\n}\n"]}