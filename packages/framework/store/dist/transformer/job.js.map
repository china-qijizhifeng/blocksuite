{"version":3,"file":"job.js","sourceRoot":"","sources":["../../src/transformer/job.ts"],"names":[],"mappings":"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","sourcesContent":["import { Slot } from '@blocksuite/global/utils';\nimport { assertExists } from '@blocksuite/global/utils';\n\nimport type { BlockModel, BlockSchemaType } from '../schema/index.js';\nimport type { DocCollection, DocMeta } from '../store/index.js';\nimport type { Doc } from '../store/index.js';\nimport { AssetsManager } from './assets.js';\nimport { BaseBlockTransformer } from './base.js';\nimport { type DraftModel, toDraftModel } from './draft.js';\nimport type {\n  BeforeExportPayload,\n  BeforeImportPayload,\n  FinalPayload,\n  JobMiddleware,\n  JobSlots,\n} from './middleware.js';\nimport { Slice } from './slice.js';\nimport type {\n  BlockSnapshot,\n  CollectionInfoSnapshot,\n  DocSnapshot,\n  SliceSnapshot,\n} from './type.js';\nimport {\n  BlockSnapshotSchema,\n  CollectionInfoSnapshotSchema,\n  DocSnapshotSchema,\n  SliceSnapshotSchema,\n} from './type.js';\n\nexport type JobConfig = {\n  collection: DocCollection;\n  middlewares?: JobMiddleware[];\n};\n\nexport class Job {\n  get collection() {\n    return this._collection;\n  }\n\n  get assetsManager() {\n    return this._assetsManager;\n  }\n\n  get assets() {\n    return this._assetsManager.getAssets();\n  }\n\n  get adapterConfigs() {\n    return this._adapterConfigs;\n  }\n\n  private readonly _collection: DocCollection;\n\n  private readonly _assetsManager: AssetsManager;\n\n  private readonly _adapterConfigs = new Map<string, string>();\n\n  private readonly _slots: JobSlots = {\n    beforeImport: new Slot<BeforeImportPayload>(),\n    afterImport: new Slot<FinalPayload>(),\n    beforeExport: new Slot<BeforeExportPayload>(),\n    afterExport: new Slot<FinalPayload>(),\n  };\n\n  constructor({ collection, middlewares = [] }: JobConfig) {\n    this._collection = collection;\n    this._assetsManager = new AssetsManager({ blob: collection.blobSync });\n\n    middlewares.forEach(middleware => {\n      middleware({\n        slots: this._slots,\n        assetsManager: this._assetsManager,\n        collection: this._collection,\n        adapterConfigs: this._adapterConfigs,\n      });\n    });\n  }\n\n  private _getSchema(flavour: string) {\n    const schema = this._collection.schema.flavourSchemaMap.get(flavour);\n    assertExists(schema, `Flavour schema not found for ${flavour}`);\n    return schema;\n  }\n\n  private _getTransformer(schema: BlockSchemaType) {\n    return schema.transformer?.() ?? new BaseBlockTransformer();\n  }\n\n  private _getCollectionMeta() {\n    const { meta } = this._collection;\n    const { pageVersion, workspaceVersion, docs } = meta;\n    assertExists(pageVersion);\n    assertExists(workspaceVersion);\n    assertExists(docs);\n    return {\n      pageVersion,\n      workspaceVersion,\n      properties: {}, // for backward compatibility\n      pages: JSON.parse(JSON.stringify(docs)) as DocMeta[],\n    };\n  }\n\n  private _exportDocMeta(doc: Doc): DocSnapshot['meta'] {\n    const docMeta = doc.meta;\n\n    assertExists(docMeta);\n    return {\n      id: docMeta.id,\n      title: docMeta.title,\n      createDate: docMeta.createDate,\n      tags: [], // for backward compatibility\n    };\n  }\n\n  private async _blockToSnapshot(model: DraftModel): Promise<BlockSnapshot> {\n    this._slots.beforeExport.emit({\n      type: 'block',\n      model,\n    });\n    const schema = this._getSchema(model.flavour);\n    const transformer = this._getTransformer(schema);\n    const snapshotLeaf = await transformer.toSnapshot({\n      model,\n      assets: this._assetsManager,\n    });\n    const children = await Promise.all(\n      model.children.map(child => {\n        return this._blockToSnapshot(child);\n      })\n    );\n    const snapshot: BlockSnapshot = {\n      type: 'block',\n      ...snapshotLeaf,\n      children,\n    };\n    this._slots.afterExport.emit({\n      type: 'block',\n      model,\n      snapshot,\n    });\n\n    return snapshot;\n  }\n\n  private async _snapshotToBlock(\n    snapshot: BlockSnapshot,\n    doc: Doc,\n    parent?: string,\n    index?: number\n  ) {\n    this._slots.beforeImport.emit({\n      type: 'block',\n      snapshot,\n      parent,\n      index,\n    });\n    const { children, flavour, props, id } = snapshot;\n\n    const schema = this._getSchema(flavour);\n    const snapshotLeaf = {\n      id,\n      flavour,\n      props,\n    };\n    const transformer = this._getTransformer(schema);\n    const modelData = await transformer.fromSnapshot({\n      json: snapshotLeaf,\n      assets: this._assetsManager,\n      children,\n    });\n\n    doc.addBlock(\n      modelData.flavour as BlockSuite.Flavour,\n      { ...modelData.props, id: modelData.id },\n      parent,\n      index\n    );\n\n    for (const [index, child] of children.entries()) {\n      await this._snapshotToBlock(child, doc, id, index);\n    }\n\n    const model = doc.getBlockById(id);\n    assertExists(model);\n    this._slots.afterImport.emit({\n      type: 'block',\n      snapshot,\n      model,\n      parent,\n      index,\n    });\n\n    return model;\n  }\n\n  reset() {\n    this._assetsManager.cleanup();\n  }\n\n  blockToSnapshot = async (model: DraftModel): Promise<BlockSnapshot> => {\n    const snapshot = await this._blockToSnapshot(model);\n    BlockSnapshotSchema.parse(snapshot);\n\n    return snapshot;\n  };\n\n  snapshotToModelData = async (snapshot: BlockSnapshot) => {\n    const { children, flavour, props, id } = snapshot;\n\n    const schema = this._getSchema(flavour);\n    const snapshotLeaf = {\n      id,\n      flavour,\n      props,\n    };\n    const transformer = this._getTransformer(schema);\n    const modelData = await transformer.fromSnapshot({\n      json: snapshotLeaf,\n      assets: this._assetsManager,\n      children,\n    });\n\n    return modelData;\n  };\n\n  walk = (snapshot: DocSnapshot, callback: (block: BlockSnapshot) => void) => {\n    const walk = (block: BlockSnapshot) => {\n      callback(block);\n\n      if (block.children) {\n        block.children.forEach(walk);\n      }\n    };\n\n    walk(snapshot.blocks);\n  };\n\n  snapshotToBlock = async (\n    snapshot: BlockSnapshot,\n    doc: Doc,\n    parent?: string,\n    index?: number\n  ): Promise<BlockModel> => {\n    BlockSnapshotSchema.parse(snapshot);\n    const model = await this._snapshotToBlock(snapshot, doc, parent, index);\n\n    return model;\n  };\n\n  docToSnapshot = async (doc: Doc): Promise<DocSnapshot> => {\n    this._slots.beforeExport.emit({\n      type: 'page',\n      page: doc,\n    });\n    const rootModel = doc.root;\n    const meta = this._exportDocMeta(doc);\n    assertExists(rootModel, 'Root block not found in doc');\n    const blocks = await this.blockToSnapshot(rootModel);\n    const docSnapshot: DocSnapshot = {\n      type: 'page',\n      meta,\n      blocks,\n    };\n    this._slots.afterExport.emit({\n      type: 'page',\n      page: doc,\n      snapshot: docSnapshot,\n    });\n    DocSnapshotSchema.parse(docSnapshot);\n\n    return docSnapshot;\n  };\n\n  snapshotToDoc = async (snapshot: DocSnapshot): Promise<Doc> => {\n    this._slots.beforeImport.emit({\n      type: 'page',\n      snapshot,\n    });\n    DocSnapshotSchema.parse(snapshot);\n    const { meta, blocks } = snapshot;\n    const doc = this._collection.createDoc({ id: meta.id });\n    doc.load();\n    await this.snapshotToBlock(blocks, doc);\n    this._slots.afterImport.emit({\n      type: 'page',\n      snapshot,\n      page: doc,\n    });\n\n    return doc;\n  };\n\n  collectionInfoToSnapshot = (): CollectionInfoSnapshot => {\n    this._slots.beforeExport.emit({\n      type: 'info',\n    });\n    const collectionMeta = this._getCollectionMeta();\n    const snapshot: CollectionInfoSnapshot = {\n      type: 'info',\n      id: this._collection.id,\n      ...collectionMeta,\n    };\n    this._slots.afterExport.emit({\n      type: 'info',\n      snapshot,\n    });\n    CollectionInfoSnapshotSchema.parse(snapshot);\n\n    return snapshot;\n  };\n\n  sliceToSnapshot = async (slice: Slice): Promise<SliceSnapshot> => {\n    this._slots.beforeExport.emit({\n      type: 'slice',\n      slice,\n    });\n    const { content, pageVersion, workspaceVersion, pageId, workspaceId } =\n      slice.data;\n    const contentSnapshot = [];\n    for (const block of content) {\n      contentSnapshot.push(await this.blockToSnapshot(block));\n    }\n    const snapshot: SliceSnapshot = {\n      type: 'slice',\n      workspaceId,\n      pageId,\n      pageVersion,\n      workspaceVersion,\n      content: contentSnapshot,\n    };\n    this._slots.afterExport.emit({\n      type: 'slice',\n      slice,\n      snapshot,\n    });\n    SliceSnapshotSchema.parse(snapshot);\n\n    return snapshot;\n  };\n\n  snapshotToSlice = async (\n    snapshot: SliceSnapshot,\n    doc: Doc,\n    parent?: string,\n    index?: number\n  ): Promise<Slice> => {\n    this._slots.beforeImport.emit({\n      type: 'slice',\n      snapshot,\n    });\n    SliceSnapshotSchema.parse(snapshot);\n    const { content, pageVersion, workspaceVersion, workspaceId, pageId } =\n      snapshot;\n    const contentBlocks: BlockModel[] = [];\n    for (const [i, block] of content.entries()) {\n      contentBlocks.push(\n        await this._snapshotToBlock(block, doc, parent, (index ?? 0) + i)\n      );\n    }\n    const slice = new Slice({\n      content: contentBlocks.map(block => toDraftModel(block)),\n      pageVersion,\n      workspaceVersion,\n      workspaceId,\n      pageId,\n    });\n    this._slots.afterImport.emit({\n      type: 'slice',\n      snapshot,\n      slice,\n    });\n\n    return slice;\n  };\n}\n"]}