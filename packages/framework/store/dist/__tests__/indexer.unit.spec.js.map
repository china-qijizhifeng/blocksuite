{"version":3,"file":"indexer.unit.spec.js","sourceRoot":"","sources":["../../src/__tests__/indexer.unit.spec.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-restricted-imports */\n// checkout https://vitest.dev/guide/debugging.html for debugging tests\nimport { beforeEach, describe, expect, it } from 'vitest';\nimport { applyUpdate, encodeStateAsUpdate } from 'yjs';\n\nimport { DocCollection, Generator, Schema } from '../index.js';\n// Use manual per-module import/export to support vitest environment on Node.js\nimport {\n  NoteBlockSchema,\n  ParagraphBlockSchema,\n  RootBlockSchema,\n} from './test-schema.js';\n\nexport const BlockSchemas = [\n  RootBlockSchema,\n  ParagraphBlockSchema,\n  NoteBlockSchema,\n];\n\nfunction createTestOptions() {\n  const idGenerator = Generator.AutoIncrement;\n  const schema = new Schema();\n  schema.register(BlockSchemas);\n  return { id: 'test-collection', idGenerator, schema };\n}\n\nfunction createTestDoc(pageId = 'doc:home', collection?: DocCollection) {\n  const options = createTestOptions();\n  const _collection = collection || new DocCollection(options);\n  _collection.meta.initialize();\n  const doc = _collection.createDoc({ id: pageId });\n  doc.load();\n  return doc;\n}\n\nfunction requestIdleCallbackPolyfill(\n  callback: IdleRequestCallback,\n  options?: IdleRequestOptions\n) {\n  const timeout = options?.timeout ?? 1000;\n  const start = Date.now();\n  return setTimeout(function () {\n    callback({\n      didTimeout: false,\n      timeRemaining: function () {\n        return Math.max(0, timeout - (Date.now() - start));\n      },\n    });\n  }, timeout) as unknown as number;\n}\n\nbeforeEach(() => {\n  if (globalThis.requestIdleCallback === undefined) {\n    globalThis.requestIdleCallback = requestIdleCallbackPolyfill;\n  }\n});\n\ndescribe('collection.search works', () => {\n  it('collection search matching', () => {\n    const doc = createTestDoc();\n    const collection = doc.collection;\n\n    const rootId = doc.addBlock('affine:page', {\n      title: new doc.Text(''),\n    });\n    const noteId = doc.addBlock('affine:note', {}, rootId);\n    const text1 =\n      '英特尔第13代酷睿i7-1370P移动处理器现身Geekbench，14核心和5GHz';\n    const text2 = '索尼考虑移植《GT赛车7》，又一PlayStation独占IP登陆PC平台';\n    const expected1 = new Map([\n      [\n        '2',\n        {\n          content: text1,\n          space: doc.id,\n        },\n      ],\n    ]);\n    const expected2 = new Map([\n      [\n        '3',\n        {\n          content: text2,\n          space: doc.id,\n        },\n      ],\n    ]);\n    doc.addBlock(\n      'affine:paragraph',\n      {\n        text: new doc.Text(text1),\n      },\n      noteId\n    );\n\n    doc.addBlock(\n      'affine:paragraph',\n      {\n        text: new doc.Text(text2),\n      },\n      noteId\n    );\n\n    requestIdleCallback(() => {\n      queueMicrotask(() => {\n        expect(collection.search('处理器')).toStrictEqual(expected1);\n        expect(collection.search('索尼')).toStrictEqual(expected2);\n      });\n    });\n\n    const update = encodeStateAsUpdate(doc.spaceDoc);\n    const schema = new Schema();\n    const collection2 = new DocCollection({\n      schema,\n      id: 'test',\n    });\n    collection2.meta.initialize();\n    const doc2 = collection2.createDoc({\n      id: 'doc:home',\n    });\n    applyUpdate(doc2.spaceDoc, update);\n    expect(doc2.spaceDoc.toJSON()).toEqual(doc.spaceDoc.toJSON());\n\n    requestIdleCallback(() => {\n      queueMicrotask(() => {\n        expect(collection2.search('处理器')).toStrictEqual(expected1);\n        expect(collection2.search('索尼')).toStrictEqual(expected2);\n      });\n    });\n  });\n});\n\ndescribe('backlink works', () => {\n  it('backlink indexer works with subpage', async () => {\n    const doc = createTestDoc();\n    const collection = doc.collection;\n    const subpage = createTestDoc('doc1', collection);\n    const backlinkIndexer = collection.indexer.backlink!;\n\n    const rootId = doc.addBlock('affine:page', {\n      title: new doc.Text(''),\n    });\n    const noteId = doc.addBlock('affine:note', {}, rootId);\n\n    const text = doc.Text.fromDelta([\n      {\n        insert: ' ',\n        attributes: { reference: { type: 'Subpage', pageId: subpage.id } },\n      },\n    ]);\n    doc.addBlock(\n      'affine:paragraph',\n      {\n        text,\n      },\n      noteId\n    );\n\n    // wait for the backlink index to be updated\n    await new Promise(resolve => setTimeout(resolve, 0));\n\n    expect(backlinkIndexer.getBacklink(doc.id)).toStrictEqual([]);\n    expect(backlinkIndexer.getBacklink(subpage.id)).toStrictEqual([\n      {\n        blockId: '2',\n        pageId: 'doc:home',\n        type: 'Subpage',\n      },\n    ]);\n\n    text.format(0, 1, { reference: null });\n\n    expect(backlinkIndexer.getBacklink(doc.id)).toStrictEqual([]);\n\n    expect(backlinkIndexer.getBacklink(subpage.id)).toStrictEqual([]);\n  });\n\n  it('backlink indexer works with linked doc', async () => {\n    const doc0 = createTestDoc();\n    const collection = doc0.collection;\n    const doc1 = createTestDoc('space:doc1', collection);\n    const backlinkIndexer = collection.indexer.backlink!;\n\n    const doc0Id = doc0.addBlock('affine:page');\n    const note0Id = doc0.addBlock('affine:note', {}, doc0Id);\n\n    doc0.addBlock(\n      'affine:paragraph',\n      {\n        text: doc0.Text.fromDelta([\n          {\n            insert: ' ',\n            attributes: { reference: { type: 'LinkedPage', pageId: doc0.id } },\n          },\n        ]),\n      },\n      note0Id\n    );\n    const paragraphId2 = doc0.addBlock(\n      'affine:paragraph',\n      {\n        text: doc1.Text.fromDelta([\n          {\n            insert: ' ',\n            attributes: { reference: { type: 'LinkedPage', pageId: doc1.id } },\n          },\n        ]),\n      },\n      note0Id\n    );\n    const paragraph2 = doc0.getBlockById(paragraphId2);\n\n    const doc1Id = doc1.addBlock('affine:page');\n    const note1Id = doc1.addBlock('affine:note', {}, doc1Id);\n\n    doc1.addBlock(\n      'affine:paragraph',\n      {\n        text: doc1.Text.fromDelta([\n          {\n            insert: ' ',\n            attributes: { reference: { type: 'LinkedPage', pageId: doc0.id } },\n          },\n        ]),\n      },\n      note1Id\n    );\n    const paragraphId4 = doc1.addBlock(\n      'affine:paragraph',\n      {\n        text: doc1.Text.fromDelta([\n          {\n            insert: ' ',\n            attributes: { reference: { type: 'LinkedPage', pageId: doc1.id } },\n          },\n        ]),\n      },\n      note1Id\n    );\n    const paragraph4 = doc1.getBlockById(paragraphId4);\n\n    // wait for the backlink index to be updated\n    await new Promise(resolve => setTimeout(resolve, 0));\n\n    expect(backlinkIndexer.getBacklink(doc0.id)).toStrictEqual([\n      {\n        blockId: '2',\n        pageId: 'doc:home',\n        type: 'LinkedPage',\n      },\n      {\n        blockId: '6',\n        pageId: 'space:doc1',\n        type: 'LinkedPage',\n      },\n    ]);\n\n    expect(backlinkIndexer.getBacklink(doc1.id)).toStrictEqual([\n      {\n        blockId: '3',\n        pageId: 'doc:home',\n        type: 'LinkedPage',\n      },\n      {\n        blockId: '7',\n        pageId: 'space:doc1',\n        type: 'LinkedPage',\n      },\n    ]);\n\n    paragraph2?.text?.delete(0, paragraph2.text.length);\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    doc1.updateBlock(paragraph4!, { text: new doc1.Text() });\n\n    expect(backlinkIndexer.getBacklink(doc0.id)).toStrictEqual([\n      {\n        blockId: '2',\n        pageId: 'doc:home',\n        type: 'LinkedPage',\n      },\n      {\n        blockId: '6',\n        pageId: 'space:doc1',\n        type: 'LinkedPage',\n      },\n    ]);\n\n    expect(backlinkIndexer.getBacklink(doc1.id)).toStrictEqual([]);\n  });\n});\n"]}