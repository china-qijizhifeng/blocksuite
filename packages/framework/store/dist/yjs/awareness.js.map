{"version":3,"file":"awareness.js","sourceRoot":"","sources":["../../src/yjs/awareness.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,IAAI,EAAE,MAAM,0BAA0B,CAAC;AAChD,OAAO,EAAE,KAAK,EAAE,MAAM,OAAO,CAAC;AA+B9B,MAAM,OAAO,cAAc;IAWzB,YACE,KAAY,EACZ,SAA+C,EAC/C,YAAmB;QAPZ,UAAK,GAAG;YACf,MAAM,EAAE,IAAI,IAAI,EAAyB;SAC1C,CAAC;QAsBM,uBAAkB,GAAG,CAAC,IAI7B,EAAE,EAAE;YACH,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG,IAAI,CAAC;YAEzC,MAAM,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC;YAC1C,KAAK,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE;gBACjB,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC;oBACrB,EAAE;oBACF,IAAI,EAAE,KAAK;oBACX,KAAK,EAAE,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC;iBACtB,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;YACH,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE;gBACnB,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC;oBACrB,EAAE;oBACF,IAAI,EAAE,QAAQ;oBACd,KAAK,EAAE,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC;iBACtB,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;YACH,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE;gBACnB,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC;oBACrB,EAAE;oBACF,IAAI,EAAE,QAAQ;iBACf,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;QACL,CAAC,CAAC;QA3CA,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;QAC3B,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,QAAQ,EAAE,IAAI,CAAC,kBAAkB,CAAC,CAAC;QACrD,IAAI,CAAC,SAAS,CAAC,kBAAkB,CAAC,aAAa,EAAE,EAAE,CAAC,CAAC;QACrD,IAAI,CAAC,UAAU,CAAC,YAAY,CAAC,CAAC;IAChC,CAAC;IAEO,UAAU,CAAC,YAAmB;QACpC,MAAM,aAAa,GAAG,IAAI,CAAC,SAAS,CAAC,aAAa,EAAE,EAAE,KAAK,CAAC;QAC5D,MAAM,KAAK,GAAG,aAAa;YACzB,CAAC,CAAC,KAAK,CAAC,IAAI,EAAE,YAAY,EAAE,aAAa,CAAC;YAC1C,CAAC,CAAC,EAAE,GAAG,YAAY,EAAE,CAAC;QACxB,IAAI,CAAC,SAAS,CAAC,kBAAkB,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;IACpD,CAAC;IAgCD,OAAO,CAA0B,KAAU,EAAE,KAAiB;QAC5D,MAAM,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,aAAa,EAAE,EAAE,KAAK,IAAI,EAAE,CAAC;QAC7D,IAAI,CAAC,SAAS,CAAC,kBAAkB,CAAC,OAAO,EAAE,EAAE,GAAG,QAAQ,EAAE,CAAC,KAAK,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC;IAC9E,CAAC;IAED,OAAO,CAA0B,KAAU;QACzC,MAAM,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,aAAa,EAAE,EAAE,KAAK,IAAI,EAAE,CAAC;QAC1D,OAAO,KAAK,CAAC,KAAK,CAAC,CAAC;IACtB,CAAC;IAED,WAAW,CAAC,KAAY,EAAE,KAAc;QACtC,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,IAAI,EAAE,CAAC;QAC7C,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE;YACvB,GAAG,KAAK;YACR,CAAC,KAAK,CAAC,EAAE,CAAC,EAAE,KAAK;SACG,CAAC,CAAC;IAC1B,CAAC;IAED,UAAU,CAAC,KAAY;QACrB,MAAM,EAAE,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;QACpC,IAAI,EAAE,IAAI,OAAO,EAAE,KAAK,QAAQ,EAAE,CAAC;YACjC,OAAO,OAAO,CAAE,EAA8B,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,CAAC;QAC5D,CAAC;aAAM,CAAC;YACN,OAAO,KAAK,CAAC;QACf,CAAC;IACH,CAAC;IAED,iBAAiB,CAAC,KAAY,EAAE,SAAwB;QACtD,MAAM,YAAY,GAAG,IAAI,CAAC,SAAS,CAAC,aAAa,EAAE,EAAE,WAAW,IAAI,EAAE,CAAC;QACvE,IAAI,CAAC,SAAS,CAAC,kBAAkB,CAAC,aAAa,EAAE;YAC/C,GAAG,YAAY;YACf,CAAC,KAAK,CAAC,EAAE,CAAC,EAAE,SAAS;SACtB,CAAC,CAAC;IACL,CAAC;IAED,iBAAiB,CAAC,KAAY;QAC5B,OAAO,CAAC,IAAI,CAAC,SAAS,CAAC,aAAa,EAAE,EAAE,WAAW,IAAI,EAAE,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,EAAE,CAAC;IAC7E,CAAC;IAED,SAAS;QACP,OAAO,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC;IACpC,CAAC;IAED,OAAO;QACL,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnB,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,CAAC,kBAAkB,CAAC,CAAC;YACtD,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;QAC9B,CAAC;IACH,CAAC;CACF","sourcesContent":["import { Slot } from '@blocksuite/global/utils';\nimport { merge } from 'merge';\nimport type { Awareness as YAwareness } from 'y-protocols/awareness.js';\n\nimport type { Space } from '../store/space.js';\nimport type { Store } from '../store/store.js';\n\nexport interface UserInfo {\n  name: string;\n}\n\ntype UserSelection = Array<Record<string, unknown>>;\n\n// Raw JSON state in awareness CRDT\nexport type RawAwarenessState<\n  Flags extends Record<string, unknown> = BlockSuiteFlags,\n> = {\n  user?: UserInfo;\n  color?: string;\n  flags: Flags;\n  // use v2 to avoid crush on old clients\n  selectionV2: Record<string, UserSelection>;\n};\n\nexport interface AwarenessEvent<\n  Flags extends Record<string, unknown> = BlockSuiteFlags,\n> {\n  id: number;\n  type: 'add' | 'update' | 'remove';\n  state?: RawAwarenessState<Flags>;\n}\n\nexport class AwarenessStore<\n  Flags extends Record<string, unknown> = BlockSuiteFlags,\n> {\n  readonly awareness: YAwareness<RawAwarenessState<Flags>>;\n\n  readonly store: Store;\n\n  readonly slots = {\n    update: new Slot<AwarenessEvent<Flags>>(),\n  };\n\n  constructor(\n    store: Store,\n    awareness: YAwareness<RawAwarenessState<Flags>>,\n    defaultFlags: Flags\n  ) {\n    this.store = store;\n    this.awareness = awareness;\n    this.awareness.on('change', this._onAwarenessChange);\n    this.awareness.setLocalStateField('selectionV2', {});\n    this._initFlags(defaultFlags);\n  }\n\n  private _initFlags(defaultFlags: Flags) {\n    const upstreamFlags = this.awareness.getLocalState()?.flags;\n    const flags = upstreamFlags\n      ? merge(true, defaultFlags, upstreamFlags)\n      : { ...defaultFlags };\n    this.awareness.setLocalStateField('flags', flags);\n  }\n\n  private _onAwarenessChange = (diff: {\n    added: number[];\n    removed: number[];\n    updated: number[];\n  }) => {\n    const { added, removed, updated } = diff;\n\n    const states = this.awareness.getStates();\n    added.forEach(id => {\n      this.slots.update.emit({\n        id,\n        type: 'add',\n        state: states.get(id),\n      });\n    });\n    updated.forEach(id => {\n      this.slots.update.emit({\n        id,\n        type: 'update',\n        state: states.get(id),\n      });\n    });\n    removed.forEach(id => {\n      this.slots.update.emit({\n        id,\n        type: 'remove',\n      });\n    });\n  };\n\n  setFlag<Key extends keyof Flags>(field: Key, value: Flags[Key]) {\n    const oldFlags = this.awareness.getLocalState()?.flags ?? {};\n    this.awareness.setLocalStateField('flags', { ...oldFlags, [field]: value });\n  }\n\n  getFlag<Key extends keyof Flags>(field: Key): Flags[Key] | undefined {\n    const flags = this.awareness.getLocalState()?.flags ?? {};\n    return flags[field];\n  }\n\n  setReadonly(space: Space, value: boolean): void {\n    const flags = this.getFlag('readonly') ?? {};\n    this.setFlag('readonly', {\n      ...flags,\n      [space.id]: value,\n    } as Flags['readonly']);\n  }\n\n  isReadonly(space: Space): boolean {\n    const rd = this.getFlag('readonly');\n    if (rd && typeof rd === 'object') {\n      return Boolean((rd as Record<string, boolean>)[space.id]);\n    } else {\n      return false;\n    }\n  }\n\n  setLocalSelection(space: Space, selection: UserSelection) {\n    const oldSelection = this.awareness.getLocalState()?.selectionV2 ?? {};\n    this.awareness.setLocalStateField('selectionV2', {\n      ...oldSelection,\n      [space.id]: selection,\n    });\n  }\n\n  getLocalSelection(space: Space): ReadonlyArray<Record<string, unknown>> {\n    return (this.awareness.getLocalState()?.selectionV2 ?? {})[space.id] ?? [];\n  }\n\n  getStates(): Map<number, RawAwarenessState<Flags>> {\n    return this.awareness.getStates();\n  }\n\n  destroy() {\n    if (this.awareness) {\n      this.awareness.off('change', this._onAwarenessChange);\n      this.slots.update.dispose();\n    }\n  }\n}\n"]}