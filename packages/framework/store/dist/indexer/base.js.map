{"version":3,"file":"base.js","sourceRoot":"","sources":["../../src/indexer/base.ts"],"names":[],"mappings":"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","sourcesContent":["import { assertExists, DisposableGroup, Slot } from '@blocksuite/global/utils';\nimport type * as Y from 'yjs';\nimport { YArrayEvent, YMapEvent, YTextEvent } from 'yjs';\n\nimport type { YBlock } from '../store/doc/block.js';\nimport type { BlockSuiteDoc } from '../yjs/index.js';\n\ntype DocId = string;\n\nexport type IndexBlockEvent =\n  | {\n      docId: DocId;\n      blockId: string;\n      action: 'add' | 'update';\n      block: YBlock;\n    }\n  | {\n      docId: DocId;\n      blockId: string;\n      action: 'delete';\n      block?: undefined;\n    };\n\nexport class BlockIndexer {\n  private readonly _doc: BlockSuiteDoc;\n\n  private readonly _collectionSlots: {\n    docAdded: Slot<string>;\n    docRemoved: Slot<string>;\n  };\n\n  private _disposables = new DisposableGroup();\n\n  slots = {\n    docRemoved: new Slot<DocId>(),\n    /**\n     * Note: sys:children update will not trigger event\n     */\n    blockUpdated: new Slot<IndexBlockEvent>(),\n    refreshIndex: new Slot(),\n  };\n\n  constructor(\n    doc: BlockSuiteDoc,\n    {\n      immediately = false,\n      slots,\n    }: {\n      readonly slots: {\n        docAdded: Slot<string>;\n        docRemoved: Slot<string>;\n      };\n      immediately?: boolean;\n    }\n  ) {\n    this._doc = doc;\n    this._collectionSlots = slots;\n\n    if (immediately) {\n      this._initIndex();\n      return;\n    }\n    // lazy init\n    setTimeout(() => {\n      this._initIndex();\n    }, 0);\n  }\n\n  private _initIndex() {\n    const doc = this._doc;\n    const share = doc.share;\n    if (!share.has('meta')) {\n      throw new Error(\n        'Failed to initialize indexer: collection meta not found'\n      );\n    }\n\n    let disposeMap: Record<string, (() => void) | null> = {};\n    this._disposables.add(() => {\n      Object.values(disposeMap).forEach(fn => fn?.());\n      disposeMap = {};\n    });\n\n    Array.from(doc.spaces.keys())\n      .map(docId => ({ docId, doc: this._getDoc(docId) }))\n      .forEach(({ docId, doc }) => {\n        assertExists(doc, `Failed to find doc '${docId}'`);\n        if (disposeMap[docId]) {\n          console.warn(\n            `Duplicated docAdded event! ${docId} already observed`,\n            disposeMap\n          );\n          return;\n        }\n        const dispose = this._indexDoc(docId, doc);\n        disposeMap[docId] = dispose;\n      });\n\n    this._collectionSlots.docAdded.on(docId => {\n      const doc = this._getDoc(docId);\n      assertExists(doc, `Failed to find doc '${docId}'`);\n      if (disposeMap[docId]) {\n        // It's possible because the `docAdded` event is emitted once a new block is added to the doc\n        return;\n      }\n      const dispose = this._indexDoc(docId, doc);\n      disposeMap[docId] = dispose;\n    });\n    this._collectionSlots.docRemoved.on(docId => {\n      disposeMap[docId]?.();\n      disposeMap[docId] = null;\n      this.slots.docRemoved.emit(docId);\n    });\n  }\n\n  private _indexDoc(docId: string, yDoc: Y.Doc) {\n    const yBlocks = yDoc.getMap<YBlock>('blocks');\n    yBlocks.forEach((block, blockId) => {\n      this._indexBlock({ action: 'add', docId, blockId, block });\n    });\n\n    const observer = (\n      events: Y.YEvent<Y.AbstractType<unknown>>[],\n      transaction: Y.Transaction\n    ) => this._yDocObserver(events, transaction, { docId, yDoc: yBlocks });\n\n    yBlocks.observeDeep(observer);\n    return () => {\n      yBlocks.unobserveDeep(observer);\n    };\n  }\n\n  private _indexBlock(indexEvent: IndexBlockEvent) {\n    this.slots.blockUpdated.emit(indexEvent);\n  }\n\n  private _yDocObserver = (\n    events: Y.YEvent<Y.AbstractType<unknown>>[],\n    _transaction: Y.Transaction,\n    { docId, yDoc }: { docId: DocId; yDoc: Y.Map<YBlock> }\n  ) => {\n    events.forEach(e => {\n      if (e instanceof YArrayEvent) {\n        // sys:children\n        return;\n      }\n\n      if (e instanceof YMapEvent) {\n        if (e.target !== e.currentTarget) {\n          // add 'elements' to 'affine:surface' or add 'prop:xywh' to 'affine:note'\n          if (e.keysChanged.has('prop:text')) {\n            // update block text by `doc.updateBlock(paragraph, { text: new doc.Text() })` API\n            const blockId = e.path[0] as string;\n            const block = yDoc.get(blockId);\n            assertExists(block);\n            this._indexBlock({\n              action: 'update',\n              docId,\n              blockId,\n              block,\n            });\n          }\n          return;\n        }\n\n        Array.from(e.changes.keys.entries()).forEach(\n          ([blockId, { action }]) => {\n            if (action === 'delete') {\n              this._indexBlock({\n                action,\n                docId,\n                blockId,\n              });\n              return;\n            }\n            // add or update\n            const block = yDoc.get(blockId);\n            assertExists(block);\n            this._indexBlock({\n              action,\n              docId,\n              blockId,\n              block,\n            });\n          }\n        );\n        return;\n      }\n      if (e instanceof YTextEvent) {\n        const blockId = e.path[0];\n        if (!blockId || typeof blockId !== 'string') {\n          throw new Error('Failed to update index! Unexpected YText Event!');\n        }\n        const block = yDoc.get(blockId);\n        assertExists(block);\n        this._indexBlock({\n          action: 'update',\n          docId,\n          blockId,\n          block,\n        });\n        return;\n      }\n    });\n  };\n\n  private _getDoc(docId: DocId): Y.Doc | undefined {\n    return this._doc.spaces.get(docId) as Y.Doc | undefined;\n  }\n\n  refreshIndex() {\n    this.slots.refreshIndex.emit();\n    this._initIndex();\n  }\n\n  dispose() {\n    this._disposables.dispose();\n  }\n}\n"]}