{"version":3,"file":"backlink.js","sourceRoot":"","sources":["../../src/indexer/backlink.ts"],"names":[],"mappings":"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","sourcesContent":["import { DisposableGroup, Slot } from '@blocksuite/global/utils';\nimport type { BaseTextAttributes, DeltaInsert } from '@blocksuite/inline';\nimport { Text } from 'yjs';\n\nimport type { BlockIndexer, IndexBlockEvent } from './base.js';\n\ntype DocId = string;\ntype BlockId = string;\ntype LinkedNode = {\n  type: 'LinkedPage' | 'Subpage';\n  pageId: DocId;\n  blockId: BlockId;\n};\n/**\n * Please sync type with {@link AffineTextAttributes} manually\n */\ntype TextDelta = DeltaInsert<\n  BaseTextAttributes & { reference: Omit<LinkedNode, 'blockId'> }\n>;\n\nexport type IndexUpdatedEvent =\n  | {\n      action: 'delete';\n      docId: DocId;\n      blockId?: BlockId;\n    }\n  | {\n      action: 'add' | 'update';\n      docId: DocId;\n      blockId: BlockId;\n    };\n\n/**\n * Returns an object with four arrays: add, remove and unchanged.\n *\n * add: elements in after that are not in before\n * remove: elements in before that are not in after\n * unchanged: elements in both before and after\n */\nfunction diffArray<T>(\n  before: T[],\n  after: T[],\n  compare = (a: T, b: T) => a === b\n) {\n  const add: T[] = [];\n  const remove: T[] = [];\n  const unchanged: T[] = [];\n\n  // Find elements in before that are not in after\n  for (const elem of before) {\n    if (!after.some(afterElem => compare(afterElem, elem))) {\n      remove.push(elem);\n    } else {\n      unchanged.push(elem);\n    }\n  }\n  // Find elements in after that are not in before\n  for (const elem of after) {\n    if (!before.some(beforeElem => compare(beforeElem, elem))) {\n      add.push(elem);\n    }\n  }\n\n  return { changed: add.length || remove.length, add, remove, unchanged };\n}\n\nexport class BacklinkIndexer {\n  get linkIndexMap() {\n    return this._linkIndexMap;\n  }\n\n  private _disposables = new DisposableGroup();\n\n  private _linkIndexMap: Record<DocId, Record<BlockId, LinkedNode[]>> = {};\n\n  // TODO use inverted index\n  private _backlinkIndexMapCache: Record<DocId, LinkedNode[]> | null = null;\n\n  slots = {\n    /**\n     * Note: sys:children update will not trigger event\n     */\n    indexUpdated: new Slot<IndexUpdatedEvent>(),\n  };\n\n  constructor(blockIndexer: BlockIndexer) {\n    this._disposables.add(\n      blockIndexer.slots.refreshIndex.on(() => this._onRefreshIndex())\n    );\n\n    this._disposables.add(\n      blockIndexer.slots.docRemoved.on(docId => this._onDocRemoved(docId))\n    );\n\n    this._disposables.add(\n      blockIndexer.slots.blockUpdated.on(e => this._onBlockUpdated(e))\n    );\n\n    this.slots.indexUpdated.on(() => {\n      this._backlinkIndexMapCache = null;\n    });\n  }\n\n  private _onRefreshIndex() {\n    this._linkIndexMap = {};\n  }\n\n  private _onDocRemoved(docId: DocId) {\n    if (!this._linkIndexMap[docId]) {\n      return;\n    }\n    this._linkIndexMap[docId] = {};\n    this.slots.indexUpdated.emit({ action: 'delete', docId });\n  }\n\n  private _onBlockUpdated({ action, docId, block, blockId }: IndexBlockEvent) {\n    switch (action) {\n      case 'add':\n      case 'update': {\n        let links: LinkedNode[] = [];\n\n        const text = block.get('prop:text');\n        if (text) {\n          if (text instanceof Text) {\n            const deltas: TextDelta[] = text.toDelta();\n            links = [\n              ...links,\n              ...deltas\n                .filter(delta => delta.attributes && delta.attributes.reference)\n                // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n                .map(delta => ({ ...delta.attributes!.reference!, blockId })),\n            ];\n          } else {\n            console.warn('Unexpected prop:text type', text);\n          }\n        }\n\n        const flavour = block.get('sys:flavour');\n        if (\n          flavour === 'affine:embed-linked-doc' ||\n          flavour === 'affine:embed-synced-doc'\n        ) {\n          const pageId = block.get('prop:pageId');\n          if (typeof pageId === 'string') {\n            links = [...links, { pageId, blockId, type: 'LinkedPage' }];\n          } else {\n            console.warn('Unexpected prop:pageId type', pageId);\n          }\n        }\n\n        this._indexDelta({ action, docId, blockId, links });\n        return;\n      }\n      case 'delete': {\n        this._removeIndex(docId, blockId);\n        break;\n      }\n    }\n  }\n\n  private _indexDelta({\n    action,\n    docId,\n    blockId,\n    links,\n  }: {\n    action: IndexBlockEvent['action'];\n    docId: DocId;\n    blockId: BlockId;\n    links: LinkedNode[];\n  }) {\n    const before = this._linkIndexMap[docId]?.[blockId] ?? [];\n    const diff = diffArray(before, links);\n    if (!diff.changed) return;\n\n    this._linkIndexMap[docId] = {\n      ...this._linkIndexMap[docId],\n      [blockId]: links,\n    };\n    this.slots.indexUpdated.emit({ action, docId, blockId });\n  }\n\n  private _removeIndex(docId: DocId, blockId: BlockId) {\n    if (!this._linkIndexMap[docId] || !this._linkIndexMap[docId][blockId]) {\n      return;\n    }\n    const previousLink = this._linkIndexMap[docId][blockId];\n    delete this._linkIndexMap[docId][blockId];\n    if (previousLink.length) {\n      this.slots.indexUpdated.emit({\n        action: 'delete',\n        docId,\n        blockId,\n      });\n    }\n  }\n\n  /**\n   * Get the list of backlinks for a given doc\n   */\n  getBacklink(targetDocId: DocId) {\n    if (this._backlinkIndexMapCache) {\n      return this._backlinkIndexMapCache[targetDocId] ?? [];\n    }\n    const backlinkIndexMapCache: Record<DocId, LinkedNode[]> = {};\n    for (const [fromDocId, blockMap] of Object.entries(this._linkIndexMap)) {\n      for (const [fromBlockId, links] of Object.entries(blockMap)) {\n        links.forEach(({ pageId, type }) => {\n          if (!(pageId in backlinkIndexMapCache)) {\n            backlinkIndexMapCache[pageId] = [];\n          }\n          backlinkIndexMapCache[pageId].push({\n            pageId: fromDocId,\n            blockId: fromBlockId,\n            type,\n          });\n        });\n      }\n    }\n    this._backlinkIndexMapCache = backlinkIndexMapCache;\n    return this._backlinkIndexMapCache[targetDocId] ?? [];\n  }\n\n  dispose() {\n    this._disposables.dispose();\n  }\n}\n"]}