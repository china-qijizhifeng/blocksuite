{"version":3,"file":"search.js","sourceRoot":"","sources":["../../src/indexer/search.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  IS_NODE,\n  IS_WEB,\n  REQUEST_IDLE_CALLBACK_ENABLED,\n} from '@blocksuite/global/env';\nimport type { DocumentSearchOptions } from 'flexsearch';\nimport FlexSearch from 'flexsearch';\nimport type { Doc } from 'yjs';\nimport { Text as YText } from 'yjs';\n\nimport type { YBlock } from '../store/doc/block.js';\nimport type { YBlocks } from '../store/doc/block-collection.js';\nimport type { BlockSuiteDoc } from '../yjs/index.js';\n\nconst DocumentIndexer = FlexSearch.Document;\nconst Index = FlexSearch.Index;\n\nexport type QueryContent = string | Partial<DocumentSearchOptions<boolean>>;\n\ntype SearchResult = { id: string; doc: { space: string; content: string } };\ntype SearchResults = { field: string; result: SearchResult[] };\n\nfunction tokenize(locale: string) {\n  const tokenizer = Intl.Segmenter;\n  if (tokenizer) {\n    // extract the latin encoder inside flexsearch\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const latinIndexer: any = new Index({ charset: 'latin:advanced' });\n    const latinEncoder = latinIndexer.encode.bind(latinIndexer);\n    // check latin characters\n    const latinChecker = /^[\\p{Script=Latin}\\p{Mark}\\d]+$/u;\n\n    const segmenter = new tokenizer([locale], { granularity: 'word' });\n    return (text: string) => {\n      const latinChars: string[] = [];\n      const cjkChars = Array.from(segmenter.segment(text))\n        .filter(s => {\n          if (s.isWordLike) {\n            if (!latinChecker.test(s.segment)) {\n              return true;\n            }\n            latinChars.push(s.segment);\n          }\n          return false;\n        })\n        .map(s => s.segment);\n\n      return [...cjkChars, ...latinEncoder(latinChars.join(' '))];\n    };\n  }\n  return (text: string) => {\n    // eslint-disable-next-line no-control-regex\n    return text.replace(/[\\x00-\\x7F]/g, '').split('');\n  };\n}\n\ntype IndexMeta = Readonly<{\n  content: string;\n  reference?: string;\n  space: string;\n  tags: string[];\n}>;\n\nconst REINDEX_TIMEOUT = 200;\n\nexport class SearchIndexer {\n  private readonly _doc: BlockSuiteDoc;\n\n  private readonly _indexer: FlexSearch.Document<IndexMeta, string[]>;\n\n  private _reindexMap: Map<string, IndexMeta> | null = null;\n\n  constructor(\n    doc: BlockSuiteDoc,\n    // locale string based on https://www.w3.org/International/articles/bcp47/\n    locale = 'en-US'\n  ) {\n    this._doc = doc;\n    this._indexer = new DocumentIndexer<IndexMeta, string[]>({\n      document: {\n        id: 'id',\n        index: ['content', 'reference', 'space'],\n        tag: 'tags',\n        store: ['space', 'content'],\n      },\n      encode: tokenize(locale),\n      tokenize: 'forward',\n      context: true,\n    });\n    this._reindexMap = new Map();\n    this._reindex();\n\n    // fixme(Mirone): use better way to listen to doc changes\n    doc.spaces.observe(event => {\n      event.keysChanged.forEach(docId => {\n        const doc = this._getDoc(docId);\n        if (doc != null) {\n          this._handleDocIndexing(docId, doc);\n        }\n      });\n    });\n\n    if (IS_WEB) {\n      window.addEventListener('beforeunload', () => {\n        this._reindexMap = null;\n      });\n    }\n    if (IS_NODE) {\n      process.on('exit', () => {\n        this._reindexMap = null;\n      });\n    }\n  }\n\n  private _reindex = () => {\n    if (!this._reindexMap) return;\n\n    for (const id of this._reindexMap.keys()) {\n      const meta = this._reindexMap.get(id);\n      if (meta) {\n        this._reindexMap.delete(id);\n        this._indexer.add(id, meta);\n      }\n    }\n\n    setTimeout(() => {\n      if (!this._reindexMap) return;\n      if (REQUEST_IDLE_CALLBACK_ENABLED) {\n        requestIdleCallback(this._reindex, { timeout: 1000 });\n      } else {\n        setTimeout(this._reindex, 1000);\n      }\n    }, REINDEX_TIMEOUT);\n  };\n\n  private _search(query: QueryContent): SearchResults[] {\n    if (typeof query === 'object') {\n      return this._indexer.search({\n        ...query,\n        enrich: true,\n      }) as unknown as SearchResults[];\n    } else {\n      return this._indexer.search(query, {\n        enrich: true,\n      }) as unknown as SearchResults[];\n    }\n  }\n\n  private _handleDocIndexing(docId: string, doc: Doc) {\n    if (!doc) {\n      return;\n    }\n    const yBlocks = doc.getMap('blocks') as YBlocks;\n    this.refreshDocIndex(docId, doc);\n    yBlocks.observeDeep(events => {\n      const keys = events.flatMap(e => {\n        // eslint-disable-next-line no-bitwise\n        if ((e.path?.length | 0) > 0) {\n          return [[e.path[0], 'update'] as [string, 'update']];\n        }\n        return Array.from(e.changes.keys.entries()).map(\n          ([k, { action }]) => [k, action] as [string, typeof action]\n        );\n      });\n\n      if (keys.length) {\n        keys.forEach(([key, action]) => {\n          this._refreshIndex(docId, key, action, yBlocks.get(key));\n        });\n      }\n    });\n  }\n\n  private _refreshIndex(\n    doc: string,\n    id: string,\n    action: 'add' | 'update' | 'delete',\n    block?: YBlock\n  ) {\n    switch (action) {\n      case 'add':\n      case 'update': {\n        if (block) {\n          const content = this._toContent(\n            block.get('prop:title') || block.get('prop:text')\n          );\n          if (content) {\n            this._reindexMap?.set(id, {\n              content,\n              space: doc,\n              tags: [doc],\n            });\n          }\n        }\n        break;\n      }\n      case 'delete': {\n        this._reindexMap?.delete(id);\n        this._indexer.remove(id);\n        break;\n      }\n    }\n  }\n\n  private _toContent(obj: unknown) {\n    if (obj) {\n      if (typeof obj === 'string') {\n        return obj;\n      } else if (obj instanceof YText) {\n        return obj.toJSON();\n      }\n    }\n    return undefined;\n  }\n\n  private _getDoc(key: string): Doc | undefined {\n    try {\n      return this._doc.spaces.get(key);\n    } catch (_) {\n      return undefined;\n    }\n  }\n\n  search(query: QueryContent) {\n    return new Map(\n      this._search(query).flatMap(({ result }) =>\n        result.map(r => [r.id, { space: r.doc.space, content: r.doc.content }])\n      )\n    );\n  }\n\n  refreshDocIndex(docId: string, doc: Doc) {\n    const yBlocks = doc.getMap('blocks') as YBlocks;\n    yBlocks.forEach((_, key) => {\n      this._refreshIndex(docId, key, 'add', yBlocks.get(key));\n    });\n  }\n}\n"]}