{"version":3,"file":"block-collection.js","sourceRoot":"","sources":["../../../src/store/doc/block-collection.ts"],"names":[],"mappings":"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","sourcesContent":["import { Slot } from '@blocksuite/global/utils';\nimport { uuidv4 } from 'lib0/random.js';\nimport * as Y from 'yjs';\n\nimport { Text } from '../../reactive/text.js';\nimport type { BlockModel } from '../../schema/base.js';\nimport type { IdGenerator } from '../../utils/id-generator.js';\nimport type { AwarenessStore, BlockSuiteDoc } from '../../yjs/index.js';\nimport type { DocCollection } from '../collection.js';\nimport { Space } from '../space.js';\nimport { DocCRUD } from './crud.js';\nimport { type BlockSelector, BlockViewType, type YBlock } from './index.js';\nimport { Doc } from './index.js';\n\nexport type YBlocks = Y.Map<YBlock>;\ntype FlatBlockMap = Record<string, YBlock>;\n\n/** JSON-serializable properties of a block */\nexport type BlockSysProps = {\n  id: string;\n  flavour: string;\n  children?: BlockModel[];\n};\nexport type BlockProps = BlockSysProps & Record<string, unknown>;\n\ntype DocOptions = {\n  id: string;\n  collection: DocCollection;\n  doc: BlockSuiteDoc;\n  awarenessStore: AwarenessStore;\n  idGenerator?: IdGenerator;\n};\n\nexport const defaultBlockSelector = () => BlockViewType.Display;\n\nexport type GetDocOptions = {\n  selector?: BlockSelector;\n  readonly?: boolean;\n};\n\nexport class BlockCollection extends Space<FlatBlockMap> {\n  get readonly() {\n    return this.awarenessStore.isReadonly(this);\n  }\n\n  get ready() {\n    return this._ready;\n  }\n\n  get history() {\n    return this._history;\n  }\n\n  get crud() {\n    return this._docCRUD;\n  }\n\n  get collection() {\n    return this._collection;\n  }\n\n  get docSync() {\n    return this.collection.docSync;\n  }\n\n  get awarenessSync() {\n    return this.collection.awarenessSync;\n  }\n\n  get blobSync() {\n    return this.collection.blobSync;\n  }\n\n  get schema() {\n    return this.collection.schema;\n  }\n\n  get meta() {\n    return this.collection.meta.getDocMeta(this.id);\n  }\n\n  get isEmpty() {\n    return this._yBlocks.size === 0;\n  }\n\n  get canUndo() {\n    if (this.readonly) {\n      return false;\n    }\n    return this._history.canUndo();\n  }\n\n  get canRedo() {\n    if (this.readonly) {\n      return false;\n    }\n    return this._history.canRedo();\n  }\n\n  get Text() {\n    return Text;\n  }\n\n  private readonly _collection: DocCollection;\n\n  private readonly _idGenerator: IdGenerator;\n\n  private readonly _docCRUD: DocCRUD;\n\n  private _history!: Y.UndoManager;\n\n  /** Indicate whether the block tree is ready */\n  private _ready = false;\n\n  private _shouldTransact = true;\n\n  private _docMap = {\n    undefined: new WeakMap<BlockSelector, Doc>(),\n    true: new WeakMap<BlockSelector, Doc>(),\n    false: new WeakMap<BlockSelector, Doc>(),\n  };\n\n  readonly slots = {\n    historyUpdated: new Slot(),\n    yBlockUpdated: new Slot<\n      | {\n          type: 'add';\n          id: string;\n        }\n      | {\n          type: 'delete';\n          id: string;\n        }\n    >(),\n  };\n\n  constructor({\n    id,\n    collection,\n    doc,\n    awarenessStore,\n    idGenerator = uuidv4,\n  }: DocOptions) {\n    super(id, doc, awarenessStore);\n    this._collection = collection;\n    this._idGenerator = idGenerator;\n    this._docCRUD = new DocCRUD(this._yBlocks, collection.schema);\n  }\n\n  private _getReadonlyKey(readonly?: boolean): 'true' | 'false' | 'undefined' {\n    return (readonly?.toString() as 'true' | 'false') ?? 'undefined';\n  }\n\n  private _initYBlocks() {\n    const { _yBlocks } = this;\n    _yBlocks.observeDeep(this._handleYEvents);\n    this._history = new Y.UndoManager([_yBlocks], {\n      trackedOrigins: new Set([this._ySpaceDoc.clientID]),\n    });\n\n    this._history.on('stack-cleared', this._historyObserver);\n    this._history.on('stack-item-added', this._historyObserver);\n    this._history.on('stack-item-popped', this._historyObserver);\n    this._history.on('stack-item-updated', this._historyObserver);\n  }\n\n  private _historyObserver = () => {\n    this.slots.historyUpdated.emit();\n  };\n\n  private _handleYBlockAdd(id: string) {\n    this.slots.yBlockUpdated.emit({ type: 'add', id });\n  }\n\n  private _handleYBlockDelete(id: string) {\n    this.slots.yBlockUpdated.emit({ type: 'delete', id });\n  }\n\n  private _handleYEvent(event: Y.YEvent<YBlock | Y.Text | Y.Array<unknown>>) {\n    // event on top-level block store\n    if (event.target !== this._yBlocks) {\n      return;\n    }\n    event.keys.forEach((value, id) => {\n      try {\n        if (value.action === 'add') {\n          this._handleYBlockAdd(id);\n          return;\n        }\n        if (value.action === 'delete') {\n          this._handleYBlockDelete(id);\n          return;\n        }\n      } catch (e) {\n        console.error('An error occurred while handling Yjs event:');\n        console.error(e);\n      }\n    });\n  }\n\n  // Handle all the events that happen at _any_ level (potentially deep inside the structure).\n  // So, we apply a listener at the top level for the flat structure of the current\n  // doc/space container.\n  private _handleYEvents = (events: Y.YEvent<YBlock | Y.Text>[]) => {\n    events.forEach(event => this._handleYEvent(event));\n  };\n\n  private _handleVersion() {\n    // Initialization from empty yDoc, indicating that the document is new.\n    if (!this.collection.meta.hasVersion) {\n      this.collection.meta.writeVersion(this.collection);\n    } else {\n      // Initialization from existing yDoc, indicating that the document is loaded from storage.\n      if (this.awarenessStore.getFlag('enable_legacy_validation')) {\n        this.collection.meta.validateVersion(this.collection);\n      }\n    }\n  }\n\n  getDoc({ selector = defaultBlockSelector, readonly }: GetDocOptions = {}) {\n    const readonlyKey = this._getReadonlyKey(readonly);\n\n    if (this._docMap[readonlyKey].has(selector)) {\n      return this._docMap[readonlyKey].get(selector)!;\n    }\n\n    const doc = new Doc({\n      blockCollection: this,\n      crud: this._docCRUD,\n      schema: this.collection.schema,\n      selector,\n      readonly,\n    });\n\n    this._docMap[readonlyKey].set(selector, doc);\n\n    return doc;\n  }\n\n  clearSelector(selector: BlockSelector, readonly?: boolean) {\n    const readonlyKey = this._getReadonlyKey(readonly);\n\n    this._docMap[readonlyKey].delete(selector);\n  }\n\n  withoutTransact(callback: () => void) {\n    this._shouldTransact = false;\n    callback();\n    this._shouldTransact = true;\n  }\n\n  override transact(\n    fn: () => void,\n    shouldTransact: boolean = this._shouldTransact\n  ) {\n    super.transact(fn, shouldTransact);\n  }\n\n  undo() {\n    if (this.readonly) {\n      console.error('cannot modify data in readonly mode');\n      return;\n    }\n    this._history.undo();\n  }\n\n  redo() {\n    if (this.readonly) {\n      console.error('cannot modify data in readonly mode');\n      return;\n    }\n    this._history.redo();\n  }\n\n  /** Capture current operations to undo stack synchronously. */\n  captureSync() {\n    this._history.stopCapturing();\n  }\n\n  resetHistory() {\n    this._history.clear();\n  }\n\n  generateBlockId() {\n    return this._idGenerator();\n  }\n\n  override load(initFn?: () => void): this {\n    if (this.ready) {\n      return this;\n    }\n\n    super.load();\n\n    if ((this.collection.meta.docs?.length ?? 0) <= 1) {\n      this._handleVersion();\n    }\n\n    this._initYBlocks();\n\n    this._yBlocks.forEach((_, id) => {\n      this._handleYBlockAdd(id);\n    });\n\n    initFn?.();\n\n    this._ready = true;\n\n    return this;\n  }\n\n  dispose() {\n    this.slots.historyUpdated.dispose();\n\n    if (this.ready) {\n      this._yBlocks.unobserveDeep(this._handleYEvents);\n      this._yBlocks.clear();\n    }\n  }\n}\n\ndeclare global {\n  namespace BlockSuite {\n    interface BlockModels {}\n\n    type Flavour = string & keyof BlockModels;\n\n    type ModelProps<Model> = Partial<\n      Model extends BlockModel<infer U> ? U : never\n    >;\n  }\n}\n"]}