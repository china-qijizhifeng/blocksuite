{"version":3,"file":"block.js","sourceRoot":"","sources":["../../../src/store/doc/block.ts"],"names":[],"mappings":"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","sourcesContent":["import { assertExists } from '@blocksuite/global/utils';\nimport * as Y from 'yjs';\n\nimport { Boxed, type UnRecord, y2Native } from '../../reactive/index.js';\nimport { createYProxy, native2Y } from '../../reactive/index.js';\nimport { BlockModel, internalPrimitives } from '../../schema/base.js';\nimport type { Schema } from '../../schema/index.js';\nimport { BlockViewType, type Doc } from './doc.js';\n\nexport type YBlock = Y.Map<unknown> & {\n  get(prop: 'sys:id'): string;\n  get(prop: 'sys:flavour'): string;\n  get(prop: 'sys:children'): Y.Array<string>;\n  get<T = unknown>(prop: string): T;\n};\n\nexport type BlockOptions = {\n  onChange?: (block: Block, key: string, value: unknown) => void;\n};\n\nexport class Block {\n  private _byPassProxy: boolean = false;\n\n  private readonly _stashed = new Set<string | number>();\n\n  blockViewType: BlockViewType = BlockViewType.Display;\n\n  readonly model: BlockModel;\n\n  readonly id: string;\n\n  readonly flavour: string;\n\n  readonly version: number;\n\n  readonly yChildren: Y.Array<string[]>;\n\n  constructor(\n    readonly schema: Schema,\n    readonly yBlock: YBlock,\n    readonly doc?: Doc,\n    readonly options: BlockOptions = {}\n  ) {\n    const { id, flavour, version, yChildren, props } = this._parseYBlock();\n\n    this.id = id;\n    this.flavour = flavour;\n    this.yChildren = yChildren;\n    this.version = version;\n\n    this.model = this._createModel(props);\n\n    this.yChildren.observe(() => {\n      this.model.childrenUpdated.emit();\n    });\n\n    this.yBlock.observe(event => {\n      event.keysChanged.forEach(key => {\n        const type = event.changes.keys.get(key);\n        if (!type) {\n          return;\n        }\n        if (type.action === 'update' || type.action === 'add') {\n          const value = this.yBlock.get(key);\n          const keyName = key.replace('prop:', '');\n          const proxy = this._getPropsProxy(keyName, value);\n          this._byPassUpdate(() => {\n            // @ts-ignore\n            this.model[keyName] = proxy;\n          });\n          this.options.onChange?.(this, keyName, value);\n          return;\n        }\n        if (type.action === 'delete') {\n          const keyName = key.replace('prop:', '');\n          this._byPassUpdate(() => {\n            // @ts-ignore\n            delete this.model[keyName];\n          });\n          this.options.onChange?.(this, keyName, undefined);\n          return;\n        }\n      });\n    });\n\n    this.yBlock.observeDeep(evtArr => {\n      const evt = evtArr[0];\n      // filter out events from itself\n      // as this event is triggered in observe function\n      if (!evt || evt.currentTarget === evt.target) return;\n\n      this.options.onChange?.(this, '', undefined);\n    });\n\n    if (doc) {\n      this.model.doc = doc;\n    }\n  }\n\n  private _stashProp(prop: string) {\n    (this.model as BlockModel<Record<string, unknown>>)[prop] = y2Native(\n      this.yBlock.get(`prop:${prop}`),\n      {\n        transform: (value, origin) => {\n          if (Boxed.is(origin)) {\n            return value;\n          }\n          if (origin instanceof Y.Map) {\n            return new Proxy(value as UnRecord, {\n              get: (target, p, receiver) => {\n                return Reflect.get(target, p, receiver);\n              },\n              set: (target, p, value, receiver) => {\n                const result = Reflect.set(target, p, value, receiver);\n                this.options.onChange?.(this, prop, value);\n                return result;\n              },\n              deleteProperty: (target, p) => {\n                const result = Reflect.deleteProperty(target, p);\n                this.options.onChange?.(this, prop, undefined);\n                return result;\n              },\n            });\n          }\n          if (origin instanceof Y.Array) {\n            return new Proxy(value as unknown[], {\n              get: (target, p, receiver) => {\n                return Reflect.get(target, p, receiver);\n              },\n              set: (target, p, value, receiver) => {\n                const index = Number(p);\n                if (Number.isNaN(index)) {\n                  return Reflect.set(target, p, value, receiver);\n                }\n                const result = Reflect.set(target, p, value, receiver);\n                this.options.onChange?.(this, prop, value);\n                return result;\n              },\n              deleteProperty: (target, p) => {\n                const result = Reflect.deleteProperty(target, p);\n                this.options.onChange?.(this, p as string, undefined);\n                return result;\n              },\n            });\n          }\n\n          return value;\n        },\n      }\n    );\n  }\n\n  private _popProp(prop: string) {\n    const model = this.model as BlockModel<Record<string, unknown>>;\n\n    const value = model[prop];\n    this._stashed.delete(prop);\n    model[prop] = value;\n  }\n\n  private _byPassUpdate = (fn: () => void) => {\n    this._byPassProxy = true;\n    fn();\n    this._byPassProxy = false;\n  };\n\n  private _getPropsProxy = (name: string, value: unknown) => {\n    return createYProxy(value, {\n      onChange: () => {\n        this.options.onChange?.(this, name, value);\n      },\n    });\n  };\n\n  private _parseYBlock() {\n    let id: string | undefined;\n    let flavour: string | undefined;\n    let version: number | undefined;\n    let yChildren: Y.Array<string[]> | undefined;\n    const props: Record<string, unknown> = {};\n\n    this.yBlock.forEach((value, key) => {\n      if (key.startsWith('prop:')) {\n        const keyName = key.replace('prop:', '');\n        props[keyName] = this._getPropsProxy(keyName, value);\n        return;\n      }\n      if (key === 'sys:id' && typeof value === 'string') {\n        id = value;\n        return;\n      }\n      if (key === 'sys:flavour' && typeof value === 'string') {\n        flavour = value;\n        return;\n      }\n      if (key === 'sys:children' && value instanceof Y.Array) {\n        yChildren = value;\n        return;\n      }\n      if (key === 'sys:version' && typeof value === 'number') {\n        version = value;\n        return;\n      }\n    });\n\n    assertExists(id, 'Block id is not found');\n    assertExists(flavour, 'Block flavour is not found');\n    assertExists(yChildren, 'Block children is not found');\n\n    const schema = this.schema.flavourSchemaMap.get(flavour);\n    assertExists(schema, `Cannot find schema for flavour ${flavour}`);\n    const defaultProps = schema.model.props?.(internalPrimitives);\n\n    if (typeof version !== 'number') {\n      // no version found in data, set to schema version\n      version = schema.version;\n    }\n\n    // Set default props if not exists\n    if (defaultProps) {\n      Object.entries(defaultProps).forEach(([key, value]) => {\n        if (key in props) return;\n\n        const yValue = native2Y(value);\n        this.yBlock.set(`prop:${key}`, yValue);\n        props[key] = this._getPropsProxy(key, yValue);\n      });\n    }\n\n    return {\n      id,\n      flavour,\n      version,\n      props,\n      yChildren,\n    };\n  }\n\n  private _createModel(props: UnRecord) {\n    const schema = this.schema.flavourSchemaMap.get(this.flavour);\n    assertExists(schema, `Cannot find schema for flavour ${this.flavour}`);\n\n    const model = schema.model.toModel?.() ?? new BlockModel<object>();\n    Object.assign(model, props);\n\n    model.id = this.id;\n    model.version = this.version;\n    model.keys = Object.keys(props);\n    model.flavour = schema.model.flavour;\n    model.role = schema.model.role;\n    model.yBlock = this.yBlock;\n    model.stash = this.stash;\n    model.pop = this.pop;\n\n    return new Proxy(model, {\n      has: (target, p) => {\n        return Reflect.has(target, p);\n      },\n      set: (target, p, value, receiver) => {\n        if (\n          !this._byPassProxy &&\n          typeof p === 'string' &&\n          model.keys.includes(p)\n        ) {\n          if (this._stashed.has(p)) {\n            const result = Reflect.set(target, p, value, receiver);\n            this.options.onChange?.(this, p, value);\n            return result;\n          }\n\n          const yValue = native2Y(value);\n          this.yBlock.set(`prop:${p}`, yValue);\n          const proxy = this._getPropsProxy(p, yValue);\n          return Reflect.set(target, p, proxy, receiver);\n        }\n\n        return Reflect.set(target, p, value, receiver);\n      },\n      get: (target, p, receiver) => {\n        return Reflect.get(target, p, receiver);\n      },\n      deleteProperty: (target, p) => {\n        if (\n          !this._byPassProxy &&\n          typeof p === 'string' &&\n          model.keys.includes(p)\n        ) {\n          this.yBlock.delete(`prop:${p}`);\n        }\n\n        return Reflect.deleteProperty(target, p);\n      },\n    });\n  }\n\n  stash = (prop: string) => {\n    if (this._stashed.has(prop)) return;\n\n    this._stashed.add(prop);\n    this._stashProp(prop);\n  };\n\n  pop = (prop: string) => {\n    if (!this._stashed.has(prop)) return;\n    this._popProp(prop);\n  };\n}\n"]}