{"version":3,"file":"space.js","sourceRoot":"","sources":["../../src/store/space.ts"],"names":[],"mappings":"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","sourcesContent":["import { Slot } from '@blocksuite/global/utils';\nimport * as Y from 'yjs';\n\nimport type { AwarenessStore } from '../yjs/awareness.js';\nimport type { BlockSuiteDoc } from '../yjs/index.js';\n\nexport interface StackItem {\n  meta: Map<'cursor-location' | 'selection-state', unknown>;\n}\n\nexport class Space<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  State extends Record<string, unknown> = Record<string, any>,\n> {\n  get yBlocks() {\n    return this._yBlocks;\n  }\n\n  get loaded() {\n    return this._loaded;\n  }\n\n  get spaceDoc() {\n    return this._ySpaceDoc;\n  }\n\n  private _loaded!: boolean;\n\n  private _onLoadSlot = new Slot();\n\n  /**\n   * @internal Used for convenient access to the underlying Yjs map,\n   * can be used interchangeably with ySpace\n   */\n  protected readonly _ySpaceDoc: Y.Doc;\n\n  protected readonly _yBlocks: Y.Map<State[keyof State]>;\n\n  readonly id: string;\n\n  readonly rootDoc: BlockSuiteDoc;\n\n  readonly awarenessStore: AwarenessStore;\n\n  constructor(\n    id: string,\n    rootDoc: BlockSuiteDoc,\n    awarenessStore: AwarenessStore\n  ) {\n    this.id = id;\n    this.rootDoc = rootDoc;\n    this.awarenessStore = awarenessStore;\n\n    this._ySpaceDoc = this._initSubDoc();\n\n    this._yBlocks = this._ySpaceDoc.getMap('blocks');\n  }\n\n  private _initSubDoc = () => {\n    let subDoc = this.rootDoc.spaces.get(this.id);\n    if (!subDoc) {\n      subDoc = new Y.Doc({\n        guid: this.id,\n      });\n      this.rootDoc.spaces.set(this.id, subDoc);\n      this._loaded = true;\n      this._onLoadSlot.emit();\n    } else {\n      this._loaded = false;\n      this.rootDoc.on('subdocs', this._onSubdocEvent);\n    }\n\n    return subDoc;\n  };\n\n  private _onSubdocEvent = ({ loaded }: { loaded: Set<Y.Doc> }): void => {\n    const result = Array.from(loaded).find(\n      doc => doc.guid === this._ySpaceDoc.guid\n    );\n    if (!result) {\n      return;\n    }\n    this.rootDoc.off('subdocs', this._onSubdocEvent);\n    this._loaded = true;\n    this._onLoadSlot.emit();\n  };\n\n  load() {\n    this._ySpaceDoc.load();\n\n    return this;\n  }\n\n  remove() {\n    this.destroy();\n    this.rootDoc.spaces.delete(this.id);\n  }\n\n  destroy() {\n    this._ySpaceDoc.destroy();\n    this._onLoadSlot.dispose();\n    this._loaded = false;\n  }\n\n  clear() {\n    this._yBlocks.clear();\n  }\n\n  /**\n   * If `shouldTransact` is `false`, the transaction will not be push to the history stack.\n   */\n  transact(fn: () => void, shouldTransact = true) {\n    this._ySpaceDoc.transact(\n      () => {\n        try {\n          fn();\n        } catch (e) {\n          console.error(\n            `An error occurred while Y.doc ${this._ySpaceDoc.guid} transacting:`\n          );\n          console.error(e);\n        }\n      },\n      shouldTransact ? this.rootDoc.clientID : null\n    );\n  }\n}\n"]}