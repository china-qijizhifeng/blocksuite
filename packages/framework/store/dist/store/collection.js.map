{"version":3,"file":"collection.js","sourceRoot":"","sources":["../../src/store/collection.ts"],"names":[],"mappings":"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","sourcesContent":["import { assertExists, Slot } from '@blocksuite/global/utils';\nimport * as Y from 'yjs';\n\nimport type { Schema } from '../schema/index.js';\nimport type { AwarenessStore } from '../yjs/index.js';\nimport { DocCollectionAddonType, indexer, test } from './addon/index.js';\nimport { BlockCollection, type GetDocOptions } from './doc/block-collection.js';\nimport type { BlockSelector, Doc } from './doc/index.js';\nimport { DocCollectionMeta, type DocMeta } from './meta.js';\nimport { Store, type StoreOptions } from './store.js';\n\nexport type DocCollectionOptions = StoreOptions & {\n  schema: Schema;\n};\n\n@indexer\n@test\nexport class DocCollection extends DocCollectionAddonType {\n  get id() {\n    return this._store.id;\n  }\n\n  get isEmpty() {\n    if (this.doc.store.clients.size === 0) return true;\n\n    let flag = false;\n    if (this.doc.store.clients.size === 1) {\n      const items = Array.from(this.doc.store.clients.values())[0];\n      // workspaceVersion and pageVersion were set when the collection is initialized\n      if (items.length <= 2) {\n        flag = true;\n      }\n    }\n    return flag;\n  }\n\n  get store(): Store {\n    return this._store;\n  }\n\n  get awarenessStore(): AwarenessStore {\n    return this._store.awarenessStore;\n  }\n\n  get docs() {\n    return this._store.spaces as Map<string, BlockCollection>;\n  }\n\n  get doc() {\n    return this._store.doc;\n  }\n\n  get idGenerator() {\n    return this._store.idGenerator;\n  }\n\n  get schema() {\n    return this._schema;\n  }\n\n  get docSync() {\n    return this.store.docSync;\n  }\n\n  get awarenessSync() {\n    return this.store.awarenessSync;\n  }\n\n  get blobSync() {\n    return this.store.blobSync;\n  }\n\n  static Y = Y;\n\n  protected _store: Store;\n\n  protected readonly _schema: Schema;\n\n  meta: DocCollectionMeta;\n\n  slots = {\n    docAdded: new Slot<string>(),\n    docUpdated: new Slot(),\n    docRemoved: new Slot<string>(),\n  };\n\n  constructor(options: DocCollectionOptions) {\n    super();\n    this._schema = options.schema;\n\n    this._store = new Store(options);\n\n    this.meta = new DocCollectionMeta(this.doc);\n    this._bindDocMetaEvents();\n  }\n\n  private _hasDoc(docId: string) {\n    return this.docs.has(docId);\n  }\n\n  private _bindDocMetaEvents() {\n    this.meta.docMetaAdded.on(docId => {\n      const doc = new BlockCollection({\n        id: docId,\n        collection: this,\n        doc: this.doc,\n        awarenessStore: this.awarenessStore,\n        idGenerator: this._store.idGenerator,\n      });\n      this._store.addSpace(doc);\n      this.slots.docAdded.emit(doc.id);\n    });\n\n    this.meta.docMetaUpdated.on(() => this.slots.docUpdated.emit());\n\n    this.meta.docMetaRemoved.on(id => {\n      const space = this.getBlockCollection(id);\n      if (!space) return;\n      this._store.removeSpace(space);\n      space.remove();\n      this.slots.docRemoved.emit(id);\n    });\n  }\n\n  getDoc(docId: string, options?: GetDocOptions): Doc | null {\n    const collection = this.getBlockCollection(docId);\n    return collection?.getDoc(options) ?? null;\n  }\n\n  getBlockCollection(docId: string): BlockCollection | null {\n    const space = this.docs.get(docId) as BlockCollection | undefined;\n    return space ?? null;\n  }\n\n  /**\n   * By default, only an empty doc will be created.\n   * If the `init` parameter is passed, a `surface`, `note`, and `paragraph` block\n   * will be created in the doc simultaneously.\n   */\n  createDoc(options: { id?: string; selector?: BlockSelector } = {}) {\n    const { id: docId = this.idGenerator(), selector } = options;\n    if (this._hasDoc(docId)) {\n      throw new Error('doc already exists');\n    }\n\n    this.meta.addDocMeta({\n      id: docId,\n      title: '',\n      createDate: Date.now(),\n      tags: [],\n    });\n    return this.getDoc(docId, { selector }) as Doc;\n  }\n\n  /** Update doc meta state. Note that this intentionally does not mutate doc state. */\n  setDocMeta(\n    docId: string,\n    // You should not update subDocIds directly.\n    props: Partial<DocMeta>\n  ) {\n    this.meta.setDocMeta(docId, props);\n  }\n\n  removeDoc(docId: string) {\n    const docMeta = this.meta.getDocMeta(docId);\n    assertExists(docMeta);\n\n    const blockCollection = this.getBlockCollection(docId);\n    if (!blockCollection) return;\n\n    blockCollection.dispose();\n    this.meta.removeDocMeta(docId);\n    this._store.removeSpace(blockCollection);\n  }\n\n  /**\n   * Start the data sync process\n   */\n  start() {\n    this.docSync.start();\n    this.blobSync.start();\n    this.awarenessSync.connect();\n  }\n\n  /**\n   * Verify that all data has been successfully saved to the primary storage.\n   * Return true if the data transfer is complete and it is secure to terminate the synchronization operation.\n   */\n  canGracefulStop() {\n    this.docSync.canGracefulStop();\n  }\n\n  /**\n   * Wait for all data has been successfully saved to the primary storage.\n   */\n  waitForGracefulStop(abort?: AbortSignal) {\n    return this.docSync.waitForGracefulStop(abort);\n  }\n\n  /**\n   * Terminate the data sync process forcefully, which may cause data loss.\n   * It is advised to invoke `canGracefulStop` before calling this method.\n   */\n  forceStop() {\n    this.docSync.forceStop();\n    this.blobSync.stop();\n    this.awarenessSync.disconnect();\n  }\n\n  waitForSynced() {\n    return this.docSync.waitForSynced();\n  }\n}\n"]}