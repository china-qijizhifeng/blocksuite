{"version":3,"file":"chat.js","sourceRoot":"","sources":["../../../../src/fragments/copilot-panel/chat/chat.ts"],"names":[],"mappings":"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","sourcesContent":["import { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { css, html, nothing, type PropertyValues } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport {\n  ChatServiceKind,\n  EmbeddingServiceKind,\n} from '../copilot-service/service-base.js';\nimport { ChatFeatureKey } from '../doc/api.js';\nimport type { AILogic } from '../logic.js';\nimport type { ChatMessage, ChatReactiveData, EmbeddedDoc } from './logic.js';\n\n@customElement('copilot-chat-panel')\nexport class CopilotChatPanel\n  extends WithDisposable(ShadowlessElement)\n  implements ChatReactiveData\n{\n  get chat() {\n    return this.logic.chat;\n  }\n\n  get host() {\n    return this.logic.getHost();\n  }\n\n  get loading(): boolean {\n    return this.currentRequest != null;\n  }\n\n  static override styles = css`\n    copilot-chat-panel {\n      margin-top: 12px;\n      display: flex;\n      flex-direction: column;\n      width: 100%;\n      font-family: var(--affine-font-family);\n      height: 100%;\n      gap: 4px;\n      overflow: auto;\n    }\n\n    .copilot-chat-prompt-container {\n      border-top: 0.5px solid var(--affine-border-color);\n      height: 189px;\n      padding: 8px;\n      display: flex;\n      gap: 10px;\n    }\n\n    .copilot-chat-prompt {\n      flex: 1;\n      border: none;\n      border-radius: 4px;\n      padding: 4px 8px;\n      outline: none;\n      background-color: transparent;\n    }\n\n    .send-button {\n      height: 32px;\n      border-radius: 50%;\n      width: 32px;\n      background-color: var(--affine-primary-color);\n      color: white;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n    }\n\n    .sync-workspace-button {\n      border: 1px solid var(--affine-border-color);\n      height: 32px;\n      border-radius: 4px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n    }\n\n    .synced-doc-list {\n      margin-bottom: 14px;\n      color: var(--affine-text-secondary-color);\n      font-size: 12px;\n    }\n\n    .history-item {\n      position: relative;\n      max-width: calc(100% - 78px);\n      display: flex;\n      flex-direction: column;\n      padding: 10px;\n      border-radius: 8px;\n      font-size: 14px;\n      border: 0.5px solid var(--affine-border-color);\n      background-color: var(--affine-background-primary-color);\n      white-space: pre-wrap;\n      line-height: 22px;\n      color: var(--affine-text-primary-color);\n    }\n\n    .history-refs {\n      font-size: 12px;\n      color: var(--affine-text-secondary-color);\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor logic!: AILogic;\n\n  @query('.chat-messages-container')\n  accessor chatMessagesContainer!: HTMLDivElement;\n\n  @state()\n  accessor tempMessage: string | undefined = undefined;\n\n  @state()\n  accessor history: ChatMessage[] = [];\n\n  @state()\n  accessor currentRequest: number | undefined = undefined;\n\n  @state()\n  accessor value = '';\n\n  @state()\n  accessor syncedDocs: EmbeddedDoc[] = [];\n\n  @state()\n  accessor surfaceSelection = false;\n\n  @state()\n  accessor docSelection = false;\n\n  @query('.copilot-chat-panel-chat-input')\n  accessor input!: HTMLInputElement;\n\n  protected override updated(_changedProperties: PropertyValues) {\n    super.updated(_changedProperties);\n    if (\n      _changedProperties.has('history') ||\n      _changedProperties.has('tempMessage')\n    ) {\n      this.chatMessagesContainer.scrollTop =\n        this.chatMessagesContainer.scrollHeight;\n    }\n  }\n\n  protected override render(): unknown {\n    const getAnswer = async () => {\n      this.input.focus();\n      const text = this.input.value;\n      this.input.value = '';\n      await this.chat.genAnswer(text);\n    };\n    const keydown = async (e: KeyboardEvent) => {\n      e.stopPropagation();\n      if (e.key === 'Enter' && !e.ctrlKey && !e.metaKey && !e.isComposing) {\n        e.preventDefault();\n        await getAnswer();\n      }\n    };\n    const sendButtonStyle = styleMap({\n      opacity: !this.loading ? '1' : '0.5',\n    });\n\n    return html`\n      <div style=\"display:flex;flex-direction: column;height: 100%\">\n        <div\n          style=\"display:flex;flex-direction: column;gap: 12px;margin-bottom: 12px;padding: 0 17px\"\n        >\n          <div class=\"service-provider-container\">\n            <div class=\"service-type\">Embedding Service</div>\n            <vendor-service-select\n              .featureKey=\"${ChatFeatureKey}\"\n              .service=\"${EmbeddingServiceKind}\"\n            ></vendor-service-select>\n          </div>\n          <div class=\"service-provider-container\">\n            <div class=\"service-type\">Chat Service</div>\n            <vendor-service-select\n              .featureKey=\"${ChatFeatureKey}\"\n              .service=\"${ChatServiceKind}\"\n            ></vendor-service-select>\n          </div>\n        </div>\n        <div\n          class=\"chat-messages-container\"\n          style=\"display:flex;flex-direction: column;flex: 1;overflow: auto\"\n        >\n          <div\n            style=\"flex:1;gap:42px;flex-direction: column;display:flex;padding: 0 7px 42px\"\n          >\n            ${repeat(this.history, this.renderMessage)}\n            ${this.tempMessage\n              ? this.renderMessage({\n                  role: 'assistant',\n                  content: this.tempMessage,\n                  sources: [],\n                })\n              : nothing}\n          </div>\n        </div>\n        <div>\n          ${this.toolbar()}\n          <div class=\"copilot-chat-prompt-container\">\n            <textarea\n              @keydown=\"${keydown}\"\n              autocomplete=\"off\"\n              data-1p-ignore\n              placeholder=\"Type here ask Copilot some thing...\"\n              class=\"copilot-chat-panel-chat-input copilot-chat-prompt\"\n              style=\"resize: none;\"\n            ></textarea>\n            <div>\n              <div\n                @click=\"${getAnswer}\"\n                style=\"${sendButtonStyle}\"\n                class=\"send-button\"\n              >\n                <sl-icon name=\"stars\"></sl-icon>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.logic.chat.reactiveData = this;\n    this.disposables.add(\n      this.host.doc.collection.slots.docUpdated.on(() => {\n        this.requestUpdate();\n      })\n    );\n    this.checkSelection();\n    this.disposables.add(\n      this.host.selection.slots.changed.on(() => {\n        this.checkSelection();\n      })\n    );\n  }\n\n  checkSelection() {\n    this.surfaceSelection = this.host.selection.value.some(\n      v => v.type === 'surface'\n    );\n    this.docSelection = this.host.selection.value.some(v => v.type === 'block');\n  }\n\n  addSelectionBackground = async () => {\n    if (this.surfaceSelection) {\n      await this.chat.selectShapesForBackground();\n    }\n    if (this.docSelection) {\n      await this.chat.selectTextForBackground();\n    }\n    this.requestUpdate();\n  };\n\n  renderMessage = (message: ChatMessage) => {\n    if (message.role === 'system') {\n      return null;\n    }\n    if (message.role === 'user') {\n      const style = styleMap({\n        alignSelf: 'flex-end',\n      });\n      return html` <div class=\"history-item\" style=\"${style}\">\n        ${repeat(message.content, item => {\n          if (item.type === 'text') {\n            return html`<div style=\"width: fit-content\">${item.text}</div>`;\n          }\n          if (item.type === 'image_url') {\n            return html`<div style=\"width: fit-content\">\n              <img .src=\"${item.image_url.url}\" style=\"max-width: 100px\" />\n            </div>`;\n          }\n          return null;\n        })}\n      </div>`;\n    }\n    if (message.role === 'assistant') {\n      const style = styleMap({\n        alignItems: 'flex-start',\n        backgroundColor: 'var(--affine-blue-100)',\n      });\n      return html`\n        <div class=\"history-item\" style=\"${style}\">\n          <div style=\"width: fit-content\">${message.content}</div>\n          ${message.sources?.length\n            ? html` <div class=\"history-refs\">\n                <div style=\"margin-top: 8px;\">sources:</div>\n                <div\n                  style=\"display: flex;flex-direction: column;gap: 4px;padding: 4px;\"\n                >\n                  ${repeat(message.sources, ref => {\n                    const doc = this.host.doc.collection.getDoc(ref.id);\n                    if (!doc) {\n                      return;\n                    }\n                    const title = doc.meta?.title || 'Untitled';\n                    const jumpTo = () => {\n                      this.host.doc = doc;\n                    };\n                    return html` <a @click=\"${jumpTo}\" style=\"cursor: pointer\"\n                      >${title}</a\n                    >`;\n                  })}\n                </div>\n              </div>`\n            : null}\n\n          <div\n            style=\"\n                  position:absolute;\n                  bottom:-35px;\n                  left: 0;\n                  display:flex;\n                  align-items:center;\n                  gap: 8px;\n                  user-select: none;\n                  height: 28px;\n                  white-space: nowrap;\n                  width: 100%;\n                  justify-content: flex-end;\n\"\n          >\n            <div\n              @click=\"${() =>\n                this.chat.replaceSelectedContent(message.content)}\"\n              style=\"border-radius: 4px;border: 1px solid rgba(0,0,0,0.1);padding: 2px 6px;cursor: pointer\"\n            >\n              replace\n            </div>\n            <div\n              @click=\"${() =>\n                this.chat.insertBelowSelectedContent(message.content)}\"\n              style=\"border-radius: 4px;border: 1px solid rgba(0,0,0,0.1);padding: 2px 6px;cursor: pointer\"\n            >\n              insert below\n            </div>\n          </div>\n        </div>\n      `;\n    }\n    return null;\n  };\n\n  toolbar() {\n    // const lastMessage = this.history[this.history.length - 1];\n    // return html`<div\n    //   style=\"display:flex;gap:12px;padding: 4px;font-size: 12px;line-height: 20px;color:var(--affine-text-secondary-color)\"\n    // >\n    //   ${this.loading\n    //     ? html`<div\n    //         style=\"border-radius: 4px;border: 1px solid rgba(0,0,0,0.1);padding: 2px 8px 2px 4px;cursor: pointer;display:flex;align-items:center;gap: 4px;\"\n    //         @click=\"${() => (this.currentRequest = undefined)}\"\n    //       >\n    //         ${StopIcon} Stop\n    //       </div>`\n    //     : nothing}\n    //   ${!this.loading && lastMessage.role === 'assistant'\n    //     ? html`<div\n    //           style=\"border-radius: 4px;border: 1px solid rgba(0,0,0,0.1);padding: 2px 10px;cursor: pointer\"\n    //         >\n    //           Longer\n    //         </div>\n    //         <div\n    //           style=\"border-radius: 4px;border: 1px solid rgba(0,0,0,0.1);padding: 2px 10px;cursor: pointer\"\n    //         >\n    //           Shorter\n    //         </div>`\n    //     : nothing}\n    // </div>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'copilot-chat-panel': CopilotChatPanel;\n  }\n}\n"]}