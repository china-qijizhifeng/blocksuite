{"version":3,"file":"open-ai.js","sourceRoot":"","sources":["../../../../src/fragments/copilot-panel/copilot-service/open-ai.ts"],"names":[],"mappings":"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","sourcesContent":["import { html } from 'lit';\nimport { OpenAI } from 'openai';\n\nimport type { ChatMessage } from '../chat/logic.js';\nimport { pngBase64ToFile } from '../edgeless/edit-image.js';\nimport {\n  ChatServiceKind,\n  createVendor,\n  EmbeddingServiceKind,\n  Image2TextServiceKind,\n  Text2ImageServiceKind,\n  TextServiceKind,\n} from './service-base.js';\n\nexport const openaiVendor = createVendor<{\n  apiKey: string;\n}>({\n  key: 'OpenAI',\n  color: '#202123',\n  initData: () => ({ apiKey: '' }),\n  renderConfigEditor: (data, refresh) => {\n    return html`\n      <div style=\"display:flex;flex-direction: column;gap: 12px;\">\n        <div>\n          <label for=\"key\">Key</label>\n          <input\n            type=\"text\"\n            id=\"key\"\n            .value=\"${data.apiKey}\"\n            @input=\"${(e: Event) => {\n              const input = e.target as HTMLInputElement;\n              data.apiKey = input.value;\n              refresh();\n            }}\"\n          />\n        </div>\n      </div>\n    `;\n  },\n});\nconst toGPTMessages = (\n  messages: ChatMessage[]\n): Array<OpenAI.ChatCompletionMessageParam> => {\n  return messages.map(v => {\n    if (v.role === 'assistant') {\n      return { role: v.role, content: v.content };\n    }\n    return v;\n  });\n};\n\nconst askGPT = async (\n  apiKey: string,\n  model:\n    | 'gpt-4'\n    | 'gpt-3.5-turbo-1106'\n    | 'gpt-4-vision-preview'\n    | 'gpt-4-turbo',\n  messages: Array<ChatMessage>\n) => {\n  const openai = new OpenAI({\n    apiKey: apiKey,\n    dangerouslyAllowBrowser: true,\n  });\n  const result = await openai.chat.completions.create({\n    messages: toGPTMessages(messages),\n    model: model,\n    temperature: 0,\n    max_tokens: 4096,\n  });\n  return result.choices[0].message;\n};\nconst askGPTStream = async function* (\n  apiKey: string,\n  model:\n    | 'gpt-4'\n    | 'gpt-3.5-turbo-1106'\n    | 'gpt-4-vision-preview'\n    | 'gpt-4-turbo',\n  messages: Array<ChatMessage>\n): AsyncIterable<string> {\n  const openai = new OpenAI({\n    apiKey: apiKey,\n    dangerouslyAllowBrowser: true,\n  });\n  const result = await openai.chat.completions.create({\n    stream: true,\n    messages: toGPTMessages(messages),\n    model: model,\n    temperature: 0,\n    max_tokens: 4096,\n  });\n  for await (const message of result) {\n    yield message.choices[0].delta.content ?? '';\n  }\n};\n\nTextServiceKind.implService({\n  name: 'GPT3.5 Turbo',\n  method: data => ({\n    generateText: async messages => {\n      const result = await askGPT(data.apiKey, 'gpt-3.5-turbo-1106', messages);\n      return result.content ?? '';\n    },\n  }),\n  vendor: openaiVendor,\n});\nTextServiceKind.implService({\n  name: 'GPT4',\n  method: data => ({\n    generateText: async messages => {\n      const result = await askGPT(data.apiKey, 'gpt-4', messages);\n      return result.content ?? '';\n    },\n  }),\n  vendor: openaiVendor,\n});\n\nChatServiceKind.implService({\n  name: 'GPT3.5 Turbo',\n  method: data => ({\n    chat: messages => {\n      return askGPTStream(data.apiKey, 'gpt-3.5-turbo-1106', messages);\n    },\n  }),\n  vendor: openaiVendor,\n});\n\nChatServiceKind.implService({\n  name: 'GPT4',\n  method: data => ({\n    chat: messages => askGPTStream(data.apiKey, 'gpt-4', messages),\n  }),\n  vendor: openaiVendor,\n});\nChatServiceKind.implService({\n  name: 'GPT4-Vision',\n  method: data => ({\n    chat: messages =>\n      askGPTStream(data.apiKey, 'gpt-4-vision-preview', messages),\n  }),\n  vendor: openaiVendor,\n});\nText2ImageServiceKind.implService({\n  name: 'DALL-E3',\n  method: data => ({\n    generateImage: async prompt => {\n      const apiKey = data.apiKey;\n      const openai = new OpenAI({\n        apiKey: apiKey,\n        dangerouslyAllowBrowser: true,\n      });\n      const result = await openai.images.generate({\n        prompt,\n        model: 'dall-e-3',\n        response_format: 'b64_json',\n      });\n      return pngBase64ToFile(result.data[0].b64_json ?? '', 'img');\n    },\n  }),\n  vendor: openaiVendor,\n});\nconst embeddings = async (apiKey: string, textList: string[]) => {\n  const openai = new OpenAI({\n    apiKey: apiKey,\n    dangerouslyAllowBrowser: true,\n  });\n  const result = await openai.embeddings.create({\n    input: textList,\n    model: 'text-embedding-ada-002',\n    encoding_format: 'float',\n  });\n  return result.data.map(v => v.embedding);\n};\nEmbeddingServiceKind.implService({\n  name: 'Ada 002',\n  method: data => ({\n    generateEmbedding: async text => {\n      const result = await embeddings(data.apiKey, [text]);\n      return result[0];\n    },\n    generateEmbeddings: async textList => {\n      return embeddings(data.apiKey, textList);\n    },\n  }),\n  vendor: openaiVendor,\n});\n\nImage2TextServiceKind.implService({\n  name: 'GPT4 Vision',\n  method: data => ({\n    generateText: async messages => {\n      const apiKey = data.apiKey;\n      const openai = new OpenAI({\n        apiKey: apiKey,\n        dangerouslyAllowBrowser: true,\n      });\n      const result = await openai.chat.completions.create({\n        messages,\n        model: 'gpt-4-vision-preview',\n        temperature: 0,\n        max_tokens: 4096,\n      });\n      return result.choices[0].message.content ?? '';\n    },\n  }),\n  vendor: openaiVendor,\n});\n"]}