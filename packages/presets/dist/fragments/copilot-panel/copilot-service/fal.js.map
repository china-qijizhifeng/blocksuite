{"version":3,"file":"fal.js","sourceRoot":"","sources":["../../../../src/fragments/copilot-panel/copilot-service/fal.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fal from '@fal-ai/serverless-client';\nimport { html } from 'lit';\n\nimport { jpegBase64ToFile } from '../edgeless/edit-image.js';\nimport {\n  createVendor,\n  FastImage2ImageServiceKind,\n  Image2ImageServiceKind,\n  Text2ImageServiceKind,\n} from './service-base.js';\n\nexport const falVendor = createVendor<{\n  apiKey: string;\n}>({\n  key: 'Fal',\n  color: '#5C4DD2',\n  initData: () => ({ apiKey: '' }),\n  renderConfigEditor: (data, refresh) => {\n    return html`\n      <div style=\"display:flex;flex-direction: column;gap: 12px;\">\n        <div>\n          <label for=\"key\">Key</label>\n          <input\n            type=\"text\"\n            id=\"key\"\n            .value=\"${data.apiKey}\"\n            @input=\"${(e: Event) => {\n              const input = e.target as HTMLInputElement;\n              data.apiKey = input.value;\n              refresh();\n            }}\"\n          />\n        </div>\n      </div>\n    `;\n  },\n});\nexport const createImageGenerator = (apiKey: string) => {\n  const connection = fal.realtime.connect('110602490-lcm-sd15-i2i', {\n    onResult: result => {\n      const fn = requestMap.get(result.request_id);\n      if (fn) {\n        fn(result.images[0].url);\n        requestMap.delete(result.request_id);\n      }\n    },\n    onError: error => {\n      console.error(error);\n    },\n  });\n  const requestMap = new Map<string, (img: string) => void>();\n  let id = 0;\n  return (prompt: string, img: string) => {\n    return new Promise<string>(res => {\n      fal.config({\n        credentials: apiKey,\n      });\n      connection.send({\n        request_id: `${id++}`,\n        prompt,\n        sync_mode: true,\n        enable_safety_checks: false,\n        image_url: img,\n      });\n      requestMap.set(id.toString(), res);\n    });\n  };\n};\nImage2ImageServiceKind.implService({\n  name: '110602490-lcm-sd15-i2i',\n  method: ({ apiKey }) => ({\n    generateImage: async (prompt, image) => {\n      const data = await fetch(\n        'https://110602490-lcm-sd15-i2i.gateway.alpha.fal.ai/',\n        {\n          method: 'post',\n          headers: {\n            Authorization: `key ${apiKey}`,\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            image_url: image,\n            prompt: prompt,\n            sync_mode: true,\n            seed: 42,\n            enable_safety_checks: false,\n          }),\n        }\n      ).then(res => res.json());\n      return data.images[0].url;\n    },\n  }),\n  vendor: falVendor,\n});\nText2ImageServiceKind.implService({\n  name: '110602490-fast-sdxl',\n  method: ({ apiKey }) => ({\n    generateImage: async prompt => {\n      fal.config({\n        credentials: apiKey,\n      });\n      const result = (await fal.subscribe('110602490-fast-sdxl', {\n        input: {\n          prompt: prompt,\n          sync_mode: true,\n        },\n      })) as { images: { url: string }[] };\n      return jpegBase64ToFile(result.images[0].url, 'img');\n    },\n  }),\n  vendor: falVendor,\n});\nFastImage2ImageServiceKind.implService({\n  name: 'lcm-sd15-i2i',\n  method: data => ({\n    createFastRequest: () => {\n      const client = createImageGenerator(data.apiKey);\n      return async (prompt, image) => {\n        return client(prompt, image);\n      };\n    },\n  }),\n  vendor: falVendor,\n});\n"]}