{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/fragments/copilot-panel/copilot-service/index.ts"],"names":[],"mappings":"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","sourcesContent":["import './open-ai.js';\nimport './fal.js';\nimport './llama2.js';\n\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { nanoid } from '@blocksuite/store';\nimport { computePosition } from '@floating-ui/dom';\nimport { css, html } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport { stopPropagation } from '../utils/selection-utils.js';\nimport { copilotConfig, type VendorConfig } from './copilot-config.js';\nimport { falVendor } from './fal.js';\nimport { llama2Vendor } from './llama2.js';\nimport { openaiVendor } from './open-ai.js';\nimport {\n  allKindService,\n  type AllServiceKind,\n  type ServiceImpl,\n  type Vendor,\n} from './service-base.js';\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport const allVendor: Vendor<any>[] = [openaiVendor, falVendor, llama2Vendor];\n\n@customElement('create-new-service')\nexport class CreateNewService extends WithDisposable(ShadowlessElement) {\n  get serviceKind() {\n    return allKindService.find(v => v.type === this.type);\n  }\n\n  @property({ attribute: false })\n  accessor type!: string;\n\n  @property({ attribute: false })\n  accessor onSave!: (config: VendorConfig) => void;\n\n  @state()\n  accessor key = '';\n\n  @state()\n  accessor name = '';\n\n  @state()\n  accessor data: unknown | undefined = undefined;\n\n  protected override render(): unknown {\n    const list = this.list();\n    if (!list) {\n      requestAnimationFrame(() => {\n        this.remove();\n      });\n      return;\n    }\n    const current = allVendor.find(v => v.key === this.key);\n    if (!current) {\n      if (!list[0]) {\n        return html` <div>no vendor</div>`;\n      }\n      this.changeKey(list[0].key);\n      requestAnimationFrame(() => {\n        this.requestUpdate();\n      });\n      return;\n    }\n    return html`\n      <div\n        @click=\"${this.close}\"\n        style=\"position: fixed;left: 0;top: 0;width: 100vw;height: 100vh;background-color: rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;\"\n      >\n        <div\n          @click=\"${stopPropagation}\"\n          style=\"display:flex;flex-direction: column;background-color: white;border-radius: 8px;padding: 24px;gap: 12px;\"\n        >\n          <div>\n            <select .value=\"${current.key}\" @change=\"${this.changeKeyByEvent}\">\n              ${repeat(\n                // @ts-ignore\n                list,\n                item => item.key,\n                item => html` <option value=\"${item.key}\">${item.key}</option>`\n              )}\n            </select>\n          </div>\n          <div>\n            <label>Name: </label>\n            <input\n              type=\"text\"\n              .value=\"${this.name}\"\n              @input=\"${this.changeName}\"\n            />\n          </div>\n          <div>\n            ${current.renderConfigEditor(this.data, () => this.requestUpdate())}\n          </div>\n          <div>\n            <button @click=\"${this.save}\">保存</button>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  changeKeyByEvent(e: Event) {\n    const select = e.target as HTMLSelectElement;\n    this.changeKey(select.value);\n  }\n\n  changeKey(key: string) {\n    this.key = key;\n    this.data = allVendor.find(v => v.key === key)?.initData();\n  }\n\n  changeName(e: Event) {\n    const input = e.target as HTMLInputElement;\n    this.name = input.value;\n  }\n\n  save() {\n    if (!this.data) {\n      return;\n    }\n    this.onSave({\n      id: nanoid(),\n      vendorKey: this.key,\n      name: this.name,\n      data: this.data,\n    });\n  }\n\n  close() {\n    this.remove();\n  }\n\n  list() {\n    const set = new Set<Vendor<unknown>>();\n    allKindService\n      .find(v => v.type === this.type)\n      ?.implList.forEach(v => {\n        set.add(v.vendor);\n      });\n    return [...set];\n  }\n}\n\n@customElement('vendor-service-select')\nexport class VendorServiceSelect extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    .vendor-service-select {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 4px;\n      padding: 2px 4px;\n      font-size: 12px;\n      color: white;\n      width: max-content;\n      cursor: pointer;\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor featureKey!: string;\n\n  @property({ attribute: false })\n  accessor service!: AllServiceKind;\n\n  protected override render(): unknown {\n    const list = copilotConfig.getVendorsByService(this.service);\n    if (!list) {\n      return html` <div style=\"font-size: 12px;color: red\">no service</div>`;\n    }\n    const current = copilotConfig.getVendor(this.featureKey, this.service);\n    if (!current) {\n      return html` <div style=\"font-size: 12px;color: red\">no vendor</div>`;\n    }\n    const style = styleMap({\n      border: '1px solid',\n      borderColor: current.impl.vendor.color,\n      color: current.impl.vendor.color,\n    });\n    return html`\n      <div\n        @click=\"${this.changeService}\"\n        class=\"vendor-service-select\"\n        style=\"${style}\"\n      >\n        ${current.vendor.name} ${current.impl.vendor.key} ${current.impl.name}\n      </div>\n    `;\n  }\n\n  changeService(e: Event) {\n    const options = new VendorServiceOptions();\n    options.featureKey = this.featureKey;\n    options.service = this.service;\n    options.close = () => {\n      this.requestUpdate();\n    };\n    const target = e.target as HTMLElement;\n    document.body.append(options);\n    computePosition(target, options)\n      .then(pos => {\n        options.style.left = `${pos.x}px`;\n        options.style.top = `${pos.y}px`;\n      })\n      .catch(() => {\n        options.remove();\n      });\n  }\n}\n\n@customElement('vendor-service-options')\nexport class VendorServiceOptions extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    vendor-service-options {\n      position: fixed;\n      font-family: var(--affine-font-family);\n    }\n\n    .vendor-service-option {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 4px;\n      padding: 2px 4px;\n      font-size: 12px;\n      color: white;\n      width: max-content;\n      cursor: pointer;\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor featureKey!: string;\n\n  @property({ attribute: false })\n  accessor service!: AllServiceKind;\n\n  @property({ attribute: false })\n  accessor close!: () => void;\n\n  protected override render(): unknown {\n    const list = copilotConfig.getVendorsByService(this.service);\n    return html`\n      <div\n        style=\"background-color: var(--affine-background-overlay-panel-color);padding: 12px;display:flex;flex-direction: column;gap: 8px;\"\n      >\n        ${repeat(list, item => {\n          const style = styleMap({\n            backgroundColor: item.impl.vendor.color,\n          });\n          const select = () => {\n            this.select(item.vendor, item.impl);\n          };\n          return html` <div\n            @click=\"${select}\"\n            class=\"vendor-service-option\"\n            style=\"${style}\"\n          >\n            ${item.vendor.name} ${item.impl.vendor.key} ${item.impl.name}\n          </div>`;\n        })}\n      </div>\n    `;\n  }\n\n  select(vendor: VendorConfig, impl: ServiceImpl<unknown, unknown>) {\n    copilotConfig.changeService(\n      this.featureKey,\n      this.service.type,\n      vendor.id,\n      impl.name\n    );\n    this.remove();\n    this.close();\n  }\n}\n"]}