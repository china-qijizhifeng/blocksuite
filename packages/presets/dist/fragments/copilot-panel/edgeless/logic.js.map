{"version":3,"file":"logic.js","sourceRoot":"","sources":["../../../../src/fragments/copilot-panel/edgeless/logic.ts"],"names":[],"mappings":"AAEA,OAAO,EACL,WAAW,EACX,kBAAkB,EAClB,cAAc,EACd,eAAe,GAGhB,MAAM,oBAAoB,CAAC;AAG5B,OAAO,EAAE,aAAa,EAAE,MAAM,sCAAsC,CAAC;AACrE,OAAO,EACL,0BAA0B,EAC1B,qBAAqB,GACtB,MAAM,oCAAoC,CAAC;AAC5C,OAAO,EAAE,UAAU,EAAE,MAAM,mBAAmB,CAAC;AAC/C,OAAO,EACL,aAAa,EACb,yBAAyB,EACzB,kBAAkB,EAClB,oBAAoB,EACpB,cAAc,EACd,2BAA2B,EAC3B,gBAAgB,EAChB,aAAa,GACd,MAAM,6BAA6B,CAAC;AACrC,OAAO,EAAE,SAAS,EAAE,gBAAgB,EAAE,MAAM,iBAAiB,CAAC;AAC9D,OAAO,EAAE,OAAO,EAAE,MAAM,eAAe,CAAC;AAExC,MAAM,OAAO,eAAe;IAC1B,IAAI,OAAO;QACT,OAAO,IAAI,CAAC,KAAK,KAAK,SAAS,CAAC;IAClC,CAAC;IAED,IAAI,UAAU;QACZ,OAAO,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC;IAClC,CAAC;IAED,IAAI,IAAI;QACN,OAAO,IAAI,CAAC,OAAO,EAAE,CAAC;IACxB,CAAC;IAcD,YAAoB,OAAyB;QAAzB,YAAO,GAAP,OAAO,CAAkB;QAZrC,YAAO,GAMX,EAAE,CAAC;QAIP,cAAS,GAAW,EAAE,CAAC;QAIvB,kBAAa,GAAG,GAAG,EAAE;YACnB,IAAI,IAAI,CAAC,KAAK,EAAE,CAAC;gBACf,IAAI,CAAC,KAAK,EAAE,CAAC;gBACb,IAAI,CAAC,KAAK,GAAG,SAAS,CAAC;gBACvB,OAAO;YACT,CAAC;YACD,MAAM,QAAQ,GAAG,yBAAyB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACtD,IAAI,CAAC,KAAK,GAAG,QAAQ,CAAC,iBAAiB,CAAC,cAAc,CAAC,EAAE,CAAC,GAAG,EAAE;gBAC7D,IAAI,CAAC,oBAAoB,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;YACnD,CAAC,CAAC,CAAC,OAAO,CAAC;QACb,CAAC,CAAC;QAEF,eAAU,GAAG,KAAK,IAAI,EAAE;YACtB,MAAM,GAAG,GAAG,MAAM,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC3C,IAAI,CAAC,GAAG,EAAE,CAAC;gBACT,KAAK,CAAC,iCAAiC,CAAC,CAAC;gBACzC,OAAO;YACT,CAAC;YACD,MAAM,YAAY,GAAG,yBAAyB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC1D,MAAM,EAAE,KAAK,EAAE,GAAG,WAAW,CAAC,aAAa,CACzC,YAAY,CAAC,OAAO,CAAC,SAAS,CAAC,gBAAgB,CAChD,CAAC;YACF,aAAa;YACb,MAAM,SAAS,GAGX,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CACpB,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE;gBACpB,IAAI,CAAC,YAAY,cAAc,EAAE,CAAC;oBAChC,OAAO,CAAC,CAAC,IAAI,IAAI,CAAC,CAAC,MAAM,CAAC;gBAC5B,CAAC;qBAAM,CAAC;oBACN,OAAO,KAAK,CAAC;gBACf,CAAC;YACH,CAAC,CAAC,CACH,CAAC,CAAC,CAAC,CAAC;YACL,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,GAAG,EAAE,SAAS,CAAC,CAAC;YAC3C,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,OAAO;YACT,CAAC;YACD,YAAY,CAAC,GAAG,CAAC,QAAQ,CACvB,kBAAkB,CAAC,MAAM,CAAC,KAAK,CAAC,OAA8B,EAC9D,EAAE,IAAI,EAAE,MAAM,EAAE,GAAG,EAAE,IAAI,EAAE,oBAAoB,EAAE,EACjD,YAAY,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAC9B,CAAC;QACJ,CAAC,CAAC;QAEF,kBAAa,GAAG,GAAG,EAAE;YACnB,MAAM,YAAY,GAAG,yBAAyB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC1D,YAAY,CAAC,GAAG,CAAC,QAAQ,CACvB,kBAAkB,CAAC,MAAM,CAAC,KAAK,CAAC,OAA8B,EAC9D,EAAE,IAAI,EAAE,UAAU,EAAE,IAAI,EAAE,oBAAoB,EAAE,EAChD,YAAY,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAC9B,CAAC;QACJ,CAAC,CAAC;QAEF,cAAS,GAAG,KAAK,IAAI,EAAE;YACrB,MAAM,MAAM,GAAG,MAAM,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACjD,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,KAAK,CAAC,iCAAiC,CAAC,CAAC;gBACzC,OAAO;YACT,CAAC;YACD,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE;gBACnB,IAAI,IAAI,EAAE,CAAC;oBACT,MAAM,MAAM,GAER,QAAQ,CAAC,cAAc,CACrB,iCAAiC,CAEpC,EAAE,KAAK,IAAI,EAAE,CAAC;oBACjB,SAAS,CAAC,MAAM,EAAE,MAAM,CAAC;wBACvB,EAAE,IAAI,CAAC,GAAG,CAAC,EAAE;wBACX,IAAI,CAAC,GAAG,EAAE,CAAC;4BACT,OAAO;wBACT,CAAC;wBACD,MAAM,OAAO,GAAG,gBAAgB,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;wBAC7C,MAAM,YAAY,GAAG,yBAAyB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;wBAC1D,YAAY,CAAC,SAAS,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;oBACzD,CAAC,CAAC;yBACD,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;gBAC1B,CAAC;YACH,CAAC,CAAC,CAAC;QACL,CAAC,CAAC;QAEF,gBAAW,GAAG,KAAK,IAAI,EAAE;YACvB,MAAM,YAAY,GAAG,yBAAyB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC1D,MAAM,MAAM,GAER,QAAQ,CAAC,cAAc,CACrB,mCAAmC,CAEtC,EAAE,KAAK,IAAI,EAAE,CAAC;YACjB,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,KAAK,CAAC,gCAAgC,CAAC,CAAC;gBACxC,OAAO;YACT,CAAC;YACD,MAAM,IAAI,GAAG,MAAM,aAAa;iBAC7B,UAAU,CAAC,eAAe,EAAE,qBAAqB,CAAC;iBAClD,aAAa,CAAC,MAAM,CAAC,CAAC;YACzB,IAAI,IAAI,EAAE,CAAC;gBACT,MAAM,YAAY,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;YACvC,CAAC;QACH,CAAC,CAAC;QAEF,yBAAoB,GAAG,KAAK,IAAI,EAAE;YAChC,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,YAAY,CACrC,IAAI,CAAC,SAAS,IAAI,EAAE,CACF,CAAC;YACrB,IAAI,CAAC,IAAI,EAAE,CAAC;gBACV,OAAO;YACT,CAAC;YACD,MAAM,OAAO,GAAG,2BAA2B,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACvD,MAAM,OAAO,GACX,OAAO,CAAC,KAAK,CAAC,aAAa,CAAC,MAAM,CAChC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,IAAI,KAAK,WAAW,CAEhC;iBACE,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,KAAK,IAAI,CAAC,EAAE,CAAC;iBACpC,OAAO,CAAC,CAAC,CAAC,EAAE;gBACX,MAAM,KAAK,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC;gBAC5D,IAAI,KAAK,YAAY,eAAe,EAAE,CAAC;oBACrC,OAAO,CAAC,KAAK,CAAC,CAAC;gBACjB,CAAC;gBACD,OAAO,EAAE,CAAC;YACZ,CAAC,CAAC,CAAC;YACL,MAAM,MAAM,GAAG,MAAM,aAAa,CAAC,IAAI,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;YACpD,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,OAAO;YACT,CAAC;YACD,MAAM,QAAQ,GAAG,CAAC,IAAiB,EAAE,EAAE;gBACrC,MAAM,GAAG,GAAG,GAAG,EAAE;oBACf,IAAI,IAAI,EAAE,CAAC;wBACT,MAAM,OAAO,GAAG,MAAM,CAAC,SAAS,EAAE,CAAC;wBACnC,MAAM,QAAQ,GAAG,KAAK,EAAE,KAAsB,EAAE,EAAE;4BAChD,MAAM,MAAM,GAAG,KAAK,CAAC,KAAK,CAAC,QAAQ,EAAE,CAAC;4BACtC,IAAI,CAAC,MAAM,EAAE,CAAC;gCACZ,OAAO;4BACT,CAAC;4BACD,MAAM,IAAI,GAAG,MAAM,GAAG,OAAO,CAAC;4BAC9B,IAAI,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;4BACpC,IAAI,CAAC,MAAM,EAAE,CAAC;gCACZ,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC,GAAG,MAAM,GAAG;oCAChC,QAAQ,EAAE,EAAE;oCACZ,OAAO,EAAE,aAAa;yCACnB,UAAU,CACT,0BAA0B,EAC1B,0BAA0B,CAC3B;yCACA,iBAAiB,EAAE;iCACvB,CAAC;4BACJ,CAAC;4BACD,IAAI,MAAM,CAAC,QAAQ,KAAK,IAAI,EAAE,CAAC;gCAC7B,OAAO;4BACT,CAAC;4BACD,MAAM,CAAC,QAAQ,GAAG,IAAI,CAAC;4BACvB,uBAAuB;4BACvB,MAAM,GAAG,GAAG,MAAM,MAAM,CAAC,OAAO,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;4BAClD,IAAI,CAAC,GAAG,EAAE,CAAC;gCACT,OAAO;4BACT,CAAC;4BACD,MAAM,OAAO,GAAG,2BAA2B,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;4BACvD,IAAI,KAAK,GAAG,oBAAoB,CAAC,KAAK,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;4BACnD,MAAM,OAAO,GAAG,gBAAgB,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;4BAC7C,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;4BAC3D,IAAI,CAAC,KAAK,EAAE,CAAC;gCACX,KAAK,GAAG,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,QAAQ,CACvC,cAAc,EACd;oCACE,IAAI,EAAE,OAAO,CAAC,IAAI;oCAClB,IAAI,EAAE,KAAK,CAAC,IAAI;iCACjB,EACD,OAAO,CAAC,KAAK,CACd,CAAC;4BACJ,CAAC;4BACD,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,aAAa,CAAC,KAAK,EAAE;gCAC5C,QAAQ;6BAC0B,CAAC,CAAC;wBACxC,CAAC,CAAC;wBACF,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE;4BAClB,QAAQ,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;wBACnC,CAAC,CAAC,CAAC;oBACL,CAAC;gBACH,CAAC,CAAC;gBACF,GAAG,EAAE,CAAC;YACR,CAAC,CAAC;YACF,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QAC1B,CAAC,CAAC;IA3L8C,CAAC;IA6LjD,gBAAgB;QACd,MAAM,MAAM,GAAG,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,cAAc,CAAC;QACxD,MAAM,UAAU,GAAG,CAAC,KAAiB,EAAY,EAAE;YACjD,OAAO;gBACL,IAAI,EAAE,KAAK,CAAC,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE;gBAClC,QAAQ,EAAE,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC;aACzC,CAAC;QACJ,CAAC,CAAC;QAEF,MAAM,KAAK,GAAiB,EAAE,CAAC;QAC/B,MAAM,MAAM,GAAiB,EAAE,CAAC;QAChC,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE;YACjB,IAAI,CAAC,CAAC,KAAK,CAAC,OAAO,KAAK,kBAAkB,EAAE,CAAC;gBAC3C,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;YACtB,CAAC;iBAAM,CAAC;gBACN,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;YACvB,CAAC;QACH,CAAC,CAAC,CAAC;QACH,IAAI,IAAc,CAAC;QACnB,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACvB,IAAI,GAAG;gBACL,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE;gBACrC,QAAQ,EAAE,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;aACzC,CAAC;QACJ,CAAC;aAAM,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YAC/B,IAAI,GAAG,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;QACrC,CAAC;aAAM,CAAC;YACN,IAAI,GAAG;gBACL,IAAI,EAAE,MAAM;gBACZ,QAAQ,EAAE,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,UAAU,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;aAC/C,CAAC;QACJ,CAAC;QACD,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;IACzB,CAAC;IAED,WAAW,CACT,QAAkB,EAClB,OAAqD;QAErD,WAAW,CAAC,OAAO,CAAC,cAAc,CAChC,kBAAkB,CAAC,IAAI,CAAC,IAAI,CAAC,EAC7B,QAAQ,EACR,OAAO,CACR,CAAC;IACJ,CAAC;CACF","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport type { ConnectorElementModel } from '@blocksuite/blocks';\nimport {\n  BlocksUtils,\n  EmbedHtmlBlockSpec,\n  EmbedHtmlModel,\n  FrameBlockModel,\n  type ImageBlockProps,\n  type TreeNode,\n} from '@blocksuite/blocks';\nimport type { BlockModel, DocCollection } from '@blocksuite/store';\n\nimport { copilotConfig } from '../copilot-service/copilot-config.js';\nimport {\n  FastImage2ImageServiceKind,\n  Text2ImageServiceKind,\n} from '../copilot-service/service-base.js';\nimport { demoScript } from '../demo-script.js';\nimport {\n  frameToCanvas,\n  getEdgelessRootFromEditor,\n  getEdgelessService,\n  getFirstImageInFrame,\n  getRootService,\n  getSurfaceElementFromEditor,\n  selectedToCanvas,\n  selectedToPng,\n} from '../utils/selection-utils.js';\nimport { editImage, jpegBase64ToFile } from './edit-image.js';\nimport { genHtml } from './gen-html.js';\n\nexport class AIEdgelessLogic {\n  get autoGen() {\n    return this.unsub !== undefined;\n  }\n\n  get collection(): DocCollection {\n    return this.host.doc.collection;\n  }\n\n  get host() {\n    return this.getHost();\n  }\n\n  private targets: Record<\n    string,\n    {\n      lastHash: string;\n      request: (prompt: string, img: string) => Promise<string>;\n    }\n  > = {};\n\n  private unsub?: () => void;\n\n  fromFrame: string = '';\n\n  constructor(private getHost: () => EditorHost) {}\n\n  toggleAutoGen = () => {\n    if (this.unsub) {\n      this.unsub();\n      this.unsub = undefined;\n      return;\n    }\n    const edgeless = getEdgelessRootFromEditor(this.host);\n    this.unsub = edgeless.surfaceBlockModel.elementUpdated.on(() => {\n      this.createImageFromFrame().catch(console.error);\n    }).dispose;\n  };\n\n  makeItReal = async () => {\n    const png = await selectedToPng(this.host);\n    if (!png) {\n      alert('Please select some shapes first');\n      return;\n    }\n    const edgelessRoot = getEdgelessRootFromEditor(this.host);\n    const { notes } = BlocksUtils.splitElements(\n      edgelessRoot.service.selection.selectedElements\n    );\n    // @ts-ignore\n    const htmlBlock: {\n      html: string;\n      design: string;\n    } = notes.flatMap(v =>\n      v.children.filter(v => {\n        if (v instanceof EmbedHtmlModel) {\n          return v.html && v.design;\n        } else {\n          return false;\n        }\n      })\n    )[0];\n    const html = await genHtml(png, htmlBlock);\n    if (!html) {\n      return;\n    }\n    edgelessRoot.doc.addBlock(\n      EmbedHtmlBlockSpec.schema.model.flavour as 'affine:embed-html',\n      { html, design: png, xywh: '[0, 400, 400, 200]' },\n      edgelessRoot.surface.model.id\n    );\n  };\n\n  htmlBlockDemo = () => {\n    const edgelessRoot = getEdgelessRootFromEditor(this.host);\n    edgelessRoot.doc.addBlock(\n      EmbedHtmlBlockSpec.schema.model.flavour as 'affine:embed-html',\n      { html: demoScript, xywh: '[0, 400, 400, 200]' },\n      edgelessRoot.surface.model.id\n    );\n  };\n\n  editImage = async () => {\n    const canvas = await selectedToCanvas(this.host);\n    if (!canvas) {\n      alert('Please select some shapes first');\n      return;\n    }\n    canvas.toBlob(blob => {\n      if (blob) {\n        const prompt =\n          (\n            document.getElementById(\n              'copilot-panel-edit-image-prompt'\n            ) as HTMLInputElement\n          )?.value ?? '';\n        editImage(prompt, canvas)\n          ?.then(b64 => {\n            if (!b64) {\n              return;\n            }\n            const imgFile = jpegBase64ToFile(b64, 'img');\n            const edgelessRoot = getEdgelessRootFromEditor(this.host);\n            edgelessRoot.addImages([imgFile]).catch(console.error);\n          })\n          .catch(console.error);\n      }\n    });\n  };\n\n  createImage = async () => {\n    const edgelessRoot = getEdgelessRootFromEditor(this.host);\n    const prompt =\n      (\n        document.getElementById(\n          'copilot-panel-create-image-prompt'\n        ) as HTMLInputElement\n      )?.value ?? '';\n    if (!prompt) {\n      alert('Please enter some prompt first');\n      return;\n    }\n    const file = await copilotConfig\n      .getService('text to image', Text2ImageServiceKind)\n      .generateImage(prompt);\n    if (file) {\n      await edgelessRoot.addImages([file]);\n    }\n  };\n\n  createImageFromFrame = async () => {\n    const from = this.host.doc.getBlockById(\n      this.fromFrame ?? ''\n    ) as FrameBlockModel;\n    if (!from) {\n      return;\n    }\n    const surface = getSurfaceElementFromEditor(this.host);\n    const targets = (\n      surface.model.elementModels.filter(\n        el => el.type === 'connector'\n      ) as ConnectorElementModel[]\n    )\n      .filter(v => v.source.id === from.id)\n      .flatMap(v => {\n        const block = this.host.doc.getBlockById(v.target.id ?? '');\n        if (block instanceof FrameBlockModel) {\n          return [block];\n        }\n        return [];\n      });\n    const canvas = await frameToCanvas(from, this.host);\n    if (!canvas) {\n      return;\n    }\n    const callback = (blob: Blob | null) => {\n      const run = () => {\n        if (blob) {\n          const dataURL = canvas.toDataURL();\n          const genImage = async (model: FrameBlockModel) => {\n            const prompt = model.title.toString();\n            if (!prompt) {\n              return;\n            }\n            const hash = prompt + dataURL;\n            let target = this.targets[model.id];\n            if (!target) {\n              this.targets[model.id] = target = {\n                lastHash: '',\n                request: copilotConfig\n                  .getService(\n                    'real time image to image',\n                    FastImage2ImageServiceKind\n                  )\n                  .createFastRequest(),\n              };\n            }\n            if (target.lastHash === hash) {\n              return;\n            }\n            target.lastHash = hash;\n            // const b64 = dataURL;\n            const b64 = await target.request(prompt, dataURL);\n            if (!b64) {\n              return;\n            }\n            const surface = getSurfaceElementFromEditor(this.host);\n            let image = getFirstImageInFrame(model, this.host);\n            const imgFile = jpegBase64ToFile(b64, 'img');\n            const sourceId = await this.host.doc.blobSync.set(imgFile);\n            if (!image) {\n              image = surface.edgeless.service.addBlock(\n                'affine:image',\n                {\n                  size: imgFile.size,\n                  xywh: model.xywh,\n                },\n                surface.model\n              );\n            }\n            surface.edgeless.service.updateElement(image, {\n              sourceId,\n            } satisfies Partial<ImageBlockProps>);\n          };\n          targets.forEach(v => {\n            genImage(v).catch(console.error);\n          });\n        }\n      };\n      run();\n    };\n    canvas.toBlob(callback);\n  };\n\n  convertToMindMap() {\n    const blocks = getRootService(this.host).selectedBlocks;\n    const toTreeNode = (block: BlockModel): TreeNode => {\n      return {\n        text: block.text?.toString() ?? '',\n        children: block.children.map(toTreeNode),\n      };\n    };\n\n    const texts: BlockModel[] = [];\n    const others: BlockModel[] = [];\n    blocks.forEach(v => {\n      if (v.model.flavour === 'affine:paragraph') {\n        texts.push(v.model);\n      } else {\n        others.push(v.model);\n      }\n    });\n    let node: TreeNode;\n    if (texts.length === 1) {\n      node = {\n        text: texts[0].text?.toString() ?? '',\n        children: others.map(v => toTreeNode(v)),\n      };\n    } else if (blocks.length === 1) {\n      node = toTreeNode(blocks[0].model);\n    } else {\n      node = {\n        text: 'Root',\n        children: blocks.map(v => toTreeNode(v.model)),\n      };\n    }\n    this.drawMindMap(node);\n  }\n\n  drawMindMap(\n    treeNode: TreeNode,\n    options?: { rootId?: string; x?: number; y?: number }\n  ) {\n    BlocksUtils.mindMap.drawInEdgeless(\n      getEdgelessService(this.host),\n      treeNode,\n      options\n    );\n  }\n}\n"]}