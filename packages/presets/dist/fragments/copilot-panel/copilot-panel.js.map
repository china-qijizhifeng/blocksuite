{"version":3,"file":"copilot-panel.js","sourceRoot":"","sources":["../../../src/fragments/copilot-panel/copilot-panel.ts"],"names":[],"mappings":"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","sourcesContent":["import './chat/chat.js';\nimport './edgeless/edgeless.js';\nimport './copilot-service/index.js';\n\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { css, html, type TemplateResult } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { AffineEditorContainer } from '../../index.js';\nimport type { AllAction } from './chat/logic.js';\nimport { copilotConfig } from './copilot-service/copilot-config.js';\nimport { CreateNewService } from './copilot-service/index.js';\nimport { allKindService } from './copilot-service/service-base.js';\nimport type { AIEdgelessLogic } from './edgeless/logic.js';\nimport { AddCursorIcon, StarIcon } from './icons.js';\nimport { AILogic } from './logic.js';\nimport { getSurfaceElementFromEditor } from './utils/selection-utils.js';\n\n@customElement('copilot-panel')\nexport class CopilotPanel extends WithDisposable(ShadowlessElement) {\n  get host() {\n    return this.editor.host;\n  }\n\n  get logic() {\n    if (!this.aiLogic) {\n      this.aiLogic = new AILogic(() => this.host);\n    }\n    return this.aiLogic;\n  }\n\n  static override styles = css`\n    copilot-panel {\n      width: 100%;\n      font-family: var(--affine-font-family);\n      overflow-y: scroll;\n      overflow-x: visible;\n    }\n\n    .copilot-panel-setting-title {\n      font-size: 14px;\n      margin-top: 12px;\n      margin-bottom: 4px;\n      color: var(--affine-text-secondary-color);\n    }\n\n    .copilot-panel-key-input {\n      width: 100%;\n      border: 1px solid var(--affine-border-color, #e3e2e4);\n      border-radius: 4px;\n      padding: 8px;\n      box-sizing: border-box;\n      margin-bottom: 12px;\n    }\n\n    .copilot-panel-action-button {\n      cursor: pointer;\n      user-select: none;\n      padding: 4px;\n      background-color: var(--affine-primary-color);\n      border-radius: 8px;\n      color: white;\n      height: 32px;\n      border: 1px solid var(--affine-border-color, #e3e2e4);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      margin-top: 12px;\n    }\n\n    .copilot-panel-action-prompt {\n      width: 100%;\n      border: 1px solid var(--affine-border-color, #e3e2e4);\n      border-radius: 4px;\n      padding: 8px;\n      box-sizing: border-box;\n      margin-top: 8px;\n    }\n\n    .copilot-panel-action-description {\n      font-size: 14px;\n      margin-bottom: 8px;\n      margin-top: 4px;\n      color: var(--affine-text-secondary-color);\n    }\n\n    .copilot-panel-add-vendor-button {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 4px;\n      cursor: pointer;\n    }\n\n    .copilot-panel-add-vendor-button:hover {\n      background-color: var(--affine-hover-color);\n    }\n\n    .copilot-panel-vendor-item {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 12px;\n      padding: 2px 4px;\n      border-radius: 4px;\n      color: white;\n    }\n    .copilot-box {\n      margin-bottom: 64px;\n    }\n\n    .service-provider-container {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n    }\n    .service-type {\n      font-size: 14px;\n      color: var(--affine-text-secondary-color);\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor editor!: AffineEditorContainer;\n\n  editorWithAI?: AIEdgelessLogic;\n\n  aiLogic?: AILogic;\n\n  config = () => {\n    const createNew = (type: string) => () => {\n      const panel = new CreateNewService();\n      panel.type = type;\n      panel.onSave = config => {\n        copilotConfig.addVendor(config);\n        this.requestUpdate();\n        panel.remove();\n      };\n      document.body.append(panel);\n    };\n    return html`\n      <div style=\"display:flex;flex-direction: column;gap: 32px;\">\n        ${repeat(allKindService, v => {\n          const list = copilotConfig.getVendorsByService(v);\n          return html`\n            <div>\n              <div\n                class=\"copilot-panel-setting-title\"\n                style=\"display:flex;justify-content:space-between;align-items:center;;color: var(--affine-text-primary-color);\"\n              >\n                ${v.title}\n                <div\n                  @click=\"${createNew(v.type)}\"\n                  class=\"copilot-panel-add-vendor-button\"\n                >\n                  ${AddCursorIcon}\n                </div>\n              </div>\n              <div style=\"display:flex;flex-wrap: wrap;padding: 4px;gap: 4px\">\n                ${repeat(list, v => {\n                  const style = styleMap({\n                    backgroundColor: v.impl.vendor.color,\n                  });\n                  return html` <div\n                    style=\"${style}\"\n                    class=\"copilot-panel-vendor-item\"\n                  >\n                    ${v.vendor.name} ${v.impl.vendor.key} ${v.impl.name}\n                  </div>`;\n                })}\n              </div>\n            </div>\n          `;\n        })}\n      </div>\n    `;\n  };\n\n  // eslint-disable-next-line @typescript-eslint/member-ordering\n  panels: Record<\n    string,\n    {\n      render: () => TemplateResult;\n    }\n  > = {\n    Chat: {\n      render: () => {\n        return html` <copilot-chat-panel\n          .logic=\"${this.logic}\"\n        ></copilot-chat-panel>`;\n      },\n    },\n    Edgeless: {\n      render: () => {\n        return html` <copilot-edgeless-panel\n          .logic=\"${this.logic}\"\n        ></copilot-edgeless-panel>`;\n      },\n    },\n    Config: {\n      render: this.config,\n    },\n  };\n\n  @state()\n  accessor currentPanel: keyof typeof this.panels = 'Chat';\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.disposables.add(\n      getSurfaceElementFromEditor(this.host).model.childrenUpdated.on(() => {\n        this.requestUpdate();\n      })\n    );\n  }\n\n  override render() {\n    const panel = this.panels[this.currentPanel];\n    return html`\n      <div style=\"display:flex;flex-direction: column;height: 100%\">\n        <div\n          style=\"display:flex;align-items:center;justify-content:center; padding-top: 17px;\"\n        >\n          <div\n            style=\"display:flex;align-items:center;justify-content:center;cursor: pointer;user-select: none;width: max-content;padding: 4px; background-color: var(--affine-hover-color);border-radius: 12px;\"\n          >\n            ${repeat(Object.keys(this.panels), key => {\n              const changePanel = () => {\n                this.currentPanel = key as keyof typeof this.panels;\n              };\n              const style = styleMap({\n                'background-color':\n                  this.currentPanel === key\n                    ? 'var(--affine-hover-color)'\n                    : 'transparent',\n                padding: '4px 8px',\n                'border-radius': '8px',\n                width: '91px',\n                display: 'flex',\n                alignItems: 'center',\n                justifyContent: 'center',\n                fontWeight: 500,\n                color:\n                  key === this.currentPanel\n                    ? 'var(--affine-text-primary-color)'\n                    : 'var(--affine-text-secondary-color)',\n              });\n              return html` <div style=\"${style}\" @click=\"${changePanel}\">\n                ${key}\n              </div>`;\n            })}\n          </div>\n        </div>\n        <div style=\"flex:1;overflow: hidden\">${panel.render()}</div>\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'copilot-panel': CopilotPanel;\n  }\n}\n\nexport const affineFormatBarItemConfig = {\n  type: 'custom' as const,\n  render(): TemplateResult | null {\n    const copilot = document.querySelector('copilot-panel');\n    if (!copilot) {\n      return null;\n    }\n    const renderItem = (item: AllAction): TemplateResult => {\n      if (item.type === 'group') {\n        return html`\n          <sl-menu-item>\n            ${item.name}\n            <sl-menu slot=\"submenu\">\n              ${repeat(item.children, renderItem)}\n            </sl-menu>\n          </sl-menu-item>\n        `;\n      }\n      return html`\n        <sl-menu-item @click=\"${() => item.action()}\"\n          >${item.name}</sl-menu-item\n        >\n      `;\n    };\n    return html`\n      <style>\n        .copilot-format-bar-item {\n          padding: 4px;\n          border-radius: 4px;\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          color: var(--affine-icon-color);\n        }\n        .copilot-format-bar-item:hover {\n          background-color: var(--affine-hover-color);\n        }\n      </style>\n      <div class=\"copilot-format-bar-item\">\n        <sl-dropdown>\n          <div\n            slot=\"trigger\"\n            style=\"display:flex;align-items:center;gap: 4px;\"\n            caret\n          >\n            ${StarIcon} Ask AI\n          </div>\n          <sl-menu>\n            ${repeat(\n              copilot.aiLogic?.chat.docSelectionActionList ?? [],\n              renderItem\n            )}\n          </sl-menu>\n        </sl-dropdown>\n      </div>\n    `;\n  },\n};\n"]}