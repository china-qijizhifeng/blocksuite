{"version":3,"file":"outline-preview.js","sourceRoot":"","sources":["../../../../src/fragments/outline-panel/card/outline-preview.ts"],"names":[],"mappings":"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","sourcesContent":["import { WithDisposable } from '@blocksuite/block-std';\nimport type {\n  AffineTextAttributes,\n  AttachmentBlockModel,\n  BookmarkBlockModel,\n  CodeBlockModel,\n  DatabaseBlockModel,\n  ImageBlockModel,\n  ListBlockModel,\n  ParagraphBlockModel,\n} from '@blocksuite/blocks';\nimport { BlocksUtils } from '@blocksuite/blocks';\nimport { DisposableGroup, noop } from '@blocksuite/global/utils';\nimport type { DeltaInsert } from '@blocksuite/inline';\nimport { css, html, LitElement, nothing } from 'lit';\nimport { property } from 'lit/decorators.js';\n\nimport { SmallLinkedDocIcon } from '../../_common/icons.js';\nimport { headingKeys, placeholderMap, previewIconMap } from '../config.js';\n\ntype ValuesOf<T, K extends keyof T = keyof T> = T[K];\n\nfunction assertType<T>(value: unknown): asserts value is T {\n  noop(value);\n}\n\nconst styles = css`\n  :host {\n    display: block;\n    width: 100%;\n  }\n\n  .outline-block-preview {\n    width: 100%;\n    box-sizing: border-box;\n    padding: 6px 8px;\n    white-space: nowrap;\n    display: flex;\n    justify-content: start;\n    align-items: center;\n    gap: 8px;\n  }\n\n  .icon {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 24px;\n    height: 24px;\n    box-sizing: border-box;\n    padding: 4px;\n    background: var(--affine-background-secondary-color);\n    border-radius: 4px;\n    color: var(--affine-icon-color);\n  }\n\n  .icon.disabled {\n    color: var(--affine-disabled-icon-color);\n  }\n\n  .text {\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    flex: 1;\n\n    font-size: var(--affine-font-sm);\n    line-height: 24px;\n    height: 24px;\n  }\n\n  .text.general,\n  .subtype.text,\n  .subtype.quote {\n    font-weight: 400;\n    padding-left: 28px;\n  }\n\n  .subtype.h1,\n  .subtype.h2,\n  .subtype.h3,\n  .subtype.h4,\n  .subtype.h5,\n  .subtype.h6 {\n    font-weight: 600;\n  }\n\n  .subtype.h1 {\n    padding-left: 0;\n  }\n  .subtype.h2 {\n    padding-left: 4px;\n  }\n  .subtype.h3 {\n    padding-left: 12px;\n  }\n  .subtype.h4 {\n    padding-left: 16px;\n  }\n  .subtype.h5 {\n    padding-left: 20px;\n  }\n  .subtype.h6 {\n    padding-left: 24px;\n  }\n\n  .outline-block-preview:not(:has(span)) {\n    display: none;\n  }\n\n  .text span {\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n\n  .linked-doc-preview svg {\n    width: 1.1em;\n    height: 1.1em;\n    vertical-align: middle;\n    font-size: inherit;\n    margin-bottom: 0.1em;\n  }\n\n  .linked-doc-text {\n    font-size: inherit;\n    border-bottom: 0.5px solid var(--affine-divider-color);\n    white-space: break-spaces;\n    margin-right: 2px;\n  }\n\n  .linked-doc-preview.unavailable svg {\n    color: var(--affine-text-disable-color);\n  }\n\n  .linked-doc-preview.unavailable .linked-doc-text {\n    color: var(--affine-text-disable-color);\n    text-decoration: line-through;\n  }\n`;\n\nexport class OutlineBlockPreview extends WithDisposable(LitElement) {\n  static override styles = styles;\n\n  private _textDisposables: DisposableGroup | null = null;\n\n  @property({ attribute: false })\n  accessor block!: ValuesOf<BlockSuite.BlockModels>;\n\n  @property({ attribute: false })\n  accessor showPreviewIcon!: boolean;\n\n  @property({ attribute: false })\n  accessor enableNotesSorting!: boolean;\n\n  @property({ attribute: false })\n  accessor disabledIcon = false;\n\n  @property({ attribute: false })\n  accessor cardNumber!: number;\n\n  private _clearTextDisposables = () => {\n    this._textDisposables?.dispose();\n    this._textDisposables = null;\n  };\n\n  private _setTextDisposables = (block: ValuesOf<BlockSuite.BlockModels>) => {\n    this._clearTextDisposables();\n    this._textDisposables = new DisposableGroup();\n    block.text?.yText.observe(this._updateElement);\n    this._textDisposables.add({\n      dispose: () => block.text?.yText.unobserve(this._updateElement),\n    });\n    this._textDisposables.add(this.block.propsUpdated.on(this._updateElement));\n  };\n\n  private _updateElement = () => {\n    this.requestUpdate();\n  };\n\n  private _TextBlockPreview(block: ParagraphBlockModel | ListBlockModel) {\n    const deltas: DeltaInsert<AffineTextAttributes>[] =\n      block.text.yText.toDelta();\n    if (!deltas?.length) return nothing;\n    const iconClass = this.disabledIcon ? 'icon disabled' : 'icon';\n\n    const previewText = deltas.map(delta => {\n      if (delta.attributes?.reference) {\n        // If linked doc, render linked doc icon and the doc title.\n        const refAttribute = delta.attributes.reference;\n        const refMeta = block.doc.collection.meta.docMetas.find(\n          doc => doc.id === refAttribute.pageId\n        );\n        const unavailable = !refMeta;\n        const title = unavailable ? 'Deleted doc' : refMeta.title;\n        return html`<span\n          class=\"linked-doc-preview ${unavailable ? 'unavailable' : ''}\"\n          >${SmallLinkedDocIcon}\n          <span class=\"linked-doc-text\"\n            >${title.length ? title : 'Untitled'}</span\n          ></span\n        >`;\n      } else {\n        // If not linked doc, render the text.\n        return delta.insert.toString().trim().length > 0\n          ? html`<span>${delta.insert.toString()}</span>`\n          : nothing;\n      }\n    });\n\n    return html`<span class=\"text subtype ${block.type}\">${previewText}</span>\n      ${this.showPreviewIcon\n        ? html`<span class=${iconClass}>${previewIconMap[block.type]}</span>`\n        : nothing}`;\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n  }\n\n  override disconnectedCallback(): void {\n    super.disconnectedCallback();\n    this._clearTextDisposables();\n  }\n\n  override updated() {\n    this.updateComplete\n      .then(() => {\n        if (\n          BlocksUtils.matchFlavours(this.block, [\n            'affine:paragraph',\n            'affine:list',\n          ])\n        ) {\n          this._setTextDisposables(this.block);\n        }\n      })\n      .catch(console.error);\n  }\n\n  renderBlockByFlavour() {\n    const { block } = this;\n    const iconClass = this.disabledIcon ? 'icon disabled' : 'icon';\n\n    const isHeadingBlock =\n      BlocksUtils.matchFlavours(block, ['affine:paragraph']) &&\n      headingKeys.has(block.type);\n    if (!this.enableNotesSorting && !isHeadingBlock) return nothing;\n\n    switch (block.flavour as keyof BlockSuite.BlockModels) {\n      case 'affine:paragraph':\n        assertType<ParagraphBlockModel>(block);\n        return this._TextBlockPreview(block);\n      case 'affine:list':\n        assertType<ListBlockModel>(block);\n        return this._TextBlockPreview(block);\n      case 'affine:bookmark':\n        assertType<BookmarkBlockModel>(block);\n        return html`\n          <span class=\"text general\"\n            >${block.title || block.url || placeholderMap['bookmark']}</span\n          >\n          ${this.showPreviewIcon\n            ? html`<span class=${iconClass}\n                >${previewIconMap['bookmark']}</span\n              >`\n            : nothing}\n        `;\n      case 'affine:code':\n        assertType<CodeBlockModel>(block);\n        return html`\n          <span class=\"text general\"\n            >${block.language ?? placeholderMap['code']}</span\n          >\n          ${this.showPreviewIcon\n            ? html`<span class=${iconClass}>${previewIconMap['code']}</span>`\n            : nothing}\n        `;\n      case 'affine:database':\n        assertType<DatabaseBlockModel>(block);\n        return html`\n          <span class=\"text general\"\n            >${block.title.toString().length\n              ? block.title.toString()\n              : placeholderMap['database']}</span\n          >\n          ${this.showPreviewIcon\n            ? html`<span class=${iconClass}>${previewIconMap['table']}</span>`\n            : nothing}\n        `;\n      case 'affine:image':\n        assertType<ImageBlockModel>(block);\n        return html`\n          <span class=\"text general\"\n            >${block.caption?.length\n              ? block.caption\n              : placeholderMap['image']}</span\n          >\n          ${this.showPreviewIcon\n            ? html`<span class=${iconClass}>${previewIconMap['image']}</span>`\n            : nothing}\n        `;\n      case 'affine:attachment':\n        assertType<AttachmentBlockModel>(block);\n        return html`\n          <span class=\"text general\"\n            >${block.name?.length\n              ? block.name\n              : placeholderMap['attachment']}</span\n          >\n          ${this.showPreviewIcon\n            ? html`<span class=${iconClass}\n                >${previewIconMap['attachment']}</span\n              >`\n            : nothing}\n        `;\n      default:\n        return nothing;\n    }\n  }\n\n  override render() {\n    return html`<div class=\"outline-block-preview\">\n      ${this.renderBlockByFlavour()}\n    </div>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'outline-block-preview': OutlineBlockPreview;\n  }\n}\n"]}