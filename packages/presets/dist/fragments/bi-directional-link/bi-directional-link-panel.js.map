{"version":3,"file":"bi-directional-link-panel.js","sourceRoot":"","sources":["../../../src/fragments/bi-directional-link/bi-directional-link-panel.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAO,EAAE,cAAc,EAAE,MAAM,uBAAuB,CAAC;AAKvD,OAAO,EAEL,iCAAiC,EACjC,mBAAmB,GACpB,MAAM,oBAAoB,CAAC;AAC5B,OAAO,EAAE,WAAW,EAAE,aAAa,EAAE,QAAQ,EAAE,MAAM,oBAAoB,CAAC;AAC1E,OAAO,EAAE,YAAY,EAAE,IAAI,EAAE,MAAM,0BAA0B,CAAC;AAG9D,OAAO,EAAE,GAAG,EAAE,IAAI,EAAE,UAAU,EAAE,OAAO,EAAuB,MAAM,KAAK,CAAC;AAC1E,OAAO,EAAE,aAAa,EAAE,QAAQ,EAAE,KAAK,EAAE,MAAM,mBAAmB,CAAC;AACnE,OAAO,EAAE,MAAM,EAAE,MAAM,0BAA0B,CAAC;AAClD,OAAO,EAAE,QAAQ,EAAE,MAAM,6BAA6B,CAAC;AAEvD,OAAO,EACL,aAAa,EACb,aAAa,EACb,eAAe,EACf,kBAAkB,GACnB,MAAM,qBAAqB,CAAC;AAC7B,OAAO,EAAE,uBAAuB,EAAE,MAAM,2BAA2B,CAAC;AAEpE,IAAI,CAAC,QAAQ,CAAC,CAAC;AAEf,MAAM,EAAE,aAAa,EAAE,GAAG,WAAW,CAAC;IAGzB,sBAAsB;4BADlC,aAAa,CAAC,2BAA2B,CAAC;;;;sBACC,cAAc,CAAC,UAAU,CAAC;;;;;;;;;;;;;sCAAlC,SAAQ,WAA0B;;;;iCA4OnE,KAAK,EAAE;yCAGP,KAAK,EAAE;+BAKP,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;oCAG9B,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;YAV/B,oKAAiB,KAAK,6BAAL,KAAK,qFAAS;YAG/B,4LAAiB,aAAa,6BAAb,aAAa,qGAAiB;YAK/C,8JAAS,GAAG,6BAAH,GAAG,iFAAO;YAGnB,6KAAS,QAAQ,6BAAR,QAAQ,2FAA0B;YAxP7C,6KAshBC;;;;QArhBC,IAAY,KAAK;YACf,OAAO,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC;QAC5B,CAAC;QAED,IAAY,MAAM;YAChB,MAAM,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;YAErB,MAAM,GAAG,GAAG,IAAI,GAAG,EAAU,CAAC;YAC9B,GAAG;iBACA,iBAAiB,CAAC;gBACjB,kBAAkB;gBAClB,aAAa;gBACb,yBAAyB;gBACzB,yBAAyB;aAC1B,CAAC;iBACD,OAAO,CAAC,KAAK,CAAC,EAAE;gBACf,IAAI,KAAK,CAAC,IAAI,EAAE,CAAC;oBACf,MAAM,MAAM,GACV,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;oBAE7B,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;wBACrB,IAAI,KAAK,CAAC,UAAU,EAAE,SAAS,EAAE,MAAM;4BACrC,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;oBAC/C,CAAC,CAAC,CAAC;gBACL,CAAC;qBAAM,IACL,aAAa,CAAC,KAAK,EAAE;oBACnB,yBAAyB;oBACzB,yBAAyB;iBAC1B,CAAC,EACF,CAAC;oBACD,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;gBACxB,CAAC;YACH,CAAC,CAAC,CAAC;YAEL,OAAO,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QACzB,CAAC;QAED,IAAY,YAAY;YACtB,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,CAAC;QACnD,CAAC;QAED,IAAY,UAAU;YACpB,MAAM,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;YACrB,MAAM,EAAE,UAAU,EAAE,GAAG,GAAG,CAAC;YAC3B,MAAM,SAAS,GAAG,IAAI,GAAG,EAAoB,CAAC;YAC9C,UAAU,CAAC,OAAO,CAAC,QAAQ,EAAE,WAAW,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE;gBACpE,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC;gBACxB,IAAI,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC;oBACpB,GAAG,CAAC,GAAG,CAAC,MAAM,CAAE,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;gBACtC,CAAC;qBAAM,CAAC;oBACN,GAAG,CAAC,GAAG,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC;gBAClC,CAAC;gBACD,OAAO,GAAG,CAAC;YACb,CAAC,EAAE,SAAS,CAAC,CAAC;YAEd,OAAO,SAAS,CAAC;QACnB,CAAC;iBAEe,WAAM,GAAG,GAAG,CAAA;;;;;;;;UAQpB,uBAAuB;;;;UAIvB,uBAAuB;;;;;;;;wBAQT,uBAAuB;yBACtB,uBAAuB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GA0J7C,AA/KqB,CA+KpB;QAGF,wBAA+B;QAA/B,IAAiB,KAAK,2CAAS;QAA/B,IAAiB,KAAK,iDAAS;QAG/B,gCAA+C;QAA/C,IAAiB,aAAa,mDAAiB;QAA/C,IAAiB,aAAa,yDAAiB;QAK/C,sBAAmB;QAAnB,IAAS,GAAG,yCAAO;QAAnB,IAAS,GAAG,+CAAO;QAGnB,2BAA2C;QAA3C,IAAS,QAAQ,8CAA0B;QAA3C,IAAS,QAAQ,oDAA0B;QAEnC,WAAW;YACjB,IAAI,CAAC,KAAK,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC;YACzB,IAAI,CAAC,YAAY,CAAC,cAAc,CAAC,OAAO,CAAC,mBAAmB,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;QAC5E,CAAC;QAEO,YAAY,CAAC,GAAa;YAChC,MAAM,EAAE,UAAU,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC;YAEhC,OAAO,IAAI,CAAA;kDACmC,GAAG,CAAC,MAAM;QACpD,MAAM,CACN,GAAG,EACH,EAAE,CAAC,EAAE,CAAC,EAAE,EACR,EAAE,CAAC,EAAE;gBACH,MAAM,GAAG,GAAG,UAAU,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;gBAElC,MAAM,SAAS,GAAG,CAAC,GAAG,CAAC;gBAEvB,MAAM,KAAK,GAAG,SAAS;oBACrB,CAAC,CAAC,aAAa;oBACf,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI;wBACT,CAAC,CAAC,UAAU;wBACZ,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC;gBAErB,MAAM,IAAI,GAAG,SAAS,CAAC,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,kBAAkB,CAAC;gBAE9D,OAAO,IAAI,CAAA;oBACD,QAAQ,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,EAAE,EAAE;qBACnC,CAAC,CAAa,EAAE,EAAE;oBACzB,IAAI,CAAC,gBAAgB,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;gBAC/B,CAAC;;cAEC,IAAI;mBACC,KAAK;iBACP,CAAC;YACV,CAAC,CACF;YACK,CAAC;QACX,CAAC;QAEO,gBAAgB,CAAC,SAAgC;YACvD,MAAM,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;YACrB,MAAM,EAAE,UAAU,EAAE,GAAG,GAAG,CAAC;YAC3B,MAAM,MAAM,GAAG,SAAS,CAAC,IAAI,CAAC;YAE9B,OAAO,IAAI,CAAA;sCACuB,eAAe,MAAM,EAAE;QACrD,MAAM,CACN,SAAS,CAAC,IAAI,EAAE,EAChB,EAAE,CAAC,EAAE,CAAC,EAAE,EACR,CAAC,KAAK,EAAE,KAAK,EAAE,EAAE;gBACf,MAAM,GAAG,GAAG,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;gBACrC,MAAM,MAAM,GAAG,SAAS,CAAC,GAAG,CAAC,KAAK,CAAE,CAAC;gBACrC,YAAY,CAAC,GAAG,CAAC,CAAC;gBAClB,MAAM,IAAI,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC;gBAEhD,MAAM,WAAW,GAAG,IAAI,CAAC,KAAM,CAAC,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,CAAC;gBAE/D,OAAO,IAAI,CAAA;;;;;;;;;;;gBAWL,WAAW,CAAC,MAAM,CAAC,MAAM;gBACzB,WAAW,CAAC,MAAM,CAAC,MAAM;;;;;;0BAMf,QAAQ,CAAC;oBACf,SAAS,EAAE,UAAU,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,MAAM;iBACzC,CAAC;2BACO,GAAG,EAAE;oBACZ,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC;oBAClC,IAAI,CAAC,aAAa,EAAE,CAAC;gBACvB,CAAC;;oBAEC,aAAa;;;oBAGb,kBAAkB,GAAG,GAAG,CAAC,IAAI,EAAE,KAAK;oBACpC,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK;oBAChB,CAAC,CAAC,UAAU;;;;;;;;oBAQZ,IAAI;oBACJ,CAAC,CAAC,MAAM,CACJ,MAAM,EACN,OAAO,CAAC,EAAE,CAAC,OAAO,EAClB,OAAO,CAAC,EAAE;wBACR,MAAM,KAAK,GAAG,GAAG,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;wBACxC,IAAI,CAAC,KAAK;4BAAE,OAAO,OAAO,CAAC;wBAC3B,OAAO,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE,KAAK,EAAE,OAAO,CAAC,CAAC;oBAC/C,CAAC,CACF;oBACH,CAAC,CAAC,OAAO;;;mBAGV,CAAC;YACZ,CAAC,CACF;WACI,CAAC;QACV,CAAC;QAEO,gBAAgB,CAAC,CAAa,EAAE,KAAa,EAAE,OAAgB;YACrE,IAAI,CAAC,CAAC,QAAQ,IAAI,IAAI,CAAC,YAAY,CAAC,eAAe,EAAE,CAAC;gBACpD,IAAI,CAAC,YAAY,CAAC,eAAe;qBAC9B,IAAI,CAAC;oBACJ,KAAK;oBACL,OAAO;iBACR,CAAC;qBACD,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;YAC1B,CAAC;iBAAM,CAAC;gBACN,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,cAAc,CAAC,IAAI,CAAC;oBACtC,KAAK;oBACL,OAAO;iBACR,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAEO,SAAS,CAAC,KAAyB,EAAE,KAAa,EAAE,OAAe;YACzE,IACE,CAAC,aAAa,CAAC,KAAK,EAAE;gBACpB,kBAAkB;gBAClB,aAAa;gBACb,yBAAyB;gBACzB,yBAAyB;aAC1B,CAAC;gBAEF,OAAO,OAAO,CAAC;YAEjB,IAAI,IAAI,GAA6B,IAAI,CAAC;YAC1C,IAAI,aAAa,CAAC,KAAK,EAAE,CAAC,aAAa,CAAC,CAAC,EAAE,CAAC;gBAC1C,MAAM,WAAW,GAAG,IAAI,CAAC,KAAM,CAAC,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,CAAC;gBAE/D,IAAI,GAAG,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,KAAK,EAAE,GAAG,EAAE,GAAE,CAAC,CAAC,CAAC;YACzD,CAAC;YACD,MAAM,IAAI,GAAG,aAAa,CAAC,KAAK,EAAE;gBAChC,yBAAyB;gBACzB,yBAAyB;aAC1B,CAAC;gBACA,CAAC,CAAC,EAAE;gBACJ,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC;YAEf,OAAO,IAAI,CAAA;cACD,uBAAuB,IAAI,EAAE;eAC5B,CAAC,CAAa,EAAE,EAAE;gBACzB,IAAI,CAAC,gBAAgB,CAAC,CAAC,EAAE,KAAK,EAAE,OAAO,CAAC,CAAC;YAC3C,CAAC;;;UAGG,IAAI;gBACJ,CAAC,CAAC,IAAI,CAAA,GAAG,IAAI,IAAI,OAAO;;yBAET,KAAK,CAAC,IAAI;4BACP,IAAI;oCACI,IAAI,CAAC,cAAc,CAAC,SAAS,EAAE;qCAC9B,IAAI,CAAC,cAAc,CAAC,WAAW,EAAE;4BAC1C;gBAClB,CAAC,CAAC,IAAI,CAAA;gBACA,kBAAkB;gBAClB,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC,UAAU;mBACrD;;;gCAGa,aAAa;WAClC,CAAC;QACV,CAAC;QAEO,QAAQ,CAAC,OAAgB;YAC/B,OAAO,IAAI,CAAA;;;;;;;;;;;;;;;;gBAgBC,QAAQ,CAAC;gBACf,UAAU,EAAE,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,QAAQ;aAC3C,CAAC;;;;;KAKL,CAAC;QACJ,CAAC;QAEkB,MAAM;YACvB,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC;YAC1B,MAAM,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC;YAElC,IAAI,KAAK,CAAC,MAAM,GAAG,SAAS,CAAC,IAAI,KAAK,CAAC;gBAAE,OAAO,OAAO,CAAC;YAExD,OAAO,IAAI,CAAA;;;;;mBAKI,IAAI,CAAC,KAAK;gBACjB,CAAC,CAAC,kCAAkC;gBACpC,CAAC,CAAC,kCAAkC;;;;;;;;;;;;;;;;QAgBxC,IAAI,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC;;;0CAGQ,IAAI,CAAC,WAAW;YAC9C,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,MAAM;;;QAGhC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC;QACzB,IAAI,CAAC,KAAK;gBACV,CAAC,CAAC,IAAI,CAAA,GAAG,IAAI,CAAC,gBAAgB,CAAC,SAAS,CAAC,IAAI,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,GAAG;gBACxE,CAAC,CAAC,OAAO,GAAG,CAAC;QACnB,CAAC;QAEQ,iBAAiB;YACxB,KAAK,CAAC,iBAAiB,EAAE,CAAC;YAC1B,MAAM,MAAM,GAAG,IAAI,mBAAmB,EAAE,CAAC;YACzC,MAAM,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;YAC9B,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YACxB,MAAM,CAAC,gBAAgB,CAAC,CAAC,SAA0B,EAAE,EAAE;gBACrD,MAAM,KAAK,GAAG,SAAS,CAAC,GAAG,CAAC,IAAI,EAAE,KAAK;oBACrC,CAAC,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK;oBAC1B,CAAC,CAAC,UAAU,CAAC;gBACf,OAAO,IAAI,CAAA;;;;;;;YAOL,kBAAkB,IAAI,KAAK;iBACtB,CAAC;YACd,CAAC,CAAC,CAAC;YACH,IAAI,CAAC,cAAc,CAAC,aAAa,CAC/B,iCAAiC,CAAC,MAAM,CAAC,CAC1C,CAAC;YACF,IAAI,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;gBACzC,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,CAAC;gBAC9B,YAAY,CAAC,GAAG,CACd,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,YAAY,CAAC,EAAE,CAAC,GAAG,EAAE;oBAC9D,IAAI,CAAC,aAAa,EAAE,CAAC;gBACvB,CAAC,CAAC,CACH,CAAC;YACJ,CAAC;YAED,IAAI,CAAC,KAAK;gBACR,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,cAAc,CAAC,OAAO,CAAC,mBAAmB,CAAC,CAAC;QACpE,CAAC;;;YAxSgB,4EAAQ,KAAK,EAAC;YAGd,gJAA2B,EAAE,GAAC;YAEvC,mBAAc,+DAAG,IAAI,aAAa,EAAE,EAAC;YAGpC,gFAAU;YAGV,6IAAkC;;;;YAxPhC,uDAAsB;;;;;SAAtB,sBAAsB","sourcesContent":["import { WithDisposable } from '@blocksuite/block-std';\nimport type {\n  AffineReference,\n  PageRootBlockComponent,\n} from '@blocksuite/blocks';\nimport {\n  type AffineTextAttributes,\n  getAffineInlineSpecsWithReference,\n  ReferenceNodeConfig,\n} from '@blocksuite/blocks';\nimport { BlocksUtils, InlineManager, RichText } from '@blocksuite/blocks';\nimport { assertExists, noop } from '@blocksuite/global/utils';\nimport type { DeltaInsert } from '@blocksuite/inline';\nimport type { BlockModel, Doc } from '@blocksuite/store';\nimport { css, html, LitElement, nothing, type TemplateResult } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport {\n  ArrowJumpIcon,\n  ArrowLeftIcon,\n  SmallDeleteIcon,\n  SmallLinkedDocIcon,\n} from '../_common/icons.js';\nimport { DOC_BLOCK_CHILD_PADDING } from '../doc-meta-tags/utils.js';\n\nnoop(RichText);\n\nconst { matchFlavours } = BlocksUtils;\n\n@customElement('bi-directional-link-panel')\nexport class BiDirectionalLinkPanel extends WithDisposable(LitElement) {\n  private get _host() {\n    return this.pageRoot.host;\n  }\n\n  private get _links() {\n    const { doc } = this;\n\n    const ids = new Set<string>();\n    doc\n      .getBlockByFlavour([\n        'affine:paragraph',\n        'affine:list',\n        'affine:embed-linked-doc',\n        'affine:embed-synced-doc',\n      ])\n      .forEach(model => {\n        if (model.text) {\n          const deltas: DeltaInsert<AffineTextAttributes>[] =\n            model.text.yText.toDelta();\n\n          deltas.forEach(delta => {\n            if (delta.attributes?.reference?.pageId)\n              ids.add(delta.attributes.reference.pageId);\n          });\n        } else if (\n          matchFlavours(model, [\n            'affine:embed-linked-doc',\n            'affine:embed-synced-doc',\n          ])\n        ) {\n          ids.add(model.pageId);\n        }\n      });\n\n    return Array.from(ids);\n  }\n\n  private get _rootService() {\n    return this._host.spec.getService('affine:page');\n  }\n\n  private get _backLinks() {\n    const { doc } = this;\n    const { collection } = doc;\n    const backLinks = new Map<string, string[]>();\n    collection.indexer.backlink?.getBacklink(doc.id).reduce((map, link) => {\n      const { pageId } = link;\n      if (map.has(pageId)) {\n        map.get(pageId)!.push(link.blockId);\n      } else {\n        map.set(pageId, [link.blockId]);\n      }\n      return map;\n    }, backLinks);\n\n    return backLinks;\n  }\n\n  static override styles = css`\n    :host {\n      width: 100%;\n      max-width: var(--affine-editor-width);\n      margin-left: auto;\n      margin-right: auto;\n      padding-left: var(\n        --affine-editor-side-padding,\n        ${DOC_BLOCK_CHILD_PADDING}\n      );\n      padding-right: var(\n        --affine-editor-side-padding,\n        ${DOC_BLOCK_CHILD_PADDING}\n      );\n      font-size: var(--affine-font-base);\n    }\n\n    /* Extra small devices (phones, 640px and down) */\n    @container viewport (width <= 640px) {\n      :host {\n        padding-left: ${DOC_BLOCK_CHILD_PADDING}px;\n        padding-right: ${DOC_BLOCK_CHILD_PADDING}px;\n      }\n    }\n\n    .title-line {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    }\n\n    .back-links-title,\n    .links-title {\n      color: var(--affine-text-secondary-color);\n      height: 32px;\n      line-height: 32px;\n    }\n\n    .links,\n    .back-links {\n      margin-bottom: 16px;\n    }\n\n    .back-link-title {\n      width: 100%;\n      height: 32px;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n\n    .back-link-title div {\n      display: flex;\n      align-items: center;\n      gap: 4px;\n      color: var(--affine-text-primary-color);\n    }\n\n    .back-links-container {\n      height: auto;\n      display: flex;\n    }\n\n    .back-links-container-left-divider {\n      width: 20px;\n      display: flex;\n      justify-content: center;\n    }\n    .back-links-container-left-divider div {\n      width: 1px;\n      height: 100%;\n      background-color: var(--affine-border-color);\n    }\n\n    .link {\n      width: 100%;\n      height: 32px;\n      display: flex;\n      align-items: center;\n      gap: 4px;\n      white-space: nowrap;\n      cursor: pointer;\n    }\n\n    .link svg {\n      flex: none;\n    }\n\n    .link div {\n      width: fit-content;\n      height: 100%;\n      overflow: hidden;\n      text-overflow: ellipsis;\n      line-height: 32px;\n      border-bottom: 0.5px solid var(--affine-divider-color);\n    }\n\n    .link.deleted {\n      color: var(--affine-text-disable-color);\n      text-decoration: line-through;\n      fill: var(--affine-text-disable-color);\n    }\n\n    .arrow {\n      cursor: pointer;\n      transition: transform 0.2s;\n    }\n\n    .back-links-blocks-container {\n      width: 100%;\n      display: flex;\n      flex-direction: column;\n      padding-left: 8px;\n      position: relative;\n    }\n\n    .rich-text-container {\n      width: 100%;\n      display: flex;\n      justify-content: space-between;\n      align-items: start;\n      cursor: pointer;\n      border-radius: 4px;\n      padding: 0px 8px;\n      padding-top: 8px;\n    }\n\n    .rich-text {\n      max-width: 96%;\n      padding-bottom: 8px;\n    }\n\n    .arrow-link {\n      width: 24px;\n      height: 24px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 4px;\n      display: none;\n    }\n\n    .rich-text-container:hover {\n      background-color: var(--affine-hover-color);\n    }\n\n    .rich-text-container:hover .arrow-link {\n      display: flex;\n    }\n    .arrow-link:hover {\n      background-color: var(--affine-hover-color);\n    }\n\n    .quote {\n      padding-left: 24px;\n    }\n    .quote::after {\n      content: '';\n      width: 2px;\n      height: 24px;\n      position: absolute;\n      left: 16px;\n      background: var(--affine-quote-color);\n      border-radius: 18px;\n    }\n\n    .linked-doc-container {\n      display: flex;\n      align-items: center;\n      padding-left: 2px;\n      gap: 2px;\n    }\n    .linked-doc-container svg {\n      scale: 1.2;\n    }\n  `;\n\n  @state()\n  private accessor _show = false;\n\n  @state()\n  private accessor _backLinkShow: boolean[] = [];\n\n  private _inlineManager = new InlineManager();\n\n  @property({ attribute: false })\n  accessor doc!: Doc;\n\n  @property({ attribute: false })\n  accessor pageRoot!: PageRootBlockComponent;\n\n  private _toggleShow() {\n    this._show = !this._show;\n    this._rootService.editPropsStore.setItem('showBidirectional', this._show);\n  }\n\n  private _renderLinks(ids: string[]) {\n    const { collection } = this.doc;\n\n    return html`<div class=\"links\">\n      <div class=\"links-title\">Outgoing links · ${ids.length}</div>\n      ${repeat(\n        ids,\n        id => id,\n        id => {\n          const doc = collection.getDoc(id);\n\n          const isDeleted = !doc;\n\n          const title = isDeleted\n            ? 'Deleted doc'\n            : !doc.meta\n              ? 'Untitled'\n              : doc.meta.title;\n\n          const icon = isDeleted ? SmallDeleteIcon : SmallLinkedDocIcon;\n\n          return html`<div\n            class=${`link ${isDeleted ? 'deleted' : ''}`}\n            @click=${(e: MouseEvent) => {\n              this._handleLinkClick(e, id);\n            }}\n          >\n            ${icon}\n            <div>${title}</div>\n          </div>`;\n        }\n      )}\n    </div> `;\n  }\n\n  private _renderBackLinks(backLinks: Map<string, string[]>) {\n    const { doc } = this;\n    const { collection } = doc;\n    const length = backLinks.size;\n\n    return html` <div class=\"back-links\">\n      <div class=\"back-links-title\">${`Backlinks · ${length}`}</div>\n      ${repeat(\n        backLinks.keys(),\n        id => id,\n        (docId, index) => {\n          const doc = collection.getDoc(docId);\n          const blocks = backLinks.get(docId)!;\n          assertExists(doc);\n          const show = this._backLinkShow[index] ?? false;\n\n          const listService = this._host!.spec.getService('affine:list');\n\n          return html`<style>\n              .affine-list-block__prefix{\n                display: flex;\n                align-items: center;\n              }\n\n              .rich-text{\n                display: flex;\n                align-items: center;\n              }\n\n              ${listService.styles.prefix}\n              ${listService.styles.toggle}\n            </style>\n            <div class=\"back-link\">\n              <div class=\"back-link-title\">\n                <div\n                  class=\"arrow\"\n                  style=${styleMap({\n                    transform: `rotate(${show ? 90 : 0}deg)`,\n                  })}\n                  @click=${() => {\n                    this._backLinkShow[index] = !show;\n                    this.requestUpdate();\n                  }}\n                >\n                  ${ArrowLeftIcon}\n                </div>\n                <div>\n                  ${SmallLinkedDocIcon}${doc.meta?.title\n                    ? doc.meta.title\n                    : 'Untitled'}\n                </div>\n              </div>\n              <div class=\"back-links-container\">\n                <div class=\"back-links-container-left-divider\">\n                  <div></div>\n                </div>\n                <div class=\"back-links-blocks-container\">\n                  ${show\n                    ? repeat(\n                        blocks,\n                        blockId => blockId,\n                        blockId => {\n                          const model = doc.getBlockById(blockId);\n                          if (!model) return nothing;\n                          return this._backlink(model, docId, blockId);\n                        }\n                      )\n                    : nothing}\n                </div>\n              </div>\n            </div>`;\n        }\n      )}\n    </div>`;\n  }\n\n  private _handleLinkClick(e: MouseEvent, docId: string, blockId?: string) {\n    if (e.shiftKey && this._rootService.peekViewService) {\n      this._rootService.peekViewService\n        .peek({\n          docId,\n          blockId,\n        })\n        .catch(console.error);\n    } else {\n      this.pageRoot.slots.docLinkClicked.emit({\n        docId,\n        blockId,\n      });\n    }\n  }\n\n  private _backlink(model: BlockModel<object>, docId: string, blockId: string) {\n    if (\n      !matchFlavours(model, [\n        'affine:paragraph',\n        'affine:list',\n        'affine:embed-linked-doc',\n        'affine:embed-synced-doc',\n      ])\n    )\n      return nothing;\n\n    let icon: TemplateResult<1> | null = null;\n    if (matchFlavours(model, ['affine:list'])) {\n      const listService = this._host!.spec.getService('affine:list');\n\n      icon = listService.styles.icon(model, false, () => {});\n    }\n    const type = matchFlavours(model, [\n      'affine:embed-linked-doc',\n      'affine:embed-synced-doc',\n    ])\n      ? ''\n      : model.type;\n\n    return html` <div\n      class=${`rich-text-container ${type}`}\n      @click=${(e: MouseEvent) => {\n        this._handleLinkClick(e, docId, blockId);\n      }}\n    >\n      <div class=\"rich-text\">\n        ${type\n          ? html`${icon ?? nothing}\n              <rich-text\n                .yText=${model.text}\n                .readonly=${true}\n                .attributesSchema=${this._inlineManager.getSchema()}\n                .attributeRenderer=${this._inlineManager.getRenderer()}\n              ></rich-text>`\n          : html`<div class=\"linked-doc-container\">\n              ${SmallLinkedDocIcon}\n              ${this.doc.meta?.title ? this.doc.meta?.title : 'Untitled'}\n            </div>`}\n      </div>\n\n      <div class=\"arrow-link\">${ArrowJumpIcon}</div>\n    </div>`;\n  }\n\n  private _divider(visible: boolean) {\n    return html`\n      <style>\n        .divider-container {\n          height: 16px;\n          width: 100%;\n          display: flex;\n          justify-content: center;\n          align-items: center;\n        }\n        .divider {\n          background: var(--affine-border-color);\n          height: 0.5px;\n          width: 100%;\n        }\n      </style>\n      <div\n        style=${styleMap({\n          visibility: visible ? 'visible' : 'hidden',\n        })}\n        class=\"divider-container\"\n      >\n        <div class=\"divider\"></div>\n      </div>\n    `;\n  }\n\n  protected override render() {\n    const links = this._links;\n    const backLinks = this._backLinks;\n\n    if (links.length + backLinks.size === 0) return nothing;\n\n    return html`<style>\n        .title {\n          font-weight: 500;\n          font-size: 15px;\n          line-height: 24px;\n          color: ${this._show\n            ? 'var(--affine-text-primary-color)'\n            : 'var(--affine-text-disable-color)'};\n        }\n        .show-button {\n          width: 56px;\n          height: 28px;\n          border-radius: 8px;\n          border: 1px solid var(--affine-border-color);\n          background-color: var(--affine-white);\n          text-align: center;\n          font-size: 12px;\n          line-height: 28px;\n          font-weight: 500;\n          color: var(--affine-text-primary-color);\n          cursor: pointer;\n        }\n      </style>\n      ${this._divider(!this._show)}\n      <div class=\"title-line\">\n        <div class=\"title text\">Bi-directional links</div>\n        <div class=\"show-button\" @click=${this._toggleShow}>\n          ${this._show ? 'Hide' : 'Show'}\n        </div>\n      </div>\n      ${this._divider(this._show)}\n      ${this._show\n        ? html`${this._renderBackLinks(backLinks)} ${this._renderLinks(links)} `\n        : nothing} `;\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    const config = new ReferenceNodeConfig();\n    config.setInteractable(false);\n    config.setDoc(this.doc);\n    config.setCustomContent((reference: AffineReference) => {\n      const title = reference.doc.meta?.title\n        ? reference.doc.meta.title\n        : 'Untitled';\n      return html`<style>\n          .custom-reference-content svg {\n            position: relative;\n            top: 2px;\n          }\n        </style>\n        <span class=\"custom-reference-content\">\n          ${SmallLinkedDocIcon} ${title}\n        </span> `;\n    });\n    this._inlineManager.registerSpecs(\n      getAffineInlineSpecsWithReference(config)\n    );\n    if (this.doc.collection.indexer.backlink) {\n      const { _disposables } = this;\n      _disposables.add(\n        this.doc.collection.indexer.backlink.slots.indexUpdated.on(() => {\n          this.requestUpdate();\n        })\n      );\n    }\n\n    this._show =\n      !!this._rootService.editPropsStore.getItem('showBidirectional');\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'bi-directional-link-panel': BiDirectionalLinkPanel;\n  }\n}\n"]}