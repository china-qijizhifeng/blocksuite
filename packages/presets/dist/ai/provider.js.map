{"version":3,"file":"provider.js","sourceRoot":"","sources":["../../src/ai/provider.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport { PaymentRequiredError, UnauthorizedError } from '@blocksuite/blocks';\nimport { Slot } from '@blocksuite/store';\n\nexport interface AIUserInfo {\n  id: string;\n  email: string;\n  name: string;\n  avatarUrl: string | null;\n}\n\nexport type ActionEventType =\n  | 'started'\n  | 'finished'\n  | 'error'\n  | 'aborted:paywall'\n  | 'aborted:login-required'\n  | 'aborted:server-error'\n  | 'aborted:stop'\n  | 'result:insert'\n  | 'result:replace'\n  | 'result:use-as-caption'\n  | 'result:add-page'\n  | 'result:add-note'\n  | 'result:continue-in-chat'\n  | 'result:discard'\n  | 'result:retry';\n\n/**\n * AI provider for the block suite\n *\n * To use it, downstream (affine) has to provide AI actions implementation,\n * user info etc\n *\n * todo: breakdown into different parts?\n */\nexport class AIProvider {\n  static get slots() {\n    return AIProvider.instance.slots;\n  }\n\n  static get actions() {\n    return AIProvider.instance.actions;\n  }\n\n  static get userInfo() {\n    return AIProvider.instance.userInfoFn();\n  }\n\n  static get photoEngine() {\n    return AIProvider.instance.photoEngine;\n  }\n\n  static get histories() {\n    return AIProvider.instance.histories;\n  }\n\n  static get actionHistory() {\n    return AIProvider.instance.actionHistory;\n  }\n\n  static get toggleGeneralAIOnboarding() {\n    return AIProvider.instance.toggleGeneralAIOnboarding;\n  }\n\n  private static readonly instance = new AIProvider();\n\n  static LAST_ACTION_SESSIONID = '';\n\n  static MAX_LOCAL_HISTORY = 10;\n\n  private readonly actions: Partial<BlockSuitePresets.AIActions> = {};\n\n  private photoEngine: BlockSuitePresets.AIPhotoEngineService | null = null;\n\n  private histories: BlockSuitePresets.AIHistoryService | null = null;\n\n  private toggleGeneralAIOnboarding: ((value: boolean) => void) | null = null;\n\n  private readonly slots = {\n    // use case: when user selects \"continue in chat\" in an ask ai result panel\n    // do we need to pass the context to the chat panel?\n    requestContinueInChat: new Slot<{ host: EditorHost; show: boolean }>(),\n    requestLogin: new Slot<{ host: EditorHost }>(),\n    requestUpgradePlan: new Slot<{ host: EditorHost }>(),\n    // when an action is requested to run in edgeless mode (show a toast in affine)\n    requestRunInEdgeless: new Slot<{ host: EditorHost }>(),\n    // stream of AI actions triggered by users\n    actions: new Slot<{\n      action: keyof BlockSuitePresets.AIActions;\n      options: BlockSuitePresets.AITextActionOptions;\n      event: ActionEventType;\n    }>(),\n    // downstream can emit this slot to notify ai presets that user info has been updated\n    userInfo: new Slot<AIUserInfo | null>(),\n    // add more if needed\n  };\n\n  // track the history of triggered actions (in memory only)\n  private readonly actionHistory: {\n    action: keyof BlockSuitePresets.AIActions;\n    options: BlockSuitePresets.AITextActionOptions;\n  }[] = [];\n\n  private userInfoFn: () => AIUserInfo | Promise<AIUserInfo> | null = () =>\n    null;\n\n  private provideAction<T extends keyof BlockSuitePresets.AIActions>(\n    id: T,\n    action: (\n      ...options: Parameters<BlockSuitePresets.AIActions[T]>\n    ) => ReturnType<BlockSuitePresets.AIActions[T]>\n  ): void {\n    if (this.actions[id]) {\n      console.warn(`AI action ${id} is already provided`);\n    }\n    // @ts-expect-error todo: maybe fix this\n    this.actions[id] = (\n      ...args: Parameters<BlockSuitePresets.AIActions[T]>\n    ) => {\n      const options = args[0];\n      const slots = this.slots;\n      slots.actions.emit({\n        action: id,\n        options,\n        event: 'started',\n      });\n      this.actionHistory.push({ action: id, options });\n      if (this.actionHistory.length > AIProvider.MAX_LOCAL_HISTORY) {\n        this.actionHistory.shift();\n      }\n      // wrap the action with slot actions\n      const result: BlockSuitePresets.TextStream | Promise<string> = action(\n        ...args\n      );\n      const isTextStream = (\n        m: BlockSuitePresets.TextStream | Promise<string>\n      ): m is BlockSuitePresets.TextStream =>\n        Reflect.has(m, Symbol.asyncIterator);\n      if (isTextStream(result)) {\n        return {\n          [Symbol.asyncIterator]: async function* () {\n            try {\n              yield* result;\n              slots.actions.emit({\n                action: id,\n                options,\n                event: 'finished',\n              });\n            } catch (err) {\n              slots.actions.emit({\n                action: id,\n                options,\n                event: 'error',\n              });\n              if (err instanceof PaymentRequiredError) {\n                slots.actions.emit({\n                  action: id,\n                  options,\n                  event: 'aborted:paywall',\n                });\n              } else if (err instanceof UnauthorizedError) {\n                slots.actions.emit({\n                  action: id,\n                  options,\n                  event: 'aborted:login-required',\n                });\n              } else {\n                slots.actions.emit({\n                  action: id,\n                  options,\n                  event: 'aborted:server-error',\n                });\n              }\n              throw err;\n            }\n          },\n        };\n      } else {\n        return result\n          .then(result => {\n            slots.actions.emit({\n              action: id,\n              options,\n              event: 'finished',\n            });\n            return result;\n          })\n          .catch(err => {\n            slots.actions.emit({\n              action: id,\n              options,\n              event: 'error',\n            });\n            if (err instanceof PaymentRequiredError) {\n              slots.actions.emit({\n                action: id,\n                options,\n                event: 'aborted:paywall',\n              });\n            }\n            throw err;\n          });\n      }\n    };\n  }\n\n  static provide(\n    id: 'userInfo',\n    fn: () => AIUserInfo | Promise<AIUserInfo> | null\n  ): void;\n\n  static provide(\n    id: 'histories',\n    service: BlockSuitePresets.AIHistoryService\n  ): void;\n\n  static provide(\n    id: 'photoEngine',\n    engine: BlockSuitePresets.AIPhotoEngineService\n  ): void;\n\n  static provide(id: 'onboarding', fn: (value: boolean) => void): void;\n\n  // actions:\n  static provide<T extends keyof BlockSuitePresets.AIActions>(\n    id: T,\n    action: (\n      ...options: Parameters<BlockSuitePresets.AIActions[T]>\n    ) => ReturnType<BlockSuitePresets.AIActions[T]>\n  ): void;\n\n  static provide(id: unknown, action: unknown) {\n    if (id === 'userInfo') {\n      AIProvider.instance.userInfoFn = action as () => AIUserInfo;\n    } else if (id === 'histories') {\n      AIProvider.instance.histories =\n        action as BlockSuitePresets.AIHistoryService;\n    } else if (id === 'photoEngine') {\n      AIProvider.instance.photoEngine =\n        action as BlockSuitePresets.AIPhotoEngineService;\n    } else if (id === 'onboarding') {\n      AIProvider.instance.toggleGeneralAIOnboarding = action as (\n        value: boolean\n      ) => void;\n    } else {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      AIProvider.instance.provideAction(id as any, action as any);\n    }\n  }\n}\n"]}