{"version":3,"file":"selection-utils.js","sourceRoot":"","sources":["../../../src/ai/utils/selection-utils.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport {\n  type CopilotSelectionController,\n  type FrameBlockModel,\n  ImageBlockModel,\n  type SurfaceBlockComponent,\n} from '@blocksuite/blocks';\nimport { BlocksUtils, EdgelessRootService } from '@blocksuite/blocks';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { BlockModel } from '@blocksuite/store';\nimport { type DraftModel, Slice, toDraftModel } from '@blocksuite/store';\n\nimport { getEdgelessCopilotWidget, getService } from './edgeless.js';\nimport { getContentFromSlice } from './markdown-utils.js';\n\nexport const getRootService = (host: EditorHost) => {\n  return host.std.spec.getService('affine:page');\n};\n\nexport function getEdgelessRootFromEditor(editor: EditorHost) {\n  const edgelessRoot = editor.getElementsByTagName('affine-edgeless-root')[0];\n  if (!edgelessRoot) {\n    alert('Please switch to edgeless mode');\n    throw new Error('Please open switch to edgeless mode');\n  }\n  return edgelessRoot;\n}\nexport function getEdgelessService(editor: EditorHost) {\n  const rootService = editor.std.spec.getService('affine:page');\n  if (rootService instanceof EdgelessRootService) {\n    return rootService;\n  }\n  alert('Please switch to edgeless mode');\n  throw new Error('Please open switch to edgeless mode');\n}\n\nexport async function selectedToCanvas(editor: EditorHost) {\n  const edgelessRoot = getEdgelessRootFromEditor(editor);\n  const { notes, frames, shapes, images } = BlocksUtils.splitElements(\n    edgelessRoot.service.selection.selectedElements\n  );\n  if (notes.length + frames.length + images.length + shapes.length === 0) {\n    return;\n  }\n  const canvas = await edgelessRoot.clipboardController.toCanvas(\n    [...notes, ...frames, ...images],\n    shapes\n  );\n  if (!canvas) {\n    return;\n  }\n  return canvas;\n}\n\nexport async function frameToCanvas(\n  frame: FrameBlockModel,\n  editor: EditorHost\n) {\n  const edgelessRoot = getEdgelessRootFromEditor(editor);\n  const { notes, frames, shapes, images } = BlocksUtils.splitElements(\n    edgelessRoot.service.frame.getElementsInFrame(frame, true)\n  );\n  if (notes.length + frames.length + images.length + shapes.length === 0) {\n    return;\n  }\n  const canvas = await edgelessRoot.clipboardController.toCanvas(\n    [...notes, ...frames, ...images],\n    shapes\n  );\n  if (!canvas) {\n    return;\n  }\n  return canvas;\n}\n\nexport async function selectedToPng(editor: EditorHost) {\n  return (await selectedToCanvas(editor))?.toDataURL('image/png');\n}\n\nexport function getSelectedModels(editorHost: EditorHost) {\n  const chain = editorHost.std.command.chain();\n  const [_, ctx] = chain\n    .getSelectedModels({\n      types: ['block', 'text'],\n    })\n    .run();\n  const { selectedModels } = ctx;\n  return selectedModels;\n}\n\nfunction traverse(model: DraftModel, drafts: DraftModel[]) {\n  const isDatabase = model.flavour === 'affine:database';\n  const children = isDatabase\n    ? model.children\n    : model.children.filter(child => {\n        const idx = drafts.findIndex(m => m.id === child.id);\n        return idx >= 0;\n      });\n\n  children.forEach(child => {\n    const idx = drafts.findIndex(m => m.id === child.id);\n    if (idx >= 0) {\n      drafts.splice(idx, 1);\n    }\n    traverse(child, drafts);\n  });\n  model.children = children;\n}\n\nexport async function getTextContentFromBlockModels(\n  editorHost: EditorHost,\n  models: BlockModel[],\n  type: 'markdown' | 'plain-text' = 'markdown'\n) {\n  // Currently only filter out images and databases\n  const selectedTextModels = models.filter(\n    model =>\n      !BlocksUtils.matchFlavours(model, ['affine:image', 'affine:database'])\n  );\n  const drafts = selectedTextModels.map(toDraftModel);\n  drafts.forEach(draft => traverse(draft, drafts));\n  const slice = Slice.fromModels(editorHost.std.doc, drafts);\n  return getContentFromSlice(editorHost, slice, type);\n}\n\nexport async function getSelectedTextContent(\n  editorHost: EditorHost,\n  type: 'markdown' | 'plain-text' = 'markdown'\n) {\n  const selectedModels = getSelectedModels(editorHost);\n  assertExists(selectedModels);\n  return getTextContentFromBlockModels(editorHost, selectedModels, type);\n}\n\nexport async function selectAboveBlocks(editorHost: EditorHost, num = 10) {\n  let selectedModels = getSelectedModels(editorHost);\n  assertExists(selectedModels);\n\n  const lastLeafModel = selectedModels[selectedModels.length - 1];\n\n  let noteModel: BlockModel | null = lastLeafModel;\n  let lastRootModel: BlockModel | null = null;\n  while (noteModel && noteModel.flavour !== 'affine:note') {\n    lastRootModel = noteModel;\n    noteModel = editorHost.doc.getParent(noteModel);\n  }\n  assertExists(noteModel);\n  assertExists(lastRootModel);\n\n  const endIndex = noteModel.children.indexOf(lastRootModel) + 1;\n  const startIndex = Math.max(0, endIndex - num);\n  const startBlock = noteModel.children[startIndex];\n\n  selectedModels = [];\n  let stop = false;\n  const traverse = (model: BlockModel): void => {\n    if (stop) return;\n\n    selectedModels.push(model);\n\n    if (model === lastLeafModel) {\n      stop = true;\n      return;\n    }\n\n    model.children.forEach(child => traverse(child));\n  };\n  noteModel.children.slice(startIndex, endIndex).forEach(traverse);\n\n  const { selection } = editorHost;\n  selection.set([\n    selection.create('text', {\n      from: {\n        blockId: startBlock.id,\n        index: 0,\n        length: startBlock.text?.length ?? 0,\n      },\n      to: {\n        blockId: lastLeafModel.id,\n        index: 0,\n        length: selection.find('text')?.from.index ?? 0,\n      },\n    }),\n  ]);\n\n  return getTextContentFromBlockModels(editorHost, selectedModels);\n}\n\nexport const stopPropagation = (e: Event) => {\n  e.stopPropagation();\n};\n\nexport function getSurfaceElementFromEditor(editor: EditorHost) {\n  const { doc } = editor;\n  const surfaceModel = doc.getBlockByFlavour('affine:surface')[0];\n  assertExists(surfaceModel);\n\n  const surfaceId = surfaceModel.id;\n  const surfaceElement = editor.querySelector(\n    `affine-surface[data-block-id=\"${surfaceId}\"]`\n  ) as SurfaceBlockComponent;\n  assertExists(surfaceElement);\n\n  return surfaceElement;\n}\n\nexport const getFirstImageInFrame = (\n  frame: FrameBlockModel,\n  editor: EditorHost\n) => {\n  const edgelessRoot = getEdgelessRootFromEditor(editor);\n  const elements = edgelessRoot.service.frame.getElementsInFrame(frame, false);\n  const image = elements.find(ele => {\n    if (!BlocksUtils.isCanvasElement(ele)) {\n      return ele.flavour === 'affine:image';\n    }\n    return false;\n  }) as ImageBlockModel | undefined;\n  return image?.id;\n};\n\nexport const getSelections = (\n  host: EditorHost,\n  mode: 'flat' | 'highest' = 'flat'\n) => {\n  const [_, data] = host.command\n    .chain()\n    .tryAll(chain => [\n      chain.getTextSelection(),\n      chain.getBlockSelections(),\n      chain.getImageSelections(),\n    ])\n    .getSelectedBlocks({ types: ['text', 'block', 'image'], mode })\n    .run();\n\n  return data;\n};\n\nexport const getSelectedImagesAsBlobs = async (host: EditorHost) => {\n  const [_, data] = host.command\n    .chain()\n    .tryAll(chain => [\n      chain.getTextSelection(),\n      chain.getBlockSelections(),\n      chain.getImageSelections(),\n    ])\n    .getSelectedBlocks({\n      types: ['image'],\n    })\n    .run();\n\n  const blobs = await Promise.all(\n    data.selectedBlocks?.map(async b => {\n      const sourceId = (b.model as ImageBlockModel).sourceId;\n      if (!sourceId) return null;\n      const blob = await (sourceId ? host.doc.blobSync.get(sourceId) : null);\n      if (!blob) return null;\n      return new File([blob], sourceId);\n    }) ?? []\n  );\n  return blobs.filter((blob): blob is File => !!blob);\n};\n\nexport const getSelectedNoteAnchor = (host: EditorHost, id: string) => {\n  return host.querySelector(`[data-portal-block-id=\"${id}\"] .note-background`);\n};\n\nexport function getCopilotSelectedElems(\n  host: EditorHost\n): BlockSuite.EdgelessModelType[] {\n  const service = getService(host);\n  const copilotWidget = getEdgelessCopilotWidget(host);\n\n  if (copilotWidget.visible) {\n    return (service.tool.controllers['copilot'] as CopilotSelectionController)\n      .selectedElements;\n  }\n\n  return service.selection.selectedElements;\n}\n\nexport const imageCustomInput = async (host: EditorHost) => {\n  const selectedElements = getCopilotSelectedElems(host);\n  if (selectedElements.length !== 1) return;\n\n  const imageBlock = selectedElements[0];\n  if (!(imageBlock instanceof ImageBlockModel)) return;\n  if (!imageBlock.sourceId) return;\n\n  const blob = await host.doc.blobSync.get(imageBlock.sourceId);\n  if (!blob) return;\n\n  return {\n    attachments: [blob],\n  };\n};\n"]}