{"version":3,"file":"markdown-utils.js","sourceRoot":"","sources":["../../../src/ai/utils/markdown-utils.ts"],"names":[],"mappings":"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","sourcesContent":["import type { TextSelection } from '@blocksuite/block-std';\nimport type { EditorHost, TextRangePoint } from '@blocksuite/block-std';\nimport {\n  defaultImageProxyMiddleware,\n  MarkdownAdapter,\n  MixTextAdapter,\n  pasteMiddleware,\n  PlainTextAdapter,\n  titleMiddleware,\n} from '@blocksuite/blocks';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type {\n  BlockModel,\n  BlockSnapshot,\n  Doc,\n  DraftModel,\n  SliceSnapshot,\n} from '@blocksuite/store';\nimport { DocCollection, Job, type Slice } from '@blocksuite/store';\n\nconst updateSnapshotText = (\n  point: TextRangePoint,\n  snapshot: BlockSnapshot,\n  model: DraftModel\n) => {\n  const { index, length } = point;\n  if (!snapshot.props.text || length === 0) {\n    return;\n  }\n  (snapshot.props.text as Record<string, unknown>).delta =\n    model.text?.sliceToDelta(index, length + index);\n};\n\nfunction processSnapshot(\n  snapshot: BlockSnapshot,\n  text: TextSelection,\n  host: EditorHost\n) {\n  const model = host.doc.getBlockById(snapshot.id);\n  assertExists(model);\n\n  const modelId = model.id;\n  if (text.from.blockId === modelId) {\n    updateSnapshotText(text.from, snapshot, model);\n  }\n  if (text.to && text.to.blockId === modelId) {\n    updateSnapshotText(text.to, snapshot, model);\n  }\n\n  // If the snapshot has children, handle them recursively\n  snapshot.children.forEach(childSnapshot =>\n    processSnapshot(childSnapshot, text, host)\n  );\n}\n\n/**\n * Processes the text in the given snapshot if there is a text selection.\n * Only the selected portion of the snapshot will be processed.\n */\nfunction processTextInSnapshot(snapshot: SliceSnapshot, host: EditorHost) {\n  const { content } = snapshot;\n  const text = host.selection.find('text');\n  if (!content.length || !text) return;\n\n  content.forEach(snapshot => processSnapshot(snapshot, text, host));\n}\n\nexport async function getContentFromSlice(\n  host: EditorHost,\n  slice: Slice,\n  type: 'markdown' | 'plain-text' = 'markdown'\n) {\n  const job = new Job({\n    collection: host.std.doc.collection,\n    middlewares: [titleMiddleware],\n  });\n  const snapshot = await job.sliceToSnapshot(slice);\n  processTextInSnapshot(snapshot, host);\n  const adapter =\n    type === 'markdown' ? new MarkdownAdapter(job) : new PlainTextAdapter(job);\n  const content = await adapter.fromSliceSnapshot({\n    snapshot,\n    assets: job.assetsManager,\n  });\n  return content.file;\n}\n\nexport async function getPlainTextFromSlice(host: EditorHost, slice: Slice) {\n  const job = new Job({\n    collection: host.std.doc.collection,\n    middlewares: [titleMiddleware],\n  });\n  const snapshot = await job.sliceToSnapshot(slice);\n  processTextInSnapshot(snapshot, host);\n  const plainTextAdapter = new PlainTextAdapter(job);\n  const plainText = await plainTextAdapter.fromSliceSnapshot({\n    snapshot,\n    assets: job.assetsManager,\n  });\n  return plainText.file;\n}\n\nexport const markdownToSnapshot = async (\n  markdown: string,\n  host: EditorHost\n) => {\n  const job = new Job({\n    collection: host.std.doc.collection,\n    middlewares: [defaultImageProxyMiddleware, pasteMiddleware(host.std)],\n  });\n  const markdownAdapter = new MixTextAdapter(job);\n  const { blockVersions, workspaceVersion, pageVersion } =\n    host.std.doc.collection.meta;\n  if (!blockVersions || !workspaceVersion || !pageVersion)\n    throw new Error(\n      'Need blockVersions, workspaceVersion, pageVersion meta information to get slice'\n    );\n  const payload = {\n    file: markdown,\n    assets: job.assetsManager,\n    blockVersions,\n    pageVersion,\n    workspaceVersion,\n    workspaceId: host.std.doc.collection.id,\n    pageId: host.std.doc.id,\n  };\n\n  const snapshot = await markdownAdapter.toSliceSnapshot(payload);\n  assertExists(snapshot, 'import markdown failed, expected to get a snapshot');\n\n  return {\n    snapshot,\n    job,\n  };\n};\n\nexport async function insertFromMarkdown(\n  host: EditorHost,\n  markdown: string,\n  parent?: string,\n  index?: number\n) {\n  const { snapshot, job } = await markdownToSnapshot(markdown, host);\n\n  const snapshots = snapshot.content.flatMap(x => x.children);\n\n  const models: BlockModel[] = [];\n  for (let i = 0; i < snapshots.length; i++) {\n    const blockSnapshot = snapshots[i];\n    const model = await job.snapshotToBlock(\n      blockSnapshot,\n      host.std.doc,\n      parent,\n      (index ?? 0) + i\n    );\n    models.push(model);\n  }\n\n  return models;\n}\n\n// FIXME: replace when selection is block is buggy right not\nexport async function replaceFromMarkdown(\n  host: EditorHost,\n  markdown: string,\n  parent?: string,\n  index?: number\n) {\n  const { snapshot, job } = await markdownToSnapshot(markdown, host);\n  await job.snapshotToSlice(snapshot, host.doc, parent, index);\n}\n\nexport async function markDownToDoc(host: EditorHost, answer: string) {\n  const schema = host.std.doc.collection.schema;\n  // Should not create a new doc in the original collection\n  const collection = new DocCollection({ schema });\n  collection.meta.initialize();\n  const job = new Job({\n    collection,\n    middlewares: [defaultImageProxyMiddleware],\n  });\n  const mdAdapter = new MarkdownAdapter(job);\n  const doc = await mdAdapter.toDoc({\n    file: answer,\n    assets: job.assetsManager,\n  });\n  if (!doc) {\n    console.error('Failed to convert markdown to doc');\n  }\n  return doc as Doc;\n}\n"]}