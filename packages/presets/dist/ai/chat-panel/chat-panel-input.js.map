{"version":3,"file":"chat-panel-input.js","sourceRoot":"","sources":["../../../src/ai/chat-panel/chat-panel-input.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport { WithDisposable } from '@blocksuite/block-std';\nimport { type AIError, openFileOrFiles } from '@blocksuite/blocks';\nimport { css, html, LitElement, nothing } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport {\n  ChatAbortIcon,\n  ChatClearIcon,\n  ChatSendIcon,\n  CloseIcon,\n  ImageIcon,\n} from '../_common/icons.js';\nimport { AIProvider } from '../provider.js';\nimport { reportResponse } from '../utils/action-reporter.js';\nimport { readBlobAsURL } from '../utils/image.js';\nimport type { ChatContextValue, ChatMessage } from './chat-context.js';\n\nconst MaximumImageCount = 8;\n\nfunction getFirstTwoLines(text: string) {\n  const lines = text.split('\\n');\n  return lines.slice(0, 2);\n}\n\n@customElement('chat-panel-input')\nexport class ChatPanelInput extends WithDisposable(LitElement) {\n  static override styles = css`\n    .chat-panel-input {\n      display: flex;\n      flex-direction: column;\n      justify-content: space-between;\n      gap: 12px;\n      position: relative;\n      margin-top: 12px;\n      border-radius: 4px;\n      padding: 8px;\n      min-height: 94px;\n      box-sizing: border-box;\n      border-width: 1px;\n      border-style: solid;\n\n      .chat-selection-quote {\n        padding: 4px 0px 8px 0px;\n        padding-left: 15px;\n        max-height: 56px;\n        font-size: 14px;\n        font-weight: 400;\n        line-height: 22px;\n        color: var(--affine-text-secondary-color);\n        position: relative;\n\n        div {\n          white-space: nowrap;\n          overflow: hidden;\n          text-overflow: ellipsis;\n        }\n\n        .chat-quote-close {\n          position: absolute;\n          right: 0;\n          top: 0;\n          cursor: pointer;\n          display: none;\n          width: 16px;\n          height: 16px;\n          border-radius: 4px;\n          border: 1px solid var(--affine-border-color);\n          background-color: var(--affine-white);\n        }\n      }\n\n      .chat-selection-quote:hover .chat-quote-close {\n        display: flex;\n        justify-content: center;\n        align-items: center;\n      }\n\n      .chat-selection-quote::after {\n        content: '';\n        width: 2px;\n        height: calc(100% - 10px);\n        margin-top: 5px;\n        position: absolute;\n        left: 0;\n        top: 0;\n        background: var(--affine-quote-color);\n        border-radius: 18px;\n      }\n    }\n\n    .chat-panel-input-actions {\n      display: flex;\n      gap: 8px;\n      align-items: center;\n\n      div {\n        width: 24px;\n        height: 24px;\n        cursor: pointer;\n      }\n\n      div:nth-child(2) {\n        margin-left: auto;\n      }\n\n      .chat-history-clear {\n        background-color: var(--affine-white);\n      }\n\n      .image-upload {\n        background-color: var(--affine-white);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n      }\n    }\n\n    .chat-panel-input {\n      textarea {\n        width: 100%;\n        padding: 0;\n        margin: 0;\n        border: none;\n        line-height: 22px;\n        font-size: var(--affine-font-sm);\n        font-weight: 400;\n        font-family: var(--affine-font-family);\n        color: var(--affine-text-primary-color);\n        box-sizing: border-box;\n        resize: none;\n        overflow-y: hidden;\n      }\n\n      textarea::placeholder {\n        font-size: 14px;\n        font-weight: 400;\n        font-family: var(--affine-font-family);\n        color: var(--affine-placeholder-color);\n      }\n\n      textarea:focus {\n        outline: none;\n      }\n    }\n\n    .chat-panel-images {\n      display: flex;\n      gap: 4px;\n      flex-wrap: wrap;\n      position: relative;\n\n      .image-container {\n        width: 58px;\n        height: 58px;\n        border-radius: 4px;\n        border: 1px solid var(--affine-border-color);\n        cursor: pointer;\n        overflow: hidden;\n        position: relative;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n\n        img {\n          max-width: 100%;\n          max-height: 100%;\n          width: auto;\n          height: auto;\n        }\n      }\n    }\n\n    .close-wrapper {\n      width: 16px;\n      height: 16px;\n      border-radius: 4px;\n      border: 1px solid var(--affine-border-color);\n      justify-content: center;\n      align-items: center;\n      display: none;\n      position: absolute;\n      background-color: var(--affine-white);\n      z-index: 1;\n      cursor: pointer;\n    }\n\n    .close-wrapper:hover {\n      background-color: var(--affine-background-error-color);\n      border: 1px solid var(--affine-error-color);\n    }\n\n    .close-wrapper:hover svg path {\n      fill: var(--affine-error-color);\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @query('.chat-panel-images')\n  accessor imagesWrapper!: HTMLDivElement;\n\n  @query('textarea')\n  accessor textarea!: HTMLTextAreaElement;\n\n  @query('.close-wrapper')\n  accessor closeWrapper!: HTMLDivElement;\n\n  @state()\n  accessor curIndex = -1;\n\n  @state()\n  accessor isInputEmpty = true;\n\n  @state()\n  accessor focused = false;\n\n  @property({ attribute: false })\n  accessor chatContextValue!: ChatContextValue;\n\n  @property({ attribute: false })\n  accessor updateContext!: (context: Partial<ChatContextValue>) => void;\n\n  @property({ attribute: false })\n  accessor cleanupHistories!: () => Promise<void>;\n\n  private _addImages(images: File[]) {\n    const oldImages = this.chatContextValue.images;\n    this.updateContext({\n      images: [...oldImages, ...images].slice(0, MaximumImageCount),\n    });\n  }\n\n  private _renderImages(images: File[]) {\n    return html`\n      <div\n        class=\"chat-panel-images\"\n        @mouseleave=${() => {\n          this.closeWrapper.style.display = 'none';\n          this.curIndex = -1;\n        }}\n      >\n        ${repeat(\n          images,\n          image => image.name,\n          (image, index) =>\n            html`<div\n              class=\"image-container\"\n              @mouseenter=${(evt: MouseEvent) => {\n                const ele = evt.target as HTMLImageElement;\n                const rect = ele.getBoundingClientRect();\n                const parentRect = ele.parentElement!.getBoundingClientRect();\n                const left = Math.abs(rect.right - parentRect.left) - 8;\n                const top = Math.abs(parentRect.top - rect.top) - 8;\n                this.curIndex = index;\n                this.closeWrapper.style.display = 'flex';\n                this.closeWrapper.style.left = left + 'px';\n                this.closeWrapper.style.top = top + 'px';\n              }}\n            >\n              <img src=\"${URL.createObjectURL(image)}\" alt=\"${image.name}\" />\n            </div>`\n        )}\n        <div\n          class=\"close-wrapper\"\n          @click=${() => {\n            if (this.curIndex >= 0 && this.curIndex < images.length) {\n              const newImages = [...images];\n              newImages.splice(this.curIndex, 1);\n              this.updateContext({ images: newImages });\n              this.curIndex = -1;\n              this.closeWrapper.style.display = 'none';\n            }\n          }}\n        >\n          ${CloseIcon}\n        </div>\n      </div>\n    `;\n  }\n\n  protected override render() {\n    const { images, status } = this.chatContextValue;\n    const hasImages = images.length > 0;\n    const maxHeight = hasImages ? 272 + 2 : 200 + 2;\n\n    return html`<style>\n        .chat-panel-send svg rect {\n          fill: ${this.isInputEmpty && hasImages\n            ? 'var(--affine-text-disable-color)'\n            : 'var(--affine-primary-color)'};\n        }\n\n        .chat-panel-input {\n          border-color: ${this.focused\n            ? 'var(--affine-primary-color)'\n            : 'var(--affine-border-color)'};\n          box-shadow: ${this.focused ? 'var(--affine-active-shadow)' : 'none'};\n          max-height: ${maxHeight}px !important;\n        }\n      </style>\n      <div class=\"chat-panel-input\">\n        ${hasImages ? this._renderImages(images) : nothing}\n        ${this.chatContextValue.quote\n          ? html`<div class=\"chat-selection-quote\">\n              ${repeat(\n                getFirstTwoLines(this.chatContextValue.quote),\n                line => line,\n                line => html`<div>${line}</div>`\n              )}\n              <div\n                class=\"chat-quote-close\"\n                @click=${() => {\n                  this.updateContext({ quote: '', markdown: '' });\n                }}\n              >\n                ${CloseIcon}\n              </div>\n            </div>`\n          : nothing}\n        <textarea\n          rows=\"1\"\n          placeholder=\"What are your thoughts?\"\n          @input=${() => {\n            const { textarea } = this;\n            this.isInputEmpty = !textarea.value.trim();\n            textarea.style.height = 'auto';\n            textarea.style.height = textarea.scrollHeight + 'px';\n            let imagesHeight = this.imagesWrapper?.scrollHeight ?? 0;\n            if (imagesHeight) imagesHeight += 12;\n            if (this.scrollHeight >= 200 + imagesHeight) {\n              textarea.style.height = '148px';\n              textarea.style.overflowY = 'scroll';\n            }\n          }}\n          @keydown=${async (evt: KeyboardEvent) => {\n            if (evt.key === 'Enter' && !evt.shiftKey && !evt.isComposing) {\n              evt.preventDefault();\n              await this.send();\n            }\n          }}\n          @focus=${() => {\n            this.focused = true;\n          }}\n          @blur=${() => {\n            this.focused = false;\n          }}\n          @paste=${(event: ClipboardEvent) => {\n            const items = event.clipboardData?.items;\n            if (!items) return;\n\n            for (const index in items) {\n              const item = items[index];\n              if (item.kind === 'file' && item.type.indexOf('image') >= 0) {\n                const blob = item.getAsFile();\n                if (!blob) continue;\n                this._addImages([blob]);\n              }\n            }\n          }}\n        ></textarea>\n        <div class=\"chat-panel-input-actions\">\n          <div\n            class=\"chat-history-clear\"\n            @click=${async () => {\n              await this.cleanupHistories();\n            }}\n          >\n            ${ChatClearIcon}\n          </div>\n          ${images.length < MaximumImageCount\n            ? html`<div\n                class=\"image-upload\"\n                @click=${async () => {\n                  const images = await openFileOrFiles({\n                    acceptType: 'Images',\n                    multiple: true,\n                  });\n                  if (!images) return;\n                  this._addImages(images);\n                }}\n              >\n                ${ImageIcon}\n              </div>`\n            : nothing}\n          ${status === 'transmitting'\n            ? html`<div\n                @click=${() => {\n                  this.chatContextValue.abortController?.abort();\n                  this.updateContext({ status: 'success' });\n                  reportResponse('aborted:stop');\n                }}\n              >\n                ${ChatAbortIcon}\n              </div>`\n            : html`<div @click=\"${this.send}\" class=\"chat-panel-send\">\n                ${ChatSendIcon}\n              </div>`}\n        </div>\n      </div>`;\n  }\n\n  send = async () => {\n    const { status, markdown } = this.chatContextValue;\n    if (status === 'loading' || status === 'transmitting') return;\n\n    const text = this.textarea.value;\n    const { images } = this.chatContextValue;\n    if (!text && images.length === 0) {\n      return;\n    }\n    const { doc } = this.host;\n    this.textarea.value = '';\n    this.isInputEmpty = true;\n    this.updateContext({\n      images: [],\n      status: 'loading',\n      error: null,\n      quote: '',\n      markdown: '',\n    });\n\n    const attachments = await Promise.all(\n      images?.map(image => readBlobAsURL(image))\n    );\n\n    const content = (markdown ? `${markdown}\\n` : '') + text;\n\n    this.updateContext({\n      items: [\n        ...this.chatContextValue.items,\n        {\n          role: 'user',\n          content: content,\n          createdAt: new Date().toISOString(),\n          attachments,\n        },\n        { role: 'assistant', content: '', createdAt: new Date().toISOString() },\n      ],\n    });\n\n    try {\n      const abortController = new AbortController();\n      const stream = AIProvider.actions.chat?.({\n        input: content,\n        docId: doc.id,\n        attachments: images,\n        workspaceId: doc.collection.id,\n        host: this.host,\n        stream: true,\n        signal: abortController.signal,\n        where: 'chat-panel',\n        control: 'chat-send',\n      });\n\n      if (stream) {\n        this.updateContext({ abortController });\n\n        for await (const text of stream) {\n          const items = [...this.chatContextValue.items];\n          const last = items[items.length - 1] as ChatMessage;\n          last.content += text;\n          this.updateContext({ items, status: 'transmitting' });\n        }\n\n        this.updateContext({ status: 'success' });\n      }\n    } catch (error) {\n      this.updateContext({ status: 'error', error: error as AIError });\n    } finally {\n      this.updateContext({ abortController: null });\n    }\n  };\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'chat-panel-input': ChatPanelInput;\n  }\n}\n"]}