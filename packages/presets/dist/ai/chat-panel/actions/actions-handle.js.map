{"version":3,"file":"actions-handle.js","sourceRoot":"","sources":["../../../../src/ai/chat-panel/actions/actions-handle.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  BlockSelection,\n  EditorHost,\n  TextSelection,\n} from '@blocksuite/block-std';\nimport type {\n  EdgelessRootService,\n  ImageSelection,\n  SerializedXYWH,\n} from '@blocksuite/blocks';\nimport {\n  BlocksUtils,\n  Bound,\n  getElementsBound,\n  NoteDisplayMode,\n} from '@blocksuite/blocks';\n\nimport {\n  CreateIcon,\n  InsertBelowIcon,\n  ReplaceIcon,\n} from '../../_common/icons.js';\nimport { reportResponse } from '../../utils/action-reporter.js';\nimport { insertBelow, replace } from '../../utils/editor-actions.js';\nimport { insertFromMarkdown } from '../../utils/markdown-utils.js';\n\nconst { matchFlavours } = BlocksUtils;\n\nconst CommonActions = [\n  {\n    icon: ReplaceIcon,\n    title: 'Replace selection',\n    handler: async (\n      host: EditorHost,\n      content: string,\n      currentTextSelection?: TextSelection,\n      currentBlockSelections?: BlockSelection[]\n    ) => {\n      const [_, data] = host.command\n        .chain()\n        .getSelectedBlocks({\n          currentTextSelection,\n          currentBlockSelections,\n        })\n        .run();\n      if (!data.selectedBlocks) return;\n\n      reportResponse('result:replace');\n\n      if (currentTextSelection) {\n        const { doc } = host;\n        const block = doc.getBlock(currentTextSelection.blockId);\n        if (matchFlavours(block?.model ?? null, ['affine:paragraph'])) {\n          block?.model.text?.replace(\n            currentTextSelection.from.index,\n            currentTextSelection.from.length,\n            content\n          );\n          return;\n        }\n      }\n\n      await replace(\n        host,\n        content,\n        data.selectedBlocks[0],\n        data.selectedBlocks.map(block => block.model),\n        currentTextSelection\n      );\n    },\n  },\n  {\n    icon: InsertBelowIcon,\n    title: 'Insert below',\n    handler: async (\n      host: EditorHost,\n      content: string,\n      currentTextSelection?: TextSelection,\n      currentBlockSelections?: BlockSelection[],\n      currentImageSelections?: ImageSelection[]\n    ) => {\n      const [_, data] = host.command\n        .chain()\n        .getSelectedBlocks({\n          currentTextSelection,\n          currentBlockSelections,\n          currentImageSelections,\n        })\n        .run();\n      if (!data.selectedBlocks) return;\n      reportResponse('result:insert');\n      await insertBelow(\n        host,\n        content,\n        data.selectedBlocks[data.selectedBlocks?.length - 1]\n      );\n    },\n  },\n];\n\nexport const PageEditorActions = [\n  ...CommonActions,\n  {\n    icon: CreateIcon,\n    title: 'Create as a doc',\n    handler: (host: EditorHost, content: string) => {\n      reportResponse('result:add-page');\n      const newDoc = host.doc.collection.createDoc();\n      newDoc.load();\n      const rootId = newDoc.addBlock('affine:page');\n      newDoc.addBlock('affine:surface', {}, rootId);\n      const noteId = newDoc.addBlock('affine:note', {}, rootId);\n\n      host.spec.getService('affine:page').slots.docLinkClicked.emit({\n        docId: newDoc.id,\n      });\n      let complete = false;\n      (function addContent() {\n        if (complete) return;\n        const newHost = document.querySelector('editor-host');\n        // FIXME: this is a hack to wait for the host to be ready, now we don't have a way to know if the new host is ready\n        if (!newHost || newHost === host) {\n          setTimeout(addContent, 100);\n          return;\n        }\n        complete = true;\n        insertFromMarkdown(newHost, content, noteId, 0).catch(console.error);\n      })();\n    },\n  },\n];\n\nexport const EdgelessEditorActions = [\n  ...CommonActions,\n  {\n    icon: CreateIcon,\n    title: 'Add to edgeless as note',\n    handler: async (host: EditorHost, content: string) => {\n      reportResponse('result:add-note');\n      const { doc } = host;\n      const service = host.spec.getService<EdgelessRootService>('affine:page');\n      const elements = service.selection.selectedElements;\n\n      const props: { displayMode: NoteDisplayMode; xywh?: SerializedXYWH } = {\n        displayMode: NoteDisplayMode.EdgelessOnly,\n      };\n\n      if (elements.length > 0) {\n        const bound = getElementsBound(\n          elements.map(e => Bound.deserialize(e.xywh))\n        );\n        const newBound = new Bound(bound.x, bound.maxY + 10, bound.w);\n        props.xywh = newBound.serialize();\n      }\n\n      const id = doc.addBlock('affine:note', props, doc.root?.id);\n\n      await insertFromMarkdown(host, content, id, 0);\n\n      service.selection.set({\n        elements: [id],\n        editing: false,\n      });\n    },\n  },\n];\n"]}