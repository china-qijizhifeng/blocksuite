{"version":3,"file":"copy-more.js","sourceRoot":"","sources":["../../../../src/ai/chat-panel/actions/copy-more.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  BlockSelection,\n  EditorHost,\n  TextSelection,\n} from '@blocksuite/block-std';\nimport { WithDisposable } from '@blocksuite/block-std';\nimport { type AIError, createButtonPopper, Tooltip } from '@blocksuite/blocks';\nimport { noop } from '@blocksuite/global/utils';\nimport { css, html, LitElement, nothing, type PropertyValues } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport { CopyIcon, MoreIcon, RetryIcon } from '../../_common/icons.js';\nimport { AIProvider } from '../../provider.js';\nimport { copyText } from '../../utils/editor-actions.js';\nimport type { ChatContextValue, ChatMessage } from '../chat-context.js';\nimport { PageEditorActions } from './actions-handle.js';\n\nnoop(Tooltip);\n\n@customElement('chat-copy-more')\nexport class ChatCopyMore extends WithDisposable(LitElement) {\n  static override styles = css`\n    .copy-more {\n      display: flex;\n      gap: 8px;\n      height: 36px;\n      justify-content: flex-end;\n      align-items: center;\n      margin-top: 8px;\n      margin-bottom: 12px;\n\n      div {\n        cursor: pointer;\n        border-radius: 4px;\n      }\n\n      div:hover {\n        background-color: var(--affine-hover-color);\n      }\n\n      svg {\n        color: var(--affine-icon-color);\n      }\n    }\n\n    .more-menu {\n      width: 226px;\n      border-radius: 8px;\n      background-color: var(--affine-background-overlay-panel-color);\n      box-shadow: var(--affine-menu-shadow);\n      display: flex;\n      flex-direction: column;\n      gap: 4px;\n      position: absolute;\n      z-index: 1;\n      user-select: none;\n\n      > div {\n        height: 30px;\n        display: flex;\n        gap: 8px;\n        align-items: center;\n        cursor: pointer;\n\n        svg {\n          margin-left: 12px;\n        }\n      }\n\n      > div:hover {\n        background-color: var(--affine-hover-color);\n      }\n    }\n  `;\n\n  @state()\n  private accessor _showMoreMenu = false;\n\n  @query('.more-button')\n  private accessor _moreButton!: HTMLDivElement;\n\n  @query('.more-menu')\n  private accessor _moreMenu!: HTMLDivElement;\n\n  private _morePopper: ReturnType<typeof createButtonPopper> | null = null;\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor content!: string;\n\n  @property({ attribute: false })\n  accessor isLast!: boolean;\n\n  @property({ attribute: false })\n  accessor curTextSelection: TextSelection | undefined = undefined;\n\n  @property({ attribute: false })\n  accessor curBlockSelections: BlockSelection[] | undefined = undefined;\n\n  @property({ attribute: false })\n  accessor chatContextValue!: ChatContextValue;\n\n  @property({ attribute: false })\n  accessor updateContext!: (context: Partial<ChatContextValue>) => void;\n\n  private _toggle() {\n    this._morePopper?.toggle();\n  }\n\n  private async _retry() {\n    const { doc } = this.host;\n    try {\n      const abortController = new AbortController();\n\n      const items = [...this.chatContextValue.items];\n      const last = items[items.length - 1];\n      if ('content' in last) {\n        last.content = '';\n        last.createdAt = new Date().toISOString();\n      }\n      this.updateContext({ items, status: 'loading', error: null });\n\n      const stream = AIProvider.actions.chat?.({\n        retry: true,\n        docId: doc.id,\n        workspaceId: doc.collection.id,\n        host: this.host,\n        stream: true,\n        signal: abortController.signal,\n        where: 'chat-panel',\n        control: 'chat-send',\n      });\n\n      if (stream) {\n        this.updateContext({ abortController });\n        for await (const text of stream) {\n          const items = [...this.chatContextValue.items];\n          const last = items[items.length - 1] as ChatMessage;\n          last.content += text;\n          this.updateContext({ items, status: 'transmitting' });\n        }\n\n        this.updateContext({ status: 'success' });\n      }\n    } catch (error) {\n      this.updateContext({ status: 'error', error: error as AIError });\n    } finally {\n      this.updateContext({ abortController: null });\n    }\n  }\n\n  protected override updated(changed: PropertyValues): void {\n    if (changed.has('isLast')) {\n      if (this.isLast) {\n        this._morePopper?.dispose();\n        this._morePopper = null;\n      } else if (!this._morePopper) {\n        this._morePopper = createButtonPopper(\n          this._moreButton,\n          this._moreMenu,\n          ({ display }) => (this._showMoreMenu = display === 'show')\n        );\n      }\n    }\n  }\n\n  override render() {\n    const { host, content, isLast } = this;\n    return html`<style>\n        .more-menu {\n          padding: ${this._showMoreMenu ? '8px' : '0px'};\n        }\n      </style>\n      <div class=\"copy-more\">\n        ${content\n          ? html`<div @click=${() => copyText(host, content)}>\n              ${CopyIcon}\n              <affine-tooltip>Copy</affine-tooltip>\n            </div>`\n          : nothing}\n        ${isLast\n          ? html`<div @click=${() => this._retry()}>\n              ${RetryIcon}\n              <affine-tooltip>Retry</affine-tooltip>\n            </div>`\n          : nothing}\n        ${isLast\n          ? nothing\n          : html`<div class=\"more-button\" @click=${this._toggle}>\n              ${MoreIcon}\n            </div> `}\n      </div>\n\n      <div class=\"more-menu\">\n        ${this._showMoreMenu\n          ? repeat(\n              PageEditorActions,\n              action => action.title,\n              action => {\n                return html`<div\n                  @click=${() =>\n                    action.handler(\n                      host,\n                      content,\n                      this.curTextSelection,\n                      this.curBlockSelections\n                    )}\n                >\n                  ${action.icon}\n                  <div>${action.title}</div>\n                </div>`;\n              }\n            )\n          : nothing}\n      </div>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'chat-copy-more': ChatCopyMore;\n  }\n}\n"]}