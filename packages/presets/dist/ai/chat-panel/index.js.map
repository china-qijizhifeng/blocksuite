{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/ai/chat-panel/index.ts"],"names":[],"mappings":"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","sourcesContent":["import './chat-panel-input.js';\nimport './chat-panel-messages.js';\n\nimport type { EditorHost } from '@blocksuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { debounce } from '@blocksuite/global/utils';\nimport type { Doc } from '@blocksuite/store';\nimport { css, html, type PropertyValues } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { createRef, type Ref, ref } from 'lit/directives/ref.js';\n\nimport { AIHelpIcon, SmallHintIcon } from '../_common/icons.js';\nimport { AIProvider } from '../provider.js';\nimport {\n  getSelectedImagesAsBlobs,\n  getSelectedTextContent,\n} from '../utils/selection-utils.js';\nimport type { ChatAction, ChatContextValue, ChatItem } from './chat-context.js';\nimport type { ChatPanelMessages } from './chat-panel-messages.js';\n\n@customElement('chat-panel')\nexport class ChatPanel extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    chat-panel {\n      width: 100%;\n    }\n\n    .chat-panel-container {\n      display: flex;\n      flex-direction: column;\n      padding: 0 12px;\n      height: 100%;\n    }\n\n    .chat-panel-title {\n      padding: 8px 0px;\n      width: 100%;\n      height: 36px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n\n      div:first-child {\n        font-size: 14px;\n        font-weight: 500;\n        color: var(--affine-text-secondary-color);\n      }\n\n      div:last-child {\n        width: 24px;\n        height: 24px;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        cursor: pointer;\n      }\n    }\n\n    chat-panel-messages {\n      flex: 1;\n      overflow-y: hidden;\n    }\n\n    .chat-panel-hints {\n      margin: 0 4px;\n      padding: 8px 12px;\n      border-radius: 8px;\n      border: 1px solid var(--affine-border-color);\n      font-size: 14px;\n      font-weight: 500;\n      cursor: pointer;\n    }\n\n    .chat-panel-hints :first-child {\n      color: var(--affine-text-primary-color);\n    }\n\n    .chat-panel-hints :nth-child(2) {\n      color: var(--affine-text-secondary-color);\n    }\n\n    .chat-panel-footer {\n      margin: 8px 0px;\n      height: 20px;\n      display: flex;\n      gap: 4px;\n      align-items: center;\n      color: var(--affine-text-secondary-color);\n      font-size: 12px;\n    }\n  `;\n\n  private _chatMessages: Ref<ChatPanelMessages> =\n    createRef<ChatPanelMessages>();\n\n  private _chatSessionId = '';\n\n  private _resettingCounter = 0;\n\n  private _resetItems = debounce(() => {\n    const counter = ++this._resettingCounter;\n    this.isLoading = true;\n    (async () => {\n      const { doc } = this;\n\n      const [histories, actions] = await Promise.all([\n        AIProvider.histories?.chats(doc.collection.id, doc.id),\n        AIProvider.histories?.actions(doc.collection.id, doc.id),\n      ]);\n\n      if (counter !== this._resettingCounter) return;\n\n      const items: ChatItem[] = actions ? [...actions] : [];\n\n      if (histories?.[0]) {\n        this._chatSessionId = histories[0].sessionId;\n        items.push(...histories[0].messages);\n      }\n\n      this.chatContextValue = {\n        ...this.chatContextValue,\n        items: items.sort((a, b) => {\n          return (\n            new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()\n          );\n        }),\n      };\n\n      this.isLoading = false;\n      this.scrollToDown();\n    })().catch(console.error);\n  }, 200);\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor doc!: Doc;\n\n  @state()\n  accessor isLoading = false;\n\n  @state()\n  accessor chatContextValue: ChatContextValue = {\n    quote: '',\n    images: [],\n    abortController: null,\n    items: [],\n    status: 'idle',\n    error: null,\n    markdown: '',\n  };\n\n  private _cleanupHistories = async () => {\n    const notification =\n      this.host.std.spec.getService('affine:page').notificationService;\n    if (!notification) return;\n\n    if (\n      await notification.confirm({\n        title: 'Clear History',\n        message:\n          'Are you sure you want to clear all history? This action will permanently delete all content, including all chat logs and data, and cannot be undone.',\n        confirmText: 'Confirm',\n        cancelText: 'Cancel',\n      })\n    ) {\n      await AIProvider.histories?.cleanup(this.doc.collection.id, this.doc.id, [\n        this._chatSessionId,\n        ...(\n          this.chatContextValue.items.filter(\n            item => 'sessionId' in item\n          ) as ChatAction[]\n        ).map(item => item.sessionId),\n      ]);\n      notification.toast('History cleared');\n      this._resetItems();\n    }\n  };\n\n  protected override updated(_changedProperties: PropertyValues) {\n    if (_changedProperties.has('doc')) {\n      this._resetItems();\n    }\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    if (!this.doc) throw new Error('doc is required');\n\n    AIProvider.slots.actions.on(({ action, event }) => {\n      const { status } = this.chatContextValue;\n      if (\n        action !== 'chat' &&\n        event === 'finished' &&\n        (status === 'idle' || status === 'success')\n      ) {\n        this._resetItems();\n      }\n    });\n\n    AIProvider.slots.userInfo.on(userInfo => {\n      if (userInfo) {\n        this._resetItems();\n      }\n    });\n\n    AIProvider.slots.requestContinueInChat.on(async ({ show }) => {\n      if (show) {\n        const text = await getSelectedTextContent(this.host, 'plain-text');\n        const markdown = await getSelectedTextContent(this.host, 'markdown');\n        const images = await getSelectedImagesAsBlobs(this.host);\n        this.updateContext({\n          quote: text,\n          markdown: markdown,\n          images: images,\n        });\n      }\n    });\n  }\n\n  updateContext = (context: Partial<ChatContextValue>) => {\n    this.chatContextValue = { ...this.chatContextValue, ...context };\n  };\n\n  continueInChat = async () => {\n    const text = await getSelectedTextContent(this.host, 'plain-text');\n    const markdown = await getSelectedTextContent(this.host, 'markdown');\n    const images = await getSelectedImagesAsBlobs(this.host);\n    this.updateContext({\n      quote: text,\n      markdown,\n      images,\n    });\n  };\n\n  scrollToDown() {\n    requestAnimationFrame(() => this._chatMessages.value?.scrollToDown());\n  }\n\n  override render() {\n    return html` <div class=\"chat-panel-container\">\n      <div class=\"chat-panel-title\">\n        <div>AFFINE AI</div>\n        <div\n          @click=${() => {\n            AIProvider.toggleGeneralAIOnboarding?.(true);\n          }}\n        >\n          ${AIHelpIcon}\n        </div>\n      </div>\n      <chat-panel-messages\n        ${ref(this._chatMessages)}\n        .chatContextValue=${this.chatContextValue}\n        .updateContext=${this.updateContext}\n        .host=${this.host}\n        .isLoading=${this.isLoading}\n      ></chat-panel-messages>\n      <chat-panel-input\n        .chatContextValue=${this.chatContextValue}\n        .updateContext=${this.updateContext}\n        .host=${this.host}\n        .cleanupHistories=${this._cleanupHistories}\n      ></chat-panel-input>\n      <div class=\"chat-panel-footer\">\n        ${SmallHintIcon}\n        <div>AI outputs can be misleading or wrong</div>\n      </div>\n    </div>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'chat-panel': ChatPanel;\n  }\n}\n"]}