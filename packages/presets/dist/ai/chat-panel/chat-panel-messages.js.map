{"version":3,"file":"chat-panel-messages.js","sourceRoot":"","sources":["../../../src/ai/chat-panel/chat-panel-messages.ts"],"names":[],"mappings":"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","sourcesContent":["import '../messages/slides-renderer.js';\nimport './ai-loading.js';\nimport '../messages/text.js';\nimport './actions/text.js';\nimport './actions/action-wrapper.js';\nimport './actions/make-real.js';\nimport './actions/slides.js';\nimport './actions/mindmap.js';\nimport './actions/chat-text.js';\nimport './actions/copy-more.js';\nimport './actions/image-to-text.js';\nimport './actions/image.js';\nimport './chat-cards.js';\n\nimport type {\n  BaseSelection,\n  BlockSelection,\n  TextSelection,\n} from '@blocksuite/block-std';\nimport type { EditorHost } from '@blocksuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport type { ImageSelection } from '@blocksuite/blocks';\nimport {\n  isInsidePageEditor,\n  PaymentRequiredError,\n  UnauthorizedError,\n} from '@blocksuite/blocks';\nimport { css, html, nothing, type PropertyValues } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport {\n  AffineAvatarIcon,\n  AffineIcon,\n  DownArrowIcon,\n} from '../_common/icons.js';\nimport {\n  GeneralErrorRenderer,\n  PaymentRequiredErrorRenderer,\n} from '../messages/error.js';\nimport { AIProvider } from '../provider.js';\nimport { insertBelow } from '../utils/editor-actions.js';\nimport {\n  EdgelessEditorActions,\n  PageEditorActions,\n} from './actions/actions-handle.js';\nimport type {\n  ChatContextValue,\n  ChatItem,\n  ChatMessage,\n} from './chat-context.js';\nimport { HISTORY_IMAGE_ACTIONS } from './const.js';\n\n@customElement('chat-panel-messages')\nexport class ChatPanelMessages extends WithDisposable(ShadowlessElement) {\n  private get _currentTextSelection(): TextSelection | undefined {\n    return this._selectionValue.find(v => v.type === 'text') as TextSelection;\n  }\n\n  private get _currentBlockSelections(): BlockSelection[] | undefined {\n    return this._selectionValue.filter(v => v.type === 'block');\n  }\n\n  private get _currentImageSelections(): ImageSelection[] | undefined {\n    return this._selectionValue.filter(v => v.type === 'image');\n  }\n\n  static override styles = css`\n    chat-panel-messages {\n      position: relative;\n    }\n\n    .chat-panel-messages {\n      display: flex;\n      flex-direction: column;\n      gap: 24px;\n      height: 100%;\n      position: relative;\n      overflow-y: auto;\n\n      chat-cards {\n        position: absolute;\n        bottom: 0;\n        width: 100%;\n      }\n    }\n\n    .chat-panel-messages-placeholder {\n      width: 100%;\n      position: absolute;\n      z-index: 1;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      gap: 12px;\n    }\n\n    .item-wrapper {\n      margin-left: 32px;\n    }\n\n    .user-info {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      margin-bottom: 4px;\n      color: var(--affine-text-primary-color);\n      font-size: 14px;\n      font-weight: 500;\n      user-select: none;\n    }\n\n    .avatar-container {\n      width: 24px;\n      height: 24px;\n    }\n\n    .avatar {\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      background-color: var(--affine-primary-color);\n    }\n\n    .avatar-container img {\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      object-fit: cover;\n    }\n\n    .down-indicator {\n      position: absolute;\n      left: 50%;\n      transform: translate(-50%, 0);\n      bottom: 24px;\n      z-index: 1;\n      border-radius: 50%;\n      width: 32px;\n      height: 32px;\n      border: 0.5px solid var(--affine-border-color);\n      background-color: var(--affine-background-primary-color);\n      box-shadow: var(--affine-shadow-2);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      cursor: pointer;\n    }\n  `;\n\n  private _selectionValue: BaseSelection[] = [];\n\n  @state()\n  accessor showDownIndicator = false;\n\n  @state()\n  accessor avatarUrl = '';\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor isLoading!: boolean;\n\n  @property({ attribute: false })\n  accessor chatContextValue!: ChatContextValue;\n\n  @property({ attribute: false })\n  accessor updateContext!: (context: Partial<ChatContextValue>) => void;\n\n  @query('.chat-panel-messages')\n  accessor messagesContainer!: HTMLDivElement;\n\n  protected override updated(_changedProperties: PropertyValues) {\n    if (_changedProperties.has('host')) {\n      const { disposables } = this;\n\n      disposables.add(\n        this.host.selection.slots.changed.on(() => {\n          this._selectionValue = this.host.selection.value;\n          this.requestUpdate();\n        })\n      );\n      const { docModeService } = this.host.spec.getService('affine:page');\n      disposables.add(docModeService.onModeChange(() => this.requestUpdate()));\n    }\n  }\n\n  protected override render() {\n    const { items } = this.chatContextValue;\n    const { isLoading } = this;\n    const filteredItems = items.filter(item => {\n      return (\n        'role' in item ||\n        item.messages?.length === 3 ||\n        (HISTORY_IMAGE_ACTIONS.includes(item.action) &&\n          item.messages?.length === 2)\n      );\n    });\n\n    return html`<style>\n        .chat-panel-messages-placeholder div {\n          color: ${isLoading\n            ? 'var(--affine-text-secondary-color)'\n            : 'var(--affine-text-primary-color)'};\n          font-size: ${isLoading ? 'var(--affine-font-sm)' : '18px'};\n          font-weight: 600;\n        }\n      </style>\n\n      <div\n        class=\"chat-panel-messages\"\n        @scroll=${(evt: Event) => {\n          const element = evt.target as HTMLDivElement;\n          this.showDownIndicator =\n            element.scrollHeight - element.scrollTop - element.clientHeight >\n            200;\n        }}\n      >\n        ${items.length === 0\n          ? html`<div class=\"chat-panel-messages-placeholder\">\n                ${AffineIcon(\n                  isLoading\n                    ? 'var(--affine-icon-secondary)'\n                    : 'var(--affine-primary-color)'\n                )}\n                <div>\n                  ${this.isLoading\n                    ? 'AFFiNE AI is loading history...'\n                    : 'What can I help you with?'}\n                </div>\n              </div>\n              <chat-cards\n                .chatContextValue=${this.chatContextValue}\n                .updateContext=${this.updateContext}\n                .host=${this.host}\n                .selectionValue=${this._selectionValue}\n              ></chat-cards> `\n          : repeat(filteredItems, (item, index) => {\n              const isLast = index === filteredItems.length - 1;\n              return html`<div class=\"message\">\n                ${this.renderAvatar(item)}\n                <div class=\"item-wrapper\">${this.renderItem(item, isLast)}</div>\n              </div>`;\n            })}\n      </div>\n      ${this.showDownIndicator\n        ? html`<div class=\"down-indicator\" @click=${() => this.scrollToDown()}>\n            ${DownArrowIcon}\n          </div>`\n        : nothing} `;\n  }\n\n  override async connectedCallback() {\n    super.connectedCallback();\n\n    const res = await AIProvider.userInfo;\n    this.avatarUrl = res?.avatarUrl ?? '';\n    this.disposables.add(\n      AIProvider.slots.userInfo.on(userInfo => {\n        const { status, error } = this.chatContextValue;\n        this.avatarUrl = userInfo?.avatarUrl ?? '';\n        if (\n          status === 'error' &&\n          error instanceof UnauthorizedError &&\n          userInfo\n        ) {\n          this.updateContext({ status: 'idle', error: null });\n        }\n      })\n    );\n  }\n\n  renderError() {\n    const { error } = this.chatContextValue;\n\n    if (error instanceof PaymentRequiredError) {\n      return PaymentRequiredErrorRenderer(this.host);\n    } else if (error instanceof UnauthorizedError) {\n      return GeneralErrorRenderer(\n        html`You need to login to AFFiNE Cloud to continue using AFFiNE AI.`,\n        html`<div\n          style=${styleMap({\n            padding: '4px 12px',\n            borderRadius: '8px',\n            border: '1px solid var(--affine-border-color)',\n            cursor: 'pointer',\n            backgroundColor: 'var(--affine-hover-color)',\n          })}\n          @click=${() =>\n            AIProvider.slots.requestLogin.emit({ host: this.host })}\n        >\n          Login\n        </div>`\n      );\n    } else {\n      return GeneralErrorRenderer();\n    }\n  }\n\n  renderItem(item: ChatItem, isLast: boolean) {\n    const { status, error } = this.chatContextValue;\n\n    if (isLast && status === 'loading') {\n      return this.renderLoading();\n    }\n\n    if (\n      isLast &&\n      status === 'error' &&\n      (error instanceof PaymentRequiredError ||\n        error instanceof UnauthorizedError)\n    ) {\n      return this.renderError();\n    }\n\n    if ('role' in item) {\n      const state = isLast\n        ? status !== 'loading' && status !== 'transmitting'\n          ? 'finished'\n          : 'generating'\n        : 'finished';\n      return html`<chat-text\n          .host=${this.host}\n          .attachments=${item.attachments}\n          .text=${item.content}\n          .state=${state}\n        ></chat-text>\n        ${isLast && status === 'error' ? this.renderError() : nothing}\n        ${this.renderEditorActions(item, isLast)}`;\n    } else {\n      switch (item.action) {\n        case 'Create a presentation':\n          return html`<action-slides\n            .host=${this.host}\n            .item=${item}\n          ></action-slides>`;\n        case 'Make it real':\n          return html`<action-make-real\n            .host=${this.host}\n            .item=${item}\n          ></action-make-real>`;\n        case 'Brainstorm mindmap':\n          return html`<action-mindmap\n            .host=${this.host}\n            .item=${item}\n          ></action-mindmap>`;\n        case 'Explain this image':\n        case 'Generate a caption':\n          return html`<action-image-to-text\n            .host=${this.host}\n            .item=${item}\n          ></action-image-to-text>`;\n        default:\n          if (HISTORY_IMAGE_ACTIONS.includes(item.action)) {\n            return html`<action-image\n              .host=${this.host}\n              .item=${item}\n            ></action-image>`;\n          }\n\n          return html`<action-text\n            .item=${item}\n            .host=${this.host}\n            .isCode=${item.action === 'Explain this code' ||\n            item.action === 'Check code error'}\n          ></action-text>`;\n      }\n    }\n  }\n\n  renderAvatar(item: ChatItem) {\n    const isUser = 'role' in item && item.role === 'user';\n\n    return html`<div class=\"user-info\">\n      ${isUser\n        ? html`<div class=\"avatar-container\">\n            ${this.avatarUrl\n              ? html`<img .src=${this.avatarUrl} />`\n              : html`<div class=\"avatar\"></div>`}\n          </div>`\n        : AffineAvatarIcon}\n      ${isUser ? 'You' : 'AFFINE AI'}\n    </div>`;\n  }\n\n  renderLoading() {\n    return html` <ai-loading></ai-loading>`;\n  }\n\n  scrollToDown() {\n    this.messagesContainer.scrollTo(0, this.messagesContainer.scrollHeight);\n  }\n\n  renderEditorActions(item: ChatMessage, isLast: boolean) {\n    const { status } = this.chatContextValue;\n\n    if (item.role !== 'assistant') return nothing;\n\n    if (\n      isLast &&\n      status !== 'success' &&\n      status !== 'idle' &&\n      status !== 'error'\n    )\n      return nothing;\n\n    const { host } = this;\n    const { content } = item;\n    const actions = isInsidePageEditor(host)\n      ? PageEditorActions\n      : EdgelessEditorActions;\n\n    return html`\n      <style>\n        .actions-container {\n          display: flex;\n          flex-direction: column;\n          align-items: flex-end;\n          gap: 8px;\n          margin-top: 8px;\n        }\n\n        .actions-container > div {\n          display: flex;\n          gap: 8px;\n        }\n\n        .action {\n          width: fit-content;\n          height: 32px;\n          padding: 12px;\n          border-radius: 8px;\n          border: 1px solid var(--affine-border-color);\n          background-color: var(--affine-white-10);\n          display: flex;\n          flex-direction: row;\n          align-items: center;\n          gap: 4px;\n          font-size: 15px;\n          font-weight: 500;\n          color: var(--affine-text-primary-color);\n          cursor: pointer;\n          user-select: none;\n        }\n\n        .action svg {\n          color: var(--affine-icon-color);\n        }\n      </style>\n      <chat-copy-more\n        .host=${host}\n        .content=${content}\n        .isLast=${isLast}\n        .curTextSelection=${this._currentTextSelection}\n        .curBlockSelections=${this._currentBlockSelections}\n        .chatContextValue=${this.chatContextValue}\n        .updateContext=${this.updateContext}\n      ></chat-copy-more>\n      ${isLast\n        ? html`<div class=\"actions-container\">\n            ${repeat(\n              actions.filter(action => {\n                if (!content) return false;\n\n                if (action.title === 'Replace selection') {\n                  if (\n                    (!this._currentTextSelection ||\n                      this._currentTextSelection.from.length === 0) &&\n                    this._currentBlockSelections?.length === 0\n                  ) {\n                    return false;\n                  }\n                }\n                return true;\n              }),\n              action => action.title,\n              action => {\n                return html`<div class=\"action\">\n                  ${action.icon}\n                  <div\n                    @click=${async () => {\n                      if (action.title === 'Insert below') {\n                        if (\n                          this._selectionValue.length === 1 &&\n                          this._selectionValue[0].type === 'database'\n                        ) {\n                          const element = this.host.view.getBlock(\n                            this._selectionValue[0].blockId\n                          );\n                          if (!element) return;\n                          await insertBelow(host, content, element);\n                          return;\n                        }\n                      }\n\n                      await action.handler(\n                        host,\n                        content,\n                        this._currentTextSelection,\n                        this._currentBlockSelections,\n                        this._currentImageSelections\n                      );\n                    }}\n                  >\n                    ${action.title}\n                  </div>\n                </div>`;\n              }\n            )}\n          </div>`\n        : nothing}\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'chat-panel-messages': ChatPanelMessages;\n  }\n}\n"]}