{"version":3,"file":"chat-cards.js","sourceRoot":"","sources":["../../../src/ai/chat-panel/chat-cards.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BaseSelection, EditorHost } from '@blocksuite/block-std';\nimport { WithDisposable } from '@blocksuite/block-std';\nimport type { CopilotSelectionController } from '@blocksuite/blocks';\nimport {\n  type ImageBlockModel,\n  type NoteBlockModel,\n  NoteDisplayMode,\n} from '@blocksuite/blocks';\nimport { debounce } from '@blocksuite/global/utils';\nimport type { BlockModel } from '@blocksuite/store';\nimport { css, html, LitElement, nothing, type PropertyValues } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport {\n  CurrentSelectionIcon,\n  DocIcon,\n  SmallImageIcon,\n} from '../_common/icons.js';\nimport {\n  getEdgelessRootFromEditor,\n  getSelectedImagesAsBlobs,\n  getSelectedTextContent,\n  getTextContentFromBlockModels,\n  selectedToCanvas,\n} from '../utils/selection-utils.js';\nimport type { ChatContextValue } from './chat-context.js';\n\nconst cardsStyles = css`\n  .card-wrapper {\n    width: 90%;\n    max-height: 76px;\n    border-radius: 8px;\n    border: 1px solid var(--affine-border-color);\n    padding: 4px 12px;\n    cursor: pointer;\n\n    .card-title {\n      display: flex;\n      gap: 4px;\n      height: 22px;\n      margin-bottom: 2px;\n      font-weight: 500;\n      font-size: 14px;\n      color: var(--affine-text-primary-color);\n    }\n\n    .second-text {\n      font-size: 14px;\n      font-weight: 400;\n      color: var(--affine-text-secondary-color);\n    }\n  }\n`;\n\nconst ChatCardsConfig = [\n  {\n    name: 'current-selection',\n    render: (text?: string, _?: File, __?: string) => {\n      if (!text) return nothing;\n\n      const lines = text.split('\\n');\n\n      return html`<div class=\"card-wrapper\">\n        <div class=\"card-title\">\n          ${CurrentSelectionIcon}\n          <div>Start with current selection</div>\n        </div>\n        <div class=\"second-text\">\n          ${repeat(\n            lines.slice(0, 2),\n            line => line,\n            line => {\n              return html`<div\n                style=${styleMap({\n                  overflow: 'hidden',\n                  textOverflow: 'ellipsis',\n                  whiteSpace: 'nowrap',\n                })}\n              >\n                ${line}\n              </div>`;\n            }\n          )}\n        </div>\n      </div> `;\n    },\n    handler: (\n      updateContext: (context: Partial<ChatContextValue>) => void,\n      text: string,\n      markdown: string,\n      images?: File[]\n    ) => {\n      const value: Partial<ChatContextValue> = {\n        quote: text,\n        markdown: markdown,\n      };\n      if (images) {\n        value.images = images;\n      }\n      updateContext(value);\n    },\n  },\n  {\n    name: 'image',\n    render: (_?: string, image?: File, caption?: string) => {\n      if (!image) return nothing;\n\n      return html`<div\n        class=\"card-wrapper\"\n        style=${styleMap({\n          display: 'flex',\n          gap: '8px',\n          justifyContent: 'space-between',\n        })}\n      >\n        <div\n          style=${styleMap({\n            display: 'flex',\n            flexDirection: 'column',\n          })}\n        >\n          <div class=\"card-title\">\n            ${SmallImageIcon}\n            <div>Start with this Image</div>\n          </div>\n          <div class=\"second-text\">${caption ? caption : 'caption'}</div>\n        </div>\n        <img\n          style=${styleMap({\n            maxWidth: '72px',\n            maxHeight: '46px',\n          })}\n          src=\"${URL.createObjectURL(image)}\"\n        />\n      </div>`;\n    },\n    handler: (\n      updateContext: (context: Partial<ChatContextValue>) => void,\n      _: string,\n      __: string,\n      images?: File[]\n    ) => {\n      const value: Partial<ChatContextValue> = {};\n      if (images) {\n        value.images = images;\n      }\n      updateContext(value);\n    },\n  },\n  {\n    name: 'doc',\n    render: () => {\n      return html`\n        <div class=\"card-wrapper\">\n          <div class=\"card-title\">\n            ${DocIcon}\n            <div>Start with this doc</div>\n          </div>\n          <div class=\"second-text\">you've chosen within the doc</div>\n        </div>\n      `;\n    },\n    handler: (\n      updateContext: (context: Partial<ChatContextValue>) => void,\n      text: string,\n      markdown: string,\n      images?: File[]\n    ) => {\n      const value: Partial<ChatContextValue> = {\n        quote: text,\n        markdown: markdown,\n      };\n      if (images) {\n        value.images = images;\n      }\n      updateContext(value);\n    },\n  },\n];\n\n@customElement('chat-cards')\nexport class ChatCards extends WithDisposable(LitElement) {\n  static override styles = css`\n    ${cardsStyles}\n    .cards-container {\n      display: flex;\n      flex-direction: column;\n      gap: 12px;\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor chatContextValue!: ChatContextValue;\n\n  @property({ attribute: false })\n  accessor updateContext!: (context: Partial<ChatContextValue>) => void;\n\n  @property({ attribute: false })\n  accessor selectionValue: BaseSelection[] = [];\n\n  @state()\n  accessor text: string = '';\n\n  @state()\n  accessor markdown: string = '';\n\n  @state()\n  accessor images: File[] = [];\n\n  @state()\n  accessor caption: string = '';\n\n  private _onEdgelessCopilotAreaUpdated() {\n    if (!this.host.closest('edgeless-editor')) return;\n    const edgeless = getEdgelessRootFromEditor(this.host);\n\n    const copilotSelectionTool = edgeless.tools.controllers\n      .copilot as CopilotSelectionController;\n\n    this._disposables.add(\n      copilotSelectionTool.draggingAreaUpdated.on(\n        debounce(() => {\n          selectedToCanvas(this.host)\n            .then(canvas => {\n              canvas?.toBlob(blob => {\n                if (!blob) return;\n                const file = new File([blob], 'selected.png');\n                this.images = [file];\n              });\n            })\n            .catch(console.error);\n        }, 300)\n      )\n    );\n  }\n\n  private async _updateState() {\n    if (\n      this.selectionValue.some(\n        selection => selection.is('text') || selection.is('image')\n      )\n    )\n      return;\n    this.text = await getSelectedTextContent(this.host, 'plain-text');\n    this.markdown = await getSelectedTextContent(this.host, 'markdown');\n    this.images = await getSelectedImagesAsBlobs(this.host);\n    const [_, data] = this.host.command\n      .chain()\n      .tryAll(chain => [\n        chain.getTextSelection(),\n        chain.getBlockSelections(),\n        chain.getImageSelections(),\n      ])\n      .getSelectedBlocks({\n        types: ['image'],\n      })\n      .run();\n    if (data.currentBlockSelections?.[0]) {\n      this.caption =\n        (\n          this.host.doc.getBlock(data.currentBlockSelections[0].blockId)\n            ?.model as ImageBlockModel\n        ).caption ?? '';\n    }\n  }\n\n  private async _handleDocSelection() {\n    const notes = this.host.doc\n      .getBlocksByFlavour('affine:note')\n      .filter(\n        note =>\n          (note.model as NoteBlockModel).displayMode !==\n          NoteDisplayMode.EdgelessOnly\n      )\n      .map(note => note.model as NoteBlockModel);\n    const selectedModels = notes.reduce((acc, note) => {\n      acc.push(...note.children);\n      return acc;\n    }, [] as BlockModel[]);\n    const text = await getTextContentFromBlockModels(\n      this.host,\n      selectedModels,\n      'plain-text'\n    );\n    const markdown = await getTextContentFromBlockModels(\n      this.host,\n      selectedModels,\n      'markdown'\n    );\n    const blobs = await Promise.all(\n      selectedModels.map(async s => {\n        if (s.flavour !== 'affine:image') return null;\n        const sourceId = (s as ImageBlockModel)?.sourceId;\n        if (!sourceId) return null;\n        const blob = await (sourceId\n          ? this.host.doc.blobSync.get(sourceId)\n          : null);\n        if (!blob) return null;\n        return new File([blob], sourceId);\n      }) ?? []\n    );\n    const images = blobs.filter((blob): blob is File => !!blob);\n    this.text = text;\n    this.markdown = markdown;\n    this.images = images;\n  }\n\n  protected override async updated(_changedProperties: PropertyValues) {\n    if (_changedProperties.has('selectionValue')) {\n      await this._updateState();\n    }\n\n    if (_changedProperties.has('host')) {\n      this._onEdgelessCopilotAreaUpdated();\n    }\n  }\n\n  protected override render() {\n    return html`<div class=\"cards-container\">\n      ${repeat(\n        ChatCardsConfig,\n        card => card.name,\n        card => {\n          if (\n            card.render(this.text, this.images[0], this.caption) !== nothing\n          ) {\n            return html`<div\n              @click=${async () => {\n                if (card.name === 'doc') {\n                  await this._handleDocSelection();\n                }\n                card.handler(\n                  this.updateContext,\n                  this.text,\n                  this.markdown,\n                  this.images\n                );\n              }}\n            >\n              ${card.render(this.text, this.images[0], this.caption)}\n            </div> `;\n          }\n          return nothing;\n        }\n      )}\n    </div>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'chat-cards': ChatCards;\n  }\n}\n"]}