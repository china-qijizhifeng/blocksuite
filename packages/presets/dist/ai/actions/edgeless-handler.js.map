{"version":3,"file":"edgeless-handler.js","sourceRoot":"","sources":["../../../src/ai/actions/edgeless-handler.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport type {\n  AffineAIPanelWidget,\n  AIError,\n  EdgelessCopilotWidget,\n  MindmapElementModel,\n} from '@blocksuite/blocks';\nimport {\n  BlocksUtils,\n  EdgelessTextBlockModel,\n  ImageBlockModel,\n  NoteBlockModel,\n  ShapeElementModel,\n  TextElementModel,\n} from '@blocksuite/blocks';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { Slice } from '@blocksuite/store';\nimport type { TemplateResult } from 'lit';\n\nimport { getAIPanel } from '../ai-panel.js';\nimport {\n  createMindmapExecuteRenderer,\n  createMindmapRenderer,\n} from '../messages/mindmap.js';\nimport { createSlidesRenderer } from '../messages/slides-renderer.js';\nimport { createTextRenderer } from '../messages/text.js';\nimport {\n  createIframeRenderer,\n  createImageRenderer,\n} from '../messages/wrapper.js';\nimport { AIProvider } from '../provider.js';\nimport { reportResponse } from '../utils/action-reporter.js';\nimport {\n  getEdgelessCopilotWidget,\n  isMindmapChild,\n  isMindMapRoot,\n} from '../utils/edgeless.js';\nimport { copyTextAnswer } from '../utils/editor-actions.js';\nimport { getContentFromSlice } from '../utils/markdown-utils.js';\nimport {\n  getCopilotSelectedElems,\n  getSelectedNoteAnchor,\n  getSelections,\n} from '../utils/selection-utils.js';\nimport { EXCLUDING_COPY_ACTIONS, IMAGE_ACTIONS } from './consts.js';\nimport { bindTextStream } from './doc-handler.js';\nimport {\n  actionToErrorResponse,\n  actionToGenerating,\n  actionToResponse,\n  getElementToolbar,\n  responses,\n} from './edgeless-response.js';\nimport type { CtxRecord } from './types.js';\n\ntype AnswerRenderer = NonNullable<\n  AffineAIPanelWidget['config']\n>['answerRenderer'];\n\nfunction actionToRenderer<T extends keyof BlockSuitePresets.AIActions>(\n  id: T,\n  host: EditorHost,\n  ctx: CtxRecord\n): AnswerRenderer {\n  if (id === 'brainstormMindmap') {\n    const selectedElements = ctx.get()[\n      'selectedElements'\n    ] as BlockSuite.EdgelessModelType[];\n\n    if (\n      isMindMapRoot(selectedElements[0] || isMindmapChild(selectedElements[0]))\n    ) {\n      const mindmap = selectedElements[0].group as MindmapElementModel;\n\n      return createMindmapRenderer(host, ctx, mindmap.style);\n    }\n\n    return createMindmapRenderer(host, ctx);\n  }\n\n  if (id === 'expandMindmap') {\n    return createMindmapExecuteRenderer(host, ctx, ctx => {\n      responses['expandMindmap']?.(host, ctx);\n    });\n  }\n\n  if (id === 'createSlides') {\n    return createSlidesRenderer(host, ctx);\n  }\n\n  if (id === 'makeItReal') {\n    return createIframeRenderer(host, { height: 300 });\n  }\n\n  if (IMAGE_ACTIONS.includes(id)) {\n    return createImageRenderer(host, { height: 300 });\n  }\n\n  return createTextRenderer(host, { maxHeight: 320 });\n}\n\nasync function getContentFromHubBlockModel(\n  host: EditorHost,\n  models: EdgelessTextBlockModel[] | NoteBlockModel[]\n) {\n  return (\n    await Promise.all(\n      models.map(model => {\n        const slice = Slice.fromModels(host.doc, model.children);\n        return getContentFromSlice(host, slice);\n      })\n    )\n  )\n    .map(content => content.trim())\n    .filter(content => content.length);\n}\n\nexport async function getContentFromSelected(\n  host: EditorHost,\n  selected: BlockSuite.EdgelessModelType[]\n) {\n  const { notes, texts, shapes, images, edgelessTexts } = selected.reduce<{\n    notes: NoteBlockModel[];\n    texts: TextElementModel[];\n    shapes: ShapeElementModel[];\n    images: ImageBlockModel[];\n    edgelessTexts: EdgelessTextBlockModel[];\n  }>(\n    (pre, cur) => {\n      if (cur instanceof NoteBlockModel) {\n        pre.notes.push(cur);\n      } else if (cur instanceof TextElementModel) {\n        pre.texts.push(cur);\n      } else if (cur instanceof ShapeElementModel && cur.text?.length) {\n        pre.shapes.push(cur);\n      } else if (cur instanceof ImageBlockModel && cur.caption?.length) {\n        pre.images.push(cur);\n      } else if (cur instanceof EdgelessTextBlockModel) {\n        pre.edgelessTexts.push(cur);\n      }\n\n      return pre;\n    },\n    { notes: [], texts: [], shapes: [], images: [], edgelessTexts: [] }\n  );\n\n  const noteContent = await getContentFromHubBlockModel(host, notes);\n  const edgelessTextContent = await getContentFromHubBlockModel(\n    host,\n    edgelessTexts\n  );\n\n  return `${noteContent.join('\\n')}\n  ${edgelessTextContent.join('\\n')}\n${texts.map(text => text.text.toString()).join('\\n')}\n${shapes.map(shape => shape.text!.toString()).join('\\n')}\n${images.map(image => image.caption!.toString()).join('\\n')}\n`.trim();\n}\n\nfunction getTextFromSelected(host: EditorHost) {\n  const selected = getCopilotSelectedElems(host);\n  return getContentFromSelected(host, selected);\n}\n\nfunction actionToStream<T extends keyof BlockSuitePresets.AIActions>(\n  id: T,\n  signal?: AbortSignal,\n  variants?: Omit<\n    Parameters<BlockSuitePresets.AIActions[T]>[0],\n    keyof BlockSuitePresets.AITextActionOptions\n  >,\n  extract?: (\n    host: EditorHost,\n    ctx: CtxRecord\n  ) => Promise<{\n    content?: string;\n    attachments?: (string | Blob)[];\n    seed?: string;\n  } | void>,\n  trackerOptions?: BlockSuitePresets.TrackerOptions\n) {\n  const action = AIProvider.actions[id];\n\n  if (!action || typeof action !== 'function') return;\n\n  if (extract && typeof extract === 'function') {\n    return (host: EditorHost, ctx: CtxRecord): BlockSuitePresets.TextStream => {\n      let stream: BlockSuitePresets.TextStream | undefined;\n      const control = trackerOptions?.control || 'format-bar';\n      const where = trackerOptions?.where || 'ai-panel';\n      return {\n        async *[Symbol.asyncIterator]() {\n          const models = getCopilotSelectedElems(host);\n          const options = {\n            ...variants,\n            signal,\n            input: '',\n            stream: true,\n            control,\n            where,\n            models,\n            host,\n            docId: host.doc.id,\n            workspaceId: host.doc.collection.id,\n          } as Parameters<typeof action>[0];\n\n          const data = await extract(host, ctx);\n          if (data) {\n            Object.assign(options, data);\n          }\n\n          // @ts-expect-error todo: maybe fix this\n          stream = action(options);\n          if (!stream) return;\n          yield* stream;\n        },\n      };\n    };\n  }\n\n  return (host: EditorHost): BlockSuitePresets.TextStream => {\n    let stream: BlockSuitePresets.TextStream | undefined;\n    return {\n      async *[Symbol.asyncIterator]() {\n        const panel = getAIPanel(host);\n        const models = getCopilotSelectedElems(host);\n        const markdown = await getTextFromSelected(panel.host);\n\n        const options = {\n          ...variants,\n          signal,\n          input: markdown,\n          stream: true,\n          where: 'ai-panel',\n          models,\n          control: 'format-bar',\n          host,\n          docId: host.doc.id,\n          workspaceId: host.doc.collection.id,\n        } as Parameters<typeof action>[0];\n\n        // @ts-expect-error todo: maybe fix this\n        stream = action(options);\n        if (!stream) return;\n        yield* stream;\n      },\n    };\n  };\n}\n\nfunction actionToGeneration<T extends keyof BlockSuitePresets.AIActions>(\n  id: T,\n  variants?: Omit<\n    Parameters<BlockSuitePresets.AIActions[T]>[0],\n    keyof BlockSuitePresets.AITextActionOptions\n  >,\n  extract?: (\n    host: EditorHost,\n    ctx: CtxRecord\n  ) => Promise<{\n    content?: string;\n    attachments?: (string | Blob)[];\n    seed?: string;\n  } | void>,\n  trackerOptions?: BlockSuitePresets.TrackerOptions\n) {\n  return (host: EditorHost, ctx: CtxRecord) => {\n    return ({\n      signal,\n      update,\n      finish,\n    }: {\n      input: string;\n      signal?: AbortSignal;\n      update: (text: string) => void;\n      finish: (state: 'success' | 'error' | 'aborted', err?: AIError) => void;\n    }) => {\n      if (!extract) {\n        const selectedElements = getCopilotSelectedElems(host);\n        if (selectedElements.length === 0) return;\n      }\n\n      const stream = actionToStream(\n        id,\n        signal,\n        variants,\n        extract,\n        trackerOptions\n      )?.(host, ctx);\n\n      if (!stream) return;\n\n      bindTextStream(stream, { update, finish, signal });\n    };\n  };\n}\n\nfunction updateEdgelessAIPanelConfig<\n  T extends keyof BlockSuitePresets.AIActions,\n>(\n  aiPanel: AffineAIPanelWidget,\n  edgelessCopilot: EdgelessCopilotWidget,\n  id: T,\n  generatingIcon: TemplateResult<1>,\n  ctx: CtxRecord,\n  variants?: Omit<\n    Parameters<BlockSuitePresets.AIActions[T]>[0],\n    keyof BlockSuitePresets.AITextActionOptions\n  >,\n  customInput?: (\n    host: EditorHost,\n    ctx: CtxRecord\n  ) => Promise<{\n    input?: string;\n    content?: string;\n    attachments?: (string | Blob)[];\n    seed?: string;\n  } | void>,\n  trackerOptions?: BlockSuitePresets.TrackerOptions\n) {\n  const host = aiPanel.host;\n  const { config } = aiPanel;\n  assertExists(config);\n  config.answerRenderer = actionToRenderer(id, host, ctx);\n  config.generateAnswer = actionToGeneration(\n    id,\n    variants,\n    customInput,\n    trackerOptions\n  )(host, ctx);\n  config.finishStateConfig = actionToResponse(id, host, ctx, variants);\n  config.generatingStateConfig = actionToGenerating(id, generatingIcon);\n  config.errorStateConfig = actionToErrorResponse(\n    aiPanel,\n    id,\n    host,\n    ctx,\n    variants\n  );\n  config.copy = {\n    allowed: !EXCLUDING_COPY_ACTIONS.includes(id),\n    onCopy: () => {\n      return copyTextAnswer(aiPanel);\n    },\n  };\n  config.discardCallback = () => {\n    reportResponse('result:discard');\n  };\n  config.hideCallback = () => {\n    aiPanel.updateComplete\n      .finally(() => {\n        edgelessCopilot.edgeless.service.tool.switchToDefaultMode({\n          elements: [],\n          editing: false,\n        });\n        host.selection.clear();\n        edgelessCopilot.lockToolbar(false);\n      })\n      .catch(console.error);\n  };\n}\n\nexport function actionToHandler<T extends keyof BlockSuitePresets.AIActions>(\n  id: T,\n  generatingIcon: TemplateResult<1>,\n  variants?: Omit<\n    Parameters<BlockSuitePresets.AIActions[T]>[0],\n    keyof BlockSuitePresets.AITextActionOptions\n  >,\n  customInput?: (\n    host: EditorHost,\n    ctx: CtxRecord\n  ) => Promise<{\n    input?: string;\n    content?: string;\n    attachments?: (string | Blob)[];\n    seed?: string;\n  } | void>,\n  trackerOptions?: BlockSuitePresets.TrackerOptions\n) {\n  return (host: EditorHost) => {\n    const aiPanel = getAIPanel(host);\n    const edgelessCopilot = getEdgelessCopilotWidget(host);\n    let internal: Record<string, unknown> = {};\n    const selectedElements = getCopilotSelectedElems(host);\n    const { selectedBlocks } = getSelections(host);\n    const ctx = {\n      get() {\n        return {\n          ...internal,\n          selectedElements,\n        };\n      },\n      set(data: Record<string, unknown>) {\n        internal = data;\n      },\n    };\n\n    edgelessCopilot.hideCopilotPanel();\n    edgelessCopilot.lockToolbar(true);\n\n    aiPanel.host = host;\n    updateEdgelessAIPanelConfig(\n      aiPanel,\n      edgelessCopilot,\n      id,\n      generatingIcon,\n      ctx,\n      variants,\n      customInput,\n      trackerOptions\n    );\n\n    const elementToolbar = getElementToolbar(host);\n    const isEmpty = selectedElements.length === 0;\n    const isCreateImageAction = id === 'createImage';\n    const isMakeItRealAction = !isCreateImageAction && id === 'makeItReal';\n    let referenceElement = null;\n    let togglePanel = () => Promise.resolve(isEmpty);\n\n    if (selectedBlocks && selectedBlocks.length !== 0) {\n      referenceElement = selectedBlocks.at(-1);\n    } else if (edgelessCopilot.visible && edgelessCopilot.selectionElem) {\n      referenceElement = edgelessCopilot.selectionElem;\n    } else if (elementToolbar.toolbarVisible) {\n      referenceElement = getElementToolbar(host);\n    } else if (!isEmpty) {\n      const lastSelected = selectedElements.at(-1)!.id;\n      referenceElement = getSelectedNoteAnchor(host, lastSelected);\n    }\n\n    if (!referenceElement) return;\n\n    if (isCreateImageAction || isMakeItRealAction) {\n      togglePanel = async () => {\n        if (isEmpty) return true;\n        const {\n          notes,\n          shapes,\n          images,\n          edgelessTexts,\n          frames: _,\n        } = BlocksUtils.splitElements(selectedElements);\n        const blocks = [...notes, ...shapes, ...images, ...edgelessTexts];\n        if (blocks.length === 0) return true;\n        const content = await getContentFromSelected(host, blocks);\n        ctx.set({\n          content,\n        });\n        return content.length === 0;\n      };\n    }\n\n    togglePanel()\n      .then(isEmpty => {\n        aiPanel.toggle(referenceElement, isEmpty ? undefined : 'placeholder');\n      })\n      .catch(console.error);\n  };\n}\n\nexport function noteBlockOrTextShowWhen(\n  _: unknown,\n  __: unknown,\n  host: EditorHost\n) {\n  const selected = getCopilotSelectedElems(host);\n\n  return selected.some(\n    el =>\n      el instanceof NoteBlockModel ||\n      el instanceof TextElementModel ||\n      el instanceof EdgelessTextBlockModel\n  );\n}\n\n/**\n * Checks if the selected element is a NoteBlockModel with a single child element of code block.\n */\nexport function noteWithCodeBlockShowWen(\n  _: unknown,\n  __: unknown,\n  host: EditorHost\n) {\n  const selected = getCopilotSelectedElems(host);\n  if (!selected.length) return false;\n\n  return (\n    selected[0] instanceof NoteBlockModel &&\n    selected[0].children.length === 1 &&\n    BlocksUtils.matchFlavours(selected[0].children[0], ['affine:code'])\n  );\n}\n\nexport function mindmapChildShowWhen(\n  _: unknown,\n  __: unknown,\n  host: EditorHost\n) {\n  const selected = getCopilotSelectedElems(host);\n\n  return selected.length === 1 && isMindmapChild(selected[0]);\n}\n\nexport function imageOnlyShowWhen(_: unknown, __: unknown, host: EditorHost) {\n  const selected = getCopilotSelectedElems(host);\n\n  return selected.length === 1 && selected[0] instanceof ImageBlockModel;\n}\n\nexport function mindmapRootShowWhen(_: unknown, __: unknown, host: EditorHost) {\n  const selected = getCopilotSelectedElems(host);\n\n  return selected.length === 1 && isMindMapRoot(selected[0]);\n}\n"]}