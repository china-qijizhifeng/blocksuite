{"version":3,"file":"doc-handler.js","sourceRoot":"","sources":["../../../src/ai/actions/doc-handler.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport type { AIError } from '@blocksuite/blocks';\nimport type {\n  AffineAIPanelWidget,\n  AffineAIPanelWidgetConfig,\n} from '@blocksuite/blocks';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { TemplateResult } from 'lit';\n\nimport {\n  buildCopyConfig,\n  buildErrorConfig,\n  buildFinishConfig,\n  buildGeneratingConfig,\n  getAIPanel,\n} from '../ai-panel.js';\nimport { createTextRenderer } from '../messages/text.js';\nimport { AIProvider } from '../provider.js';\nimport { reportResponse } from '../utils/action-reporter.js';\nimport {\n  getSelectedImagesAsBlobs,\n  getSelectedTextContent,\n  getSelections,\n  selectAboveBlocks,\n} from '../utils/selection-utils.js';\n\nexport function bindTextStream(\n  stream: BlockSuitePresets.TextStream,\n  {\n    update,\n    finish,\n    signal,\n  }: {\n    update: (text: string) => void;\n    finish: (state: 'success' | 'error' | 'aborted', err?: AIError) => void;\n    signal?: AbortSignal;\n  }\n) {\n  (async () => {\n    let answer = '';\n    signal?.addEventListener('abort', () => {\n      finish('aborted');\n      reportResponse('aborted:stop');\n    });\n    for await (const data of stream) {\n      if (signal?.aborted) {\n        return;\n      }\n      answer += data;\n      update(answer);\n    }\n    finish('success');\n  })().catch(err => {\n    if (signal?.aborted) return;\n    if (err.name === 'AbortError') {\n      finish('aborted');\n    } else {\n      finish('error', err);\n    }\n  });\n}\n\nexport function actionToStream<T extends keyof BlockSuitePresets.AIActions>(\n  id: T,\n  signal?: AbortSignal,\n  variants?: Omit<\n    Parameters<BlockSuitePresets.AIActions[T]>[0],\n    keyof BlockSuitePresets.AITextActionOptions\n  >,\n  trackerOptions?: BlockSuitePresets.TrackerOptions\n) {\n  const action = AIProvider.actions[id];\n  if (!action || typeof action !== 'function') return;\n  return (host: EditorHost): BlockSuitePresets.TextStream => {\n    let stream: BlockSuitePresets.TextStream | undefined;\n    return {\n      async *[Symbol.asyncIterator]() {\n        const { currentTextSelection, selectedBlocks } = getSelections(host);\n\n        let markdown: string;\n        let attachments: File[] = [];\n\n        if (currentTextSelection?.isCollapsed()) {\n          markdown = await selectAboveBlocks(host);\n        } else {\n          [markdown, attachments] = await Promise.all([\n            getSelectedTextContent(host),\n            getSelectedImagesAsBlobs(host),\n          ]);\n        }\n\n        // for now if there are more than one selected blocks, we will not omit the attachments\n        const sendAttachments =\n          selectedBlocks?.length === 1 && attachments.length > 0;\n        const models = selectedBlocks?.map(block => block.model);\n        const control = trackerOptions?.control ?? 'format-bar';\n        const where = trackerOptions?.where ?? 'ai-panel';\n        const options = {\n          ...variants,\n          attachments: sendAttachments ? attachments : undefined,\n          input: sendAttachments ? '' : markdown,\n          stream: true,\n          host,\n          models,\n          signal,\n          control,\n          where,\n          docId: host.doc.id,\n          workspaceId: host.doc.collection.id,\n        } as Parameters<typeof action>[0];\n        // @ts-expect-error todo: maybe fix this\n        stream = action(options);\n        if (!stream) return;\n        yield* stream;\n      },\n    };\n  };\n}\n\nexport function actionToGenerateAnswer<\n  T extends keyof BlockSuitePresets.AIActions,\n>(\n  id: T,\n  variants?: Omit<\n    Parameters<BlockSuitePresets.AIActions[T]>[0],\n    keyof BlockSuitePresets.AITextActionOptions\n  >,\n  trackerOptions?: BlockSuitePresets.TrackerOptions\n) {\n  return (host: EditorHost) => {\n    return ({\n      signal,\n      update,\n      finish,\n    }: {\n      input: string;\n      signal?: AbortSignal;\n      update: (text: string) => void;\n      finish: (state: 'success' | 'error' | 'aborted', err?: AIError) => void;\n    }) => {\n      const { selectedBlocks: blocks } = getSelections(host);\n      if (!blocks || blocks.length === 0) return;\n      const stream = actionToStream(\n        id,\n        signal,\n        variants,\n        trackerOptions\n      )?.(host);\n      if (!stream) return;\n      bindTextStream(stream, { update, finish, signal });\n    };\n  };\n}\n\n/**\n * TODO: Should update config according to the action type\n * When support mind-map. generate image, generate slides on doc mode or in edgeless note block\n * Currently, only support text action\n */\nfunction updateAIPanelConfig<T extends keyof BlockSuitePresets.AIActions>(\n  aiPanel: AffineAIPanelWidget,\n  id: T,\n  generatingIcon: TemplateResult<1>,\n  variants?: Omit<\n    Parameters<BlockSuitePresets.AIActions[T]>[0],\n    keyof BlockSuitePresets.AITextActionOptions\n  >,\n  trackerOptions?: BlockSuitePresets.TrackerOptions\n) {\n  const { config, host } = aiPanel;\n  assertExists(config);\n  config.generateAnswer = actionToGenerateAnswer(\n    id,\n    variants,\n    trackerOptions\n  )(host);\n  config.answerRenderer = createTextRenderer(host, { maxHeight: 320 });\n  config.finishStateConfig = buildFinishConfig(aiPanel, id);\n  config.generatingStateConfig = buildGeneratingConfig(generatingIcon);\n  config.errorStateConfig = buildErrorConfig(aiPanel);\n  config.copy = buildCopyConfig(aiPanel);\n  config.discardCallback = () => {\n    reportResponse('result:discard');\n  };\n}\n\nexport function actionToHandler<T extends keyof BlockSuitePresets.AIActions>(\n  id: T,\n  generatingIcon: TemplateResult<1>,\n  variants?: Omit<\n    Parameters<BlockSuitePresets.AIActions[T]>[0],\n    keyof BlockSuitePresets.AITextActionOptions\n  >,\n  trackerOptions?: BlockSuitePresets.TrackerOptions\n) {\n  return (host: EditorHost) => {\n    const aiPanel = getAIPanel(host);\n    updateAIPanelConfig(aiPanel, id, generatingIcon, variants, trackerOptions);\n    const { selectedBlocks: blocks } = getSelections(aiPanel.host);\n    if (!blocks || blocks.length === 0) return;\n    aiPanel.toggle(blocks.at(-1)!, 'placeholder');\n  };\n}\n\nexport function handleInlineAskAIAction(host: EditorHost) {\n  const panel = getAIPanel(host);\n  const selection = host.selection.find('text');\n  const lastBlockPath = selection\n    ? selection.to?.blockId ?? selection.blockId\n    : null;\n  if (!lastBlockPath) return;\n  const block = host.view.getBlock(lastBlockPath);\n  if (!block) return;\n  const generateAnswer: AffineAIPanelWidgetConfig['generateAnswer'] = ({\n    finish,\n    input,\n    signal,\n    update,\n  }) => {\n    if (!AIProvider.actions.chat) return;\n\n    // recover selection to get content from above blocks\n    assertExists(selection);\n    host.selection.set([selection]);\n\n    selectAboveBlocks(host)\n      .then(context => {\n        assertExists(AIProvider.actions.chat);\n        const stream = AIProvider.actions.chat({\n          input: `${context}\\n${input}`,\n          stream: true,\n          host,\n          where: 'inline-chat-panel',\n          control: 'chat-send',\n          docId: host.doc.id,\n          workspaceId: host.doc.collection.id,\n        });\n        bindTextStream(stream, { update, finish, signal });\n      })\n      .catch(console.error);\n  };\n  assertExists(panel.config);\n  panel.config.generateAnswer = generateAnswer;\n  panel.toggle(block);\n}\n"]}