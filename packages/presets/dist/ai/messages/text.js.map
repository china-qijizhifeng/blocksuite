{"version":3,"file":"text.js","sourceRoot":"","sources":["../../../src/ai/messages/text.ts"],"names":[],"mappings":"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","sourcesContent":["import { type EditorHost, WithDisposable } from '@blocksuite/block-std';\nimport type { AffineAIPanelState } from '@blocksuite/blocks';\nimport {\n  type AffineAIPanelWidgetConfig,\n  BlocksUtils,\n  CodeBlockComponent,\n  DividerBlockComponent,\n  ListBlockComponent,\n  ParagraphBlockComponent,\n} from '@blocksuite/blocks';\nimport { type BlockSelector, BlockViewType, type Doc } from '@blocksuite/store';\nimport { css, html, LitElement, type PropertyValues } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { keyed } from 'lit/directives/keyed.js';\n\nimport { CustomPageEditorBlockSpecs } from '../utils/custom-specs.js';\nimport { markDownToDoc } from '../utils/markdown-utils.js';\n\nconst textBlockStyles = css`\n  ${ParagraphBlockComponent.styles}\n  ${ListBlockComponent.styles}\n  ${DividerBlockComponent.styles}\n  ${CodeBlockComponent.styles}\n`;\n\nconst customHeadingStyles = css`\n  .custom-heading {\n    .h1 {\n      font-size: calc(var(--affine-font-h-1) - 2px);\n      code {\n        font-size: calc(var(--affine-font-base) + 6px);\n      }\n    }\n    .h2 {\n      font-size: calc(var(--affine-font-h-2) - 2px);\n      code {\n        font-size: calc(var(--affine-font-base) + 4px);\n      }\n    }\n    .h3 {\n      font-size: calc(var(--affine-font-h-3) - 2px);\n      code {\n        font-size: calc(var(--affine-font-base) + 2px);\n      }\n    }\n    .h4 {\n      font-size: calc(var(--affine-font-h-4) - 2px);\n      code {\n        font-size: var(--affine-font-base);\n      }\n    }\n    .h5 {\n      font-size: calc(var(--affine-font-h-5) - 2px);\n      code {\n        font-size: calc(var(--affine-font-base) - 2px);\n      }\n    }\n    .h6 {\n      font-size: calc(var(--affine-font-h-6) - 2px);\n      code {\n        font-size: calc(var(--affine-font-base) - 4px);\n      }\n    }\n  }\n`;\n\ntype TextRendererOptions = {\n  maxHeight?: number;\n  customHeading?: boolean;\n};\n\n@customElement('ai-answer-text')\nexport class AIAnswerText extends WithDisposable(LitElement) {\n  static override styles = css`\n    .ai-answer-text-editor.affine-page-viewport {\n      background: transparent;\n      font-family: var(--affine-font-family);\n      margin-top: 0;\n      margin-bottom: 0;\n    }\n\n    .ai-answer-text-editor .affine-page-root-block-container {\n      padding: 0;\n      line-height: var(--affine-line-height);\n      color: var(--affine-text-primary-color);\n      font-weight: 400;\n    }\n\n    .affine-paragraph-block-container {\n      line-height: 22px;\n    }\n\n    .ai-answer-text-editor {\n      .affine-note-block-container {\n        > .affine-block-children-container {\n          > :first-child,\n          > :first-child * {\n            margin-top: 0 !important;\n          }\n          > :last-child,\n          > :last-child * {\n            margin-bottom: 0 !important;\n          }\n        }\n      }\n    }\n\n    .ai-answer-text-container {\n      overflow-y: auto;\n      overflow-x: hidden;\n      padding: 0;\n      overscroll-behavior-y: none;\n    }\n    .ai-answer-text-container.show-scrollbar::-webkit-scrollbar {\n      width: 5px;\n      height: 100px;\n    }\n    .ai-answer-text-container.show-scrollbar::-webkit-scrollbar-thumb {\n      border-radius: 20px;\n    }\n    .ai-answer-text-container.show-scrollbar:hover::-webkit-scrollbar-thumb {\n      background-color: var(--affine-black-30);\n    }\n    .ai-answer-text-container.show-scrollbar::-webkit-scrollbar-corner {\n      display: none;\n    }\n\n    .ai-answer-text-container {\n      rich-text .nowrap-lines v-text span,\n      rich-text .nowrap-lines v-element span {\n        white-space: pre;\n      }\n      editor-host:focus-visible {\n        outline: none;\n      }\n      editor-host * {\n        box-sizing: border-box;\n      }\n    }\n\n    ${textBlockStyles}\n    ${customHeadingStyles}\n  `;\n\n  @query('.ai-answer-text-container')\n  private accessor _container!: HTMLDivElement;\n\n  private _doc!: Doc;\n\n  private _answers: string[] = [];\n\n  private _timer?: ReturnType<typeof setInterval> | null = null;\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor answer!: string;\n\n  @property({ attribute: false })\n  accessor options!: TextRendererOptions;\n\n  @property({ attribute: false })\n  accessor state: AffineAIPanelState | undefined = undefined;\n\n  private _onWheel(e: MouseEvent) {\n    e.stopPropagation();\n    if (this.state === 'generating') {\n      e.preventDefault();\n    }\n  }\n\n  private _clearTimer = () => {\n    if (this._timer) {\n      clearInterval(this._timer);\n      this._timer = null;\n    }\n  };\n\n  private _selector: BlockSelector = block =>\n    BlocksUtils.matchFlavours(block.model, [\n      'affine:page',\n      'affine:note',\n      'affine:surface',\n      'affine:paragraph',\n      'affine:code',\n      'affine:list',\n      'affine:divider',\n    ])\n      ? BlockViewType.Display\n      : BlockViewType.Hidden;\n\n  private _updateDoc = () => {\n    if (this._answers.length > 0) {\n      const latestAnswer = this._answers.pop();\n      this._answers = [];\n      if (latestAnswer) {\n        markDownToDoc(this.host, latestAnswer)\n          .then(doc => {\n            this._doc = doc.blockCollection.getDoc({\n              selector: this._selector,\n            });\n            this.disposables.add(() => {\n              doc.blockCollection.clearSelector(this._selector);\n            });\n            this._doc.awarenessStore.setReadonly(\n              this._doc.blockCollection,\n              true\n            );\n            this.requestUpdate();\n            if (this.state !== 'generating') {\n              this._clearTimer();\n            }\n          })\n          .catch(console.error);\n      }\n    }\n  };\n\n  override shouldUpdate(changedProperties: PropertyValues) {\n    if (changedProperties.has('answer')) {\n      this._answers.push(this.answer);\n      return false;\n    }\n\n    return true;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this._answers.push(this.answer);\n\n    this._updateDoc();\n    if (this.state === 'generating') {\n      this._timer = setInterval(this._updateDoc, 600);\n    }\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this._clearTimer();\n  }\n\n  override updated(changedProperties: PropertyValues) {\n    super.updated(changedProperties);\n    requestAnimationFrame(() => {\n      if (!this._container) return;\n      this._container.scrollTop = this._container.scrollHeight;\n    });\n  }\n\n  override render() {\n    const { maxHeight, customHeading } = this.options;\n    const classes = classMap({\n      'ai-answer-text-container': true,\n      'show-scrollbar': !!maxHeight,\n      'custom-heading': !!customHeading,\n    });\n    return html`\n      <style>\n        .ai-answer-text-container {\n          max-height: ${maxHeight ? Math.max(maxHeight, 200) + 'px' : ''};\n        }\n      </style>\n      <div class=${classes} @wheel=${this._onWheel}>\n        ${keyed(\n          this._doc,\n          html`<div class=\"ai-answer-text-editor affine-page-viewport\">\n            ${this.host.renderSpecPortal(this._doc, CustomPageEditorBlockSpecs)}\n          </div>`\n        )}\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'ai-answer-text': AIAnswerText;\n  }\n}\n\nexport const createTextRenderer: (\n  host: EditorHost,\n  options: TextRendererOptions\n) => AffineAIPanelWidgetConfig['answerRenderer'] = (host, options) => {\n  return (answer, state) => {\n    return html`<ai-answer-text\n      .host=${host}\n      .answer=${answer}\n      .state=${state}\n      .options=${options}\n    ></ai-answer-text>`;\n  };\n};\n"]}