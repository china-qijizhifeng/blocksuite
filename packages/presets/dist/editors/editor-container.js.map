{"version":3,"file":"editor-container.js","sourceRoot":"","sources":["../../src/editors/editor-container.ts"],"names":[],"mappings":"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","sourcesContent":["import './page-editor.js';\nimport './edgeless-editor.js';\nimport '../fragments/doc-title/doc-title.js';\nimport '../fragments/doc-meta-tags/doc-meta-tags.js';\n\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport type {\n  AbstractEditor,\n  DocMode,\n  EdgelessRootBlockComponent,\n  PageRootBlockComponent,\n  PageRootService,\n} from '@blocksuite/blocks';\nimport {\n  EdgelessEditorBlockSpecs,\n  PageEditorBlockSpecs,\n  ThemeObserver,\n} from '@blocksuite/blocks';\nimport { assertExists, Slot } from '@blocksuite/global/utils';\nimport type { BlockModel, Doc } from '@blocksuite/store';\nimport { css, html, nothing } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { keyed } from 'lit/directives/keyed.js';\n\nimport type { EdgelessEditor } from './edgeless-editor.js';\nimport type { PageEditor } from './page-editor.js';\n\n/**\n * @deprecated need to refactor\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction forwardSlot<T extends Record<string, Slot<any>>>(\n  from: T,\n  to: Partial<T>\n) {\n  Object.entries(from).forEach(([key, slot]) => {\n    const target = to[key];\n    if (target) {\n      slot.pipe(target);\n    }\n  });\n}\n\n@customElement('affine-editor-container')\nexport class AffineEditorContainer\n  extends WithDisposable(ShadowlessElement)\n  implements AbstractEditor\n{\n  private get _pageSpecs() {\n    return [...this.pageSpecs].map(spec => {\n      if (spec.schema.model.flavour === 'affine:page') {\n        const setup = spec.setup;\n        spec = {\n          ...spec,\n          setup: (slots, disposable) => {\n            setup?.(slots, disposable);\n            slots.mounted.once(({ service }) => {\n              const { docModeService } = service as PageRootService;\n              disposable.add(\n                docModeService.onModeChange(this.switchEditor.bind(this))\n              );\n            });\n          },\n        };\n      }\n      return spec;\n    });\n  }\n\n  private get _edgelessSpecs() {\n    return [...this.edgelessSpecs].map(spec => {\n      if (spec.schema.model.flavour === 'affine:page') {\n        const setup = spec.setup;\n        spec = {\n          ...spec,\n          setup: (slots, disposable) => {\n            setup?.(slots, disposable);\n            slots.mounted.once(({ service }) => {\n              const { docModeService } = service as PageRootService;\n              disposable.add(\n                docModeService.onModeChange(this.switchEditor.bind(this))\n              );\n            });\n          },\n        };\n      }\n      return spec;\n    });\n  }\n\n  get editor() {\n    const editor =\n      this.mode === 'page' ? this._pageEditor : this._edgelessEditor;\n    assertExists(editor);\n    return editor;\n  }\n\n  get host() {\n    assertExists(this.editor);\n    return this.editor.host;\n  }\n\n  get rootModel() {\n    return this.doc.root as BlockModel;\n  }\n\n  static override styles = css`\n    .affine-page-viewport {\n      position: relative;\n      display: flex;\n      flex-direction: column;\n      height: 100%;\n      overflow-x: hidden;\n      overflow-y: auto;\n      container-name: viewport;\n      container-type: inline-size;\n      font-family: var(--affine-font-family);\n    }\n    .affine-page-viewport * {\n      box-sizing: border-box;\n    }\n\n    @media print {\n      .affine-page-viewport {\n        height: auto;\n      }\n    }\n\n    page-editor {\n      flex-grow: 1;\n    }\n  `;\n\n  @query('page-editor')\n  private accessor _pageEditor: PageEditor | null = null;\n\n  @query('edgeless-editor')\n  private accessor _edgelessEditor: EdgelessEditor | null = null;\n\n  /** @deprecated unreliable since pageSpecs can be overridden */\n  @query('affine-page-root')\n  private accessor _pageRoot: PageRootBlockComponent | null = null;\n\n  /** @deprecated unreliable since edgelessSpecs can be overridden */\n  @query('affine-edgeless-root')\n  private accessor _edgelessRoot: EdgelessRootBlockComponent | null = null;\n\n  @property({ attribute: false })\n  accessor doc!: Doc;\n\n  @property({ attribute: false })\n  accessor mode: DocMode = 'page';\n\n  @property({ attribute: false })\n  accessor pageSpecs = PageEditorBlockSpecs;\n\n  @property({ attribute: false })\n  accessor edgelessSpecs = EdgelessEditorBlockSpecs;\n\n  @property({ attribute: false })\n  override accessor autofocus = false;\n\n  /**\n   * @deprecated need to refactor\n   */\n  readonly themeObserver = new ThemeObserver();\n\n  /**\n   * @deprecated need to refactor\n   */\n  slots: AbstractEditor['slots'] = {\n    docLinkClicked: new Slot(),\n    editorModeSwitched: new Slot(),\n    docUpdated: new Slot(),\n    tagClicked: new Slot<{ tagId: string }>(),\n  };\n\n  switchEditor(mode: DocMode) {\n    this.mode = mode;\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    const editor = this.editor;\n    assertExists(editor);\n    await editor.updateComplete;\n    return result;\n  }\n\n  override firstUpdated() {\n    if (this.mode === 'page') {\n      setTimeout(() => {\n        if (this.autofocus) {\n          const richText = this.querySelector('rich-text');\n          assertExists(richText);\n          const inlineEditor = richText.inlineEditor;\n          assertExists(inlineEditor);\n          inlineEditor.focusEnd();\n        }\n      });\n    }\n  }\n\n  /**\n   * @deprecated need to refactor\n   */\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.themeObserver.observe(document.documentElement);\n    this._disposables.add(this.themeObserver);\n    this._disposables.add(\n      this.doc.slots.rootAdded.on(() => this.requestUpdate())\n    );\n  }\n\n  /**\n   * @deprecated need to refactor\n   */\n  override updated(changedProperties: Map<string, unknown>) {\n    if (changedProperties.has('mode')) {\n      this.slots.editorModeSwitched.emit(this.mode);\n    }\n\n    if (changedProperties.has('doc')) {\n      this.slots.docUpdated.emit({ newDocId: this.doc.id });\n    }\n\n    if (!changedProperties.has('doc') && !changedProperties.has('mode')) {\n      return;\n    }\n\n    requestAnimationFrame(() => {\n      if (this._pageRoot) forwardSlot(this._pageRoot.slots, this.slots);\n      if (this._edgelessRoot) forwardSlot(this._edgelessRoot.slots, this.slots);\n    });\n  }\n\n  override render() {\n    if (!this.rootModel) return nothing;\n\n    return html`${keyed(\n      this.rootModel.id,\n      this.mode === 'page'\n        ? html`\n            <div class=\"affine-page-viewport\">\n              <doc-title .doc=${this.doc}></doc-title>\n\n              <doc-meta-tags .doc=${this.doc}></doc-meta-tags>\n\n              <page-editor\n                .doc=${this.doc}\n                .specs=${this._pageSpecs}\n                .hasViewport=${false}\n              ></page-editor>\n            </div>\n          `\n        : html`\n            <edgeless-editor\n              .doc=${this.doc}\n              .specs=${this._edgelessSpecs}\n            ></edgeless-editor>\n          `\n    )}`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-editor-container': AffineEditorContainer;\n  }\n}\n"]}