{"version":3,"file":"edgeless-text-service.js","sourceRoot":"","sources":["../../src/edgeless-text/edgeless-text-service.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,YAAY,EAAE,MAAM,uBAAuB,CAAC;AAErD,OAAO,EAAE,kBAAkB,EAAE,MAAM,+BAA+B,CAAC;AACnE,OAAO,EAAE,sBAAsB,EAAE,MAAM,wDAAwD,CAAC;AAEhG,OAAO,EAAE,UAAU,EAAE,MAAM,4BAA4B,CAAC;AACxD,OAAO,EAAE,KAAK,EAAE,MAAM,iCAAiC,CAAC;AACxD,OAAO,EACL,8BAA8B,EAC9B,6BAA6B,GAC9B,MAAM,0BAA0B,CAAC;AAGlC,MAAM,OAAO,wBAAyB,SAAQ,YAAoC;IAChF,qBAAqB,CAAC,EACpB,QAAQ,EACR,CAAC,EACD,CAAC,GAKF;QACC,MAAM,IAAI,GAAG,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC;QACnC,MAAM,MAAM,GAAG,QAAQ,CAAC,OAAO,CAAC,QAAQ,CACtC,sBAAsB,EACtB;YACE,IAAI,EAAE,IAAI,KAAK,CACb,CAAC,GAAG,CAAC,6BAA6B,GAAG,IAAI,CAAC,GAAG,CAAC,EAC9C,CAAC,GAAG,CAAC,8BAA8B,GAAG,IAAI,CAAC,GAAG,CAAC,EAC/C,6BAA6B,GAAG,IAAI,EACpC,8BAA8B,GAAG,IAAI,CACtC,CAAC,SAAS,EAAE;YACb,KAAK,EAAE,sBAAsB,EAAE;YAC/B,UAAU,EAAE,UAAU,CAAC,KAAK;SAC7B,EACD,QAAQ,CAAC,OAAO,CAAC,OAAO,CACzB,CAAC;QAEF,MAAM,OAAO,GAAG,QAAQ,CAAC,GAAG,CAAC,QAAQ,CACnC,kBAAkB,EAClB,EAAE,IAAI,EAAE,MAAM,EAAE,EAChB,MAAM,CACP,CAAC;QACF,QAAQ,CAAC,cAAc;aACpB,IAAI,CAAC,GAAG,EAAE;YACT,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC;gBAC7B,QAAQ,EAAE,CAAC,MAAM,CAAC;gBAClB,OAAO,EAAE,IAAI;aACd,CAAC,CAAC;YACH,kBAAkB,CAAC,QAAQ,CAAC,IAAI,EAAE,OAAO,CAAC;gBACxC,EAAE,IAAI,CAAC,GAAG,EAAE;gBACV,MAAM,YAAY,GAAG,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;gBACzD,MAAM,SAAS,GAAG,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;gBACvD,IAAI,CAAC,YAAY,IAAI,CAAC,SAAS;oBAAE,OAAO;gBAExC,MAAM,eAAe,GAAG,IAAI,eAAe,EAAE,CAAC;gBAC9C,YAAY,CAAC,gBAAgB,CAC3B,UAAU,EACV,GAAG,EAAE;oBACH,IACE,CAAC,SAAS,CAAC,KAAK,CAAC,IAAI;wBACrB,SAAS,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,KAAK,CAAC,EACjC,CAAC;wBACD,QAAQ,CAAC,GAAG,CAAC,WAAW,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC;oBAC/C,CAAC;gBACH,CAAC,EACD;oBACE,IAAI,EAAE,IAAI;oBACV,MAAM,EAAE,eAAe,CAAC,MAAM;iBAC/B,CACF,CAAC;gBACF,SAAS,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,EAAE;oBAChC,eAAe,CAAC,KAAK,EAAE,CAAC;gBAC1B,CAAC,CAAC,CAAC;YACL,CAAC,CAAC;iBACD,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QAC1B,CAAC,CAAC;aACD,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QAExB,OAAO,MAAM,CAAC;IAChB,CAAC;CACF","sourcesContent":["import { BlockService } from '@blocksuite/block-std';\n\nimport { asyncFocusRichText } from '../_common/utils/selection.js';\nimport { GET_DEFAULT_TEXT_COLOR } from '../root-block/edgeless/components/panel/color-panel.js';\nimport type { EdgelessRootBlockComponent } from '../root-block/index.js';\nimport { FontFamily } from '../surface-block/consts.js';\nimport { Bound } from '../surface-block/utils/bound.js';\nimport {\n  EDGELESS_TEXT_BLOCK_MIN_HEIGHT,\n  EDGELESS_TEXT_BLOCK_MIN_WIDTH,\n} from './edgeless-text-block.js';\nimport type { EdgelessTextBlockModel } from './edgeless-text-model.js';\n\nexport class EdgelessTextBlockService extends BlockService<EdgelessTextBlockModel> {\n  initEdgelessTextBlock({\n    edgeless,\n    x,\n    y,\n  }: {\n    edgeless: EdgelessRootBlockComponent;\n    x: number;\n    y: number;\n  }) {\n    const zoom = edgeless.service.zoom;\n    const textId = edgeless.service.addBlock(\n      'affine:edgeless-text',\n      {\n        xywh: new Bound(\n          x - (EDGELESS_TEXT_BLOCK_MIN_WIDTH * zoom) / 2,\n          y - (EDGELESS_TEXT_BLOCK_MIN_HEIGHT * zoom) / 2,\n          EDGELESS_TEXT_BLOCK_MIN_WIDTH * zoom,\n          EDGELESS_TEXT_BLOCK_MIN_HEIGHT * zoom\n        ).serialize(),\n        color: GET_DEFAULT_TEXT_COLOR(),\n        fontFamily: FontFamily.Kalam,\n      },\n      edgeless.surface.blockId\n    );\n\n    const blockId = edgeless.doc.addBlock(\n      'affine:paragraph',\n      { type: 'text' },\n      textId\n    );\n    edgeless.updateComplete\n      .then(() => {\n        edgeless.service.selection.set({\n          elements: [textId],\n          editing: true,\n        });\n        asyncFocusRichText(edgeless.host, blockId)\n          ?.then(() => {\n            const edgelessText = edgeless.host.view.getBlock(textId);\n            const paragraph = edgeless.host.view.getBlock(blockId);\n            if (!edgelessText || !paragraph) return;\n\n            const abortController = new AbortController();\n            edgelessText.addEventListener(\n              'focusout',\n              () => {\n                if (\n                  !paragraph.model.text ||\n                  paragraph.model.text.length === 0\n                ) {\n                  edgeless.doc.deleteBlock(edgelessText.model);\n                }\n              },\n              {\n                once: true,\n                signal: abortController.signal,\n              }\n            );\n            paragraph.model.deleted.once(() => {\n              abortController.abort();\n            });\n          })\n          .catch(console.error);\n      })\n      .catch(console.error);\n\n    return textId;\n  }\n}\n\ndeclare global {\n  namespace BlockSuite {\n    interface BlockServices {\n      'affine:edgeless-text': EdgelessTextBlockService;\n    }\n  }\n}\n"]}