{"version":3,"file":"paste.js","sourceRoot":"","sources":["../../../../src/root-block/clipboard/middlewares/paste.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  BlockElement,\n  EditorHost,\n  TextRangePoint,\n  TextSelection,\n} from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { Text } from '@blocksuite/store';\nimport {\n  type BlockModel,\n  type BlockSnapshot,\n  type DeltaOperation,\n  DocCollection,\n  fromJSON,\n  type JobMiddleware,\n  type SliceSnapshot,\n} from '@blocksuite/store';\n\nimport { matchFlavours } from '../../../_common/utils/index.js';\nimport type { CodeBlockModel } from '../../../code-block/index.js';\nimport type { ParagraphBlockModel } from '../../../paragraph-block/index.js';\n\nconst findLast = (snapshot: BlockSnapshot): BlockSnapshot => {\n  if (snapshot.children && snapshot.children.length > 0) {\n    return findLast(snapshot.children[snapshot.children.length - 1]);\n  }\n  return snapshot;\n};\n\nclass PointState {\n  readonly block: BlockElement;\n\n  readonly text: Text;\n\n  readonly model: BlockModel;\n\n  constructor(\n    readonly std: EditorHost['std'],\n    readonly point: TextRangePoint\n  ) {\n    this.block = this._blockFromPath(point.blockId);\n    this.model = this.block.model;\n    const text = this.model.text;\n    assertExists(text);\n    this.text = text;\n  }\n\n  private _blockFromPath = (path: string) => {\n    const block = this.std.view.getBlock(path);\n    assertExists(block);\n    return block;\n  };\n}\n\nclass PasteTr {\n  private readonly lastIndex: number;\n\n  private readonly fromPointState: PointState;\n\n  private readonly endPointState: PointState;\n\n  private readonly to: TextRangePoint | null;\n\n  private readonly firstSnapshot: BlockSnapshot;\n\n  private lastSnapshot: BlockSnapshot;\n\n  private readonly firstSnapshotIsPlainText: boolean;\n\n  constructor(\n    readonly std: EditorHost['std'],\n    readonly text: TextSelection,\n    readonly snapshot: SliceSnapshot\n  ) {\n    const { from, to } = text;\n    const end = to ?? from;\n\n    this.to = to;\n\n    this.fromPointState = new PointState(std, from);\n    this.endPointState = new PointState(std, end);\n\n    this.firstSnapshot = snapshot.content[0];\n    this.lastSnapshot = findLast(snapshot.content[snapshot.content.length - 1]);\n    if (\n      this.firstSnapshot !== this.lastSnapshot &&\n      this.lastSnapshot.props.text\n    ) {\n      const text = fromJSON(this.lastSnapshot.props.text) as Text;\n      const doc = new DocCollection.Y.Doc();\n      const temp = doc.getMap('temp');\n      temp.set('text', text.yText);\n      this.lastIndex = text.length;\n    } else {\n      this.lastIndex = this.endPointState.text.length - end.index - end.length;\n    }\n    this.firstSnapshotIsPlainText =\n      this.firstSnapshot.flavour === 'affine:paragraph' &&\n      this.firstSnapshot.props.type === 'text';\n  }\n\n  private _textFromSnapshot = (snapshot: BlockSnapshot) => {\n    return snapshot.props.text as Record<'delta', DeltaOperation[]>;\n  };\n\n  private _getDeltas = () => {\n    const firstTextSnapshot = this._textFromSnapshot(this.firstSnapshot);\n    const lastTextSnapshot = this._textFromSnapshot(this.lastSnapshot);\n    const fromDelta = this.fromPointState.text.sliceToDelta(\n      0,\n      this.fromPointState.point.index\n    );\n    const toDelta = this.endPointState.text.sliceToDelta(\n      this.endPointState.point.index + this.endPointState.point.length,\n      this.endPointState.text.length\n    );\n    const firstDelta = firstTextSnapshot.delta;\n    const lastDelta = lastTextSnapshot.delta;\n    return {\n      firstTextSnapshot,\n      lastTextSnapshot,\n      fromDelta,\n      toDelta,\n      firstDelta,\n      lastDelta,\n    };\n  };\n\n  private _mergeCode = () => {\n    const { firstTextSnapshot, fromDelta, toDelta } = this._getDeltas();\n\n    this.firstSnapshot.flavour = this.fromPointState.model.flavour;\n    const toLanguage = (this.fromPointState.model as CodeBlockModel).language;\n    if (toLanguage !== 'Plain Text') {\n      this.firstSnapshot.props.language = toLanguage;\n    }\n    const deltas: DeltaOperation[] = [...fromDelta];\n    let i = 0;\n    for (const blockSnapshot of this.snapshot.content) {\n      if (blockSnapshot.props.text) {\n        const text = this._textFromSnapshot(blockSnapshot);\n        if (i > 0) {\n          deltas.push({ insert: '\\n' });\n        }\n        deltas.push(...text.delta);\n        i++;\n      } else {\n        break;\n      }\n    }\n    firstTextSnapshot.delta = deltas.concat(toDelta);\n    this.snapshot.content.splice(1, i);\n    this.lastSnapshot = findLast(\n      this.snapshot.content[this.snapshot.content.length - 1]\n    );\n  };\n\n  private _mergeSingle = () => {\n    this.firstSnapshot.flavour = this.fromPointState.model.flavour;\n    if (\n      this.firstSnapshot.props.type &&\n      (this.fromPointState.text.length > 0 || this.firstSnapshotIsPlainText)\n    ) {\n      this.firstSnapshot.props.type = (\n        this.fromPointState.model as ParagraphBlockModel\n      ).type;\n    }\n    const { firstTextSnapshot, fromDelta, toDelta, firstDelta } =\n      this._getDeltas();\n\n    firstTextSnapshot.delta = [...fromDelta, ...firstDelta, ...toDelta];\n  };\n\n  private _mergeMultiple = () => {\n    this.firstSnapshot.flavour = this.fromPointState.model.flavour;\n    if (\n      this.firstSnapshot.props.type &&\n      (this.fromPointState.text.length > 0 || this.firstSnapshotIsPlainText)\n    ) {\n      this.firstSnapshot.props.type = (\n        this.fromPointState.model as ParagraphBlockModel\n      ).type;\n    }\n    if (this.lastSnapshot.props.type && this.to) {\n      this.lastSnapshot.flavour = this.endPointState.model.flavour;\n      this.lastSnapshot.props.type = (\n        this.endPointState.model as ParagraphBlockModel\n      ).type;\n    }\n\n    const {\n      firstTextSnapshot,\n      lastTextSnapshot,\n      fromDelta,\n      toDelta,\n      firstDelta,\n      lastDelta,\n    } = this._getDeltas();\n\n    firstTextSnapshot.delta = [...fromDelta, ...firstDelta];\n    lastTextSnapshot.delta = [...lastDelta, ...toDelta];\n  };\n\n  canMerge = () => {\n    const firstTextSnapshot = this._textFromSnapshot(this.firstSnapshot);\n    const lastTextSnapshot = this._textFromSnapshot(this.lastSnapshot);\n    return (\n      firstTextSnapshot &&\n      lastTextSnapshot &&\n      ((this.fromPointState.text.length > 0 &&\n        this.endPointState.text.length > 0) ||\n        this.firstSnapshotIsPlainText)\n    );\n  };\n\n  pasted = () => {\n    const needCleanup = this.canMerge() || this.endPointState.text.length === 0;\n    if (!needCleanup) {\n      return;\n    }\n\n    const lastModel = this.std.doc.getBlockById(this.lastSnapshot.id);\n    assertExists(lastModel);\n\n    if (!this.to) {\n      this.std.doc.deleteBlock(this.fromPointState.model, {\n        bringChildrenTo: lastModel,\n      });\n\n      return;\n    }\n\n    this.std.doc.deleteBlock(\n      this.endPointState.model,\n      lastModel\n        ? {\n            bringChildrenTo: lastModel,\n          }\n        : undefined\n    );\n    const parent = this.std.doc.getParent(this.fromPointState.model);\n    this.std.doc.deleteBlock(\n      this.fromPointState.model,\n      parent\n        ? {\n            bringChildrenTo: parent,\n          }\n        : undefined\n    );\n  };\n\n  focusPasted = () => {\n    const host = this.std.host as EditorHost;\n\n    const lastModel = this.std.doc.getBlockById(this.lastSnapshot.id);\n    assertExists(lastModel);\n\n    host.updateComplete\n      .then(() => {\n        const target = this.std.host.querySelector<BlockElement>(\n          `[${host.blockIdAttr}=\"${lastModel.id}\"]`\n        );\n        assertExists(target);\n        if (!lastModel.text) {\n          if (matchFlavours(lastModel, ['affine:image'])) {\n            const selection = this.std.selection.create('image', {\n              blockId: target.blockId,\n            });\n            this.std.selection.setGroup('note', [selection]);\n            return;\n          }\n          const selection = this.std.selection.create('block', {\n            blockId: target.blockId,\n          });\n          this.std.selection.setGroup('note', [selection]);\n          return;\n        }\n        const selection = this.std.selection.create('text', {\n          from: {\n            blockId: target.blockId,\n            index:\n              this.firstSnapshot === this.lastSnapshot\n                ? lastModel.text\n                  ? lastModel.text.length - this.lastIndex\n                  : 0\n                : this.lastIndex,\n            length: 0,\n          },\n          to: null,\n        });\n        this.std.selection.setGroup('note', [selection]);\n      })\n      .catch(console.error);\n  };\n\n  merge() {\n    if (this.fromPointState.model.flavour === 'affine:code' && !this.to) {\n      this._mergeCode();\n      return;\n    }\n\n    if (this.firstSnapshot === this.lastSnapshot) {\n      this._mergeSingle();\n      return;\n    }\n\n    this._mergeMultiple();\n  }\n\n  convertToLinkedDoc = async (std: EditorHost['std']) => {\n    const quickSearchService =\n      std.spec.getService('affine:page').quickSearchService;\n\n    if (!quickSearchService) {\n      return;\n    }\n\n    const linkToDocId = new Map<string, string | null>();\n\n    for (const blockSnapshot of this.snapshot.content) {\n      if (blockSnapshot.props.text) {\n        const text = this._textFromSnapshot(blockSnapshot);\n        const needToConvert = new Map<DeltaOperation, string>();\n        for (const op of text.delta) {\n          if (op.attributes?.link) {\n            let docId = linkToDocId.get(op.attributes.link);\n            if (docId === undefined) {\n              const searchResult = await quickSearchService.searchDoc({\n                userInput: op.attributes.link,\n                skipSelection: true,\n                action: 'insert',\n              });\n              if (searchResult && 'docId' in searchResult) {\n                const doc = std.collection.getDoc(searchResult.docId);\n                if (doc) {\n                  docId = doc.id;\n                  linkToDocId.set(op.attributes.link, doc.id);\n                }\n              }\n            }\n            if (docId) {\n              needToConvert.set(op, docId);\n            }\n          }\n        }\n        const delta = text.delta.map(op => {\n          if (needToConvert.has(op)) {\n            return {\n              ...op,\n              attributes: {\n                reference: {\n                  pageId: needToConvert.get(op),\n                  type: 'LinkedPage',\n                },\n              },\n              insert: ' ',\n            };\n          }\n          return {\n            ...op,\n          };\n        });\n        const model = std.doc.getBlockById(blockSnapshot.id);\n        if (model) {\n          std.spec\n            .getService('affine:page')\n            .telemetryService?.track('LinkedDocCreated', {\n              page: 'doc editor',\n              category: 'pasted link',\n              type: 'doc',\n              other: 'existing doc',\n            });\n          std.doc.captureSync();\n          std.doc.transact(() => {\n            const text = model.text as Text;\n            text.clear();\n            text.applyDelta(delta);\n          });\n        }\n      }\n    }\n  };\n}\n\nfunction flatNote(snapshot: SliceSnapshot) {\n  if (snapshot.content[0]?.flavour === 'affine:note') {\n    snapshot.content = snapshot.content[0].children;\n  }\n}\n\nexport const pasteMiddleware = (std: EditorHost['std']): JobMiddleware => {\n  return ({ slots }) => {\n    let tr: PasteTr | undefined;\n    slots.beforeImport.on(payload => {\n      if (payload.type === 'slice') {\n        const { snapshot } = payload;\n        flatNote(snapshot);\n\n        const text = std.selection.find('text');\n        if (!text) {\n          return;\n        }\n        tr = new PasteTr(std, text, payload.snapshot);\n        if (tr.canMerge()) {\n          tr.merge();\n        }\n      }\n    });\n    slots.afterImport.on(payload => {\n      if (tr && payload.type === 'slice') {\n        tr.pasted();\n        tr.focusPasted();\n        tr.convertToLinkedDoc(std).catch(console.error);\n      }\n    });\n  };\n};\n"]}