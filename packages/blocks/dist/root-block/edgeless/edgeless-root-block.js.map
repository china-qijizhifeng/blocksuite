{"version":3,"file":"edgeless-root-block.js","sourceRoot":"","sources":["../../../src/root-block/edgeless/edgeless-root-block.ts"],"names":[],"mappings":"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","sourcesContent":["import '../../surface-block/surface-block.js';\nimport './components/block-portal/frame/edgeless-frame.js';\nimport './components/toolbar/edgeless-toolbar.js';\n\nimport type { SurfaceSelection } from '@blocksuite/block-std';\nimport { BlockElement } from '@blocksuite/block-std';\nimport { IS_WINDOWS } from '@blocksuite/global/env';\nimport { assertExists, throttle } from '@blocksuite/global/utils';\nimport type { BlockModel } from '@blocksuite/store';\nimport { css, html } from 'lit';\nimport { customElement, query, state } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport { toast } from '../../_common/components/toast.js';\nimport {\n  BLOCK_ID_ATTR,\n  EMBED_CARD_HEIGHT,\n  EMBED_CARD_WIDTH,\n} from '../../_common/consts.js';\nimport { ThemeObserver } from '../../_common/theme/theme-observer.js';\nimport {\n  asyncFocusRichText,\n  handleNativeRangeAtPoint,\n  type IPoint,\n  isPinchEvent,\n  NoteDisplayMode,\n  on,\n  Point,\n  requestConnectedFrame,\n  type Viewport,\n} from '../../_common/utils/index.js';\nimport { humanFileSize } from '../../_common/utils/math.js';\nimport type { AttachmentBlockProps } from '../../attachment-block/attachment-model.js';\nimport {\n  setAttachmentUploaded,\n  setAttachmentUploading,\n} from '../../attachment-block/utils.js';\nimport type {\n  ImageBlockModel,\n  ImageBlockProps,\n} from '../../image-block/image-model.js';\nimport {\n  Bound,\n  type IBound,\n  type IVec2,\n  normalizeWheelDeltaY,\n  serializeXYWH,\n  Vec,\n} from '../../surface-block/index.js';\nimport type {\n  IndexedCanvasUpdateEvent,\n  SurfaceBlockComponent,\n} from '../../surface-block/surface-block.js';\nimport type { SurfaceBlockModel } from '../../surface-block/surface-model.js';\nimport type { FontLoader } from '../font-loader/font-loader.js';\nimport type { RootBlockModel } from '../root-model.js';\nimport type { EdgelessRootBlockWidgetName } from '../types.js';\nimport type { EdgelessBlockPortalContainer } from './components/block-portal/edgeless-block-portal.js';\nimport { EdgelessToolbar } from './components/toolbar/edgeless-toolbar.js';\nimport { calcBoundByOrigin, readImageSize } from './components/utils.js';\nimport { EdgelessClipboardController } from './controllers/clipboard.js';\nimport {\n  BrushToolController,\n  ConnectorToolController,\n  CopilotSelectionController,\n  DefaultToolController,\n  EraserToolController,\n  FrameToolController,\n  LassoToolController,\n  MindmapToolController,\n  NoteToolController,\n  PanToolController,\n  PresentToolController,\n  ShapeToolController,\n  TemplateToolController,\n  TextToolController,\n} from './controllers/tools/index.js';\nimport { EdgelessPageKeyboardManager } from './edgeless-keyboard.js';\nimport type { EdgelessRootService } from './edgeless-root-service.js';\nimport type { EdgelessToolConstructor } from './services/tools-manager.js';\nimport type { EdgelessTool } from './types.js';\nimport { edgelessElementsBound } from './utils/bound-utils.js';\nimport {\n  DEFAULT_NOTE_HEIGHT,\n  DEFAULT_NOTE_OFFSET_X,\n  DEFAULT_NOTE_OFFSET_Y,\n  DEFAULT_NOTE_WIDTH,\n} from './utils/consts.js';\nimport { isCanvasElement } from './utils/query.js';\nexport interface EdgelessViewport {\n  left: number;\n  top: number;\n  scrollLeft: number;\n  scrollTop: number;\n  scrollWidth: number;\n  scrollHeight: number;\n  clientWidth: number;\n  clientHeight: number;\n}\n\n@customElement('affine-edgeless-root')\nexport class EdgelessRootBlockComponent extends BlockElement<\n  RootBlockModel,\n  EdgelessRootService,\n  EdgelessRootBlockWidgetName\n> {\n  get tools() {\n    return this.service.tool;\n  }\n\n  get dispatcher() {\n    return this.service?.uiEventDispatcher;\n  }\n\n  get slots() {\n    return this.service.slots;\n  }\n\n  get viewportElement(): HTMLElement {\n    if (this._viewportElement) return this._viewportElement;\n    this._viewportElement = this.host.closest(\n      '.affine-edgeless-viewport'\n    ) as HTMLElement | null;\n    assertExists(this._viewportElement);\n    return this._viewportElement;\n  }\n\n  get viewport(): Viewport {\n    const {\n      scrollLeft,\n      scrollTop,\n      scrollWidth,\n      scrollHeight,\n      clientWidth,\n      clientHeight,\n    } = this.viewportElement;\n    const { top, left } = this.viewportElement.getBoundingClientRect();\n    return {\n      top,\n      left,\n      scrollLeft,\n      scrollTop,\n      scrollWidth,\n      scrollHeight,\n      clientWidth,\n      clientHeight,\n    };\n  }\n\n  get surfaceBlockModel() {\n    return this.model.children.find(\n      child => child.flavour === 'affine:surface'\n    ) as SurfaceBlockModel;\n  }\n\n  static override styles = css`\n    affine-edgeless-root {\n      -webkit-user-select: none;\n      user-select: none;\n    }\n\n    .widgets-container {\n      position: absolute;\n      left: 0;\n      top: 0;\n      contain: size layout;\n      z-index: 1;\n      height: 100%;\n    }\n\n    .affine-edgeless-layer {\n      position: absolute;\n      top: 0;\n      left: 0;\n      contain: size layout style;\n    }\n\n    @media print {\n      .selected {\n        background-color: transparent !important;\n      }\n    }\n  `;\n\n  private _viewportElement: HTMLElement | null = null;\n\n  private readonly _themeObserver = new ThemeObserver();\n\n  private _resizeObserver: ResizeObserver | null = null;\n\n  /**\n   * Disable components\n   *\n   * Toolbar is not allowed to display in `syncd doc block`.\n   */\n  disableComponents = false;\n\n  /**\n   * Shared components\n   */\n  components = {\n    toolbar: null as EdgelessToolbar | null,\n  };\n\n  keyboardManager: EdgelessPageKeyboardManager | null = null;\n\n  mouseRoot!: HTMLElement;\n\n  @state()\n  accessor edgelessTool: EdgelessTool = {\n    type: localStorage.defaultTool ?? 'default',\n  };\n\n  @query('edgeless-block-portal-container')\n  accessor rootElementContainer!: EdgelessBlockPortalContainer;\n\n  @query('.affine-edgeless-layer')\n  accessor edgelessLayer!: HTMLDivElement;\n\n  clipboardController = new EdgelessClipboardController(this);\n\n  @query('affine-surface')\n  accessor surface!: SurfaceBlockComponent;\n\n  fontLoader!: FontLoader;\n\n  private _handleToolbarFlag() {\n    const createToolbar = () => {\n      const toolbar = new EdgelessToolbar(this);\n\n      this.append(toolbar);\n      this.components.toolbar = toolbar;\n    };\n\n    if (!this.components.toolbar) {\n      createToolbar();\n    }\n  }\n\n  private _initSlotEffects() {\n    const { disposables, slots } = this;\n\n    this._themeObserver.observe(document.documentElement);\n    this._themeObserver.on(() => this.surface.refresh());\n    this.disposables.add(() => this._themeObserver.dispose());\n\n    disposables.add(this.service.selection);\n    disposables.add(\n      slots.edgelessToolUpdated.on(tool => {\n        this.edgelessTool = tool;\n      })\n    );\n    disposables.add(\n      slots.cursorUpdated.on(\n        throttle((cursor: string) => {\n          this.style.cursor = cursor;\n        }, 144)\n      )\n    );\n\n    let canCopyAsPng = true;\n    disposables.add(\n      slots.copyAsPng.on(({ blocks, shapes }) => {\n        if (!canCopyAsPng) return;\n        canCopyAsPng = false;\n\n        this.clipboardController\n          .copyAsPng(blocks, shapes)\n          .then(() => toast(this.host, 'Copied to clipboard'))\n          .catch(() => toast(this.host, 'Failed to copy as PNG'))\n          .finally(() => {\n            canCopyAsPng = true;\n          });\n      })\n    );\n  }\n\n  private _initResizeEffect() {\n    const resizeObserver = new ResizeObserver((_: ResizeObserverEntry[]) => {\n      this.service.selection.set(this.service.selection.surfaceSelections);\n      this.service.viewport.onResize();\n    });\n\n    resizeObserver.observe(this.viewportElement);\n    this._resizeObserver = resizeObserver;\n  }\n\n  private _initPixelRatioChangeEffect() {\n    let media: MediaQueryList;\n\n    const onPixelRatioChange = () => {\n      if (media) {\n        this.service.viewport.onResize();\n        media.removeEventListener('change', onPixelRatioChange);\n      }\n\n      media = matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`);\n      media.addEventListener('change', onPixelRatioChange);\n    };\n\n    onPixelRatioChange();\n\n    this._disposables.add(() => {\n      media?.removeEventListener('change', onPixelRatioChange);\n    });\n  }\n\n  private _initFontLoader() {\n    const fontLoader = this.service?.fontLoader;\n    assertExists(fontLoader);\n\n    fontLoader.ready\n      .then(() => {\n        this.surface.refresh();\n      })\n      .catch(console.error);\n  }\n\n  private _initRemoteCursor() {\n    let rafId: number | null = null;\n\n    const setRemoteCursor = (pos: { x: number; y: number }) => {\n      if (rafId) cancelAnimationFrame(rafId);\n      rafId = requestConnectedFrame(() => {\n        const cursorPosition = this.service.viewport.toModelCoord(pos.x, pos.y);\n        this.service.selection.setCursor({\n          x: cursorPosition[0],\n          y: cursorPosition[1],\n        });\n        rafId = null;\n      }, this);\n    };\n\n    this.handleEvent('pointerMove', e => {\n      const pointerEvent = e.get('pointerState');\n      setRemoteCursor(pointerEvent);\n    });\n  }\n\n  private _initSurface() {\n    const appendIndexedCanvasToPortal = (\n      canvases: HTMLCanvasElement[] = this.surface.renderer.stackingCanvas\n    ) => {\n      this.rootElementContainer.setSlotContent(canvases);\n    };\n\n    this._disposables.add(\n      on(this.surface, 'indexedcanvasupdate', e => {\n        appendIndexedCanvasToPortal(\n          (e as IndexedCanvasUpdateEvent).detail.content\n        );\n      })\n    );\n\n    this._disposables.add(\n      this.std.event.slots.editorHostPanned.on(() => {\n        this.service.viewport.onResize();\n      })\n    );\n\n    if (this.rootElementContainer.isUpdatePending) {\n      this.rootElementContainer.updateComplete\n        .then(() => appendIndexedCanvasToPortal())\n        .catch(console.error);\n    } else {\n      appendIndexedCanvasToPortal();\n    }\n  }\n\n  private _initViewport() {\n    const { service } = this;\n\n    service.viewport.setContainer(this);\n\n    const run = () => {\n      const viewport =\n        service.editPropsStore.getItem('viewport') ??\n        service.getFitToScreenData();\n\n      if ('xywh' in viewport) {\n        const bound = Bound.deserialize(viewport.xywh);\n        service.viewport.setViewportByBound(bound, viewport.padding);\n      } else {\n        const { zoom, centerX, centerY } = viewport;\n        service.viewport.setViewport(zoom, [centerX, centerY]);\n      }\n    };\n\n    if (this.surface.isUpdatePending) {\n      this.surface.updateComplete.then(run).catch(console.error);\n    } else {\n      run();\n    }\n\n    this._disposables.add(() => {\n      service.editPropsStore.setItem('viewport', {\n        centerX: service.viewport.centerX,\n        centerY: service.viewport.centerY,\n        zoom: service.viewport.zoom,\n      });\n    });\n  }\n\n  private _initTools() {\n    const tools = [\n      DefaultToolController,\n      BrushToolController,\n      EraserToolController,\n      TextToolController,\n      ShapeToolController,\n      ConnectorToolController,\n      NoteToolController,\n      FrameToolController,\n      PanToolController,\n      PresentToolController,\n      CopilotSelectionController,\n      LassoToolController,\n      TemplateToolController,\n      MindmapToolController,\n    ] as EdgelessToolConstructor[];\n\n    tools.forEach(tool => {\n      this.service.registerTool(tool);\n    });\n    this.service.tool.mount(this);\n  }\n\n  private _initWheelEvent() {\n    this._disposables.add(\n      this.dispatcher.add('wheel', ctx => {\n        const state = ctx.get('defaultState');\n        const e = state.event as WheelEvent;\n\n        e.preventDefault();\n\n        const { viewport, locked } = this.service;\n\n        if (locked) return;\n\n        // zoom\n        if (isPinchEvent(e)) {\n          const rect = this.getBoundingClientRect();\n          // Perform zooming relative to the mouse position\n          const [baseX, baseY] = this.service.viewport.toModelCoord(\n            e.clientX - rect.x,\n            e.clientY - rect.y\n          );\n\n          const zoom = normalizeWheelDeltaY(e.deltaY, viewport.zoom);\n          viewport.setZoom(zoom, new Point(baseX, baseY));\n          e.stopPropagation();\n        }\n        // pan\n        else {\n          const simulateHorizontalScroll = IS_WINDOWS && e.shiftKey;\n          const dx = simulateHorizontalScroll\n            ? e.deltaY / viewport.zoom\n            : e.deltaX / viewport.zoom;\n          const dy = simulateHorizontalScroll ? 0 : e.deltaY / viewport.zoom;\n\n          viewport.applyDeltaCenter(dx, dy);\n          viewport.viewportMoved.emit([dx, dy]);\n          e.stopPropagation();\n        }\n      })\n    );\n  }\n\n  /**\n   * Adds a new note with the given point on the affine-editor-container.\n   *\n   * @param: point Point\n   * @returns: The id of new note\n   */\n  addNoteWithPoint(\n    point: IPoint,\n    options: {\n      width?: number;\n      height?: number;\n      parentId?: string;\n      noteIndex?: number;\n      offsetX?: number;\n      offsetY?: number;\n      scale?: number;\n    } = {}\n  ) {\n    const {\n      width = DEFAULT_NOTE_WIDTH,\n      height = DEFAULT_NOTE_HEIGHT,\n      offsetX = DEFAULT_NOTE_OFFSET_X,\n      offsetY = DEFAULT_NOTE_OFFSET_Y,\n      parentId = this.doc.root?.id,\n      noteIndex: noteIndex,\n      scale = 1,\n    } = options;\n    const [x, y] = this.service.viewport.toModelCoord(point.x, point.y);\n    const blockId = this.service.addBlock(\n      'affine:note',\n      {\n        xywh: serializeXYWH(\n          x - offsetX * scale,\n          y - offsetY * scale,\n          width,\n          height\n        ),\n        displayMode: NoteDisplayMode.EdgelessOnly,\n      },\n      parentId,\n      noteIndex\n    );\n\n    this.service.telemetryService?.track('CanvasElementAdded', {\n      control: 'canvas:draw',\n      page: 'whiteboard editor',\n      module: 'toolbar',\n      segment: 'toolbar',\n      type: 'note',\n    });\n\n    return blockId;\n  }\n\n  /**\n   * Adds a new note with the given blocks and point.\n   * @param blocks Array\\<Partial\\<BlockModel\\>\\>\n   * @param point Point\n   */\n  addNewNote(\n    blocks: Array<Partial<BlockModel>>,\n    point: IPoint,\n    options?: {\n      width?: number;\n      height?: number;\n      parentId?: string;\n      noteIndex?: number;\n      offsetX?: number;\n      offsetY?: number;\n    }\n  ): {\n    noteId: string;\n    ids: string[];\n  } {\n    this.doc.captureSync();\n    const { left, top } = this.service.viewport;\n    point.x -= left;\n    point.y -= top;\n    const noteId = this.addNoteWithPoint(point, options);\n    const ids = this.doc.addBlocks(\n      blocks.map(({ flavour, ...blockProps }) => {\n        assertExists(flavour);\n        return {\n          flavour,\n          blockProps,\n        };\n      }),\n      noteId\n    );\n    return {\n      noteId,\n      ids,\n    };\n  }\n\n  addImage(model: Partial<ImageBlockModel>, point: IPoint) {\n    const options = {\n      width: model.width ?? 0,\n      height: model.height ?? 0,\n    };\n    {\n      delete model.width;\n      delete model.height;\n    }\n    const [x, y] = this.service.viewport.toModelCoord(point.x, point.y);\n    const bound = new Bound(x, y, options.width, options.height);\n    return this.service.addBlock(\n      'affine:image',\n      { ...model, xywh: bound.serialize() },\n      this.surface.model\n    );\n  }\n\n  async addImages(\n    files: File[],\n    point?: IVec2,\n    inTopLeft?: boolean\n  ): Promise<string[]> {\n    const imageFiles = [...files].filter(file =>\n      file.type.startsWith('image/')\n    );\n    if (!imageFiles.length) return [];\n\n    const imageService = this.host.spec.getService('affine:image');\n    const maxFileSize = imageService.maxFileSize;\n    const isSizeExceeded = imageFiles.some(file => file.size > maxFileSize);\n    if (isSizeExceeded) {\n      toast(\n        this.host,\n        `You can only upload files less than ${humanFileSize(\n          maxFileSize,\n          true,\n          0\n        )}`\n      );\n      return [];\n    }\n\n    let { x, y } = this.service.viewport.center;\n    if (point) [x, y] = this.service.viewport.toModelCoord(...point);\n\n    const dropInfos: { point: Point; blockId: string }[] = [];\n\n    const IMAGE_STACK_GAP = 32;\n\n    // create image cards without image data\n    imageFiles.map((file, index) => {\n      const point = new Point(\n        x + index * IMAGE_STACK_GAP,\n        y + index * IMAGE_STACK_GAP\n      );\n      const center = Vec.toVec(point);\n      const bound = calcBoundByOrigin(center, inTopLeft);\n      const blockId = this.service.addBlock(\n        'affine:image',\n        {\n          size: file.size,\n          xywh: bound.serialize(),\n        },\n        this.surface.model\n      );\n      dropInfos.push({ point, blockId });\n    });\n\n    // upload image data and update the image model\n    const uploadPromises = imageFiles.map(async (file, index) => {\n      const { point, blockId } = dropInfos[index];\n\n      const sourceId = await this.doc.blobSync.set(file);\n      const imageSize = await readImageSize(file);\n\n      const center = Vec.toVec(point);\n      const bound = calcBoundByOrigin(\n        center,\n        inTopLeft,\n        imageSize.width,\n        imageSize.height\n      );\n\n      this.doc.withoutTransact(() => {\n        this.service.updateElement(blockId, {\n          sourceId,\n          ...imageSize,\n          xywh: bound.serialize(),\n        } satisfies Partial<ImageBlockProps>);\n      });\n    });\n    await Promise.all(uploadPromises);\n\n    const blockIds = dropInfos.map(info => info.blockId);\n    this.service.selection.set({\n      elements: blockIds,\n      editing: false,\n    });\n    return blockIds;\n  }\n\n  async addAttachments(files: File[], point?: IVec2): Promise<string[]> {\n    if (!files.length) return [];\n\n    const attachmentService = this.host.spec.getService('affine:attachment');\n    const maxFileSize = attachmentService.maxFileSize;\n    const isSizeExceeded = files.some(file => file.size > maxFileSize);\n    if (isSizeExceeded) {\n      toast(\n        this.host,\n        `You can only upload files less than ${humanFileSize(\n          maxFileSize,\n          true,\n          0\n        )}`\n      );\n      return [];\n    }\n\n    let { x, y } = this.service.viewport.center;\n    if (point) [x, y] = this.service.viewport.toModelCoord(...point);\n\n    const CARD_STACK_GAP = 32;\n\n    const dropInfos: { blockId: string; file: File }[] = files.map(\n      (file, index) => {\n        const point = new Point(\n          x + index * CARD_STACK_GAP,\n          y + index * CARD_STACK_GAP\n        );\n        const center = Vec.toVec(point);\n        const bound = Bound.fromCenter(\n          center,\n          EMBED_CARD_WIDTH.cubeThick,\n          EMBED_CARD_HEIGHT.cubeThick\n        );\n        const blockId = this.service.addBlock(\n          'affine:attachment',\n          {\n            name: file.name,\n            size: file.size,\n            type: file.type,\n            style: 'cubeThick',\n            xywh: bound.serialize(),\n          } satisfies Partial<AttachmentBlockProps>,\n          this.surface.model\n        );\n\n        return { blockId, file };\n      }\n    );\n\n    // upload file and update the attachment model\n    const uploadPromises = dropInfos.map(async ({ blockId, file }) => {\n      let sourceId: string | undefined;\n      try {\n        setAttachmentUploading(blockId);\n        sourceId = await this.doc.blobSync.set(file);\n      } catch (error) {\n        console.error(error);\n        if (error instanceof Error) {\n          toast(\n            this.host,\n            `Failed to upload attachment! ${error.message || error.toString()}`\n          );\n        }\n      } finally {\n        setAttachmentUploaded(blockId);\n        this.doc.withoutTransact(() => {\n          this.service.updateElement(blockId, {\n            sourceId,\n          } satisfies Partial<AttachmentBlockProps>);\n        });\n      }\n      return blockId;\n    });\n    const blockIds = await Promise.all(uploadPromises);\n\n    this.service.selection.set({\n      elements: blockIds,\n      editing: false,\n    });\n\n    return blockIds;\n  }\n\n  /*\n   * Set selection state by giving noteId & blockId.\n   * Not supports surface elements.\n   */\n  setSelection(noteId: string, _active = true, blockId: string, point?: Point) {\n    const noteBlock = this.service.blocks\n      .filter(block => block.flavour === 'affine:note')\n      .find(b => b.id === noteId);\n    assertExists(noteBlock);\n\n    requestAnimationFrame(() => {\n      this.service.selection.set({\n        elements: [noteBlock.id],\n        editing: false,\n      });\n      // Waiting dom updated, `note mask` is removed\n      this.updateComplete\n        .then(() => {\n          if (blockId) {\n            asyncFocusRichText(this.host, blockId)?.catch(console.error);\n          } else if (point) {\n            // Cannot reuse `handleNativeRangeClick` directly here,\n            // since `retargetClick` will re-target to pervious editor\n            handleNativeRangeAtPoint(point.x, point.y);\n          }\n        })\n        .catch(console.error);\n    });\n  }\n\n  getElementsBound(): IBound | null {\n    const { service } = this;\n    return edgelessElementsBound([...service.elements, ...service.blocks]);\n  }\n\n  override firstUpdated() {\n    this._initSlotEffects();\n    this._initResizeEffect();\n    this._initPixelRatioChangeEffect();\n    this._initFontLoader();\n    this._initRemoteCursor();\n    this._initSurface();\n\n    this._initViewport();\n    this._initWheelEvent();\n\n    if (this.doc.readonly) {\n      this.tools.setEdgelessTool({ type: 'pan', panning: true });\n    }\n\n    if (this.disableComponents) return;\n    requestConnectedFrame(() => {\n      this._handleToolbarFlag();\n      this.requestUpdate();\n    }, this);\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.clipboardController.hostConnected();\n\n    this.keyboardManager = new EdgelessPageKeyboardManager(this);\n\n    this.handleEvent('selectionChange', () => {\n      const surface = this.host.selection.value.find(\n        (sel): sel is SurfaceSelection => sel.is('surface')\n      );\n      if (!surface) return;\n\n      const el = this.service.getElementById(surface.elements[0]);\n      if (isCanvasElement(el)) {\n        return true;\n      }\n\n      return;\n    });\n\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    this.mouseRoot = this.parentElement!;\n    this._initTools();\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this.clipboardController.hostDisconnected();\n    if (this._resizeObserver) {\n      this._resizeObserver.disconnect();\n      this._resizeObserver = null;\n    }\n\n    this.keyboardManager = null;\n    this.components.toolbar?.remove();\n    this.components.toolbar = null;\n  }\n\n  override renderBlock() {\n    this.setAttribute(BLOCK_ID_ATTR, this.model.id);\n\n    const widgets = repeat(\n      Object.entries(this.widgets),\n      ([id]) => id,\n      ([_, widget]) => widget\n    );\n\n    return html`${this.host.renderModel(this.surfaceBlockModel)}\n      <edgeless-block-portal-container .edgeless=${this}>\n      </edgeless-block-portal-container>\n      <div class=\"widgets-container\">${widgets}</div> `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-edgeless-root': EdgelessRootBlockComponent;\n  }\n}\n"]}