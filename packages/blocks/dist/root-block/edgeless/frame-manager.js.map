{"version":3,"file":"frame-manager.js","sourceRoot":"","sources":["../../../src/root-block/edgeless/frame-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { assertExists, DisposableGroup } from '@blocksuite/global/utils';\nimport type { Doc } from '@blocksuite/store';\nimport { DocCollection } from '@blocksuite/store';\n\nimport type { FrameBlockModel } from '../../frame-block/frame-model.js';\nimport type { EdgelessRootService } from '../../index.js';\nimport type { NoteBlockModel } from '../../note-block/note-model.js';\nimport { Bound, Overlay, type RoughCanvas } from '../../surface-block/index.js';\nimport type { SurfaceBlockModel } from '../../surface-block/surface-model.js';\nimport { EdgelessBlockModel } from './edgeless-block-model.js';\nimport { edgelessElementsBound } from './utils/bound-utils.js';\nimport { isFrameBlock } from './utils/query.js';\n\nconst MIN_FRAME_WIDTH = 800;\nconst MIN_FRAME_HEIGHT = 640;\nconst FRAME_PADDING = 40;\n\nexport function removeContainedFrames(frames: FrameBlockModel[]) {\n  return frames.filter(frame => {\n    const bound = Bound.deserialize(frame.xywh);\n    return frames.some(\n      f => f.id === frame.id || !Bound.deserialize(f.xywh).contains(bound)\n    );\n  });\n}\n\nexport class FrameOverlay extends Overlay {\n  bound: Bound | null = null;\n\n  override render(ctx: CanvasRenderingContext2D, _rc: RoughCanvas): void {\n    if (!this.bound) return;\n    const { x, y, w, h } = this.bound;\n    ctx.beginPath();\n    ctx.strokeStyle = '#1E96EB';\n    ctx.lineWidth = 2;\n    ctx.roundRect(x, y, w, h, 8);\n    ctx.stroke();\n  }\n\n  highlight(frame: FrameBlockModel) {\n    const bound = Bound.deserialize(frame.xywh);\n\n    this.bound = bound;\n    this._renderer.refresh();\n  }\n\n  clear() {\n    this.bound = null;\n    this._renderer.refresh();\n  }\n}\n\nexport function isFrameInner(\n  frame: FrameBlockModel,\n  frames: FrameBlockModel[]\n) {\n  const bound = Bound.deserialize(frame.xywh);\n  return frames.some(\n    f => f.id !== frame.id && Bound.deserialize(f.xywh).contains(bound)\n  );\n}\n\nexport class EdgelessFrameManager {\n  private _disposable = new DisposableGroup();\n\n  constructor(private _rootService: EdgelessRootService) {}\n\n  selectFrame(eles: BlockSuite.EdgelessModelType[]) {\n    const frames = this._rootService.frames;\n    if (frames.length === 0) return null;\n\n    const selectedFrames = eles.filter(ele => isFrameBlock(ele));\n    const bound = edgelessElementsBound(eles);\n    for (let i = frames.length - 1; i >= 0; i--) {\n      const frame = frames[i];\n      if (selectedFrames.includes(frame)) continue;\n      if (Bound.deserialize(frame.xywh).contains(bound)) {\n        return frame;\n      }\n    }\n    return null;\n  }\n\n  getElementsInFrame(frame: FrameBlockModel, fullyContained = true) {\n    const bound = Bound.deserialize(frame.xywh);\n    const elements: BlockSuite.EdgelessModelType[] =\n      this._rootService.layer.canvasGrid.search(bound, true);\n\n    return elements.concat(\n      getBlocksInFrame(this._rootService.doc, frame, fullyContained)\n    );\n  }\n\n  createFrameOnSelected() {\n    const frames = this._rootService.frames;\n    const surfaceModel =\n      this._rootService.doc.getBlockByFlavour('affine:surface')[0];\n\n    let bound = edgelessElementsBound(\n      this._rootService.selection.selectedElements\n    );\n    bound = bound.expand(FRAME_PADDING);\n    if (bound.w < MIN_FRAME_WIDTH) {\n      const offset = (MIN_FRAME_WIDTH - bound.w) / 2;\n      bound = bound.expand(offset, 0);\n    }\n    if (bound.h < MIN_FRAME_HEIGHT) {\n      const offset = (MIN_FRAME_HEIGHT - bound.h) / 2;\n      bound = bound.expand(0, offset);\n    }\n    const id = this._rootService.addBlock(\n      'affine:frame',\n      {\n        title: new DocCollection.Y.Text(`Frame ${frames.length + 1}`),\n        xywh: bound.serialize(),\n      },\n      surfaceModel\n    );\n    const frameModel = this._rootService.getElementById(id);\n    this._rootService.doc.captureSync();\n    assertExists(frameModel);\n\n    this._rootService.selection.set({\n      elements: [frameModel.id],\n      editing: false,\n    });\n\n    return this._rootService.getElementById(id);\n  }\n\n  dispose() {\n    this._disposable.dispose();\n  }\n}\n\nexport function getNotesInFrame(\n  doc: Doc,\n  frame: FrameBlockModel,\n  fullyContained: boolean = true\n) {\n  const bound = Bound.deserialize(frame.xywh);\n\n  return (doc.getBlockByFlavour('affine:note') as NoteBlockModel[]).filter(\n    ele => {\n      const xywh = Bound.deserialize(ele.xywh);\n\n      return fullyContained\n        ? bound.contains(xywh)\n        : bound.isPointInBound([xywh.x, xywh.y]);\n    }\n  ) as NoteBlockModel[];\n}\n\nexport function getBlocksInFrame(\n  doc: Doc,\n  model: FrameBlockModel,\n  fullyContained: boolean = true\n) {\n  const bound = Bound.deserialize(model.xywh);\n  const surfaceModel = doc.getBlockByFlavour([\n    'affine:surface',\n  ]) as SurfaceBlockModel[];\n\n  return (\n    getNotesInFrame(\n      doc,\n      model,\n      fullyContained\n    ) as BlockSuite.EdgelessBlockModelType[]\n  ).concat(\n    surfaceModel[0].children.filter(ele => {\n      if (ele.id === model.id) return;\n      if (ele instanceof EdgelessBlockModel) {\n        const blockBound = Bound.deserialize(ele.xywh);\n        return fullyContained\n          ? bound.contains(blockBound)\n          : bound.containsPoint([blockBound.x, blockBound.y]);\n      }\n\n      return false;\n    }) as BlockSuite.EdgelessBlockModelType[]\n  );\n}\n"]}