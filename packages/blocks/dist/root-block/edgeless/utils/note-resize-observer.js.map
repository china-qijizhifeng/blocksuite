{"version":3,"file":"note-resize-observer.js","sourceRoot":"","sources":["../../../../src/root-block/edgeless/utils/note-resize-observer.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport { Slot, throttle } from '@blocksuite/global/utils';\n\nimport { BLOCK_ID_ATTR } from '../../../_common/consts.js';\nimport { almostEqual } from '../../../_common/utils/math.js';\nimport { matchFlavours } from '../../../_common/utils/model.js';\nimport { buildPath } from '../../../_common/utils/query.js';\n\nexport class NoteResizeObserver {\n  private _observer: ResizeObserver;\n\n  /**\n   * Observation will fire when observation starts if Element is being rendered, and Elementâ€™s size is not 0,0.\n   * https://w3c.github.io/csswg-drafts/resize-observer/#resize-observer-interface\n   *\n   * So we need to cache observed element.\n   */\n  private _cachedElements = new Map<string, Element>();\n\n  private _lastRects = new Map<string, DOMRectReadOnly>();\n\n  slots = {\n    resize: new Slot<Map<string, [DOMRectReadOnly, DOMRectReadOnly?]>>(),\n  };\n\n  constructor() {\n    this._observer = new ResizeObserver(\n      throttle<ResizeObserverEntry[][], typeof this._onResize>(\n        this._onResize,\n        1000 / 60\n      )\n    );\n  }\n\n  private _onResize = (entries: ResizeObserverEntry[]) => {\n    const resizedNotes = new Map<string, [DOMRectReadOnly, DOMRectReadOnly?]>();\n    entries.forEach(entry => {\n      const blockElement = entry.target.closest(`[${BLOCK_ID_ATTR}]`);\n      const id = blockElement?.getAttribute(BLOCK_ID_ATTR);\n      if (!id) return;\n      const lastRect = this._lastRects.get(id);\n      if (\n        lastRect &&\n        almostEqual(lastRect.x, entry.contentRect.x) &&\n        almostEqual(lastRect.y, entry.contentRect.y) &&\n        almostEqual(lastRect.width, entry.contentRect.width) &&\n        almostEqual(lastRect.height, entry.contentRect.height)\n      ) {\n        return;\n      }\n      resizedNotes.set(id, [entry.contentRect, lastRect]);\n      this._lastRects.set(id, entry.contentRect);\n    });\n\n    if (resizedNotes.size) {\n      this.slots.resize.emit(resizedNotes);\n    }\n  };\n\n  resetListener(editorHost: EditorHost) {\n    const doc = editorHost.doc;\n    const unCachedKeys = new Set(this._cachedElements.keys());\n    doc.root?.children.forEach(model => {\n      if (!matchFlavours(model, ['affine:note'])) return;\n\n      const blockId = model.id;\n      unCachedKeys.delete(blockId);\n\n      const blockElement = editorHost.view.viewFromPath(\n        'block',\n        buildPath(model)\n      );\n\n      const container = blockElement?.querySelector(\n        '.affine-note-block-container'\n      );\n\n      const cachedElement = this._cachedElements.get(blockId);\n      if (cachedElement) {\n        if (container === cachedElement && !model.edgeless.collapse) {\n          return;\n        }\n        this._observer.unobserve(cachedElement);\n        this._cachedElements.delete(blockId);\n      }\n\n      if (!container || model.edgeless.collapse) return;\n      this._lastRects.set(blockId, container.getBoundingClientRect());\n      this._observer.observe(container);\n      this._cachedElements.set(blockId, container);\n    });\n\n    unCachedKeys.forEach(k => {\n      const element = this._cachedElements.get(k);\n      if (!element) return;\n      this._observer.unobserve(element);\n    });\n  }\n\n  dispose() {\n    this._observer.disconnect();\n    this.slots.resize.dispose();\n    this._cachedElements.clear();\n    this._lastRects.clear();\n  }\n}\n"]}