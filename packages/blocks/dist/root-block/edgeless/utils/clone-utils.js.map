{"version":3,"file":"clone-utils.js","sourceRoot":"","sources":["../../../../src/root-block/edgeless/utils/clone-utils.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockStdScope } from '@blocksuite/block-std';\nimport { Job } from '@blocksuite/store';\n\nimport { groupBy } from '../../../_common/utils/iterable.js';\nimport { SurfaceGroupLikeModel } from '../../../surface-block/element-model/base.js';\nimport type { SerializedConnectorElement } from '../../../surface-block/element-model/connector.js';\nimport type { SerializedGroupElement } from '../../../surface-block/element-model/group.js';\nimport type { SerializedMindmapElement } from '../../../surface-block/element-model/mindmap.js';\nimport type { NodeDetail } from '../../../surface-block/element-model/utils/mindmap/layout.js';\nimport {\n  ConnectorElementModel,\n  GroupElementModel,\n  MindmapElementModel,\n} from '../../../surface-block/index.js';\nimport { EdgelessBlockModel } from '../edgeless-block-model.js';\nimport type { EdgelessFrameManager } from '../frame-manager.js';\nimport { isFrameBlock } from '../utils/query.js';\n\nexport function getCloneElements(\n  elements: BlockSuite.EdgelessModelType[],\n  frame: EdgelessFrameManager\n) {\n  const set = new Set<BlockSuite.EdgelessModelType>();\n  elements.forEach(element => {\n    set.add(element);\n    if (isFrameBlock(element)) {\n      frame.getElementsInFrame(element).forEach(ele => set.add(ele));\n    } else if (element instanceof SurfaceGroupLikeModel) {\n      const children = element.childElements;\n      getCloneElements(children, frame).forEach(ele => set.add(ele));\n    }\n  });\n  return Array.from(set);\n}\n\nexport async function prepareCloneData(\n  elements: BlockSuite.EdgelessModelType[],\n  std: BlockStdScope\n) {\n  const job = new Job({\n    collection: std.collection,\n  });\n  const res = await Promise.all(\n    elements.map(async element => {\n      const data = await serializeElement(element, elements, job);\n      return data;\n    })\n  );\n  return res.filter(d => !!d);\n}\n\nexport async function serializeElement(\n  element: BlockSuite.EdgelessModelType,\n  elements: BlockSuite.EdgelessModelType[],\n  job: Job\n) {\n  if (element instanceof EdgelessBlockModel) {\n    const snapshot = await job.blockToSnapshot(element);\n    return { ...snapshot };\n  } else if (element instanceof ConnectorElementModel) {\n    return serializeConnector(element, elements);\n  } else {\n    return element.serialize();\n  }\n}\n\nexport function serializeConnector(\n  connector: ConnectorElementModel,\n  elements: BlockSuite.EdgelessModelType[]\n) {\n  const sourceId = connector.source?.id;\n  const targetId = connector.target?.id;\n  const serialized = connector.serialize();\n  // if the source or target element not to be cloned\n  // transfer connector position to absolute path\n  if (sourceId && elements.every(s => s.id !== sourceId)) {\n    serialized.source = { position: connector.absolutePath[0] };\n  }\n  if (targetId && elements.every(s => s.id !== targetId)) {\n    serialized.target = {\n      position: connector.absolutePath[connector.absolutePath.length - 1],\n    };\n  }\n  return serialized;\n}\n\n/**\n * There are interdependencies between elements,\n * so they must be added in a certain order\n * @param elements edgeless model list\n * @returns sorted edgeless model list\n */\nexport function sortEdgelessElements(elements: BlockSuite.EdgelessModelType[]) {\n  const result = groupBy(elements, element => {\n    if (element instanceof ConnectorElementModel) {\n      return 'connector';\n    }\n    if (element instanceof GroupElementModel) {\n      return 'group';\n    }\n    if (element instanceof MindmapElementModel) {\n      return 'mindmap';\n    }\n    return 'default';\n  });\n  return [\n    ...(result.default ?? []),\n    ...(result.connector ?? []),\n    ...(result.group ?? []),\n    ...(result.mindmap ?? []),\n  ];\n}\n\n/**\n * map connector source & target ids\n * @param props serialized element props\n * @param ids old element id to new element id map\n * @returns updated element props\n */\nexport function mapConnectorIds(\n  props: SerializedConnectorElement,\n  ids: Map<string, string>\n) {\n  if (props.source.id) {\n    props.source.id = ids.get(props.source.id);\n  }\n  if (props.target.id) {\n    props.target.id = ids.get(props.target.id);\n  }\n  return props;\n}\n\n/**\n * map group children ids\n * @param props serialized element props\n * @param ids old element id to new element id map\n * @returns updated element props\n */\nexport function mapGroupIds(\n  props: SerializedGroupElement,\n  ids: Map<string, string>\n) {\n  if (props.children) {\n    const newMap: Record<string, boolean> = {};\n    for (const [key, value] of Object.entries(props.children)) {\n      const newKey = ids.get(key);\n      if (newKey) {\n        newMap[newKey] = value;\n      }\n    }\n    props.children = newMap;\n  }\n  return props;\n}\n\n/**\n * map mindmap children & parent ids\n * @param props serialized element props\n * @param ids old element id to new element id map\n * @returns updated element props\n */\nexport function mapMindmapIds(\n  props: SerializedMindmapElement,\n  ids: Map<string, string>\n) {\n  if (props.children) {\n    const newMap: Record<string, NodeDetail> = {};\n    for (const [key, value] of Object.entries(props.children)) {\n      const newKey = ids.get(key);\n      if (value.parent) {\n        const newParent = ids.get(value.parent);\n        value.parent = newParent;\n      }\n      if (newKey) {\n        newMap[newKey] = value;\n      }\n    }\n    props.children = newMap;\n  }\n  return props;\n}\n\nexport function getElementProps(\n  element: BlockSuite.SurfaceModelType,\n  ids: Map<string, string>\n) {\n  if (element instanceof ConnectorElementModel) {\n    const props = element.serialize();\n    return mapConnectorIds(props, ids);\n  }\n  if (element instanceof GroupElementModel) {\n    const props = element.serialize();\n    return mapGroupIds(props, ids);\n  }\n  if (element instanceof MindmapElementModel) {\n    const props = element.serialize();\n    return mapMindmapIds(props, ids);\n  }\n  return element.serialize();\n}\n"]}