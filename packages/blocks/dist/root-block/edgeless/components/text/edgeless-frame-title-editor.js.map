{"version":3,"file":"edgeless-frame-title-editor.js","sourceRoot":"","sources":["../../../../../src/root-block/edgeless/components/text/edgeless-frame-title-editor.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  RangeManager,\n  ShadowlessElement,\n  WithDisposable,\n} from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { html } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { RichText } from '../../../../_common/components/rich-text/rich-text.js';\nimport type {\n  FrameBlockComponent,\n  FrameBlockModel,\n} from '../../../../frame-block/index.js';\nimport { Bound } from '../../../../surface-block/index.js';\nimport type { EdgelessRootBlockComponent } from '../../edgeless-root-block.js';\n\n@customElement('edgeless-frame-title-editor')\nexport class EdgelessFrameTitleEditor extends WithDisposable(\n  ShadowlessElement\n) {\n  get editorHost() {\n    return this.edgeless.host;\n  }\n\n  get inlineEditor() {\n    assertExists(this.richText.inlineEditor);\n    return this.richText.inlineEditor;\n  }\n\n  get inlineEditorContainer() {\n    return this.inlineEditor.rootElement;\n  }\n\n  get frameBlock() {\n    assertExists(this.frameModel.page.root);\n    const block = this.editorHost.view.viewFromPath('block', [\n      this.frameModel.page.root.id,\n      this.frameModel.id,\n    ]) as FrameBlockComponent | null;\n    assertExists(block);\n    return block;\n  }\n\n  @query('rich-text')\n  accessor richText!: RichText;\n\n  @property({ attribute: false })\n  accessor frameModel!: FrameBlockModel;\n\n  @property({ attribute: false })\n  accessor edgeless!: EdgelessRootBlockComponent;\n\n  private _unmount() {\n    // dispose in advance to avoid execute `this.remove()` twice\n    this.disposables.dispose();\n    this.edgeless.service.selection.set({\n      elements: [],\n      editing: false,\n    });\n    this.remove();\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.setAttribute(RangeManager.rangeSyncExcludeAttr, 'true');\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    await this.richText?.updateComplete;\n    return result;\n  }\n\n  override firstUpdated(): void {\n    const dispatcher = this.edgeless.dispatcher;\n    assertExists(dispatcher);\n    this.updateComplete\n      .then(() => {\n        this.inlineEditor.selectAll();\n\n        this.inlineEditor.slots.renderComplete.on(() => {\n          this.requestUpdate();\n        });\n\n        this.disposables.add(\n          dispatcher.add('keyDown', ctx => {\n            const state = ctx.get('keyboardState');\n            if (state.raw.key === 'Enter' && !state.raw.isComposing) {\n              this._unmount();\n              return true;\n            }\n            requestAnimationFrame(() => {\n              this.requestUpdate();\n            });\n            return false;\n          })\n        );\n        this.disposables.add(\n          this.edgeless.service.viewport.viewportUpdated.on(() => {\n            this.requestUpdate();\n          })\n        );\n\n        this.disposables.add(dispatcher.add('click', () => true));\n        this.disposables.add(dispatcher.add('doubleClick', () => true));\n        this.disposables.addFromEvent(\n          this.inlineEditorContainer,\n          'blur',\n          () => {\n            this._unmount();\n          }\n        );\n      })\n      .catch(console.error);\n  }\n\n  override render() {\n    const viewport = this.edgeless.service.viewport;\n    const bound = Bound.deserialize(this.frameModel.xywh);\n    const [x, y] = viewport.toViewCoord(bound.x, bound.y);\n    const isInner = this.edgeless.service.layer.framesGrid.has(\n      this.frameModel.elementBound,\n      true,\n      true,\n      new Set([this.frameModel])\n    );\n\n    const inlineEditorStyle = styleMap({\n      transformOrigin: 'top left',\n      borderRadius: '4px',\n      width: 'fit-content',\n      maxHeight: '30px',\n      lineHeight: '20px',\n      padding: '4px 10px',\n      fontSize: '14px',\n      position: 'absolute',\n      left: (isInner ? x + 8 : x) + 'px',\n      top: (isInner ? y + 8 : y - 38) + 'px',\n      minWidth: '8px',\n      fontFamily: 'var(--affine-font-family)',\n      background: isInner\n        ? 'var(--affine-white)'\n        : 'var(--affine-text-primary-color)',\n      color: isInner\n        ? 'var(--affine-text-secondary-color)'\n        : 'var(--affine-white)',\n      outline: 'none',\n      zIndex: '1',\n      border: `1px solid\n        var(--affine-primary-color)`,\n      boxShadow: `0px 0px 0px 2px rgba(30, 150, 235, 0.3)`,\n    });\n    return html`<rich-text\n      .yText=${this.frameModel.title.yText}\n      .enableFormat=${false}\n      .enableAutoScrollHorizontally=${false}\n      style=${inlineEditorStyle}\n    ></rich-text>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'edgeless-frame-title-editor': EdgelessFrameTitleEditor;\n  }\n}\n"]}