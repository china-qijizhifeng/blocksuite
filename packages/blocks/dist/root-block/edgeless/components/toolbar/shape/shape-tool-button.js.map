{"version":3,"file":"shape-tool-button.js","sourceRoot":"","sources":["../../../../../../src/root-block/edgeless/components/toolbar/shape/shape-tool-button.ts"],"names":[],"mappings":"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","sourcesContent":["import '../../buttons/toolbar-button.js';\nimport './shape-menu.js';\nimport './shape-draggable.js';\n\nimport { cssVar } from '@toeverything/theme';\nimport { css, html, LitElement } from 'lit';\nimport { customElement, state } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport { isTransparent } from '../../../../../_common/theme/css-variables.js';\nimport {\n  DEFAULT_SHAPE_FILL_COLOR,\n  DEFAULT_SHAPE_STROKE_COLOR,\n  ShapeType,\n} from '../../../../../surface-block/elements/shape/consts.js';\nimport { ShapeStyle } from '../../../../../surface-block/index.js';\nimport type { LastProps } from '../../../../../surface-block/managers/edit-session.js';\nimport { ShapeToolController } from '../../../controllers/tools/shape-tool.js';\nimport { getTooltipWithShortcut } from '../../utils.js';\nimport {\n  applyLastProps,\n  observeLastProps,\n} from '../common/observe-last-props.js';\nimport { EdgelessToolbarToolMixin } from '../mixins/tool.mixin.js';\nimport { ShapeComponentConfig } from './shape-menu-config.js';\nimport type { ShapeName } from './shape-tool-element.js';\nimport type { DraggableShape } from './utils.js';\n\nconst { Rect } = ShapeType;\n\n@customElement('edgeless-shape-tool-button')\nexport class EdgelessShapeToolButton extends EdgelessToolbarToolMixin(\n  LitElement\n) {\n  static override styles = css`\n    :host {\n      display: block;\n      width: 100%;\n      height: 100%;\n    }\n    edgeless-toolbar-button,\n    .shapes {\n      width: 100%;\n      height: 64px;\n    }\n  `;\n\n  override type = 'shape' as const;\n\n  @state()\n  accessor states: Partial<LastProps['shape']> = {\n    shapeStyle: ShapeStyle.Scribbled,\n    shapeType: Rect,\n    fillColor: DEFAULT_SHAPE_FILL_COLOR,\n    strokeColor: DEFAULT_SHAPE_STROKE_COLOR,\n    radius: 0,\n  };\n\n  get stateKeys() {\n    return Object.keys(this.states) as Array<keyof typeof this.states>;\n  }\n\n  private _toggleMenu() {\n    if (this.tryDisposePopper()) return;\n    this.setEdgelessTool({\n      type: this.type,\n      shapeType: this.states.shapeType!,\n    });\n    const menu = this.createPopper('edgeless-shape-menu', this);\n    Object.assign(menu.element, {\n      edgeless: this.edgeless,\n      onChange: (props: Record<string, unknown>) => {\n        this.edgeless.service.editPropsStore.record('shape', props);\n        this.updateMenu();\n        this._updateOverlay();\n\n        this.setEdgelessTool({\n          type: 'shape',\n          shapeType: (props.shapeType as ShapeName) ?? this.states.shapeType,\n        });\n      },\n    });\n    this.updateMenu();\n  }\n\n  private _updateOverlay() {\n    const controller = this.edgeless.tools.currentController;\n    if (controller instanceof ShapeToolController) {\n      controller.createOverlay();\n    }\n  }\n\n  private _handleShapeClick(shape: DraggableShape) {\n    const name = shape.name;\n    if (name !== this.states.shapeType) {\n      const shapeConfig = ShapeComponentConfig.find(s => s.name === name);\n      if (!shapeConfig) return;\n      this.edgeless.service.editPropsStore.record('shape', shapeConfig?.value);\n      this.updateMenu();\n    }\n    if (!this.popper) this._toggleMenu();\n  }\n\n  updateMenu() {\n    if (!this.popper) return;\n    Object.assign(this.popper.element, this.states);\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    const { edgeless, states, stateKeys, type } = this;\n    applyLastProps(edgeless.service, type, stateKeys, states);\n\n    this.disposables.add(\n      observeLastProps(\n        edgeless.service,\n        'shape',\n        stateKeys,\n        states,\n        updates => {\n          this.states = { ...this.states, ...updates };\n        }\n      )\n    );\n  }\n\n  override render() {\n    const { active, states } = this;\n    const { fillColor, strokeColor } = states;\n\n    const shapeColor = isTransparent(fillColor!)\n      ? cssVar('white60')\n      : `var(${fillColor})`;\n    const shapeStroke = isTransparent(strokeColor!)\n      ? cssVar('black10')\n      : `var(${strokeColor})`;\n\n    return html`\n      <edgeless-toolbar-button\n        class=\"edgeless-shape-button\"\n        .tooltip=${this.popper ? '' : getTooltipWithShortcut('Shape', 'S')}\n        .tooltipOffset=${5}\n        .active=${active}\n      >\n        <edgeless-toolbar-shape-draggable\n          .edgeless=${this.edgeless}\n          .toolbarContainer=${this.toolbarContainer}\n          class=\"shapes\"\n          style=${styleMap({\n            color: shapeColor,\n            stroke: shapeStroke,\n          })}\n          .color=${shapeColor}\n          .stroke=${shapeStroke}\n          @click=${this._toggleMenu}\n          .onShapeClick=${this._handleShapeClick.bind(this)}\n        >\n        </edgeless-toolbar-shape-draggable>\n      </edgeless-toolbar-button>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'edgeless-shape-tool-button': EdgelessShapeToolButton;\n  }\n}\n"]}