{"version":3,"file":"edgeless-block-portal.js","sourceRoot":"","sources":["../../../../../src/root-block/edgeless/components/block-portal/edgeless-block-portal.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,+DAA+D;AAC/D,OAAO,yBAAyB,CAAC;AACjC,OAAO,2BAA2B,CAAC;AACnC,OAAO,iCAAiC,CAAC;AACzC,OAAO,qCAAqC,CAAC;AAC7C,OAAO,2BAA2B,CAAC;AACnC,OAAO,2BAA2B,CAAC;AACnC,OAAO,2CAA2C,CAAC;AACnD,OAAO,oCAAoC,CAAC;AAC5C,OAAO,yCAAyC,CAAC;AACjD,OAAO,wDAAwD,CAAC;AAEhE,OAAO,EAAE,iBAAiB,EAAE,cAAc,EAAE,MAAM,uBAAuB,CAAC;AAC1E,OAAO,EAAE,YAAY,EAAE,MAAM,0BAA0B,CAAC;AACxD,OAAO,EAAE,GAAG,EAAE,OAAO,EAAE,MAAM,KAAK,CAAC;AACnC,OAAO,EAAE,aAAa,EAAE,QAAQ,EAAE,KAAK,EAAE,KAAK,EAAE,MAAM,mBAAmB,CAAC;AAC1E,OAAO,EAAE,MAAM,EAAE,MAAM,0BAA0B,CAAC;AAClD,OAAO,EAAE,QAAQ,EAAE,MAAM,6BAA6B,CAAC;AACvD,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,YAAY,EAAE,MAAM,oBAAoB,CAAC;AAEjE,OAAO,EAAE,4BAA4B,EAAE,MAAM,oCAAoC,CAAC;AAClF,OAAO,EAAE,IAAI,EAAE,MAAM,uCAAuC,CAAC;AAM7D,OAAO,EAAE,kBAAkB,EAAE,MAAM,+BAA+B,CAAC;AAEnE,OAAO,EAAE,iBAAiB,EAAE,WAAW,EAAE,MAAM,sBAAsB,CAAC;AAStE,MAAM,SAAS,GAAG,IAAI,GAAG,CAAmD;IAC1E,CAAC,cAAc,EAAE,6BAA6B,CAAC;IAC/C,CAAC,aAAa,EAAE,4BAA4B,CAAC;IAC7C,CAAC,cAAc,EAAE,6BAA6B,CAAC;IAC/C,CAAC,iBAAiB,EAAE,gCAAgC,CAAC;IACrD,CAAC,mBAAmB,EAAE,kCAAkC,CAAC;IACzD,CAAC,sBAAsB,EAAE,qCAAqC,CAAC;IAC/D,CAAC,gBAAgB,EAAE,6BAA6B,CAAC;CAClD,CAAC,CAAC;IAGU,4BAA4B;4BADxC,aAAa,CAAC,iCAAiC,CAAC;;;;sBACC,cAAc,CAC9D,iBAAiB,CAClB;;;;;;;;;;;;;;;;;;;;;;;;;4CAFyC,SAAQ,WAEjD;;;;YAqBkB,wFAAc,KAAK,EAAC;YAGpB,8JAAoB,KAAK,GAAC;YAG1B,oKAA2C,IAAI,GAAC;YAEzD,qBAAgB,mEAAG,IAAI,GAAG,EAAsB,EAAC;YAEjD,iCAA4B,GAAG,4BAA4B,CAAC,GAAG,EAAE;gBACvE,IAAI,IAAI,CAAC,oBAAoB,EAAE,EAAE,CAAC;oBAChC,IAAI,CAAC,aAAa,EAAE,CAAC;gBACvB,CAAC;YACH,CAAC,EAAE,IAAI,CAAC,CAAC;YAGA,0FAAsC;YAGtC,oJAA2B;YAG3B,2JAAoC;YAGpC,gJAAuB;YAGvB,mJAA4B;YAErC,wBAAmB,4DAAW,CAAC,EAAC;YAEhC,iBAAY,GAAG,IAAI,GAAG,EAAU,CAAC;YAEjC,yBAAoB,GAAG,4BAA4B,CAAC,GAAG,EAAE;gBACvD,IAAI,CAAC,IAAI,CAAC,QAAQ,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,OAAO;oBAAE,OAAO;gBAErD,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,CAAC,QAAQ,CAAC;gBAClC,MAAM,EAAE,IAAI,EAAE,UAAU,EAAE,UAAU,EAAE,GAAG,OAAO,CAAC,QAAQ,CAAC;gBAC1D,MAAM,EAAE,GAAG,EAAE,GAAG,iBAAiB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;gBAE9C,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,WAAW,CAC9B,qBAAqB,EACrB,GAAG,UAAU,MAAM,UAAU,IAAI,CAClC,CAAC;gBACF,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,WAAW,CAAC,iBAAiB,EAAE,GAAG,GAAG,MAAM,GAAG,IAAI,CAAC,CAAC;gBAEzE,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,WAAW,CAAC,WAAW,EAAE,IAAI,CAAC,iBAAiB,EAAE,CAAC,CAAC;gBACpE,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,GAAG,IAAI,CAAC,QAAQ,EAAE,CAAC;gBAE3C,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,WAAW,CAC/B,2BAA2B,EAC3B,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAC7B,CAAC;YACJ,CAAC,EAAE,IAAI,CAAC,CAAC;QAyRX,CAAC;;;uCAjVE,KAAK,EAAE;6CAGP,KAAK,EAAE;6CAGP,KAAK,EAAE;oCAWP,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;qCAG9B,KAAK,CAAC,2CAA2C,CAAC;wCAGlD,KAAK,CAAC,wBAAwB,CAAC;iCAG/B,KAAK,CAAC,wBAAwB,CAAC;sCAG/B,KAAK,CAAC,cAAc,CAAC;YA5BtB,sLAAiB,WAAW,6BAAX,WAAW,iGAAS;YAGrC,wMAAiB,iBAAiB,6BAAjB,iBAAiB,6GAAS;YAG3C,wMAAiB,iBAAiB,6BAAjB,iBAAiB,6GAA+B;YAWjE,6KAAS,QAAQ,6BAAR,QAAQ,2FAA8B;YAG/C,gLAAS,SAAS,6BAAT,SAAS,6FAAkB;YAGpC,yLAAS,YAAY,6BAAZ,YAAY,mGAAwB;YAG7C,oKAAS,KAAK,6BAAL,KAAK,qFAAkB;YAGhC,mLAAS,UAAU,6BAAV,UAAU,+FAAkB;YApDvC,6KAuWC;;;;QApWC,IAAI,UAAU;YACZ,OAAO,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC;QACpC,CAAC;iBAEe,WAAM,GAAG,GAAG,CAAA;;;;;;;;;;;;;GAa3B,AAbqB,CAapB;QAGF,8BAAqC;QAArC,IAAiB,WAAW,iDAAS;QAArC,IAAiB,WAAW,uDAAS;QAGrC,oCAA2C;QAA3C,IAAiB,iBAAiB,uDAAS;QAA3C,IAAiB,iBAAiB,6DAAS;QAG3C,oCAAiE;QAAjE,IAAiB,iBAAiB,uDAA+B;QAAjE,IAAiB,iBAAiB,6DAA+B;QAWjE,2BAA+C;QAA/C,IAAS,QAAQ,8CAA8B;QAA/C,IAAS,QAAQ,oDAA8B;QAG/C,4BAAoC;QAApC,IAAS,SAAS,+CAAkB;QAApC,IAAS,SAAS,qDAAkB;QAGpC,+BAA6C;QAA7C,IAAS,YAAY,kDAAwB;QAA7C,IAAS,YAAY,wDAAwB;QAG7C,wBAAgC;QAAhC,IAAS,KAAK,2CAAkB;QAAhC,IAAS,KAAK,iDAAkB;QAGhC,6BAAqC;QAArC,IAAS,UAAU,gDAAkB;QAArC,IAAS,UAAU,sDAAkB;QA4BrC;;WAEG;QACK,oBAAoB;YAC1B,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,CAAC,QAAQ,CAAC;YAClC,MAAM,QAAQ,GAAG,OAAO,CAAC,KAAK,CAAC,UAAU,CAAC,MAAM,CAC9C,OAAO,CAAC,QAAQ,CAAC,cAAc,EAC/B,KAAK,EACL,IAAI,CACL,CAAC;YACF,MAAM,QAAQ,GAAG,OAAO,CAAC,KAAK,CAAC,UAAU,CAAC,MAAM,CAC9C,OAAO,CAAC,QAAQ,CAAC,cAAc,EAC/B,KAAK,EACL,IAAI,CACL,CAAC;YAEF,IAAI,IAAI,CAAC,gBAAgB,CAAC,IAAI,KAAK,QAAQ,CAAC,IAAI,GAAG,QAAQ,CAAC,IAAI,EAAE,CAAC;gBACjE,IAAI,CAAC,gBAAgB,GAAG,IAAI,GAAG,CAAC,CAAC,GAAG,QAAQ,EAAE,GAAG,QAAQ,CAAC,CAAC,CAAC;gBAC5D,OAAO,IAAI,CAAC;YACd,CAAC;iBAAM,CAAC;gBACN,KAAK,MAAM,OAAO,IAAI,IAAI,CAAC,gBAAgB,EAAE,CAAC;oBAC5C,IACE,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC;wBACtB,CAAC,QAAQ,CAAC,GAAG,CAAC,OAA0B,CAAC,EACzC,CAAC;wBACD,IAAI,CAAC,gBAAgB,GAAG,IAAI,GAAG,CAAC,CAAC,GAAG,QAAQ,EAAE,GAAG,QAAQ,CAAC,CAAC,CAAC;wBAC5D,OAAO,IAAI,CAAC;oBACd,CAAC;gBACH,CAAC;YACH,CAAC;YAED,OAAO,KAAK,CAAC;QACf,CAAC;QAEO,iBAAiB;YACvB,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,CAAC;YAC1B,MAAM,EAAE,gBAAgB,EAAE,GAAG,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAC;YACxD,IACE,CAAC,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAC,OAAO;gBACnC,gBAAgB,CAAC,MAAM,KAAK,CAAC;gBAC7B,WAAW,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,EAChC,CAAC;gBACD,IAAI,CAAC,iBAAiB,GAAG,gBAAgB,CAAC,CAAC,CAAC,CAAC;YAC/C,CAAC;iBAAM,CAAC;gBACN,IAAI,CAAC,iBAAiB,GAAG,IAAI,CAAC;YAChC,CAAC;QACH,CAAC;QAEO,iBAAiB,CAAC,QAAQ,GAAG,KAAK;YACxC,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,CAAC,QAAQ,CAAC;YAClC,MAAM,EAAE,UAAU,EAAE,UAAU,EAAE,IAAI,EAAE,GAAG,OAAO,CAAC,QAAQ,CAAC;YAE1D,IAAI,QAAQ,EAAE,CAAC;gBACb,OAAO,SAAS,CAAC,GAAG,IAAI,eAAe,CAAC,UAAU,OAAO,CAAC,UAAU,KAAK,CAAC;YAC5E,CAAC;YAED,OAAO,aAAa,UAAU,OAAO,UAAU,aAAa,IAAI,GAAG,CAAC;QACtE,CAAC;QAED,cAAc,CAAC,QAAuB;YACpC,IAAI,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,MAAM,KAAK,QAAQ,CAAC,MAAM,EAAE,CAAC;gBACxD,QAAQ,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;oBACvB,KAAK,CAAC,KAAK,CAAC,WAAW,CAAC,WAAW,EAAE,gCAAgC,CAAC,CAAC;gBACzE,CAAC,CAAC,CAAC;gBACH,IAAI,CAAC,UAAU,CAAC,eAAe,CAAC,GAAG,QAAQ,CAAC,CAAC;YAC/C,CAAC;QACH,CAAC;QAED,gBAAgB,CAAC,EAAU;YACzB,OAAO,IAAI,CAAC,aAAa,CACvB,0BAA0B,EAAE,IAAI,CAC+B,CAAC;QACpE,CAAC;QAEQ,iBAAiB;YACxB,KAAK,CAAC,iBAAiB,EAAE,CAAC;YAC1B,IAAI,CAAC,oBAAoB,EAAE,CAAC;QAC9B,CAAC;QAEQ,YAAY;YACnB,MAAM,EAAE,YAAY,EAAE,QAAQ,EAAE,GAAG,IAAI,CAAC;YAExC,YAAY,CAAC,GAAG,CACd,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,eAAe,CAAC,EAAE,CAAC,GAAG,EAAE;gBAChD,IAAI,CAAC,oBAAoB,EAAE,CAAC;gBAC5B,IAAI,CAAC,4BAA4B,EAAE,CAAC;YACtC,CAAC,CAAC,CACH,CAAC;YAEF,YAAY,CAAC,GAAG,CACd,QAAQ,CAAC,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,YAAY,CAAC,EAAE,CAAC,GAAG,EAAE;gBAChD,IAAI,CAAC,aAAa,EAAE,CAAC;YACvB,CAAC,CAAC,CACH,CAAC;YAEF,YAAY,CAAC,GAAG,CACd,QAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,YAAY,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE;gBAC3C,IACE,CAAC,OAAO,CAAC,IAAI,KAAK,QAAQ,IAAI,OAAO,CAAC,KAAK,CAAC,GAAG,KAAK,MAAM,CAAC;oBAC3D,OAAO,CAAC,IAAI,KAAK,KAAK,EACtB,CAAC;oBACD,MAAM,KAAK,GAAG,QAAQ,CAAC,GAAG,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;oBAEhD,IAAI,KAAK,EAAE,KAAK,YAAY,kBAAkB,EAAE,CAAC;wBAC/C,IAAI,CAAC,4BAA4B,EAAE,CAAC;oBACtC,CAAC;gBACH,CAAC;qBAAM,CAAC;oBACN,IACE,OAAO,IAAI,OAAO;wBAClB,OAAO,CAAC,KAAK,YAAY,kBAAkB,EAC3C,CAAC;wBACD,IAAI,CAAC,4BAA4B,EAAE,CAAC;oBACtC,CAAC;gBACH,CAAC;YACH,CAAC,CAAC,CACH,CAAC;YAEF,YAAY,CAAC,GAAG,CACd,QAAQ,CAAC,KAAK,CAAC,eAAe,CAAC,EAAE,CAAC,GAAG,EAAE;gBACrC,IAAI,CAAC,aAAa,EAAE,CAAC;YACvB,CAAC,CAAC,CACH,CAAC;YAEF,YAAY,CAAC,GAAG,CACd,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE,CAAC,GAAG,EAAE;gBAC/C,IAAI,CAAC,iBAAiB,GAAG,KAAK,CAAC;gBAC/B,IAAI,CAAC,iBAAiB,EAAE,CAAC;YAC3B,CAAC,CAAC,CACH,CAAC;YAEF,YAAY,CAAC,GAAG,CACd,QAAQ,CAAC,KAAK,CAAC,kBAAkB,CAAC,EAAE,CAAC,GAAG,EAAE;gBACxC,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;YAC1B,CAAC,CAAC,CACH,CAAC;YAEF,YAAY,CAAC,GAAG,CACd,QAAQ,CAAC,KAAK,CAAC,gBAAgB,CAAC,EAAE,CAAC,GAAG,EAAE;gBACtC,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;YAC3B,CAAC,CAAC,CACH,CAAC;YAEF,YAAY,CAAC,GAAG,CACd,QAAQ,CAAC,KAAK,CAAC,gBAAgB,CAAC,EAAE,CAAC,GAAG,EAAE;gBACtC,IAAI,CAAC,iBAAiB,GAAG,CAAC,IAAI,CAAC,iBAAiB,CAAC;YACnD,CAAC,CAAC,CACH,CAAC;QACJ,CAAC;QAEQ,MAAM;YACb,MAAM,EAAE,QAAQ,EAAE,gBAAgB,EAAE,GAAG,IAAI,CAAC;YAC5C,MAAM,EAAE,OAAO,EAAE,GAAG,EAAE,OAAO,EAAE,GAAG,QAAQ,CAAC;YAC3C,MAAM,EAAE,QAAQ,EAAE,GAAG,GAAG,CAAC;YACzB,MAAM,EAAE,IAAI,EAAE,GAAG,OAAO,CAAC,QAAQ,CAAC;YAElC,IAAI,CAAC,OAAO;gBAAE,OAAO,OAAO,CAAC;YAE7B,MAAM,MAAM,GAAG,OAAO,CAAC,KAAK,CAAC,MAAM,CAAC;YACpC,MAAM,SAAS,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC;YAC/B,MAAM,eAAe,GACnB,SAAS,EAAE,MAAM,IAAI,CAAC,GAAG,CAAC,SAAS,EAAE,QAAQ,CAAC,MAAM,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC;YACjE,MAAM,MAAM,GAAG,MAAM,CAAC,MAAM,CAC1B,CAAC,GAAG,EAAE,KAAK,EAAE,EAAE;gBACb,IAAI,KAAK,CAAC,IAAI,KAAK,OAAO,EAAE,CAAC;oBAC3B,GAAG,GAAG,GAAG,CAAC,MAAM,CACd,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,KAAK,EAAE,EAAE,CAAC,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC,CAC5D,CAAC;gBACJ,CAAC;gBAED,OAAO,GAAG,CAAC;YACb,CAAC,EACD,EAAgD,CACjD,CAAC;YAEF,OAAO,IAAI,CAAA;;;;wBAIS,IAAI;;;;YAIhB,MAAM,CACN,MAAM,EACN,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,EAAE,EACpB,CAAC,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,EAAE,EAAE;gBACxB,MAAM,MAAM,GAAG,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,EAAE,EAAE;oBAC5D,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE,CAAC;wBAC5B,OAAO,GAAG,KAAK,KAAK,CAAC,OAAO,CAAC;oBAC/B,CAAC;oBACD,OAAO,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;gBACjC,CAAC,CAAC,CAAC;gBACH,YAAY,CACV,MAAM,EACN,8CAA8C,KAAK,CAAC,OAAO,EAAE,CAC9D,CAAC;gBAEF,MAAM,CAAC,CAAC,EAAE,OAAO,CAAC,GAAG,MAAM,CAAC;gBAC5B,MAAM,GAAG,GAAG,YAAY,CAAC,OAAO,CAAC,CAAC;gBAElC,OAAO,IAAI,CAAA,IAAI,GAAG;mCACG,KAAK,CAAC,KAAK;6CACD,KAAK,CAAC,EAAE;+BACtB,KAAK,CAAC,MAAM,GAAG,KAAK;+BACpB,KAAK;iCACH,OAAO;kCACN,QAAQ;qCACL,IAAI,CAAC,YAAY;iDACL,IAAI,CAAC,mBAAmB;yCAChC,IAAI;8BACf,YAAY,KAAK,CAAC,MAAM,GAAG,KAAK,IAAI,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,EAAE,EAAE;yBAC7F,GAAG,GAAG,CAAC;YACpB,CAAC,CACF;;wBAEa,QAAQ;sBACV,OAAO,CAAC,KAAK,CAAC,MAAM;0BAChB,eAAe;6BACZ,IAAI,CAAC,gBAAgB;;;;;;oBAM9B,QAAQ;;;QAGpB,QAAQ,IAAI,IAAI,CAAC,WAAW,IAAI,CAAC,IAAI,CAAC,iBAAiB;gBACvD,CAAC,CAAC,OAAO;gBACT,CAAC,CAAC,IAAI,CAAA;wBACU,QAAQ;0BACN,IAAI,CAAC,iBAAiB;0BACtB;;;oBAGN,QAAQ;2BACD,IAAI,CAAC,iBAAiB;;;;oBAI7B,QAAQ;;KAEvB,CAAC;QACJ,CAAC;QAED,MAAM,CAAC,YAAY,CACjB,KAAwC,EACxC,MAAc,EACd,OAA8B,EAC9B,QAAoC;YAEpC,MAAM,MAAM,GAAG,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,EAAE,EAAE;gBAC5D,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE,CAAC;oBAC5B,OAAO,GAAG,KAAK,KAAK,CAAC,OAAO,CAAC;gBAC/B,CAAC;gBACD,OAAO,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;YACjC,CAAC,CAAC,CAAC;YACH,YAAY,CACV,MAAM,EACN,8CAA8C,KAAK,CAAC,OAAO,EAAE,CAC9D,CAAC;YAEF,MAAM,CAAC,CAAC,EAAE,OAAO,CAAC,GAAG,MAAM,CAAC;YAE5B,MAAM,GAAG,GAAG,OAAO,CAAA,GAAG,YAAY,CAAC,OAAO,CAAC,EAAE,CAAC;YAC9C,OAAO,IAAI,CAAA,IAAI,GAAG;;uBAEC,KAAK,CAAC,KAAK;mBACf,MAAM;mBACN,KAAK;qBACH,OAAO;sBACN,QAAQ;kBACZ,QAAQ,CAAC;gBACf,MAAM;gBACN,OAAO,EAAE,OAAO;gBAChB,QAAQ,EAAE,UAAU;aACrB,CAAC;aACC,GAAG,GAAG,CAAC;QAClB,CAAC;;YAtWU,uDAA4B;;;;;SAA5B,4BAA4B","sourcesContent":["/* eslint-disable lit/binding-positions, lit/no-invalid-html */\nimport './note/edgeless-note.js';\nimport './image/edgeless-image.js';\nimport './bookmark/edgeless-bookmark.js';\nimport './attachment/edgeless-attachment.js';\nimport './frame/edgeless-frame.js';\nimport './embed/edgeless-embed.js';\nimport './edgeless-text/edgeless-edgeless-text.js';\nimport '../rects/edgeless-selected-rect.js';\nimport '../rects/edgeless-dragging-area-rect.js';\nimport '../presentation/edgeless-navigator-black-background.js';\n\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { css, nothing } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\nimport { html, literal, unsafeStatic } from 'lit/static-html.js';\n\nimport { requestThrottledConnectFrame } from '../../../../_common/utils/event.js';\nimport { last } from '../../../../_common/utils/iterable.js';\nimport type { FrameBlockModel } from '../../../../frame-block/frame-model.js';\nimport type { NoteBlockModel } from '../../../../note-block/index.js';\nimport type { GroupElementModel } from '../../../../surface-block/index.js';\nimport type { BlockLayer } from '../../../../surface-block/managers/layer-manager.js';\nimport type { SurfaceBlockComponent } from '../../../../surface-block/surface-block.js';\nimport { EdgelessBlockModel } from '../../edgeless-block-model.js';\nimport type { EdgelessRootBlockComponent } from '../../edgeless-root-block.js';\nimport { getBackgroundGrid, isNoteBlock } from '../../utils/query.js';\nimport type { EdgelessSelectedRect } from '../rects/edgeless-selected-rect.js';\nimport type { EdgelessPortalBase } from './edgeless-portal-base.js';\n\nexport type AutoConnectElement =\n  | NoteBlockModel\n  | FrameBlockModel\n  | GroupElementModel;\n\nconst portalMap = new Map<BlockSuite.EdgelessModelKeyType | RegExp, string>([\n  ['affine:frame', 'edgeless-block-portal-frame'],\n  ['affine:note', 'edgeless-block-portal-note'],\n  ['affine:image', 'edgeless-block-portal-image'],\n  ['affine:bookmark', 'edgeless-block-portal-bookmark'],\n  ['affine:attachment', 'edgeless-block-portal-attachment'],\n  ['affine:edgeless-text', 'edgeless-block-portal-edgeless-text'],\n  [/affine:embed-*/, 'edgeless-block-portal-embed'],\n]);\n\n@customElement('edgeless-block-portal-container')\nexport class EdgelessBlockPortalContainer extends WithDisposable(\n  ShadowlessElement\n) {\n  get isDragging() {\n    return this.selectedRect.dragging;\n  }\n\n  static override styles = css`\n    .affine-block-children-container.edgeless {\n      user-select: none;\n    }\n\n    .surface-layer {\n      position: absolute;\n    }\n\n    .affine-edgeless-layer > [data-portal-block-id] {\n      display: none;\n      position: relative;\n    }\n  `;\n\n  @state()\n  private accessor _isResizing = false;\n\n  @state()\n  private accessor _enableNoteSlicer = false;\n\n  @state()\n  private accessor _slicerAnchorNote: NoteBlockModel | null = null;\n\n  private _visibleElements = new Set<EdgelessBlockModel>();\n\n  private _updateOnVisibleBlocksChange = requestThrottledConnectFrame(() => {\n    if (this._updateVisibleBlocks()) {\n      this.requestUpdate();\n    }\n  }, this);\n\n  @property({ attribute: false })\n  accessor edgeless!: EdgelessRootBlockComponent;\n\n  @query('.affine-block-children-container.edgeless')\n  accessor container!: HTMLDivElement;\n\n  @query('edgeless-selected-rect')\n  accessor selectedRect!: EdgelessSelectedRect;\n\n  @query('.affine-edgeless-layer')\n  accessor layer!: HTMLDivElement;\n\n  @query('.canvas-slot')\n  accessor canvasSlot!: HTMLDivElement;\n\n  concurrentRendering: number = 2;\n\n  renderingSet = new Set<string>();\n\n  refreshLayerViewport = requestThrottledConnectFrame(() => {\n    if (!this.edgeless || !this.edgeless.surface) return;\n\n    const { service } = this.edgeless;\n    const { zoom, translateX, translateY } = service.viewport;\n    const { gap } = getBackgroundGrid(zoom, true);\n\n    this.container.style.setProperty(\n      'background-position',\n      `${translateX}px ${translateY}px`\n    );\n    this.container.style.setProperty('background-size', `${gap}px ${gap}px`);\n\n    this.layer.style.setProperty('transform', this._getLayerViewport());\n    this.layer.dataset.scale = zoom.toString();\n\n    this.canvasSlot.style.setProperty(\n      '--canvas-transform-offset',\n      this._getLayerViewport(true)\n    );\n  }, this);\n\n  /**\n   * @returns true if the visible elements have changed\n   */\n  private _updateVisibleBlocks() {\n    const { service } = this.edgeless;\n    const blockSet = service.layer.blocksGrid.search(\n      service.viewport.viewportBounds,\n      false,\n      true\n    );\n    const frameSet = service.layer.framesGrid.search(\n      service.viewport.viewportBounds,\n      false,\n      true\n    );\n\n    if (this._visibleElements.size !== blockSet.size + frameSet.size) {\n      this._visibleElements = new Set([...blockSet, ...frameSet]);\n      return true;\n    } else {\n      for (const element of this._visibleElements) {\n        if (\n          !blockSet.has(element) &&\n          !frameSet.has(element as FrameBlockModel)\n        ) {\n          this._visibleElements = new Set([...blockSet, ...frameSet]);\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  private _updateNoteSlicer() {\n    const { edgeless } = this;\n    const { selectedElements } = edgeless.service.selection;\n    if (\n      !edgeless.service.selection.editing &&\n      selectedElements.length === 1 &&\n      isNoteBlock(selectedElements[0])\n    ) {\n      this._slicerAnchorNote = selectedElements[0];\n    } else {\n      this._slicerAnchorNote = null;\n    }\n  }\n\n  private _getLayerViewport(negative = false) {\n    const { service } = this.edgeless;\n    const { translateX, translateY, zoom } = service.viewport;\n\n    if (negative) {\n      return `scale(${1 / zoom}) translate(${-translateX}px, ${-translateY}px)`;\n    }\n\n    return `translate(${translateX}px, ${translateY}px) scale(${zoom})`;\n  }\n\n  setSlotContent(children: HTMLElement[]) {\n    if (this.canvasSlot.children.length !== children.length) {\n      children.forEach(child => {\n        child.style.setProperty('transform', 'var(--canvas-transform-offset)');\n      });\n      this.canvasSlot.replaceChildren(...children);\n    }\n  }\n\n  getPortalElement(id: string) {\n    return this.querySelector(\n      `[data-portal-block-id=\"${id}\"]`\n    ) as EdgelessPortalBase<BlockSuite.EdgelessBlockModelType> | null;\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    this._updateVisibleBlocks();\n  }\n\n  override firstUpdated() {\n    const { _disposables, edgeless } = this;\n\n    _disposables.add(\n      edgeless.service.viewport.viewportUpdated.on(() => {\n        this.refreshLayerViewport();\n        this._updateOnVisibleBlocksChange();\n      })\n    );\n\n    _disposables.add(\n      edgeless.service.layer.slots.layerUpdated.on(() => {\n        this.requestUpdate();\n      })\n    );\n\n    _disposables.add(\n      edgeless.doc.slots.blockUpdated.on(payload => {\n        if (\n          (payload.type === 'update' && payload.props.key === 'xywh') ||\n          payload.type === 'add'\n        ) {\n          const block = edgeless.doc.getBlock(payload.id);\n\n          if (block?.model instanceof EdgelessBlockModel) {\n            this._updateOnVisibleBlocksChange();\n          }\n        } else {\n          if (\n            'model' in payload &&\n            payload.model instanceof EdgelessBlockModel\n          ) {\n            this._updateOnVisibleBlocksChange();\n          }\n        }\n      })\n    );\n\n    _disposables.add(\n      edgeless.slots.readonlyUpdated.on(() => {\n        this.requestUpdate();\n      })\n    );\n\n    _disposables.add(\n      edgeless.service.selection.slots.updated.on(() => {\n        this._enableNoteSlicer = false;\n        this._updateNoteSlicer();\n      })\n    );\n\n    _disposables.add(\n      edgeless.slots.elementResizeStart.on(() => {\n        this._isResizing = true;\n      })\n    );\n\n    _disposables.add(\n      edgeless.slots.elementResizeEnd.on(() => {\n        this._isResizing = false;\n      })\n    );\n\n    _disposables.add(\n      edgeless.slots.toggleNoteSlicer.on(() => {\n        this._enableNoteSlicer = !this._enableNoteSlicer;\n      })\n    );\n  }\n\n  override render() {\n    const { edgeless, _visibleElements } = this;\n    const { surface, doc, service } = edgeless;\n    const { readonly } = doc;\n    const { zoom } = service.viewport;\n\n    if (!surface) return nothing;\n\n    const layers = service.layer.layers;\n    const lastLayer = last(layers);\n    const frameStartIndex =\n      lastLayer?.zIndex ?? 1 + (lastLayer?.elements.length ?? 0) + 1;\n    const blocks = layers.reduce(\n      (pre, layer) => {\n        if (layer.type === 'block') {\n          pre = pre.concat(\n            layer.elements.map((block, index) => [block, layer, index])\n          );\n        }\n\n        return pre;\n      },\n      [] as [EdgelessBlockModel, BlockLayer, number][]\n    );\n\n    return html`\n      <div class=\"affine-block-children-container edgeless\">\n        <div\n          class=\"affine-edgeless-layer\"\n          data-scale=\"${zoom}\"\n          data-translate=\"true\"\n        >\n          <div class=\"canvas-slot\"></div>\n          ${repeat(\n            blocks,\n            block => block[0].id,\n            ([block, layer, index]) => {\n              const target = Array.from(portalMap.entries()).find(([key]) => {\n                if (typeof key === 'string') {\n                  return key === block.flavour;\n                }\n                return key.test(block.flavour);\n              });\n              assertExists(\n                target,\n                `Unknown block flavour for edgeless portal: ${block.flavour}`\n              );\n\n              const [_, tagName] = target;\n              const tag = unsafeStatic(tagName);\n\n              return html`<${tag}\n                      data-index=${block.index}\n                      data-portal-block-id=${block.id}\n                      .index=${layer.zIndex + index}\n                      .model=${block}\n                      .surface=${surface}\n                      .edgeless=${edgeless}\n                      .updatingSet=${this.renderingSet}\n                      .concurrentUpdatingCount=${this.concurrentRendering}\n                      .portalContainer=${this}\n                      style=${`z-index: ${layer.zIndex + index};${_visibleElements.has(block) ? 'display:block' : ''}`}\n                    ></${tag}>`;\n            }\n          )}\n          <edgeless-frames-container\n            .edgeless=${edgeless}\n            .frames=${service.layer.frames}\n            .startIndex=${frameStartIndex}\n            .visibleFrames=${this._visibleElements}\n          >\n          </edgeless-frames-container>\n        </div>\n      </div>\n      <edgeless-dragging-area-rect\n        .edgeless=${edgeless}\n      ></edgeless-dragging-area-rect>\n\n      ${readonly || this._isResizing || !this._enableNoteSlicer\n        ? nothing\n        : html`<note-slicer\n            .edgeless=${edgeless}\n            .anchorNote=${this._slicerAnchorNote}\n          ></note-slicer>`}\n\n      <edgeless-selected-rect\n        .edgeless=${edgeless}\n        .autoCompleteOff=${this._enableNoteSlicer}\n      ></edgeless-selected-rect>\n\n      <edgeless-navigator-black-background\n        .edgeless=${edgeless}\n      ></edgeless-navigator-black-background>\n    `;\n  }\n\n  static renderPortal(\n    block: BlockSuite.EdgelessBlockModelType,\n    zIndex: number,\n    surface: SurfaceBlockComponent,\n    edgeless: EdgelessRootBlockComponent\n  ) {\n    const target = Array.from(portalMap.entries()).find(([key]) => {\n      if (typeof key === 'string') {\n        return key === block.flavour;\n      }\n      return key.test(block.flavour);\n    });\n    assertExists(\n      target,\n      `Unknown block flavour for edgeless portal: ${block.flavour}`\n    );\n\n    const [_, tagName] = target;\n\n    const tag = literal`${unsafeStatic(tagName)}`;\n    return html`<${tag}\n          slot=\"blocks\"\n          data-index=${block.index}\n          .index=${zIndex}\n          .model=${block}\n          .surface=${surface}\n          .edgeless=${edgeless}\n          style=${styleMap({\n            zIndex,\n            display: 'block',\n            position: 'relative',\n          })}\n        ></${tag}>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'edgeless-block-portal-container': EdgelessBlockPortalContainer;\n  }\n}\n"]}