{"version":3,"file":"surface-ref-toolbar.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/surface-ref-toolbar/surface-ref-toolbar.ts"],"names":[],"mappings":"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","sourcesContent":["import { WidgetElement } from '@blocksuite/block-std';\nimport { offset, shift } from '@floating-ui/dom';\nimport { html, nothing } from 'lit';\nimport { customElement } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport { HoverController } from '../../../_common/components/hover/controller.js';\nimport { isPeekable, peek } from '../../../_common/components/peekable.js';\nimport { toast } from '../../../_common/components/toast.js';\nimport { PAGE_HEADER_HEIGHT } from '../../../_common/consts.js';\nimport { EdgelessModeIcon } from '../../../_common/icons/edgeless.js';\nimport {\n  CaptionIcon,\n  CenterPeekIcon,\n  CopyIcon,\n  DeleteIcon,\n  DownloadIcon,\n} from '../../../_common/icons/text.js';\nimport { downloadBlob } from '../../../_common/utils/filesys.js';\nimport type {\n  SurfaceRefBlockComponent,\n  SurfaceRefBlockModel,\n} from '../../../surface-ref-block/index.js';\nimport { edgelessToBlob, writeImageBlobToClipboard } from './utils.js';\n\nexport const AFFINE_SURFACE_REF_TOOLBAR = 'affine-surface-ref-toolbar';\n\n@customElement(AFFINE_SURFACE_REF_TOOLBAR)\nexport class AffineSurfaceRefToolbar extends WidgetElement<\n  SurfaceRefBlockModel,\n  SurfaceRefBlockComponent\n> {\n  private _hoverController = new HoverController(\n    this,\n    ({ abortController }) => {\n      const surfaceRefBlock = this.blockElement;\n      const selection = this.host.selection;\n\n      const textSelection = selection.find('text');\n      if (\n        !!textSelection &&\n        (!!textSelection.to || !!textSelection.from.length)\n      ) {\n        return null;\n      }\n\n      const blockSelections = selection.filter('block');\n      if (\n        blockSelections.length > 1 ||\n        (blockSelections.length === 1 &&\n          blockSelections[0].blockId !== surfaceRefBlock.blockId)\n      ) {\n        return null;\n      }\n\n      return {\n        template: SurfaceRefToolbarOptions({\n          blockElement: this.blockElement,\n          model: this.blockElement.model,\n          abortController,\n        }),\n        computePosition: {\n          referenceElement: this.blockElement,\n          placement: 'top-start',\n          middleware: [\n            offset({\n              mainAxis: 12,\n              crossAxis: 10,\n            }),\n            shift({\n              crossAxis: true,\n              padding: {\n                top: PAGE_HEADER_HEIGHT + 12,\n                bottom: 12,\n                right: 12,\n              },\n            }),\n          ],\n          autoUpdate: true,\n        },\n      };\n    }\n  );\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this._hoverController.setReference(this.blockElement);\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_SURFACE_REF_TOOLBAR]: AffineSurfaceRefToolbar;\n  }\n}\n\nfunction SurfaceRefToolbarOptions(options: {\n  blockElement: SurfaceRefBlockComponent;\n  model: SurfaceRefBlockModel;\n  abortController: AbortController;\n}) {\n  const { blockElement, model, abortController } = options;\n  const readonly = model.doc.readonly;\n  const hasValidReference = !!blockElement.referenceModel;\n\n  return html`\n    <style>\n      :host {\n        z-index: 1;\n      }\n      .surface-ref-toolbar-container {\n        display: flex;\n        box-sizing: border-box;\n        box-shadow: var(--affine-shadow-2);\n        border-radius: 8px;\n        list-style: none;\n        padding: 4px 8px;\n        gap: 4px;\n        align-items: center;\n        background-color: var(--affine-background-overlay-panel-color);\n        margin: 0;\n      }\n      .delete-button:hover {\n        background: var(--affine-background-error-color);\n        color: var(--affine-error-color);\n      }\n      .delete-button:hover > svg {\n        color: var(--affine-error-color);\n      }\n\n      .divider {\n        width: 1px;\n        height: 24px;\n        background-color: var(--affine-border-color);\n        margin: 0 8px;\n      }\n\n      .view-in-edgeless-button {\n        font-size: 12px;\n        color: var(--affine-text-secondary-color);\n        font-weight: 600;\n        gap: 2px;\n      }\n    </style>\n\n    <div class=\"surface-ref-toolbar-container\">\n      <icon-button\n        ?hidden=${!hasValidReference || readonly}\n        class=\"view-in-edgeless-button\"\n        text=\"View in Edgeless\"\n        width=\"fit-content\"\n        @click=${() => blockElement.viewInEdgeless()}\n        >${EdgelessModeIcon}\n      </icon-button>\n\n      <div\n        class=\"divider\"\n        ?hidden=${readonly}\n        style=${styleMap({\n          display: hasValidReference ? undefined : 'none',\n        })}\n      ></div>\n\n      <icon-button\n        size=\"32px\"\n        ?hidden=${readonly}\n        @click=${() => {\n          abortController.abort();\n          blockElement.captionElement.show();\n        }}\n      >\n        ${CaptionIcon}\n\n        <affine-tooltip tip-position=\"top\">Caption</affine-tooltip>\n      </icon-button>\n\n      <icon-button\n        size=\"32px\"\n        ?hidden=${!hasValidReference}\n        @click=${() => {\n          const referencedModel = blockElement.referenceModel;\n\n          if (!referencedModel) return;\n\n          edgelessToBlob(blockElement.host, {\n            surfaceRefBlock: blockElement,\n            surfaceRenderer: blockElement.surfaceRenderer,\n            edgelessElement: referencedModel,\n            blockContainer: blockElement.portal,\n          })\n            .then(blob => {\n              const fileName =\n                'title' in referencedModel\n                  ? referencedModel.title?.toString() ?? 'Edgeless Content'\n                  : 'Edgeless Content';\n\n              downloadBlob(blob, fileName);\n            })\n            .catch(err => {\n              console.error(err);\n            });\n        }}\n      >\n        ${DownloadIcon}\n\n        <affine-tooltip tip-position=\"top\">Download</affine-tooltip>\n      </icon-button>\n\n      ${isPeekable(blockElement)\n        ? html`<icon-button\n            size=\"32px\"\n            ?hidden=${!hasValidReference}\n            @click=${() => {\n              peek(blockElement);\n            }}\n          >\n            ${CenterPeekIcon}\n            <affine-tooltip tip-position=\"top\"\n              >Open in center peek</affine-tooltip\n            >\n          </icon-button>`\n        : nothing}\n\n      <icon-button\n        size=\"32px\"\n        ?hidden=${!hasValidReference}\n        @click=${() => {\n          edgelessToBlob(blockElement.host, {\n            surfaceRefBlock: blockElement,\n            surfaceRenderer: blockElement.surfaceRenderer,\n            edgelessElement:\n              blockElement.referenceModel as BlockSuite.EdgelessModelType,\n            blockContainer: blockElement.portal,\n          })\n            .then(blob => {\n              return writeImageBlobToClipboard(blob);\n            })\n            .then(() => {\n              toast(blockElement.host, 'Copied image to clipboard');\n            })\n            .catch(err => {\n              console.error(err);\n            });\n        }}\n      >\n        ${CopyIcon}\n\n        <affine-tooltip tip-position=\"top\">Copy to clipboard</affine-tooltip>\n      </icon-button>\n\n      <icon-button\n        class=\"delete-button\"\n        size=\"32px\"\n        ?hidden=${readonly}\n        @click=\"${() => {\n          model.doc.deleteBlock(model);\n          abortController.abort();\n        }}\"\n      >\n        ${DeleteIcon}\n\n        <affine-tooltip tip-position=\"top\">Delete</affine-tooltip>\n      </icon-button>\n    </div>\n  `;\n}\n"]}