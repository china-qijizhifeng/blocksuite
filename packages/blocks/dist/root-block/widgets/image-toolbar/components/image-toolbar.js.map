{"version":3,"file":"image-toolbar.js","sourceRoot":"","sources":["../../../../../src/root-block/widgets/image-toolbar/components/image-toolbar.ts"],"names":[],"mappings":"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","sourcesContent":["import { assertExists, noop } from '@blocksuite/global/utils';\nimport { flip, offset } from '@floating-ui/dom';\nimport { html, LitElement, nothing } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\n\nimport { MorePopupMenu } from '../../../../_common/components/more-popup-menu/more-popup-menu.js';\nimport { createLitPortal } from '../../../../_common/components/portal.js';\nimport { MoreVerticalIcon } from '../../../../_common/icons/edgeless.js';\nimport { stopPropagation } from '../../../../_common/utils/event.js';\nimport type { ImageBlockComponent } from '../../../../image-block/image-block.js';\nimport { styles } from '../styles.js';\nimport type { ImageConfigItem, MoreMenuConfigItem } from '../type.js';\nimport { ConfigRenderer, MoreMenuRenderer } from '../utils.js';\n\n@customElement('affine-image-toolbar')\nexport class AffineImageToolbar extends LitElement {\n  get _items() {\n    return ConfigRenderer(\n      this.blockElement,\n      this.abortController,\n      this.config,\n      this.closeCurrentMenu\n    );\n  }\n\n  static override styles = styles;\n\n  @query('.image-toolbar-button.more')\n  private accessor _moreButton!: HTMLElement;\n\n  @state()\n  private accessor _moreMenuOpen = false;\n\n  private _popMenuAbortController: AbortController | null = null;\n\n  private _currentOpenMenu: AbortController | null = null;\n\n  @property({ attribute: false })\n  accessor blockElement!: ImageBlockComponent;\n\n  @property({ attribute: false })\n  accessor abortController!: AbortController;\n\n  @property({ attribute: false })\n  accessor config!: ImageConfigItem[];\n\n  @property({ attribute: false })\n  accessor moreMenuConfig!: MoreMenuConfigItem[];\n\n  @property({ attribute: false })\n  accessor onActiveStatusChange: (active: boolean) => void = noop;\n\n  private _clearPopMenu() {\n    if (this._popMenuAbortController) {\n      this._popMenuAbortController.abort();\n      this._popMenuAbortController = null;\n    }\n  }\n\n  private _toggleMoreMenu() {\n    // If the menu we're trying to open is already open, return\n    if (\n      this._currentOpenMenu &&\n      !this._currentOpenMenu.signal.aborted &&\n      this._currentOpenMenu === this._popMenuAbortController\n    ) {\n      this.closeCurrentMenu();\n      this._moreMenuOpen = false;\n      return;\n    }\n\n    this.closeCurrentMenu();\n    this._popMenuAbortController = new AbortController();\n    this._popMenuAbortController.signal.addEventListener('abort', () => {\n      this._moreMenuOpen = false;\n      this.onActiveStatusChange(false);\n    });\n    this.onActiveStatusChange(true);\n\n    this._currentOpenMenu = this._popMenuAbortController;\n\n    const moreMenu = new MorePopupMenu();\n    const moreItems = MoreMenuRenderer(\n      this.blockElement,\n      this._popMenuAbortController,\n      this.moreMenuConfig\n    );\n    moreMenu.items = moreItems;\n\n    assertExists(this._moreButton);\n    createLitPortal({\n      template: moreMenu,\n      container: this.blockElement.host,\n      // stacking-context(editor-host)\n      portalStyles: {\n        zIndex: 'var(--affine-z-index-popover)',\n      },\n      computePosition: {\n        referenceElement: this._moreButton,\n        placement: 'bottom-start',\n        middleware: [flip(), offset(4)],\n        autoUpdate: { animationFrame: true },\n      },\n      abortController: this._popMenuAbortController,\n      closeOnClickAway: true,\n    });\n    this._moreMenuOpen = true;\n  }\n\n  closeCurrentMenu = () => {\n    if (this._currentOpenMenu && !this._currentOpenMenu.signal.aborted) {\n      this._currentOpenMenu.abort();\n      this._currentOpenMenu = null;\n    }\n  };\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this.closeCurrentMenu();\n    this._clearPopMenu();\n  }\n\n  override render() {\n    return html`\n      <div\n        class=\"affine-image-toolbar-container\"\n        @pointerdown=${stopPropagation}\n      >\n        ${this._items}\n        <icon-button\n          class=\"image-toolbar-button more\"\n          size=\"24px\"\n          @click=${() => this._toggleMoreMenu()}\n        >\n          ${MoreVerticalIcon}\n          ${!this._moreMenuOpen\n            ? html`<affine-tooltip>More</affine-tooltip>`\n            : nothing}\n        </icon-button>\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-image-toolbar': AffineImageToolbar;\n  }\n}\n"]}