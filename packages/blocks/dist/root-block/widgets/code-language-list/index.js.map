{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/code-language-list/index.ts"],"names":[],"mappings":"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","sourcesContent":["import './components/lang-button.js';\n\nimport { WidgetElement } from '@blocksuite/block-std';\nimport { sleep } from '@blocksuite/global/utils';\nimport { offset } from '@floating-ui/dom';\nimport { html } from 'lit';\nimport { customElement } from 'lit/decorators.js';\n\nimport { HoverController } from '../../../_common/components/index.js';\nimport type { CodeBlockModel } from '../../../code-block/code-model.js';\nimport type { CodeBlockComponent } from '../../../code-block/index.js';\n\nexport const AFFINE_CODE_LANGUAGE_LIST_WIDGET =\n  'affine-code-language-list-widget';\n\n@customElement(AFFINE_CODE_LANGUAGE_LIST_WIDGET)\nexport class AffineCodeLanguageListWidget extends WidgetElement<\n  CodeBlockModel,\n  CodeBlockComponent\n> {\n  private _isActivated = false;\n\n  private _hoverController = new HoverController(\n    this,\n    () => {\n      const codeBlock = this.blockElement;\n      const selection = this.host.selection;\n\n      const textSelection = selection.find('text');\n      if (\n        !!textSelection &&\n        (!!textSelection.to || !!textSelection.from.length)\n      ) {\n        return null;\n      }\n\n      const blockSelections = selection.filter('block');\n      if (\n        blockSelections.length > 1 ||\n        (blockSelections.length === 1 &&\n          blockSelections[0].blockId !== codeBlock.blockId)\n      ) {\n        return null;\n      }\n\n      return {\n        template: html`<language-list-button\n          .blockElement=${this.blockElement}\n          .onActiveStatusChange=${async (active: boolean) => {\n            this._isActivated = active;\n            if (!active) {\n              // Wait a moment for the user to see the result.\n              // This is to prevent the language list from closing immediately.\n              //\n              // This snippet is not perfect, it only checks the hover status at the moment.\n              if (this._hoverController.isHovering) return;\n              await sleep(1000);\n              if (this._hoverController.isHovering || this._isActivated) return;\n              this._hoverController.abort();\n            }\n          }}\n        >\n        </language-list-button>`,\n        // stacking-context(editor-host)\n        portalStyles: {\n          zIndex: 'var(--affine-z-index-popover)',\n        },\n        container: this.blockElement,\n        computePosition: {\n          referenceElement: this.blockElement,\n          placement: 'left-start',\n          middleware: [offset({ mainAxis: -5, crossAxis: 5 })],\n          autoUpdate: true,\n        },\n      };\n    },\n    {\n      allowMultiple: true,\n    }\n  );\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this._hoverController.setReference(this.blockElement);\n    this._hoverController.onAbort = () => {\n      // If the language list is opened, don't close it.\n      if (this._isActivated) return;\n      this._hoverController.abort();\n      return;\n    };\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_CODE_LANGUAGE_LIST_WIDGET]: AffineCodeLanguageListWidget;\n  }\n}\n"]}