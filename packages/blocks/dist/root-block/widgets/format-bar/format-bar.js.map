{"version":3,"file":"format-bar.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/format-bar/format-bar.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAO,uCAAuC,CAAC;AAO/C,OAAO,EAAE,aAAa,EAAE,MAAM,uBAAuB,CAAC;AACtD,OAAO,EAAE,YAAY,EAAE,eAAe,EAAE,MAAM,0BAA0B,CAAC;AACzE,OAAO,EACL,UAAU,EACV,eAAe,EACf,MAAM,EACN,MAAM,EAGN,KAAK,GACN,MAAM,kBAAkB,CAAC;AAC1B,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,KAAK,CAAC;AACpC,OAAO,EAAE,aAAa,EAAE,KAAK,EAAE,KAAK,EAAE,MAAM,mBAAmB,CAAC;AAEhE,OAAO,EACL,eAAe,GAEhB,MAAM,sCAAsC,CAAC;AAE9C,OAAO,EAAE,eAAe,EAAE,MAAM,iCAAiC,CAAC;AAClE,OAAO,EAAE,aAAa,EAAE,MAAM,iCAAiC,CAAC;AAChE,OAAO,EAAE,iBAAiB,EAAE,MAAM,uCAAuC,CAAC;AAC1E,OAAO,EAAE,aAAa,EAAE,MAAM,oCAAoC,CAAC;AACnE,OAAO,EAAE,cAAc,EAAE,MAAM,iCAAiC,CAAC;AACjE,OAAO,EAIL,oBAAoB,GACrB,MAAM,aAAa,CAAC;AACrB,OAAO,EAAE,cAAc,EAAE,MAAM,aAAa,CAAC;AAE7C,MAAM,CAAC,MAAM,wBAAwB,GAAG,0BAA0B,CAAC;IAGtD,qBAAqB;4BADjC,aAAa,CAAC,wBAAwB,CAAC;;;;sBACG,aAAa;;;;;;;;;;;;;;;;qCAArB,SAAQ,WAAa;;;;qCAqBrD,KAAK,EAAE;wCAGP,KAAK,EAAE;kDAGP,KAAK,EAAE;4CAWP,KAAK,CAAC,IAAI,wBAAwB,EAAE,CAAC;uCAGrC,KAAK,EAAE;YAnBR,gLAAiB,SAAS,6BAAT,SAAS,6FAAS;YAGnC,yLAAiB,YAAY,6BAAZ,YAAY,mGAAgD;YAG7E,uNAAiB,sBAAsB,6BAAtB,sBAAsB,uHAAsB;YAW7D,qMAAS,gBAAgB,6BAAhB,gBAAgB,2GAA4B;YAGrD,sLAAS,WAAW,6BAAX,WAAW,iGAA6B;YA1CnD,6KAymBC;;;;QAxmBC,IAAY,iBAAiB;YAC3B,OAAO,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC;QAC7B,CAAC;QAED,IAAI,WAAW;YACb,OAAO,IAAI,CAAC,YAAY,CAAC;QAC3B,CAAC;QAED,IAAI,qBAAqB;YACvB,OAAO,IAAI,CAAC,sBAAsB,CAAC;QACrC,CAAC;QAED,IAAI,WAAW;YACb,MAAM,EAAE,GAAG,QAAQ,CAAC,YAAY,EAAE,CAAC;YACnC,IAAI,CAAC,EAAE,IAAI,EAAE,CAAC,UAAU,KAAK,CAAC;gBAAE,OAAO,IAAI,CAAC;YAC5C,OAAO,EAAE,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;QAC1B,CAAC;iBAEe,WAAM,GAAG,cAAc,AAAjB,CAAkB;QAGxC,4BAAmC;QAAnC,IAAiB,SAAS,+CAAS;QAAnC,IAAiB,SAAS,qDAAS;QAGnC,+BAA6E;QAA7E,IAAiB,YAAY,kDAAgD;QAA7E,IAAiB,YAAY,wDAAgD;QAG7E,yCAA6D;QAA7D,IAAiB,sBAAsB,4DAAsB;QAA7D,IAAiB,sBAAsB,kEAAsB;QAW7D,mCAAqD;QAArD,IAAS,gBAAgB,sDAA4B;QAArD,IAAS,gBAAgB,4DAA4B;QAGrD,8BAAiD;QAAjD,IAAS,WAAW,iDAA6B;QAAjD,IAAS,WAAW,uDAA6B;QAEzC,MAAM;YACZ,IAAI,CAAC,YAAY,GAAG,MAAM,CAAC;YAC3B,IAAI,CAAC,sBAAsB,GAAG,EAAE,CAAC;QACnC,CAAC;QAEO,cAAc;YACpB,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,cAAc,CAAC,UAAU,CACjD,IAAI,CAAC,GAAG,CAAC,eAAe,CACzB,CAAC;YACF,IAAI,QAAQ;gBAAE,OAAO,KAAK,CAAC;YAE3B,IACE,IAAI,CAAC,WAAW,KAAK,OAAO;gBAC5B,IAAI,CAAC,sBAAsB,EAAE,CAAC,CAAC,CAAC,EAAE,OAAO,KAAK,oBAAoB,EAClE,CAAC;gBACD,OAAO,KAAK,CAAC;YACf,CAAC;YAED,IACE,IAAI,CAAC,WAAW,KAAK,OAAO;gBAC5B,IAAI,CAAC,sBAAsB,CAAC,MAAM,KAAK,CAAC,EACxC,CAAC;gBACD,MAAM,aAAa,GAAG,IAAI,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC;gBACrD,IACE,CAAC,aAAa,CAAC,aAAa,CAAC,KAAK,EAAE;oBAClC,kBAAkB;oBAClB,aAAa;oBACb,aAAa;oBACb,cAAc;iBACf,CAAC,EACF,CAAC;oBACD,OAAO,KAAK,CAAC;gBACf,CAAC;YACH,CAAC;YAED,IAAI,IAAI,CAAC,WAAW,KAAK,MAAM,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;gBAClD,OAAO,KAAK,CAAC;YACf,CAAC;YAED,2CAA2C;YAC3C,IAAI,CAAC;gBACH,MAAM,SAAS,GAAG,MAAM,CAAC,YAAY,EAAE,CAAC;gBACxC,IAAI,SAAS,IAAI,SAAS,CAAC,UAAU,GAAG,CAAC,EAAE,CAAC;oBAC1C,MAAM,KAAK,GAAG,SAAS,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;oBACtC,IAAI,IAAI,GAAgB,KAAK,CAAC,uBAAuB,CAAC;oBAEtD,WAAW;oBACX,OAAO,IAAI,EAAE,CAAC;wBACZ,IAAI,IAAI,CAAC,QAAQ,KAAK,IAAI,CAAC,YAAY,EAAE,CAAC;4BACxC,MAAM,OAAO,GAAG,IAAe,CAAC;4BAChC,MAAM,OAAO,GAAG,OAAO,CAAC,OAAO,EAAE,WAAW,EAAE,CAAC;4BAC/C,qCAAqC;4BACrC,IAAI,OAAO,KAAK,uBAAuB,EAAE,CAAC;gCACxC,OAAO,KAAK,CAAC;4BACf,CAAC;4BACD,oCAAoC;4BACpC,IAAI,OAAO,CAAC,SAAS,EAAE,QAAQ,CAAC,uBAAuB,CAAC,EAAE,CAAC;gCACzD,OAAO,KAAK,CAAC;4BACf,CAAC;4BACD,0BAA0B;4BAC1B,IAAI,OAAO,CAAC,YAAY,EAAE,CAAC,qBAAqB,CAAC,EAAE,CAAC;gCAClD,OAAO,KAAK,CAAC;4BACf,CAAC;wBACH,CAAC;wBACD,IAAI,GAAG,IAAI,CAAC,UAAU,CAAC;oBACzB,CAAC;oBAED,aAAa;oBACb,MAAM,cAAc,GAAG,KAAK,CAAC,cAAc,CAAC;oBAC5C,MAAM,YAAY,GAAG,KAAK,CAAC,YAAY,CAAC;oBACxC,MAAM,SAAS,GAAG,CAAC,CAAc,EAAW,EAAE;wBAC5C,OAAO,CAAC,EAAE,CAAC;4BACT,IAAI,CAAC,CAAC,QAAQ,KAAK,IAAI,CAAC,YAAY,EAAE,CAAC;gCACrC,MAAM,EAAE,GAAG,CAAY,CAAC;gCACxB,IAAI,EAAE,CAAC,OAAO,EAAE,WAAW,EAAE,KAAK,uBAAuB;oCACrD,EAAE,CAAC,SAAS,EAAE,QAAQ,CAAC,uBAAuB,CAAC,EAAE,CAAC;oCACpD,OAAO,IAAI,CAAC;gCACd,CAAC;4BACH,CAAC;4BACD,CAAC,GAAG,CAAC,CAAC,UAAU,CAAC;wBACnB,CAAC;wBACD,OAAO,KAAK,CAAC;oBACf,CAAC,CAAC;oBACF,IAAI,SAAS,CAAC,cAAc,CAAC,IAAI,SAAS,CAAC,YAAY,CAAC,EAAE,CAAC;wBACzD,OAAO,KAAK,CAAC;oBACf,CAAC;gBACH,CAAC;YACH,CAAC;YAAC,MAAM,CAAC;gBACP,OAAO;YACT,CAAC;YAED,0FAA0F;YAC1F,IACE,IAAI,CAAC,WAAW,KAAK,MAAM;gBAC3B,IAAI,CAAC,sBAAsB,CAAC,MAAM,KAAK,CAAC,EACxC,CAAC;gBACD,MAAM,OAAO,GAAG,GAAG,EAAE;oBACnB,MAAM,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC,sBAAsB,CAAC;oBAC9C,MAAM,QAAQ,GAAG,OAAO,CAAC,aAAa,CAAW,WAAW,CAAC,CAAC;oBAC9D,MAAM,MAAM,GAAG,QAAQ,EAAE,YAAY,CAAC;oBACtC,IAAI,CAAC,QAAQ,IAAI,CAAC,MAAM,EAAE,CAAC;wBACzB,OAAO,KAAK,CAAC;oBACf,CAAC;oBACD,MAAM,KAAK,GAAG,MAAM,CAAC,cAAc,EAAE,CAAC;oBACtC,IAAI,CAAC,KAAK,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;wBAC/B,OAAO,KAAK,CAAC;oBACf,CAAC;oBACD,MAAM,MAAM,GAAG,MAAM,CAAC,sBAAsB,CAAC,KAAK,CAAC,CAAC;oBACpD,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;wBACtB,OAAO,KAAK,CAAC;oBACf,CAAC;oBACD,MAAM,KAAK,GAAG,MAAM,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;oBAC/B,IAAI,CAAC,KAAK,EAAE,CAAC;wBACX,OAAO,KAAK,CAAC;oBACf,CAAC;oBAED,OAAO,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;gBAC/B,CAAC,CAAC;gBAEF,IAAI,OAAO,EAAE,EAAE,CAAC;oBACd,OAAO,KAAK,CAAC;gBACf,CAAC;gBAED,gDAAgD;gBAChD,MAAM,eAAe,GAAG,GAAG,EAAE;oBAC3B,MAAM,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC,sBAAsB,CAAC;oBAC9C,MAAM,QAAQ,GAAG,OAAO,CAAC,aAAa,CAAW,WAAW,CAAC,CAAC;oBAC9D,MAAM,MAAM,GAAG,QAAQ,EAAE,YAAY,CAAC;oBACtC,IAAI,CAAC,QAAQ,IAAI,CAAC,MAAM,EAAE,CAAC;wBACzB,OAAO,KAAK,CAAC;oBACf,CAAC;oBACD,MAAM,KAAK,GAAG,MAAM,CAAC,cAAc,EAAE,CAAC;oBACtC,IAAI,CAAC,KAAK,EAAE,CAAC;wBACX,OAAO,KAAK,CAAC;oBACf,CAAC;oBACD,MAAM,MAAM,GAAG,MAAM,CAAC,sBAAsB,CAAC,KAAK,CAAC,CAAC;oBACpD,+BAA+B;oBAC/B,KAAK,MAAM,CAAC,KAAK,CAAC,IAAI,MAAM,EAAE,CAAC;wBAC7B,IAAI,KAAK,EAAE,UAAU,EAAE,aAAa,EAAE,CAAC;4BACrC,OAAO,IAAI,CAAC;wBACd,CAAC;oBACH,CAAC;oBACD,OAAO,KAAK,CAAC;gBACf,CAAC,CAAC;gBAEF,IAAI,eAAe,EAAE,EAAE,CAAC;oBACtB,OAAO,KAAK,CAAC;gBACf,CAAC;YACH,CAAC;YAED,kFAAkF;YAClF,qCAAqC;YACrC,MAAM,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,EAAE,CAAC;YAC3C,MAAM,OAAO,GAAG,WAAW;gBACzB,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,wBAAwB,EAAE,WAAW,CAAC;gBACjE,CAAC,CAAC,IAAI,CAAC;YAET,aAAa;YACb,IAAI,OAAO,IAAI,OAAO,EAAE,KAAK,KAAK,QAAQ,EAAE,CAAC;gBAC3C,OAAO,KAAK,CAAC;YACf,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC;QAEO,eAAe,CACrB,MAAiC,EACjC,OAAkC;YAElC,IAAI,MAAM,KAAK,OAAO,IAAI,CAAC,MAAM,IAAI,OAAO,IAAI,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC;gBACxE,OAAO,IAAI,CAAC;YACd,CAAC;YAED,OAAO,KAAK,CAAC;QACf,CAAC;QAEO,mBAAmB;YACzB,MAAM,WAAW,GAAG,IAAI,CAAC,YAAY,CAAC;YAEtC,IAAI,CAAC,WAAW,CAAC,aAAa,EAAE,GAAG,CAAC,EAAE;gBACpC,IAAI,CAAC,SAAS,GAAG,GAAG,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC,QAAQ,CAAC;YACpD,CAAC,CAAC,CAAC;YAEH,IAAI,CAAC,WAAW,CAAC,WAAW,EAAE,GAAG,EAAE;gBACjC,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;YACzB,CAAC,CAAC,CAAC;YAEH,sBAAsB;YACtB,IAAI,CAAC,WAAW,CAAC,GAAG,CAClB,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,WAAW,EAAE,GAAG,CAAC,EAAE;gBACrC,IAAI,UAAU,GAAmB,IAAI,CAAC;gBACtC,IAAI,IAAI,CAAC,WAAW,KAAK,MAAM,IAAI,IAAI,CAAC,WAAW,KAAK,QAAQ,EAAE,CAAC;oBACjE,MAAM,KAAK,GAAG,IAAI,CAAC,WAAW,CAAC;oBAC/B,IAAI,CAAC,KAAK,EAAE,CAAC;wBACX,IAAI,CAAC,MAAM,EAAE,CAAC;wBACd,OAAO;oBACT,CAAC;oBACD,UAAU,GAAG,KAAK,CAAC,qBAAqB,EAAE,CAAC;gBAC7C,CAAC;qBAAM,IAAI,IAAI,CAAC,WAAW,KAAK,OAAO,EAAE,CAAC;oBACxC,MAAM,YAAY,GAAG,IAAI,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC;oBACpD,IAAI,CAAC,YAAY;wBAAE,OAAO;oBAC1B,UAAU,GAAG,YAAY,CAAC,qBAAqB,EAAE,CAAC;gBACpD,CAAC;qBAAM,CAAC;oBACN,OAAO;gBACT,CAAC;gBAED,MAAM,EAAE,GAAG,EAAE,aAAa,EAAE,MAAM,EAAE,gBAAgB,EAAE,GACpD,IAAI,CAAC,IAAI,CAAC,qBAAqB,EAAE,CAAC;gBACpC,MAAM,CAAC,GAAG,GAAG,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC;gBAClC,IAAI,gBAAgB,GAAG,UAAU,CAAC,MAAM,GAAG,EAAE,EAAE,CAAC;oBAC9C,IAAI,CAAC,UAAU,GAAG,KAAK,CAAC;gBAC1B,CAAC;qBAAM,IAAI,UAAU,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,aAAa,EAAE,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC;oBAC5D,IAAI,CAAC,UAAU,GAAG,QAAQ,CAAC;gBAC7B,CAAC;qBAAM,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC,GAAG,UAAU,CAAC,GAAG,GAAG,UAAU,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBAC5D,IAAI,CAAC,UAAU,GAAG,KAAK,CAAC;gBAC1B,CAAC;qBAAM,CAAC;oBACN,IAAI,CAAC,UAAU,GAAG,QAAQ,CAAC;gBAC7B,CAAC;YACH,CAAC,CAAC,CACH,CAAC;YAEF,6BAA6B;YAC7B,IAAI,CAAC,WAAW,CAAC,GAAG,CAClB,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE,CAAC,GAAG,EAAE;gBAC3C,MAAM,MAAM,GAAG,KAAK,IAAI,EAAE;oBACxB,MAAM,aAAa,GAAG,WAAW,CAAC,SAAS,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;oBACzD,MAAM,eAAe,GAAG,WAAW,CAAC,SAAS,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;oBAE9D,iFAAiF;oBACjF,MAAM,eAAe,GAAG,WAAW,CAAC,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;oBAC7D,IAAI,eAAe,EAAE,CAAC;wBACpB,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;4BACtB,IAAI,CAAC,WAAW,GAAG,eAAe,CAAC;4BACnC,OAAO;wBACT,CAAC;wBAED,IAAI,CAAC,IAAI,CAAC,eAAe,CAAC,eAAe,EAAE,IAAI,CAAC,WAAW,CAAC,EAAE,CAAC;4BAC7D,IAAI,CAAC,WAAW,GAAG,eAAe,CAAC;4BACnC,OAAO;wBACT,CAAC;oBACH,CAAC;oBAED,MAAM,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE,CAAC;oBAEpC,IAAI,aAAa,EAAE,CAAC;wBAClB,MAAM,KAAK,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;wBAE7D,IACE,CAAC,aAAa,CAAC,WAAW,EAAE;4BAC5B,KAAK;4BACL,KAAK,CAAC,KAAK,CAAC,IAAI,KAAK,SAAS,EAC9B,CAAC;4BACD,IAAI,CAAC,YAAY,GAAG,MAAM,CAAC;4BAC3B,YAAY,CAAC,WAAW,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;4BAE5C,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO;iCAClB,KAAK,EAAE;iCACP,gBAAgB,EAAE;iCAClB,iBAAiB,CAAC;gCACjB,KAAK,EAAE,CAAC,MAAM,CAAC;6BAChB,CAAC;iCACD,MAAM,CAAC,GAAG,CAAC,EAAE;gCACZ,MAAM,EAAE,cAAc,EAAE,GAAG,GAAG,CAAC;gCAC/B,YAAY,CAAC,cAAc,CAAC,CAAC;gCAE7B,IAAI,CAAC,sBAAsB,GAAG,cAAc,CAAC;4BAC/C,CAAC,CAAC;iCACD,GAAG,EAAE,CAAC;4BAET,OAAO;wBACT,CAAC;wBAED,IAAI,CAAC,MAAM,EAAE,CAAC;wBACd,OAAO;oBACT,CAAC;oBAED,IAAI,eAAe,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;wBAC/B,IAAI,CAAC,YAAY,GAAG,OAAO,CAAC;wBAC5B,MAAM,cAAc,GAAG,eAAe;6BACnC,GAAG,CAAC,SAAS,CAAC,EAAE;4BACf,MAAM,IAAI,GAAG,SAAS,CAAC,OAAO,CAAC;4BAC/B,OAAO,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;wBACpD,CAAC,CAAC;6BACD,MAAM,CAAC,CAAC,EAAE,EAAsB,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;wBAE5C,IAAI,CAAC,sBAAsB,GAAG,cAAc,CAAC;wBAC7C,OAAO;oBACT,CAAC;oBAED,IAAI,CAAC,MAAM,EAAE,CAAC;gBAChB,CAAC,CAAC;gBAEF,MAAM,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;YAChC,CAAC,CAAC,CACH,CAAC;YACF,IAAI,CAAC,WAAW,CAAC,YAAY,CAAC,QAAQ,EAAE,iBAAiB,EAAE,GAAG,EAAE;gBAC9D,MAAM,iBAAiB,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;gBAC/D,IAAI,CAAC,iBAAiB,EAAE,CAAC;oBACvB,OAAO;gBACT,CAAC;gBAED,MAAM,KAAK,GAAG,GAAG,EAAE;oBACjB,IAAI,CAAC,MAAM,EAAE,CAAC;oBACd,IAAI,CAAC,aAAa,EAAE,CAAC;gBACvB,CAAC,CAAC;gBACF,MAAM,aAAa,GAAG,iBAAiB,CAAC,aAAa,CAAC;gBACtD,wBAAwB;gBACxB,IAAI,aAAa,CAAC,IAAI,KAAK,OAAO,IAAI,CAAC,aAAa,CAAC,SAAS;oBAC5D,OAAO,KAAK,EAAE,CAAC;gBACjB,yBAAyB;gBACzB,IACE,CAAC,aAAa,CAAC,IAAI,KAAK,QAAQ;oBAC9B,aAAa,CAAC,aAAa,KAAK,MAAM,CAAC;oBACzC,CAAC,aAAa,CAAC,SAAS;oBAExB,OAAO,KAAK,EAAE,CAAC;gBAEjB,MAAM,KAAK,GAAG,IAAI,CAAC,WAAW,CAAC;gBAE/B,IAAI,CAAC,KAAK,IAAI,KAAK,CAAC,SAAS;oBAAE,OAAO,KAAK,EAAE,CAAC;gBAC9C,IAAI,CAAC,YAAY,GAAG,QAAQ,CAAC;gBAC7B,IAAI,CAAC,aAAa,EAAE,CAAC;YACvB,CAAC,CAAC,CAAC;QACL,CAAC;QAEO,sBAAsB;YAC5B,MAAM,qBAAqB,GAAG,IAAI,CAAC,gBAAgB,CAAC;YACpD,YAAY,CAAC,qBAAqB,EAAE,+BAA+B,CAAC,CAAC;YAErE,MAAM,qBAAqB,GAAG,CAC5B,UAAyC,EACzC,EAAE;gBACF,MAAM,cAAc,GAAG,UAAU,EAAE,CAAC;gBACpC,IAAI,CAAC,cAAc,EAAE,CAAC;oBACpB,OAAO;gBACT,CAAC;gBAED,YAAY,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC;gBACrC,eAAe,CAAC,qBAAqB,EAAE,KAAK,EAAE,CAAC;gBAC/C,IAAI,CAAC,iBAAiB,CAAC,GAAG,CACxB,UAAU,CACR,cAAc,EACd,qBAAqB,EACrB,GAAG,EAAE;oBACH,MAAM,OAAO,GAAG,UAAU,EAAE,CAAC;oBAC7B,IAAI,CAAC,OAAO;wBAAE,OAAO;oBAErB,eAAe,CAAC,OAAO,EAAE,qBAAqB,EAAE;wBAC9C,SAAS,EAAE,IAAI,CAAC,UAAU;wBAC1B,UAAU,EAAE;4BACV,MAAM,CAAC,EAAE,CAAC;4BACV,MAAM,EAAE;4BACR,KAAK,CAAC;gCACJ,OAAO,EAAE,CAAC;6BACX,CAAC;yBACH;qBACF,CAAC;yBACC,IAAI,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE,EAAE;wBACjB,qBAAqB,CAAC,KAAK,CAAC,OAAO,GAAG,MAAM,CAAC;wBAC7C,qBAAqB,CAAC,KAAK,CAAC,GAAG,GAAG,GAAG,CAAC,IAAI,CAAC;wBAC3C,qBAAqB,CAAC,KAAK,CAAC,IAAI,GAAG,GAAG,CAAC,IAAI,CAAC;oBAC9C,CAAC,CAAC;yBACD,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;gBAC1B,CAAC,EACD;oBACE,kCAAkC;oBAClC,cAAc,EAAE,IAAI;iBACrB,CACF,CACF,CAAC;YACJ,CAAC,CAAC;YAEF,MAAM,4BAA4B,GAAG,GAAG,EAAE;gBACxC,MAAM,iBAAiB,GAAG,IAAI,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC;gBACzD,IAAI,IAAI,GAAG,iBAAiB,EAAE,qBAAqB,EAAE,CAAC;gBAEtD,IAAI,CAAC,IAAI;oBAAE,OAAO;gBAElB,IAAI,CAAC,sBAAsB,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE;oBACvC,MAAM,MAAM,GAAG,EAAE,CAAC,qBAAqB,EAAE,CAAC;oBAC1C,IAAI,MAAM,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;wBAC1B,IAAI,GAAG,IAAI,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,MAAM,CAAC,GAAG,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;oBACrE,CAAC;oBACD,IAAI,MAAM,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC;wBAChC,IAAI,GAAG,IAAI,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,KAAK,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC;oBACrE,CAAC;oBACD,IAAI,MAAM,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;wBAC5B,IAAI,GAAG,IAAI,OAAO,CAAC,MAAM,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;oBACrE,CAAC;oBACD,IAAI,MAAM,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,EAAE,CAAC;wBAC9B,IAAI,GAAG,IAAI,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,EAAE,MAAM,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;oBACrE,CAAC;gBACH,CAAC,CAAC,CAAC;gBACH,OAAO;oBACL,qBAAqB,EAAE,GAAG,EAAE,CAAC,IAAI;oBACjC,cAAc,EAAE,GAAG,EAAE,CACnB,IAAI,CAAC,sBAAsB,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,qBAAqB,EAAE,CAAC;iBACpE,CAAC;YACJ,CAAC,CAAC;YAEF,MAAM,2BAA2B,GAAG,GAAG,EAAE;gBACvC,MAAM,KAAK,GAAG,IAAI,CAAC,WAAW,CAAC;gBAC/B,IAAI,CAAC,KAAK,EAAE,CAAC;oBACX,OAAO;gBACT,CAAC;gBACD,OAAO;oBACL,qBAAqB,EAAE,GAAG,EAAE,CAAC,KAAK,CAAC,qBAAqB,EAAE;oBAC1D,cAAc,EAAE,GAAG,EAAE,CAAC,KAAK,CAAC,cAAc,EAAE;iBAC7C,CAAC;YACJ,CAAC,CAAC;YAEF,QAAQ,IAAI,CAAC,WAAW,EAAE,CAAC;gBACzB,KAAK,MAAM,CAAC;gBACZ,KAAK,QAAQ;oBACX,OAAO,qBAAqB,CAAC,2BAA2B,CAAC,CAAC;gBAC5D,KAAK,OAAO;oBACV,OAAO,qBAAqB,CAAC,4BAA4B,CAAC,CAAC;gBAC7D;oBACE,OAAO;YACX,CAAC;QACH,CAAC;QAEQ,iBAAiB;YACxB,KAAK,CAAC,iBAAiB,EAAE,CAAC;YAC1B,IAAI,CAAC,gBAAgB,GAAG,IAAI,eAAe,EAAE,CAAC;YAE9C,MAAM,WAAW,GAAG,IAAI,CAAC,YAAY,CAAC;YACtC,YAAY,CAAC,WAAW,CAAC,CAAC;YAC1B,MAAM,OAAO,GAAG,WAAW,CAAC,OAAO,CAAC;YAEpC,8CAA8C;YAC9C,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,OAAO,EAAE,wBAAwB,CAAC,EAAE,CAAC;gBACtD,OAAO;YACT,CAAC;YAED,8CAA8C;YAC9C,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,EAAE,CAAC;gBAChC,MAAM,IAAI,KAAK,CACb,uCAAuC,WAAW,CAAC,WAAW,CAAC,IAAI,iCAAiC,CACrG,CAAC;YACJ,CAAC;YAED,IAAI,CAAC,mBAAmB,EAAE,CAAC;YAE3B,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBAClC,oBAAoB,CAAC,IAAI,CAAC,CAAC;YAC7B,CAAC;QACH,CAAC;QAEQ,OAAO;YACd,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE,EAAE,CAAC;gBAC3B,IAAI,IAAI,CAAC,iBAAiB,EAAE,CAAC;oBAC3B,IAAI,CAAC,iBAAiB,CAAC,OAAO,EAAE,CAAC;gBACnC,CAAC;gBACD,OAAO;YACT,CAAC;YAED,IAAI,CAAC,iBAAiB,GAAG,IAAI,eAAe,EAAE,CAAC;YAC/C,IAAI,CAAC,sBAAsB,EAAE,CAAC;QAChC,CAAC;QAEQ,oBAAoB;YAC3B,KAAK,CAAC,oBAAoB,EAAE,CAAC;YAC7B,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,CAAC;YAC9B,IAAI,CAAC,MAAM,EAAE,CAAC;YACd,IAAI,CAAC,WAAW,GAAG,SAAS,CAAC;QAC/B,CAAC;QAED,UAAU;YACR,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC,CAAC;YAC3C,OAAO,IAAI,CAAC;QACd,CAAC;QAED,sBAAsB;YACpB,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,sBAAsB,EAAE,CAAC,CAAC;YACxD,OAAO,IAAI,CAAC;QACd,CAAC;QAED,oBAAoB;YAClB,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,oBAAoB,EAAE,CAAC,CAAC;YACtD,OAAO,IAAI,CAAC;QACd,CAAC;QAED,eAAe,CAAC,MAA4C;YAC1D,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE,IAAI,EAAE,eAAe,EAAE,CAAC,CAAC;YAC5D,OAAO,IAAI,CAAC;QACd,CAAC;QAED,kBAAkB,CAAC,MAA+C;YAChE,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE,IAAI,EAAE,kBAAkB,EAAE,CAAC,CAAC;YAC/D,OAAO,IAAI,CAAC;QACd,CAAC;QAED,kBAAkB,CAAC,MAOlB;YACC,MAAM,EAAE,GAAG,EAAE,GAAG,MAAM,CAAC;YACvB,OAAO,IAAI,CAAC,eAAe,CAAC;gBAC1B,EAAE,EAAE,GAAG;gBACP,IAAI,EAAE,gBAAgB,CAAC,GAAG,CAAC;gBAC3B,IAAI,EAAE,MAAM,CAAC,IAAI;gBACjB,QAAQ,EAAE,KAAK,CAAC,EAAE;oBAChB,MAAM,CAAC,MAAM,CAAC,GAAG,KAAK,CAAC,iBAAiB,CAAC,EAAE,GAAG,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC;oBACxD,OAAO,MAAM,CAAC;gBAChB,CAAC;gBACD,MAAM,EAAE,MAAM,CAAC,MAAM;gBACrB,QAAQ,EAAE,KAAK,CAAC,EAAE;oBAChB,MAAM,CAAC,MAAM,CAAC,GAAG,iBAAiB,CAAC,KAAK,CAAC,CAAC,GAAG,EAAE,CAAC;oBAChD,OAAO,MAAM,CAAC;gBAChB,CAAC;aACF,CAAC,CAAC;QACL,CAAC;QAED,kBAAkB,CAAC,MAKlB;YACC,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG,MAAM,CAAC;YACvC,OAAO,IAAI,CAAC,kBAAkB,CAAC;gBAC7B,EAAE,EAAE,GAAG,OAAO,IAAI,IAAI,IAAI,EAAE,EAAE;gBAC9B,IAAI;gBACJ,OAAO;gBACP,IAAI,EAAE,MAAM,CAAC,IAAI,IAAI,gBAAgB,CAAC,IAAI,IAAI,OAAO,CAAC;gBACtD,MAAM,EAAE,KAAK,CAAC,EAAE;oBACd,KAAK;yBACF,eAAe,CAAC;wBACf,OAAO;wBACP,KAAK,EAAE,IAAI,IAAI,IAAI,CAAC,CAAC,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,SAAS;qBAC3C,CAAC;yBACD,GAAG,EAAE,CAAC;gBACX,CAAC;aACF,CAAC,CAAC;QACL,CAAC;QAED,iBAAiB,CAAC,WAAkC,EAAE,KAAc;YAClE,IAAI,KAAK,KAAK,SAAS,EAAE,CAAC;gBACxB,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,WAAW,CAAC,CAAC;YACxC,CAAC;iBAAM,CAAC;gBACN,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,EAAE,GAAG,WAAW,CAAC,CAAC;YACpD,CAAC;YACD,OAAO,IAAI,CAAC;QACd,CAAC;QAED,WAAW;YACT,IAAI,CAAC,WAAW,GAAG,EAAE,CAAC;YACtB,OAAO,IAAI,CAAC;QACd,CAAC;QAEQ,MAAM;YACb,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE,EAAE,CAAC;gBAC3B,OAAO,OAAO,CAAC;YACjB,CAAC;YAED,MAAM,KAAK,GAAG,cAAc,CAAC,IAAI,CAAC,CAAC;YAEnC,OAAO,IAAI,CAAA;eACA,wBAAwB;sBACjB,CAAC,KAAY,EAAE,EAAE;gBAC/B,KAAK,CAAC,eAAe,EAAE,CAAC;gBACxB,KAAK,CAAC,cAAc,EAAE,CAAC;YACzB,CAAC;gBACS,eAAe;;QAEvB,KAAK;WACF,CAAC;QACV,CAAC;;;YAllBgB,oFAAY,KAAK,EAAC;YAGlB,kJAAqD,MAAM,GAAC;YAG5D,yKAAyC,EAAE,GAAC;YAErD,gBAAW,wEAAgC,SAAS,EAAC;YAErD,qBAAgB,GAAG,IAAI,eAAe,EAAE,CAAC;YAEzC,eAAU,GAAc,KAAK,CAAC;YAE9B,sBAAiB,GAA2B,IAAI,CAAC;YAGhD,kGAAuC,IAAI,EAAC;YAG5C,uJAAqC,EAAE,GAAC;;;;YA1CtC,uDAAqB;;;;;SAArB,qBAAqB;AA2mBlC,SAAS,gBAAgB,CAAC,CAAS;IACjC,MAAM,MAAM,GAAG,CAAC,CAAC,OAAO,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;IAC5C,OAAO,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,WAAW,EAAE,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;AAC1D,CAAC","sourcesContent":["import '../../../_common/components/button.js';\n\nimport type {\n  BaseSelection,\n  BlockElement,\n  CursorSelection,\n} from '@blocksuite/block-std';\nimport { WidgetElement } from '@blocksuite/block-std';\nimport { assertExists, DisposableGroup } from '@blocksuite/global/utils';\nimport {\n  autoUpdate,\n  computePosition,\n  inline,\n  offset,\n  type Placement,\n  type ReferenceElement,\n  shift,\n} from '@floating-ui/dom';\nimport { html, nothing } from 'lit';\nimport { customElement, query, state } from 'lit/decorators.js';\n\nimport {\n  HoverController,\n  type RichText,\n} from '../../../_common/components/index.js';\nimport type { AffineTextAttributes } from '../../../_common/inline/presets/affine-inline-specs.js';\nimport { stopPropagation } from '../../../_common/utils/event.js';\nimport { matchFlavours } from '../../../_common/utils/model.js';\nimport { isFormatSupported } from '../../../note-block/commands/utils.js';\nimport { isRootElement } from '../../../root-block/utils/guard.js';\nimport { ConfigRenderer } from './components/config-renderer.js';\nimport {\n  type FormatBarConfigItem,\n  type InlineActionConfigItem,\n  type ParagraphActionConfigItem,\n  toolbarDefaultConfig,\n} from './config.js';\nimport { formatBarStyle } from './styles.js';\n\nexport const AFFINE_FORMAT_BAR_WIDGET = 'affine-format-bar-widget';\n\n@customElement(AFFINE_FORMAT_BAR_WIDGET)\nexport class AffineFormatBarWidget extends WidgetElement {\n  private get _selectionManager() {\n    return this.host.selection;\n  }\n\n  get displayType() {\n    return this._displayType;\n  }\n\n  get selectedBlockElements() {\n    return this._selectedBlockElements;\n  }\n\n  get nativeRange() {\n    const sl = document.getSelection();\n    if (!sl || sl.rangeCount === 0) return null;\n    return sl.getRangeAt(0);\n  }\n\n  static override styles = formatBarStyle;\n\n  @state()\n  private accessor _dragging = false;\n\n  @state()\n  private accessor _displayType: 'text' | 'block' | 'native' | 'none' = 'none';\n\n  @state()\n  private accessor _selectedBlockElements: BlockElement[] = [];\n\n  private _lastCursor: CursorSelection | undefined = undefined;\n\n  private _abortController = new AbortController();\n\n  private _placement: Placement = 'top';\n\n  private _floatDisposables: DisposableGroup | null = null;\n\n  @query(`.${AFFINE_FORMAT_BAR_WIDGET}`)\n  accessor formatBarElement: HTMLElement | null = null;\n\n  @state()\n  accessor configItems: FormatBarConfigItem[] = [];\n\n  private _reset() {\n    this._displayType = 'none';\n    this._selectedBlockElements = [];\n  }\n\n  private _shouldDisplay() {\n    const readonly = this.doc.awarenessStore.isReadonly(\n      this.doc.blockCollection\n    );\n    if (readonly) return false;\n\n    if (\n      this.displayType === 'block' &&\n      this._selectedBlockElements?.[0]?.flavour === 'affine:surface-ref'\n    ) {\n      return false;\n    }\n\n    if (\n      this.displayType === 'block' &&\n      this._selectedBlockElements.length === 1\n    ) {\n      const selectedBlock = this._selectedBlockElements[0];\n      if (\n        !matchFlavours(selectedBlock.model, [\n          'affine:paragraph',\n          'affine:list',\n          'affine:code',\n          'affine:image',\n        ])\n      ) {\n        return false;\n      }\n    }\n\n    if (this.displayType === 'none' || this._dragging) {\n      return false;\n    }\n    \n    // 【v6.5】全局检查：如果选中了 aiPlaceholder 内容，不显示工具栏\n    try {\n      const selection = window.getSelection();\n      if (selection && selection.rangeCount > 0) {\n        const range = selection.getRangeAt(0);\n        let node: Node | null = range.commonAncestorContainer;\n        \n        // 遍历祖先元素检查\n        while (node) {\n          if (node.nodeType === Node.ELEMENT_NODE) {\n            const element = node as Element;\n            const tagName = element.tagName?.toLowerCase();\n            // 检查是否是 affine-ai-placeholder 或其内部元素\n            if (tagName === 'affine-ai-placeholder') {\n              return false;\n            }\n            // 检查是否有 affine-ai-placeholder class\n            if (element.classList?.contains('affine-ai-placeholder')) {\n              return false;\n            }\n            // 检查是否在占位符容器内（通过 data 属性）\n            if (element.hasAttribute?.('data-ai-placeholder')) {\n              return false;\n            }\n          }\n          node = node.parentNode;\n        }\n        \n        // 也检查选区起点和终点\n        const startContainer = range.startContainer;\n        const endContainer = range.endContainer;\n        const checkNode = (n: Node | null): boolean => {\n          while (n) {\n            if (n.nodeType === Node.ELEMENT_NODE) {\n              const el = n as Element;\n              if (el.tagName?.toLowerCase() === 'affine-ai-placeholder' ||\n                  el.classList?.contains('affine-ai-placeholder')) {\n                return true;\n              }\n            }\n            n = n.parentNode;\n          }\n          return false;\n        };\n        if (checkNode(startContainer) || checkNode(endContainer)) {\n          return false;\n        }\n      }\n    } catch {\n      // 忽略错误\n    }\n\n    // if the selection is on an embed (ex. linked page), we should not display the format bar\n    if (\n      this.displayType === 'text' &&\n      this._selectedBlockElements.length === 1\n    ) {\n      const isEmbed = () => {\n        const [element] = this._selectedBlockElements;\n        const richText = element.querySelector<RichText>('rich-text');\n        const inline = richText?.inlineEditor;\n        if (!richText || !inline) {\n          return false;\n        }\n        const range = inline.getInlineRange();\n        if (!range || range.length > 1) {\n          return false;\n        }\n        const deltas = inline.getDeltasByInlineRange(range);\n        if (deltas.length > 2) {\n          return false;\n        }\n        const delta = deltas?.[1]?.[0];\n        if (!delta) {\n          return false;\n        }\n\n        return inline.isEmbed(delta);\n      };\n\n      if (isEmbed()) {\n        return false;\n      }\n      \n      // 【v6.4】如果选中的文本在 aiPlaceholder 内，不显示 format bar\n      const isInPlaceholder = () => {\n        const [element] = this._selectedBlockElements;\n        const richText = element.querySelector<RichText>('rich-text');\n        const inline = richText?.inlineEditor;\n        if (!richText || !inline) {\n          return false;\n        }\n        const range = inline.getInlineRange();\n        if (!range) {\n          return false;\n        }\n        const deltas = inline.getDeltasByInlineRange(range);\n        // 检查选中范围内是否包含 aiPlaceholder 属性\n        for (const [delta] of deltas) {\n          if (delta?.attributes?.aiPlaceholder) {\n            return true;\n          }\n        }\n        return false;\n      };\n      \n      if (isInPlaceholder()) {\n        return false;\n      }\n    }\n\n    // todo: refactor later that ai panel & format bar should not depend on each other\n    // do not display if AI panel is open\n    const rootBlockId = this.host.doc.root?.id;\n    const aiPanel = rootBlockId\n      ? this.host.view.getWidget('affine-ai-panel-widget', rootBlockId)\n      : null;\n\n    // @ts-ignore\n    if (aiPanel && aiPanel?.state !== 'hidden') {\n      return false;\n    }\n\n    return true;\n  }\n\n  private _selectionEqual(\n    target: BaseSelection | undefined,\n    current: BaseSelection | undefined\n  ) {\n    if (target === current || (target && current && target.equals(current))) {\n      return true;\n    }\n\n    return false;\n  }\n\n  private _calculatePlacement() {\n    const rootElement = this.blockElement;\n\n    this.handleEvent('pointerMove', ctx => {\n      this._dragging = ctx.get('pointerState').dragging;\n    });\n\n    this.handleEvent('pointerUp', () => {\n      this._dragging = false;\n    });\n\n    // calculate placement\n    this.disposables.add(\n      this.host.event.add('pointerUp', ctx => {\n        let targetRect: DOMRect | null = null;\n        if (this.displayType === 'text' || this.displayType === 'native') {\n          const range = this.nativeRange;\n          if (!range) {\n            this._reset();\n            return;\n          }\n          targetRect = range.getBoundingClientRect();\n        } else if (this.displayType === 'block') {\n          const blockElement = this._selectedBlockElements[0];\n          if (!blockElement) return;\n          targetRect = blockElement.getBoundingClientRect();\n        } else {\n          return;\n        }\n\n        const { top: editorHostTop, bottom: editorHostBottom } =\n          this.host.getBoundingClientRect();\n        const e = ctx.get('pointerState');\n        if (editorHostBottom - targetRect.bottom < 50) {\n          this._placement = 'top';\n        } else if (targetRect.top - Math.max(editorHostTop, 0) < 50) {\n          this._placement = 'bottom';\n        } else if (e.raw.y < targetRect.top + targetRect.height / 2) {\n          this._placement = 'top';\n        } else {\n          this._placement = 'bottom';\n        }\n      })\n    );\n\n    // listen to selection change\n    this.disposables.add(\n      this._selectionManager.slots.changed.on(() => {\n        const update = async () => {\n          const textSelection = rootElement.selection.find('text');\n          const blockSelections = rootElement.selection.filter('block');\n\n          // Should not re-render format bar when only cursor selection changed in edgeless\n          const cursorSelection = rootElement.selection.find('cursor');\n          if (cursorSelection) {\n            if (!this._lastCursor) {\n              this._lastCursor = cursorSelection;\n              return;\n            }\n\n            if (!this._selectionEqual(cursorSelection, this._lastCursor)) {\n              this._lastCursor = cursorSelection;\n              return;\n            }\n          }\n\n          await this.host.getUpdateComplete();\n\n          if (textSelection) {\n            const block = this.host.view.getBlock(textSelection.blockId);\n\n            if (\n              !textSelection.isCollapsed() &&\n              block &&\n              block.model.role === 'content'\n            ) {\n              this._displayType = 'text';\n              assertExists(rootElement.host.rangeManager);\n\n              this.host.std.command\n                .chain()\n                .getTextSelection()\n                .getSelectedBlocks({\n                  types: ['text'],\n                })\n                .inline(ctx => {\n                  const { selectedBlocks } = ctx;\n                  assertExists(selectedBlocks);\n\n                  this._selectedBlockElements = selectedBlocks;\n                })\n                .run();\n\n              return;\n            }\n\n            this._reset();\n            return;\n          }\n\n          if (blockSelections.length > 0) {\n            this._displayType = 'block';\n            const selectedBlocks = blockSelections\n              .map(selection => {\n                const path = selection.blockId;\n                return this.blockElement.host.view.getBlock(path);\n              })\n              .filter((el): el is BlockElement => !!el);\n\n            this._selectedBlockElements = selectedBlocks;\n            return;\n          }\n\n          this._reset();\n        };\n\n        update().catch(console.error);\n      })\n    );\n    this.disposables.addFromEvent(document, 'selectionchange', () => {\n      const databaseSelection = this.host.selection.find('database');\n      if (!databaseSelection) {\n        return;\n      }\n\n      const reset = () => {\n        this._reset();\n        this.requestUpdate();\n      };\n      const viewSelection = databaseSelection.viewSelection;\n      // check table selection\n      if (viewSelection.type === 'table' && !viewSelection.isEditing)\n        return reset();\n      // check kanban selection\n      if (\n        (viewSelection.type === 'kanban' &&\n          viewSelection.selectionType !== 'cell') ||\n        !viewSelection.isEditing\n      )\n        return reset();\n\n      const range = this.nativeRange;\n\n      if (!range || range.collapsed) return reset();\n      this._displayType = 'native';\n      this.requestUpdate();\n    });\n  }\n\n  private _listenFloatingElement() {\n    const formatQuickBarElement = this.formatBarElement;\n    assertExists(formatQuickBarElement, 'format quick bar should exist');\n\n    const listenFloatingElement = (\n      getElement: () => ReferenceElement | void\n    ) => {\n      const initialElement = getElement();\n      if (!initialElement) {\n        return;\n      }\n\n      assertExists(this._floatDisposables);\n      HoverController.globalAbortController?.abort();\n      this._floatDisposables.add(\n        autoUpdate(\n          initialElement,\n          formatQuickBarElement,\n          () => {\n            const element = getElement();\n            if (!element) return;\n\n            computePosition(element, formatQuickBarElement, {\n              placement: this._placement,\n              middleware: [\n                offset(10),\n                inline(),\n                shift({\n                  padding: 6,\n                }),\n              ],\n            })\n              .then(({ x, y }) => {\n                formatQuickBarElement.style.display = 'flex';\n                formatQuickBarElement.style.top = `${y}px`;\n                formatQuickBarElement.style.left = `${x}px`;\n              })\n              .catch(console.error);\n          },\n          {\n            // follow edgeless viewport update\n            animationFrame: true,\n          }\n        )\n      );\n    };\n\n    const getReferenceElementFromBlock = () => {\n      const firstBlockElement = this._selectedBlockElements[0];\n      let rect = firstBlockElement?.getBoundingClientRect();\n\n      if (!rect) return;\n\n      this._selectedBlockElements.forEach(el => {\n        const elRect = el.getBoundingClientRect();\n        if (elRect.top < rect.top) {\n          rect = new DOMRect(rect.left, elRect.top, rect.width, rect.bottom);\n        }\n        if (elRect.bottom > rect.bottom) {\n          rect = new DOMRect(rect.left, rect.top, rect.width, elRect.bottom);\n        }\n        if (elRect.left < rect.left) {\n          rect = new DOMRect(elRect.left, rect.top, rect.right, rect.bottom);\n        }\n        if (elRect.right > rect.right) {\n          rect = new DOMRect(rect.left, rect.top, elRect.right, rect.bottom);\n        }\n      });\n      return {\n        getBoundingClientRect: () => rect,\n        getClientRects: () =>\n          this._selectedBlockElements.map(el => el.getBoundingClientRect()),\n      };\n    };\n\n    const getReferenceElementFromText = () => {\n      const range = this.nativeRange;\n      if (!range) {\n        return;\n      }\n      return {\n        getBoundingClientRect: () => range.getBoundingClientRect(),\n        getClientRects: () => range.getClientRects(),\n      };\n    };\n\n    switch (this.displayType) {\n      case 'text':\n      case 'native':\n        return listenFloatingElement(getReferenceElementFromText);\n      case 'block':\n        return listenFloatingElement(getReferenceElementFromBlock);\n      default:\n        return;\n    }\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this._abortController = new AbortController();\n\n    const rootElement = this.blockElement;\n    assertExists(rootElement);\n    const widgets = rootElement.widgets;\n\n    // check if the host use the format bar widget\n    if (!Object.hasOwn(widgets, AFFINE_FORMAT_BAR_WIDGET)) {\n      return;\n    }\n\n    // check if format bar widget support the host\n    if (!isRootElement(rootElement)) {\n      throw new Error(\n        `format bar not support rootElement: ${rootElement.constructor.name} but its widgets has format bar`\n      );\n    }\n\n    this._calculatePlacement();\n\n    if (this.configItems.length === 0) {\n      toolbarDefaultConfig(this);\n    }\n  }\n\n  override updated() {\n    if (!this._shouldDisplay()) {\n      if (this._floatDisposables) {\n        this._floatDisposables.dispose();\n      }\n      return;\n    }\n\n    this._floatDisposables = new DisposableGroup();\n    this._listenFloatingElement();\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this._abortController.abort();\n    this._reset();\n    this._lastCursor = undefined;\n  }\n\n  addDivider() {\n    this.configItems.push({ type: 'divider' });\n    return this;\n  }\n\n  addHighlighterDropdown() {\n    this.configItems.push({ type: 'highlighter-dropdown' });\n    return this;\n  }\n\n  addParagraphDropdown() {\n    this.configItems.push({ type: 'paragraph-dropdown' });\n    return this;\n  }\n\n  addInlineAction(config: Omit<InlineActionConfigItem, 'type'>) {\n    this.configItems.push({ ...config, type: 'inline-action' });\n    return this;\n  }\n\n  addParagraphAction(config: Omit<ParagraphActionConfigItem, 'type'>) {\n    this.configItems.push({ ...config, type: 'paragraph-action' });\n    return this;\n  }\n\n  addTextStyleToggle(config: {\n    icon: InlineActionConfigItem['icon'];\n    key: Exclude<\n      keyof AffineTextAttributes,\n      'color' | 'background' | 'reference'\n    >;\n    action: InlineActionConfigItem['action'];\n  }) {\n    const { key } = config;\n    return this.addInlineAction({\n      id: key,\n      name: camelCaseToWords(key),\n      icon: config.icon,\n      isActive: chain => {\n        const [result] = chain.isTextStyleActive({ key }).run();\n        return result;\n      },\n      action: config.action,\n      showWhen: chain => {\n        const [result] = isFormatSupported(chain).run();\n        return result;\n      },\n    });\n  }\n\n  addBlockTypeSwitch(config: {\n    flavour: BlockSuite.Flavour;\n    icon: ParagraphActionConfigItem['icon'];\n    type?: string;\n    name?: string;\n  }) {\n    const { flavour, type, icon } = config;\n    return this.addParagraphAction({\n      id: `${flavour}/${type ?? ''}`,\n      icon,\n      flavour,\n      name: config.name ?? camelCaseToWords(type ?? flavour),\n      action: chain => {\n        chain\n          .updateBlockType({\n            flavour,\n            props: type != null ? { type } : undefined,\n          })\n          .run();\n      },\n    });\n  }\n\n  addRawConfigItems(configItems: FormatBarConfigItem[], index?: number) {\n    if (index === undefined) {\n      this.configItems.push(...configItems);\n    } else {\n      this.configItems.splice(index, 0, ...configItems);\n    }\n    return this;\n  }\n\n  clearConfig() {\n    this.configItems = [];\n    return this;\n  }\n\n  override render() {\n    if (!this._shouldDisplay()) {\n      return nothing;\n    }\n\n    const items = ConfigRenderer(this);\n\n    return html`<div\n      class=\"${AFFINE_FORMAT_BAR_WIDGET}\"\n      @pointerdown=\"${(event: Event) => {\n        event.stopPropagation();\n        event.preventDefault();\n      }}\"\n      @wheel=\"${stopPropagation}\"\n    >\n      ${items}\n    </div>`;\n  }\n}\n\nfunction camelCaseToWords(s: string) {\n  const result = s.replace(/([A-Z])/g, ' $1');\n  return result.charAt(0).toUpperCase() + result.slice(1);\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_FORMAT_BAR_WIDGET]: AffineFormatBarWidget;\n  }\n}\n"]}