{"version":3,"file":"highlight-button.js","sourceRoot":"","sources":["../../../../../../src/root-block/widgets/format-bar/components/highlight/highlight-button.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { computePosition, flip, offset, shift } from '@floating-ui/dom';\nimport { html } from 'lit';\nimport { ref, type RefOrCallback } from 'lit/directives/ref.js';\n\nimport { whenHover } from '../../../../../_common/components/hover/index.js';\nimport {\n  ArrowDownIcon,\n  HighLightDuotoneIcon,\n  TextBackgroundDuotoneIcon,\n  TextForegroundDuotoneIcon,\n} from '../../../../../_common/icons/index.js';\nimport type { AffineTextAttributes } from '../../../../../_common/inline/presets/affine-inline-specs.js';\nimport type { AffineFormatBarWidget } from '../../format-bar.js';\nimport { backgroundConfig, foregroundConfig } from './consts.js';\n\nenum HighlightType {\n  Foreground,\n  Background,\n}\n\nlet lastUsedColor: string | null = null;\nlet lastUsedHighlightType: HighlightType = HighlightType.Background;\n\nconst updateHighlight = (\n  host: EditorHost,\n  color: string | null,\n  highlightType: HighlightType\n) => {\n  lastUsedColor = color;\n  lastUsedHighlightType = highlightType;\n\n  const payload: {\n    styles: AffineTextAttributes;\n  } = {\n    styles: {\n      color: highlightType === HighlightType.Foreground ? color : null,\n      background: highlightType === HighlightType.Background ? color : null,\n    },\n  };\n  host.std.command\n    .chain()\n    .try(chain => [\n      chain.getTextSelection().formatText(payload),\n      chain.getBlockSelections().formatBlock(payload),\n      chain.formatNative(payload),\n    ])\n    .run();\n};\n\nconst HighlightPanel = (\n  formatBar: AffineFormatBarWidget,\n  containerRef?: RefOrCallback\n) => {\n  return html`<div ${ref(containerRef)} class=\"highlight-panel\">\n    <!-- Text Color Highlight -->\n    <div class=\"highligh-panel-heading\">颜色</div>\n    ${foregroundConfig.map(\n      ({ name, color }) =>\n        html`<icon-button\n          width=\"100%\"\n          height=\"32px\"\n          style=\"padding-left: 4px; justify-content: flex-start; gap: 8px;\"\n          text=\"${name}\"\n          data-testid=\"${color ?? 'unset'}\"\n          @click=\"${() => {\n            updateHighlight(formatBar.host, color, HighlightType.Foreground);\n            formatBar.requestUpdate();\n          }}\"\n        >\n          <span style=\"color: ${color}; display: flex; align-items: center;\">\n            ${TextForegroundDuotoneIcon}\n          </span>\n        </icon-button>`\n    )}\n\n    <!-- Text Background Highlight -->\n    <div class=\"highligh-panel-heading\">背景</div>\n    ${backgroundConfig.map(\n      ({ name, color }) =>\n        html`<icon-button\n          width=\"100%\"\n          height=\"32px\"\n          style=\"padding-left: 4px; justify-content: flex-start; gap: 8px;\"\n          text=\"${name}\"\n          @click=\"${() => {\n            updateHighlight(formatBar.host, color, HighlightType.Background);\n            formatBar.requestUpdate();\n          }}\"\n        >\n          <span\n            style=\"color: ${color ??\n            'rgba(0,0,0,0)'}; display: flex; align-items: center;\"\n          >\n            ${TextBackgroundDuotoneIcon}\n          </span>\n        </icon-button>`\n    )}\n  </div>`;\n};\n\nexport const HighlightButton = (formatBar: AffineFormatBarWidget) => {\n  const editorHost = formatBar.host;\n\n  const { setFloating, setReference } = whenHover(isHover => {\n    if (!isHover) {\n      const panel =\n        formatBar.shadowRoot?.querySelector<HTMLElement>('.highlight-panel');\n      if (!panel) return;\n      panel.style.display = 'none';\n      return;\n    }\n    const button =\n      formatBar.shadowRoot?.querySelector<HTMLElement>('.highlight-button');\n    const panel =\n      formatBar.shadowRoot?.querySelector<HTMLElement>('.highlight-panel');\n    assertExists(button);\n    assertExists(panel);\n    panel.style.display = 'block';\n    computePosition(button, panel, {\n      placement: 'bottom',\n      middleware: [\n        flip(),\n        offset(10),\n        shift({\n          padding: 6,\n        }),\n      ],\n    })\n      .then(({ x, y }) => {\n        panel.style.left = `${x}px`;\n        panel.style.top = `${y}px`;\n      })\n      .catch(console.error);\n  });\n\n  const highlightPanel = HighlightPanel(formatBar, setFloating);\n\n  return html`<div ${ref(setReference)} class=\"highlight-button\">\n    <icon-button\n      class=\"highlight-icon\"\n      data-last-used=\"${lastUsedColor ?? 'unset'}\"\n      width=\"52px\"\n      height=\"32px\"\n      @click=\"${() =>\n        updateHighlight(editorHost, lastUsedColor, lastUsedHighlightType)}\"\n    >\n      <span\n        style=\"color: ${lastUsedColor}; display: flex; align-items: center; \"\n        >${HighLightDuotoneIcon}</span\n      >\n      ${ArrowDownIcon}</icon-button\n    >\n    ${highlightPanel}\n  </div>`;\n};\n"]}