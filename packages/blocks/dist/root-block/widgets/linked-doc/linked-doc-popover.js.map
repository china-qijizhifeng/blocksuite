{"version":3,"file":"linked-doc-popover.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/linked-doc/linked-doc-popover.ts"],"names":[],"mappings":"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","sourcesContent":["import '../../../_common/components/button.js';\n\nimport type { EditorHost } from '@blocksuite/block-std';\nimport { WithDisposable } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { html, LitElement } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport {\n  cleanSpecifiedTail,\n  createKeydownObserver,\n} from '../../../_common/components/utils.js';\nimport type { AffineInlineEditor } from '../../../_common/inline/presets/affine-inline-specs.js';\nimport type { LinkedDocOptions } from './config.js';\nimport type { LinkedDocGroup } from './config.js';\nimport { styles } from './styles.js';\n\n@customElement('affine-linked-doc-popover')\nexport class LinkedDocPopover extends WithDisposable(LitElement) {\n  private get _flattenActionList() {\n    return this._actionGroup\n      .map(group =>\n        group.items.map(item => ({ ...item, groupName: group.name }))\n      )\n      .flat();\n  }\n\n  private get _doc() {\n    return this.editorHost.doc;\n  }\n\n  static override styles = styles;\n\n  @state()\n  private accessor _position: {\n    height: number;\n    x: string;\n    y: string;\n  } | null = null;\n\n  @state()\n  private accessor _query = '';\n\n  @state()\n  private accessor _activatedItemIndex = 0;\n\n  private _actionGroup: LinkedDocGroup[] = [];\n\n  @property({ attribute: false })\n  accessor options!: LinkedDocOptions;\n\n  @property({ attribute: false })\n  accessor triggerKey!: string;\n\n  @query('.linked-doc-popover')\n  accessor linkedDocElement: Element | null = null;\n\n  constructor(\n    private editorHost: EditorHost,\n    private inlineEditor: AffineInlineEditor,\n    private abortController = new AbortController()\n  ) {\n    super();\n  }\n\n  private _updateActionList() {\n    this._actionGroup = this.options.getMenus({\n      editorHost: this.editorHost,\n      query: this._query,\n      inlineEditor: this.inlineEditor,\n      docMetas: this._doc.collection.meta.docMetas,\n    });\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    const inlineEditor = this.inlineEditor;\n    assertExists(inlineEditor, 'RichText InlineEditor not found');\n\n    // init\n    this._updateActionList();\n    this._disposables.add(\n      this._doc.collection.slots.docUpdated.on(() => {\n        this._updateActionList();\n      })\n    );\n    this._disposables.addFromEvent(this, 'mousedown', e => {\n      // Prevent input from losing focus\n      e.preventDefault();\n    });\n\n    createKeydownObserver({\n      target: inlineEditor.eventSource,\n      inlineEditor,\n      onUpdateQuery: str => {\n        this._query = str;\n        this._activatedItemIndex = 0;\n        this._updateActionList();\n      },\n      abortController: this.abortController,\n      onMove: step => {\n        const itemLen = this._flattenActionList.length;\n        this._activatedItemIndex =\n          (itemLen + this._activatedItemIndex + step) % itemLen;\n\n        // Scroll to the active item\n        const item = this._flattenActionList[this._activatedItemIndex];\n        const shadowRoot = this.shadowRoot;\n        if (!shadowRoot) {\n          console.warn('Failed to find the shadow root!', this);\n          return;\n        }\n        const ele = shadowRoot.querySelector(\n          `icon-button[data-id=\"${item.key}\"]`\n        );\n        if (!ele) {\n          console.warn('Failed to find the active item!', item);\n          return;\n        }\n        ele.scrollIntoView({\n          block: 'nearest',\n        });\n      },\n      onConfirm: () => {\n        this.abortController.abort();\n        cleanSpecifiedTail(\n          this.editorHost,\n          this.inlineEditor,\n          this.triggerKey + this._query\n        );\n        this._flattenActionList[this._activatedItemIndex]\n          .action()\n          ?.catch(console.error);\n      },\n      onEsc: () => {\n        this.abortController.abort();\n      },\n    });\n  }\n\n  updatePosition(position: { height: number; x: string; y: string }) {\n    this._position = position;\n  }\n\n  override render() {\n    const MAX_HEIGHT = 396;\n    const style = this._position\n      ? styleMap({\n          transform: `translate(${this._position.x}, ${this._position.y})`,\n          maxHeight: `${Math.min(this._position.height, MAX_HEIGHT)}px`,\n        })\n      : styleMap({\n          visibility: 'hidden',\n        });\n\n    // XXX This is a side effect\n    let accIdx = 0;\n    return html`<div class=\"linked-doc-popover\" style=\"${style}\">\n      ${this._actionGroup\n        .filter(group => group.items.length)\n        .map((group, idx) => {\n          return html`\n            <div class=\"divider\" ?hidden=${idx === 0}></div>\n            <div class=\"group-title\">${group.name}</div>\n            <div class=\"group\" style=${group.styles ?? ''}>\n              ${group.items.map(({ key, name, icon, action }) => {\n                accIdx++;\n                const curIdx = accIdx - 1;\n                return html`<icon-button\n                  width=\"280px\"\n                  height=\"32px\"\n                  data-id=${key}\n                  text=${name}\n                  ?hover=${this._activatedItemIndex === curIdx}\n                  @click=${() => {\n                    this.abortController.abort();\n                    cleanSpecifiedTail(\n                      this.editorHost,\n                      this.inlineEditor,\n                      this.triggerKey + this._query\n                    );\n                    action()?.catch(console.error);\n                  }}\n                  @mousemove=${() => {\n                    // Use `mousemove` instead of `mouseover` to avoid navigate conflict with keyboard\n                    this._activatedItemIndex = curIdx;\n                  }}\n                  >${icon}</icon-button\n                >`;\n              })}\n            </div>\n          `;\n        })}\n    </div>`;\n  }\n}\n"]}