{"version":3,"file":"config.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/linked-doc/config.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { DocMeta } from '@blocksuite/store';\nimport type { TemplateResult } from 'lit';\n\nimport { toast } from '../../../_common/components/toast.js';\nimport {\n  DocIcon,\n  ImportIcon,\n  NewDocIcon,\n} from '../../../_common/icons/index.js';\nimport type { AffineInlineEditor } from '../../../_common/inline/presets/affine-inline-specs.js';\nimport { REFERENCE_NODE } from '../../../_common/inline/presets/nodes/consts.js';\nimport { createDefaultDoc } from '../../../_common/utils/init.js';\nimport { isFuzzyMatch } from '../../../_common/utils/string.js';\nimport { showImportModal } from './import-doc/index.js';\n\nexport type LinkedDocOptions = {\n  triggerKeys: string[];\n  ignoreBlockTypes: BlockSuite.Flavour[];\n  convertTriggerKey: boolean;\n  getMenus: (ctx: {\n    editorHost: EditorHost;\n    query: string;\n    inlineEditor: AffineInlineEditor;\n    docMetas: DocMeta[];\n  }) => LinkedDocGroup[];\n};\n\nexport type LinkedDocItem = {\n  key: string;\n  name: string;\n  icon: TemplateResult<1>;\n  // suffix?: TemplateResult<1>;\n  // disabled?: boolean;\n  action: () => Promise<void> | void;\n};\n\nexport type LinkedDocGroup = {\n  name: string;\n  styles?: string;\n  items: LinkedDocItem[];\n};\n\nconst DEFAULT_DOC_NAME = 'Untitled';\nconst DISPLAY_NAME_LENGTH = 8;\n\nexport function insertLinkedNode({\n  inlineEditor,\n  docId,\n}: {\n  inlineEditor: AffineInlineEditor;\n  docId: string;\n}) {\n  assertExists(inlineEditor, 'Editor not found');\n  const inlineRange = inlineEditor.getInlineRange();\n  assertExists(inlineRange);\n  inlineEditor.insertText(inlineRange, REFERENCE_NODE, {\n    reference: { type: 'LinkedPage', pageId: docId },\n  });\n  inlineEditor.setInlineRange({\n    index: inlineRange.index + 1,\n    length: 0,\n  });\n}\n\nexport const getMenus: (ctx: {\n  editorHost: EditorHost;\n  query: string;\n  inlineEditor: AffineInlineEditor;\n  docMetas: DocMeta[];\n}) => LinkedDocGroup[] = ({ editorHost, query, inlineEditor, docMetas }) => {\n  const doc = editorHost.doc;\n  const docName = query || DEFAULT_DOC_NAME;\n  const displayDocName =\n    docName.slice(0, DISPLAY_NAME_LENGTH) +\n    (docName.length > DISPLAY_NAME_LENGTH ? '..' : '');\n\n  const filteredDocList = docMetas\n    .filter(({ id }) => id !== doc.id)\n    .filter(({ title }) => isFuzzyMatch(title, query));\n\n  return [\n    {\n      name: 'Link to Doc',\n      styles: 'overflow-y: scroll; max-height: 224px;',\n      items: filteredDocList.map(doc => ({\n        key: doc.id,\n        name: doc.title || DEFAULT_DOC_NAME,\n        icon: DocIcon,\n        action: () => {\n          insertLinkedNode({\n            inlineEditor,\n            docId: doc.id,\n          });\n          editorHost.spec\n            .getService('affine:page')\n            .telemetryService?.track('LinkedDocCreated', {\n              control: 'linked doc',\n              module: 'inline @',\n              type: 'doc',\n              other: 'existing doc',\n            });\n        },\n      })),\n    },\n    {\n      name: 'New Doc',\n      items: [\n        {\n          key: 'create',\n          name: `Create \"${displayDocName}\" doc`,\n          icon: NewDocIcon,\n          action: () => {\n            const docName = query;\n            const newDoc = createDefaultDoc(doc.collection, {\n              title: docName,\n            });\n            insertLinkedNode({\n              inlineEditor,\n              docId: newDoc.id,\n            });\n            const telemetryService =\n              editorHost.spec.getService('affine:page').telemetryService;\n            telemetryService?.track('LinkedDocCreated', {\n              control: 'new doc',\n              module: 'inline @',\n              type: 'doc',\n              other: 'new doc',\n            });\n            telemetryService?.track('DocCreated', {\n              control: 'new doc',\n              module: 'inline @',\n              type: 'doc',\n            });\n          },\n        },\n        {\n          key: 'import',\n          name: 'Import',\n          icon: ImportIcon,\n          action: () => {\n            const onSuccess = (\n              docIds: string[],\n              options: {\n                importedCount: number;\n              }\n            ) => {\n              toast(\n                editorHost,\n                `Successfully imported ${options.importedCount} Doc${options.importedCount > 1 ? 's' : ''}.`\n              );\n              for (const docId of docIds) {\n                insertLinkedNode({\n                  inlineEditor,\n                  docId,\n                });\n              }\n            };\n            const onFail = (message: string) => {\n              toast(editorHost, message);\n            };\n            showImportModal({\n              collection: doc.collection,\n              onSuccess,\n              onFail,\n            });\n          },\n        },\n      ],\n    },\n  ] satisfies LinkedDocGroup[];\n};\n"]}