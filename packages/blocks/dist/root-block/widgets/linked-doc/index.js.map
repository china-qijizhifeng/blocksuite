{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/linked-doc/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost, UIEventStateContext } from '@blocksuite/block-std';\nimport { WidgetElement } from '@blocksuite/block-std';\nimport {\n  assertExists,\n  DisposableGroup,\n  throttle,\n} from '@blocksuite/global/utils';\nimport { InlineEditor } from '@blocksuite/inline';\nimport { customElement } from 'lit/decorators.js';\n\nimport type { AffineInlineEditor } from '../../../_common/inline/presets/affine-inline-specs.js';\nimport { isControlledKeyboardEvent } from '../../../_common/utils/event.js';\nimport { matchFlavours } from '../../../_common/utils/index.js';\nimport {\n  getInlineEditorByModel,\n  getViewportElement,\n} from '../../../_common/utils/query.js';\nimport { getCurrentNativeRange } from '../../../_common/utils/selection.js';\nimport { getPopperPosition } from '../../../root-block/utils/position.js';\nimport { getMenus, type LinkedDocOptions } from './config.js';\nimport { LinkedDocPopover } from './linked-doc-popover.js';\n\nexport function showLinkedDocPopover({\n  editorHost,\n  inlineEditor,\n  range,\n  container = document.body,\n  abortController = new AbortController(),\n  options,\n  triggerKey,\n}: {\n  editorHost: EditorHost;\n  inlineEditor: AffineInlineEditor;\n  range: Range;\n  container?: HTMLElement;\n  abortController?: AbortController;\n  options: LinkedDocOptions;\n  triggerKey: string;\n}) {\n  const disposables = new DisposableGroup();\n  abortController.signal.addEventListener('abort', () => disposables.dispose());\n\n  const linkedDoc = new LinkedDocPopover(\n    editorHost,\n    inlineEditor,\n    abortController\n  );\n  linkedDoc.options = options;\n  linkedDoc.triggerKey = triggerKey;\n  // Mount\n  container.append(linkedDoc);\n  disposables.add(() => linkedDoc.remove());\n\n  // Handle position\n  const updatePosition = throttle(() => {\n    const linkedDocElement = linkedDoc.linkedDocElement;\n    assertExists(\n      linkedDocElement,\n      'You should render the linked doc node even if no position'\n    );\n    const position = getPopperPosition(linkedDocElement, range);\n    linkedDoc.updatePosition(position);\n  }, 10);\n  disposables.addFromEvent(window, 'resize', updatePosition);\n  const scrollContainer = getViewportElement(editorHost);\n  if (scrollContainer) {\n    // Note: in edgeless mode, the scroll container is not exist!\n    disposables.addFromEvent(scrollContainer, 'scroll', updatePosition, {\n      passive: true,\n    });\n  }\n\n  // Wait for node to be mounted\n  setTimeout(updatePosition);\n\n  disposables.addFromEvent(window, 'mousedown', (e: Event) => {\n    if (e.target === linkedDoc) return;\n    abortController.abort();\n  });\n\n  return linkedDoc;\n}\n\nexport const AFFINE_LINKED_DOC_WIDGET = 'affine-linked-doc-widget';\n\n@customElement(AFFINE_LINKED_DOC_WIDGET)\nexport class AffineLinkedDocWidget extends WidgetElement {\n  static DEFAULT_OPTIONS: LinkedDocOptions = {\n    /**\n     * The first item of the trigger keys will be the primary key\n     */\n    triggerKeys: ['@', '[[', '【【'],\n    ignoreBlockTypes: ['affine:code'],\n    /**\n     * Convert trigger key to primary key (the first item of the trigger keys)\n     */\n    convertTriggerKey: true,\n    getMenus,\n  };\n\n  options = AffineLinkedDocWidget.DEFAULT_OPTIONS;\n\n  private getInlineEditor = (evt: KeyboardEvent) => {\n    const text = this.host.selection.value.find(selection =>\n      selection.is('text')\n    );\n    if (!text) return;\n    const model = this.host.doc.getBlockById(text.blockId);\n    if (!model || matchFlavours(model, this.options.ignoreBlockTypes)) return;\n\n    if (evt.target instanceof HTMLElement) {\n      const editor = (\n        evt.target.closest('.inline-editor') as {\n          inlineEditor?: AffineInlineEditor;\n        }\n      )?.inlineEditor;\n      if (editor instanceof InlineEditor) {\n        return editor;\n      }\n    }\n\n    return getInlineEditorByModel(this.host, model);\n  };\n\n  private _onKeyDown = (ctx: UIEventStateContext) => {\n    const eventState = ctx.get('keyboardState');\n    const event = eventState.raw;\n    if (isControlledKeyboardEvent(event) || event.key.length !== 1) return;\n    const inlineEditor = this.getInlineEditor(event);\n    if (!inlineEditor) return;\n    const inlineRange = inlineEditor.getInlineRange();\n    if (!inlineRange) return;\n    if (inlineRange.length > 0) {\n      // When select text and press `[[` should not trigger transform,\n      // since it will break the bracket complete.\n      // Expected `[[selected text]]` instead of `@selected text]]`\n      return;\n    }\n\n    const [leafStart, offsetStart] = inlineEditor.getTextPoint(\n      inlineRange.index\n    );\n    const prefixText = leafStart.textContent\n      ? leafStart.textContent.slice(0, offsetStart)\n      : '';\n\n    const matchedKey = this.options.triggerKeys.find(triggerKey =>\n      (prefixText + event.key).endsWith(triggerKey)\n    );\n    if (!matchedKey) return;\n\n    const primaryTriggerKey = this.options.triggerKeys[0];\n    inlineEditor.slots.inlineRangeApply.once(() => {\n      if (this.options.convertTriggerKey && primaryTriggerKey !== matchedKey) {\n        // Convert to the primary trigger key\n        // e.g. [[ -> @\n        const startIdxBeforeMatchKey =\n          inlineRange.index - (matchedKey.length - 1);\n        inlineEditor.deleteText({\n          index: startIdxBeforeMatchKey,\n          length: matchedKey.length,\n        });\n        inlineEditor.insertText(\n          { index: startIdxBeforeMatchKey, length: 0 },\n          primaryTriggerKey\n        );\n        inlineEditor.setInlineRange({\n          index: startIdxBeforeMatchKey + primaryTriggerKey.length,\n          length: 0,\n        });\n        inlineEditor.slots.inlineRangeApply.once(() => {\n          this.showLinkedDoc(inlineEditor, primaryTriggerKey);\n        });\n        return;\n      }\n      this.showLinkedDoc(inlineEditor, matchedKey);\n    });\n  };\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.handleEvent('keyDown', this._onKeyDown);\n  }\n\n  showLinkedDoc = (inlineEditor: AffineInlineEditor, triggerKey: string) => {\n    const curRange = getCurrentNativeRange();\n    if (!curRange) return;\n    showLinkedDocPopover({\n      editorHost: this.host,\n      inlineEditor,\n      range: curRange,\n      options: this.options,\n      triggerKey,\n    });\n  };\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_LINKED_DOC_WIDGET]: AffineLinkedDocWidget;\n  }\n}\n"]}