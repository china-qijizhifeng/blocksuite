{"version":3,"file":"root-service.js","sourceRoot":"","sources":["../../src/root-block/root-service.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,YAAY,EAAE,MAAM,uBAAuB,CAAC;AACrD,OAAO,EAAE,YAAY,EAAE,MAAM,0BAA0B,CAAC;AAGxD,OAAO,EACL,eAAe,GAEhB,MAAM,4CAA4C,CAAC;AACpD,OAAO,EACL,oBAAoB,EAEpB,gCAAgC,EAEhC,wBAAwB,GAEzB,MAAM,gCAAgC,CAAC;AACxC,OAAO,EACL,4BAA4B,EAC5B,iBAAiB,EACjB,gBAAgB,GACjB,MAAM,sBAAsB,CAAC;AAC9B,OAAO,EAAE,aAAa,EAAE,MAAM,6CAA6C,CAAC;AAC5E,OAAO,EACL,eAAe,EACf,mBAAmB,EACnB,cAAc,GACf,MAAM,kCAAkC,CAAC;AAC1C,OAAO,EAAuB,eAAe,EAAE,MAAM,qBAAqB,CAAC;AAC3E,OAAO,EAAE,mBAAmB,EAAE,MAAM,2BAA2B,CAAC;AAChE,OAAO,EAAE,aAAa,EAAE,MAAM,2BAA2B,CAAC;AAC1D,OAAO,EAAE,kBAAkB,EAAE,MAAM,+BAA+B,CAAC;AAEnE,OAAO,EAAE,wBAAwB,EAAE,MAAM,4BAA4B,CAAC;AACtE,OAAO,EAAE,KAAK,EAAE,GAAG,EAAE,MAAM,2BAA2B,CAAC;AACvD,OAAO,EAAE,cAAc,EAAE,MAAM,2CAA2C,CAAC;AAC3E,OAAO,EACL,yBAAyB,EACzB,2BAA2B,EAC3B,iBAAiB,EACjB,kBAAkB,EAClB,mBAAmB,EACnB,iBAAiB,EACjB,oBAAoB,EACpB,yBAAyB,EACzB,yBAAyB,EACzB,mBAAmB,EACnB,mBAAmB,EACnB,wBAAwB,EACxB,wBAAwB,EACxB,uBAAuB,GACxB,MAAM,qBAAqB,CAAC;AAE7B,OAAO,EAAE,UAAU,EAAE,MAAM,8BAA8B,CAAC;AA0D1D,MAAM,OAAO,WAAY,SAAQ,YAA4B;IAA7D;;QAiCU,qBAAgB,GAAoB;YAC1C,OAAO,EAAE,IAAI,CAAC,OAAO;SACtB,CAAC;QAEM,mBAAc,GAAG;YACvB,kBAAkB,EAAE,4BAA4B;SACjD,CAAC;QAEM,wBAAmB,GAAG,IAAI,GAAG,EAAgB,CAAC;QAE7C,eAAU,GAAG,IAAI,UAAU,EAAE,CAAC;QAE9B,mBAAc,GAAmB,IAAI,cAAc,CAAC,IAAI,CAAC,CAAC;QAMnE,gCAAgC;QAChC,wBAAmB,GAA+B,IAAI,CAAC;QAEvD,oBAAe,GAA2B,IAAI,CAAC;QAE/C,mBAAc,GAAmB,oBAAoB,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;QAEnE,uBAAkB,GAA8B,IAAI,CAAC;QAErD,qBAAgB,GAA4B,IAAI,CAAC;QAEjD,iBAAY,GAAG;YACb,QAAQ,EAAE,mBAAmB;YAC7B,IAAI,EAAE,eAAe;YACrB,GAAG,EAAE,cAAc;SACpB,CAAC;QAoBM,+BAA0B,GAAG,GAGnC,EAAE;YACF,MAAM,WAAW,GAAG,IAAI,CAAC,cAAc,CAAC,OAAO,EAAE,CAAC;YAClD,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC;YAC3B,IAAI,CAAC,IAAI;gBACP,OAAO;oBACL,KAAK,EAAE,SAAS;oBAChB,KAAK,EAAE,IAAI;iBACZ,CAAC;YAEJ,IAAI,WAAW,KAAK,UAAU,EAAE,CAAC;gBAC/B,MAAM,OAAO,GACX,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,KAAK,gBAAgB,CAAC,IAAI,IAAI,CAAC;gBAC1E,OAAO,EAAE,KAAK,EAAE,SAAS,EAAE,KAAK,EAAE,OAAO,EAAE,CAAC;YAC9C,CAAC;YAED,IAAI,WAAW,KAAK,MAAM,EAAE,CAAC;gBAC3B,IAAI,aAAa,GAAsB,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC;gBACrE,IAAI,KAAK,GAAuB,SAAS,CAAC;gBAE1C,IAAI,CAAC,aAAa,EAAE,CAAC;oBACnB,yDAAyD;oBACzD,aAAa,GAAG,IAAI,CAAC,iBAAiB,EAAE,CAAC;gBAC3C,CAAC;gBAED,OAAO,aAAa,IAAI,aAAa,CAAC,OAAO,KAAK,aAAa,EAAE,CAAC;oBAChE,wDAAwD;oBACxD,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,aAAa,CAAC,EAAE,CAAC,CAAC;oBACpD,KAAK,GAAG,MAAM,EAAE,QAAQ,CAAC,OAAO,CAAC,aAAa,CAAC,CAAC;oBAChD,aAAa,GAAG,MAAM,CAAC;gBACzB,CAAC;gBAED,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,aAAa,EAAE,CAAC;YACzC,CAAC;YAED,OAAO;gBACL,KAAK,EAAE,SAAS;gBAChB,KAAK,EAAE,IAAI;aACZ,CAAC;QACJ,CAAC,CAAC;QAEM,gBAAW,GAAG,CACpB,OAAe,EACf,WAA2B,EAC3B,KAA8B,EAC9B,EAAE;YACF,MAAM,IAAI,GAAG,IAAI,CAAC,IAAkB,CAAC;YAErC,MAAM,IAAI,GAAG,IAAI,CAAC,cAAc,CAAC,OAAO,EAAE,CAAC;YAC3C,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,IAAI,CAAC,0BAA0B,EAAE,CAAC;YAE3D,IAAI,IAAI,KAAK,MAAM,EAAE,CAAC;gBACpB,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,OAAgB,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC;gBACzD,OAAO;YACT,CAAC;YACD,IAAI,IAAI,KAAK,UAAU,EAAE,CAAC;gBACxB,MAAM,YAAY,GAAG,mBAAmB,CACtC,IAAI,CACgC,CAAC;gBACvC,IAAI,CAAC,YAAY;oBAAE,OAAO;gBAE1B,YAAY,CAAC,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;gBAC5C,MAAM,OAAO,GAAG,YAAY,CAAC,OAAO,CAAC;gBACrC,MAAM,MAAM,GAAG,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;gBAClD,MAAM,MAAM,GAAG,YAAY,CAAC,OAAO,CAAC,QAAQ,CAC1C,OAAO,EACP;oBACE,GAAG,KAAK;oBACR,IAAI,EAAE,KAAK,CAAC,UAAU,CACpB,MAAM,EACN,gBAAgB,CAAC,WAAW,CAAC,EAC7B,iBAAiB,CAAC,WAAW,CAAC,CAC/B,CAAC,SAAS,EAAE;oBACb,KAAK,EAAE,WAAW;iBACnB,EACD,OAAO,CAAC,KAAK,CACd,CAAC;gBAEF,YAAY,CAAC,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC;oBACjC,QAAQ,EAAE,CAAC,MAAM,CAAC;oBAClB,OAAO,EAAE,KAAK;iBACf,CAAC,CAAC;gBAEH,YAAY,CAAC,KAAK,CAAC,eAAe,CAAC;oBACjC,IAAI,EAAE,SAAS;iBAChB,CAAC,CAAC;gBACH,OAAO;YACT,CAAC;QACH,CAAC,CAAC;QAEM,gBAAW,GAAG,CAAC,GAAW,EAAE,EAAE;YACpC,MAAM,IAAI,GAAG,IAAI,CAAC,IAAkB,CAAC;YACrC,MAAM,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,CAAC;YAExD,MAAM,YAAY,GAAG,WAAW,CAAC,oBAAoB,CAAC,GAAG,CAAC,CAAC;YAE3D,IAAI,OAAO,GAAG,iBAAiB,CAAC;YAChC,IAAI,WAAW,GAAmB,UAAU,CAAC;YAC7C,MAAM,KAAK,GAA4B,EAAE,GAAG,EAAE,CAAC;YAC/C,IAAI,YAAY,EAAE,CAAC;gBACjB,OAAO,GAAG,YAAY,CAAC,OAAO,CAAC;gBAC/B,WAAW,GAAG,YAAY,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;YACvC,CAAC;YAED,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,WAAW,EAAE,KAAK,CAAC,CAAC;YAC9C,OAAO,OAAO,CAAC;QACjB,CAAC,CAAC;QAEM,eAAU,GAAG,CAAC,KAAa,EAAE,EAAE;YACrC,MAAM,OAAO,GAAG,yBAAyB,CAAC;YAC1C,MAAM,WAAW,GAAmB,UAAU,CAAC;YAC/C,MAAM,KAAK,GAA4B,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC;YAEzD,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,WAAW,EAAE,KAAK,CAAC,CAAC;YAC9C,OAAO,OAAO,CAAC;QACjB,CAAC,CAAC;QAEF,8BAAyB,GAAG,CAAC,OAAqB,EAAQ,EAAE;YAC1D,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;QACxC,CAAC,CAAC;QAEF,yBAAoB,GAAG,CAAC,GAAW,EAAuB,EAAE;YAC1D,MAAM,OAAO,GAAG,IAAI,CAAC,mBAAmB,CAAC,OAAO,EAAE,CAAC;YACnD,KAAK,MAAM,CAAC,OAAO,CAAC,IAAI,OAAO,EAAE,CAAC;gBAChC,MAAM,KAAK,GAAG,OAAO,CAAC,QAAQ,CAAC;gBAC/B,IAAI,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC;oBAAE,OAAO,OAAO,CAAC;YACtC,CAAC;YACD,OAAO,IAAI,CAAC;QACd,CAAC,CAAC;QAyDF,oBAAe,GAAG,CAAC,OAAe,EAAE,EAAE,EAAE;YACtC,MAAM,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;YACrB,IAAI,CAAC,GAAG,CAAC,IAAI;gBAAE,OAAO;YACtB,IAAI,GAAG,CAAC,QAAQ;gBAAE,OAAO;YACzB,IAAI,MAAM,GAAG,IAAI,CAAC,iBAAiB,EAAE,EAAE,EAAE,CAAC;YAC1C,IAAI,CAAC,MAAM,EAAE,CAAC;gBACZ,MAAM,GAAG,GAAG,CAAC,QAAQ,CAAC,aAAa,EAAE,EAAE,EAAE,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;YACxD,CAAC;YACD,MAAM,EAAE,GAAG,GAAG,CAAC,QAAQ,CACrB,kBAAkB,EAClB,EAAE,IAAI,EAAE,IAAI,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,EAC5B,MAAM,CACP,CAAC;YAEF,kBAAkB,CAAC,IAAI,CAAC,IAAkB,EAAE,EAAE,EAAE;gBAC9C,KAAK,EAAE,IAAI,CAAC,MAAM;gBAClB,MAAM,EAAE,CAAC;aACV,CAAC,EAAE,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QAC3B,CAAC,CAAC;QAEF,4BAAuB,GAAG,KAAK,EAC7B,SAAkB,EAClB,aAAuB,EAOvB,EAAE;YACF,IAAI,CAAC,IAAI,CAAC,kBAAkB;gBAAE,OAAO;YAErC,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,SAAS,CAAC;gBACrD,MAAM,EAAE,QAAQ;gBAChB,SAAS;gBACT,aAAa;aACd,CAAC,CAAC;YACH,IAAI,CAAC,MAAM;gBAAE,OAAO;YAEpB,iBAAiB;YACjB,IAAI,OAAO,IAAI,MAAM,EAAE,CAAC;gBACtB,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;gBAC9B,OAAO,EAAE,OAAO,EAAE,yBAAyB,EAAE,QAAQ,EAAE,MAAM,CAAC,QAAQ,EAAE,CAAC;YAC3E,CAAC;YAED,mBAAmB;YACnB,IAAI,WAAW,IAAI,MAAM,EAAE,CAAC;gBAC1B,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;gBACnC,OAAO;oBACL,OAAO,EAAE,iBAAiB;iBAC3B,CAAC;YACJ,CAAC;YAED,OAAO;QACT,CAAC,CAAC;IACJ,CAAC;IAvUC,IAAI,eAAe;QACjB,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE;YACtD,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,IAAI,EAAE,EAAE,IAAI,EAAE;SAC5B,CAA8B,CAAC;QAChC,YAAY,CAAC,WAAW,CAAC,CAAC;QAC1B,MAAM,eAAe,GAAG,WAAW,CAAC,eAAqC,CAAC;QAC1E,YAAY,CAAC,eAAe,CAAC,CAAC;QAC9B,OAAO,eAAe,CAAC;IACzB,CAAC;IAED,IAAI,cAAc;QAChB,IAAI,MAAM,GAAmB,EAAE,CAAC;QAChC,IAAI,CAAC,GAAG,CAAC,OAAO;aACb,KAAK,EAAE;aACP,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC;YACf,KAAK,CAAC,gBAAgB,EAAE;YACxB,KAAK,CAAC,kBAAkB,EAAE;YAC1B,KAAK,CAAC,kBAAkB,EAAE;SAC3B,CAAC;aACD,iBAAiB,EAAE;aACnB,MAAM,CAAC,CAAC,EAAE,cAAc,EAAE,EAAE,EAAE;YAC7B,IAAI,CAAC,cAAc;gBAAE,OAAO;YAC5B,MAAM,GAAG,cAAc,CAAC;QAC1B,CAAC,CAAC;aACD,GAAG,EAAE,CAAC;QACT,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,IAAI,cAAc;QAChB,OAAO,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;IACvD,CAAC;IAqCO,iBAAiB;QACvB,MAAM,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;QACrB,IAAI,IAAI,GAA0B,IAAI,CAAC;QACvC,IAAI,CAAC,GAAG,CAAC,IAAI;YAAE,OAAO,IAAI,CAAC;QAC3B,MAAM,EAAE,QAAQ,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;QAC9B,KAAK,IAAI,CAAC,GAAG,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;YAC9C,MAAM,KAAK,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC;YAC1B,IACE,aAAa,CAAC,KAAK,EAAE,CAAC,aAAa,CAAC,CAAC;gBACrC,KAAK,CAAC,WAAW,KAAK,eAAe,CAAC,YAAY,EAClD,CAAC;gBACD,IAAI,GAAG,KAAuB,CAAC;gBAC/B,MAAM;YACR,CAAC;QACH,CAAC;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAsIQ,SAAS;QAChB,IAAI,CAAC,cAAc,CAAC,OAAO,EAAE,CAAC;QAC9B,IAAI,CAAC,UAAU,CAAC,KAAK,EAAE,CAAC;IAC1B,CAAC;IAEQ,OAAO;QACd,KAAK,CAAC,OAAO,EAAE,CAAC;QAEhB,IAAI,CAAC,GAAG,CAAC,OAAO;aACb,GAAG,CAAC,eAAe,EAAE,oBAAoB,CAAC;aAC1C,GAAG,CAAC,cAAc,EAAE,mBAAmB,CAAC;aACxC,GAAG,CAAC,cAAc,EAAE,mBAAmB,CAAC;aACxC,GAAG,CAAC,mBAAmB,EAAE,wBAAwB,CAAC;aAClD,GAAG,CAAC,oBAAoB,EAAE,yBAAyB,CAAC;aACpD,GAAG,CAAC,sBAAsB,EAAE,2BAA2B,CAAC;aACxD,GAAG,CAAC,mBAAmB,EAAE,wBAAwB,CAAC;aAClD,GAAG,CAAC,oBAAoB,EAAE,yBAAyB,CAAC;aACpD,GAAG,CAAC,oBAAoB,EAAE,yBAAyB,CAAC;aACpD,GAAG,CAAC,kBAAkB,EAAE,uBAAuB,CAAC;aAChD,GAAG,CAAC,YAAY,EAAE,iBAAiB,CAAC;aACpC,GAAG,CAAC,aAAa,EAAE,kBAAkB,CAAC;aACtC,GAAG,CAAC,cAAc,EAAE,mBAAmB,CAAC;aACxC,GAAG,CAAC,YAAY,EAAE,iBAAiB,CAAC;aACpC,GAAG,CAAC,mBAAmB,EAAE,wBAAwB,CAAC;aAClD,GAAG,CAAC,2BAA2B,EAAE,gCAAgC,CAAC,CAAC;QAEtE,IAAI,CAAC,SAAS,EAAE,CAAC;QAEjB,IAAI,CAAC,aAAa,GAAG,IAAI,aAAa,CAAC,IAAI,EAAE,IAAI,CAAC,cAAc,CAAC,CAAC;QAElE,IAAI,CAAC,eAAe,GAAG,IAAI,eAAe,CAAC,IAAI,EAAE,IAAI,CAAC,gBAAgB,CAAC,CAAC;QACxE,IAAI,CAAC,WAAW,CAAC,YAAY,CAC3B,IAAI,CAAC,IAAI,EACT,UAAU,EACV,IAAI,CAAC,eAAe,CAAC,UAAU,CAChC,CAAC;QAEF,IAAI,CAAC,WAAW,CAAC,YAAY,CAC3B,IAAI,CAAC,IAAI,EACT,WAAW,EACX,IAAI,CAAC,eAAe,CAAC,WAAW,CACjC,CAAC;QAEF,IAAI,CAAC,WAAW,CAAC,GAAG,CAClB,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,aAAa,EAAE,GAAG,CAAC,EAAE;YACtC,MAAM,KAAK,GAAG,GAAG,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC;YACtC,KAAK,CAAC,GAAG,CAAC,eAAe,EAAE,CAAC;QAC9B,CAAC,CAAC,CACH,CAAC;IACJ,CAAC;IAED,SAAS;QACP,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,wBAAwB,CAAC,CAAC;IACjD,CAAC;CAyDF","sourcesContent":["import type { BlockElement, EditorHost } from '@blocksuite/block-std';\nimport { BlockService } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { BlockModel } from '@blocksuite/store';\n\nimport {\n  FileDropManager,\n  type FileDropOptions,\n} from '../_common/components/file-drop-manager.js';\nimport {\n  createDocModeService,\n  type DocModeService,\n  getSelectedPeekableBlocksCommand,\n  type NotificationService,\n  peekSelectedBlockCommand,\n  type PeekViewService,\n} from '../_common/components/index.js';\nimport {\n  DEFAULT_IMAGE_PROXY_ENDPOINT,\n  EMBED_CARD_HEIGHT,\n  EMBED_CARD_WIDTH,\n} from '../_common/consts.js';\nimport { ExportManager } from '../_common/export-manager/export-manager.js';\nimport {\n  HtmlTransformer,\n  MarkdownTransformer,\n  ZipTransformer,\n} from '../_common/transformers/index.js';\nimport { type EmbedCardStyle, NoteDisplayMode } from '../_common/types.js';\nimport { getRootByEditorHost } from '../_common/utils/index.js';\nimport { matchFlavours } from '../_common/utils/model.js';\nimport { asyncFocusRichText } from '../_common/utils/selection.js';\nimport type { NoteBlockModel } from '../note-block/note-model.js';\nimport { CommunityCanvasTextFonts } from '../surface-block/consts.js';\nimport { Bound, Vec } from '../surface-block/index.js';\nimport { EditPropsStore } from '../surface-block/managers/edit-session.js';\nimport {\n  copySelectedModelsCommand,\n  deleteSelectedModelsCommand,\n  deleteTextCommand,\n  formatBlockCommand,\n  formatNativeCommand,\n  formatTextCommand,\n  getBlockIndexCommand,\n  getBlockSelectionsCommand,\n  getImageSelectionsCommand,\n  getNextBlockCommand,\n  getPrevBlockCommand,\n  getSelectedBlocksCommand,\n  getSelectedModelsCommand,\n  getTextSelectionCommand,\n} from './commands/index.js';\nimport type { EdgelessRootBlockComponent } from './edgeless/edgeless-root-block.js';\nimport { FontLoader } from './font-loader/font-loader.js';\nimport type { RootBlockModel } from './root-model.js';\nimport type { RootBlockComponent } from './types.js';\n\nexport type EmbedOptions = {\n  flavour: string;\n  urlRegex: RegExp;\n  styles: EmbedCardStyle[];\n  viewType: 'card' | 'embed';\n};\n\nexport type QuickSearchResult =\n  | { docId: string; isNewDoc?: boolean }\n  | { userInput: string }\n  | null;\n\nexport interface QuickSearchService {\n  searchDoc: (options: {\n    action?: 'insert';\n    userInput?: string;\n    skipSelection?: boolean;\n    trigger?: 'edgeless-toolbar' | 'slash-command' | 'shortcut';\n  }) => Promise<QuickSearchResult>;\n}\n\nexport interface TelemetryEvent {\n  page?: string;\n  segment?: string;\n  module?: string;\n  control?: string;\n  type?: string;\n  category?: string;\n  other?: unknown;\n}\n\ninterface DocCreatedEvent extends TelemetryEvent {\n  page?: 'doc editor' | 'whiteboard editor';\n  segment?: 'whiteboard' | 'note' | 'doc';\n  module?:\n    | 'slash commands'\n    | 'format toolbar'\n    | 'edgeless toolbar'\n    | 'inline @';\n  category?: 'page' | 'whiteboard';\n}\n\nexport interface TelemetryEventMap {\n  DocCreated: DocCreatedEvent;\n  LinkedDocCreated: TelemetryEvent;\n}\n\nexport interface TelemetryService {\n  track<T extends keyof TelemetryEventMap>(\n    eventName: T,\n    props: TelemetryEventMap[T]\n  ): void;\n}\n\nexport class RootService extends BlockService<RootBlockModel> {\n  get viewportElement() {\n    const rootElement = this.std.view.viewFromPath('block', [\n      this.std.doc.root?.id ?? '',\n    ]) as RootBlockComponent | null;\n    assertExists(rootElement);\n    const viewportElement = rootElement.viewportElement as HTMLElement | null;\n    assertExists(viewportElement);\n    return viewportElement;\n  }\n\n  get selectedBlocks() {\n    let result: BlockElement[] = [];\n    this.std.command\n      .chain()\n      .tryAll(chain => [\n        chain.getTextSelection(),\n        chain.getImageSelections(),\n        chain.getBlockSelections(),\n      ])\n      .getSelectedBlocks()\n      .inline(({ selectedBlocks }) => {\n        if (!selectedBlocks) return;\n        result = selectedBlocks;\n      })\n      .run();\n    return result;\n  }\n\n  get selectedModels() {\n    return this.selectedBlocks.map(block => block.model);\n  }\n\n  private _fileDropOptions: FileDropOptions = {\n    flavour: this.flavour,\n  };\n\n  private _exportOptions = {\n    imageProxyEndpoint: DEFAULT_IMAGE_PROXY_ENDPOINT,\n  };\n\n  private _embedBlockRegistry = new Set<EmbedOptions>();\n\n  readonly fontLoader = new FontLoader();\n\n  readonly editPropsStore: EditPropsStore = new EditPropsStore(this);\n\n  fileDropManager!: FileDropManager;\n\n  exportManager!: ExportManager;\n\n  // implements provided by affine\n  notificationService: NotificationService | null = null;\n\n  peekViewService: PeekViewService | null = null;\n\n  docModeService: DocModeService = createDocModeService(this.doc.id);\n\n  quickSearchService: QuickSearchService | null = null;\n\n  telemetryService: TelemetryService | null = null;\n\n  transformers = {\n    markdown: MarkdownTransformer,\n    html: HtmlTransformer,\n    zip: ZipTransformer,\n  };\n\n  private _getLastNoteBlock() {\n    const { doc } = this;\n    let note: NoteBlockModel | null = null;\n    if (!doc.root) return null;\n    const { children } = doc.root;\n    for (let i = children.length - 1; i >= 0; i--) {\n      const child = children[i];\n      if (\n        matchFlavours(child, ['affine:note']) &&\n        child.displayMode !== NoteDisplayMode.EdgelessOnly\n      ) {\n        note = child as NoteBlockModel;\n        break;\n      }\n    }\n    return note;\n  }\n\n  private _getParentModelBySelection = (): {\n    index: number | undefined;\n    model: BlockModel | null;\n  } => {\n    const currentMode = this.docModeService.getMode();\n    const root = this.doc.root;\n    if (!root)\n      return {\n        index: undefined,\n        model: null,\n      };\n\n    if (currentMode === 'edgeless') {\n      const surface =\n        root.children.find(child => child.flavour === 'affine:surface') ?? null;\n      return { index: undefined, model: surface };\n    }\n\n    if (currentMode === 'page') {\n      let selectedBlock: BlockModel | null = this.selectedBlocks[0]?.model;\n      let index: undefined | number = undefined;\n\n      if (!selectedBlock) {\n        // if no block is selected, append to the last note block\n        selectedBlock = this._getLastNoteBlock();\n      }\n\n      while (selectedBlock && selectedBlock.flavour !== 'affine:note') {\n        // selectedBlock = this.doc.getParent(selectedBlock.id);\n        const parent = this.doc.getParent(selectedBlock.id);\n        index = parent?.children.indexOf(selectedBlock);\n        selectedBlock = parent;\n      }\n\n      return { index, model: selectedBlock };\n    }\n\n    return {\n      index: undefined,\n      model: null,\n    };\n  };\n\n  private _insertCard = (\n    flavour: string,\n    targetStyle: EmbedCardStyle,\n    props: Record<string, unknown>\n  ) => {\n    const host = this.host as EditorHost;\n\n    const mode = this.docModeService.getMode();\n    const { model, index } = this._getParentModelBySelection();\n\n    if (mode === 'page') {\n      host.doc.addBlock(flavour as never, props, model, index);\n      return;\n    }\n    if (mode === 'edgeless') {\n      const edgelessRoot = getRootByEditorHost(\n        host\n      ) as EdgelessRootBlockComponent | null;\n      if (!edgelessRoot) return;\n\n      edgelessRoot.service.viewport.smoothZoom(1);\n      const surface = edgelessRoot.surface;\n      const center = Vec.toVec(surface.renderer.center);\n      const cardId = edgelessRoot.service.addBlock(\n        flavour,\n        {\n          ...props,\n          xywh: Bound.fromCenter(\n            center,\n            EMBED_CARD_WIDTH[targetStyle],\n            EMBED_CARD_HEIGHT[targetStyle]\n          ).serialize(),\n          style: targetStyle,\n        },\n        surface.model\n      );\n\n      edgelessRoot.service.selection.set({\n        elements: [cardId],\n        editing: false,\n      });\n\n      edgelessRoot.tools.setEdgelessTool({\n        type: 'default',\n      });\n      return;\n    }\n  };\n\n  private _insertLink = (url: string) => {\n    const host = this.host as EditorHost;\n    const rootService = host.spec.getService('affine:page');\n\n    const embedOptions = rootService.getEmbedBlockOptions(url);\n\n    let flavour = 'affine:bookmark';\n    let targetStyle: EmbedCardStyle = 'vertical';\n    const props: Record<string, unknown> = { url };\n    if (embedOptions) {\n      flavour = embedOptions.flavour;\n      targetStyle = embedOptions.styles[0];\n    }\n\n    this._insertCard(flavour, targetStyle, props);\n    return flavour;\n  };\n\n  private _insertDoc = (docId: string) => {\n    const flavour = 'affine:embed-linked-doc';\n    const targetStyle: EmbedCardStyle = 'vertical';\n    const props: Record<string, unknown> = { pageId: docId };\n\n    this._insertCard(flavour, targetStyle, props);\n    return flavour;\n  };\n\n  registerEmbedBlockOptions = (options: EmbedOptions): void => {\n    this._embedBlockRegistry.add(options);\n  };\n\n  getEmbedBlockOptions = (url: string): EmbedOptions | null => {\n    const entries = this._embedBlockRegistry.entries();\n    for (const [options] of entries) {\n      const regex = options.urlRegex;\n      if (regex.test(url)) return options;\n    }\n    return null;\n  };\n\n  override unmounted() {\n    this.editPropsStore.dispose();\n    this.fontLoader.clear();\n  }\n\n  override mounted() {\n    super.mounted();\n\n    this.std.command\n      .add('getBlockIndex', getBlockIndexCommand)\n      .add('getNextBlock', getNextBlockCommand)\n      .add('getPrevBlock', getPrevBlockCommand)\n      .add('getSelectedBlocks', getSelectedBlocksCommand)\n      .add('copySelectedModels', copySelectedModelsCommand)\n      .add('deleteSelectedModels', deleteSelectedModelsCommand)\n      .add('getSelectedModels', getSelectedModelsCommand)\n      .add('getBlockSelections', getBlockSelectionsCommand)\n      .add('getImageSelections', getImageSelectionsCommand)\n      .add('getTextSelection', getTextSelectionCommand)\n      .add('deleteText', deleteTextCommand)\n      .add('formatBlock', formatBlockCommand)\n      .add('formatNative', formatNativeCommand)\n      .add('formatText', formatTextCommand)\n      .add('peekSelectedBlock', peekSelectedBlockCommand)\n      .add('getSelectedPeekableBlocks', getSelectedPeekableBlocksCommand);\n\n    this.loadFonts();\n\n    this.exportManager = new ExportManager(this, this._exportOptions);\n\n    this.fileDropManager = new FileDropManager(this, this._fileDropOptions);\n    this.disposables.addFromEvent(\n      this.host,\n      'dragover',\n      this.fileDropManager.onDragOver\n    );\n\n    this.disposables.addFromEvent(\n      this.host,\n      'dragleave',\n      this.fileDropManager.onDragLeave\n    );\n\n    this.disposables.add(\n      this.std.event.add('pointerDown', ctx => {\n        const state = ctx.get('pointerState');\n        state.raw.stopPropagation();\n      })\n    );\n  }\n\n  loadFonts() {\n    this.fontLoader.load(CommunityCanvasTextFonts);\n  }\n\n  appendParagraph = (text: string = '') => {\n    const { doc } = this;\n    if (!doc.root) return;\n    if (doc.readonly) return;\n    let noteId = this._getLastNoteBlock()?.id;\n    if (!noteId) {\n      noteId = doc.addBlock('affine:note', {}, doc.root.id);\n    }\n    const id = doc.addBlock(\n      'affine:paragraph',\n      { text: new doc.Text(text) },\n      noteId\n    );\n\n    asyncFocusRichText(this.host as EditorHost, id, {\n      index: text.length,\n      length: 0,\n    })?.catch(console.error);\n  };\n\n  insertLinkByQuickSearch = async (\n    userInput?: string,\n    skipSelection?: boolean\n  ): Promise<\n    | {\n        flavour: string;\n        isNewDoc?: boolean;\n      }\n    | undefined\n  > => {\n    if (!this.quickSearchService) return;\n\n    const result = await this.quickSearchService.searchDoc({\n      action: 'insert',\n      userInput,\n      skipSelection,\n    });\n    if (!result) return;\n\n    // add linked doc\n    if ('docId' in result) {\n      this._insertDoc(result.docId);\n      return { flavour: 'affine:embed-linked-doc', isNewDoc: result.isNewDoc };\n    }\n\n    // add normal link;\n    if ('userInput' in result) {\n      this._insertLink(result.userInput);\n      return {\n        flavour: 'affine:bookmark',\n      };\n    }\n\n    return;\n  };\n}\n"]}