{"version":3,"file":"delete-text.js","sourceRoot":"","sources":["../../../../src/root-block/commands/text-crud/delete-text.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Command, TextSelection } from '@blocksuite/block-std';\nimport type { EditorHost } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { Text } from '@blocksuite/store';\n\nimport { matchFlavours } from '../../../_common/utils/index.js';\n\nexport const deleteTextCommand: Command<\n  'currentTextSelection',\n  never,\n  {\n    textSelection?: TextSelection;\n  }\n> = (ctx, next) => {\n  const textSelection = ctx.textSelection ?? ctx.currentTextSelection;\n  assertExists(\n    textSelection,\n    '`textSelection` is required, you need to pass it in args or use `getTextSelection` command before adding this command to the pipeline.'\n  );\n\n  const host = ctx.std.host as EditorHost;\n  assertExists(host.rangeManager);\n\n  const range = host.rangeManager.textSelectionToRange(textSelection);\n  if (!range) return;\n  const selectedElements = host.rangeManager.getSelectedBlockElementsByRange(\n    range,\n    {\n      mode: 'flat',\n    }\n  );\n\n  const { from, to } = textSelection;\n\n  const fromElement = selectedElements.find(el => from.blockId === el.blockId);\n  assertExists(fromElement);\n\n  let fromText: Text | undefined;\n  if (matchFlavours(fromElement.model, ['affine:page'])) {\n    fromText = fromElement.model.title;\n  } else {\n    fromText = fromElement.model.text;\n  }\n  assertExists(fromText);\n  if (!to) {\n    fromText.delete(from.index, from.length);\n    ctx.std.selection.setGroup('note', [\n      ctx.std.selection.create('text', {\n        from: {\n          blockId: from.blockId,\n          index: from.index,\n          length: 0,\n        },\n        to: null,\n      }),\n    ]);\n    return next();\n  }\n\n  const toElement = selectedElements.find(el => to.blockId === el.blockId);\n  assertExists(toElement);\n\n  const toText = toElement.model.text;\n  assertExists(toText);\n\n  fromText.delete(from.index, from.length);\n  toText.delete(0, to.length);\n\n  fromText.join(toText);\n\n  selectedElements\n    .filter(el => el.model.id !== fromElement.model.id)\n    .forEach(el => {\n      ctx.std.doc.deleteBlock(el.model);\n    });\n\n  ctx.std.selection.setGroup('note', [\n    ctx.std.selection.create('text', {\n      from: {\n        blockId: to.blockId,\n        index: to.index,\n        length: 0,\n      },\n      to: null,\n    }),\n  ]);\n\n  next();\n};\n\ndeclare global {\n  namespace BlockSuite {\n    interface Commands {\n      deleteText: typeof deleteTextCommand;\n    }\n  }\n}\n"]}