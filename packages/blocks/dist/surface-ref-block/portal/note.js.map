{"version":3,"file":"note.js","sourceRoot":"","sources":["../../../src/surface-ref-block/portal/note.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport {\n  RangeManager,\n  ShadowlessElement,\n  WithDisposable,\n} from '@blocksuite/block-std';\nimport type { Block } from '@blocksuite/store';\nimport {\n  type BlockModel,\n  type BlockSelector,\n  BlockViewType,\n} from '@blocksuite/store';\nimport { css, nothing } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\nimport { html } from 'lit/static-html.js';\n\nimport {\n  EDGELESS_BLOCK_CHILD_BORDER_WIDTH,\n  EDGELESS_BLOCK_CHILD_PADDING,\n} from '../../_common/consts.js';\nimport { DEFAULT_NOTE_BACKGROUND_COLOR } from '../../_common/edgeless/note/consts.js';\nimport { NoteDisplayMode } from '../../_common/types.js';\nimport type { NoteBlockModel } from '../../note-block/index.js';\nimport { SpecProvider } from '../../specs/utils/spec-provider.js';\nimport { deserializeXYWH } from '../../surface-block/index.js';\n\n@customElement('surface-ref-note-portal')\nexport class SurfaceRefNotePortal extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    surface-ref-note-portal {\n      position: relative;\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor index!: number;\n\n  @property({ attribute: false })\n  accessor model!: NoteBlockModel;\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  ancestors = new Set<string>();\n\n  selector: BlockSelector = (block, doc) => {\n    let currentBlock: Block | BlockModel | null = block;\n\n    if (this.ancestors.has(block.id)) {\n      return BlockViewType.Display;\n    }\n\n    while (currentBlock) {\n      if (currentBlock.id === this.model.id) {\n        return BlockViewType.Display;\n      }\n\n      currentBlock = doc.getParent(currentBlock.id);\n    }\n\n    return BlockViewType.Hidden;\n  };\n\n  renderPreview() {\n    const doc = this.model.doc.blockCollection.getDoc({\n      selector: this.selector,\n      readonly: true,\n    });\n    const previewSpec = SpecProvider.getInstance().getSpec('page:preview');\n    return this.host.renderSpecPortal(doc, previewSpec.value.slice());\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    let parent: BlockModel | null = this.model;\n    while (parent) {\n      this.ancestors.add(parent.id);\n      parent = this.model.doc.getParent(parent.id);\n    }\n\n    const doc = this.model.doc;\n    this._disposables.add(() => {\n      doc.blockCollection.clearSelector(this.selector, true);\n    });\n  }\n\n  override firstUpdated() {\n    this.disposables.add(\n      this.model.propsUpdated.on(() => this.requestUpdate())\n    );\n  }\n\n  override updated() {\n    setTimeout(() => {\n      const editableElements = Array.from<HTMLDivElement>(\n        this.querySelectorAll('[contenteditable]')\n      );\n      const blockElements = Array.from(\n        this.querySelectorAll(`[data-block-id]`)\n      );\n\n      editableElements.forEach(element => {\n        if (element.contentEditable === 'true')\n          element.contentEditable = 'false';\n      });\n\n      blockElements.forEach(element => {\n        element.setAttribute(RangeManager.rangeQueryExcludeAttr, 'true');\n      });\n    }, 500);\n  }\n\n  override render() {\n    const { model, index } = this;\n    const { displayMode, edgeless } = model;\n    if (!!displayMode && displayMode === NoteDisplayMode.DocOnly)\n      return nothing;\n\n    const { xywh, background } = model;\n    const [modelX, modelY, modelW, modelH] = deserializeXYWH(xywh);\n    const style = {\n      zIndex: `${index}`,\n      width: modelW + 'px',\n      height:\n        edgeless.collapse && edgeless.collapsedHeight\n          ? edgeless.collapsedHeight + 'px'\n          : undefined,\n      transform: `translate(${modelX}px, ${modelY}px)`,\n      padding: `${EDGELESS_BLOCK_CHILD_PADDING}px`,\n      border: `${EDGELESS_BLOCK_CHILD_BORDER_WIDTH}px none var(--affine-black-10)`,\n      background: `var(${background ?? DEFAULT_NOTE_BACKGROUND_COLOR})`,\n      boxShadow: 'var(--affine-note-shadow-sticker)',\n      position: 'absolute',\n      borderRadius: '0px',\n      boxSizing: 'border-box',\n      pointerEvents: 'none',\n      overflow: 'hidden',\n      transformOrigin: '0 0',\n      userSelect: 'none',\n    };\n\n    return html`\n      <div\n        class=\"surface-ref-note-portal\"\n        style=${styleMap(style)}\n        data-model-height=\"${modelH}\"\n        data-portal-reference-block-id=\"${model.id}\"\n      >\n        ${this.renderPreview()}\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'surface-ref-note-portal': SurfaceRefNotePortal;\n  }\n}\n"]}