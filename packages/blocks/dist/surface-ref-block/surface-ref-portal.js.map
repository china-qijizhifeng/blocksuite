{"version":3,"file":"surface-ref-portal.js","sourceRoot":"","sources":["../../src/surface-ref-block/surface-ref-portal.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable lit/binding-positions, lit/no-invalid-html */\n\nimport './portal/note.js';\nimport './portal/generic-block.js';\n\nimport type { EditorHost } from '@blocksuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport type { BlockModel, Doc } from '@blocksuite/store';\nimport { css, html, type TemplateResult } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\nimport { html as staticHtml, literal, unsafeStatic } from 'lit/static-html.js';\n\nimport type { FrameBlockModel } from '../frame-block/index.js';\nimport type { EdgelessBlockModel } from '../root-block/edgeless/edgeless-block-model.js';\nimport type { GroupElementModel } from '../surface-block/element-model/group.js';\nimport type { BlockLayer } from '../surface-block/managers/layer-manager.js';\n\nconst portalMap = {\n  'affine:note': 'surface-ref-note-portal',\n} as Record<BlockSuite.EdgelessModelKeyType, string>;\n\nconst getPortalTag = (model: BlockModel) => {\n  const tag = portalMap[model.flavour as BlockSuite.EdgelessModelKeyType];\n  return tag ?? 'surface-ref-generic-block-portal';\n};\n\n@customElement('surface-ref-portal')\nexport class SurfaceRefPortal extends WithDisposable(ShadowlessElement) {\n  get surfaceService() {\n    return this.host.std.spec.getService('affine:surface');\n  }\n\n  static override styles = css`\n    .surface-blocks-portal {\n      pointer-events: none;\n      position: absolute;\n      left: 0;\n      top: 0;\n      transform-origin: 0 0;\n    }\n    .stacking-canvas {\n      position: absolute;\n      left: 0;\n      top: 0;\n    }\n\n    .stacking-canvas > canvas {\n      transform: var(--stacking-canvas-transform);\n      transform-origin: 0 0;\n      position: absolute;\n      left: 0;\n      top: 0;\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor doc!: Doc;\n\n  @property({ attribute: false })\n  accessor refModel!: GroupElementModel | FrameBlockModel;\n\n  @property({ attribute: false })\n  accessor renderModel!: (model: BlockModel) => TemplateResult;\n\n  @query('.surface-blocks-portal')\n  accessor portal!: HTMLDivElement;\n\n  @query('.stacking-canvas')\n  accessor canvasSlot!: HTMLDivElement;\n\n  private _getBlocksInFrame(model: FrameBlockModel): EdgelessBlockModel[] {\n    const bound = model.elementBound;\n    const candidates = this.surfaceService.layer.blocksGrid.search(bound);\n\n    return candidates;\n  }\n\n  private _getBlocksInGroup(model: GroupElementModel): EdgelessBlockModel[] {\n    return Array.from(model.childIds)\n      .map(id => this.doc.getBlockById(id) as EdgelessBlockModel)\n      .filter(el => el);\n  }\n\n  private _renderEdgelessBlocks() {\n    const refModel = this.refModel;\n    const blocks =\n      'flavour' in refModel\n        ? this._getBlocksInFrame(refModel)\n        : this._getBlocksInGroup(refModel);\n    const blockLayers = this.surfaceService.layer.layers.filter(\n      layer => layer.type === 'block'\n    ) as BlockLayer[];\n    let currentLayerIdx = 0;\n    let currentIdxOffset = 0;\n\n    return repeat(\n      blocks,\n      model => model.id,\n      (model, index) => {\n        const tag = literal`${unsafeStatic(getPortalTag(model))}`;\n\n        let currentLayer = blockLayers[currentLayerIdx];\n        if (!blockLayers[currentLayerIdx].set.has(model)) {\n          while (!currentLayer.set.has(model)) {\n            currentLayer = blockLayers[++currentLayerIdx];\n          }\n\n          currentIdxOffset = 0;\n        }\n\n        const zIndex = currentLayer.zIndex + currentIdxOffset++;\n\n        return staticHtml`<${tag}\n          .index=${index}\n          .model=${model}\n          .doc=${this.doc}\n          .host=${this.host}\n          .renderModel=${this.renderModel}\n          style=${styleMap({\n            'z-index': zIndex,\n          })}\n        ></${tag}>`;\n      }\n    );\n  }\n\n  setStackingCanvas(canvases: HTMLCanvasElement[]) {\n    if (this.canvasSlot) {\n      this.canvasSlot.replaceChildren(...canvases);\n    }\n  }\n\n  setViewport = (viewport: {\n    translateX: number;\n    translateY: number;\n    zoom: number;\n  }) => {\n    this.requestUpdate();\n    this.updateComplete\n      .then(() => {\n        this.portal?.style.setProperty(\n          'transform',\n          `translate(${viewport.translateX}px, ${viewport.translateY}px) scale(${viewport.zoom})`\n        );\n        this.portal?.style.setProperty('transform-origin', '0 0');\n        this.canvasSlot?.style.setProperty(\n          '--stacking-canvas-transform',\n          `scale(${\n            1 / viewport.zoom\n          }) translate(${-viewport.translateX}px, ${-viewport.translateY}px)`\n        );\n      })\n      .catch(console.error);\n  };\n\n  override render() {\n    return html`<div class=\"surface-blocks-portal\">\n      <div class=\"stacking-canvas\"></div>\n      ${this._renderEdgelessBlocks()}\n    </div>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'surface-ref-portal': SurfaceRefPortal;\n  }\n}\n"]}