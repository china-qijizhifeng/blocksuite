{"version":3,"file":"database.unit.spec.js","sourceRoot":"","sources":["../../../src/__tests__/database/database.unit.spec.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockModel, Doc } from '@blocksuite/store';\nimport { DocCollection, Generator, Schema } from '@blocksuite/store';\nimport { beforeEach, describe, expect, test } from 'vitest';\n\nimport { selectColumnModelConfig } from '../../database-block/data-view/column/presets/select/define.js';\nimport type { DatabaseBlockModel } from '../../database-block/database-model.js';\nimport { DatabaseBlockSchema } from '../../database-block/database-model.js';\nimport {\n  type Cell,\n  type Column,\n  columnPresets,\n  richTextColumnConfig,\n} from '../../database-block/index.js';\nimport { NoteBlockSchema } from '../../note-block/note-model.js';\nimport { ParagraphBlockSchema } from '../../paragraph-block/paragraph-model.js';\nimport { RootBlockSchema } from '../../root-block/root-model.js';\n\nconst AffineSchemas = [\n  RootBlockSchema,\n  NoteBlockSchema,\n  ParagraphBlockSchema,\n  DatabaseBlockSchema,\n];\n\nfunction createTestOptions() {\n  const idGenerator = Generator.AutoIncrement;\n  const schema = new Schema();\n  schema.register(AffineSchemas);\n  return { id: 'test-collection', idGenerator, schema };\n}\n\nfunction createTestDoc(docId = 'doc0') {\n  const options = createTestOptions();\n  const collection = new DocCollection(options);\n  collection.meta.initialize();\n  const doc = collection.createDoc({ id: docId });\n  doc.load();\n  return doc;\n}\n\ndescribe('DatabaseManager', () => {\n  let doc: Doc;\n  let db: DatabaseBlockModel;\n\n  let rootId: BlockModel['id'];\n  let noteBlockId: BlockModel['id'];\n  let databaseBlockId: BlockModel['id'];\n  let p1: BlockModel['id'];\n  let p2: BlockModel['id'];\n  let col1: Column['id'];\n  let col2: Column['id'];\n  let col3: Column['id'];\n\n  const selection = [\n    { id: '1', value: 'Done', color: 'var(--affine-tag-white)' },\n    { id: '2', value: 'TODO', color: 'var(--affine-tag-pink)' },\n    { id: '3', value: 'WIP', color: 'var(--affine-tag-blue)' },\n  ];\n\n  beforeEach(() => {\n    doc = createTestDoc();\n\n    rootId = doc.addBlock('affine:page', {\n      title: new doc.Text('database test'),\n    });\n    noteBlockId = doc.addBlock('affine:note', {}, rootId);\n\n    databaseBlockId = doc.addBlock(\n      'affine:database' as BlockSuite.Flavour,\n      {\n        columns: [],\n        titleColumn: 'Title',\n      },\n      noteBlockId\n    );\n\n    const databaseModel = doc.getBlockById(\n      databaseBlockId\n    ) as DatabaseBlockModel;\n    db = databaseModel;\n\n    col1 = db.addColumn(\n      'end',\n      columnPresets.numberColumnConfig.model.create('Number')\n    );\n    col2 = db.addColumn(\n      'end',\n      selectColumnModelConfig.create('Single Select', { options: selection })\n    );\n    col3 = db.addColumn('end', richTextColumnConfig.model.create('Rich Text'));\n\n    doc.updateBlock(databaseModel, {\n      columns: [col1, col2, col3],\n    });\n\n    p1 = doc.addBlock(\n      'affine:paragraph',\n      {\n        text: new doc.Text('text1'),\n      },\n      databaseBlockId\n    );\n    p2 = doc.addBlock(\n      'affine:paragraph',\n      {\n        text: new doc.Text('text2'),\n      },\n      databaseBlockId\n    );\n\n    db.updateCell(p1, {\n      columnId: col1,\n      value: 0.1,\n    });\n    db.updateCell(p2, {\n      columnId: col2,\n      value: [selection[1]],\n    });\n  });\n\n  test('getColumn', () => {\n    const column = {\n      ...columnPresets.numberColumnConfig.model.create('testColumnId'),\n      id: 'testColumnId',\n    };\n    db.addColumn('end', column);\n\n    const result = db.getColumn(column.id);\n    expect(result).toEqual(column);\n  });\n\n  test('addColumn', () => {\n    const column = columnPresets.numberColumnConfig.model.create('Test Column');\n    const id = db.addColumn('end', column);\n    const result = db.getColumn(id);\n\n    expect(result).toMatchObject(column);\n    expect(result).toHaveProperty('id');\n  });\n\n  test('deleteColumn', () => {\n    const column = {\n      ...columnPresets.numberColumnConfig.model.create('Test Column'),\n      id: 'testColumnId',\n    };\n    db.addColumn('end', column);\n    expect(db.getColumn(column.id)).toEqual(column);\n\n    db.deleteColumn(column.id);\n    expect(db.getColumn(column.id)).toBeUndefined();\n  });\n\n  test('getCell', () => {\n    const modelId = doc.addBlock(\n      'affine:paragraph',\n      {\n        text: new doc.Text('paragraph'),\n      },\n      noteBlockId\n    );\n    const column = {\n      ...columnPresets.numberColumnConfig.model.create('Test Column'),\n      id: 'testColumnId',\n    };\n    const cell: Cell = {\n      columnId: column.id,\n      value: 42,\n    };\n\n    db.addColumn('end', column);\n    db.updateCell(modelId, cell);\n\n    const model = doc.getBlockById(modelId);\n\n    expect(model).not.toBeNull();\n\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    const result = db.getCell(model!.id, column.id);\n    expect(result).toEqual(cell);\n  });\n\n  test('updateCell', () => {\n    const newRowId = doc.addBlock(\n      'affine:paragraph',\n      {\n        text: new doc.Text('text3'),\n      },\n      databaseBlockId\n    );\n\n    db.updateCell(newRowId, {\n      columnId: col2,\n      value: [selection[2]],\n    });\n\n    const cell = db.getCell(newRowId, col2);\n    expect(cell).toEqual({\n      columnId: col2,\n      value: [selection[2]],\n    });\n  });\n\n  test('copyCellsByColumn', () => {\n    const newColId = db.addColumn(\n      'end',\n      selectColumnModelConfig.create('Copied Select', { options: selection })\n    );\n\n    db.copyCellsByColumn(col2, newColId);\n\n    const cell = db.getCell(p2, newColId);\n    expect(cell).toEqual({\n      columnId: newColId,\n      value: [selection[1]],\n    });\n  });\n});\n"]}