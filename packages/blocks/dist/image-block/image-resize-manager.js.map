{"version":3,"file":"image-resize-manager.js","sourceRoot":"","sources":["../../src/image-block/image-resize-manager.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,YAAY,EAAE,MAAM,0BAA0B,CAAC;AAExD,OAAO,EAEL,+BAA+B,EAC/B,iBAAiB,EACjB,cAAc,GACf,MAAM,2BAA2B,CAAC;AACnC,OAAO,EAAE,4BAA4B,EAAE,MAAM,8BAA8B,CAAC;AAE5E,MAAM,OAAO,kBAAkB;IAA/B;QACU,qBAAgB,GAA0B,IAAI,CAAC;QAE/C,oBAAe,GAAuB,IAAI,CAAC;QAE3C,kBAAa,GAAG,CAAC,CAAC;QAElB,oBAAe,GAAG,OAAO,CAAC;QAE1B,UAAK,GAAG,CAAC,CAAC;IAwEpB,CAAC;IAtEC,OAAO,CAAC,CAAoB;QAC1B,MAAM,WAAW,GAAG,CAAC,CAAC,GAAG,CAAC,MAAqB,CAAC;QAChD,IAAI,CAAC,gBAAgB,GAAG,+BAA+B,CACrD,WAAW,CACM,CAAC;QAEpB,MAAM,WAAW,GAAG,4BAA4B,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;QACxE,IAAI,WAAW,IAAI,cAAc,CAAC,WAAW,CAAC,EAAE,CAAC;YAC/C,IAAI,CAAC,KAAK,GAAG,WAAW,CAAC,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC;QACjD,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,KAAK,GAAG,CAAC,CAAC;QACjB,CAAC;QAED,IAAI,CAAC,eAAe,GAAG,WAAW,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC;QAC7D,YAAY,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QACnC,MAAM,IAAI,GAAG,IAAI,CAAC,eAAe,CAAC,qBAAqB,EAAa,CAAC;QACrE,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,KAAK,GAAG,CAAC,CAAC;QAChD,IAAI,WAAW,CAAC,SAAS,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC;YAC5C,IAAI,CAAC,eAAe,GAAG,OAAO,CAAC;QACjC,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,eAAe,GAAG,MAAM,CAAC;QAChC,CAAC;IACH,CAAC;IAED,MAAM,CAAC,CAAoB;QACzB,YAAY,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;QACpC,MAAM,eAAe,GAAG,IAAI,CAAC,gBAAgB,CAAC;QAC9C,MAAM,kBAAkB,GAAG,IAAI,CAAC,eAAe,CAAC;QAChD,YAAY,CAAC,kBAAkB,CAAC,CAAC;QACjC,MAAM,SAAS,GAAG,eAAe,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QACvD,YAAY,CAAC,SAAS,CAAC,CAAC;QAExB,IAAI,KAAK,GAAG,CAAC,CAAC;QACd,IAAI,IAAI,CAAC,eAAe,KAAK,OAAO,EAAE,CAAC;YACrC,KAAK,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC;QACjD,CAAC;aAAM,CAAC;YACN,KAAK,GAAG,CAAC,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QACjD,CAAC;QAED,MAAM,SAAS,GAAG,EAAE,CAAC;QACrB,IAAI,KAAK,GAAG,SAAS,EAAE,CAAC;YACtB,KAAK,GAAG,SAAS,CAAC;QACpB,CAAC;QACD,IAAI,KAAK,GAAG,eAAe,CAAC,qBAAqB,EAAE,CAAC,KAAK,EAAE,CAAC;YAC1D,KAAK,GAAG,eAAe,CAAC,qBAAqB,EAAE,CAAC,KAAK,CAAC;QACxD,CAAC;QAED,MAAM,MAAM,GAAG,KAAK,GAAG,CAAC,SAAS,CAAC,aAAa,GAAG,SAAS,CAAC,YAAY,CAAC,CAAC;QAE1E,MAAM,aAAa,GAAG,kBAAkB,CAAC,qBAAqB,EAAE,CAAC;QACjE,IAAI,aAAa,CAAC,KAAK,KAAK,KAAK,IAAI,aAAa,CAAC,MAAM,KAAK,MAAM;YAClE,OAAO;QAET,qBAAqB,CAAC,GAAG,EAAE;YACzB,kBAAkB,CAAC,KAAK,CAAC,KAAK,GAAG,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC;QAC1E,CAAC,CAAC,CAAC;IACL,CAAC;IAED,KAAK;QACH,YAAY,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;QACpC,YAAY,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QAEnC,MAAM,SAAS,GAAG,iBAAiB,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;QAC3D,SAAS,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;QAC7B,MAAM,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC,eAAe,CAAC,qBAAqB,EAAE,CAAC;QACvE,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,SAAS,EAAE;YACpC,KAAK,EAAE,KAAK,GAAG,IAAI,CAAC,KAAK;YACzB,MAAM,EAAE,MAAM,GAAG,IAAI,CAAC,KAAK;SAC5B,CAAC,CAAC;IACL,CAAC;CACF","sourcesContent":["import type { PointerEventState } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\n\nimport {\n  type BlockComponent,\n  getClosestBlockElementByElement,\n  getModelByElement,\n  isEdgelessPage,\n} from '../_common/utils/query.js';\nimport { getClosestRootBlockComponent } from '../root-block/utils/query.js';\n\nexport class ImageResizeManager {\n  private _activeComponent: BlockComponent | null = null;\n\n  private _imageContainer: HTMLElement | null = null;\n\n  private _imageCenterX = 0;\n\n  private _dragMoveTarget = 'right';\n\n  private _zoom = 1;\n\n  onStart(e: PointerEventState) {\n    const eventTarget = e.raw.target as HTMLElement;\n    this._activeComponent = getClosestBlockElementByElement(\n      eventTarget\n    ) as BlockComponent;\n\n    const rootElement = getClosestRootBlockComponent(this._activeComponent);\n    if (rootElement && isEdgelessPage(rootElement)) {\n      this._zoom = rootElement.service.viewport.zoom;\n    } else {\n      this._zoom = 1;\n    }\n\n    this._imageContainer = eventTarget.closest('.resizable-img');\n    assertExists(this._imageContainer);\n    const rect = this._imageContainer.getBoundingClientRect() as DOMRect;\n    this._imageCenterX = rect.left + rect.width / 2;\n    if (eventTarget.className.includes('right')) {\n      this._dragMoveTarget = 'right';\n    } else {\n      this._dragMoveTarget = 'left';\n    }\n  }\n\n  onMove(e: PointerEventState) {\n    assertExists(this._activeComponent);\n    const activeComponent = this._activeComponent;\n    const activeImgContainer = this._imageContainer;\n    assertExists(activeImgContainer);\n    const activeImg = activeComponent.querySelector('img');\n    assertExists(activeImg);\n\n    let width = 0;\n    if (this._dragMoveTarget === 'right') {\n      width = (e.raw.pageX - this._imageCenterX) * 2;\n    } else {\n      width = (this._imageCenterX - e.raw.pageX) * 2;\n    }\n\n    const MIN_WIDTH = 50;\n    if (width < MIN_WIDTH) {\n      width = MIN_WIDTH;\n    }\n    if (width > activeComponent.getBoundingClientRect().width) {\n      width = activeComponent.getBoundingClientRect().width;\n    }\n\n    const height = width * (activeImg.naturalHeight / activeImg.naturalWidth);\n\n    const containerRect = activeImgContainer.getBoundingClientRect();\n    if (containerRect.width === width && containerRect.height === height)\n      return;\n\n    requestAnimationFrame(() => {\n      activeImgContainer.style.width = (width / this._zoom).toFixed(2) + 'px';\n    });\n  }\n\n  onEnd() {\n    assertExists(this._activeComponent);\n    assertExists(this._imageContainer);\n\n    const dragModel = getModelByElement(this._activeComponent);\n    dragModel.page.captureSync();\n    const { width, height } = this._imageContainer.getBoundingClientRect();\n    dragModel.page.updateBlock(dragModel, {\n      width: width / this._zoom,\n      height: height / this._zoom,\n    });\n  }\n}\n"]}