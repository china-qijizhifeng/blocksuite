{"version":3,"file":"affine-code-line.js","sourceRoot":"","sources":["../../src/code-block/affine-code-line.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAO,EAAE,iBAAiB,EAAE,MAAM,uBAAuB,CAAC;AAC1D,OAAO,EAAE,YAAY,EAAE,MAAM,0BAA0B,CAAC;AACxD,OAAO,EAAoB,gBAAgB,EAAE,MAAM,oBAAoB,CAAC;AACxE,OAAO,EAAE,IAAI,EAAE,MAAM,KAAK,CAAC;AAC3B,OAAO,EAAE,aAAa,EAAE,QAAQ,EAAE,MAAM,mBAAmB,CAAC;AAI5D,OAAO,EAAE,YAAY,EAAE,MAAM,2BAA2B,CAAC;AAEzD,OAAO,EAAE,UAAU,EAAE,WAAW,EAAE,MAAM,mBAAmB,CAAC;AAC5D,OAAO,EACL,cAAc,GAEf,MAAM,4BAA4B,CAAC;IAGvB,cAAc;4BAD1B,aAAa,CAAC,kBAAkB,CAAC;;;;sBACE,iBAAiB;;;;;;;8BAAzB,SAAQ,WAAiB;;;;iCAClD,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC;kDAK1B,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;YAJ/B,oKAAS,KAAK,6BAAL,KAAK,qFAEZ;YAGF,uNAAS,sBAAsB,6BAAtB,sBAAsB,uHAAuC;YAPxE,6KAkDC;;;YAlDY,uDAAc;;QAEzB,uEAAoD;YAClD,MAAM,EAAE,gBAAgB;SACzB,EAAC;QAFF,IAAS,KAAK,2CAEZ;QAFF,IAAS,KAAK,iDAEZ;QAGF,6JAAiE,IAAI,GAAC;QAAtE,IAAS,sBAAsB,4DAAuC;QAAtE,IAAS,sBAAsB,kEAAuC;QAE7D,MAAM;YACb,YAAY,CACV,IAAI,CAAC,sBAAsB,EAC3B,mCAAmC,CACpC,CAAC;YACF,MAAM,EAAE,IAAI,EAAE,WAAW,EAAE,GAAG,IAAI,CAAC,sBAAsB,EAAE,CAAC;YAE5D,IAAI,CAAC,WAAW,IAAI,CAAC,WAAW,CAAC,kBAAkB,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE,CAAC;gBACrE,OAAO,IAAI,CAAA,sBAAsB,IAAI,CAAC,KAAK,CAAC,MAAM,mBAAmB,CAAC;YACxE,CAAC;YAED,MAAM,IAAI,GAAG,YAAY,EAAE,CAAC;YAC5B,MAAM,QAAQ,GAAsB,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,IAAI,IAAI,IAAI,IAAI,EAAE,CAAC;YAC3E,MAAM,KAAK,GAAG,cAAc,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAE3C,IAAI,MAAM,GAAkC;gBAC1C;oBACE,OAAO,EAAE,IAAI,CAAC,KAAK,CAAC,MAAM;iBAC3B;aACF,CAAC;YACF,IAAI,KAAK,EAAE,CAAC;gBACV,MAAM,GAAG,KAAK,CAAC;YACjB,CAAC;iBAAM,CAAC;gBACN,MAAM,GAAG,WAAW,CAAC,gBAAgB,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE;oBACvD,IAAI;oBACJ,KAAK,EAAE,IAAI,KAAK,MAAM,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,WAAW;iBAClD,CAAC,CAAC,CAAC,CAAC,CAAC;gBACN,cAAc,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;YACvC,CAAC;YAED,MAAM,MAAM,GAAG,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE;gBAChC,OAAO,IAAI,CAAA;eACF,KAAK,CAAC,OAAO;kBACV;oBACR,KAAK,EAAE,KAAK,CAAC,KAAK;iBACnB;iBACQ,CAAC;YACd,CAAC,CAAC,CAAC;YAEH,OAAO,IAAI,CAAA,SAAS,MAAM,SAAS,CAAC;QACtC,CAAC;;;;;;;;SAjDU,cAAc","sourcesContent":["import { ShadowlessElement } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { type DeltaInsert, ZERO_WIDTH_SPACE } from '@blocksuite/inline';\nimport { html } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport type { ThemedToken } from 'shiki';\n\nimport type { AffineTextAttributes } from '../_common/inline/presets/affine-inline-specs.js';\nimport { getThemeMode } from '../_common/utils/query.js';\nimport type { HighlightOptionsGetter } from './code-model.js';\nimport { DARK_THEME, LIGHT_THEME } from './utils/consts.js';\nimport {\n  highlightCache,\n  type highlightCacheKey,\n} from './utils/highlight-cache.js';\n\n@customElement('affine-code-line')\nexport class AffineCodeLine extends ShadowlessElement {\n  @property({ type: Object })\n  accessor delta: DeltaInsert<AffineTextAttributes> = {\n    insert: ZERO_WIDTH_SPACE,\n  };\n\n  @property({ attribute: false })\n  accessor highlightOptionsGetter: HighlightOptionsGetter | null = null;\n\n  override render() {\n    assertExists(\n      this.highlightOptionsGetter,\n      'highlightOptionsGetter is not set'\n    );\n    const { lang, highlighter } = this.highlightOptionsGetter();\n\n    if (!highlighter || !highlighter.getLoadedLanguages().includes(lang)) {\n      return html`<span><v-text .str=${this.delta.insert}></v-text></span>`;\n    }\n\n    const mode = getThemeMode();\n    const cacheKey: highlightCacheKey = `${this.delta.insert}-${lang}-${mode}`;\n    const cache = highlightCache.get(cacheKey);\n\n    let tokens: Omit<ThemedToken, 'offset'>[] = [\n      {\n        content: this.delta.insert,\n      },\n    ];\n    if (cache) {\n      tokens = cache;\n    } else {\n      tokens = highlighter.codeToTokensBase(this.delta.insert, {\n        lang,\n        theme: mode === 'dark' ? DARK_THEME : LIGHT_THEME,\n      })[0];\n      highlightCache.set(cacheKey, tokens);\n    }\n\n    const vTexts = tokens.map(token => {\n      return html`<v-text\n        .str=${token.content}\n        .styles=${{\n          color: token.color,\n        }}\n      ></v-text>`;\n    });\n\n    return html`<span>${vTexts}</span>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-code-line': AffineCodeLine;\n  }\n}\n"]}