{"version":3,"file":"view-source.js","sourceRoot":"","sources":["../../src/data-view-block/view-source.ts"],"names":[],"mappings":"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","sourcesContent":["import { Slot } from '@blocksuite/global/utils';\n\nimport type { SingleViewSource } from '../database-block/data-view/common/index.js';\nimport type {\n  DataViewDataType,\n  InsertToPosition,\n  ViewMeta,\n  ViewSource,\n} from '../database-block/data-view/index.js';\nimport type { DataViewTypes } from '../database-block/data-view/view/data-view.js';\nimport type { DataViewBlockModel } from './data-view-model.js';\nimport { blockQueryViewMap, blockQueryViews } from './views/index.js';\n\nexport class BlockQueryViewSource implements ViewSource {\n  get currentViewId(): string {\n    return this.currentId ?? this.model.views[0].id;\n  }\n\n  get views(): SingleViewSource[] {\n    return this.model.views.map(v => this.viewGet(v.id));\n  }\n\n  get currentView(): SingleViewSource {\n    return this.viewGet(this.currentViewId);\n  }\n\n  get readonly(): boolean {\n    return this.model.doc.readonly;\n  }\n\n  get allViewMeta(): ViewMeta[] {\n    return blockQueryViews;\n  }\n\n  private viewMap = new Map<string, SingleViewSource>();\n\n  private currentId?: string;\n\n  updateSlot = new Slot<{ viewId?: string }>();\n\n  viewInit: Record<\n    (typeof blockQueryViews)[number]['type'],\n    () => DataViewDataType\n  > = {\n    table: () => {\n      return {\n        id: this.model.doc.generateBlockId(),\n        name: 'Table View',\n        mode: 'table',\n        columns: [],\n        filter: {\n          type: 'group',\n          op: 'and',\n          conditions: [],\n        },\n      };\n    },\n    kanban: () => {\n      return {\n        id: this.model.doc.generateBlockId(),\n        name: 'Kanban View',\n        mode: 'kanban',\n        columns: [],\n        filter: {\n          type: 'group',\n          op: 'and',\n          conditions: [],\n        },\n        header: {\n          iconColumn: 'type',\n        },\n        groupProperties: [],\n      };\n    },\n  };\n\n  constructor(private model: DataViewBlockModel) {}\n\n  checkViewDataUpdate(): void {\n    this.model.views.forEach(v => {\n      this.updateSlot.emit({ viewId: v.id });\n    });\n  }\n\n  selectView(id: string): void {\n    this.currentId = id;\n    this.updateSlot.emit({});\n  }\n\n  viewAdd(viewType: DataViewTypes): string {\n    this.model.doc.captureSync();\n    const view = this.viewInit[viewType]();\n    this.model.doc.transact(() => {\n      this.model.views.push(view);\n    });\n    this.model.applyViewsUpdate();\n    return view.id;\n  }\n\n  viewGet(id: string): SingleViewSource {\n    let result = this.viewMap.get(id);\n    if (!result) {\n      const getView = () => {\n        return this.model.views.find(v => v.id === id);\n      };\n      const view = getView();\n      if (!view) {\n        throw new Error('view not found');\n      }\n      // eslint-disable-next-line @typescript-eslint/no-this-alias\n      const self = this;\n      const slot = new Slot<{ viewId: string }>();\n      this.updateSlot\n        .flatMap(data => {\n          if (data.viewId === id) {\n            return { viewId: id };\n          }\n          return [];\n        })\n        .pipe(slot);\n      result = {\n        duplicate(): void {\n          self.duplicate(id);\n        },\n        get view() {\n          const view = getView();\n          if (!view) {\n            throw new Error('view not found');\n          }\n          return view;\n        },\n        updateView: updater => {\n          this.model.doc.captureSync();\n          this.model.updateView(id, updater);\n          this.model.applyViewsUpdate();\n        },\n        delete: () => {\n          this.model.doc.captureSync();\n          if (this.model.views.length === 1) {\n            this.model.doc.deleteBlock(this.model);\n            return;\n          }\n          this.model.deleteView(id);\n          this.currentId = undefined;\n          this.model.applyViewsUpdate();\n        },\n        get readonly() {\n          return self.model.doc.readonly;\n        },\n        updateSlot: slot,\n        isDeleted() {\n          return self.model.views.every(v => v.id !== id);\n        },\n      };\n      this.viewMap.set(id, result);\n    }\n    return result;\n  }\n\n  duplicate(id: string): void {\n    const newId = this.model.duplicateView(id);\n    this.selectView(newId);\n  }\n\n  moveTo(id: string, position: InsertToPosition): void {\n    this.model.moveViewTo(id, position);\n  }\n\n  getViewMeta(type: string): ViewMeta {\n    return blockQueryViewMap[type];\n  }\n}\n"]}