{"version":3,"file":"data-view-block.js","sourceRoot":"","sources":["../../src/data-view-block/data-view-block.ts"],"names":[],"mappings":"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","sourcesContent":["import { RangeManager } from '@blocksuite/block-std';\nimport { Slice, Slot } from '@blocksuite/store';\nimport { css, nothing, unsafeCSS } from 'lit';\nimport { customElement } from 'lit/decorators.js';\nimport { html } from 'lit/static-html.js';\n\nimport { BlockComponent, popMenu } from '../_common/components/index.js';\nimport {\n  CopyIcon,\n  DeleteIcon,\n  MoreHorizontalIcon,\n} from '../_common/icons/index.js';\nimport { dataViewCommonStyle } from '../database-block/data-view/common/css-variable.js';\nimport type { DataSource } from '../database-block/data-view/common/data-source/base.js';\nimport {\n  DatabaseSelection,\n  DataView,\n  type DataViewProps,\n  type DataViewSelection,\n  type DataViewWidget,\n  type DataViewWidgetProps,\n  defineUniComponent,\n  renderUniLit,\n  type ViewSource,\n  widgetPresets,\n} from '../database-block/data-view/index.js';\nimport type { NoteBlockComponent } from '../note-block/index.js';\nimport {\n  type AffineInnerModalWidget,\n  EdgelessRootBlockComponent,\n} from '../root-block/index.js';\nimport { AFFINE_INNER_MODAL_WIDGET } from '../root-block/widgets/inner-modal/inner-modal.js';\nimport { BlockQueryDataSource } from './data-source.js';\nimport type { DataViewBlockModel } from './data-view-model.js';\nimport { BlockQueryViewSource } from './view-source.js';\n\n@customElement('affine-data-view')\nexport class DataViewBlockComponent extends BlockComponent<DataViewBlockModel> {\n  override get topContenteditableElement() {\n    if (this.rootElement instanceof EdgelessRootBlockComponent) {\n      const note = this.closest<NoteBlockComponent>('affine-note');\n      return note;\n    }\n    return this.rootElement;\n  }\n\n  get view() {\n    return this.dataView.expose;\n  }\n\n  get dataSource(): DataSource {\n    if (!this._dataSource) {\n      this._dataSource = new BlockQueryDataSource(this.host, this.model, {\n        type: 'todo',\n      });\n    }\n    return this._dataSource;\n  }\n\n  get viewSource(): ViewSource {\n    if (!this._viewSource) {\n      this._viewSource = new BlockQueryViewSource(this.model);\n    }\n    return this._viewSource;\n  }\n\n  get getFlag() {\n    return this.host.doc.awarenessStore.getFlag.bind(\n      this.host.doc.awarenessStore\n    );\n  }\n\n  get innerModalWidget() {\n    return this.rootElement?.widgetElements[\n      AFFINE_INNER_MODAL_WIDGET\n    ] as AffineInnerModalWidget;\n  }\n\n  static override styles = css`\n    ${unsafeCSS(dataViewCommonStyle('affine-database'))}\n    affine-database {\n      display: block;\n      border-radius: 8px;\n      background-color: var(--affine-background-primary-color);\n      padding: 8px;\n      margin: 8px -8px -8px;\n    }\n\n    .database-block-selected {\n      background-color: var(--affine-hover-color);\n      border-radius: 4px;\n    }\n\n    .database-ops {\n      margin-top: 4px;\n      padding: 2px;\n      border-radius: 4px;\n      display: flex;\n      cursor: pointer;\n    }\n\n    .database-ops svg {\n      width: 16px;\n      height: 16px;\n      color: var(--affine-icon-color);\n    }\n\n    .database-ops:hover {\n      background-color: var(--affine-hover-color);\n    }\n  `;\n\n  private dataView = new DataView();\n\n  private _dataSource?: DataSource;\n\n  private _viewSource?: ViewSource;\n\n  toolsWidget: DataViewWidget = widgetPresets.createTools({\n    table: [\n      widgetPresets.tools.filter,\n      widgetPresets.tools.expand,\n      widgetPresets.tools.search,\n      widgetPresets.tools.viewOptions,\n      widgetPresets.tools.tableAddRow,\n    ],\n    kanban: [\n      widgetPresets.tools.filter,\n      widgetPresets.tools.expand,\n      widgetPresets.tools.search,\n      widgetPresets.tools.viewOptions,\n    ],\n  });\n\n  headerWidget: DataViewWidget = defineUniComponent(\n    (props: DataViewWidgetProps) => {\n      return html`\n        <div style=\"margin-bottom: 16px;display:flex;flex-direction: column\">\n          <div style=\"display:flex;gap:8px;padding: 0 6px;margin-bottom: 8px;\">\n            <div>${this.model.title}</div>\n            ${this.renderDatabaseOps()}\n          </div>\n          <div\n            style=\"display:flex;align-items:center;justify-content: space-between;gap: 12px\"\n          >\n            <div style=\"flex:1\">\n              ${renderUniLit(widgetPresets.viewBar, props)}\n            </div>\n            ${renderUniLit(this.toolsWidget, props)}\n          </div>\n          ${renderUniLit(widgetPresets.filterBar, props)}\n        </div>\n      `;\n    }\n  );\n\n  selectionUpdated = new Slot<DataViewSelection | undefined>();\n\n  private _clickDatabaseOps = (e: MouseEvent) => {\n    popMenu(e.currentTarget as HTMLElement, {\n      options: {\n        input: {\n          initValue: this.model.title,\n          placeholder: 'Untitled',\n          onComplete: text => {\n            this.model.title = text;\n          },\n        },\n        items: [\n          {\n            type: 'action',\n            icon: CopyIcon,\n            name: 'Copy',\n            select: () => {\n              const slice = Slice.fromModels(this.doc, [this.model]);\n              this.std.clipboard.copySlice(slice).catch(console.error);\n            },\n          },\n          // {\n          //   type: 'action',\n          //   icon: DuplicateIcon,\n          //   name: 'Duplicate',\n          //   select: () => {\n          //   },\n          // },\n          {\n            type: 'group',\n            name: '',\n            children: () => [\n              {\n                type: 'action',\n                icon: DeleteIcon,\n                class: 'delete-item',\n                name: 'Delete Database',\n                select: () => {\n                  this.model.children.slice().forEach(block => {\n                    this.doc.deleteBlock(block);\n                  });\n                  this.doc.deleteBlock(this.model);\n                },\n              },\n            ],\n          },\n        ],\n      },\n    });\n  };\n\n  private renderDatabaseOps() {\n    if (this.doc.readonly) {\n      return nothing;\n    }\n    return html` <div class=\"database-ops\" @click=\"${this._clickDatabaseOps}\">\n      ${MoreHorizontalIcon}\n    </div>`;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.setAttribute(RangeManager.rangeSyncExcludeAttr, 'true');\n\n    this._disposables.add(\n      this.selection.slots.changed.on(selections => {\n        const databaseSelection = selections.find(\n          (selection): selection is DatabaseSelection => {\n            if (selection.blockId !== this.blockId) {\n              return false;\n            }\n            return selection instanceof DatabaseSelection;\n          }\n        );\n        this.selectionUpdated.emit(databaseSelection?.viewSelection);\n      })\n    );\n    this._disposables.add(\n      this.model.propsUpdated.on(data => {\n        if (data.key === 'views') {\n          this.viewSource.checkViewDataUpdate();\n        }\n      })\n    );\n  }\n\n  setSelection = (selection: DataViewSelection | undefined) => {\n    this.selection.setGroup(\n      'note',\n      selection\n        ? [\n            new DatabaseSelection({\n              blockId: this.blockId,\n              viewSelection: selection,\n            }),\n          ]\n        : []\n    );\n  };\n\n  _bindHotkey: DataViewProps['bindHotkey'] = hotkeys => {\n    return {\n      dispose: this.host.event.bindHotkey(hotkeys, {\n        path: this.topContenteditableElement?.path ?? this.path,\n      }),\n    };\n  };\n\n  _handleEvent: DataViewProps['handleEvent'] = (name, handler) => {\n    return {\n      dispose: this.host.event.add(name, handler, {\n        path: this.path,\n      }),\n    };\n  };\n\n  getRootService = () => {\n    return this.std.spec.getService('affine:page');\n  };\n\n  override renderBlock() {\n    const peekViewService = this.getRootService().peekViewService;\n    return html`\n      <div contenteditable=\"false\" style=\"position: relative\">\n        ${this.dataView.render({\n          bindHotkey: this._bindHotkey,\n          handleEvent: this._handleEvent,\n          getFlag: this.getFlag,\n          selectionUpdated: this.selectionUpdated,\n          setSelection: this.setSelection,\n          dataSource: this.dataSource,\n          viewSource: this.viewSource,\n          headerWidget: this.headerWidget,\n          std: this.std,\n          detailPanelConfig: {\n            openDetailPanel: peekViewService\n              ? async (target, template) =>\n                  peekViewService.peek(target, template)\n              : undefined,\n            target: () => this.innerModalWidget.target,\n          },\n        })}\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-data-view': DataViewBlockComponent;\n  }\n}\n"]}