{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/database-block/widgets/expand/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EventName, UIEventHandler } from '@blocksuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport type { Disposable } from '@blocksuite/global/utils';\nimport { assertExists, Slot } from '@blocksuite/global/utils';\nimport type { PropertyValues } from 'lit';\nimport { css, html } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\n\nimport { createModal } from '../../../_common/components/index.js';\nimport { CrossIcon, ExpandWideIcon } from '../../../_common/icons/index.js';\nimport { DatabaseSelection } from '../../data-view/common/selection.js';\nimport type { DataViewRendererConfig } from '../../data-view/data-view.js';\nimport type { DataViewSelection } from '../../data-view/types.js';\nimport { renderTemplate } from '../../data-view/utils/uni-component/render-template.js';\nimport { WidgetBase } from '../../data-view/widget/widget-base.js';\nimport type { DatabaseBlockComponent } from '../../database-block.js';\n\nexport function showDatabasePreviewModal(database: DatabaseBlockComponent) {\n  const viewComponent = new DatabaseBlockModalPreview();\n  viewComponent.database = database;\n  const editorHost = document.querySelector('editor-host');\n  assertExists(editorHost);\n  const modal = createModal(editorHost);\n  const close = () => {\n    modal.remove();\n  };\n  const container = renderTemplate(() => {\n    return html`\n      <style>\n        .database-block-preview-container {\n          position: absolute;\n          display: flex;\n          padding: 24px 53px;\n          border-radius: 8px;\n          left: 0;\n          right: 0;\n          margin: 20px auto auto;\n          width: calc(100% - 300px);\n          max-height: calc(100% - 40px);\n          box-shadow: var(--affine-shadow-1);\n          background-color: var(--affine-background-primary-color);\n        }\n        .database-block-preview-close {\n          position: absolute;\n          right: -48px;\n          top: 0;\n          padding: 10px;\n          border-radius: 8px;\n          cursor: pointer;\n          display: flex;\n          background-color: var(--affine-background-primary-color);\n        }\n        .database-block-preview-close svg {\n          color: var(--affine-icon-color);\n          width: 16px;\n          height: 16px;\n        }\n        .database-block-preview-close:hover {\n          background-color: var(--affine-hover-color-filled);\n        }\n      </style>\n      <div class=\"database-block-preview-container\">\n        <database-block-modal-preview\n          .database=\"${database}\"\n        ></database-block-modal-preview>\n        <div @click=\"${close}\" class=\"database-block-preview-close\">\n          ${CrossIcon}\n        </div>\n      </div>\n    `;\n  });\n  container.onclick = e => {\n    e.stopPropagation();\n  };\n  modal.onclick = close;\n  modal.style.backgroundColor = 'var(--affine-black-60)';\n  modal.append(container);\n}\n\n@customElement('expand-database-block-modal')\nexport class ExpandDatabaseBlockModal extends WidgetBase {\n  get database() {\n    return this.closest('affine-database');\n  }\n\n  protected override render(): unknown {\n    if (\n      this.closest('database-block-modal-preview') ||\n      !this.database?.doc.awarenessStore.getFlag('enable_expand_database_block')\n    ) {\n      return;\n    }\n    return html` <div\n      @click=\"${this.expandDatabase}\"\n      class=\"dv-icon-20 dv-pd-2 dv-hover dv-round-4\"\n      style=\"display:flex;\"\n    >\n      ${ExpandWideIcon}\n    </div>`;\n  }\n\n  expandDatabase = () => {\n    const database = this.closest('affine-database');\n    if (database) {\n      showDatabasePreviewModal(database);\n    }\n  };\n}\n\n@customElement('database-block-modal-preview')\nexport class DatabaseBlockModalPreview extends WithDisposable(\n  ShadowlessElement\n) {\n  static override styles = css`\n    database-block-modal-preview {\n      display: flex;\n      flex-direction: column;\n      flex: 1;\n      overflow: hidden;\n    }\n  `;\n\n  blockId = 'database-modal-preview';\n\n  @property({ attribute: false })\n  accessor database!: DatabaseBlockComponent;\n\n  selectionUpdated = new Slot<DataViewSelection | undefined>();\n\n  protected override firstUpdated(_changedProperties: PropertyValues) {\n    super.firstUpdated(_changedProperties);\n    requestAnimationFrame(() => {\n      this.querySelector('affine-data-view-renderer')?.focusFirstCell();\n    });\n  }\n\n  protected override render(): unknown {\n    const config: DataViewRendererConfig = {\n      bindHotkey: this.bindHotkey,\n      handleEvent: this.handleEvent,\n      getFlag: this.database.getFlag,\n      selectionUpdated: this.selectionUpdated,\n      setSelection: this.setSelection,\n      dataSource: this.database.dataSource,\n      viewSource: this.database.viewSource,\n      headerWidget: this.database.headerWidget,\n      std: this.database.std,\n    };\n    return html`\n      <affine-data-view-renderer\n        .config=\"${config}\"\n      ></affine-data-view-renderer>\n    `;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.database.selection.slots.changed.on(selections => {\n      const selection = selections.find(v => {\n        return v.blockId === this.blockId;\n      });\n      if (selection && selection instanceof DatabaseSelection) {\n        this.selectionUpdated.emit(selection.viewSelection);\n      } else {\n        this.selectionUpdated.emit(undefined);\n      }\n    });\n  }\n\n  setSelection: (selection?: DataViewSelection) => void = selection => {\n    this.database.host.selection.set(\n      selection\n        ? [\n            new DatabaseSelection({\n              blockId: this.blockId,\n              viewSelection: selection,\n            }),\n          ]\n        : []\n    );\n  };\n\n  bindHotkey: (hotkeys: Record<string, UIEventHandler>) => Disposable =\n    hotkeys => {\n      return {\n        dispose: this.database.host.event.bindHotkey(hotkeys, {\n          path: [],\n        }),\n      };\n    };\n\n  handleEvent: (name: EventName, handler: UIEventHandler) => Disposable = (\n    name,\n    handler\n  ) => {\n    return {\n      dispose: this.database.host.event.add(name, handler, {\n        path: [],\n      }),\n    };\n  };\n}\n"]}