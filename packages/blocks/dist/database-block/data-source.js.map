{"version":3,"file":"data-source.js","sourceRoot":"","sources":["../../src/database-block/data-source.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport { assertExists, type Disposable, Slot } from '@blocksuite/global/utils';\nimport { type BlockModel, Text } from '@blocksuite/store';\n\nimport { getIcon } from './block-icons.js';\nimport {\n  databaseBlockAllColumnMap,\n  databaseBlockColumns,\n} from './columns/index.js';\nimport { HostContextKey } from './context/host-context.js';\nimport {\n  BaseDataSource,\n  type ColumnConfig,\n  type ColumnMeta,\n  columnPresets,\n  createUniComponentFromWebComponent,\n  type DetailSlots,\n  insertPositionToIndex,\n  type InsertToPosition,\n} from './data-view/index.js';\nimport { map } from './data-view/utils/uni-component/operation.js';\nimport type { DatabaseBlockModel } from './database-model.js';\nimport { BlockRenderer } from './detail-panel/block-renderer.js';\nimport { NoteRenderer } from './detail-panel/note-renderer.js';\n\nexport type DatabaseBlockDataSourceConfig = {\n  pageId: string;\n  blockId: string;\n};\n\nexport class DatabaseBlockDataSource extends BaseDataSource {\n  get doc() {\n    return this._model.doc;\n  }\n\n  get rows(): string[] {\n    return this._model.children.map(v => v.id);\n  }\n\n  get properties(): string[] {\n    return this._model.columns.map(column => column.id);\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  get addPropertyConfigList(): ColumnConfig<any, any, any>[] {\n    return databaseBlockColumns.map(v => v.model);\n  }\n\n  override get detailSlots(): DetailSlots {\n    return {\n      ...super.detailSlots,\n      header: map(createUniComponentFromWebComponent(BlockRenderer), props => ({\n        ...props,\n        host: this.host,\n      })),\n      note: map(createUniComponentFromWebComponent(NoteRenderer), props => ({\n        ...props,\n        model: this._model,\n        host: this.host,\n      })),\n    };\n  }\n\n  private readonly _model: DatabaseBlockModel;\n\n  private _batch = 0;\n\n  slots = {\n    update: new Slot(),\n  };\n\n  constructor(\n    private host: EditorHost,\n    config: DatabaseBlockDataSourceConfig\n  ) {\n    super();\n    this._model = host.doc.collection\n      .getDoc(config.pageId)\n      ?.getBlockById(config.blockId) as DatabaseBlockModel;\n    this._model.childrenUpdated.pipe(this.slots.update);\n    this.setContext(HostContextKey, host);\n  }\n\n  private _runCapture() {\n    if (this._batch) {\n      return;\n    }\n\n    this._batch = requestAnimationFrame(() => {\n      this.doc.captureSync();\n      this._batch = 0;\n    });\n  }\n\n  private getModelById(rowId: string): BlockModel | undefined {\n    return this._model.children[this._model.childMap.get(rowId) ?? -1];\n  }\n\n  private newColumnName() {\n    let i = 1;\n    while (this._model.columns.some(column => column.name === `Column ${i}`)) {\n      i++;\n    }\n    return `Column ${i}`;\n  }\n\n  cellChangeValue(rowId: string, propertyId: string, value: unknown): void {\n    this._runCapture();\n\n    const type = this.propertyGetType(propertyId);\n    const update = this.getPropertyMeta(type).model.ops.valueUpdate;\n    let newValue = value;\n    if (update) {\n      const old = this.cellGetValue(rowId, propertyId);\n      newValue = update(old, this.propertyGetData(propertyId), value);\n    }\n    if (type === 'title' && newValue instanceof Text) {\n      this._model.doc.transact(() => {\n        this._model.text?.clear();\n        this._model.text?.join(newValue);\n      });\n      return;\n    }\n    if (this._model.columns.some(v => v.id === propertyId)) {\n      this._model.updateCell(rowId, {\n        columnId: propertyId,\n        value: newValue,\n      });\n      this._model.applyColumnUpdate();\n    }\n  }\n\n  cellGetValue(rowId: string, propertyId: string): unknown {\n    if (propertyId === 'type') {\n      const model = this.getModelById(rowId);\n      if (!model) {\n        return;\n      }\n      return getIcon(model);\n    }\n    const type = this.propertyGetType(propertyId);\n    if (type === 'title') {\n      const model = this.getModelById(rowId);\n      return model?.text;\n    }\n    return this._model.getCell(rowId, propertyId)?.value;\n  }\n\n  override cellGetExtra(rowId: string, propertyId: string): unknown {\n    if (this.propertyGetType(propertyId) === 'title') {\n      const model = this.getModelById(rowId);\n      if (model) {\n        return {\n          result: this.host.renderModel(model),\n          model,\n        };\n      }\n    }\n    return super.cellGetExtra(rowId, propertyId);\n  }\n\n  override cellGetRenderValue(rowId: string, propertyId: string): unknown {\n    return this.cellGetValue(rowId, propertyId);\n  }\n\n  propertyAdd(insertToPosition: InsertToPosition, type?: string): string {\n    this.doc.captureSync();\n    return this._model.addColumn(\n      insertToPosition,\n      databaseBlockAllColumnMap[\n        type ?? columnPresets.multiSelectColumnConfig.type\n      ].model.create(this.newColumnName())\n    );\n  }\n\n  propertyChangeData(propertyId: string, data: Record<string, unknown>): void {\n    this._runCapture();\n\n    this._model.updateColumn(propertyId, () => ({ data }));\n    this._model.applyColumnUpdate();\n  }\n\n  propertyChangeName(propertyId: string, name: string): void {\n    this.doc.captureSync();\n    this._model.updateColumn(propertyId, () => ({ name }));\n    this._model.applyColumnUpdate();\n  }\n\n  propertyChangeType(propertyId: string, toType: string): void {\n    const currentType = this.propertyGetType(propertyId);\n    const currentData = this.propertyGetData(propertyId);\n    const rows = this.rows;\n    const currentCells = rows.map(rowId =>\n      this.cellGetValue(rowId, propertyId)\n    );\n    const result = databaseBlockAllColumnMap[currentType].model?.convertCell(\n      toType,\n      currentData,\n      currentCells\n    ) ?? {\n      column: databaseBlockAllColumnMap[toType].model.defaultData(),\n      cells: currentCells.map(() => undefined),\n    };\n    this.doc.captureSync();\n    this._model.updateColumn(propertyId, () => ({\n      type: toType,\n      data: result.column,\n    }));\n    const cells: Record<string, unknown> = {};\n    currentCells.forEach((value, i) => {\n      if (value != null || result.cells[i] != null) {\n        cells[rows[i]] = result.cells[i];\n      }\n    });\n    this._model.updateCells(propertyId, cells);\n    this._model.applyColumnUpdate();\n  }\n\n  propertyDelete(id: string): void {\n    this.doc.captureSync();\n    const index = this._model.findColumnIndex(id);\n    if (index < 0) return;\n\n    this.doc.transact(() => {\n      this._model.columns.splice(index, 1);\n    });\n    this._model.applyColumnUpdate();\n  }\n\n  propertyGetData(propertyId: string): Record<string, unknown> {\n    return this._model.columns.find(v => v.id === propertyId)?.data ?? {};\n  }\n\n  override propertyGetReadonly(propertyId: string): boolean {\n    if (propertyId === 'type') return true;\n    return false;\n  }\n\n  propertyGetName(propertyId: string): string {\n    if (propertyId === 'type') {\n      return 'Block Type';\n    }\n    return this._model.columns.find(v => v.id === propertyId)?.name ?? '';\n  }\n\n  propertyGetType(propertyId: string): string {\n    if (propertyId === 'type') {\n      return 'image';\n    }\n    return this._model.columns.find(v => v.id === propertyId)?.type ?? '';\n  }\n\n  propertyDuplicate(columnId: string): string {\n    this.doc.captureSync();\n    const currentSchema = this._model.getColumn(columnId);\n    assertExists(currentSchema);\n    const { id: copyId, ...nonIdProps } = currentSchema;\n    const names = new Set(this._model.columns.map(v => v.name));\n    let index = 1;\n    while (names.has(`${nonIdProps.name}(${index})`)) {\n      index++;\n    }\n    const schema = { ...nonIdProps, name: `${nonIdProps.name}(${index})` };\n    const id = this._model.addColumn(\n      {\n        before: false,\n        id: columnId,\n      },\n      schema\n    );\n    this._model.copyCellsByColumn(copyId, id);\n    this._model.applyColumnUpdate();\n    return id;\n  }\n\n  rowAdd(insertPosition: InsertToPosition | number): string {\n    this.doc.captureSync();\n    const index =\n      typeof insertPosition === 'number'\n        ? insertPosition\n        : insertPositionToIndex(insertPosition, this._model.children);\n    return this.doc.addBlock('affine:paragraph', {}, this._model.id, index);\n  }\n\n  rowDelete(ids: string[]): void {\n    this.doc.captureSync();\n    this.doc.updateBlock(this._model, {\n      children: this._model.children.filter(v => !ids.includes(v.id)),\n    });\n    this._model.deleteRows(ids);\n  }\n\n  override propertyGetDefaultWidth(propertyId: string): number {\n    if (this.propertyGetType(propertyId) === 'title') {\n      return 260;\n    }\n    return super.propertyGetDefaultWidth(propertyId);\n  }\n\n  override onCellUpdate(\n    rowId: string,\n    propertyId: string,\n    callback: () => void\n  ): Disposable {\n    let lastDisposable: Disposable | undefined;\n    let lastValue: unknown = this.cellGetValue(rowId, propertyId);\n    const cb = () => {\n      const value = this.cellGetValue(rowId, propertyId);\n      const type = this.propertyGetType(propertyId);\n      const onUpdate = this.getPropertyMeta(type).model.ops.onUpdate;\n      if (!onUpdate) {\n        if (value != lastValue) {\n          callback();\n        }\n      } else {\n        if (value != lastValue) {\n          lastDisposable?.dispose();\n          lastDisposable =\n            value != null\n              ? onUpdate(\n                  value as never,\n                  this.propertyGetData(propertyId),\n                  callback\n                )\n              : undefined;\n        }\n      }\n      lastValue = value;\n    };\n    return this._model.propsUpdated.on(cb);\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  getPropertyMeta(type: string): ColumnMeta<any, any, any> {\n    return databaseBlockAllColumnMap[type];\n  }\n\n  rowMove(rowId: string, position: InsertToPosition): void {\n    const model = this.doc.getBlockById(rowId);\n    if (model) {\n      const index = insertPositionToIndex(position, this._model.children);\n      const target = this._model.children[index];\n      if (target.id === rowId) {\n        return;\n      }\n      this.doc.moveBlocks([model], this._model, target);\n    }\n  }\n}\n"]}