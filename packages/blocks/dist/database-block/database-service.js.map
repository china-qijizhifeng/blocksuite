{"version":3,"file":"database-service.js","sourceRoot":"","sources":["../../src/database-block/database-service.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,YAAY,EAAE,MAAM,uBAAuB,CAAC;AACrD,OAAO,EAAE,YAAY,EAAE,MAAM,0BAA0B,CAAC;AAGxD,OAAO,EAAE,aAAa,EAAE,MAAM,qCAAqC,CAAC;AACpE,OAAO,EAEL,iCAAiC,GAClC,MAAM,kDAAkD,CAAC;AAC1D,OAAO,EAAE,2BAA2B,EAAE,MAAM,uCAAuC,CAAC;AACpF,OAAO,EAAE,mBAAmB,EAAE,MAAM,oEAAoE,CAAC;AACzG,OAAO,EAAE,iBAAiB,EAAE,MAAM,iCAAiC,CAAC;AACpE,OAAO,EAAE,WAAW,EAAE,MAAM,sBAAsB,CAAC;AAGnD,OAAO,EAAE,qBAAqB,EAAE,wBAAwB,EAAE,MAAM,YAAY,CAAC;AAE7E,MAAM,OAAO,oBAEX,SAAQ,YAAgC;IAF1C;;QAGW,kBAAa,GAAG,IAAI,aAAa,EAAkB,CAAC;QAEpD,wBAAmB,GAAG,IAAI,mBAAmB,EAAE,CAAC;QAEzD,0BAAqB,GAAG,qBAAqB,CAAC;QAE9C,gBAAW,GAAG,WAAW,CAAC;IAiC5B,CAAC;IA/BU,OAAO;QACd,KAAK,CAAC,OAAO,EAAE,CAAC;QAChB,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,iBAAiB,CAAC,CAAC;QAElD,IAAI,CAAC,mBAAmB,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAE1C,MAAM,WAAW,GAAG,iCAAiC,CACnD,IAAI,CAAC,mBAAmB,CACzB,CAAC;QACF,IAAI,CAAC,aAAa,CAAC,aAAa,CAAC,WAAW,CAAC,CAAC;QAC9C,IAAI,CAAC,aAAa,CAAC,uBAAuB,CAAC,2BAA2B,CAAC,CAAC;IAC1E,CAAC;IAED,iBAAiB,CACf,GAAQ,EACR,KAAiB,EACjB,UAAkB,EAClB,QAAkB,EAClB,cAAc,GAAG,IAAI;QAErB,MAAM,UAAU,GAAG,GAAG,CAAC,YAAY,CAAC,UAAU,CAAuB,CAAC;QACtE,YAAY,CAAC,UAAU,CAAC,CAAC;QACzB,wBAAwB,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC;QAC/C,IAAI,cAAc,EAAE,CAAC;YACnB,iCAAiC;YACjC,MAAM,MAAM,GAAG,GAAG,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;YACpC,YAAY,CAAC,MAAM,CAAC,CAAC;YACrB,GAAG,CAAC,QAAQ,CAAC,kBAAkB,EAAE,EAAE,EAAE,MAAM,CAAC,EAAE,CAAC,CAAC;QAClD,CAAC;QACD,UAAU,CAAC,iBAAiB,EAAE,CAAC;IACjC,CAAC;CACF","sourcesContent":["import { BlockService } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { BlockModel, Doc } from '@blocksuite/store';\n\nimport { InlineManager } from '../_common/inline/inline-manager.js';\nimport {\n  type AffineTextAttributes,\n  getAffineInlineSpecsWithReference,\n} from '../_common/inline/presets/affine-inline-specs.js';\nimport { affineInlineMarkdownMatches } from '../_common/inline/presets/markdown.js';\nimport { ReferenceNodeConfig } from '../_common/inline/presets/nodes/reference-node/reference-config.js';\nimport { DatabaseSelection } from './data-view/common/selection.js';\nimport { viewPresets } from './data-view/index.js';\nimport type { ViewMeta } from './data-view/view/data-view.js';\nimport type { DatabaseBlockModel } from './database-model.js';\nimport { databaseViewInitEmpty, databaseViewInitTemplate } from './utils.js';\n\nexport class DatabaseBlockService<\n  TextAttributes extends AffineTextAttributes = AffineTextAttributes,\n> extends BlockService<DatabaseBlockModel> {\n  readonly inlineManager = new InlineManager<TextAttributes>();\n\n  readonly referenceNodeConfig = new ReferenceNodeConfig();\n\n  databaseViewInitEmpty = databaseViewInitEmpty;\n\n  viewPresets = viewPresets;\n\n  override mounted(): void {\n    super.mounted();\n    this.selectionManager.register(DatabaseSelection);\n\n    this.referenceNodeConfig.setDoc(this.doc);\n\n    const inlineSpecs = getAffineInlineSpecsWithReference(\n      this.referenceNodeConfig\n    );\n    this.inlineManager.registerSpecs(inlineSpecs);\n    this.inlineManager.registerMarkdownMatches(affineInlineMarkdownMatches);\n  }\n\n  initDatabaseBlock(\n    doc: Doc,\n    model: BlockModel,\n    databaseId: string,\n    viewMeta: ViewMeta,\n    isAppendNewRow = true\n  ) {\n    const blockModel = doc.getBlockById(databaseId) as DatabaseBlockModel;\n    assertExists(blockModel);\n    databaseViewInitTemplate(blockModel, viewMeta);\n    if (isAppendNewRow) {\n      // Add a paragraph after database\n      const parent = doc.getParent(model);\n      assertExists(parent);\n      doc.addBlock('affine:paragraph', {}, parent.id);\n    }\n    blockModel.applyColumnUpdate();\n  }\n}\n"]}