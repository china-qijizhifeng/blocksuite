{"version":3,"file":"column-config.js","sourceRoot":"","sources":["../../../../src/database-block/data-view/column/column-config.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Disposable } from '@blocksuite/global/utils';\n\nimport type { TType } from '../logical/typesystem.js';\nimport type { StatCalcOpType } from '../view/presets/table/types.js';\nimport type {\n  GetCellDataFromConfig,\n  GetColumnDataFromConfig,\n} from './manager.js';\nimport { createRendererConfig, type Renderer } from './renderer.js';\n\ntype JSON =\n  | null\n  | number\n  | string\n  | boolean\n  | JSON[]\n  | {\n      [k: string]: JSON;\n    };\n\ntype ColumnOps<\n  Data extends NonNullable<unknown> = NonNullable<unknown>,\n  Value = unknown,\n> = {\n  name: string;\n  defaultData: () => Data;\n  type: (data: Data) => TType;\n  formatValue?: (value: unknown, colData: Data) => Value;\n  isEmpty: (value?: Value) => boolean;\n  cellToString: (data: Value, colData: Data) => string;\n  cellFromString: (\n    data: string,\n    colData: Data\n  ) => {\n    value: unknown;\n    data?: Record<string, unknown>;\n  };\n  cellToJson: (data: Value, colData: Data) => JSON;\n  addGroup?: (text: string, oldData: Data) => Data;\n  onUpdate?: (value: Value, Data: Data, callback: () => void) => Disposable;\n  valueUpdate?: (value: Value, Data: Data, newValue: Value) => Value;\n};\n\nexport class ColumnConfig<\n  Type extends string = keyof ColumnConfigMap,\n  T extends NonNullable<unknown> = NonNullable<unknown>,\n  CellData = unknown,\n> {\n  convertMap = new Map();\n\n  constructor(\n    readonly type: Type,\n    public ops: ColumnOps<T, CellData>\n  ) {}\n\n  create = (\n    name: string,\n    data?: T\n  ): {\n    type: string;\n    name: string;\n    statCalcOp: StatCalcOpType;\n    data: T;\n  } => {\n    return {\n      type: this.type,\n      name,\n      statCalcOp: 'none',\n      data: data ?? this.ops.defaultData(),\n    };\n  };\n\n  defaultData() {\n    return this.ops.defaultData();\n  }\n\n  createWithId(\n    id: string,\n    name: string,\n    data?: T\n  ): {\n    type: string;\n    name: string;\n    data: T;\n    id: string;\n  } {\n    return {\n      id,\n      type: this.type,\n      name,\n      data: data ?? this.ops.defaultData(),\n    };\n  }\n\n  dataType(data: T) {\n    return this.ops.type(data);\n  }\n\n  toString(cellData: CellData, colData: T): string {\n    return this.ops.cellToString(cellData, colData);\n  }\n\n  toJson(cellData: CellData, colData: T): JSON {\n    return this.ops.cellToJson(cellData, colData);\n  }\n\n  formatValue(cellData: CellData, colData: T): CellData | undefined {\n    return cellData === undefined\n      ? undefined\n      : this.ops.formatValue?.(cellData, colData) ?? cellData;\n  }\n\n  fromString(cellData: string, colData: T) {\n    return this.ops.cellFromString(cellData, colData);\n  }\n\n  convertCell(to: string, column: Record<string, unknown>, cells: unknown[]) {\n    return this.convertMap.get(to)?.(column, cells);\n  }\n\n  registerConvert = <ToCellName extends keyof ColumnConfigMap>(\n    to: ToCellName,\n    convert: (\n      column: GetColumnDataFromConfig<ColumnConfig<Type, T, CellData>>,\n      cells: (\n        | GetCellDataFromConfig<ColumnConfig<Type, T, CellData>>\n        | undefined\n      )[]\n    ) => {\n      column: GetColumnDataFromConfig<ColumnConfigMap[ToCellName]>;\n      cells: (GetCellDataFromConfig<ColumnConfigMap[ToCellName]> | undefined)[];\n    }\n  ) => {\n    this.convertMap.set(to, convert);\n  };\n\n  get name() {\n    return this.ops.name;\n  }\n}\n\nexport type ColumnMeta<\n  Type extends string = keyof ColumnConfigMap,\n  CellData = unknown,\n  ColumnData extends NonNullable<unknown> = NonNullable<unknown>,\n> = {\n  type: Type;\n  model: ColumnConfig<Type, ColumnData, CellData>;\n  renderer: Renderer<ColumnData, CellData>;\n};\nexport const columnType = <Type extends string>(type: Type) => ({\n  type: type,\n  modelConfig: <\n    CellData,\n    ColumnData extends Record<string, unknown> = Record<string, never>,\n  >(\n    ops: ColumnOps<ColumnData, CellData>\n  ) => {\n    const model = new ColumnConfig(type, ops);\n    return {\n      type,\n      model,\n      create: model.create,\n      addConvert: model.registerConvert,\n      renderConfig: (\n        renderer: Omit<Renderer<ColumnData, CellData>, 'type'>\n      ): ColumnMeta<Type, CellData, ColumnData> => ({\n        type,\n        model,\n        renderer: createRendererConfig<CellData, ColumnData>({\n          ...renderer,\n          type,\n        }),\n      }),\n    };\n  },\n});\n"]}