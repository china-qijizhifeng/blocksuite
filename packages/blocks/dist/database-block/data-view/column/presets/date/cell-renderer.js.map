{"version":3,"file":"cell-renderer.js","sourceRoot":"","sources":["../../../../../../src/database-block/data-view/column/presets/date/cell-renderer.ts"],"names":[],"mappings":"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","sourcesContent":["import { flip, offset } from '@floating-ui/dom';\nimport { baseTheme } from '@toeverything/theme';\nimport { format } from 'date-fns/format';\nimport { css, html, unsafeCSS } from 'lit';\nimport { customElement, query } from 'lit/decorators.js';\n\nimport { DatePicker } from '../../../../../_common/components/date-picker/index.js';\nimport { createLitPortal } from '../../../../../_common/components/portal.js';\nimport { createIcon } from '../../../utils/uni-icon.js';\nimport { BaseCellRenderer } from '../../base-cell.js';\nimport { createFromBaseCellRenderer } from '../../renderer.js';\nimport { dateColumnModelConfig } from './define.js';\n\n@customElement('affine-database-date-cell')\nexport class DateCell extends BaseCellRenderer<number> {\n  static override styles = css`\n    affine-database-date-cell {\n      width: 100%;\n    }\n\n    .affine-database-date {\n      display: flex;\n      align-items: center;\n      width: 100%;\n      padding: 0;\n      border: none;\n      font-family: ${unsafeCSS(baseTheme.fontSansFamily)};\n      color: var(--affine-text-primary-color);\n      font-weight: 400;\n      background-color: transparent;\n      font-size: var(--data-view-cell-text-size);\n      line-height: var(--data-view-cell-text-line-height);\n      height: var(--data-view-cell-text-line-height);\n    }\n\n    input.affine-database-date[type='date']::-webkit-calendar-picker-indicator {\n      display: none;\n    }\n  `;\n\n  override render() {\n    const value = this.value ? format(new Date(this.value), 'yyyy-MM-dd') : '';\n    if (!value) {\n      return '';\n    }\n    return html` <input\n      type=\"date\"\n      value=\"${value}\"\n      class=\"affine-database-date date\"\n    />`;\n  }\n}\n\n@customElement('affine-database-date-cell-editing')\nexport class DateCellEditing extends BaseCellRenderer<number> {\n  static override styles = css`\n    affine-database-date-cell-editing {\n      width: 100%;\n      cursor: text;\n    }\n\n    .affine-database-date:focus {\n      outline: none;\n    }\n  `;\n\n  @query('input')\n  private accessor _inputEle!: HTMLInputElement;\n\n  private _prevPortalAbortController: AbortController | null = null;\n\n  private _datePicker: DatePicker | null = null;\n\n  private _setValue = (str: string = this._inputEle.value) => {\n    if (str === '') {\n      this.onChange(undefined);\n      this._inputEle.value = '';\n      return;\n    }\n\n    const date = new Date(str);\n    const value = format(date, 'yyyy-MM-dd');\n    this.onChange(date.getTime());\n    this._inputEle.value = `${value ?? ''}`;\n  };\n\n  private _onFocus = () => {\n    if (\n      this._prevPortalAbortController &&\n      !this._prevPortalAbortController.signal.aborted\n    )\n      return;\n\n    // this._inputEle.showPicker();\n    this._prevPortalAbortController?.abort();\n    const abortController = new AbortController();\n    this._prevPortalAbortController = abortController;\n\n    abortController.signal.addEventListener(\n      'abort',\n      () => (this._datePicker = null),\n      { once: true }\n    );\n\n    const root = createLitPortal({\n      abortController,\n      closeOnClickAway: true,\n      computePosition: {\n        referenceElement: this._inputEle,\n        placement: 'bottom',\n        middleware: [offset(10), flip()],\n      },\n      template: () => {\n        const datePicker = new DatePicker();\n        datePicker.value = this.value ?? Date.now();\n        datePicker.onChange = (date: Date) => {\n          this._setValue(date.toISOString());\n        };\n        setTimeout(() => datePicker.focusDateCell());\n        this._datePicker = datePicker;\n        return datePicker;\n      },\n    });\n    // TODO: use z-index from variable,\n    //       for now the slide-layout-modal's z-index is `1001`\n    //       the z-index of popover should be higher than it\n    // root.style.zIndex = 'var(--affine-z-index-popover)';\n    root.style.zIndex = '1002';\n  };\n\n  private _onInput(e: InputEvent) {\n    if (!this._datePicker) return;\n    const v = (e.target as HTMLInputElement).value;\n    this._datePicker.value = v ? new Date(v).getTime() : undefined;\n  }\n\n  override onExitEditMode() {\n    this._setValue();\n    this._prevPortalAbortController?.abort();\n  }\n\n  override firstUpdated() {\n    this._inputEle.focus();\n  }\n\n  override render() {\n    const value = this.value ? format(this.value, 'yyyy-MM-dd') : '';\n    return html`<input\n      type=\"date\"\n      class=\"affine-database-date date\"\n      .value=\"${value}\"\n      @focus=${this._onFocus}\n      @input=${this._onInput}\n    />`;\n  }\n}\n\nexport const dateColumnConfig = dateColumnModelConfig.renderConfig({\n  icon: createIcon('DateTime'),\n  cellRenderer: {\n    view: createFromBaseCellRenderer(DateCell),\n    edit: createFromBaseCellRenderer(DateCellEditing),\n  },\n});\n"]}