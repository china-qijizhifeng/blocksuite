{"version":3,"file":"data-view.js","sourceRoot":"","sources":["../../../src/database-block/data-view/data-view.ts"],"names":[],"mappings":"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","sourcesContent":["import './common/group-by/define.js';\n\nimport type { BlockStdScope } from '@blocksuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { Slot } from '@blocksuite/global/utils';\nimport type { ReferenceElement } from '@floating-ui/dom';\nimport { css, type TemplateResult, unsafeCSS } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { keyed } from 'lit/directives/keyed.js';\nimport { createRef, ref } from 'lit/directives/ref.js';\nimport { html } from 'lit/static-html.js';\n\nimport { dataViewCommonStyle } from './common/css-variable.js';\nimport type { DataSource } from './common/data-source/base.js';\nimport { createRecordDetail, popSideDetail } from './common/detail/layout.js';\nimport type { ViewSource } from './common/index.js';\nimport type { DataViewSelection, DataViewSelectionState } from './types.js';\nimport { renderUniLit } from './utils/uni-component/index.js';\nimport type { DataViewExpose, DataViewProps } from './view/data-view.js';\nimport type { DataViewBase } from './view/data-view-base.js';\nimport type { DataViewManager } from './view/data-view-manager.js';\n\ntype ViewProps = {\n  view: DataViewManager;\n  viewUpdated: Slot<{ viewId: string }>;\n  selectionUpdated: Slot<DataViewSelectionState>;\n  setSelection: (selection?: DataViewSelectionState) => void;\n  bindHotkey: DataViewBase['bindHotkey'];\n  handleEvent: DataViewBase['handleEvent'];\n};\n\nexport type DataViewRendererConfig = {\n  bindHotkey: DataViewProps['bindHotkey'];\n  handleEvent: DataViewProps['handleEvent'];\n  getFlag?: DataViewProps['getFlag'];\n  selectionUpdated: Slot<DataViewSelection | undefined>;\n  setSelection: (selection: DataViewSelection | undefined) => void;\n  dataSource: DataSource;\n  viewSource: ViewSource;\n  detailPanelConfig?: {\n    openDetailPanel?: (\n      target: HTMLElement,\n      template: TemplateResult\n    ) => Promise<void>;\n    target?: () => ReferenceElement;\n  };\n  headerWidget: DataViewProps['headerWidget'];\n  onDrag?: DataViewProps['onDrag'];\n  std: BlockStdScope;\n};\n\n@customElement('affine-data-view-renderer')\nexport class DataViewRenderer extends WithDisposable(ShadowlessElement) {\n  get expose() {\n    return this._view.value;\n  }\n\n  static override styles = css`\n    ${unsafeCSS(dataViewCommonStyle('affine-data-view-renderer'))}\n    affine-data-view-renderer {\n      background-color: var(--affine-background-primary-color);\n      display: contents;\n    }\n  `;\n\n  private _view = createRef<DataViewExpose>();\n\n  private viewMap: Record<string, ViewProps> = {};\n\n  @property({ attribute: false })\n  accessor config!: DataViewRendererConfig;\n\n  @state()\n  accessor currentView: string | undefined = undefined;\n\n  private getView(id: string): ViewProps {\n    if (!this.viewMap[id]) {\n      const singleViewSource = this.config.viewSource.viewGet(id);\n\n      const view = new (this.config.viewSource.getViewMeta(\n        singleViewSource.view.mode\n      ).model.dataViewManager)();\n      view.init(this.config.dataSource, singleViewSource);\n      this.viewMap[id] = {\n        view: view,\n        viewUpdated: singleViewSource.updateSlot,\n        selectionUpdated: new Slot<DataViewSelectionState>(),\n        setSelection: selection => {\n          this.config.setSelection(selection);\n        },\n        handleEvent: (name, handler) =>\n          this.config.handleEvent(name, context => {\n            if (this.config.viewSource.currentViewId === id) {\n              return handler(context);\n            }\n          }),\n        bindHotkey: hotkeys =>\n          this.config.bindHotkey(\n            Object.fromEntries(\n              Object.entries(hotkeys).map(([key, fn]) => [\n                key,\n                ctx => {\n                  if (this.config.viewSource.currentViewId === id) {\n                    return fn(ctx);\n                  }\n                },\n              ])\n            )\n          ),\n      };\n    }\n    return this.viewMap[id];\n  }\n\n  private renderView(viewData?: ViewProps) {\n    if (!viewData) {\n      return;\n    }\n    const props: DataViewProps = {\n      dataViewEle: this,\n      view: viewData.view,\n      headerWidget: this.config.headerWidget,\n      selectionUpdated: viewData.selectionUpdated,\n      setSelection: viewData.setSelection,\n      bindHotkey: viewData.bindHotkey,\n      handleEvent: viewData.handleEvent,\n      getFlag: this.config.getFlag,\n      onDrag: this.config.onDrag,\n      std: this.config.std,\n      viewSource: this.config.viewSource,\n      dataSource: this.config.dataSource,\n    };\n    return keyed(\n      viewData.view.id,\n      renderUniLit(\n        this.config.viewSource.getViewMeta(viewData.view.type).renderer.view,\n        props,\n        { ref: this._view }\n      )\n    );\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.disposables.add(\n      this.config.selectionUpdated.on(selection => {\n        Object.entries(this.viewMap).forEach(([id, v]) => {\n          if (!selection || selection.viewId !== id) {\n            v.selectionUpdated.emit(undefined);\n            return;\n          }\n          v.selectionUpdated.emit(selection);\n        });\n      })\n    );\n    this.disposables.add(\n      this.config.viewSource.updateSlot.on(() => {\n        this.requestUpdate();\n      })\n    );\n  }\n\n  focusFirstCell = () => {\n    this._view.value?.focusFirstCell();\n  };\n\n  openDetailPanel = (ops: {\n    view: DataViewManager;\n    rowId: string;\n    onClose?: () => void;\n  }) => {\n    const openDetailPanel = this.config.detailPanelConfig?.openDetailPanel;\n    if (openDetailPanel) {\n      openDetailPanel(\n        this,\n        createRecordDetail({\n          view: ops.view,\n          rowId: ops.rowId,\n        })\n      )\n        .catch(console.error)\n        .finally(ops.onClose);\n    } else {\n      popSideDetail({\n        target: this.config.detailPanelConfig?.target?.() ?? document.body,\n        view: ops.view,\n        rowId: ops.rowId,\n        onClose: ops.onClose,\n      });\n    }\n  };\n\n  override render() {\n    const views = this.config.viewSource.views;\n    const viewData = views\n      .map(view => this.getView(view.view.id))\n      .find(v => v.view.id === this.config.viewSource.currentViewId);\n    const containerClass = classMap({\n      'toolbar-hover-container': true,\n      'data-view-root': true,\n    });\n    return html`\n      <div style=\"display: contents\" class=\"${containerClass}\">\n        ${this.renderView(viewData)}\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-data-view-renderer': DataViewRenderer;\n  }\n}\n\nexport class DataView {\n  private _ref = createRef<DataViewRenderer>();\n\n  get expose() {\n    return this._ref.value?.expose;\n  }\n\n  render(props: DataViewRendererConfig) {\n    return html` <affine-data-view-renderer\n      ${ref(this._ref)}\n      .config=\"${props}\"\n    ></affine-data-view-renderer>`;\n  }\n}\n"]}