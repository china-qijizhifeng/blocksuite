{"version":3,"file":"column-header.js","sourceRoot":"","sources":["../../../../../../../../src/database-block/data-view/view/presets/table/components/column-header/column-header.ts"],"names":[],"mappings":"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","sourcesContent":["import './database-header-column.js';\n\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport {\n  autoUpdate,\n  computePosition,\n  type Middleware,\n  shift,\n} from '@floating-ui/dom';\nimport { nothing, type TemplateResult } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { createRef, ref } from 'lit/directives/ref.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\nimport { html } from 'lit/static-html.js';\n\nimport { AddCursorIcon } from '../../../../../../../_common/icons/index.js';\nimport { getScrollContainer } from '../../../../../../../_common/utils/scroll-container.js';\nimport { renderTemplate } from '../../../../../utils/uni-component/render-template.js';\nimport type { DataViewTableManager } from '../../table-view-manager.js';\nimport { styles } from './styles.js';\n\n@customElement('affine-database-column-header')\nexport class DatabaseColumnHeader extends WithDisposable(ShadowlessElement) {\n  private get readonly() {\n    return this.tableViewManager.readonly;\n  }\n\n  static override styles = styles;\n\n  private addColumnPositionRef = createRef();\n\n  @property({ attribute: false })\n  accessor tableViewManager!: DataViewTableManager;\n\n  @property({ attribute: false })\n  accessor renderGroupHeader: (() => TemplateResult) | undefined;\n\n  addColumnButton = renderTemplate(() => {\n    if (this.readonly) return nothing;\n\n    return html` <div\n      @click=\"${this._onAddColumn}\"\n      class=\"header-add-column-button dv-hover\"\n    >\n      ${AddCursorIcon}\n    </div>`;\n  });\n\n  private _onAddColumn = () => {\n    if (this.readonly) return;\n    this.tableViewManager.columnAdd('end');\n    requestAnimationFrame(() => {\n      this.editLastColumnTitle();\n    });\n  };\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.disposables.add(\n      this.tableViewManager.slots.update.on(() => {\n        this.requestUpdate();\n      })\n    );\n    const scrollContainer = getScrollContainer(\n      this.closest('affine-data-view-renderer')!\n    );\n    const group = this.closest('affine-data-view-table-group');\n    if (group) {\n      const cancel = autoUpdate(group, this, () => {\n        if (!scrollContainer) {\n          return;\n        }\n        computePosition(group, this, {\n          middleware: [headerShift(scrollContainer)],\n        })\n          .then(data => {\n            const x = data.middlewareData.headerShift.x;\n            this.style.transform = `translate3d(0,${x / this.getScale()}px,0)`;\n          })\n          .catch(console.error);\n      });\n      this.disposables.add(cancel);\n    }\n    if (group) {\n      this.disposables.addFromEvent(group, 'mouseenter', () => {\n        this.addColumnButton.style.visibility = 'visible';\n      });\n      this.disposables.addFromEvent(group, 'mouseleave', () => {\n        this.addColumnButton.style.visibility = 'hidden';\n      });\n      this.disposables.addFromEvent(this.addColumnButton, 'mouseenter', () => {\n        this.addColumnButton.style.visibility = 'visible';\n      });\n      this.disposables.addFromEvent(this.addColumnButton, 'mouseleave', () => {\n        this.addColumnButton.style.visibility = 'hidden';\n      });\n      this.addColumnButton.style.visibility = 'hidden';\n      this.addColumnButton.style.transition = 'visibility 0.2s';\n      this.addColumnButton.style.marginLeft = '20px';\n      this.addColumnButton.style.position = 'absolute';\n      this.addColumnButton.style.zIndex = '1';\n      this.closest('affine-data-view-renderer')?.append(this.addColumnButton);\n      requestAnimationFrame(() => {\n        const referenceEl = this.addColumnPositionRef.value;\n        if (!referenceEl) {\n          return;\n        }\n        const cleanup = autoUpdate(\n          referenceEl,\n          this.addColumnButton,\n          this.updateAddButton\n        );\n        this.disposables.add({\n          dispose: () => {\n            cleanup();\n            this.addColumnButton.remove();\n          },\n        });\n      });\n    }\n  }\n\n  updateAddButton = () => {\n    const referenceEl = this.addColumnPositionRef.value;\n    if (!referenceEl) {\n      return;\n    }\n    computePosition(referenceEl, this.addColumnButton, {\n      middleware: [\n        shift({\n          boundary: this.closest('affine-database-table') ?? this,\n          padding: -20,\n        }),\n      ],\n    })\n      .then(({ x, y }) => {\n        Object.assign(this.addColumnButton.style, {\n          left: `${x}px`,\n          top: `${y}px`,\n        });\n      })\n      .catch(console.error);\n  };\n\n  editLastColumnTitle = () => {\n    const columns = this.querySelectorAll('affine-database-header-column');\n    const column = columns.item(columns.length - 1);\n    column.scrollIntoView({ block: 'nearest', inline: 'nearest' });\n    column.editTitle();\n  };\n\n  @query('.scale-div')\n  accessor scaleDiv!: HTMLDivElement;\n\n  getScale() {\n    return this.scaleDiv?.getBoundingClientRect().width ?? 1;\n  }\n\n  override render() {\n    this.updateAddButton();\n    return html`\n      ${this.renderGroupHeader?.()}\n      <div class=\"affine-database-column-header database-row\">\n        <div class=\"data-view-table-left-bar\"></div>\n        ${repeat(\n          this.tableViewManager.columnManagerList,\n          column => column.id,\n          (column, index) => {\n            const style = styleMap({\n              width: `${column.width}px`,\n              border: index === 0 ? 'none' : undefined,\n            });\n            return html` <affine-database-header-column\n              style=\"${style}\"\n              data-column-id=\"${column.id}\"\n              data-column-index=\"${index}\"\n              class=\"affine-database-column database-cell\"\n              .column=\"${column}\"\n              .tableViewManager=\"${this.tableViewManager}\"\n            ></affine-database-header-column>`;\n          }\n        )}\n        <div\n          style=\"background-color: var(--affine-border-color);width: 1px;\"\n        ></div>\n        <div style=\"height: 0;\" ${ref(this.addColumnPositionRef)}></div>\n        <div class=\"scale-div\" style=\"width: 1px;height: 1px;\"></div>\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-database-column-header': DatabaseColumnHeader;\n  }\n}\nconst headerShift = (container: HTMLElement): Middleware => {\n  return {\n    name: 'headerShift',\n    fn({ x, y, elements }) {\n      const referenceRect = elements.reference.getBoundingClientRect();\n      const floatingRect = elements.floating.getBoundingClientRect();\n      const rootRect = container.getBoundingClientRect();\n      let moveX = 0;\n      if (rootRect.top > referenceRect.top) {\n        moveX =\n          Math.min(referenceRect.bottom - floatingRect.height, rootRect.top) -\n          referenceRect.top;\n      }\n      return {\n        x,\n        y,\n        data: {\n          x: moveX,\n        },\n      };\n    },\n  };\n};\n"]}