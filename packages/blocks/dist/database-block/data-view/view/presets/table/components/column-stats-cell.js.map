{"version":3,"file":"column-stats-cell.js","sourceRoot":"","sources":["../../../../../../../src/database-block/data-view/view/presets/table/components/column-stats-cell.ts"],"names":[],"mappings":"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","sourcesContent":["import { WithDisposable } from '@blocksuite/block-std';\nimport { css, html, LitElement } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport { ArrowDownIcon } from '../../../../../../_common/icons/index.js';\nimport { getRootByElement } from '../../../../../../_common/utils/index.js';\nimport type { GroupData } from '../../../../common/group-by/helper.js';\nimport {\n  type ColumnDataType,\n  getStatCalcOperationFromType,\n  type StatCalcOp,\n  type StatOpResult,\n} from '../stat-ops.js';\nimport type { DataViewTableColumnManager } from '../table-view-manager.js';\nimport { DEFAULT_COLUMN_MIN_WIDTH } from './../consts.js';\nimport { popColStatOperationMenu } from './menu.js';\n\nconst styles = css`\n  .stats-cell {\n    cursor: pointer;\n    transition: opacity 230ms ease;\n    padding: 8px 0px;\n    font-size: 12px;\n    color: var(--affine-text-secondary-color);\n    display: flex;\n    opacity: 0;\n    min-width: ${DEFAULT_COLUMN_MIN_WIDTH}px;\n    justify-content: flex-end;\n  }\n  .stats-cell:hover {\n    background-color: var(--affine-hover-color);\n    cursor: pointer;\n    opacity: 1;\n  }\n  .stats-cell[calculated='true'] {\n    opacity: 1;\n  }\n  .stats-cell .content {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.2rem;\n    margin-inline: 5px;\n  }\n  .label {\n    text-transform: uppercase;\n  }\n  .value {\n    color: var(--affine-text-primary-color);\n  }\n`;\n\n@customElement('affine-database-column-stats-cell')\nexport class DatabaseColumnStatsCell extends WithDisposable(LitElement) {\n  static override styles = styles;\n\n  @state()\n  private accessor operation: StatCalcOp | null = null;\n\n  @state()\n  private accessor result: StatOpResult | null = null;\n\n  @property({ attribute: false })\n  accessor column!: DataViewTableColumnManager;\n\n  @property({ attribute: false })\n  accessor group: GroupData | undefined = undefined;\n\n  private getResultString() {\n    if (!this.result || !isFinite(this.result.value)) return '';\n    const { displayFormat: df, value } = this.result;\n\n    switch (df) {\n      case '%':\n        return `${(value * 100).toFixed(3)}%`;\n      case 'x10':\n        return `${value}`;\n    }\n  }\n\n  protected override render() {\n    const style = {\n      width: `${this.column.width}px`,\n    };\n    return html`<div\n      calculated=\"${!!this.operation && this.operation.type !== 'none'}\"\n      style=\"${styleMap(style)}\"\n      class=\"stats-cell\"\n    >\n      <div class=\"content\">\n        ${!this.operation || this.operation.type === 'none'\n          ? html`Calculate ${ArrowDownIcon}`\n          : html`\n              <span class=\"label\">${this.operation.display}</span>\n              <span class=\"value\">${this.getResultString()} </span>\n            `}\n      </div>\n    </div>`;\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    this.operation = getStatCalcOperationFromType(this.column.statCalcOp);\n    this.calculate();\n\n    this.disposables.addFromEvent(this, 'click', this.openMenu);\n\n    const view = this.column.dataViewManager;\n    this.disposables.add(\n      view.slots.update.on(() => {\n        this.calculate();\n      })\n    );\n\n    view.rows.forEach(rowId => {\n      this._disposables.add(\n        this.column.onCellUpdate(rowId, () => {\n          this.calculate();\n        })\n      );\n    });\n  }\n\n  openMenu = (ev: MouseEvent) => {\n    const rootElement = getRootByElement(this);\n    popColStatOperationMenu(\n      rootElement,\n      ev.target as HTMLElement,\n      this.column,\n      this.getColumnType(),\n      this.onSelect\n    );\n  };\n\n  onSelect = (operation: StatCalcOp) => {\n    if (operation.type === 'none') {\n      this.operation = null;\n      this.result = null;\n      return;\n    }\n    this.column.updateStatCalcOp(operation.type);\n    this.operation = operation;\n    this.calculate();\n  };\n\n  calculate() {\n    if (!this.operation) return;\n    this.result = this.operation.calculate(this.column, this.group);\n  }\n\n  getColumnType(): ColumnDataType {\n    const type = this.column.type;\n    if (type === 'number' || type === 'checkbox') return type;\n    return 'other';\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-database-column-stats-cell': DatabaseColumnStatsCell;\n  }\n}\n"]}