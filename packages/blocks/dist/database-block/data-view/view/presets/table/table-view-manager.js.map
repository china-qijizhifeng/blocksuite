{"version":3,"file":"table-view-manager.js","sourceRoot":"","sources":["../../../../../../src/database-block/data-view/view/presets/table/table-view-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import type { FilterGroup } from '../../../common/ast.js';\nimport { ColumnDataStats } from '../../../common/data-stats.js';\nimport {\n  GroupHelper,\n  sortByManually,\n} from '../../../common/group-by/helper.js';\nimport { groupByMatcher } from '../../../common/group-by/matcher.js';\nimport { defaultGroupBy } from '../../../common/view-manager.js';\nimport { evalFilter } from '../../../logical/eval-filter.js';\nimport type { TType } from '../../../logical/typesystem.js';\nimport type { InsertToPosition } from '../../../types.js';\nimport { insertPositionToIndex } from '../../../utils/insert.js';\nimport type { _DataViewDataTypeMap } from '../../data-view.js';\nimport {\n  DataViewColumnManagerBase,\n  DataViewManagerBase,\n} from '../../data-view-manager.js';\nimport type { StatCalcOpType } from './types.js';\n\ntype TableViewData = _DataViewDataTypeMap['table'];\n\nexport class DataViewTableManager extends DataViewManagerBase<TableViewData> {\n  override get type(): string {\n    return this.view.mode;\n  }\n\n  get view() {\n    return this.viewSource.view;\n  }\n\n  get filter(): FilterGroup {\n    return this.view.filter;\n  }\n\n  get id() {\n    return this.view.id;\n  }\n\n  get name(): string {\n    return this.view.name;\n  }\n\n  get columns(): string[] {\n    return this.columnsWithoutFilter.filter(id => !this.columnGetHide(id));\n  }\n\n  get detailColumns(): string[] {\n    return this.columnsWithoutFilter.filter(\n      id => this.columnGetType(id) !== 'title'\n    );\n  }\n\n  get columnsWithoutFilter(): string[] {\n    const needShow = new Set(this.dataSource.properties);\n    const result: string[] = [];\n    this.view.columns.forEach(v => {\n      if (needShow.has(v.id)) {\n        result.push(v.id);\n        needShow.delete(v.id);\n      }\n    });\n    result.push(...needShow);\n    return result;\n  }\n\n  override get readonly(): boolean {\n    return this.viewSource.readonly;\n  }\n\n  get isDeleted(): boolean {\n    return this.viewSource.isDeleted();\n  }\n\n  get header() {\n    return (\n      this.view.header ?? {\n        titleColumn: this.columnsWithoutFilter.find(\n          id => this.columnGetType(id) === 'title'\n        ),\n        iconColumn: 'type',\n      }\n    );\n  }\n\n  get groupProperties() {\n    return this.view.groupProperties ?? [];\n  }\n\n  get groupHelper(): GroupHelper | undefined {\n    const groupBy = this.view.groupBy;\n    if (!groupBy) {\n      return;\n    }\n    const result = groupByMatcher.find(v => v.data.name === groupBy.name);\n    if (!result) {\n      return;\n    }\n    const groupByConfig = result.data;\n    const type = this.columnGetDataType(groupBy.columnId);\n    if (!this.checkGroup(groupBy.columnId, result.type, type)) {\n      // reset groupBy config\n      return this.groupHelper;\n    }\n    return new GroupHelper(groupBy, groupByConfig, type, this, {\n      sortGroup: ids =>\n        sortByManually(\n          ids,\n          v => v,\n          this.groupProperties.map(v => v.key)\n        ),\n      sortRow: (key, ids) => {\n        const property = this.groupProperties.find(v => v.key === key);\n        return sortByManually(ids, v => v, property?.manuallyCardSort ?? []);\n      },\n      changeGroupSort: keys => {\n        const map = new Map(this.groupProperties.map(v => [v.key, v]));\n        this.updateView(() => {\n          return {\n            groupProperties: keys.map(key => {\n              const property = map.get(key);\n              if (property) {\n                return property;\n              }\n              return {\n                key,\n                hide: false,\n                manuallyCardSort: [],\n              };\n            }),\n          };\n        });\n      },\n      changeRowSort: (groupKeys, groupKey, keys) => {\n        const map = new Map(this.groupProperties.map(v => [v.key, v]));\n        this.updateView(() => {\n          return {\n            groupProperties: groupKeys.map(key => {\n              if (key === groupKey) {\n                const group = map.get(key);\n                return group\n                  ? {\n                      ...group,\n                      manuallyCardSort: keys,\n                    }\n                  : {\n                      key,\n                      hide: false,\n                      manuallyCardSort: keys,\n                    };\n              } else {\n                return (\n                  map.get(key) ?? {\n                    key,\n                    hide: false,\n                    manuallyCardSort: [],\n                  }\n                );\n              }\n            }),\n          };\n        });\n      },\n    });\n  }\n\n  private updateView(updater: (view: TableViewData) => Partial<TableViewData>) {\n    this.syncView();\n    this.viewSource.updateView(updater);\n  }\n\n  private syncView() {\n    if (this.view.columns.length === this.columns.length) {\n      return;\n    }\n    this.viewSource.updateView(_view => {\n      return {\n        columns: this.columnsWithoutFilter.map(id => {\n          const column = this.columnGet(id);\n          return {\n            id: column.id,\n            hide: column.hide,\n            width: column.width,\n            statCalcType: column.statCalcOp,\n          };\n        }),\n      };\n    });\n  }\n\n  updateFilter(filter: FilterGroup): void {\n    this.updateView(() => {\n      return {\n        filter,\n      };\n    });\n  }\n\n  updateName(name: string): void {\n    this.updateView(() => {\n      return {\n        name,\n      };\n    });\n  }\n\n  override rowMove(\n    rowId: string,\n    position: InsertToPosition,\n    fromGroup?: string,\n    toGroup?: string\n  ) {\n    if (toGroup == null) {\n      super.rowMove(rowId, position);\n      return;\n    }\n    this.groupHelper?.moveCardTo(rowId, fromGroup, toGroup, position);\n  }\n\n  columnGet(columnId: string): DataViewTableColumnManager {\n    return new DataViewTableColumnManager(columnId, this);\n  }\n\n  columnGetWidth(columnId: string): number {\n    return (\n      this.view.columns.find(v => v.id === columnId)?.width ??\n      this.dataSource.propertyGetDefaultWidth(columnId)\n    );\n  }\n\n  columnMove(columnId: string, toAfterOfColumn: InsertToPosition): void {\n    this.updateView(view => {\n      const columnIndex = view.columns.findIndex(v => v.id === columnId);\n      if (columnIndex < 0) {\n        return {};\n      }\n      const columns = [...view.columns];\n      const [column] = columns.splice(columnIndex, 1);\n      const index = insertPositionToIndex(toAfterOfColumn, columns);\n      columns.splice(index, 0, column);\n      return {\n        columns,\n      };\n    });\n  }\n\n  columnUpdateWidth(columnId: string, width: number): void {\n    this.updateView(view => {\n      return {\n        columns: view.columns.map(v =>\n          v.id === columnId\n            ? {\n                ...v,\n                width: width,\n              }\n            : v\n        ),\n      };\n    });\n  }\n\n  override rowAdd(\n    insertPosition: InsertToPosition | number,\n    groupKey?: string\n  ): string {\n    const id = super.rowAdd(insertPosition);\n    if (!groupKey) {\n      return id;\n    }\n    this.groupHelper?.addToGroup(id, groupKey);\n    return id;\n  }\n\n  isShow(rowId: string): boolean {\n    if (this.filter.conditions.length) {\n      const rowMap = Object.fromEntries(\n        this.columnManagerList.map(column => [\n          column.id,\n          column.getJsonValue(rowId),\n        ])\n      );\n      return evalFilter(this.filter, rowMap);\n    }\n    return true;\n  }\n\n  columnUpdateHide(columnId: string, hide: boolean): void {\n    this.updateView(view => {\n      return {\n        columns: view.columns.map(v =>\n          v.id === columnId\n            ? {\n                ...v,\n                hide,\n              }\n            : v\n        ),\n      };\n    });\n  }\n\n  columnGetHide(columnId: string): boolean {\n    return this.view.columns.find(v => v.id === columnId)?.hide ?? false;\n  }\n\n  duplicateView(): void {\n    this.viewSource.duplicate();\n  }\n\n  deleteView(): void {\n    this.viewSource.delete();\n  }\n\n  isInHeader(columnId: string) {\n    return Object.values(this.header).some(v => v === columnId);\n  }\n\n  hasHeader(rowId: string): boolean {\n    return Object.values(this.header).some(id => this.cellGetValue(rowId, id));\n  }\n\n  changeGroup(columnId: string | undefined) {\n    if (columnId == null) {\n      this.updateView(() => {\n        return {\n          groupBy: undefined,\n        };\n      });\n      return;\n    }\n    const column = this.columnGet(columnId);\n    this.updateView(_view => {\n      return {\n        groupBy: defaultGroupBy(\n          this.columnGetMeta(column.type),\n          column.id,\n          column.data\n        ),\n      };\n    });\n  }\n\n  checkGroup(columnId: string, type: TType, target: TType): boolean {\n    if (!groupByMatcher.isMatched(type, target)) {\n      this.changeGroup(columnId);\n      return false;\n    }\n    return true;\n  }\n\n  columnGetStatCalcOp(columnId: string): StatCalcOpType {\n    return (\n      this.view.columns.find(v => v.id === columnId)?.statCalcType ?? 'none'\n    );\n  }\n\n  columnUpdateStatCalcOp(columnId: string, op: StatCalcOpType): void {\n    this.updateView(view => {\n      return {\n        columns: view.columns.map(v =>\n          v.id === columnId\n            ? {\n                ...v,\n                statCalcType: op,\n              }\n            : v\n        ),\n      };\n    });\n  }\n}\n\nexport class DataViewTableColumnManager extends DataViewColumnManagerBase {\n  get statCalcOp(): StatCalcOpType {\n    return this.dataViewManager.columnGetStatCalcOp(this.id);\n  }\n\n  get width(): number {\n    return this.dataViewManager.columnGetWidth(this.id);\n  }\n\n  readonly stats = new ColumnDataStats(this);\n\n  constructor(\n    propertyId: string,\n    override dataViewManager: DataViewTableManager\n  ) {\n    super(propertyId, dataViewManager);\n  }\n\n  updateStatCalcOp(type: StatCalcOpType): void {\n    return this.dataViewManager.columnUpdateStatCalcOp(this.id, type);\n  }\n\n  updateWidth(width: number): void {\n    this.dataViewManager.columnUpdateWidth(this.id, width);\n  }\n}\n"]}