{"version":3,"file":"table-view.js","sourceRoot":"","sources":["../../../../../../src/database-block/data-view/view/presets/table/table-view.ts"],"names":[],"mappings":"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","sourcesContent":["// related component\nimport './components/column-header/column-header.js';\nimport './components/cell-container.js';\nimport './components/row.js';\nimport './group.js';\n\nimport { css } from 'lit';\nimport { customElement } from 'lit/decorators.js';\nimport { html } from 'lit/static-html.js';\n\nimport { popMenu } from '../../../../../_common/components/index.js';\nimport { AddCursorIcon } from '../../../../../_common/icons/index.js';\nimport type { GroupHelper } from '../../../common/group-by/helper.js';\nimport type { InsertToPosition } from '../../../types.js';\nimport { insertPositionToIndex } from '../../../utils/insert.js';\nimport { renderUniLit } from '../../../utils/uni-component/index.js';\nimport { DataViewBase } from '../../data-view-base.js';\nimport { LEFT_TOOL_BAR_WIDTH } from './consts.js';\nimport { TableClipboardController } from './controller/clipboard.js';\nimport { TableDragController } from './controller/drag.js';\nimport { TableHotkeysController } from './controller/hotkeys.js';\nimport { TableSelectionController } from './controller/selection.js';\nimport type { DataViewTableManager } from './table-view-manager.js';\nimport type { TableViewSelection } from './types.js';\n\nconst styles = css`\n  affine-database-table {\n    position: relative;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n  }\n\n  affine-database-table * {\n    box-sizing: border-box;\n  }\n  .affine-database-table {\n    overflow-y: auto;\n  }\n\n  .affine-database-block-title-container {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    height: 44px;\n    margin: 2px 0 2px;\n  }\n\n  .affine-database-block-table {\n    position: relative;\n    width: 100%;\n    padding-bottom: 4px;\n    z-index: 1;\n    overflow-x: scroll;\n    overflow-y: hidden;\n  }\n\n  .affine-database-block-table:hover {\n    padding-bottom: 0px;\n  }\n\n  .affine-database-block-table::-webkit-scrollbar {\n    -webkit-appearance: none;\n    display: block;\n  }\n\n  .affine-database-block-table::-webkit-scrollbar:horizontal {\n    height: 4px;\n  }\n\n  .affine-database-block-table::-webkit-scrollbar-thumb {\n    border-radius: 2px;\n    background-color: transparent;\n  }\n\n  .affine-database-block-table:hover::-webkit-scrollbar:horizontal {\n    height: 8px;\n  }\n\n  .affine-database-block-table:hover::-webkit-scrollbar-thumb {\n    border-radius: 16px;\n    background-color: var(--affine-black-30);\n  }\n\n  .affine-database-block-table:hover::-webkit-scrollbar-track {\n    background-color: var(--affine-hover-color);\n  }\n\n  .affine-database-table-container {\n    position: relative;\n    width: fit-content;\n    min-width: 100%;\n  }\n\n  .affine-database-block-tag-circle {\n    width: 12px;\n    height: 12px;\n    border-radius: 50%;\n    display: inline-block;\n  }\n\n  .affine-database-block-tag {\n    display: inline-flex;\n    border-radius: 11px;\n    align-items: center;\n    padding: 0 8px;\n    cursor: pointer;\n  }\n\n  .database-cell {\n    border-left: 1px solid var(--affine-border-color);\n  }\n  .data-view-table-left-bar {\n    display: flex;\n    align-items: center;\n    position: sticky;\n    left: 0;\n    width: ${LEFT_TOOL_BAR_WIDTH}px;\n    flex-shrink: 0;\n    background-color: var(--affine-background-primary-color);\n  }\n  .affine-database-block-rows {\n    display: flex;\n    flex-direction: column;\n    justify-content: center;\n    align-items: flex-start;\n  }\n`;\n\n@customElement('affine-database-table')\nexport class DataViewTable extends DataViewBase<\n  DataViewTableManager,\n  TableViewSelection\n> {\n  private get readonly() {\n    return this.view.readonly;\n  }\n\n  static override styles = styles;\n\n  dragController = new TableDragController(this);\n\n  selectionController = new TableSelectionController(this);\n\n  hotkeysController = new TableHotkeysController(this);\n\n  clipboardController = new TableClipboardController(this);\n\n  private _addRow = (\n    tableViewManager: DataViewTableManager,\n    position: InsertToPosition | number\n  ) => {\n    if (this.readonly) return;\n\n    const index =\n      typeof position === 'number'\n        ? position\n        : insertPositionToIndex(\n            position,\n            this.view.rows.map(id => ({ id }))\n          );\n    tableViewManager.rowAdd(position);\n    requestAnimationFrame(() => {\n      this.selectionController.selection = {\n        focus: {\n          rowIndex: index,\n          columnIndex: 0,\n        },\n        isEditing: true,\n      };\n    });\n  };\n\n  private renderTable() {\n    const groupHelper = this.view.groupHelper;\n    if (groupHelper) {\n      return html`\n        <div style=\"display:flex;flex-direction: column;gap: 16px;\">\n          ${groupHelper.groups.map(group => {\n            return html`<affine-data-view-table-group\n              data-group-key=\"${group.key}\"\n              .dataViewEle=\"${this.dataViewEle}\"\n              .view=\"${this.view}\"\n              .viewEle=\"${this}\"\n              .group=\"${group}\"\n            ></affine-data-view-table-group>`;\n          })}\n          ${this.renderAddGroup(groupHelper)}\n        </div>\n      `;\n    }\n    return html`<affine-data-view-table-group\n      .dataViewEle=\"${this.dataViewEle}\"\n      .view=\"${this.view}\"\n      .viewEle=\"${this}\"\n    ></affine-data-view-table-group>`;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this._disposables.add(\n      this.view.slots.update.on(() => {\n        this.requestUpdate();\n        this.querySelectorAll('affine-data-view-table-group').forEach(v => {\n          v.requestUpdate();\n        });\n      })\n    );\n\n    if (this.readonly) return;\n  }\n\n  override addRow(position: InsertToPosition) {\n    this._addRow(this.view, position);\n  }\n\n  renderAddGroup = (groupHelper: GroupHelper) => {\n    const addGroup = groupHelper.addGroup;\n    if (!addGroup) {\n      return;\n    }\n    const add = (e: MouseEvent) => {\n      const ele = e.currentTarget as HTMLElement;\n      popMenu(ele, {\n        options: {\n          input: {\n            onComplete: text => {\n              const column = groupHelper.column;\n              if (column) {\n                column.updateData(() => addGroup(text, column.data) as never);\n              }\n            },\n          },\n          items: [],\n        },\n      });\n    };\n    return html` <div style=\"display:flex;\">\n      <div\n        class=\"dv-hover dv-round-8\"\n        style=\"display:flex;align-items:center;gap: 10px;padding: 6px 12px 6px 8px;color: var(--affine-text-secondary-color);font-size: 12px;line-height: 20px;position: sticky;left: ${LEFT_TOOL_BAR_WIDTH}px;\"\n        @click=\"${add}\"\n      >\n        <div class=\"dv-icon-16\" style=\"display:flex;\">${AddCursorIcon}</div>\n        <div>New Group</div>\n      </div>\n    </div>`;\n  };\n\n  onWheel = (event: WheelEvent) => {\n    if (event.metaKey || event.ctrlKey) {\n      return;\n    }\n    const ele = event.currentTarget;\n    if (ele instanceof HTMLElement) {\n      if (ele.scrollWidth === ele.clientWidth) {\n        return;\n      }\n      event.stopPropagation();\n    }\n  };\n\n  hideIndicator(): void {\n    this.dragController.dropPreview.remove();\n  }\n\n  moveTo(id: string, evt: MouseEvent): void {\n    const result = this.dragController.getInsertPosition(evt);\n    if (result) {\n      this.view.rowMove(id, result.position, undefined, result.groupKey);\n    }\n  }\n\n  showIndicator(evt: MouseEvent): boolean {\n    return this.dragController.showIndicator(evt) != null;\n  }\n\n  override render() {\n    return html`\n      ${renderUniLit(this.headerWidget, {\n        view: this.view,\n        viewMethods: this,\n        viewSource: this.viewSource,\n        dataSource: this.dataSource,\n      })}\n      <div class=\"affine-database-table\">\n        <div class=\"affine-database-block-table\" @wheel=\"${this.onWheel}\">\n          <div class=\"affine-database-table-container\">\n            ${this.renderTable()}\n          </div>\n        </div>\n      </div>\n    `;\n  }\n\n  focusFirstCell(): void {\n    this.selectionController.focusFirstCell();\n  }\n\n  getSelection = () => {\n    return this.selectionController.selection;\n  };\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-database-table': DataViewTable;\n  }\n}\n"]}