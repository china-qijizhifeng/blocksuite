{"version":3,"file":"setting.js","sourceRoot":"","sources":["../../../../../src/database-block/data-view/common/group-by/setting.ts"],"names":[],"mappings":"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","sourcesContent":["import { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport type { PropertyValues } from 'lit';\nimport { css, html, unsafeCSS } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport Sortable from 'sortablejs';\n\nimport {\n  type Menu,\n  type MenuOptions,\n  popMenu,\n} from '../../../../_common/components/index.js';\nimport { ArrowRightSmallIcon } from '../../../../_common/icons/index.js';\nimport { menuTitleItem } from '../../utils/menu-title.js';\nimport { renderUniLit } from '../../utils/uni-component/uni-component.js';\nimport { DataViewKanbanManager } from '../../view/presets/kanban/kanban-view-manager.js';\nimport { DataViewTableManager } from '../../view/presets/table/table-view-manager.js';\nimport { dataViewCssVariable } from '../css-variable.js';\nimport { DeleteIcon } from '../icons/index.js';\nimport type { GroupRenderProps } from './matcher.js';\nimport { groupByMatcher } from './matcher.js';\n\n@customElement('data-view-group-setting')\nexport class GroupSetting extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    data-view-group-setting {\n      display: flex;\n      flex-direction: column;\n      gap: 4px;\n      ${unsafeCSS(dataViewCssVariable())};\n    }\n    .group-item {\n      display: flex;\n      padding: 4px 12px;\n      position: relative;\n      cursor: grab;\n    }\n\n    .group-item-drag-bar {\n      width: 4px;\n      height: 12px;\n      border-radius: 1px;\n      background-color: #efeff0;\n      position: absolute;\n      left: 4px;\n      top: 0;\n      bottom: 0;\n      margin: auto;\n    }\n\n    .group-item:hover .group-item-drag-bar {\n      background-color: #c0bfc1;\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor view!: DataViewTableManager | DataViewKanbanManager;\n\n  @query('.group-sort-setting')\n  accessor groupContainer!: HTMLElement;\n\n  protected override firstUpdated(_changedProperties: PropertyValues) {\n    super.firstUpdated(_changedProperties);\n    const sortable = new Sortable(this.groupContainer, {\n      animation: 150,\n      group: `group-sort-${this.view.id}`,\n      onEnd: evt => {\n        const groupHelper = this.view.groupHelper;\n        if (!groupHelper) {\n          return;\n        }\n        const groups = [...groupHelper.groups];\n        const index = evt.oldIndex ?? -1;\n        const from = groups[index];\n        groups.splice(index, 1);\n        const to = groups[evt.newIndex ?? -1];\n        groupHelper.moveGroupTo(\n          from.key,\n          to\n            ? {\n                before: true,\n                id: to.key,\n              }\n            : 'end'\n        );\n      },\n    });\n    this._disposables.add({\n      dispose: () => sortable.destroy(),\n    });\n  }\n\n  protected override render(): unknown {\n    const helper = this.view.groupHelper;\n    if (!helper) {\n      return;\n    }\n    return html`\n      <div style=\"padding: 7px 12px;\">\n        <div\n          style=\"padding: 0 4px; font-size: 12px;color: var(--affine-text-secondary-color);line-height: 20px;\"\n        >\n          Groups\n        </div>\n        <div></div>\n      </div>\n      <div\n        style=\"display:flex;flex-direction: column;gap: 4px;\"\n        class=\"group-sort-setting\"\n      >\n        ${repeat(\n          helper.groups,\n          group => group.key,\n          group => {\n            const props: GroupRenderProps = {\n              value: group.value,\n              data: group.helper.data,\n              readonly: true,\n            };\n            const config = group.helper.groupConfig();\n            return html` <div class=\"dv-hover dv-round-4 group-item\">\n              <div class=\"group-item-drag-bar\"></div>\n              <div style=\"padding: 0 4px;position:relative;\">\n                ${renderUniLit(config?.view, props)}\n                <div\n                  style=\"position:absolute;left: 0;top: 0;right: 0;bottom: 0;\"\n                ></div>\n              </div>\n            </div>`;\n          }\n        )}\n      </div>\n    `;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this._disposables.add(\n      this.view.slots.update.on(() => {\n        this.requestUpdate();\n      })\n    );\n    this._disposables.addFromEvent(this, 'pointerdown', e => {\n      e.stopPropagation();\n    });\n  }\n}\nexport const selectGroupByProperty = (\n  view: DataViewTableManager | DataViewKanbanManager,\n  onClose?: () => void\n): MenuOptions => {\n  return {\n    onClose,\n    input: {\n      search: true,\n      placeholder: 'Search',\n    },\n    items: [\n      ...view.columnsWithoutFilter\n        .filter(id => {\n          if (view.columnGet(id).type === 'title') {\n            return false;\n          }\n          return !!groupByMatcher.match(view.columnGet(id).dataType);\n        })\n        .map<Menu>(id => {\n          const column = view.columnGet(id);\n          return {\n            type: 'action',\n            name: column.name,\n            isSelected: view.view.groupBy?.columnId === id,\n            icon: html` <uni-lit .uni=\"${column.icon}\"></uni-lit>`,\n            select: () => {\n              view.changeGroup(id);\n            },\n          };\n        }),\n      {\n        type: 'group',\n        name: '',\n        hide: () =>\n          view instanceof DataViewKanbanManager || view.view.groupBy == null,\n        children: () => [\n          {\n            type: 'action',\n            icon: DeleteIcon,\n            class: 'delete-item',\n            name: 'Remove Grouping',\n            select: () => {\n              if (view instanceof DataViewTableManager) {\n                view.changeGroup(undefined);\n              }\n            },\n          },\n        ],\n      },\n    ],\n  };\n};\nexport const popSelectGroupByProperty = (\n  target: HTMLElement,\n  view: DataViewTableManager | DataViewKanbanManager,\n  onClose?: () => void\n) => {\n  popMenu(target, {\n    options: selectGroupByProperty(view, onClose),\n  });\n};\nexport const popGroupSetting = (\n  target: HTMLElement,\n  view: DataViewTableManager | DataViewKanbanManager,\n  onBack: () => void\n) => {\n  const groupBy = view.view.groupBy;\n  if (groupBy == null) {\n    return;\n  }\n  const reopen = () => {\n    popGroupSetting(target, view, onBack);\n  };\n  const type = view.columnGetType(groupBy.columnId);\n  const icon = view.getIcon(type);\n  const menuHandler = popMenu(target, {\n    options: {\n      input: {\n        search: true,\n      },\n      items: [\n        menuTitleItem('GROUP', () => {\n          onBack();\n          menuHandler.close();\n        }),\n        {\n          type: 'group',\n          name: '',\n          children: () => [\n            {\n              type: 'sub-menu',\n              name: 'Group By',\n              postfix: html`\n                <div\n                  style=\"display:flex;align-items:center;gap: 4px;font-size: 12px;line-height: 20px;color: var(--affine-text-secondary-color);margin-right: 4px;margin-left: 8px;\"\n                  class=\"dv-icon-16\"\n                >\n                  ${renderUniLit(icon, {})}\n                  ${view.columnGetName(groupBy.columnId)}\n                </div>\n                ${ArrowRightSmallIcon}\n              `,\n              options: selectGroupByProperty(view, reopen),\n            },\n          ],\n        },\n        {\n          type: 'group',\n          name: '',\n          children: () => [\n            {\n              type: 'custom',\n              render: html` <data-view-group-setting\n                .view=\"${view}\"\n                .columnId=\"${groupBy.columnId}\"\n              ></data-view-group-setting>`,\n            },\n          ],\n        },\n      ],\n    },\n  });\n};\n"]}