{"version":3,"file":"database-model.js","sourceRoot":"","sources":["../../src/database-block/database-model.ts"],"names":[],"mappings":"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","sourcesContent":["import type { MigrationRunner, Text } from '@blocksuite/store';\nimport { BlockModel, defineBlockSchema, nanoid } from '@blocksuite/store';\n\nimport type { InsertToPosition } from './data-view/types.js';\nimport { arrayMove, insertPositionToIndex } from './data-view/utils/insert.js';\nimport type { DataViewDataType } from './data-view/view/data-view.js';\nimport type { Cell, Column, ColumnUpdater } from './types.js';\n\nexport type DatabaseBlockProps = {\n  views: DataViewDataType[];\n  title: Text;\n  cells: SerializedCells;\n  columns: Array<Column>;\n  // rowId -> pageId\n  notes?: Record<string, string>;\n};\n\nexport type SerializedCells = Record<string, Record<string, Cell>>;\n\nexport class DatabaseBlockModel extends BlockModel<DatabaseBlockProps> {\n  getViewList() {\n    return this.views;\n  }\n\n  duplicateView(id: string): string {\n    const newId = this.doc.generateBlockId();\n    this.doc.transact(() => {\n      const index = this.views.findIndex(v => v.id === id);\n      const view = this.views[index];\n      if (view) {\n        this.views.splice(\n          index + 1,\n          0,\n          JSON.parse(JSON.stringify({ ...view, id: newId }))\n        );\n      }\n    });\n    return newId;\n  }\n\n  deleteView(id: string) {\n    this.doc.captureSync();\n    this.doc.transact(() => {\n      this.views = this.views.filter(v => v.id !== id);\n    });\n  }\n\n  updateView(\n    id: string,\n    update: (data: DataViewDataType) => Partial<DataViewDataType>\n  ) {\n    this.doc.transact(() => {\n      this.views = this.views.map(v => {\n        if (v.id !== id) {\n          return v;\n        }\n        return { ...v, ...update(v) } as DataViewDataType;\n      });\n    });\n    this.applyViewsUpdate();\n  }\n\n  moveViewTo(id: string, position: InsertToPosition) {\n    this.doc.transact(() => {\n      this.views = arrayMove(\n        this.views,\n        v => v.id === id,\n        arr => insertPositionToIndex(position, arr)\n      );\n    });\n    this.applyViewsUpdate();\n  }\n\n  applyViewsUpdate() {\n    this.doc.updateBlock(this, {\n      views: this.views,\n    });\n  }\n\n  applyColumnUpdate() {\n    this.doc.updateBlock(this, {\n      columns: this.columns,\n    });\n  }\n\n  findColumnIndex(id: Column['id']) {\n    return this.columns.findIndex(v => v.id === id);\n  }\n\n  getColumn(id: Column['id']): Column | undefined {\n    return this.columns.find(v => v.id === id);\n  }\n\n  addColumn(\n    position: InsertToPosition,\n    column: Omit<Column, 'id'> & {\n      id?: string;\n    }\n  ): string {\n    const id = column.id ?? this.doc.generateBlockId();\n    if (this.columns.some(v => v.id === id)) {\n      return id;\n    }\n    this.doc.transact(() => {\n      const col: Column = {\n        ...column,\n        id,\n      };\n      this.columns.splice(\n        insertPositionToIndex(position, this.columns),\n        0,\n        col\n      );\n    });\n    return id;\n  }\n\n  updateColumn(id: string, updater: ColumnUpdater) {\n    const index = this.columns.findIndex(v => v.id === id);\n    if (index == null) {\n      return;\n    }\n    this.doc.transact(() => {\n      const column = this.columns[index];\n      this.columns[index] = { ...column, ...updater(column) };\n    });\n    return id;\n  }\n\n  deleteColumn(columnId: Column['id']) {\n    const index = this.findColumnIndex(columnId);\n    if (index < 0) return;\n\n    this.doc.transact(() => {\n      this.columns.splice(index, 1);\n    });\n  }\n\n  getCell(rowId: BlockModel['id'], columnId: Column['id']): Cell | null {\n    if (columnId === 'title') {\n      return {\n        columnId: 'title',\n        value: rowId,\n      };\n    }\n    const yRow = this.cells[rowId];\n    const yCell = yRow?.[columnId] ?? null;\n    if (!yCell) return null;\n\n    return {\n      columnId: yCell.columnId,\n      value: yCell.value,\n    };\n  }\n\n  updateCell(rowId: string, cell: Cell) {\n    const hasRow = rowId in this.cells;\n    if (!hasRow) {\n      this.cells[rowId] = Object.create(null);\n    }\n    this.doc.transact(() => {\n      this.cells[rowId][cell.columnId] = {\n        columnId: cell.columnId,\n        value: cell.value,\n      };\n    });\n  }\n\n  deleteRows(rowIds: string[]) {\n    this.doc.transact(() => {\n      for (const rowId of rowIds) {\n        delete this.cells[rowId];\n      }\n    });\n  }\n\n  copyCellsByColumn(fromId: Column['id'], toId: Column['id']) {\n    this.doc.transact(() => {\n      Object.keys(this.cells).forEach(rowId => {\n        const cell = this.cells[rowId][fromId];\n        if (cell) {\n          this.cells[rowId][toId] = {\n            ...cell,\n            columnId: toId,\n          };\n        }\n      });\n    });\n  }\n\n  updateCells(columnId: string, cells: Record<string, unknown>) {\n    this.doc.transact(() => {\n      Object.entries(cells).forEach(([rowId, value]) => {\n        this.cells[rowId][columnId] = {\n          columnId,\n          value,\n        };\n      });\n    });\n  }\n}\n\nconst migration = {\n  toV3: data => {\n    const id = nanoid();\n    // @ts-expect-error\n    const title = data['titleColumnName'];\n    // @ts-expect-error\n    const width = data['titleColumnWidth'];\n    // @ts-expect-error\n    delete data['titleColumnName'];\n    // @ts-expect-error\n    delete data['titleColumnWidth'];\n    data.columns.unshift({\n      id,\n      type: 'title',\n      name: title,\n      data: {},\n    });\n    data.views.forEach(view => {\n      if (view.mode === 'table') {\n        view.columns.unshift({\n          id,\n          width,\n          statCalcType: 'none',\n        });\n      }\n    });\n  },\n} satisfies Record<string, MigrationRunner<typeof DatabaseBlockSchema>>;\n\nexport const DatabaseBlockSchema = defineBlockSchema({\n  flavour: 'affine:database',\n  props: (internal): DatabaseBlockProps => ({\n    views: [],\n    title: internal.Text(),\n    cells: Object.create(null),\n    columns: [],\n  }),\n  metadata: {\n    role: 'hub',\n    version: 3,\n    parent: ['affine:note'],\n    children: ['affine:paragraph', 'affine:list'],\n  },\n  toModel: () => new DatabaseBlockModel(),\n  onUpgrade: (data, previousVersion, latestVersion) => {\n    if (previousVersion < 3 && latestVersion >= 3) {\n      migration.toV3(data);\n    }\n  },\n});\n"]}