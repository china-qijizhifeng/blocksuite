{"version":3,"file":"utils.js","sourceRoot":"","sources":["../../src/database-block/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import { nanoid } from '@blocksuite/store';\n\nimport { databaseBlockAllColumnMap } from './columns/index.js';\nimport { titlePureColumnConfig } from './columns/title/define.js';\nimport { multiSelectColumnModelConfig } from './data-view/column/presets/multi-select/define.js';\nimport { numberColumnModelConfig } from './data-view/column/presets/number/define.js';\nimport { selectColumnModelConfig } from './data-view/column/presets/select/define.js';\nimport { textColumnModelConfig } from './data-view/column/presets/text/define.js';\nimport { groupByMatcher } from './data-view/common/group-by/matcher.js';\nimport { defaultGroupBy } from './data-view/common/view-manager.js';\nimport type {\n  ColumnMeta,\n  DataViewDataType,\n  ViewMeta,\n} from './data-view/index.js';\nimport { columnPresets } from './data-view/index.js';\nimport { getTagColor } from './data-view/utils/tags/colors.js';\nimport type { DataViewTypes } from './data-view/view/data-view.js';\nimport type { Column } from './data-view/view/presets/table/types.js';\nimport type { DatabaseBlockModel } from './database-model.js';\n\nconst initMap: Record<\n  DataViewTypes,\n  (\n    columnMetaMap: Record<string, ColumnMeta>,\n    model: DatabaseBlockModel,\n    id: string,\n    name: string\n  ) => DataViewDataType\n> = {\n  table(_columnMetaMap, model, id, name) {\n    return {\n      id,\n      name,\n      mode: 'table',\n      columns: [],\n      filter: {\n        type: 'group',\n        op: 'and',\n        conditions: [],\n      },\n      header: {\n        titleColumn: model.columns.find(v => v.type === 'title')?.id,\n        iconColumn: 'type',\n      },\n    };\n  },\n  kanban(columnMetaMap, model, id, name) {\n    const allowList = model.columns.filter(column => {\n      const type = columnMetaMap[column.type].model.dataType(column.data);\n      return !!groupByMatcher.match(type) && column.type !== 'title';\n    });\n    const getWeight = (column: Column) => {\n      if (\n        [\n          selectColumnModelConfig.type as string,\n          multiSelectColumnModelConfig.type,\n        ].includes(column.type)\n      ) {\n        return 3;\n      }\n      if (\n        [\n          numberColumnModelConfig.type as string,\n          textColumnModelConfig.type,\n        ].includes(column.type)\n      ) {\n        return 2;\n      }\n      return 1;\n    };\n    const column = allowList.sort((a, b) => getWeight(b) - getWeight(a))[0];\n    if (!column) {\n      throw new Error('not implement yet');\n    }\n    return {\n      id,\n      name,\n      mode: 'kanban',\n      columns: model.columns.map(v => ({\n        id: v.id,\n        hide: false,\n      })),\n      filter: {\n        type: 'group',\n        op: 'and',\n        conditions: [],\n      },\n      groupBy: defaultGroupBy(\n        columnMetaMap[column.type],\n        column.id,\n        column.data\n      ),\n      header: {\n        titleColumn: model.columns.find(v => v.type === 'title')?.id,\n        iconColumn: 'type',\n      },\n      groupProperties: [],\n    };\n  },\n};\nexport const databaseViewInitEmpty = (\n  model: DatabaseBlockModel,\n  viewMeta: ViewMeta\n) => {\n  model.addColumn(\n    'start',\n    titlePureColumnConfig.create(titlePureColumnConfig.model.name)\n  );\n  databaseViewAddView(model, viewMeta);\n};\n\nexport const databaseViewInitConvert = (\n  model: DatabaseBlockModel,\n  viewMeta: ViewMeta\n) => {\n  model.addColumn(\n    'end',\n    columnPresets.multiSelectColumnConfig.model.create('Tag', { options: [] })\n  );\n  databaseViewInitEmpty(model, viewMeta);\n};\n\nexport const databaseViewInitTemplate = (\n  model: DatabaseBlockModel,\n  viewMeta: ViewMeta\n) => {\n  const ids = [nanoid(), nanoid(), nanoid()];\n  const statusId = model.addColumn(\n    'end',\n    columnPresets.selectColumnConfig.model.create('Status', {\n      options: [\n        {\n          id: ids[0],\n          color: getTagColor(),\n          value: 'TODO',\n        },\n        {\n          id: ids[1],\n          color: getTagColor(),\n          value: 'In Progress',\n        },\n        {\n          id: ids[2],\n          color: getTagColor(),\n          value: 'Done',\n        },\n      ],\n    })\n  );\n  for (let i = 0; i < 4; i++) {\n    const rowId = model.doc.addBlock(\n      'affine:paragraph',\n      {\n        text: new model.doc.Text(`Task ${i + 1}`),\n      },\n      model.id\n    );\n    model.updateCell(rowId, {\n      columnId: statusId,\n      value: ids[i],\n    });\n  }\n  databaseViewInitEmpty(model, viewMeta);\n};\n\nexport const databaseViewAddView = (\n  model: DatabaseBlockModel,\n  viewMeta: ViewMeta\n) => {\n  const id = model.doc.generateBlockId();\n  const view = initMap[viewMeta.type](\n    databaseBlockAllColumnMap,\n    model,\n    id,\n    viewMeta.model.defaultName\n  );\n  model.doc.transact(() => {\n    model.views.push(view);\n  });\n  return view;\n};\n"]}