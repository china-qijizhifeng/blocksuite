{"version":3,"file":"list-block.js","sourceRoot":"","sources":["../../src/list-block/list-block.ts"],"names":[],"mappings":"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","sourcesContent":["/// <reference types=\"vite/client\" />\nimport '../_common/components/rich-text/rich-text.js';\n\nimport type { BlockElement } from '@blocksuite/block-std';\nimport { getInlineRangeProvider } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { InlineRangeProvider } from '@blocksuite/inline';\nimport { html, nothing, type TemplateResult } from 'lit';\nimport { customElement, query, state } from 'lit/decorators.js';\n\nimport { BlockComponent } from '../_common/components/block-component.js';\nimport { bindContainerHotkey } from '../_common/components/rich-text/keymap/index.js';\nimport type { RichText } from '../_common/components/rich-text/rich-text.js';\nimport { BLOCK_CHILDREN_CONTAINER_PADDING_LEFT } from '../_common/consts.js';\nimport { getViewportElement } from '../_common/utils/query.js';\nimport { EdgelessRootBlockComponent } from '../root-block/edgeless/edgeless-root-block.js';\nimport type { ListBlockModel } from './list-model.js';\nimport type { ListBlockService } from './list-service.js';\nimport { listBlockStyles } from './styles.js';\nimport { ListIcon } from './utils/get-list-icon.js';\nimport { playCheckAnimation, toggleDown, toggleRight } from './utils/icons.js';\n\n@customElement('affine-list')\nexport class ListBlockComponent extends BlockComponent<\n  ListBlockModel,\n  ListBlockService\n> {\n  get inlineManager() {\n    const inlineManager = this.service?.inlineManager;\n    assertExists(inlineManager);\n    return inlineManager;\n  }\n\n  get attributesSchema() {\n    return this.inlineManager.getSchema();\n  }\n\n  get attributeRenderer() {\n    return this.inlineManager.getRenderer();\n  }\n\n  get markdownShortcutHandler() {\n    return this.inlineManager.markdownShortcutHandler;\n  }\n\n  get embedChecker() {\n    return this.inlineManager.embedChecker;\n  }\n\n  override get topContenteditableElement() {\n    if (this.rootElement instanceof EdgelessRootBlockComponent) {\n      const el = this.closest<BlockElement>(\n        'affine-note, affine-edgeless-text'\n      );\n      return el;\n    }\n    return this.rootElement;\n  }\n\n  static override styles = listBlockStyles;\n\n  @state()\n  private accessor _isCollapsedWhenReadOnly = !!this.model?.collapsed;\n\n  @query('rich-text')\n  private accessor _richTextElement: RichText | null = null;\n\n  private _inlineRangeProvider: InlineRangeProvider | null = null;\n\n  override accessor blockContainerStyles = {\n    margin: '10px 0',\n  };\n\n  private _select() {\n    const selection = this.host.selection;\n    selection.update(selList => {\n      return selList\n        .filter(sel => !sel.is('text') && !sel.is('block'))\n        .concat(selection.create('block', { blockId: this.blockId }));\n    });\n  }\n\n  private _onClickIcon = (e: MouseEvent) => {\n    e.stopPropagation();\n\n    if (this.model.type === 'toggle') {\n      this._toggleChildren();\n      return;\n    } else if (this.model.type === 'todo') {\n      this.doc.captureSync();\n      const checkedPropObj = { checked: !this.model.checked };\n      this.doc.updateBlock(this.model, checkedPropObj);\n      if (this.model.checked) {\n        const checkEl = this.querySelector('.affine-list-block__todo-prefix');\n        assertExists(checkEl);\n        playCheckAnimation(checkEl).catch(console.error);\n      }\n      return;\n    }\n    this._select();\n  };\n\n  private _updateFollowingListSiblings() {\n    this.updateComplete\n      .then(() => {\n        let current: BlockElement | null = this as BlockElement;\n        while (current?.tagName == 'AFFINE-LIST') {\n          current.requestUpdate();\n          const next = this.std.doc.getNext(current.model);\n          const id = next?.id;\n          current = id ? this.std.view.getBlock(id) : null;\n        }\n      })\n      .catch(console.error);\n  }\n\n  private _toggleChildren() {\n    if (this.doc.readonly) {\n      this._isCollapsedWhenReadOnly = !this._isCollapsedWhenReadOnly;\n      return;\n    }\n    const newCollapsedState = !this.model.collapsed;\n    this._isCollapsedWhenReadOnly = newCollapsedState;\n    this.doc.captureSync();\n    this.doc.updateBlock(this.model, {\n      collapsed: newCollapsedState,\n    } as Partial<ListBlockModel>);\n  }\n\n  private _toggleTemplate(isCollapsed: boolean) {\n    const noChildren = this.model.children.length === 0;\n    if (noChildren) return nothing;\n\n    const toggleDownTemplate = html`<div\n      contenteditable=\"false\"\n      class=\"toggle-icon\"\n      @click=${this._toggleChildren}\n    >\n      ${toggleDown}\n    </div>`;\n\n    const toggleRightTemplate = html`<div\n      contenteditable=\"false\"\n      class=\"toggle-icon toggle-icon__collapsed\"\n      @click=${this._toggleChildren}\n    >\n      ${toggleRight}\n    </div>`;\n\n    return isCollapsed ? toggleRightTemplate : toggleDownTemplate;\n  }\n\n  override async getUpdateComplete() {\n    const result = await super.getUpdateComplete();\n    await this._richTextElement?.updateComplete;\n    return result;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    bindContainerHotkey(this);\n\n    this._inlineRangeProvider = getInlineRangeProvider(this);\n\n    this._updateFollowingListSiblings();\n    this.disposables.add(\n      this.model.childrenUpdated.on(() => {\n        this._updateFollowingListSiblings();\n      })\n    );\n    this.disposables.add(\n      this.host.std.doc.slots.blockUpdated.on(e => {\n        if (e.type !== 'delete') return;\n        const deletedBlock = this.std.view.getBlock(e.id);\n        if (!deletedBlock) return;\n        if (this !== deletedBlock.nextElementSibling) return;\n        this._updateFollowingListSiblings();\n        return;\n      })\n    );\n  }\n\n  override renderBlock(): TemplateResult<1> {\n    const { model, _onClickIcon } = this;\n    const collapsed = this.doc.readonly\n      ? this._isCollapsedWhenReadOnly\n      : !!model.collapsed;\n    const listIcon = ListIcon(model, !collapsed, _onClickIcon);\n\n    const checked =\n      this.model.type === 'todo' && this.model.checked\n        ? 'affine-list--checked'\n        : '';\n\n    const children = html`<div\n      class=\"affine-block-children-container\"\n      style=\"padding-left: ${BLOCK_CHILDREN_CONTAINER_PADDING_LEFT}px\"\n    >\n      ${this.renderChildren(this.model)}\n    </div>`;\n\n    return html`\n      <div class=${'affine-list-block-container'}>\n        <div class=${`affine-list-rich-text-wrapper ${checked}`}>\n          ${this._toggleTemplate(collapsed)} ${listIcon}\n          <rich-text\n            .yText=${this.model.text.yText}\n            .inlineEventSource=${this.topContenteditableElement ?? nothing}\n            .undoManager=${this.doc.history}\n            .attributeRenderer=${this.attributeRenderer}\n            .attributesSchema=${this.attributesSchema}\n            .markdownShortcutHandler=${this.markdownShortcutHandler}\n            .embedChecker=${this.embedChecker}\n            .readonly=${this.doc.readonly}\n            .inlineRangeProvider=${this._inlineRangeProvider}\n            .enableClipboard=${false}\n            .enableUndoRedo=${false}\n            .verticalScrollContainerGetter=${() =>\n              getViewportElement(this.host)}\n          ></rich-text>\n        </div>\n\n        ${collapsed ? nothing : children}\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-list': ListBlockComponent;\n  }\n}\n"]}