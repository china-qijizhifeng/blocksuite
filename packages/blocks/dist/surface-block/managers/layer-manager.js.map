{"version":3,"file":"layer-manager.js","sourceRoot":"","sources":["../../../src/surface-block/managers/layer-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { assertType, DisposableGroup, Slot } from '@blocksuite/global/utils';\nimport type { Doc } from '@blocksuite/store';\nimport type { BlockModel } from '@blocksuite/store';\nimport { generateKeyBetween } from 'fractional-indexing';\n\nimport { last, nToLast } from '../../_common/utils/iterable.js';\nimport { matchFlavours } from '../../_common/utils/model.js';\nimport type { FrameBlockModel } from '../../frame-block/frame-model.js';\nimport { EdgelessBlockModel } from '../../root-block/edgeless/edgeless-block-model.js';\nimport { Bound } from '../../surface-block/utils/bound.js';\nimport {\n  SurfaceElementModel,\n  SurfaceGroupLikeModel,\n} from '../element-model/base.js';\nimport type { GroupElementModel } from '../element-model/group.js';\nimport { GridManager } from '../grid.js';\nimport type { SurfaceBlockModel } from '../surface-model.js';\nimport {\n  compare,\n  getElementIndex,\n  getLayerEndZIndex,\n  insertToOrderedArray,\n  isInRange,\n  removeFromOrderedArray,\n  renderableInEdgeless,\n  ungroupIndex,\n  updateLayersZIndex,\n} from './layer-utils.js';\n\nexport type ReorderingDirection = 'front' | 'forward' | 'backward' | 'back';\n\ntype BaseLayer<T> = {\n  set: Set<T>;\n\n  elements: Array<T>;\n\n  /**\n   * fractional indexing range\n   */\n  indexes: [string, string];\n};\n\nexport type BlockLayer = BaseLayer<EdgelessBlockModel> & {\n  type: 'block';\n\n  /**\n   * The z-index of the first block in this layer.\n   *\n   * A block layer may contains multiple blocks,\n   * the block should be rendered with this `zIndex` + \"its index in the layer\" as the z-index property.\n   */\n  zIndex: number;\n};\n\nexport type CanvasLayer = BaseLayer<SurfaceElementModel> & {\n  type: 'canvas';\n\n  /**\n   * The z-index of canvas layer.\n   *\n   * A canvas layer renders all the elements in a single canvas,\n   *  this property is used to render the canvas with correct z-index.\n   */\n  zIndex: number;\n};\n\nexport type Layer = BlockLayer | CanvasLayer;\n\nexport class LayerManager {\n  static INITAL_INDEX = 'a0';\n\n  private _disposables = new DisposableGroup();\n\n  slots = {\n    layerUpdated: new Slot<{\n      type: 'delete' | 'add' | 'update';\n      initiatingElement: BlockSuite.EdgelessModelType;\n    }>(),\n  };\n\n  canvasElements!: SurfaceElementModel[];\n\n  blocks!: EdgelessBlockModel[];\n\n  frames!: FrameBlockModel[];\n\n  layers!: Layer[];\n\n  canvasLayers!: {\n    set: Set<SurfaceElementModel>;\n    /**\n     * fractional index\n     */\n    indexes: [string, string];\n    /**\n     * z-index, used for actual rendering\n     */\n    zIndex: number;\n    elements: Array<SurfaceElementModel>;\n  }[];\n\n  blocksGrid = new GridManager<EdgelessBlockModel>();\n\n  framesGrid = new GridManager<FrameBlockModel>();\n\n  canvasGrid = new GridManager<SurfaceElementModel>();\n\n  constructor(elements?: BlockSuite.EdgelessModelType[]) {\n    if (elements) {\n      this._init(elements);\n    }\n  }\n\n  private listen(doc: Doc, surface: SurfaceBlockModel) {\n    this._disposables.add(\n      doc.slots.blockUpdated.on(payload => {\n        if (payload.type === 'add') {\n          const block = doc.getBlockById(payload.id)!;\n\n          if (\n            block instanceof EdgelessBlockModel &&\n            renderableInEdgeless(doc, surface, block) &&\n            this.blocks.indexOf(block) === -1\n          ) {\n            this.add(block as EdgelessBlockModel);\n          }\n        }\n        if (payload.type === 'update') {\n          const block = doc.getBlockById(payload.id)!;\n\n          if (\n            payload.props.key === 'index' ||\n            (payload.props.key === 'xywh' &&\n              block instanceof EdgelessBlockModel &&\n              renderableInEdgeless(doc, surface, block))\n          ) {\n            this.update(block as EdgelessBlockModel, {\n              [payload.props.key]: true,\n            });\n          }\n        }\n        if (payload.type === 'delete') {\n          const block = doc.getBlockById(payload.id);\n\n          if (block instanceof EdgelessBlockModel) {\n            this.delete(block as EdgelessBlockModel);\n          }\n        }\n      })\n    );\n\n    this._disposables.add(\n      surface.elementAdded.on(payload =>\n        this.add(surface.getElementById(payload.id)!)\n      )\n    );\n    this._disposables.add(\n      surface.elementUpdated.on(payload => {\n        if (\n          payload.props['index'] ||\n          payload.props['xywh'] ||\n          payload.props['externalXYWH'] ||\n          payload.props['childIds']\n        ) {\n          this.update(surface.getElementById(payload.id)!, payload.props);\n        }\n      })\n    );\n    this._disposables.add(\n      surface.elementRemoved.on(payload => this.delete(payload.model!))\n    );\n  }\n\n  private _init(elements: BlockSuite.EdgelessModelType[]) {\n    this.canvasElements = [];\n    this.blocks = [];\n    this.frames = [];\n\n    elements.forEach(element => {\n      if (element instanceof SurfaceElementModel) {\n        this.canvasElements.push(element);\n        this.canvasGrid.add(element);\n      } else if (matchFlavours(element, ['affine:frame'])) {\n        this.framesGrid.add(element);\n        this.frames.push(element);\n      } else {\n        this.blocksGrid.add(element);\n        this.blocks.push(element);\n      }\n    });\n\n    this.canvasElements.sort(compare);\n    this.frames.sort(compare);\n    this.blocks.sort(compare);\n\n    this._initLayers();\n    this._buildCanvasLayers();\n  }\n\n  private _initLayers() {\n    let blockIdx = 0;\n    let canvasIdx = 0;\n    const layers: LayerManager['layers'] = [];\n    let curLayer: LayerManager['layers'][number] | undefined;\n    let currentCSSZindex = 1;\n\n    const pushCurLayer = () => {\n      if (curLayer) {\n        curLayer.indexes = [\n          getElementIndex(curLayer.elements[0]),\n          getElementIndex(last(curLayer.elements)!),\n        ];\n        curLayer.zIndex = currentCSSZindex;\n        layers.push(curLayer as LayerManager['layers'][number]);\n\n        currentCSSZindex +=\n          curLayer.type === 'block' ? curLayer.elements.length : 1;\n      }\n    };\n    const addLayer = (type: 'canvas' | 'block') => {\n      pushCurLayer();\n      curLayer =\n        type === 'canvas'\n          ? ({\n              type,\n              indexes: [LayerManager.INITAL_INDEX, LayerManager.INITAL_INDEX],\n              zIndex: 0,\n              set: new Set(),\n              elements: [],\n              bound: new Bound(),\n            } as CanvasLayer)\n          : ({\n              type,\n              indexes: [LayerManager.INITAL_INDEX, LayerManager.INITAL_INDEX],\n              zIndex: 0,\n              set: new Set(),\n              elements: [],\n            } as BlockLayer);\n    };\n\n    while (\n      blockIdx < this.blocks.length ||\n      canvasIdx < this.canvasElements.length\n    ) {\n      const curBlock = this.blocks[blockIdx];\n      const curCanvas = this.canvasElements[canvasIdx];\n\n      if (!curBlock && !curCanvas) {\n        break;\n      }\n\n      if (!curBlock) {\n        if (curLayer?.type !== 'canvas') {\n          addLayer('canvas');\n        }\n        assertType<CanvasLayer>(curLayer);\n\n        const remains = this.canvasElements.slice(canvasIdx);\n\n        curLayer!.elements = curLayer.elements.concat(remains);\n        remains.forEach(element => (curLayer as CanvasLayer).set.add(element));\n\n        break;\n      }\n\n      if (!curCanvas) {\n        if (curLayer?.type !== 'block') {\n          addLayer('block');\n        }\n\n        assertType<BlockLayer>(curLayer);\n\n        const remains = this.blocks.slice(blockIdx);\n\n        curLayer.elements = curLayer.elements.concat(remains);\n        remains.forEach(block => (curLayer as BlockLayer).set.add(block));\n\n        break;\n      }\n\n      const order = compare(curBlock, curCanvas);\n\n      switch (order) {\n        case -1:\n          if (curLayer?.type !== 'block') {\n            addLayer('block');\n          }\n\n          assertType<BlockLayer>(curLayer);\n\n          curLayer!.set.add(curBlock);\n          curLayer!.elements.push(curBlock);\n\n          ++blockIdx;\n\n          break;\n        case 1:\n          if (curLayer?.type !== 'canvas') {\n            addLayer('canvas');\n          }\n\n          assertType<CanvasLayer>(curLayer);\n\n          curLayer!.set.add(curCanvas);\n          curLayer!.elements.push(curCanvas);\n\n          ++canvasIdx;\n\n          break;\n        case 0:\n          if (!curLayer) {\n            addLayer('block');\n          }\n\n          if (curLayer!.type === 'block') {\n            curLayer!.set.add(curBlock);\n            curLayer!.elements.push(curBlock);\n\n            ++blockIdx;\n          } else {\n            curLayer!.set.add(curCanvas);\n            curLayer!.elements.push(curCanvas);\n\n            ++canvasIdx;\n          }\n          break;\n      }\n    }\n\n    if (curLayer && curLayer.elements.length) {\n      pushCurLayer();\n    }\n\n    this.layers = layers;\n  }\n\n  private _insertIntoLayer(\n    target: BlockSuite.EdgelessModelType,\n    type: 'block' | 'canvas'\n  ) {\n    if (this.layers.length === 0) {\n      this._initLayers();\n      return;\n    }\n\n    const layers = this.layers;\n    let cur = layers.length - 1;\n\n    const addToLayer = (\n      layer: Layer,\n      element: BlockSuite.EdgelessModelType,\n      position: number | 'tail'\n    ) => {\n      assertType<CanvasLayer>(layer);\n      assertType<SurfaceElementModel>(element);\n\n      if (position === 'tail') {\n        layer.elements.push(element);\n      } else {\n        layer.elements.splice(position, 0, element);\n      }\n\n      layer.set.add(element);\n\n      if (\n        position === 'tail' ||\n        position === 0 ||\n        position === layer.elements.length - 1\n      ) {\n        layer.indexes = [\n          getElementIndex(layer.elements[0]),\n          getElementIndex(last(layer.elements)!),\n        ];\n      }\n    };\n    const createLayer = (\n      type: 'block' | 'canvas',\n      targets: BlockSuite.EdgelessModelType[],\n      curZIndex: number\n    ): Layer => {\n      const newLayer = {\n        type,\n        set: new Set(targets),\n        indexes: [\n          getElementIndex(targets[0]),\n          getElementIndex(last(targets)!),\n        ] as [string, string],\n        zIndex: curZIndex + 1,\n        elements: targets,\n      } as BlockLayer;\n\n      return newLayer as Layer;\n    };\n\n    if (compare(target, last(last(this.layers)!.elements)!) > 0) {\n      const layer = last(this.layers);\n\n      if (layer?.type === type) {\n        addToLayer(layer, target, 'tail');\n        updateLayersZIndex(layers, cur);\n      } else {\n        this.layers.push(\n          createLayer(\n            type,\n            [target],\n            getLayerEndZIndex(layers, layers.length - 1)\n          )\n        );\n      }\n    } else {\n      while (cur > -1) {\n        const layer = layers[cur];\n        const layerElements = layer.elements;\n\n        if (isInRange([layerElements[0], last(layerElements)!], target)) {\n          const insertIdx = layerElements.findIndex((_, idx) => {\n            const pre = layerElements[idx - 1];\n            return (\n              compare(target, layerElements[idx]) < 0 &&\n              (!pre || compare(target, pre) >= 0)\n            );\n          });\n\n          if (layer.type === type) {\n            addToLayer(layer, target, insertIdx);\n            updateLayersZIndex(layers, cur);\n          } else {\n            const splicedElements = layer.elements.splice(insertIdx);\n            layer.set = new Set(layer.elements as SurfaceElementModel[]);\n\n            layers.splice(\n              cur + 1,\n              0,\n              createLayer(layer.type, splicedElements, 1)\n            );\n            layers.splice(cur + 1, 0, createLayer(type, [target], 1));\n            updateLayersZIndex(layers, cur);\n          }\n          break;\n        } else {\n          const nextLayer = layers[cur - 1];\n\n          if (!nextLayer || compare(target, last(nextLayer.elements)!) >= 0) {\n            if (layer.type === type) {\n              addToLayer(layer, target, 0);\n              updateLayersZIndex(layers, cur);\n            } else {\n              if (nextLayer) {\n                addToLayer(nextLayer, target, 'tail');\n                updateLayersZIndex(layers, cur - 1);\n              } else {\n                layers.unshift(createLayer(type, [target], 1));\n                updateLayersZIndex(layers, 0);\n              }\n            }\n\n            break;\n          }\n        }\n\n        --cur;\n      }\n    }\n  }\n\n  private _removeFromLayer(\n    target: BlockSuite.EdgelessModelType,\n    type: 'block' | 'canvas'\n  ) {\n    const layers = this.layers;\n    const index = layers.findIndex(layer => {\n      if (layer.type !== type) return false;\n\n      assertType<CanvasLayer>(layer);\n      assertType<SurfaceElementModel>(target);\n\n      if (layer.set.has(target)) {\n        layer.set.delete(target);\n        const idx = layer.elements.indexOf(target);\n        if (idx !== -1) {\n          layer.elements.splice(layer.elements.indexOf(target), 1);\n\n          if (layer.elements.length) {\n            layer.indexes = [\n              getElementIndex(layer.elements[0]),\n              getElementIndex(last(layer.elements)!),\n            ];\n          }\n        }\n\n        return true;\n      }\n\n      return false;\n    });\n\n    if (index === -1) return;\n\n    const isDeletedAtEdge = index === 0 || index === layers.length - 1;\n\n    if (layers[index].set.size === 0) {\n      if (isDeletedAtEdge) {\n        layers.splice(index, 1);\n\n        if (layers[index]) {\n          updateLayersZIndex(layers, index);\n        }\n      } else {\n        const lastLayer = layers[index - 1] as CanvasLayer;\n        const nextLayer = layers[index + 1] as CanvasLayer;\n\n        lastLayer.elements = lastLayer.elements.concat(nextLayer.elements);\n        lastLayer.set = new Set(lastLayer.elements);\n\n        layers.splice(index, 2);\n        updateLayersZIndex(layers, index - 1);\n      }\n      return;\n    }\n\n    updateLayersZIndex(layers, index);\n  }\n\n  private _buildCanvasLayers() {\n    const canvasLayers = this.layers\n      .filter<CanvasLayer>(\n        (layer): layer is CanvasLayer => layer.type === 'canvas'\n      )\n      .map(layer => {\n        return {\n          set: layer.set,\n          elements: layer.elements,\n          zIndex: layer.zIndex,\n          indexes: layer.indexes,\n        };\n      }) as LayerManager['canvasLayers'];\n\n    if (!canvasLayers.length || last(this.layers)?.type !== 'canvas') {\n      canvasLayers.push({\n        set: new Set(),\n        elements: [],\n        zIndex: 0,\n        indexes: [LayerManager.INITAL_INDEX, LayerManager.INITAL_INDEX],\n      });\n    }\n\n    this.canvasLayers = canvasLayers;\n  }\n\n  /**\n   * @returns a boolean value to indicate whether the layers have been updated\n   */\n  private _updateLayer(\n    element: BlockSuite.EdgelessModelType,\n    props?: Record<string, unknown>\n  ) {\n    let updateType: 'block' | 'canvas' | undefined = undefined;\n    const type = 'flavour' in element ? element.flavour : element.type;\n\n    const indexChanged = !props || 'index' in props;\n    const childIdsChanged = props && 'childIds' in props;\n    const updateArray = (\n      array: BlockSuite.EdgelessModelType[],\n      element: BlockSuite.EdgelessModelType\n    ) => {\n      if (!indexChanged) return;\n      removeFromOrderedArray(array, element);\n      insertToOrderedArray(array, element);\n    };\n\n    if (!type.startsWith('affine:')) {\n      updateType = 'canvas';\n      updateArray(this.canvasElements, element);\n      this.canvasGrid.update(element as SurfaceElementModel);\n\n      if (\n        (type === 'group' || element instanceof SurfaceGroupLikeModel) &&\n        (indexChanged || childIdsChanged)\n      ) {\n        (element as GroupElementModel).childElements.forEach(\n          child => child && this._updateLayer(child)\n        );\n      }\n    } else if (matchFlavours(element as BlockModel, ['affine:frame'])) {\n      updateArray(this.frames, element);\n      this.framesGrid.update(element as FrameBlockModel);\n    } else {\n      updateType = 'block';\n      updateArray(this.blocks, element);\n      this.blocksGrid.update(element as EdgelessBlockModel);\n    }\n\n    if (updateType && (indexChanged || childIdsChanged)) {\n      this._removeFromLayer(\n        element as BlockSuite.EdgelessModelType,\n        updateType\n      );\n      this._insertIntoLayer(\n        element as BlockSuite.EdgelessModelType,\n        updateType\n      );\n\n      return true;\n    }\n\n    return false;\n  }\n\n  add(element: BlockSuite.EdgelessModelType) {\n    let insertType: 'block' | 'canvas' | undefined = undefined;\n    const type = 'flavour' in element ? element.flavour : element.type;\n\n    if (!type.startsWith('affine:')) {\n      insertType = 'canvas';\n      insertToOrderedArray(this.canvasElements, element);\n      this.canvasGrid.add(element as SurfaceElementModel);\n\n      if (type === 'group' || element instanceof SurfaceGroupLikeModel) {\n        (element as GroupElementModel).childElements.forEach(\n          child => child && this._updateLayer(child)\n        );\n      }\n    } else if (matchFlavours(element as BlockModel, ['affine:frame'])) {\n      insertToOrderedArray(this.frames, element);\n      this.framesGrid.add(element as FrameBlockModel);\n    } else {\n      insertType = 'block';\n      insertToOrderedArray(this.blocks, element);\n      this.blocksGrid.add(element as EdgelessBlockModel);\n    }\n\n    if (insertType) {\n      this._insertIntoLayer(\n        element as BlockSuite.EdgelessModelType,\n        insertType\n      );\n      this._buildCanvasLayers();\n      this.slots.layerUpdated.emit({\n        type: 'add',\n        initiatingElement: element,\n      });\n    }\n  }\n\n  delete(element: BlockSuite.EdgelessModelType) {\n    let deleteType: 'canvas' | 'block' | undefined = undefined;\n\n    if (element instanceof SurfaceElementModel) {\n      deleteType = 'canvas';\n      removeFromOrderedArray(this.canvasElements, element);\n      this.canvasGrid.remove(element);\n    } else if (matchFlavours(element, ['affine:frame'])) {\n      removeFromOrderedArray(this.frames, element);\n      this.framesGrid.remove(element as FrameBlockModel);\n    } else {\n      deleteType = 'block';\n      removeFromOrderedArray(this.blocks, element);\n      this.blocksGrid.remove(element);\n    }\n\n    if (deleteType) {\n      this._removeFromLayer(element, deleteType);\n      this._buildCanvasLayers();\n      this.slots.layerUpdated.emit({\n        type: 'delete',\n        initiatingElement: element,\n      });\n    }\n  }\n\n  update(\n    element: BlockSuite.EdgelessModelType,\n    props?: Record<string, unknown>\n  ) {\n    if (this._updateLayer(element, props)) {\n      this._buildCanvasLayers();\n      this.slots.layerUpdated.emit({\n        type: 'update',\n        initiatingElement: element,\n      });\n    }\n  }\n\n  getCanvasLayers() {\n    return this.canvasLayers;\n  }\n\n  generateIndex(elementType: string): string {\n    const batch = elementType === 'affine:frame' ? 'frame' : 'common';\n    const type = elementType.startsWith('affine:') ? 'block' : 'canvas';\n\n    if (batch === 'frame') {\n      const lastFrame = last(this.frames);\n\n      return lastFrame\n        ? generateKeyBetween(ungroupIndex(getElementIndex(lastFrame)), null)\n        : LayerManager.INITAL_INDEX;\n    } else {\n      if (type === 'canvas') {\n        const lastIndex = last(this.layers)?.indexes[1];\n\n        return lastIndex\n          ? generateKeyBetween(ungroupIndex(lastIndex), null)\n          : LayerManager.INITAL_INDEX;\n      }\n\n      const lastLayer = last(this.layers);\n\n      if (!lastLayer) return LayerManager.INITAL_INDEX;\n\n      assertType<string>(lastLayer);\n\n      if (lastLayer.type === 'canvas') {\n        const secondLastLayer = nToLast(this.layers, 2);\n        const secondLastLayerIndex = secondLastLayer\n          ? ungroupIndex(secondLastLayer.indexes[1])\n          : null;\n\n        return generateKeyBetween(\n          secondLastLayerIndex,\n          secondLastLayerIndex && secondLastLayerIndex >= lastLayer.indexes[0]\n            ? null\n            : lastLayer.indexes[0]\n        );\n      }\n\n      return generateKeyBetween(lastLayer.indexes[1], null);\n    }\n  }\n\n  /**\n   * In some cases, we need to generate a bunch of indexes in advance before acutally adding the elements to the layer manager.\n   * Eg. when importing a template. The `generateIndex` is a function only depends on the current state of the manager.\n   * So we cannot use it because it will always return the same index if the element is not added to manager.\n   *\n   * This function return a index generator that can \"remember\" the index it generated without actually adding the element to the manager.\n   *\n   * @note The generator cannot work with `group` element.\n   *\n   * @param ignoreRule If true, the generator will not distinguish between `block` and `canvas` elements.\n   * @returns\n   */\n  createIndexGenerator(ignoreRule: boolean = false) {\n    const manager = new LayerManager();\n\n    manager.frames = [...this.frames];\n    manager.blocks = [...this.blocks];\n    manager.canvasElements = [...this.canvasElements];\n    // @ts-ignore\n    manager.layers = this.layers.map(layer => {\n      return {\n        ...layer,\n        // @ts-ignore\n        set: new Set(layer.set),\n        elements: [...layer.elements],\n      };\n    });\n    manager._buildCanvasLayers();\n\n    return (elementType: string) => {\n      if (ignoreRule && elementType !== 'affine:frame') {\n        elementType = 'shape';\n      }\n\n      const idx = manager.generateIndex(elementType);\n      const bound = new Bound(0, 0, 10, 10);\n\n      if (elementType === 'group') elementType = 'shape';\n\n      const mockedFakeElement = {\n        index: idx,\n        flavour: elementType,\n        x: 0,\n        y: 0,\n        w: 10,\n        h: 10,\n        elementBound: bound,\n        xywh: '[0, 0, 10, 10]',\n        group: () => null,\n        groups: () => [],\n      };\n\n      manager.add(mockedFakeElement as unknown as BlockSuite.EdgelessModelType);\n\n      return idx;\n    };\n  }\n\n  getReorderedIndex(\n    element: BlockSuite.EdgelessModelType,\n    direction: ReorderingDirection\n  ): string {\n    const group = element.group;\n    const isFrameBlock =\n      (element as FrameBlockModel).flavour === 'affine:frame';\n\n    let elements: BlockSuite.EdgelessModelType[];\n\n    if (group !== null) {\n      elements = group.childElements.filter(\n        element =>\n          ((element as FrameBlockModel)?.flavour === 'affine:frame') ===\n          isFrameBlock\n      );\n\n      elements.sort(compare);\n    } else if (isFrameBlock) {\n      elements = this.frames;\n    } else {\n      elements = this.layers.reduce(\n        (pre: BlockSuite.EdgelessModelType[], current) =>\n          pre.concat(current.elements.filter(element => element.group == null)),\n        []\n      );\n    }\n\n    const currentIdx = elements.indexOf(element);\n\n    switch (direction) {\n      case 'forward':\n      case 'front':\n        if (currentIdx === -1 || currentIdx === elements.length - 1)\n          return element.index;\n\n        {\n          const next =\n            direction === 'forward'\n              ? elements[currentIdx + 1]\n              : elements[elements.length - 1];\n          const next2 =\n            direction === 'forward' ? elements[currentIdx + 2] : null;\n\n          return generateKeyBetween(\n            next.index,\n            next2?.index\n              ? next.index < next2.index\n                ? next2.index\n                : null\n              : null\n          );\n        }\n      case 'backward':\n      case 'back':\n        if (currentIdx === -1 || currentIdx === 0) return element.index;\n\n        {\n          const pre =\n            direction === 'backward' ? elements[currentIdx - 1] : elements[0];\n          const pre2 =\n            direction === 'backward' ? elements[currentIdx - 2] : null;\n\n          return generateKeyBetween(pre2?.index ?? null, pre.index);\n        }\n    }\n  }\n\n  /**\n   * Pass to the `Array.sort` to  sort the elements by their index\n   */\n  compare(a: BlockSuite.EdgelessModelType, b: BlockSuite.EdgelessModelType) {\n    return compare(a, b);\n  }\n\n  dispose() {\n    this.slots.layerUpdated.dispose();\n    this._disposables.dispose();\n  }\n\n  static create(doc: Doc, surface: SurfaceBlockModel) {\n    const layerManager = new LayerManager(\n      (\n        doc\n          .getBlocks()\n          .filter(\n            model =>\n              model instanceof EdgelessBlockModel &&\n              renderableInEdgeless(doc, surface, model)\n          ) as BlockSuite.EdgelessModelType[]\n      ).concat(surface.elementModels)\n    );\n\n    layerManager.listen(doc, surface);\n\n    return layerManager;\n  }\n}\n"]}