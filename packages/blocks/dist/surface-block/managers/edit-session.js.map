{"version":3,"file":"edit-session.js","sourceRoot":"","sources":["../../../src/surface-block/managers/edit-session.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockService } from '@blocksuite/block-std';\nimport { DisposableGroup, Slot } from '@blocksuite/global/utils';\nimport { isPlainObject, recursive } from 'merge';\nimport { z } from 'zod';\n\nimport {\n  DEFAULT_NOTE_BACKGROUND_COLOR,\n  DEFAULT_NOTE_SHADOW,\n  NoteBackgroundColorsSchema,\n  NoteShadowsSchema,\n} from '../../_common/edgeless/note/consts.js';\nimport { LineWidth, NoteDisplayMode } from '../../_common/types.js';\nimport {\n  DEFAULT_CONNECTOR_COLOR,\n  GET_DEFAULT_LINE_COLOR,\n  GET_DEFAULT_TEXT_COLOR,\n  LineColorsSchema,\n} from '../../root-block/edgeless/components/panel/color-panel.js';\nimport {\n  FontFamily,\n  FontStyle,\n  FontWeight,\n  ShapeStyle,\n  StrokeStyle,\n  TextAlign,\n  TextVerticalAlign,\n} from '../consts.js';\nimport {\n  ConnectorMode,\n  DEFAULT_FRONT_END_POINT_STYLE,\n  DEFAULT_REAR_END_POINT_STYLE,\n} from '../element-model/connector.js';\nimport {\n  DEFAULT_SHAPE_FILL_COLOR,\n  DEFAULT_SHAPE_STROKE_COLOR,\n  DEFAULT_SHAPE_TEXT_COLOR,\n  FillColorsSchema,\n  SHAPE_TEXT_FONT_SIZE,\n  ShapeType,\n  StrokeColorsSchema,\n} from '../elements/shape/consts.js';\n\nconst ConnectorEndpointSchema = z.enum([\n  'None',\n  'Arrow',\n  'Triangle',\n  'Circle',\n  'Diamond',\n]);\nconst StrokeStyleSchema = z.nativeEnum(StrokeStyle);\nconst LineWidthSchema = z.nativeEnum(LineWidth);\nconst ShapeStyleSchema = z.nativeEnum(ShapeStyle);\nconst ShapeTextFontSizeSchema = z.nativeEnum(SHAPE_TEXT_FONT_SIZE);\nconst FontFamilySchema = z.nativeEnum(FontFamily);\nconst FontWeightSchema = z.nativeEnum(FontWeight);\nconst FontStyleSchema = z.nativeEnum(FontStyle);\nconst TextAlignSchema = z.nativeEnum(TextAlign);\nconst TextVerticalAlignSchema = z.nativeEnum(TextVerticalAlign);\nconst ShapeTypeSchema = z.nativeEnum(ShapeType);\nconst NoteDisplayModeSchema = z.nativeEnum(NoteDisplayMode);\n\nconst LastPropsSchema = z.object({\n  connector: z.object({\n    frontEndpointStyle: ConnectorEndpointSchema,\n    rearEndpointStyle: ConnectorEndpointSchema,\n    strokeStyle: StrokeStyleSchema,\n    stroke: LineColorsSchema,\n    strokeWidth: LineWidthSchema,\n    rough: z.boolean(),\n    mode: z.number().optional(),\n  }),\n  brush: z.object({\n    color: LineColorsSchema,\n    lineWidth: LineWidthSchema,\n  }),\n  shape: z.object({\n    shapeType: ShapeTypeSchema,\n    fillColor: FillColorsSchema,\n    strokeColor: StrokeColorsSchema,\n    shapeStyle: ShapeStyleSchema,\n    filled: z.boolean(),\n    radius: z.number(),\n    strokeWidth: z.number().optional(),\n    strokeStyle: StrokeStyleSchema.optional(),\n    color: z.string().optional(),\n    fontSize: ShapeTextFontSizeSchema.optional(),\n    fontFamily: FontFamilySchema.optional(),\n    fontWeight: FontWeightSchema.optional(),\n    fontStyle: FontStyleSchema.optional(),\n    textAlign: TextAlignSchema.optional(),\n    textHorizontalAlign: TextAlignSchema.optional(),\n    textVerticalAlign: TextVerticalAlignSchema.optional(),\n    roughness: z.number().optional(),\n  }),\n  text: z.object({\n    color: z.string(),\n    fontFamily: FontFamilySchema,\n    textAlign: TextAlignSchema,\n    fontWeight: FontWeightSchema,\n    fontStyle: FontStyleSchema,\n    fontSize: z.number(),\n  }),\n  'affine:note': z.object({\n    background: NoteBackgroundColorsSchema,\n    displayMode: NoteDisplayModeSchema.optional(),\n    edgeless: z.object({\n      style: z.object({\n        borderRadius: z.number(),\n        borderSize: z.number(),\n        borderStyle: StrokeStyleSchema,\n        shadowType: NoteShadowsSchema,\n      }),\n    }),\n  }),\n});\n\nexport type LastProps = z.infer<typeof LastPropsSchema>;\n\nconst SESSION_PROP_KEY = 'blocksuite:prop:record';\n\nconst SessionPropsSchema = z.object({\n  viewport: z.union([\n    z.object({\n      centerX: z.number(),\n      centerY: z.number(),\n      zoom: z.number(),\n    }),\n    z.object({\n      xywh: z.string(),\n      padding: z\n        .tuple([z.number(), z.number(), z.number(), z.number()])\n        .optional(),\n    }),\n  ]),\n  templateCache: z.string(),\n  remoteColor: z.string(),\n  showBidirectional: z.boolean(),\n});\n\nconst LocalPropsSchema = z.object({\n  presentBlackBackground: z.boolean(),\n  presentFillScreen: z.boolean(),\n  presentHideToolbar: z.boolean(),\n\n  autoHideEmbedHTMLFullScreenToolbar: z.boolean(),\n});\n\ntype SessionProps = z.infer<typeof SessionPropsSchema>;\ntype LocalProps = z.infer<typeof LocalPropsSchema>;\ntype StorageProps = SessionProps & LocalProps;\n\nfunction isLocalProp(key: string): key is keyof LocalProps {\n  return key in LocalPropsSchema.shape;\n}\n\nfunction isSessionProp(key: string): key is keyof SessionProps {\n  return key in SessionPropsSchema.shape;\n}\n\nexport type SerializedViewport = z.infer<\n  typeof SessionPropsSchema.shape.viewport\n>;\n\nexport class EditPropsStore {\n  private _lastProps: LastProps = {\n    connector: {\n      frontEndpointStyle: DEFAULT_FRONT_END_POINT_STYLE,\n      rearEndpointStyle: DEFAULT_REAR_END_POINT_STYLE,\n      stroke: DEFAULT_CONNECTOR_COLOR,\n      strokeStyle: StrokeStyle.Solid,\n      strokeWidth: LineWidth.Two,\n      rough: false,\n      mode: ConnectorMode.Curve,\n    },\n    brush: {\n      color: GET_DEFAULT_LINE_COLOR(),\n      lineWidth: LineWidth.Four,\n    },\n    shape: {\n      color: DEFAULT_SHAPE_TEXT_COLOR,\n      shapeType: ShapeType.Rect,\n      fillColor: DEFAULT_SHAPE_FILL_COLOR,\n      strokeColor: DEFAULT_SHAPE_STROKE_COLOR,\n      strokeStyle: StrokeStyle.Solid,\n      strokeWidth: LineWidth.Two,\n      shapeStyle: ShapeStyle.General,\n      filled: true,\n      radius: 0,\n    },\n    text: {\n      color: GET_DEFAULT_TEXT_COLOR(),\n      fontFamily: FontFamily.Inter,\n      textAlign: TextAlign.Left,\n      fontWeight: FontWeight.Regular,\n      fontStyle: FontStyle.Normal,\n      fontSize: 24,\n    },\n    'affine:note': {\n      background: DEFAULT_NOTE_BACKGROUND_COLOR,\n      displayMode: NoteDisplayMode.DocAndEdgeless,\n      edgeless: {\n        style: {\n          borderRadius: 0,\n          borderSize: 4,\n          borderStyle: StrokeStyle.None,\n          shadowType: DEFAULT_NOTE_SHADOW,\n        },\n      },\n    },\n  };\n\n  private _disposables = new DisposableGroup();\n\n  slots = {\n    lastPropsUpdated: new Slot<{\n      type: keyof LastProps;\n      props: Record<string, unknown>;\n    }>(),\n    itemUpdated: new Slot<{\n      key: keyof StorageProps;\n      value: StorageProps[keyof StorageProps];\n    }>(),\n  };\n\n  constructor(private _service: BlockService) {\n    const props = sessionStorage.getItem(SESSION_PROP_KEY);\n    if (props) {\n      const result = LastPropsSchema.safeParse(JSON.parse(props));\n      if (result.success) {\n        this._lastProps = result.data;\n      }\n    }\n  }\n\n  private _getKey<T extends keyof StorageProps>(key: T) {\n    const id = this._service.doc.id;\n    switch (key) {\n      case 'viewport':\n        return 'blocksuite:' + id + ':edgelessViewport';\n      case 'presentBlackBackground':\n        return 'blocksuite:presentation:blackBackground';\n      case 'presentFillScreen':\n        return 'blocksuite:presentation:fillScreen';\n      case 'presentHideToolbar':\n        return 'blocksuite:presentation:hideToolbar';\n      case 'templateCache':\n        return 'blocksuite:' + id + ':templateTool';\n      case 'remoteColor':\n        return 'blocksuite:remote-color';\n      case 'showBidirectional':\n        return 'blocksuite:' + id + ':showBidirectional';\n      case 'autoHideEmbedHTMLFullScreenToolbar':\n        return 'blocksuite:embedHTML:autoHideFullScreenToolbar';\n      default:\n        return key;\n    }\n  }\n\n  private _getStorage<T extends keyof StorageProps>(key: T) {\n    return isSessionProp(key) ? sessionStorage : localStorage;\n  }\n\n  getLastProps<T extends keyof LastProps>(type: T) {\n    return this._lastProps[type] as LastProps[T];\n  }\n\n  record(\n    type: BlockSuite.EdgelessModelKeyType,\n    recordProps: Partial<LastProps[keyof LastProps]>\n  ) {\n    if (!isLastPropType(type)) return;\n\n    const props = this._lastProps[type];\n    const overrideProps = extractProps(\n      recordProps,\n      LastPropsSchema.shape[type]\n    );\n    if (Object.keys(overrideProps).length === 0) return;\n\n    recursive(props, overrideProps);\n    this.slots.lastPropsUpdated.emit({ type, props: overrideProps });\n  }\n\n  apply(type: BlockSuite.EdgelessModelKeyType, props: Record<string, unknown>) {\n    if (!isLastPropType(type)) return;\n\n    const lastProps = this._lastProps[type];\n    deepAssign(props, lastProps);\n  }\n\n  setItem<T extends keyof StorageProps>(key: T, value: StorageProps[T]) {\n    const oldValue = this.getItem(key);\n    this._getStorage(key).setItem(this._getKey(key), JSON.stringify(value));\n    if (oldValue === value) return;\n    this.slots.itemUpdated.emit({ key, value });\n  }\n\n  getItem<T extends keyof StorageProps>(key: T) {\n    try {\n      const storage = this._getStorage(key);\n      const value = storage.getItem(this._getKey(key));\n      if (!value) return null;\n      if (isLocalProp(key)) {\n        return LocalPropsSchema.shape[key].parse(\n          JSON.parse(value)\n        ) as StorageProps[T];\n      } else if (isSessionProp(key)) {\n        return SessionPropsSchema.shape[key].parse(\n          JSON.parse(value)\n        ) as StorageProps[T];\n      } else {\n        return null;\n      }\n    } catch {\n      return null;\n    }\n  }\n\n  dispose() {\n    this._disposables.dispose();\n    this.slots.lastPropsUpdated.dispose();\n  }\n}\n\nfunction extractProps(\n  props: Record<string, unknown>,\n  ref: z.ZodObject<z.ZodRawShape>\n): Record<string, unknown> {\n  const result: Record<string, unknown> = {};\n\n  Object.entries(props).forEach(([key, value]) => {\n    if (!(key in ref.shape)) return;\n    if (isPlainObject(value)) {\n      result[key] = extractProps(\n        props[key] as Record<string, unknown>,\n        ref.shape[key] as z.ZodObject<z.ZodRawShape>\n      );\n    } else {\n      result[key] = value;\n    }\n  });\n\n  return result;\n}\n\nfunction isLastPropType(\n  type: BlockSuite.EdgelessModelKeyType\n): type is keyof LastProps {\n  return Object.keys(LastPropsSchema.shape).includes(type);\n}\n\nfunction deepAssign(\n  target: Record<string, unknown>,\n  source: Record<string, unknown>\n) {\n  Object.keys(source).forEach(key => {\n    if (source[key] === undefined) return;\n    if (!(key in target)) target[key] = undefined;\n    if (target[key] !== undefined) return;\n\n    if (isPlainObject(source[key])) {\n      target[key] = target[key] ?? {};\n      deepAssign(\n        target[key] as Record<string, unknown>,\n        source[key] as Record<string, unknown>\n      );\n    } else {\n      target[key] = source[key];\n    }\n  });\n\n  return target;\n}\n"]}