{"version":3,"file":"surface-block.js","sourceRoot":"","sources":["../../../src/surface-block/mini-mindmap/surface-block.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAO,EAAE,YAAY,EAAE,MAAM,uBAAuB,CAAC;AACrD,OAAO,EAAE,IAAI,EAAE,MAAM,KAAK,CAAC;AAC3B,OAAO,EAAE,aAAa,EAAE,KAAK,EAAE,MAAM,mBAAmB,CAAC;AAEzD,OAAO,EAAE,aAAa,EAAE,MAAM,uCAAuC,CAAC;AACtE,OAAO,EAAE,UAAU,EAAE,MAAM,oDAAoD,CAAC;AAChF,OAAO,EAAE,QAAQ,EAAE,MAAM,gCAAgC,CAAC;AAE1D,OAAO,EAAE,YAAY,EAAE,MAAM,8BAA8B,CAAC;IAM/C,mBAAmB;4BAD/B,aAAa,CAAC,4BAA4B,CAAC;;;;sBACH,YAAY;;;;mCAApB,SAAQ,WAA+B;;;;2CAOrE,KAAK,CAAC,8BAA8B,CAAC;YACtC,kMAAS,eAAe,6BAAf,eAAe,yGAAkB;YAR5C,6KAyGC;;;YAzGY,uDAAmB;;QAQ9B,kCAA0C;QAA1C,IAAS,eAAe,qDAAkB;QAA1C,IAAS,eAAe,2DAAkB;QAE1C,IAAI,cAAc;YAChB,OAAO,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,UAAU,CAC9B,aAAa,CACe,CAAC;QACjC,CAAC;QAEO,gBAAgB;YACtB,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,GAAG,EAAE;gBAC3B,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE;oBACzC,IAAI,OAAO,CAAC,IAAI,KAAK,OAAO,EAAE,CAAC;wBAC7B,UAAU,CAAC,OAA4B,CAAC,CAAC;oBAC3C,CAAC;gBACH,CAAC,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;QACL,CAAC;QAEO,aAAa;YACnB,MAAM,QAAQ,GAAG,IAAI,cAAc,CAAC,GAAG,EAAE;gBACvC,IAAI,CAAC,SAAS,CAAC,QAAQ,EAAE,CAAC;YAC5B,CAAC,CAAC,CAAC;YAEH,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;YACvC,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,GAAG,EAAE;gBACzB,QAAQ,CAAC,UAAU,EAAE,CAAC;YACxB,CAAC,CAAC,CAAC;QACL,CAAC;QAEO,kBAAkB;YACxB,IAAI,CAAC,YAAY,CAAC,GAAG,CACnB,IAAI,CAAC,cAAc,CAAC,aAAa,CAAC,EAAE,CAAC,GAAG,EAAE;gBACxC,IAAI,KAAY,CAAC;gBAEjB,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE;oBACpC,IAAI,CAAC,KAAK,EAAE,CAAC;wBACX,KAAK,GAAG,EAAE,CAAC,YAAY,CAAC;oBAC1B,CAAC;yBAAM,CAAC;wBACN,KAAK,GAAG,KAAK,CAAC,KAAK,CAAC,EAAE,CAAC,YAAY,CAAC,CAAC;oBACvC,CAAC;gBACH,CAAC,CAAC,CAAC;gBAEH,IAAI,KAAM,EAAE,CAAC;oBACX,IAAI,CAAC,SAAS,CAAC,kBAAkB,CAAC,KAAK,EAAE,CAAC,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC;gBAC7D,CAAC;YACH,CAAC,CAAC,CACH,CAAC;QACJ,CAAC;QAEO,cAAc;YACpB,IAAI,CAAC,YAAY,CAAC,GAAG,CACnB,IAAI,CAAC,KAAK,CAAC,cAAc,CAAC,EAAE,CAAC,GAAG,EAAE;gBAChC,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,CAAC;gBACzB,IAAI,CAAC,cAAc,CAAC,MAAM,EAAE,CAAC;YAC/B,CAAC,CAAC,CACH,CAAC;YAEF,IAAI,CAAC,SAAS,CAAC,QAAQ,GAAG,IAAI,CAAC;QACjC,CAAC;QAEQ,iBAAiB;YACxB,KAAK,CAAC,iBAAiB,EAAE,CAAC;YAC1B,IAAI,CAAC,MAAM,GAAG,YAAY,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;YACxD,IAAI,CAAC,SAAS,GAAG,IAAI,QAAQ,CAAC;gBAC5B,YAAY,EAAE,IAAI,CAAC,MAAM;gBACzB,oBAAoB,EAAE,IAAI;gBAC1B,QAAQ,EAAE;oBACR,gBAAgB,EAAE,GAAG,EAAE,CAAC,EAAE;oBAC1B,gBAAgB,EAAE,CAAC,GAAW,EAAE,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,gBAAgB,CAAC,GAAG,CAAC;iBACrE;aACF,CAAC,CAAC;YACH,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,CAAC;YACxD,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACpC,CAAC;QAEQ,YAAY,CAAC,kBAA6C;YACjE,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;YAC5C,IAAI,CAAC,aAAa,EAAE,CAAC;YACrB,IAAI,CAAC,kBAAkB,EAAE,CAAC;YAC1B,IAAI,CAAC,cAAc,EAAE,CAAC;YACtB,IAAI,CAAC,gBAAgB,EAAE,CAAC;YACxB,IAAI,CAAC,cAAc,CAAC,MAAM,EAAE,CAAC;QAC/B,CAAC;QAEQ,MAAM;YACb,OAAO,IAAI,CAAA;;;;;;;;;;KAUV,CAAC;QACJ,CAAC;;;YAvGO,WAAM,GAAG,IAAI,aAAa,EAAE,CAAC;YAO5B,wGAAiC;;;;;;SAR/B,mBAAmB","sourcesContent":["import { BlockElement } from '@blocksuite/block-std';\nimport { html } from 'lit';\nimport { customElement, query } from 'lit/decorators.js';\n\nimport { ThemeObserver } from '../../_common/theme/theme-observer.js';\nimport { fitContent } from '../canvas-renderer/element-renderer/shape/utils.js';\nimport { Renderer } from '../canvas-renderer/renderer.js';\nimport type { ShapeElementModel } from '../element-model/shape.js';\nimport { LayerManager } from '../managers/layer-manager.js';\nimport type { SurfaceBlockModel } from '../surface-model.js';\nimport type { Bound } from '../utils/bound.js';\nimport type { MindmapService } from './service.js';\n\n@customElement('mini-mindmap-surface-block')\nexport class MindmapSurfaceBlock extends BlockElement<SurfaceBlockModel> {\n  private _theme = new ThemeObserver();\n\n  private _layer!: LayerManager;\n\n  private _renderer!: Renderer;\n\n  @query('.affine-mini-mindmap-surface')\n  accessor editorContainer!: HTMLDivElement;\n\n  get mindmapService() {\n    return this.host.spec.getService(\n      'affine:page'\n    ) as unknown as MindmapService;\n  }\n\n  private _adjustNodeWidth() {\n    this.model.doc.transact(() => {\n      this.model.elementModels.forEach(element => {\n        if (element.type === 'shape') {\n          fitContent(element as ShapeElementModel);\n        }\n      });\n    });\n  }\n\n  private _resizeEffect() {\n    const observer = new ResizeObserver(() => {\n      this._renderer.onResize();\n    });\n\n    observer.observe(this.editorContainer);\n    this._disposables.add(() => {\n      observer.disconnect();\n    });\n  }\n\n  private _setupCenterEffect() {\n    this._disposables.add(\n      this.mindmapService.requestCenter.on(() => {\n        let bound: Bound;\n\n        this.model.elementModels.forEach(el => {\n          if (!bound) {\n            bound = el.elementBound;\n          } else {\n            bound = bound.unite(el.elementBound);\n          }\n        });\n\n        if (bound!) {\n          this._renderer.setViewportByBound(bound, [10, 10, 10, 10]);\n        }\n      })\n    );\n  }\n\n  private _setupRenderer() {\n    this._disposables.add(\n      this.model.elementUpdated.on(() => {\n        this._renderer.refresh();\n        this.mindmapService.center();\n      })\n    );\n\n    this._renderer.ZOOM_MIN = 0.01;\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    this._layer = LayerManager.create(this.doc, this.model);\n    this._renderer = new Renderer({\n      layerManager: this._layer,\n      enableStackingCanvas: true,\n      provider: {\n        selectedElements: () => [],\n        getVariableColor: (val: string) => this._theme.getVariableValue(val),\n      },\n    });\n    this._theme.observe(this.ownerDocument.documentElement);\n    this.disposables.add(this._theme);\n  }\n\n  override firstUpdated(_changedProperties: Map<PropertyKey, unknown>): void {\n    this._renderer.attach(this.editorContainer);\n    this._resizeEffect();\n    this._setupCenterEffect();\n    this._setupRenderer();\n    this._adjustNodeWidth();\n    this.mindmapService.center();\n  }\n\n  override render() {\n    return html`\n      <style>\n        .affine-mini-mindmap-surface {\n          width: 100%;\n          height: 100%;\n        }\n      </style>\n      <div class=\"affine-mini-mindmap-surface\">\n        <!-- attach cavnas later in renderer -->\n      </div>\n    `;\n  }\n}\n"]}