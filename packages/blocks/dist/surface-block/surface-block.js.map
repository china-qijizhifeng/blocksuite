{"version":3,"file":"surface-block.js","sourceRoot":"","sources":["../../src/surface-block/surface-block.ts"],"names":[],"mappings":"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","sourcesContent":["import '../root-block/edgeless/components/block-portal/edgeless-block-portal.js';\n\nimport { BlockElement, RangeManager } from '@blocksuite/block-std';\nimport { css, html, nothing } from 'lit';\nimport { customElement, query } from 'lit/decorators.js';\n\nimport { ThemeObserver } from '../_common/theme/theme-observer.js';\nimport { isInsideEdgelessEditor } from '../_common/utils/index.js';\nimport { values } from '../_common/utils/iterable.js';\nimport { isShape } from '../root-block/edgeless/components/auto-complete/utils.js';\nimport type { EdgelessBlockPortalContainer } from '../root-block/edgeless/components/block-portal/edgeless-block-portal.js';\nimport type { EdgelessRootBlockComponent } from '../root-block/edgeless/edgeless-root-block.js';\nimport { FrameOverlay } from '../root-block/edgeless/frame-manager.js';\nimport { Renderer } from './canvas-renderer/renderer.js';\nimport { ConnectorElementModel } from './element-model/index.js';\nimport { ConnectionOverlay } from './managers/connector-manager.js';\nimport type { SurfaceBlockModel } from './surface-model.js';\nimport type { SurfaceBlockService } from './surface-service.js';\nimport { Bound } from './utils/bound.js';\nimport { normalizeWheelDeltaY } from './utils/index.js';\n\nexport type IndexedCanvasUpdateEvent = CustomEvent<{\n  content: HTMLCanvasElement[];\n}>;\n\n@customElement('affine-surface')\nexport class SurfaceBlockComponent extends BlockElement<\n  SurfaceBlockModel,\n  SurfaceBlockService\n> {\n  get renderer() {\n    return this._renderer;\n  }\n\n  get edgeless() {\n    return this.parentBlockElement as EdgelessRootBlockComponent;\n  }\n\n  private get _isEdgeless() {\n    return isInsideEdgelessEditor(this.host);\n  }\n\n  static override styles = css`\n    .affine-edgeless-surface-block-container {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n    }\n\n    .affine-edgeless-surface-block-container canvas {\n      width: 100%;\n      height: 100%;\n      position: relative;\n      z-index: 1;\n      pointer-events: none;\n    }\n\n    edgeless-block-portal-container {\n      position: relative;\n      box-sizing: border-box;\n      overflow: hidden;\n      display: block;\n      height: 100%;\n      font-family: var(--affine-font-family);\n      font-size: var(--affine-font-base);\n      line-height: var(--affine-line-height);\n      color: var(--affine-text-primary-color);\n      font-weight: 400;\n    }\n\n    .affine-block-children-container.edgeless {\n      padding-left: 0;\n      position: relative;\n      overflow: hidden;\n      height: 100%;\n      /**\n       * Fix: pointerEvent stops firing after a short time.\n       * When a gesture is started, the browser intersects the touch-action values of the touched element and its ancestors,\n       * up to the one that implements the gesture (in other words, the first containing scrolling element)\n       * https://developer.mozilla.org/en-US/docs/Web/CSS/touch-action\n       */\n      touch-action: none;\n      background-color: var(--affine-background-primary-color);\n      background-image: radial-gradient(\n        var(--affine-edgeless-grid-color) 1px,\n        var(--affine-background-primary-color) 1px\n      );\n      z-index: 0;\n    }\n\n    .affine-edgeless-block-child {\n      position: absolute;\n      transform-origin: center;\n      box-sizing: border-box;\n      border: 2px solid var(--affine-white-10);\n      border-radius: 8px;\n      box-shadow: var(--affine-shadow-3);\n      pointer-events: all;\n    }\n  `;\n\n  static isShape = isShape;\n\n  private _renderer!: Renderer;\n\n  private _lastTime = 0;\n\n  private _cachedViewport = new Bound();\n\n  @query('.affine-edgeless-surface-block-container')\n  private accessor _surfaceContainer!: HTMLElement;\n\n  readonly themeObserver = new ThemeObserver();\n\n  overlays!: {\n    connector: ConnectionOverlay;\n    frame: FrameOverlay;\n  };\n\n  @query('edgeless-block-portal-container')\n  accessor portal!: EdgelessBlockPortalContainer;\n\n  private _initOverlay() {\n    this.overlays = {\n      connector: new ConnectionOverlay(this.edgeless.service),\n      frame: new FrameOverlay(),\n    };\n\n    values(this.overlays).forEach(overlay => {\n      this._renderer.addOverlay(overlay);\n    });\n  }\n\n  private _initRenderer() {\n    const service = this.edgeless.service!;\n\n    this._renderer = new Renderer({\n      layerManager: service.layer,\n      enableStackingCanvas: true,\n      provider: {\n        selectedElements: () => service.selection.selectedIds,\n        getVariableColor: (val: string) =>\n          this.themeObserver.getVariableValue(val),\n      },\n      onStackingCanvasCreated(canvas) {\n        canvas.className = 'indexable-canvas';\n\n        canvas.style.setProperty('transform-origin', '0 0');\n        canvas.style.setProperty('position', 'absolute');\n        canvas.style.setProperty('pointer-events', 'none');\n      },\n    });\n\n    this._disposables.add(\n      this.model.elementUpdated.on(payload => {\n        // ignore externalXYWH update cause it's updated by the renderer\n        if (payload.props['externalXYWH']) return;\n        this._renderer.refresh();\n      })\n    );\n    this._disposables.add(\n      this.model.elementAdded.on(() => {\n        this._renderer.refresh();\n      })\n    );\n    this._disposables.add(\n      this.model.elementRemoved.on(() => {\n        this._renderer.refresh();\n      })\n    );\n    this._disposables.add(this._renderer.sync(this.edgeless.service.viewport));\n    this._disposables.add(() => {\n      this._renderer.dispose();\n    });\n    this._disposables.add(\n      this._renderer.stackingCanvasUpdated.on(() => {\n        this._emitStackingCanvasUpdate();\n      })\n    );\n    this._disposables.add(\n      this.std.event.slots.editorHostPanned.on(() => {\n        this._renderer.onResize();\n      })\n    );\n  }\n\n  private _initThemeObserver = () => {\n    this.themeObserver.observe(document.documentElement);\n    this.themeObserver.on(() => this.requestUpdate());\n    this.disposables.add(() => this.themeObserver.dispose());\n  };\n\n  private _emitStackingCanvasUpdate() {\n    const evt = new CustomEvent('indexedcanvasupdate', {\n      detail: {\n        content: this._renderer.stackingCanvas,\n      },\n    }) as IndexedCanvasUpdateEvent;\n\n    this.dispatchEvent(evt);\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.setAttribute(RangeManager.rangeSyncExcludeAttr, 'true');\n\n    if (!this._isEdgeless) return;\n\n    this._initThemeObserver();\n    this._initRenderer();\n    this._initOverlay();\n  }\n\n  override firstUpdated() {\n    if (!this._isEdgeless) return;\n\n    this._renderer.attach(this._surfaceContainer);\n  }\n\n  refresh() {\n    this._renderer.refresh();\n  }\n\n  fitToViewport(bound: Bound) {\n    const { viewport } = this.edgeless.service;\n    bound = bound.expand(30);\n    if (Date.now() - this._lastTime > 200)\n      this._cachedViewport = viewport.viewportBounds;\n    this._lastTime = Date.now();\n\n    if (this._cachedViewport.contains(bound)) return;\n\n    this._cachedViewport = this._cachedViewport.unite(bound);\n    viewport.setViewportByBound(this._cachedViewport, [0, 0, 0, 0], true);\n  }\n\n  /** @internal Only for testing */\n  initDefaultGestureHandler() {\n    const { _renderer } = this;\n    _renderer.canvas.addEventListener('wheel', e => {\n      e.preventDefault();\n      // pan\n      if (!e.ctrlKey) {\n        const dx = e.deltaX / _renderer.zoom;\n        const dy = e.deltaY / _renderer.zoom;\n        _renderer.setCenter(_renderer.centerX + dx, _renderer.centerY + dy);\n      }\n      // zoom\n      else {\n        const zoom = normalizeWheelDeltaY(e.deltaY);\n        _renderer.setZoom(zoom);\n      }\n    });\n  }\n\n  override render() {\n    if (!this._isEdgeless) return nothing;\n\n    return html`\n      <div class=\"affine-edgeless-surface-block-container\">\n        <!-- attach canvas later in renderer -->\n      </div>\n    `;\n  }\n\n  static isConnector = (element: unknown): element is ConnectorElementModel => {\n    return element instanceof ConnectorElementModel;\n  };\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-surface': SurfaceBlockComponent;\n  }\n}\n"]}