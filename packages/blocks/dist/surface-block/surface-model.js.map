{"version":3,"file":"surface-model.js","sourceRoot":"","sources":["../../src/surface-block/surface-model.ts"],"names":[],"mappings":"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","sourcesContent":["import { DisposableGroup, Slot } from '@blocksuite/global/utils';\nimport type { MigrationRunner, Y } from '@blocksuite/store';\nimport {\n  BlockModel,\n  Boxed,\n  defineBlockSchema,\n  DocCollection,\n  Text,\n} from '@blocksuite/store';\n\nimport {\n  type IBaseProps,\n  SurfaceGroupLikeModel,\n} from './element-model/base.js';\nimport type {\n  Connection,\n  ConnectorElementModel,\n} from './element-model/connector.js';\nimport {\n  createElementModel,\n  createModelFromProps,\n  type ElementModelMap,\n  propsToY,\n} from './element-model/index.js';\nimport { connectorMiddleware } from './middlewares/connector.js';\nimport {\n  groupRelationMiddleware,\n  groupSizeMiddleware,\n} from './middlewares/group.js';\nimport { SurfaceBlockTransformer } from './surface-transformer.js';\nimport { generateElementId } from './utils/index.js';\n\nexport type SurfaceBlockProps = {\n  elements: Boxed<Y.Map<Y.Map<unknown>>>;\n};\n\nexport interface ElementUpdatedData {\n  id: string;\n  props: Record<string, unknown>;\n  oldValues: Record<string, unknown>;\n  local: boolean;\n}\n\nconst migration = {\n  toV4: data => {\n    const { elements } = data;\n    if (elements instanceof Boxed) {\n      const value = elements.getValue();\n      if (!value) {\n        return;\n      }\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      for (const [key, element] of (value as Record<string, any>).entries()) {\n        const type = element.get('type') as string;\n        if (type === 'shape' || type === 'text') {\n          const isBold = element.get('isBold');\n          const isItalic = element.get('isItalic');\n          element.delete('isBold');\n          element.delete('isItalic');\n          if (isBold) {\n            element.set('bold', true);\n          }\n          if (isItalic) {\n            element.set('italic', true);\n          }\n        }\n        if (type === 'connector') {\n          const source = element.get('source');\n          const target = element.get('target');\n          const sourceId = source['id'];\n          const targetId = target['id'];\n          if (!source['position'] && !sourceId) {\n            value.delete(key);\n            return;\n          }\n          if (!target['position'] && !targetId) {\n            value.delete(key);\n            return;\n          }\n        }\n      }\n    } else {\n      for (const key of Object.keys(elements)) {\n        const element = elements[key] as Record<string, unknown>;\n        const type = element['type'] as string;\n        if (type === 'shape' || type === 'text') {\n          const isBold = element['isBold'];\n          const isItalic = element['isItalic'];\n          delete element['isBold'];\n          delete element['isItalic'];\n          if (isBold) {\n            element['bold'] = true;\n          }\n          if (isItalic) {\n            element['italic'] = true;\n          }\n        }\n        if (type === 'connector') {\n          const source = element['source'] as Record<string, unknown>;\n          const target = element['target'] as Record<string, unknown>;\n          const sourceId = source['id'];\n          const targetId = target['id'];\n          // @ts-expect-error\n          if (!source['position'] && (!sourceId || !elements[sourceId])) {\n            delete elements[key];\n            return;\n          }\n          // @ts-expect-error\n          if (!target['position'] && (!targetId || !elements[targetId])) {\n            delete elements[key];\n            return;\n          }\n        }\n      }\n    }\n  },\n  toV5: data => {\n    const { elements } = data;\n    if (!((elements as object | Boxed) instanceof Boxed)) {\n      const yMap = new DocCollection.Y.Map() as Y.Map<Y.Map<unknown>>;\n\n      Object.entries(elements).forEach(([key, value]) => {\n        const map = new DocCollection.Y.Map();\n        Object.entries(value).forEach(([_key, _value]) => {\n          map.set(\n            _key,\n            _value instanceof DocCollection.Y.Text\n              ? _value.clone()\n              : _value instanceof Text\n                ? _value.yText.clone()\n                : _value\n          );\n        });\n        yMap.set(key, map);\n      });\n      const wrapper = new Boxed(yMap);\n      data.elements = wrapper;\n    }\n\n    const childrenMap = data.elements.getValue() as Y.Map<Y.Map<unknown>>;\n\n    for (const [id, element] of childrenMap) {\n      if (\n        element.get('type') === 'mindmap' ||\n        element.get('type') === 'group'\n      ) {\n        const children = element.get('children') as Y.Map<Y.Map<unknown>>;\n\n        if (children?.size === 0) {\n          childrenMap.delete(id);\n        }\n      }\n    }\n  },\n} satisfies Record<string, MigrationRunner<typeof SurfaceBlockSchema>>;\n\nexport const SurfaceBlockSchema = defineBlockSchema({\n  flavour: 'affine:surface',\n  props: (internalPrimitives): SurfaceBlockProps => ({\n    elements: internalPrimitives.Boxed(new DocCollection.Y.Map()),\n  }),\n  metadata: {\n    version: 5,\n    role: 'hub',\n    parent: ['affine:page'],\n    children: [\n      'affine:frame',\n      'affine:image',\n      'affine:bookmark',\n      'affine:attachment',\n      'affine:embed-*',\n      'affine:edgeless-text',\n    ],\n  },\n  onUpgrade: (data, previousVersion, version) => {\n    if (previousVersion < 4 && version >= 4) {\n      migration.toV4(data);\n    }\n    if (previousVersion < 5 && version >= 5) {\n      migration.toV5(data);\n    }\n  },\n  transformer: () => new SurfaceBlockTransformer(),\n  toModel: () => new SurfaceBlockModel(),\n});\n\nexport type SurfaceMiddleware = (\n  surface: SurfaceBlockModel,\n  hooks: SurfaceBlockModel['hooks']\n) => () => void;\n\nexport class SurfaceBlockModel extends BlockModel<SurfaceBlockProps> {\n  private _elementModels = new Map<\n    string,\n    {\n      mount: () => void;\n      unmount: () => void;\n      model: BlockSuite.SurfaceElementModelType;\n    }\n  >();\n\n  private _disposables: DisposableGroup = new DisposableGroup();\n\n  private _groupToElements = new Map<string, string[]>();\n\n  private _elementToGroup = new Map<string, string>();\n\n  private _connectorToElements = new Map<string, string[]>();\n\n  private _elementToConnector = new Map<string, string[]>();\n\n  /**\n   * Hooks is used to attach extra logic when calling `addElement`„ÄÅ`updateElement`(or assign property directly) and `removeElement`.\n   * It's useful when dealing with relation between different model.\n   */\n  protected hooks = {\n    update: new Slot<Omit<ElementUpdatedData, 'local'>>(),\n    remove: new Slot<{\n      id: string;\n      type: string;\n      model: BlockSuite.SurfaceElementModelType;\n    }>(),\n  };\n\n  elementUpdated = new Slot<ElementUpdatedData>();\n\n  elementAdded = new Slot<{ id: string; local: boolean }>();\n\n  elementRemoved = new Slot<{\n    id: string;\n    type: string;\n    model: BlockSuite.SurfaceElementModelType;\n    local: boolean;\n  }>();\n\n  get elementModels() {\n    const models: BlockSuite.SurfaceElementModelType[] = [];\n    this._elementModels.forEach(model => models.push(model.model));\n    return models;\n  }\n\n  constructor() {\n    super();\n    this.created.once(() => this._init());\n  }\n\n  private _init() {\n    this._initElementModels();\n    this._watchGroupRelationChange();\n    this._watchConnectorRelationChange();\n    this._applyMiddlewares();\n  }\n\n  private _applyMiddlewares() {\n    [\n      connectorMiddleware(this, this.hooks),\n      groupRelationMiddleware(this, this.hooks),\n      groupSizeMiddleware(this, this.hooks),\n    ].forEach(disposable => this._disposables.add(disposable));\n  }\n\n  private _initElementModels() {\n    const elementsYMap = this.elements.getValue()!;\n    const onElementsMapChange = (\n      event: Y.YMapEvent<Y.Map<unknown>>,\n      transaction: Y.Transaction\n    ) => {\n      const { changes, keysChanged } = event;\n\n      keysChanged.forEach(id => {\n        const change = changes.keys.get(id);\n        const element = this.elements.getValue()!.get(id);\n\n        switch (change?.action) {\n          case 'add':\n            if (element) {\n              if (!this._elementModels.has(id)) {\n                const model = createElementModel(\n                  element.get('type') as string,\n                  element.get('id') as string,\n                  element,\n                  this,\n                  {\n                    onChange: payload => this.elementUpdated.emit(payload),\n                    skipFieldInit: true,\n                  }\n                );\n\n                this._elementModels.set(id, model);\n              }\n              const { mount } = this._elementModels.get(id)!;\n              mount();\n              this.elementAdded.emit({ id, local: transaction.local });\n            }\n            break;\n          case 'delete':\n            if (this._elementModels.has(id)) {\n              const { model, unmount } = this._elementModels.get(id)!;\n              unmount();\n              this.elementRemoved.emit({\n                id,\n                type: model.type,\n                model,\n                local: transaction.local,\n              });\n              this._elementToGroup.delete(id);\n              this._elementToConnector.delete(id);\n              this._elementModels.delete(id);\n            }\n            break;\n        }\n      });\n    };\n\n    elementsYMap.forEach((val, key) => {\n      const model = createElementModel(\n        val.get('type') as string,\n        val.get('id') as string,\n        val,\n        this,\n        {\n          onChange: payload => this.elementUpdated.emit(payload),\n          skipFieldInit: true,\n        }\n      );\n\n      this._elementModels.set(key, model);\n      model.mount();\n    });\n    elementsYMap.observe(onElementsMapChange);\n\n    this._disposables.add(() => {\n      elementsYMap.unobserve(onElementsMapChange);\n    });\n  }\n\n  private _watchGroupRelationChange() {\n    const addToGroup = (elementId: string, groupId: string) => {\n      this._elementToGroup.set(elementId, groupId);\n      this._groupToElements.set(\n        groupId,\n        (this._groupToElements.get(groupId) || []).concat(elementId)\n      );\n    };\n    const removeFromGroup = (elementId: string, groupId: string) => {\n      if (this._elementToGroup.has(elementId)) {\n        const group = this._elementToGroup.get(elementId)!;\n        if (group === groupId) {\n          this._elementToGroup.delete(elementId);\n        }\n      }\n\n      if (this._groupToElements.has(groupId)) {\n        const elements = this._groupToElements.get(groupId)!;\n        const index = elements.indexOf(elementId);\n\n        if (index !== -1) {\n          elements.splice(index, 1);\n          elements.length === 0 && this._groupToElements.delete(groupId);\n        }\n      }\n    };\n    const isGroup = (\n      element: BlockSuite.SurfaceElementModelType\n    ): element is BlockSuite.SurfaceGroupLikeModelType =>\n      element instanceof SurfaceGroupLikeModel;\n\n    this.elementModels.forEach(model => {\n      if (isGroup(model)) {\n        model.childIds.forEach(childId => {\n          addToGroup(childId, model.id);\n        });\n      }\n    });\n\n    this.elementUpdated.on(({ id, oldValues }) => {\n      const element = this.getElementById(id)!;\n\n      if (isGroup(element) && oldValues['childIds']) {\n        (oldValues['childIds'] as string[]).forEach(childId => {\n          removeFromGroup(childId, id);\n        });\n\n        element.childIds.forEach(childId => {\n          addToGroup(childId, id);\n        });\n\n        if (element.childIds.length === 0) {\n          this.removeElement(id);\n        }\n      }\n    });\n\n    this.elementAdded.on(({ id }) => {\n      const element = this.getElementById(id)!;\n\n      if (isGroup(element)) {\n        element.childIds.forEach(childId => {\n          addToGroup(childId, id);\n        });\n      }\n    });\n\n    this.elementRemoved.on(({ id, model }) => {\n      if (isGroup(model)) {\n        const children = [...(this._groupToElements.get(id) || [])];\n\n        children.forEach(childId => removeFromGroup(childId, id));\n      }\n    });\n\n    this._disposables.add(\n      this.doc.slots.blockUpdated.on(({ type, id }) => {\n        switch (type) {\n          case 'delete': {\n            const group = this.getGroup(id);\n\n            if (group) {\n              // eslint-disable-next-line unicorn/prefer-dom-node-remove\n              group.removeChild(id);\n            }\n          }\n        }\n      })\n    );\n  }\n\n  private _watchConnectorRelationChange() {\n    const addConnector = (targetId: string, connectorId: string) => {\n      const connectors = this._elementToConnector.get(targetId);\n\n      if (!connectors) {\n        this._elementToConnector.set(targetId, [connectorId]);\n      } else {\n        connectors.push(connectorId);\n      }\n\n      this._connectorToElements.set(\n        connectorId,\n        (this._connectorToElements.get(connectorId) || []).concat(targetId)\n      );\n    };\n    const removeConnector = (targetId: string, connectorId: string) => {\n      if (this._elementToConnector.has(targetId)) {\n        const connectors = this._elementToConnector.get(targetId)!;\n        const index = connectors.indexOf(connectorId);\n\n        if (index !== -1) {\n          connectors.splice(index, 1);\n          connectors.length === 0 && this._elementToConnector.delete(targetId);\n        }\n      }\n\n      if (this._connectorToElements.has(connectorId)) {\n        const elements = this._connectorToElements.get(connectorId)!;\n        const index = elements.indexOf(targetId);\n\n        if (index !== -1) {\n          elements.splice(index, 1);\n          elements.length === 0 &&\n            this._connectorToElements.delete(connectorId);\n        }\n      }\n    };\n\n    const updateConnectorMap = (\n      element: BlockSuite.SurfaceElementModelType,\n      type: 'add' | 'remove'\n    ) => {\n      if (element.type !== 'connector') return;\n\n      const connector = element as ConnectorElementModel;\n      const connected = [connector.source.id, connector.target.id];\n      const action = type === 'add' ? addConnector : removeConnector;\n\n      connected.forEach(id => {\n        id && action(id, connector.id);\n      });\n    };\n\n    this.elementModels.forEach(model => updateConnectorMap(model, 'add'));\n\n    this.elementUpdated.on(({ id, oldValues }) => {\n      const element = this.getElementById(id)!;\n\n      if (\n        element.type !== 'connector' ||\n        (!oldValues['source'] && !oldValues['target'])\n      )\n        return;\n\n      const oldConnected = [\n        (oldValues['source'] as Connection)?.id,\n        (oldValues['target'] as Connection)?.id,\n      ];\n\n      oldConnected.forEach(id => {\n        id && removeConnector(id, element.id);\n      });\n\n      updateConnectorMap(element, 'add');\n    });\n\n    this.elementAdded.on(id =>\n      updateConnectorMap(this.getElementById(id.id)!, 'add')\n    );\n\n    this.elementRemoved.on(({ id, type }) => {\n      if (type === 'connector') {\n        const connected = [...(this._connectorToElements.get(id) || [])];\n\n        connected.forEach(connectedId => removeConnector(connectedId, id));\n      }\n    });\n  }\n\n  override dispose(): void {\n    super.dispose();\n\n    this._disposables.dispose();\n\n    this.elementAdded.dispose();\n    this.elementRemoved.dispose();\n    this.elementUpdated.dispose();\n\n    this._elementModels.forEach(({ unmount }) => unmount());\n    this._elementModels.clear();\n\n    this.hooks.update.dispose();\n    this.hooks.remove.dispose();\n  }\n\n  isInMindmap(id: string) {\n    const group = this.getGroup(id);\n\n    return group?.type === 'mindmap';\n  }\n\n  getConnectors(id: string) {\n    return (this._elementToConnector.get(id) || []).map(\n      id => this.getElementById(id)!\n    ) as ConnectorElementModel[];\n  }\n\n  getGroup<\n    T extends\n      SurfaceGroupLikeModel<IBaseProps> = SurfaceGroupLikeModel<IBaseProps>,\n  >(id: string): T | null {\n    return this._elementToGroup.has(id)\n      ? (this.getElementById(this._elementToGroup.get(id)!) as T)\n      : null;\n  }\n\n  getGroups(id: string): SurfaceGroupLikeModel<IBaseProps>[] {\n    const groups: SurfaceGroupLikeModel<IBaseProps>[] = [];\n    let group = this.getGroup(id);\n\n    while (group) {\n      groups.push(group);\n      group = this.getGroup(group.id);\n    }\n\n    return groups;\n  }\n\n  getElementsByType<K extends keyof ElementModelMap>(\n    type: K\n  ): ElementModelMap[K][] {\n    return this.elementModels.filter(\n      model => model.type === type\n    ) as ElementModelMap[K][];\n  }\n\n  hasElementById(id: string): boolean {\n    return this._elementModels.has(id);\n  }\n\n  getElementById(id: string): BlockSuite.SurfaceElementModelType | null {\n    return this._elementModels.get(id)?.model ?? null;\n  }\n\n  addElement<T extends object = Record<string, unknown>>(\n    props: Partial<T> & { type: string }\n  ) {\n    if (this.doc.readonly) {\n      throw new Error('Cannot add element in readonly mode');\n    }\n\n    const id = generateElementId();\n\n    // @ts-ignore\n    props.id = id;\n\n    const elementModel = createModelFromProps(props, this, {\n      onChange: payload => this.elementUpdated.emit(payload),\n    });\n\n    this._elementModels.set(id, elementModel);\n\n    this.doc.transact(() => {\n      this.elements.getValue()!.set(id, elementModel.model.yMap);\n    });\n\n    return id;\n  }\n\n  removeElement(id: string) {\n    if (this.doc.readonly) {\n      throw new Error('Cannot remove element in readonly mode');\n    }\n\n    if (!this.hasElementById(id)) {\n      return;\n    }\n\n    this.doc.transact(() => {\n      const element = this.getElementById(id)!;\n      const group = this.getGroup(id);\n\n      if (element instanceof SurfaceGroupLikeModel) {\n        element.childIds.forEach(childId => {\n          if (this.hasElementById(childId)) {\n            this.removeElement(childId);\n          } else if (this.doc.hasBlock(childId)) {\n            this.doc.deleteBlock(this.doc.getBlock(childId)!.model);\n          }\n        });\n      }\n\n      if (group) {\n        // eslint-disable-next-line unicorn/prefer-dom-node-remove\n        group.removeChild(id);\n      }\n\n      this.elements.getValue()!.delete(id);\n\n      this.hooks.remove.emit({\n        id,\n        model: element as BlockSuite.SurfaceElementModelType,\n        type: element.type,\n      });\n    });\n  }\n\n  updateElement<T extends object = Record<string, unknown>>(\n    id: string,\n    props: Partial<T>\n  ) {\n    if (this.doc.readonly) {\n      throw new Error('Cannot update element in readonly mode');\n    }\n\n    const elementModel = this.getElementById(id);\n\n    if (!elementModel) {\n      throw new Error(`Element ${id} is not found`);\n    }\n\n    this.doc.transact(() => {\n      props = propsToY(\n        elementModel.type,\n        props as Record<string, unknown>\n      ) as T;\n      Object.entries(props).forEach(([key, value]) => {\n        // @ts-ignore\n        elementModel[key] = value;\n      });\n    });\n  }\n}\n"]}