{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/surface-block/element-model/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { DocCollection, type Y } from '@blocksuite/store';\n\nimport type { SurfaceBlockModel } from '../surface-model.js';\nimport { SurfaceElementModel } from './base.js';\nimport { BrushElementModel } from './brush.js';\nimport { ConnectorElementModel } from './connector.js';\nimport { initializedObservers, initializeWatchers } from './decorators.js';\nimport { getDecoratorState } from './decorators/common.js';\nimport { GroupElementModel } from './group.js';\nimport { MindmapElementModel } from './mindmap.js';\nimport { ShapeElementModel } from './shape.js';\nimport { TextElementModel } from './text.js';\n\nconst elementsCtorMap = {\n  group: GroupElementModel,\n  connector: ConnectorElementModel,\n  shape: ShapeElementModel,\n  brush: BrushElementModel,\n  text: TextElementModel,\n  mindmap: MindmapElementModel,\n};\n\nexport function createElementModel(\n  type: string,\n  id: string,\n  yMap: Y.Map<unknown>,\n  model: SurfaceBlockModel,\n  options: {\n    onChange: (payload: {\n      id: string;\n      props: Record<string, unknown>;\n      oldValues: Record<string, unknown>;\n      local: boolean;\n    }) => void;\n    skipFieldInit?: boolean;\n    newCreate?: boolean;\n  }\n): {\n  model: SurfaceElementModel;\n  unmount: () => void;\n  mount: () => void;\n} {\n  const stashed = new Map<string | symbol, unknown>();\n  const Ctor = elementsCtorMap[type as keyof typeof elementsCtorMap];\n\n  if (!Ctor) {\n    throw new Error(`Invalid element type: ${yMap.get('type')}`);\n  }\n  const state = getDecoratorState();\n\n  state.creating = true;\n  state.skipYfield = options.skipFieldInit ?? false;\n\n  let mounted = false;\n  const elementModel = new Ctor({\n    id,\n    yMap,\n    model,\n    stashedStore: stashed,\n    onChange: payload => mounted && options.onChange({ id, ...payload }),\n  }) as SurfaceElementModel;\n\n  state.creating = false;\n  state.skipYfield = false;\n\n  const unmount = () => {\n    mounted = false;\n    elementModel['_disposable'].dispose();\n  };\n\n  const mount = () => {\n    initializedObservers(Ctor.prototype, elementModel);\n    initializeWatchers(Ctor.prototype, elementModel);\n    elementModel['_disposable'].add(\n      onElementChange(yMap, payload => {\n        mounted &&\n          options.onChange({\n            id,\n            ...payload,\n          });\n      })\n    );\n    elementModel['_preserved'].clear();\n    mounted = true;\n    elementModel.onCreated();\n  };\n\n  return {\n    model: elementModel,\n    mount,\n    unmount,\n  };\n}\n\nfunction onElementChange(\n  yMap: Y.Map<unknown>,\n  callback: (payload: {\n    props: Record<string, unknown>;\n    oldValues: Record<string, unknown>;\n    local: boolean;\n  }) => void\n) {\n  const observer = (\n    event: Y.YMapEvent<unknown>,\n    transaction: Y.Transaction\n  ) => {\n    const props: Record<string, unknown> = {};\n    const oldValues: Record<string, unknown> = {};\n\n    event.keysChanged.forEach(key => {\n      const type = event.changes.keys.get(key);\n      const oldValue = event.changes.keys.get(key)?.oldValue;\n\n      if (!type) {\n        return;\n      }\n\n      if (type.action === 'update' || type.action === 'add') {\n        props[key] = yMap.get(key);\n        oldValues[key] = oldValue;\n      }\n    });\n\n    callback({\n      props,\n      oldValues,\n      local: transaction.local,\n    });\n  };\n\n  yMap.observe(observer);\n\n  return () => {\n    yMap.observe(observer);\n  };\n}\n\nexport function propsToY(type: string, props: Record<string, unknown>) {\n  const ctor = elementsCtorMap[type as keyof typeof elementsCtorMap];\n\n  if (!ctor) {\n    throw new Error(`Invalid element type: ${type}`);\n  }\n\n  // @ts-ignore\n  return (ctor.propsToY ?? SurfaceElementModel.propsToY)(props);\n}\n\nexport function createModelFromProps(\n  props: Record<string, unknown>,\n  model: SurfaceBlockModel,\n  options: {\n    onChange: (payload: {\n      id: string;\n      props: Record<string, unknown>;\n      oldValues: Record<string, unknown>;\n      local: boolean;\n    }) => void;\n  }\n) {\n  const { type, id, ...rest } = props;\n\n  if (!id) {\n    throw new Error('Cannot find id in props');\n  }\n\n  const yMap = new DocCollection.Y.Map();\n  const elementModel = createElementModel(\n    type as string,\n    id as string,\n    yMap,\n    model,\n    {\n      ...options,\n      newCreate: true,\n    }\n  );\n\n  props = propsToY(type as string, props);\n\n  yMap.set('type', type);\n  yMap.set('id', id);\n\n  Object.keys(rest).forEach(key => {\n    if (props[key] !== undefined) {\n      // @ts-ignore\n      elementModel.model[key] = props[key];\n    }\n  });\n\n  return elementModel;\n}\n\nexport {\n  BrushElementModel,\n  ConnectorElementModel,\n  GroupElementModel,\n  MindmapElementModel,\n  ShapeElementModel,\n  SurfaceElementModel,\n  TextElementModel,\n};\n\nexport enum CanvasElementType {\n  SHAPE = 'shape',\n  BRUSH = 'brush',\n  CONNECTOR = 'connector',\n  TEXT = 'text',\n  GROUP = 'group',\n  MINDMAP = 'mindmap',\n}\n\nexport type ElementModelMap = {\n  ['shape']: ShapeElementModel;\n  ['brush']: BrushElementModel;\n  ['connector']: ConnectorElementModel;\n  ['text']: TextElementModel;\n  ['group']: GroupElementModel;\n  ['mindmap']: MindmapElementModel;\n};\n\nexport function isCanvasElementType(type: string): type is CanvasElementType {\n  return type.toLocaleUpperCase() in CanvasElementType;\n}\n"]}