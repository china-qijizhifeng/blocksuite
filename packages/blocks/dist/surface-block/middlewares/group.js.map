{"version":3,"file":"group.js","sourceRoot":"","sources":["../../../src/surface-block/middlewares/group.ts"],"names":[],"mappings":"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","sourcesContent":["import { SurfaceGroupLikeModel } from '../element-model/base.js';\nimport type { SurfaceBlockModel, SurfaceMiddleware } from '../surface-model.js';\nimport type { Bound } from '../utils/bound.js';\n\nexport const groupSizeMiddleware: SurfaceMiddleware = (\n  surface: SurfaceBlockModel\n) => {\n  const getElementById = (id: string) =>\n    surface.getElementById(id) ??\n    (surface.doc.getBlockById(id) as BlockSuite.EdgelessModelType);\n  let pending = false;\n  const groupSet = new Set<SurfaceGroupLikeModel>();\n  const calculateGroupSize = (group: SurfaceGroupLikeModel) => {\n    let bound: Bound | undefined;\n    group.childIds.forEach(childId => {\n      const elementBound = getElementById(childId)?.elementBound;\n\n      if (elementBound) {\n        bound = bound ? bound.unite(elementBound) : elementBound;\n      }\n    });\n\n    group.xywh = bound?.serialize() ?? '[0,0,0,0]';\n  };\n  const addGroupSizeUpdateList = (group: SurfaceGroupLikeModel) => {\n    groupSet.add(group);\n\n    if (!pending) {\n      pending = true;\n      queueMicrotask(() => {\n        groupSet.forEach(group => {\n          calculateGroupSize(group);\n        });\n        groupSet.clear();\n        pending = false;\n      });\n    }\n  };\n\n  const disposables = [\n    surface.doc.slots.blockUpdated.on(payload => {\n      if (payload.type === 'update') {\n        const group = surface.getGroup(payload.id);\n\n        if (\n          group instanceof SurfaceGroupLikeModel &&\n          payload.props.key === 'xywh'\n        ) {\n          addGroupSizeUpdateList(group);\n        }\n      }\n    }),\n    surface.elementUpdated.on(({ id, props }) => {\n      // update the group's xywh when children's xywh updated\n      const group = surface.getGroup(id);\n      if (group instanceof SurfaceGroupLikeModel && props['xywh']) {\n        addGroupSizeUpdateList(group);\n      }\n\n      const element = surface.getElementById(id);\n      if (element instanceof SurfaceGroupLikeModel && props['childIds']) {\n        addGroupSizeUpdateList(element);\n      }\n    }),\n    surface.elementAdded.on(({ id }) => {\n      // update the group's xywh when added\n      const group = surface.getElementById(id);\n\n      if (group instanceof SurfaceGroupLikeModel) {\n        addGroupSizeUpdateList(group);\n      }\n    }),\n  ];\n\n  surface.elementModels.forEach(model => {\n    if (model instanceof SurfaceGroupLikeModel) {\n      addGroupSizeUpdateList(model);\n    }\n  });\n\n  return () => {\n    disposables.forEach(d => d.dispose());\n  };\n};\n\nexport const groupRelationMiddleware: SurfaceMiddleware = (\n  surface: SurfaceBlockModel\n) => {\n  const disposables = [\n    surface.elementUpdated\n      .filter(payload => payload.local)\n      .on(({ id, props }) => {\n        const element = surface.getElementById(id)!;\n\n        // remove the group if it has no children\n        if (element instanceof SurfaceGroupLikeModel && props['childIds']) {\n          if (element.childIds.length === 0) {\n            surface.removeElement(id);\n          }\n        }\n      }),\n  ];\n\n  return () => {\n    disposables.forEach(d => d.dispose());\n  };\n};\n"]}