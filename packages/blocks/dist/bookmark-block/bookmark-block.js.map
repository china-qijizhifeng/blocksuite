{"version":3,"file":"bookmark-block.js","sourceRoot":"","sources":["../../src/bookmark-block/bookmark-block.ts"],"names":[],"mappings":"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","sourcesContent":["import './components/bookmark-card.js';\n\nimport { html } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport { BlockComponent } from '../_common/components/block-component.js';\nimport { EMBED_CARD_HEIGHT, EMBED_CARD_WIDTH } from '../_common/consts.js';\nimport { Bound } from '../surface-block/utils/bound.js';\nimport type { BookmarkBlockModel } from './bookmark-model.js';\nimport type { BookmarkBlockService } from './bookmark-service.js';\nimport { refreshBookmarkUrlData } from './utils.js';\n\n@customElement('affine-bookmark')\nexport class BookmarkBlockComponent extends BlockComponent<\n  BookmarkBlockModel,\n  BookmarkBlockService\n> {\n  get isInSurface() {\n    return this._isInSurface;\n  }\n\n  get edgeless() {\n    if (!this._isInSurface) {\n      return null;\n    }\n    return this.host.querySelector('affine-edgeless-root');\n  }\n\n  private _isInSurface = false;\n\n  private _fetchAbortController?: AbortController;\n\n  override accessor useCaptionEditor = true;\n\n  @property({ attribute: false })\n  accessor loading = false;\n\n  @property({ attribute: false })\n  accessor error = false;\n\n  @query('bookmark-card')\n  accessor bookmarkCard!: HTMLElement;\n\n  open = () => {\n    let link = this.model.url;\n    if (!link.match(/^[a-zA-Z]+:\\/\\//)) {\n      link = 'https://' + link;\n    }\n    window.open(link, '_blank');\n  };\n\n  refreshData = () => {\n    refreshBookmarkUrlData(this, this._fetchAbortController?.signal).catch(\n      console.error\n    );\n  };\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this._fetchAbortController = new AbortController();\n\n    this.contentEditable = 'false';\n\n    const parent = this.host.doc.getParent(this.model);\n    this._isInSurface = parent?.flavour === 'affine:surface';\n\n    this.blockContainerStyles = this._isInSurface\n      ? undefined\n      : { margin: '18px 0' };\n\n    if (!this.model.description && !this.model.title) {\n      this.refreshData();\n    }\n\n    this.disposables.add(\n      this.model.propsUpdated.on(({ key }) => {\n        if (key === 'url') {\n          this.refreshData();\n        }\n      })\n    );\n  }\n\n  override disconnectedCallback(): void {\n    super.disconnectedCallback();\n    this._fetchAbortController?.abort();\n  }\n\n  override renderBlock() {\n    const { style } = this.model;\n\n    let containerStyleMap = styleMap({\n      position: 'relative',\n      width: '100%',\n      minWidth: '450px',\n    });\n\n    if (this.isInSurface) {\n      const width = EMBED_CARD_WIDTH[style];\n      const height = EMBED_CARD_HEIGHT[style];\n      const bound = Bound.deserialize(\n        (this.edgeless?.service.getElementById(this.model.id) ?? this.model)\n          .xywh\n      );\n      const scaleX = bound.w / width;\n      const scaleY = bound.h / height;\n      containerStyleMap = styleMap({\n        width: `${width}px`,\n        height: `${height}px`,\n        transform: `scale(${scaleX}, ${scaleY})`,\n        transformOrigin: '0 0',\n      });\n    }\n\n    return html`\n      <div class=\"affine-bookmark-container\" style=${containerStyleMap}>\n        <bookmark-card\n          .bookmark=${this}\n          .loading=${this.loading}\n          .error=${this.error}\n        ></bookmark-card>\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-bookmark': BookmarkBlockComponent;\n  }\n}\n"]}