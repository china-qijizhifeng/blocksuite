{"version":3,"file":"paragraph-block.js","sourceRoot":"","sources":["../../src/paragraph-block/paragraph-block.ts"],"names":[],"mappings":"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","sourcesContent":["import '../_common/components/rich-text/rich-text.js';\n\nimport type { BlockElement, TextSelection } from '@blocksuite/block-std';\nimport { getInlineRangeProvider } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { InlineRangeProvider } from '@blocksuite/inline';\nimport { html, nothing, type TemplateResult } from 'lit';\nimport { customElement, query } from 'lit/decorators.js';\n\nimport { BlockComponent } from '../_common/components/block-component.js';\nimport { bindContainerHotkey } from '../_common/components/rich-text/keymap/index.js';\nimport type { RichText } from '../_common/components/rich-text/rich-text.js';\nimport { BLOCK_CHILDREN_CONTAINER_PADDING_LEFT } from '../_common/consts.js';\nimport { getViewportElement } from '../_common/utils/query.js';\nimport { EdgelessTextBlockComponent } from '../edgeless-text/edgeless-text-block.js';\nimport { EdgelessRootBlockComponent } from '../root-block/edgeless/edgeless-root-block.js';\nimport type { ParagraphBlockModel } from './paragraph-model.js';\nimport type { ParagraphBlockService } from './paragraph-service.js';\nimport { paragraphBlockStyles } from './styles.js';\n\n@customElement('affine-paragraph')\nexport class ParagraphBlockComponent extends BlockComponent<\n  ParagraphBlockModel,\n  ParagraphBlockService\n> {\n  get inlineManager() {\n    const inlineManager = this.service?.inlineManager;\n    assertExists(inlineManager);\n    return inlineManager;\n  }\n\n  get attributesSchema() {\n    return this.inlineManager.getSchema();\n  }\n\n  get attributeRenderer() {\n    return this.inlineManager.getRenderer();\n  }\n\n  get markdownShortcutHandler() {\n    return this.inlineManager.markdownShortcutHandler;\n  }\n\n  get embedChecker() {\n    return this.inlineManager.embedChecker;\n  }\n\n  override get topContenteditableElement() {\n    if (this.rootElement instanceof EdgelessRootBlockComponent) {\n      const el = this.closest<BlockElement>(\n        'affine-note, affine-edgeless-text'\n      );\n      return el;\n    }\n    return this.rootElement;\n  }\n\n  get inEdgelessText() {\n    return this.topContenteditableElement instanceof EdgelessTextBlockComponent;\n  }\n\n  get inlineEditor() {\n    return this._richTextElement?.inlineEditor;\n  }\n\n  static override styles = paragraphBlockStyles;\n\n  private _inlineRangeProvider: InlineRangeProvider | null = null;\n\n  @query('rich-text')\n  private accessor _richTextElement: RichText | null = null;\n\n  @query('.affine-paragraph-placeholder')\n  private accessor _placeholderContainer: HTMLElement | null = null;\n\n  private _currentTextSelection: TextSelection | undefined = undefined;\n\n  override accessor blockContainerStyles = { margin: '10px 0' };\n\n  //TODO(@Flrande) wrap placeholder in `rich-text` or inline-editor to make it more developer-friendly\n  private _updatePlaceholder = () => {\n    if (\n      !this._placeholderContainer ||\n      !this._richTextElement ||\n      !this.inlineEditor\n    )\n      return;\n\n    const selection = this._currentTextSelection;\n    const isCollapsed = selection?.isCollapsed() ?? false;\n\n    if (\n      this.doc.readonly ||\n      this.inlineEditor.yTextLength > 0 ||\n      this.inlineEditor.isComposing ||\n      !this.selected ||\n      !isCollapsed ||\n      this._isInDatabase()\n    ) {\n      this._placeholderContainer.classList.remove('visible');\n    } else {\n      this._placeholderContainer.classList.add('visible');\n    }\n  };\n\n  private _isInDatabase = () => {\n    let parent = this.parentElement;\n    while (parent && parent !== document.body) {\n      if (parent.tagName.toLowerCase() === 'affine-database') {\n        return true;\n      }\n      parent = parent.parentElement;\n    }\n    return false;\n  };\n\n  override async getUpdateComplete() {\n    const result = await super.getUpdateComplete();\n    await this._richTextElement?.updateComplete;\n    return result;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    bindContainerHotkey(this);\n\n    this._inlineRangeProvider = getInlineRangeProvider(this);\n  }\n\n  override firstUpdated() {\n    this._disposables.add(this.model.propsUpdated.on(this._updatePlaceholder));\n    this._disposables.add(\n      this.host.selection.slots.changed.on(() => {\n        const selection = this.host.selection.find('text');\n\n        if (\n          selection === this._currentTextSelection ||\n          (this._currentTextSelection &&\n            selection &&\n            selection.equals(this._currentTextSelection))\n        ) {\n          return;\n        }\n\n        this._currentTextSelection = selection;\n        this._updatePlaceholder();\n      })\n    );\n\n    this.updateComplete\n      .then(() => {\n        this._updatePlaceholder();\n\n        const inlineEditor = this.inlineEditor;\n        if (!inlineEditor) return;\n        this.disposables.add(\n          inlineEditor.slots.inputting.on(this._updatePlaceholder)\n        );\n      })\n      .catch(console.error);\n  }\n\n  override renderBlock(): TemplateResult<1> {\n    const { type } = this.model;\n    const children = html`<div\n      class=\"affine-block-children-container\"\n      style=\"padding-left: ${BLOCK_CHILDREN_CONTAINER_PADDING_LEFT}px\"\n    >\n      ${this.renderChildren(this.model)}\n    </div>`;\n\n    return html`\n      <div class=\"affine-paragraph-block-container\">\n        <div class=\"affine-paragraph-rich-text-wrapper ${type}\">\n          <rich-text\n            .yText=${this.model.text.yText}\n            .inlineEventSource=${this.topContenteditableElement ?? nothing}\n            .undoManager=${this.doc.history}\n            .attributesSchema=${this.attributesSchema}\n            .attributeRenderer=${this.attributeRenderer}\n            .markdownShortcutHandler=${this.markdownShortcutHandler}\n            .embedChecker=${this.embedChecker}\n            .readonly=${this.doc.readonly}\n            .inlineRangeProvider=${this._inlineRangeProvider}\n            .enableClipboard=${false}\n            .enableUndoRedo=${false}\n            .verticalScrollContainerGetter=${() =>\n              getViewportElement(this.host)}\n          ></rich-text>\n          ${this.inEdgelessText\n            ? nothing\n            : html`\n                <div\n                  contenteditable=\"false\"\n                  class=\"affine-paragraph-placeholder\"\n                >\n                  ${this.service.placeholderGenerator(this.model)}\n                </div>\n              `}\n        </div>\n\n        ${children}\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-paragraph': ParagraphBlockComponent;\n  }\n}\n"]}