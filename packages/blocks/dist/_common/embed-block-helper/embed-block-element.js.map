{"version":3,"file":"embed-block-element.js","sourceRoot":"","sources":["../../../src/_common/embed-block-helper/embed-block-element.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockService } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { BlockModel } from '@blocksuite/store';\nimport type { TemplateResult } from 'lit';\nimport { html, render } from 'lit';\nimport { query } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { DragHandleOption } from '../../root-block/widgets/drag-handle/config.js';\nimport {\n  AFFINE_DRAG_HANDLE_WIDGET,\n  AffineDragHandleWidget,\n} from '../../root-block/widgets/drag-handle/drag-handle.js';\nimport {\n  captureEventTarget,\n  convertDragPreviewDocToEdgeless,\n  convertDragPreviewEdgelessToDoc,\n} from '../../root-block/widgets/drag-handle/utils.js';\nimport { Bound } from '../../surface-block/index.js';\nimport { BlockComponent } from '../components/block-component.js';\nimport { EMBED_CARD_HEIGHT, EMBED_CARD_WIDTH } from '../consts.js';\nimport type { EdgelessSelectableProps } from '../edgeless/mixin/index.js';\nimport {\n  type EmbedCardStyle,\n  getThemeMode,\n  matchFlavours,\n} from '../utils/index.js';\nimport { styles } from './styles.js';\n\nexport class EmbedBlockElement<\n  Model extends\n    BlockModel<EdgelessSelectableProps> = BlockModel<EdgelessSelectableProps>,\n  Service extends BlockService = BlockService,\n  WidgetName extends string = string,\n> extends BlockComponent<Model, Service, WidgetName> {\n  get isInSurface() {\n    return this._isInSurface;\n  }\n\n  get edgeless() {\n    if (!this._isInSurface) {\n      return null;\n    }\n    return this.host.querySelector('affine-edgeless-root');\n  }\n\n  get surface() {\n    if (!this.isInSurface) return null;\n    return this.host.querySelector('affine-surface');\n  }\n\n  get bound(): Bound {\n    return Bound.deserialize(\n      (this.edgeless?.service.getElementById(this.model.id) ?? this.model).xywh\n    );\n  }\n\n  @query('.embed-block-container')\n  protected accessor embedBlock!: HTMLDivElement;\n\n  static override styles = styles;\n\n  private _isInSurface = false;\n\n  private _fetchAbortController = new AbortController();\n\n  get fetchAbortController() {\n    return this._fetchAbortController;\n  }\n\n  private _dragHandleOption: DragHandleOption = {\n    flavour: /affine:embed-*/,\n    edgeless: true,\n    onDragStart: ({ state, startDragging, anchorBlockPath, editorHost }) => {\n      if (!anchorBlockPath) return false;\n      const anchorComponent = editorHost.std.view.getBlock(anchorBlockPath);\n      if (\n        !anchorComponent ||\n        !matchFlavours(anchorComponent.model, [\n          this.flavour as keyof BlockSuite.BlockModels,\n        ])\n      )\n        return false;\n\n      const blockComponent = anchorComponent as this;\n      const element = captureEventTarget(state.raw.target);\n\n      const isDraggingByDragHandle = !!element?.closest(\n        AFFINE_DRAG_HANDLE_WIDGET\n      );\n      const isDraggingByComponent = blockComponent.contains(element);\n      const isInSurface = blockComponent.isInSurface;\n\n      if (!isInSurface && (isDraggingByDragHandle || isDraggingByComponent)) {\n        editorHost.selection.setGroup('note', [\n          editorHost.selection.create('block', {\n            blockId: blockComponent.blockId,\n          }),\n        ]);\n        startDragging([blockComponent], state);\n        return true;\n      } else if (isInSurface && isDraggingByDragHandle) {\n        const embedPortal = blockComponent.closest(\n          '.edgeless-block-portal-embed'\n        );\n        assertExists(embedPortal);\n        const dragPreviewEl = embedPortal.cloneNode() as HTMLElement;\n        dragPreviewEl.style.transform = '';\n        dragPreviewEl.style.left = '0';\n        dragPreviewEl.style.top = '0';\n        render(\n          blockComponent.host.renderModel(blockComponent.model),\n          dragPreviewEl\n        );\n\n        startDragging([blockComponent], state, dragPreviewEl);\n        return true;\n      }\n      return false;\n    },\n    onDragEnd: props => {\n      const { state, draggingElements } = props;\n      if (\n        draggingElements.length !== 1 ||\n        !matchFlavours(draggingElements[0].model, [\n          this.flavour as keyof BlockSuite.BlockModels,\n        ])\n      )\n        return false;\n\n      const blockComponent = draggingElements[0] as this;\n      const isInSurface = blockComponent.isInSurface;\n      const target = captureEventTarget(state.raw.target);\n      const isTargetEdgelessContainer =\n        target?.classList.contains('edgeless') &&\n        target?.classList.contains('affine-block-children-container');\n\n      if (isInSurface) {\n        const style = blockComponent._cardStyle;\n        const targetStyle =\n          style === 'vertical' || style === 'cube' ? 'horizontal' : style;\n        return convertDragPreviewEdgelessToDoc({\n          blockComponent,\n          style: targetStyle,\n          ...props,\n        });\n      } else if (isTargetEdgelessContainer) {\n        const style = blockComponent._cardStyle;\n\n        return convertDragPreviewDocToEdgeless({\n          blockComponent,\n          cssSelector: '.embed-block-container',\n          width: EMBED_CARD_WIDTH[style],\n          height: EMBED_CARD_HEIGHT[style],\n          ...props,\n        });\n      }\n\n      return false;\n    },\n  };\n\n  protected _cardStyle: EmbedCardStyle = 'horizontal';\n\n  protected _width = EMBED_CARD_WIDTH.horizontal;\n\n  protected _height = EMBED_CARD_HEIGHT.horizontal;\n\n  override accessor useCaptionEditor = true;\n\n  override accessor showBlockSelection = false;\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (this._fetchAbortController.signal.aborted)\n      this._fetchAbortController = new AbortController();\n\n    this.contentEditable = 'false';\n\n    const parent = this.host.doc.getParent(this.model);\n    this._isInSurface = parent?.flavour === 'affine:surface';\n\n    this.blockContainerStyles = this.isInSurface\n      ? undefined\n      : { margin: '18px 0' };\n\n    this.disposables.add(\n      AffineDragHandleWidget.registerOption(this._dragHandleOption)\n    );\n  }\n\n  override disconnectedCallback(): void {\n    super.disconnectedCallback();\n    this._fetchAbortController.abort();\n  }\n\n  renderEmbed = (children: () => TemplateResult) => {\n    const theme = getThemeMode();\n    const isSelected = !!this.selected?.is('block');\n\n    if (!this.isInSurface) {\n      return html`\n        <div\n          class=${classMap({\n            'embed-block-container': true,\n            [theme]: true,\n            selected: isSelected,\n          })}\n          style=${styleMap({\n            position: 'relative',\n            width: '100%',\n          })}\n        >\n          ${children()}\n        </div>\n      `;\n    }\n\n    const surface = this.surface;\n    assertExists(surface);\n\n    const width = this._width;\n    const height = this._height;\n    const bound = Bound.deserialize(\n      (this.edgeless?.service.getElementById(this.model.id) ?? this.model).xywh\n    );\n    const scaleX = bound.w / width;\n    const scaleY = bound.h / height;\n\n    return html`\n      <div\n        class=\"embed-block-container\"\n        style=${styleMap({\n          width: `${width}px`,\n          height: `${height}px`,\n          transform: `scale(${scaleX}, ${scaleY})`,\n          transformOrigin: '0 0',\n        })}\n      >\n        ${children()}\n      </div>\n    `;\n  };\n}\n"]}