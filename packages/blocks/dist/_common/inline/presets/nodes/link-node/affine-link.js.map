{"version":3,"file":"affine-link.js","sourceRoot":"","sources":["../../../../../../src/_common/inline/presets/nodes/link-node/affine-link.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockElement } from '@blocksuite/block-std';\nimport { ShadowlessElement } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport {\n  type DeltaInsert,\n  INLINE_ROOT_ATTR,\n  type InlineRootElement,\n  ZERO_WIDTH_SPACE,\n} from '@blocksuite/inline';\nimport { css, html } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { ref } from 'lit/directives/ref.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport { HoverController } from '../../../../components/hover/index.js';\nimport { BLOCK_ID_ATTR } from '../../../../consts.js';\nimport type { AffineTextAttributes } from '../../affine-inline-specs.js';\nimport { affineTextStyles } from '../affine-text.js';\nimport { toggleLinkPopup } from './link-popup/toggle-link-popup.js';\n\n@customElement('affine-link')\nexport class AffineLink extends ShadowlessElement {\n  get link() {\n    const link = this.delta.attributes?.link;\n    if (!link) {\n      return '';\n    }\n    return link;\n  }\n\n  get inlineEditor() {\n    const inlineRoot = this.closest<InlineRootElement<AffineTextAttributes>>(\n      `[${INLINE_ROOT_ATTR}]`\n    );\n    assertExists(inlineRoot);\n    return inlineRoot.inlineEditor;\n  }\n\n  get selfInlineRange() {\n    const selfInlineRange = this.inlineEditor.getInlineRangeFromElement(this);\n    assertExists(selfInlineRange);\n    return selfInlineRange;\n  }\n\n  get blockElement() {\n    const blockElement = this.inlineEditor.rootElement.closest<BlockElement>(\n      `[${BLOCK_ID_ATTR}]`\n    );\n    assertExists(blockElement);\n    return blockElement;\n  }\n\n  get std() {\n    const std = this.blockElement.std;\n    assertExists(std);\n    return std;\n  }\n\n  static override styles = css`\n    affine-link > a:hover [data-v-text='true'] {\n      text-decoration: underline;\n    }\n  `;\n\n  private _whenHover = new HoverController(\n    this,\n    ({ abortController }) => {\n      if (this.blockElement.doc.readonly) {\n        return null;\n      }\n\n      const selection = this.std.selection;\n      const textSelection = selection.find('text');\n      if (\n        !!textSelection &&\n        (!!textSelection.to || !!textSelection.from.length)\n      ) {\n        return null;\n      }\n\n      const blockSelections = selection.filter('block');\n      if (blockSelections.length) {\n        return null;\n      }\n\n      return {\n        template: toggleLinkPopup(\n          this.inlineEditor,\n          'view',\n          this.selfInlineRange,\n          abortController\n        ),\n      };\n    },\n    { enterDelay: 500 }\n  );\n\n  @property({ type: Object })\n  accessor delta: DeltaInsert<AffineTextAttributes> = {\n    insert: ZERO_WIDTH_SPACE,\n  };\n\n  // Workaround for links not working in contenteditable div\n  // see also https://stackoverflow.com/questions/12059211/how-to-make-clickable-anchor-in-contenteditable-div\n  //\n  // Note: We cannot use JS to directly open a new page as this may be blocked by the browser.\n  //\n  // Please also note that when readonly mode active,\n  // this workaround is not necessary and links work normally.\n  // see https://github.com/toeverything/AFFiNE/issues/1540\n  private _onMouseUp() {\n    const anchorElement = this.querySelector('a');\n    assertExists(anchorElement);\n    if (!anchorElement.isContentEditable) return;\n    anchorElement.contentEditable = 'false';\n    setTimeout(() => {\n      anchorElement.removeAttribute('contenteditable');\n    }, 0);\n  }\n\n  override render() {\n    const style = this.delta.attributes\n      ? affineTextStyles(this.delta.attributes, {\n          color: 'var(--affine-link-color)',\n          fill: 'var(--affine-link-color)',\n          'text-decoration': 'none',\n          cursor: 'pointer',\n        })\n      : styleMap({});\n\n    return html`<a\n      ${ref(this._whenHover.setReference)}\n      href=${this.link}\n      rel=\"noopener noreferrer\"\n      target=\"_blank\"\n      style=${style}\n      @mouseup=${this._onMouseUp}\n      ><v-text .str=${this.delta.insert}></v-text\n    ></a>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-link': AffineLink;\n  }\n}\n"]}