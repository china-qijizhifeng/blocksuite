{"version":3,"file":"reference-popup.js","sourceRoot":"","sources":["../../../../../../src/_common/inline/presets/nodes/reference-node/reference-popup.ts"],"names":[],"mappings":"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","sourcesContent":["import '../../../../components/tooltip/tooltip.js';\nimport '../../../../components/button.js';\n\nimport type { BlockElement } from '@blocksuite/block-std';\nimport { WithDisposable } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { InlineRange } from '@blocksuite/inline';\nimport { computePosition, flip, inline, offset, shift } from '@floating-ui/dom';\nimport { html, LitElement, nothing } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\n\nimport type { RootBlockComponent } from '../../../../../root-block/types.js';\nimport { isPeekable, peek } from '../../../../components/index.js';\nimport { createLitPortal } from '../../../../components/portal.js';\nimport { BLOCK_ID_ATTR } from '../../../../consts.js';\nimport { BookmarkIcon, MoreVerticalIcon } from '../../../../icons/index.js';\nimport {\n  CenterPeekIcon,\n  EmbedWebIcon,\n  LinkIcon,\n  OpenIcon,\n} from '../../../../icons/text.js';\nimport { isInsideBlockByFlavour } from '../../../../utils/model.js';\nimport type { AffineInlineEditor } from '../../affine-inline-specs.js';\nimport { ReferencePopupMoreMenu } from './reference-popup-more-menu-popup.js';\nimport { styles } from './styles.js';\n\n@customElement('reference-popup')\nexport class ReferencePopup extends WithDisposable(LitElement) {\n  get referenceDocId() {\n    const docId = this.inlineEditor.getFormat(this.targetInlineRange).reference\n      ?.pageId;\n    assertExists(docId);\n    return docId;\n  }\n\n  get blockElement() {\n    const blockElement = this.inlineEditor.rootElement.closest<BlockElement>(\n      `[${BLOCK_ID_ATTR}]`\n    );\n    assertExists(blockElement);\n    return blockElement;\n  }\n\n  get std() {\n    const std = this.blockElement.std;\n    assertExists(std);\n    return std;\n  }\n\n  get doc() {\n    const doc = this.blockElement.doc;\n    assertExists(doc);\n    return doc;\n  }\n\n  get _embedViewButtonDisabled() {\n    if (\n      this.blockElement.doc.readonly ||\n      isInsideBlockByFlavour(\n        this.blockElement.doc,\n        this.blockElement.model,\n        'affine:edgeless-text'\n      )\n    ) {\n      return true;\n    }\n    return (\n      !!this.blockElement.closest('affine-embed-synced-doc-block') ||\n      this.referenceDocId === this.doc.id\n    );\n  }\n\n  get _openButtonDisabled() {\n    return this.referenceDocId === this.doc.id;\n  }\n\n  static override styles = styles;\n\n  private _moreMenuAbortController: AbortController | null = null;\n\n  @property({ attribute: false })\n  accessor target!: LitElement;\n\n  @property({ attribute: false })\n  accessor inlineEditor!: AffineInlineEditor;\n\n  @property({ attribute: false })\n  accessor targetInlineRange!: InlineRange;\n\n  @property({ attribute: false })\n  accessor docTitle!: string;\n\n  @property({ attribute: false })\n  accessor abortController!: AbortController;\n\n  @query('.affine-reference-popover-container')\n  accessor popupContainer!: HTMLDivElement;\n\n  private _openDoc() {\n    const refDocId = this.referenceDocId;\n    const blockElement = this.blockElement;\n    if (refDocId === blockElement.doc.id) return;\n\n    const rootElement = this.std.view.viewFromPath('block', [\n      blockElement.doc.root?.id ?? '',\n    ]) as RootBlockComponent | null;\n    assertExists(rootElement);\n\n    rootElement.slots.docLinkClicked.emit({ docId: refDocId });\n  }\n\n  private _convertToCardView() {\n    const blockElement = this.blockElement;\n    const doc = blockElement.host.doc;\n    const parent = doc.getParent(blockElement.model);\n    assertExists(parent);\n\n    const index = parent.children.indexOf(blockElement.model);\n    const docId = this.referenceDocId;\n    doc.addBlock(\n      'affine:embed-linked-doc',\n      { pageId: docId },\n      parent,\n      index + 1\n    );\n\n    const totalTextLength = this.inlineEditor.yTextLength;\n    const inlineTextLength = this.targetInlineRange.length;\n    if (totalTextLength === inlineTextLength) {\n      doc.deleteBlock(blockElement.model);\n    } else {\n      this.inlineEditor.insertText(this.targetInlineRange, this.docTitle);\n    }\n\n    this.abortController.abort();\n  }\n\n  private _convertToEmbedView() {\n    const blockElement = this.blockElement;\n    const doc = blockElement.host.doc;\n    const parent = doc.getParent(blockElement.model);\n    assertExists(parent);\n\n    const index = parent.children.indexOf(blockElement.model);\n    const docId = this.referenceDocId;\n    doc.addBlock(\n      'affine:embed-synced-doc',\n      { pageId: docId },\n      parent,\n      index + 1\n    );\n\n    const totalTextLength = this.inlineEditor.yTextLength;\n    const inlineTextLength = this.targetInlineRange.length;\n    if (totalTextLength === inlineTextLength) {\n      doc.deleteBlock(blockElement.model);\n    } else {\n      this.inlineEditor.insertText(this.targetInlineRange, this.docTitle);\n    }\n\n    this.abortController.abort();\n  }\n\n  private _toggleMoreMenu() {\n    if (this._moreMenuAbortController) {\n      this._moreMenuAbortController.abort();\n      this._moreMenuAbortController = null;\n      return;\n    }\n    this._moreMenuAbortController = new AbortController();\n    const referencePopupMoreMenu = new ReferencePopupMoreMenu();\n    referencePopupMoreMenu.target = this.target;\n    referencePopupMoreMenu.abortController = this.abortController;\n    referencePopupMoreMenu.inlineEditor = this.inlineEditor;\n    referencePopupMoreMenu.targetInlineRange = this.targetInlineRange;\n\n    createLitPortal({\n      template: referencePopupMoreMenu,\n      container: this.popupContainer,\n      computePosition: {\n        referenceElement: this.popupContainer,\n        placement: 'top-end',\n        middleware: [flip()],\n        autoUpdate: true,\n      },\n      abortController: this._moreMenuAbortController,\n    });\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (this.targetInlineRange.length === 0) {\n      throw new Error('Cannot toggle reference popup on empty range');\n    }\n\n    const parent = this.blockElement.host.doc.getParent(\n      this.blockElement.model\n    );\n    assertExists(parent);\n\n    this.disposables.add(\n      parent.childrenUpdated.on(() => {\n        const children = parent.children;\n        if (children.includes(this.blockElement.model)) return;\n        this.abortController.abort();\n      })\n    );\n  }\n\n  override updated() {\n    assertExists(this.popupContainer);\n    const range = this.inlineEditor.toDomRange(this.targetInlineRange);\n    assertExists(range);\n\n    const visualElement = {\n      getBoundingClientRect: () => range.getBoundingClientRect(),\n      getClientRects: () => range.getClientRects(),\n    };\n    computePosition(visualElement, this.popupContainer, {\n      middleware: [\n        offset(10),\n        inline(),\n        shift({\n          padding: 6,\n        }),\n      ],\n    })\n      .then(({ x, y }) => {\n        const popupContainer = this.popupContainer;\n        if (!popupContainer) return;\n        popupContainer.style.left = `${x}px`;\n        popupContainer.style.top = `${y}px`;\n      })\n      .catch(console.error);\n  }\n\n  override render() {\n    // synced doc entry controlled by awareness flag\n    const isSyncedDocEnabled = this.doc.awarenessStore.getFlag(\n      'enable_synced_doc_block'\n    );\n\n    return html`\n      <div class=\"overlay-root\">\n        <div class=\"affine-reference-popover-container\">\n          <div class=\"affine-reference-popover view\">\n            <icon-button\n              size=\"24px\"\n              class=\"affine-reference-popover-open-button\"\n              @click=${this._openDoc}\n              ?disabled=${this._openButtonDisabled}\n            >\n              ${OpenIcon}\n              <affine-tooltip .offset=${12}>${'Open this doc'}</affine-tooltip>\n            </icon-button>\n            ${isPeekable(this.target)\n              ? html`<icon-button\n                  size=\"24px\"\n                  class=\"affine-reference-popover-open-button\"\n                  @click=${() => peek(this.target)}\n                >\n                  ${CenterPeekIcon}\n                  <affine-tooltip .offset=${12}\n                    >${'Open in center peek'}</affine-tooltip\n                  >\n                </icon-button>`\n              : nothing}\n\n            <span class=\"affine-reference-popover-dividing-line\"></span>\n\n            <div class=\"affine-reference-popover-view-selector\">\n              <icon-button\n                size=\"24px\"\n                class=\"affine-reference-popover-view-selector-button link current-view\"\n                .hover=${false}\n              >\n                ${LinkIcon}\n                <affine-tooltip .offset=${12}>${'Inline view'}</affine-tooltip>\n              </icon-button>\n\n              <icon-button\n                size=\"24px\"\n                class=\"affine-reference-popover-view-selector-button embed card-view\"\n                .hover=${false}\n                @click=${() => this._convertToCardView()}\n              >\n                ${BookmarkIcon}\n                <affine-tooltip .offset=${12}>${'Card view'}</affine-tooltip>\n              </icon-button>\n\n              ${isSyncedDocEnabled\n                ? html`\n                    <icon-button\n                      size=\"24px\"\n                      class=\"affine-reference-popover-view-selector-button embed embed-view\"\n                      .hover=${false}\n                      @click=${() => this._convertToEmbedView()}\n                      ?disabled=${this._embedViewButtonDisabled}\n                    >\n                      ${EmbedWebIcon}\n                      <affine-tooltip .offset=${12}\n                        >${'Embed view'}</affine-tooltip\n                      >\n                    </icon-button>\n                  `\n                : nothing}\n            </div>\n\n            <span class=\"affine-reference-popover-dividing-line\"></span>\n\n            <icon-button size=\"24px\" @click=${() => this._toggleMoreMenu()}>\n              ${MoreVerticalIcon}\n              <affine-tooltip .offset=${12}>More</affine-tooltip>\n            </icon-button>\n          </div>\n        </div>\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'reference-popup': ReferencePopup;\n  }\n}\n\nexport function toggleReferencePopup(\n  target: LitElement,\n  inlineEditor: AffineInlineEditor,\n  targetInlineRange: InlineRange,\n  docTitle: string,\n  abortController: AbortController\n): ReferencePopup {\n  const popup = new ReferencePopup();\n  popup.target = target;\n  popup.inlineEditor = inlineEditor;\n  popup.targetInlineRange = targetInlineRange;\n  popup.docTitle = docTitle;\n  popup.abortController = abortController;\n\n  document.body.append(popup);\n\n  return popup;\n}\n"]}