{"version":3,"file":"ai-placeholder-node.js","sourceRoot":"","sources":["../../../../../../src/_common/inline/presets/nodes/ai-placeholder/ai-placeholder-node.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * AI 占位符内联组件\n * =====================\n * 功能：\n * 1. 显示为紫色标签\n * 2. 单击进入编辑模式\n * 3. 回车确认、ESC 取消、失焦保存\n * 4. 数据持久化到 Y.Text 的 aiPlaceholder.content\n * \n * 修复：\n * - 单击编辑（不是双击）\n * - 阻止输入内容外泄到编辑器\n * - 正确保存到 Yjs\n * =====================\n */\nimport type { BlockElement } from '@blocksuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport {\n  type DeltaInsert,\n  INLINE_ROOT_ATTR,\n  type InlineRootElement,\n  ZERO_WIDTH_NON_JOINER,\n} from '@blocksuite/inline';\nimport { css, html } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\n\nimport { BLOCK_ID_ATTR } from '../../../../consts.js';\nimport type { AffineTextAttributes } from '../../affine-inline-specs.js';\nimport { AI_PLACEHOLDER_NODE } from '../consts.js';\n\n// 重新导出常量，方便外部使用\nexport { AI_PLACEHOLDER_NODE } from '../consts.js';\n\n/**\n * AI 占位符内联组件\n * =====================\n * 支持直接编辑，双击进入编辑模式\n * 数据通过 delta.attributes.aiPlaceholder.content 存储\n * =====================\n */\n@customElement('affine-ai-placeholder')\nexport class AffineAiPlaceholder extends WithDisposable(ShadowlessElement) {\n  // ========================================\n  // 静态样式定义\n  // ========================================\n  static override styles = css`\n    .affine-ai-placeholder {\n      display: inline-flex;\n      align-items: center;\n      gap: 4px;\n      padding: 2px 10px;\n      margin: 0 2px;\n      background: linear-gradient(135deg, #f3e8ff 0%, #ede9fe 100%);\n      border: 1px solid var(--ai-placeholder-border, #c4b5fd);\n      border-radius: 6px;\n      color: #7c3aed;\n      font-size: 14px;\n      cursor: pointer;\n      user-select: none;\n      vertical-align: baseline;\n      white-space: nowrap;\n    }\n\n    .affine-ai-placeholder:hover {\n      background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);\n      --ai-placeholder-border: #a78bfa;\n    }\n\n    .affine-ai-placeholder[data-selected='true'],\n    .affine-ai-placeholder[data-editing='true'] {\n      --ai-placeholder-border: #a78bfa;\n      box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.3);\n    }\n\n    .affine-ai-placeholder-icon {\n      font-size: 12px;\n      color: #8b5cf6;\n    }\n\n    .affine-ai-placeholder-content {\n      max-width: 200px;\n      overflow: hidden;\n      text-overflow: ellipsis;\n    }\n\n    .affine-ai-placeholder-empty {\n      opacity: 0.6;\n      font-style: italic;\n    }\n\n    .affine-ai-placeholder-input {\n      border: none;\n      background: transparent;\n      color: #7c3aed;\n      font-size: 14px;\n      outline: none;\n      min-width: 60px;\n      max-width: 200px;\n    }\n\n    .affine-ai-placeholder-input::placeholder {\n      color: #a78bfa;\n      font-style: italic;\n    }\n  `;\n\n  // ========================================\n  // Getter 方法（参考 reference-node）\n  // ========================================\n  \n  /**\n   * 获取内联编辑器实例\n   */\n  get inlineEditor() {\n    const inlineRoot = this.closest<InlineRootElement<AffineTextAttributes>>(\n      `[${INLINE_ROOT_ATTR}]`\n    );\n    assertExists(inlineRoot, 'Cannot find inline root element');\n    return inlineRoot.inlineEditor;\n  }\n\n  /**\n   * 获取当前元素的内联范围\n   */\n  get selfInlineRange() {\n    const selfInlineRange = this.inlineEditor.getInlineRangeFromElement(this);\n    assertExists(selfInlineRange, 'Cannot get inline range');\n    return selfInlineRange;\n  }\n\n  /**\n   * 获取所属的 block 元素\n   */\n  get blockElement() {\n    const blockElement = this.inlineEditor.rootElement.closest<BlockElement>(\n      `[${BLOCK_ID_ATTR}]`\n    );\n    assertExists(blockElement, 'Cannot find block element');\n    return blockElement;\n  }\n\n  /**\n   * 获取标准 API\n   */\n  get std() {\n    const std = this.blockElement.std;\n    assertExists(std, 'Cannot get std');\n    return std;\n  }\n\n  /**\n   * 获取文档对象\n   */\n  get doc() {\n    return this.std.doc;\n  }\n\n  /**\n   * 获取占位符显示内容\n   */\n  get placeholderContent(): string {\n    return this.delta.attributes?.aiPlaceholder?.content || '';\n  }\n\n  // ========================================\n  // 属性定义\n  // ========================================\n  \n  /**\n   * Delta 数据\n   * 关键：insert 必须是 AI_PLACEHOLDER_NODE（单个空格字符）\n   */\n  @property({ type: Object })\n  accessor delta: DeltaInsert<AffineTextAttributes> = {\n    insert: AI_PLACEHOLDER_NODE,\n    attributes: {},\n  };\n\n  /**\n   * 是否被选中\n   */\n  @property({ type: Boolean })\n  accessor selected = false;\n\n  /**\n   * 是否处于编辑模式\n   */\n  @state()\n  accessor _editing = false;\n\n  /**\n   * 编辑中的临时值\n   */\n  @state()\n  accessor _editValue = '';\n\n  /**\n   * 是否正在进行中文输入\n   */\n  private _isComposing = false;\n\n  // ========================================\n  // 事件处理\n  // ========================================\n  \n  /**\n   * 单击进入编辑模式\n   * =====================\n   * 修复：改为单击编辑\n   * =====================\n   */\n  private _onClick = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    \n    if (this.doc.readonly) return;\n    if (this._editing) return;\n    \n    this._editing = true;\n    this._editValue = this.placeholderContent;\n    \n    // 聚焦输入框\n    requestAnimationFrame(() => {\n      const input = this.renderRoot.querySelector('.affine-ai-placeholder-input') as HTMLInputElement;\n      if (input) {\n        input.focus();\n        input.select();\n      }\n    });\n  };\n\n  /**\n   * 输入框键盘事件\n   * =====================\n   * 阻止所有键盘事件冒泡，防止内容外泄\n   * 中文输入时不响应 Enter（等待 compositionend）\n   * =====================\n   */\n  private _onKeyDown = (e: KeyboardEvent) => {\n    e.stopPropagation();\n    e.stopImmediatePropagation();\n    \n    // 中文输入时不响应 Enter\n    if (this._isComposing) return;\n    \n    if (e.key === 'Enter') {\n      e.preventDefault();\n      this._saveAndExit();\n    } else if (e.key === 'Escape') {\n      e.preventDefault();\n      this._cancelEdit();\n    }\n  };\n\n  /**\n   * 阻止 keyup 事件冒泡\n   */\n  private _onKeyUp = (e: KeyboardEvent) => {\n    e.stopPropagation();\n    e.stopImmediatePropagation();\n  };\n\n  /**\n   * 阻止 beforeinput 事件冒泡\n   * =====================\n   * 防止输入内容外泄到 BlockSuite 编辑器\n   * =====================\n   */\n  private _onBeforeInput = (e: Event) => {\n    e.stopPropagation();\n    e.stopImmediatePropagation();\n  };\n\n  /**\n   * 中文输入开始\n   */\n  private _onCompositionStart = (e: Event) => {\n    e.stopPropagation();\n    e.stopImmediatePropagation();\n    this._isComposing = true;\n  };\n\n  /**\n   * 中文输入结束\n   */\n  private _onCompositionEnd = (e: Event) => {\n    e.stopPropagation();\n    e.stopImmediatePropagation();\n    this._isComposing = false;\n    // 更新值\n    const input = e.target as HTMLInputElement;\n    this._editValue = input.value;\n  };\n\n  /**\n   * 输入框失焦时保存\n   */\n  private _onBlur = () => {\n    // 延迟一下，避免中文输入时误触发\n    setTimeout(() => {\n      if (this._editing && !this._isComposing) {\n        this._saveAndExit();\n      }\n    }, 100);\n  };\n\n  /**\n   * 输入框值变化\n   * =====================\n   * 阻止事件冒泡，防止外泄\n   * =====================\n   */\n  private _onInput = (e: Event) => {\n    e.stopPropagation();\n    e.stopImmediatePropagation();\n    // 中文输入时在 compositionend 处理\n    if (!this._isComposing) {\n      const input = e.target as HTMLInputElement;\n      this._editValue = input.value;\n    }\n  };\n\n  /**\n   * 保存并退出编辑模式\n   * =====================\n   * 修复：正确保存到 Yjs\n   * 使用 Y.Text 的 format 方法更新属性\n   * =====================\n   */\n  private _saveAndExit() {\n    const newContent = this._editValue.trim();\n    this._editing = false;\n    \n    // 即使内容相同也更新，确保数据一致性\n    try {\n      const inlineRange = this.selfInlineRange;\n      \n      // 使用 formatText 更新 aiPlaceholder 属性\n      this.inlineEditor.formatText(inlineRange, {\n        aiPlaceholder: { content: newContent }\n      });\n      \n      console.log('[AI Placeholder] ✅ 内容已保存到 Yjs:', newContent);\n    } catch (err) {\n      console.error('[AI Placeholder] ❌ 保存失败:', err);\n    }\n  }\n\n  /**\n   * 取消编辑\n   */\n  private _cancelEdit() {\n    this._editing = false;\n    this._editValue = '';\n  };\n\n  // ========================================\n  // 生命周期方法\n  // ========================================\n  \n  /**\n   * 组件连接到 DOM 时\n   * =====================\n   * 关键：验证 insert 值是否正确\n   * 如果不是 AI_PLACEHOLDER_NODE，说明有问题\n   * =====================\n   */\n  override connectedCallback() {\n    super.connectedCallback();\n    \n    // 验证 insert 值（参考 reference-node 的做法）\n    if (this.delta.insert !== AI_PLACEHOLDER_NODE) {\n      console.error(\n        `[AI Placeholder] Node must be initialized with '${AI_PLACEHOLDER_NODE}' (space char), ` +\n        `but got '${this.delta.insert}' (length: ${this.delta.insert.length}). ` +\n        `This may cause cursor issues.`\n      );\n    }\n  }\n\n  // ========================================\n  // 渲染方法\n  // ========================================\n  \n  /**\n   * 渲染组件\n   * =====================\n   * 修复：\n   * 1. 单击进入编辑模式\n   * 2. 添加 beforeinput 阻止内容外泄\n   * 3. 显示文本改为\"点击输入要求\"\n   * =====================\n   */\n  protected override render() {\n    const content = this.placeholderContent;\n    const displayText = content || '点击输入要求';\n    const isEmpty = !content;\n\n    // 编辑模式：显示输入框\n    // 【关键】阻止所有可能导致内容外泄的事件\n    if (this._editing) {\n      return html`<span\n        class=\"affine-ai-placeholder\"\n        data-selected=\"true\"\n        data-editing=\"true\"\n        @click=${(e: Event) => { e.stopPropagation(); e.stopImmediatePropagation(); }}\n        @mousedown=${(e: Event) => { e.stopPropagation(); e.stopImmediatePropagation(); }}\n      >\n        <span class=\"affine-ai-placeholder-icon\">✦</span>\n        <input\n          class=\"affine-ai-placeholder-input\"\n          type=\"text\"\n          .value=${this._editValue}\n          placeholder=\"输入 AI 要求...\"\n          @input=${this._onInput}\n          @keydown=${this._onKeyDown}\n          @keyup=${this._onKeyUp}\n          @keypress=${(e: Event) => { e.stopPropagation(); e.stopImmediatePropagation(); }}\n          @beforeinput=${this._onBeforeInput}\n          @compositionstart=${this._onCompositionStart}\n          @compositionend=${this._onCompositionEnd}\n          @compositionupdate=${(e: Event) => { e.stopPropagation(); e.stopImmediatePropagation(); }}\n          @blur=${this._onBlur}\n          @click=${(e: Event) => { e.stopPropagation(); e.stopImmediatePropagation(); }}\n          @mousedown=${(e: Event) => { e.stopPropagation(); e.stopImmediatePropagation(); }}\n          @mouseup=${(e: Event) => { e.stopPropagation(); e.stopImmediatePropagation(); }}\n          @focus=${(e: Event) => { e.stopPropagation(); e.stopImmediatePropagation(); }}\n        /><v-text .str=${ZERO_WIDTH_NON_JOINER}></v-text>\n      </span>`;\n    }\n\n    // 显示模式：显示标签，单击进入编辑\n    return html`<span\n      class=\"affine-ai-placeholder\"\n      data-selected=${this.selected}\n      @click=${this._onClick}\n    >\n      <span class=\"affine-ai-placeholder-icon\">✦</span>\n      <span class=\"affine-ai-placeholder-content ${isEmpty ? 'affine-ai-placeholder-empty' : ''}\"\n        >${displayText}</span\n      ><v-text .str=${ZERO_WIDTH_NON_JOINER}></v-text>\n    </span>`;\n  }\n}\n\n// ========================================\n// 全局类型声明\n// ========================================\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-ai-placeholder': AffineAiPlaceholder;\n  }\n}\n"]}