{"version":3,"file":"ai-diff-node.js","sourceRoot":"","sources":["../../../../../../src/_common/inline/presets/nodes/ai-diff/ai-diff-node.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * AI Diff ÂÜÖËÅîÁªÑ‰ª∂\n * =====================\n * ÂäüËÉΩÔºö\n * 1. ÊòæÁ§∫ AI ‰øÆÊîπÁöÑÂ∑ÆÂºÇ\n * 2. delete Á±ªÂûãÔºöÁ∫¢Ëâ≤Âà†Èô§Á∫ø\n * 3. insert Á±ªÂûãÔºöÁªøËâ≤È´ò‰∫Æ + Êé•Âèó/ÊãíÁªùÊåâÈíÆ\n * 4. ÁÇπÂáªÊé•ÂèóÔºöÂ∫îÁî®‰øÆÊîπ\n * 5. ÁÇπÂáªÊãíÁªùÔºöÊÅ¢Â§çÂéüÊñá\n * =====================\n */\nimport type { BlockElement } from '@blocksuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport {\n  type DeltaInsert,\n  INLINE_ROOT_ATTR,\n  type InlineRootElement,\n  ZERO_WIDTH_NON_JOINER,\n} from '@blocksuite/inline';\nimport { css, html } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\n\nimport { BLOCK_ID_ATTR } from '../../../../consts.js';\nimport type { AffineTextAttributes } from '../../affine-inline-specs.js';\n\n/**\n * AI Diff ÂÜÖËÅîÁªÑ‰ª∂\n * =====================\n * Ê†πÊçÆ type Â±ûÊÄßÊ∏≤Êüì‰∏çÂêåÊ†∑ÂºèÔºö\n * - delete: Á∫¢Ëâ≤Âà†Èô§Á∫ø\n * - insert: ÁªøËâ≤È´ò‰∫Æ + Êìç‰ΩúÊåâÈíÆ\n * =====================\n */\n@customElement('affine-ai-diff')\nexport class AffineAiDiff extends WithDisposable(ShadowlessElement) {\n  // ========================================\n  // ÈùôÊÄÅÊ†∑ÂºèÂÆö‰πâ\n  // ========================================\n  static override styles = css`\n    /* Âà†Èô§Ê†∑ÂºèÔºöÁ∫¢Ëâ≤Âà†Èô§Á∫ø */\n    .ai-diff-delete {\n      text-decoration: line-through;\n      color: #dc2626;\n      background-color: #fef2f2;\n      padding: 1px 2px;\n      border-radius: 2px;\n    }\n\n    /* ÊèíÂÖ•Ê†∑ÂºèÔºöÁªøËâ≤È´ò‰∫Æ */\n    .ai-diff-insert {\n      color: #166534;\n      background-color: #dcfce7;\n      padding: 1px 2px;\n      border-radius: 2px;\n    }\n\n    /* Êìç‰ΩúÊåâÈíÆÂÆπÂô® */\n    .ai-diff-actions {\n      display: inline-flex;\n      gap: 2px;\n      margin-left: 4px;\n      vertical-align: middle;\n    }\n\n    /* Êìç‰ΩúÊåâÈíÆ */\n    .ai-diff-btn {\n      padding: 2px 6px;\n      border-radius: 4px;\n      border: none;\n      cursor: pointer;\n      font-size: 11px;\n      font-weight: 500;\n      line-height: 1;\n    }\n\n    .ai-diff-btn-accept {\n      background: #dcfce7;\n      color: #16a34a;\n    }\n\n    .ai-diff-btn-accept:hover {\n      background: #bbf7d0;\n    }\n\n    .ai-diff-btn-reject {\n      background: #fee2e2;\n      color: #dc2626;\n    }\n\n    .ai-diff-btn-reject:hover {\n      background: #fecaca;\n    }\n  `;\n\n  // ========================================\n  // Getter ÊñπÊ≥ï\n  // ========================================\n  \n  get inlineEditor() {\n    const inlineRoot = this.closest<InlineRootElement<AffineTextAttributes>>(\n      `[${INLINE_ROOT_ATTR}]`\n    );\n    assertExists(inlineRoot, 'Cannot find inline root element');\n    return inlineRoot.inlineEditor;\n  }\n\n  get selfInlineRange() {\n    const selfInlineRange = this.inlineEditor.getInlineRangeFromElement(this);\n    assertExists(selfInlineRange, 'Cannot get inline range');\n    return selfInlineRange;\n  }\n\n  get blockElement() {\n    const blockElement = this.inlineEditor.rootElement.closest<BlockElement>(\n      `[${BLOCK_ID_ATTR}]`\n    );\n    assertExists(blockElement, 'Cannot find block element');\n    return blockElement;\n  }\n\n  get std() {\n    const std = this.blockElement.std;\n    assertExists(std, 'Cannot get std');\n    return std;\n  }\n\n  get doc() {\n    return this.std.doc;\n  }\n\n  get diffData() {\n    return this.delta.attributes?.aiDiff;\n  }\n\n  // ========================================\n  // Â±ûÊÄßÂÆö‰πâ\n  // ========================================\n  \n  @property({ type: Object })\n  accessor delta: DeltaInsert<AffineTextAttributes> = {\n    insert: '',\n    attributes: {},\n  };\n\n  @property({ type: Boolean })\n  accessor selected = false;\n\n  // ========================================\n  // ‰∫ã‰ª∂Â§ÑÁêÜ\n  // ========================================\n  \n  /**\n   * Êé•Âèó Diff - „Äêv7 ‰øÆÂ§ç„ÄëÂ§ÑÁêÜÊï¥‰∏™ block ‰∏≠ÊâÄÊúâÁõ∏Âêå diffId ÁöÑ delta\n   * =====================\n   * - ÊâæÂà∞ÊâÄÊúâÁõ∏Âêå aiDiff.id ÁöÑ delta\n   * - delete Á±ªÂûãÔºöÂà†Èô§ËøôÊÆµÊñáÊú¨\n   * - insert Á±ªÂûãÔºö‰øùÁïôÊñáÊú¨ÔºåÁßªÈô§ aiDiff Â±ûÊÄß\n   * =====================\n   */\n  private _onAccept = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    \n    const diff = this.diffData;\n    if (!diff) return;\n    \n    const diffId = diff.id;\n    \n    try {\n      // „Äêv7 Ê†∏ÂøÉ„ÄëËé∑ÂèñÊï¥‰∏™ block ÁöÑ textÔºåÂ§ÑÁêÜÊâÄÊúâÁõ∏Âêå diffId ÁöÑ delta\n      const blockElement = this.blockElement;\n      const text = (blockElement.model as any).text;\n      if (!text) {\n        console.warn('[AI Diff] ‚ö†Ô∏è Êó†Ê≥ïËé∑Âèñ block text');\n        return;\n      }\n      \n      const yText = text.yText;\n      const deltas = yText.toDelta();\n      \n      // Êî∂ÈõÜÊâÄÊúâÈúÄË¶ÅÂ§ÑÁêÜÁöÑÊìç‰ΩúÔºà‰ªéÂêéÂæÄÂâçÔºåÈÅøÂÖçÁ¥¢ÂºïÈîô‰π±Ôºâ\n      const operations: Array<{type: 'delete' | 'format', index: number, length: number}> = [];\n      let offset = 0;\n      \n      for (const delta of deltas) {\n        const insertText = delta.insert;\n        const length = typeof insertText === 'string' ? insertText.length : 1;\n        const aiDiff = delta.attributes?.aiDiff;\n        \n        // Âè™Â§ÑÁêÜÁõ∏Âêå diffId ÁöÑ delta\n        if (aiDiff && aiDiff.id === diffId) {\n          if (aiDiff.type === 'delete') {\n            operations.push({ type: 'delete', index: offset, length });\n          } else if (aiDiff.type === 'insert') {\n            operations.push({ type: 'format', index: offset, length });\n          }\n        }\n        offset += length;\n      }\n      \n      console.log(`[AI Diff] üîÑ Êé•ÂèóÊï¥‰∏™ blockÔºåÂÖ± ${operations.length} ‰∏™Êìç‰Ωú:`, diffId);\n      \n      // ‰ªéÂêéÂæÄÂâçÊâßË°åÊìç‰Ωú\n      operations.reverse();\n      for (const op of operations) {\n        if (op.type === 'delete') {\n          text.delete(op.index, op.length);\n        } else {\n          text.format(op.index, op.length, { aiDiff: null });\n        }\n      }\n      \n      console.log('[AI Diff] ‚úÖ Êé•ÂèóÂÆåÊàê:', diffId);\n      \n      // Ëß¶Âèë‰∫ã‰ª∂ÈÄöÁü•Â§ñÈÉ®\n      window.dispatchEvent(new CustomEvent('blocksuite-diff-accept', {\n        detail: { diffId, type: diff.type }\n      }));\n    } catch (err) {\n      console.error('[AI Diff] ‚ùå Êé•ÂèóÂ§±Ë¥•:', err);\n    }\n  };\n\n  /**\n   * ÊãíÁªù Diff - „Äêv7 ‰øÆÂ§ç„ÄëÂ§ÑÁêÜÊï¥‰∏™ block ‰∏≠ÊâÄÊúâÁõ∏Âêå diffId ÁöÑ delta\n   * =====================\n   * - ÊâæÂà∞ÊâÄÊúâÁõ∏Âêå aiDiff.id ÁöÑ delta\n   * - delete Á±ªÂûãÔºö‰øùÁïôÂéüÊñáÔºåÁßªÈô§ aiDiff Â±ûÊÄß\n   * - insert Á±ªÂûãÔºöÂà†Èô§ËøôÊÆµÊñ∞ÊñáÊú¨\n   * =====================\n   */\n  private _onReject = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    \n    const diff = this.diffData;\n    if (!diff) return;\n    \n    const diffId = diff.id;\n    \n    try {\n      // „Äêv7 Ê†∏ÂøÉ„ÄëËé∑ÂèñÊï¥‰∏™ block ÁöÑ textÔºåÂ§ÑÁêÜÊâÄÊúâÁõ∏Âêå diffId ÁöÑ delta\n      const blockElement = this.blockElement;\n      const text = (blockElement.model as any).text;\n      if (!text) {\n        console.warn('[AI Diff] ‚ö†Ô∏è Êó†Ê≥ïËé∑Âèñ block text');\n        return;\n      }\n      \n      const yText = text.yText;\n      const deltas = yText.toDelta();\n      \n      // Êî∂ÈõÜÊâÄÊúâÈúÄË¶ÅÂ§ÑÁêÜÁöÑÊìç‰ΩúÔºà‰ªéÂêéÂæÄÂâçÔºåÈÅøÂÖçÁ¥¢ÂºïÈîô‰π±Ôºâ\n      const operations: Array<{type: 'delete' | 'format', index: number, length: number}> = [];\n      let offset = 0;\n      \n      for (const delta of deltas) {\n        const insertText = delta.insert;\n        const length = typeof insertText === 'string' ? insertText.length : 1;\n        const aiDiff = delta.attributes?.aiDiff;\n        \n        // Âè™Â§ÑÁêÜÁõ∏Âêå diffId ÁöÑ delta\n        if (aiDiff && aiDiff.id === diffId) {\n          if (aiDiff.type === 'insert') {\n            // ÊãíÁªù insert = Âà†Èô§Êñ∞Êñá\n            operations.push({ type: 'delete', index: offset, length });\n          } else if (aiDiff.type === 'delete') {\n            // ÊãíÁªù delete = ‰øùÁïôÂéüÊñáÔºåÁßªÈô§Ê†áËÆ∞\n            operations.push({ type: 'format', index: offset, length });\n          }\n        }\n        offset += length;\n      }\n      \n      console.log(`[AI Diff] üîÑ ÊãíÁªùÊï¥‰∏™ blockÔºåÂÖ± ${operations.length} ‰∏™Êìç‰Ωú:`, diffId);\n      \n      // ‰ªéÂêéÂæÄÂâçÊâßË°åÊìç‰Ωú\n      operations.reverse();\n      for (const op of operations) {\n        if (op.type === 'delete') {\n          text.delete(op.index, op.length);\n        } else {\n          text.format(op.index, op.length, { aiDiff: null });\n        }\n      }\n      \n      console.log('[AI Diff] ‚úÖ ÊãíÁªùÂÆåÊàê:', diffId);\n      \n      // Ëß¶Âèë‰∫ã‰ª∂ÈÄöÁü•Â§ñÈÉ®\n      window.dispatchEvent(new CustomEvent('blocksuite-diff-reject', {\n        detail: { diffId, type: diff.type }\n      }));\n    } catch (err) {\n      console.error('[AI Diff] ‚ùå ÊãíÁªùÂ§±Ë¥•:', err);\n    }\n  };\n\n  // ========================================\n  // Ê∏≤ÊüìÊñπÊ≥ï\n  // ========================================\n  \n  protected override render() {\n    const diff = this.diffData;\n    if (!diff) {\n      return html`<affine-text .delta=${this.delta}></affine-text>`;\n    }\n    \n    const text = this.delta.insert;\n    \n    // Âà†Èô§Á±ªÂûãÔºöÁ∫¢Ëâ≤Âà†Èô§Á∫ø\n    if (diff.type === 'delete') {\n      return html`<span class=\"ai-diff-delete\">${text}<v-text .str=${ZERO_WIDTH_NON_JOINER}></v-text></span>`;\n    }\n    \n    // ÊèíÂÖ•Á±ªÂûãÔºöÁªøËâ≤È´ò‰∫Æ + Êìç‰ΩúÊåâÈíÆ\n    return html`<span class=\"ai-diff-insert\">${text}</span><span class=\"ai-diff-actions\">\n      <button class=\"ai-diff-btn ai-diff-btn-accept\" @click=${this._onAccept} title=\"Êé•Âèó\">‚úì</button>\n      <button class=\"ai-diff-btn ai-diff-btn-reject\" @click=${this._onReject} title=\"ÊãíÁªù\">‚úï</button>\n    </span><v-text .str=${ZERO_WIDTH_NON_JOINER}></v-text>`;\n  }\n}\n\n// ========================================\n// ÂÖ®Â±ÄÁ±ªÂûãÂ£∞Êòé\n// ========================================\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-ai-diff': AffineAiDiff;\n  }\n}\n"]}