{"version":3,"file":"zip.js","sourceRoot":"","sources":["../../../src/_common/transformers/zip.ts"],"names":[],"mappings":"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","sourcesContent":["import { assertExists, sha } from '@blocksuite/global/utils';\nimport type {\n  CollectionInfoSnapshot,\n  Doc,\n  DocCollection,\n  DocSnapshot,\n  JobMiddleware,\n} from '@blocksuite/store';\nimport { extMimeMap, getAssetName, Job } from '@blocksuite/store';\nimport JSZip from 'jszip';\n\nimport { replaceIdMiddleware, titleMiddleware } from './middlewares.js';\n\nasync function exportDocs(collection: DocCollection, docs: Doc[]) {\n  const zip = new JSZip();\n\n  const job = new Job({ collection });\n  const snapshots = await Promise.all(docs.map(job.docToSnapshot));\n\n  const collectionInfo = job.collectionInfoToSnapshot();\n  zip.file('info.json', JSON.stringify(collectionInfo, null, 2));\n\n  snapshots.forEach(snapshot => {\n    const snapshotName = `${snapshot.meta.id}.snapshot.json`;\n    zip.file(snapshotName, JSON.stringify(snapshot, null, 2));\n  });\n\n  const assets = zip.folder('assets');\n  assertExists(assets);\n  const assetsMap = job.assets;\n\n  assetsMap.forEach((blob, id) => {\n    const ext = getAssetName(assetsMap, id).split('.').at(-1);\n    const name = `${id}.${ext}`;\n    assets.file(name, blob);\n  });\n\n  return zip.generateAsync({ type: 'blob' });\n}\n\nasync function importDocs(collection: DocCollection, imported: Blob) {\n  const zip = new JSZip();\n  const { files } = await zip.loadAsync(imported);\n\n  const assetObjs: JSZip.JSZipObject[] = [];\n  const snapshotsObjs: JSZip.JSZipObject[] = [];\n  let infoObj: JSZip.JSZipObject | undefined;\n  let info: CollectionInfoSnapshot | undefined;\n\n  Object.entries(files).map(([name, fileObj]) => {\n    if (name.includes('MACOSX') || name.includes('DS_Store')) {\n      return;\n    }\n\n    if (name.startsWith('assets/') && !fileObj.dir) {\n      assetObjs.push(fileObj);\n      return;\n    }\n\n    if (name === 'info.json') {\n      infoObj = fileObj;\n      return;\n    }\n\n    if (name.endsWith('.snapshot.json')) {\n      snapshotsObjs.push(fileObj);\n      return;\n    }\n  });\n\n  {\n    const json = await infoObj?.async('text');\n    assertExists(json);\n    info = JSON.parse(json) as CollectionInfoSnapshot;\n  }\n\n  const migrationMiddleware: JobMiddleware = ({ slots, collection }) => {\n    slots.afterImport.on(payload => {\n      if (payload.type === 'page') {\n        collection.schema.upgradeDoc(\n          info?.pageVersion ?? 0,\n          {},\n          payload.page.spaceDoc\n        );\n      }\n    });\n  };\n  const job = new Job({\n    collection,\n    middlewares: [replaceIdMiddleware, migrationMiddleware, titleMiddleware],\n  });\n  const assetsMap = job.assets;\n\n  await Promise.all(\n    assetObjs.map(async fileObj => {\n      const nameWithExt = fileObj.name.replace('assets/', '');\n      const assetsId = nameWithExt.replace(/\\.[^/.]+$/, '');\n      const blob = await fileObj.async('blob');\n      const ext = nameWithExt.split('.').at(-1) ?? '';\n      const mime = extMimeMap.get(ext) ?? '';\n      const file = new File([blob], nameWithExt, {\n        type: mime,\n      });\n      assetsMap.set(assetsId, file);\n    })\n  );\n\n  return Promise.all(\n    snapshotsObjs.map(async fileObj => {\n      const json = await fileObj.async('text');\n      const snapshot = JSON.parse(json) as DocSnapshot;\n      const tasks: Promise<void>[] = [];\n\n      job.walk(snapshot, block => {\n        const sourceId = block.props?.sourceId as string | undefined;\n\n        if (sourceId && sourceId.startsWith('/')) {\n          const removeSlashId = sourceId.replace(/^\\//, '');\n\n          if (assetsMap.has(removeSlashId)) {\n            const blob = assetsMap.get(removeSlashId)!;\n\n            tasks.push(\n              blob\n                .arrayBuffer()\n                .then(buffer => sha(buffer))\n                .then(hash => {\n                  assetsMap.set(hash, blob);\n                  block.props.sourceId = hash;\n                })\n            );\n          }\n        }\n      });\n\n      await Promise.all(tasks);\n\n      return job.snapshotToDoc(snapshot);\n    })\n  );\n}\n\nexport const ZipTransformer = {\n  exportDocs,\n  importDocs,\n};\n"]}