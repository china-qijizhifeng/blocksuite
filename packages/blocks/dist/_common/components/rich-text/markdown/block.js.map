{"version":3,"file":"block.js","sourceRoot":"","sources":["../../../../../src/_common/components/rich-text/markdown/block.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockElement } from '@blocksuite/block-std';\nimport { assertExists, isEqual } from '@blocksuite/global/utils';\nimport {\n  KEYBOARD_ALLOW_DEFAULT,\n  KEYBOARD_PREVENT_DEFAULT,\n} from '@blocksuite/inline';\n\nimport {\n  asyncSetInlineRange,\n  matchFlavours,\n} from '../../../../_common/utils/index.js';\nimport { getStandardLanguage } from '../../../../code-block/utils/code-languages.js';\nimport { FALLBACK_LANG } from '../../../../code-block/utils/consts.js';\nimport type { ParagraphBlockModel } from '../../../../paragraph-block/index.js';\nimport type { AffineInlineEditor } from '../../../inline/presets/affine-inline-specs.js';\nimport {\n  convertToDivider,\n  convertToList,\n  convertToParagraph,\n} from './utils.js';\n\nexport function tryConvertBlock(\n  element: BlockElement,\n  inline: AffineInlineEditor,\n  prefixText: string,\n  range: { index: number; length: number }\n) {\n  const { model } = element;\n  if (\n    !prefixText.match(\n      /^(\\d+\\.|-|\\*|\\[ ?\\]|\\[x\\]|(#){1,6}|(-){3}|(\\*){3}|>|```([a-zA-Z0-9]*))$/\n    )\n  ) {\n    return KEYBOARD_ALLOW_DEFAULT;\n  }\n\n  const { lineIndex, rangeIndexRelatedToLine } = inline.getLine(range.index);\n  if (lineIndex !== 0 || rangeIndexRelatedToLine > prefixText.length) {\n    return KEYBOARD_ALLOW_DEFAULT;\n  }\n  const isParagraph = matchFlavours(model, ['affine:paragraph']);\n  const isHeading = isParagraph && model.type.startsWith('h');\n  const isParagraphQuoteBlock = isParagraph && isEqual(model.type, 'quote');\n  const isCodeBlock = matchFlavours(model, ['affine:code']);\n  if (isHeading || isParagraphQuoteBlock || isCodeBlock) {\n    return KEYBOARD_ALLOW_DEFAULT;\n  }\n\n  // try to add code block\n  const codeMatch = prefixText.match(/^```([a-zA-Z0-9]*)$/g);\n  if (codeMatch) {\n    if (\n      model.flavour === 'affine:paragraph' &&\n      (model as ParagraphBlockModel).type === 'quote'\n    ) {\n      return KEYBOARD_ALLOW_DEFAULT;\n    }\n\n    const doc = model.doc;\n    doc.captureSync();\n\n    const parent = doc.getParent(model);\n    assertExists(parent);\n    const index = parent.children.indexOf(model);\n\n    const codeId = doc.addBlock(\n      'affine:code',\n      {\n        language:\n          getStandardLanguage(codeMatch[0].slice(3))?.id ?? FALLBACK_LANG,\n      },\n      parent,\n      index\n    );\n    if (model.text && model.text.length > prefixText.length) {\n      const text = model.text.clone();\n      doc.addBlock('affine:paragraph', { text }, parent, index + 1);\n      text.delete(0, prefixText.length);\n    }\n    doc.deleteBlock(model, {\n      bringChildrenTo: parent,\n    });\n\n    const codeBlock = doc.getBlockById(codeId);\n    assertExists(codeBlock);\n    asyncSetInlineRange(element.host, codeBlock, { index: 0, length: 0 }).catch(\n      console.error\n    );\n\n    return KEYBOARD_PREVENT_DEFAULT;\n  }\n\n  let isConverted = false;\n  switch (prefixText.trim()) {\n    case '[]':\n    case '[ ]':\n      isConverted = convertToList(element, 'todo', prefixText, {\n        checked: false,\n      });\n      break;\n    case '[x]':\n      isConverted = convertToList(element, 'todo', prefixText, {\n        checked: true,\n      });\n      break;\n    case '-':\n    case '*':\n      isConverted = convertToList(element, 'bulleted', prefixText);\n      break;\n    case '***':\n    case '---':\n      isConverted = convertToDivider(element, prefixText);\n      break;\n    case '#':\n      isConverted = convertToParagraph(element, 'h1', prefixText);\n      break;\n    case '##':\n      isConverted = convertToParagraph(element, 'h2', prefixText);\n      break;\n    case '###':\n      isConverted = convertToParagraph(element, 'h3', prefixText);\n      break;\n    case '####':\n      isConverted = convertToParagraph(element, 'h4', prefixText);\n      break;\n    case '#####':\n      isConverted = convertToParagraph(element, 'h5', prefixText);\n      break;\n    case '######':\n      isConverted = convertToParagraph(element, 'h6', prefixText);\n      break;\n    case '>':\n      isConverted = convertToParagraph(element, 'quote', prefixText);\n      break;\n    default:\n      isConverted = convertToList(element, 'numbered', prefixText);\n  }\n\n  return isConverted ? KEYBOARD_PREVENT_DEFAULT : KEYBOARD_ALLOW_DEFAULT;\n}\n"]}