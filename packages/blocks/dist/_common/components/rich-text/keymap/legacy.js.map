{"version":3,"file":"legacy.js","sourceRoot":"","sources":["../../../../../src/_common/components/rich-text/keymap/legacy.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,YAAY,EAAE,MAAM,0BAA0B,CAAC;AACxD,OAAO,EAEL,sBAAsB,EACtB,wBAAwB,GACzB,MAAM,oBAAoB,CAAC;AAG5B,OAAO,EAAE,aAAa,EAAE,MAAM,oCAAoC,CAAC;AAEnE,OAAO,EACL,mBAAmB,EACnB,gBAAgB,EAChB,0BAA0B,EAC1B,wBAAwB,EACxB,cAAc,GACf,MAAM,4BAA4B,CAAC;AAEpC,SAAS,uBAAuB,CAAC,YAAgC;IAC/D,MAAM,WAAW,GAAG,YAAY,CAAC,cAAc,EAAE,CAAC;IAClD,OAAO,WAAW,EAAE,KAAK,KAAK,CAAC,IAAI,WAAW,EAAE,MAAM,KAAK,CAAC,CAAC;AAC/D,CAAC;AAED,SAAS,qBAAqB,CAAC,YAAgC;IAC7D,MAAM,WAAW,GAAG,YAAY,CAAC,cAAc,EAAE,CAAC;IAClD,OAAO,CACL,WAAW,EAAE,KAAK,KAAK,YAAY,CAAC,KAAK,CAAC,MAAM;QAChD,WAAW,EAAE,MAAM,KAAK,CAAC,CAC1B,CAAC;AACJ,CAAC;AAED,MAAM,UAAU,WAAW,CACzB,WAAwB,EACxB,YAAgC;IAEhC,YAAY,CAAC,UAAU,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;IAC3C,YAAY,CAAC,cAAc,CAAC;QAC1B,KAAK,EAAE,WAAW,CAAC,KAAK,GAAG,CAAC;QAC5B,MAAM,EAAE,CAAC;KACV,CAAC,CAAC;IACH,OAAO,wBAAwB,CAAC;AAClC,CAAC;AAED,MAAM,UAAU,SAAS,CACvB,UAAsB,EACtB,KAAiB,EACjB,KAAkB;AAClB;;GAEG;AACH,YAAgC,EAChC,CAAgB,EAChB,QAAQ,GAAG,KAAK;IAEhB,MAAM,GAAG,GAAG,KAAK,CAAC,GAAG,CAAC;IACtB,CAAC,CAAC,eAAe,EAAE,CAAC;IACpB,MAAM,MAAM,GAAG,GAAG,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;IACpC,MAAM,WAAW,GAAG,MAAM,EAAE,SAAS,EAAE,KAAK,KAAK,CAAC;IAClD,MAAM,WAAW,GACf,aAAa,CAAC,KAAK,EAAE,CAAC,aAAa,CAAC,CAAC,IAAI,KAAK,CAAC,IAAI,CAAC,MAAM,KAAK,CAAC,CAAC;IAEnE,YAAY,CAAC,KAAK,CAAC,IAAI,EAAE,6CAA6C,CAAC,CAAC;IACxE,IACE,WAAW;QACX,MAAM;QACN,aAAa,CAAC,MAAM,EAAE,CAAC,aAAa,EAAE,iBAAiB,CAAC,CAAC;QACzD,KAAK,CAAC,QAAQ,CAAC,MAAM,KAAK,CAAC,EAC3B,CAAC;QACD,sEAAsE;QACtE,mDAAmD;QACnD,EAAE;QACF,SAAS;QACT,SAAS;QACT,sBAAsB;QACtB,EAAE;QACF,QAAQ;QACR,SAAS;QACT,6CAA6C;QAC7C,wBAAwB,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;QAC5C,OAAO,wBAAwB,CAAC;IAClC,CAAC;IACD,IAAI,WAAW,IAAI,WAAW,EAAE,CAAC;QAC/B,SAAS;QACT,UAAU;QACV,wBAAwB;QACxB,EAAE;QACF,QAAQ;QACR,UAAU;QACV,kCAAkC;QAClC,cAAc,CAAC,UAAU,EAAE,KAAK,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC;QAC/C,OAAO,wBAAwB,CAAC;IAClC,CAAC;IACD,MAAM,KAAK,GAAG,KAAK,CAAC,IAAI,CAAC,MAAM,KAAK,KAAK,CAAC,KAAK,CAAC;IAChD,MAAM,aAAa,GAAG,eAAe,CAAC,KAAK,CAAC,CAAC;IAC7C,IAAI,KAAK,IAAI,aAAa,EAAE,CAAC;QAC3B,IAAI,aAAa,CAAC,KAAK,EAAE,CAAC,aAAa,CAAC,CAAC,EAAE,CAAC;YAC1C,IAAI,QAAQ,EAAE,CAAC;gBACb,mCAAmC;gBACnC,mBAAmB,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;gBACvC,OAAO,wBAAwB,CAAC;YAClC,CAAC;YAED,sDAAsD;YACtD,WAAW,CAAC,KAAK,EAAE,YAAY,CAAC,CAAC;YACjC,OAAO,wBAAwB,CAAC;QAClC,CAAC;QAED,MAAM,OAAO,GAAG,KAAK,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;QACtC,MAAM,oBAAoB,GAAG,OAAO,KAAK,IAAI,IAAI,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QACxE,MAAM,eAAe,GAAG,aAAa,IAAI,CAAC,oBAAoB,CAAC;QAE/D,IAAI,eAAe,IAAI,QAAQ,EAAE,CAAC;YAChC,WAAW,CAAC,KAAK,EAAE,YAAY,CAAC,CAAC;YACjC,OAAO,wBAAwB,CAAC;QAClC,CAAC;QAED,oCAAoC;QACpC,SAAS;QACT,IAAI;QACJ,sBAAsB;QACtB,EAAE;QACF,QAAQ;QACR,UAAU;QACV,kCAAkC;QAClC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC;QACtC,mBAAmB,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;QACvC,OAAO,wBAAwB,CAAC;IAClC,CAAC;IACD,IAAI,KAAK,IAAI,QAAQ,EAAE,CAAC;QACtB,mBAAmB,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;QACvC,OAAO,wBAAwB,CAAC;IAClC,CAAC;IACD,MAAM,gBAAgB,GAAG,eAAe,CAAC,KAAK,CAAC,CAAC;IAChD,IAAI,gBAAgB,EAAE,CAAC;QACrB,WAAW,CAAC,KAAK,EAAE,YAAY,CAAC,CAAC;QACjC,OAAO,wBAAwB,CAAC;IAClC,CAAC;IACD,gBAAgB,CAAC,UAAU,EAAE,KAAK,EAAE,KAAK,CAAC,KAAK,EAAE,KAAK,CAAC,MAAM,CAAC,EAAE,KAAK,CACnE,OAAO,CAAC,KAAK,CACd,CAAC;IACF,OAAO,wBAAwB,CAAC;AAClC,CAAC;AAED,6CAA6C;AAC7C,2HAA2H;AAC3H,sFAAsF;AACtF,6CAA6C;AAC7C,SAAS,eAAe,CAAC,KAAiB;IACxC,IAAI,aAAa,CAAC,KAAK,EAAE,CAAC,aAAa,CAAC,CAAC;QAAE,OAAO,IAAI,CAAC;IACvD,IAAI,aAAa,CAAC,KAAK,EAAE,CAAC,kBAAkB,CAAC,CAAC,EAAE,CAAC;QAC/C,OAAO,KAAK,CAAC,IAAI,KAAK,OAAO,CAAC;IAChC,CAAC;IACD,OAAO,KAAK,CAAC;AACf,CAAC;AAED,MAAM,UAAU,WAAW,CACzB,UAAsB,EACtB,KAAiB,EACjB,CAAgB,EAChB,YAAgC;IAEhC,IAAI,uBAAuB,CAAC,YAAY,CAAC,EAAE,CAAC;QAC1C,IAAI,KAAK,CAAC,OAAO,KAAK,aAAa,EAAE,CAAC;YACpC,OAAO,sBAAsB,CAAC;QAChC,CAAC;QACD,CAAC,CAAC,eAAe,EAAE,CAAC;QACpB,wBAAwB,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;QAC5C,OAAO,wBAAwB,CAAC;IAClC,CAAC;IACD,CAAC,CAAC,eAAe,EAAE,CAAC;IACpB,OAAO,sBAAsB,CAAC;AAChC,CAAC;AAED,MAAM,UAAU,eAAe,CAC7B,UAAsB,EACtB,KAAiB,EACjB,CAAgB,EAChB,YAAgC;IAEhC,CAAC,CAAC,eAAe,EAAE,CAAC;IACpB,IAAI,qBAAqB,CAAC,YAAY,CAAC,EAAE,CAAC;QACxC,0BAA0B,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;QAC9C,OAAO,wBAAwB,CAAC;IAClC,CAAC;IACD,OAAO,sBAAsB,CAAC;AAChC,CAAC","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport {\n  type InlineRange,\n  KEYBOARD_ALLOW_DEFAULT,\n  KEYBOARD_PREVENT_DEFAULT,\n} from '@blocksuite/inline';\nimport type { BlockModel } from '@blocksuite/store';\n\nimport { matchFlavours } from '../../../../_common/utils/model.js';\nimport type { AffineInlineEditor } from '../../../inline/presets/affine-inline-specs.js';\nimport {\n  handleBlockEndEnter,\n  handleBlockSplit,\n  handleLineEndForwardDelete,\n  handleLineStartBackspace,\n  handleUnindent,\n} from '../rich-text-operations.js';\n\nfunction isCollapsedAtBlockStart(inlineEditor: AffineInlineEditor) {\n  const inlineRange = inlineEditor.getInlineRange();\n  return inlineRange?.index === 0 && inlineRange?.length === 0;\n}\n\nfunction isCollapsedAtBlockEnd(inlineEditor: AffineInlineEditor) {\n  const inlineRange = inlineEditor.getInlineRange();\n  return (\n    inlineRange?.index === inlineEditor.yText.length &&\n    inlineRange?.length === 0\n  );\n}\n\nexport function onSoftEnter(\n  inlineRange: InlineRange,\n  inlineEditor: AffineInlineEditor\n) {\n  inlineEditor.insertText(inlineRange, '\\n');\n  inlineEditor.setInlineRange({\n    index: inlineRange.index + 1,\n    length: 0,\n  });\n  return KEYBOARD_PREVENT_DEFAULT;\n}\n\nexport function hardEnter(\n  editorHost: EditorHost,\n  model: BlockModel,\n  range: InlineRange,\n  /**\n   * @deprecated\n   */\n  inlineEditor: AffineInlineEditor,\n  e: KeyboardEvent,\n  shortKey = false\n) {\n  const doc = model.doc;\n  e.stopPropagation();\n  const parent = doc.getParent(model);\n  const isLastChild = parent?.lastChild() === model;\n  const isEmptyList =\n    matchFlavours(model, ['affine:list']) && model.text.length === 0;\n\n  assertExists(model.text, 'Failed to hardEnter! model.text not exists!');\n  if (\n    isEmptyList &&\n    parent &&\n    matchFlavours(parent, ['affine:note', 'affine:database']) &&\n    model.children.length === 0\n  ) {\n    // TODO use `handleLineStartBackspace` directly is not concise enough,\n    // we should extract a function to handle this case\n    //\n    // Before\n    // - list\n    // - | <-- press Enter\n    //\n    // After\n    // - list\n    // |   <-- will replace with a new text block\n    handleLineStartBackspace(editorHost, model);\n    return KEYBOARD_PREVENT_DEFAULT;\n  }\n  if (isEmptyList && isLastChild) {\n    // Before\n    // - line1\n    //   - ↩ <-- press Enter\n    //\n    // After\n    // - line1\n    // - | <-- will unindent the block\n    handleUnindent(editorHost, model, range.index);\n    return KEYBOARD_PREVENT_DEFAULT;\n  }\n  const isEnd = model.text.length === range.index;\n  const softEnterable = isSoftEnterable(model);\n  if (isEnd && softEnterable) {\n    if (matchFlavours(model, ['affine:code'])) {\n      if (shortKey) {\n        // shortKey+Enter to exit the block\n        handleBlockEndEnter(editorHost, model);\n        return KEYBOARD_PREVENT_DEFAULT;\n      }\n\n      // add a new line to the block when press Enter solely\n      onSoftEnter(range, inlineEditor);\n      return KEYBOARD_PREVENT_DEFAULT;\n    }\n\n    const textStr = model.text.toString();\n    const endWithTwoBlankLines = textStr === '\\n' || textStr.endsWith('\\n');\n    const shouldSoftEnter = softEnterable && !endWithTwoBlankLines;\n\n    if (shouldSoftEnter || shortKey) {\n      onSoftEnter(range, inlineEditor);\n      return KEYBOARD_PREVENT_DEFAULT;\n    }\n\n    // delete the \\n at the end of block\n    // Before\n    // >\n    // > ↩ <-- press Enter\n    //\n    // After\n    // - line1\n    // - | <-- will unindent the block\n    model.text.delete(range.index - 1, 1);\n    handleBlockEndEnter(editorHost, model);\n    return KEYBOARD_PREVENT_DEFAULT;\n  }\n  if (isEnd || shortKey) {\n    handleBlockEndEnter(editorHost, model);\n    return KEYBOARD_PREVENT_DEFAULT;\n  }\n  const isSoftEnterBlock = isSoftEnterable(model);\n  if (isSoftEnterBlock) {\n    onSoftEnter(range, inlineEditor);\n    return KEYBOARD_PREVENT_DEFAULT;\n  }\n  handleBlockSplit(editorHost, model, range.index, range.length)?.catch(\n    console.error\n  );\n  return KEYBOARD_PREVENT_DEFAULT;\n}\n\n// If a block is soft enterable, the rule is:\n// 1. In the end of block, first press Enter will insert a \\n to break the line, second press Enter will insert a new block\n// 2. In the middle and start of block, press Enter will insert a \\n to break the line\n// TODO this should be configurable per-block\nfunction isSoftEnterable(model: BlockModel) {\n  if (matchFlavours(model, ['affine:code'])) return true;\n  if (matchFlavours(model, ['affine:paragraph'])) {\n    return model.type === 'quote';\n  }\n  return false;\n}\n\nexport function onBackspace(\n  editorHost: EditorHost,\n  model: BlockModel,\n  e: KeyboardEvent,\n  inlineEditor: AffineInlineEditor\n) {\n  if (isCollapsedAtBlockStart(inlineEditor)) {\n    if (model.flavour === 'affine:code') {\n      return KEYBOARD_ALLOW_DEFAULT;\n    }\n    e.stopPropagation();\n    handleLineStartBackspace(editorHost, model);\n    return KEYBOARD_PREVENT_DEFAULT;\n  }\n  e.stopPropagation();\n  return KEYBOARD_ALLOW_DEFAULT;\n}\n\nexport function onForwardDelete(\n  editorHost: EditorHost,\n  model: BlockModel,\n  e: KeyboardEvent,\n  inlineEditor: AffineInlineEditor\n) {\n  e.stopPropagation();\n  if (isCollapsedAtBlockEnd(inlineEditor)) {\n    handleLineEndForwardDelete(editorHost, model);\n    return KEYBOARD_PREVENT_DEFAULT;\n  }\n  return KEYBOARD_ALLOW_DEFAULT;\n}\n"]}