{"version":3,"file":"utils.js","sourceRoot":"","sources":["../../../src/_common/components/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport { assertExists, sleep } from '@blocksuite/global/utils';\nimport type { InlineEditor } from '@blocksuite/inline';\nimport { BlockModel } from '@blocksuite/store';\nimport { css, unsafeCSS } from 'lit';\n\nimport { isControlledKeyboardEvent } from '../../_common/utils/event.js';\nimport { getInlineEditorByModel } from '../../_common/utils/query.js';\nimport { getCurrentNativeRange } from '../../_common/utils/selection.js';\nimport type { AffineInlineEditor } from '../inline/presets/affine-inline-specs.js';\n\nexport const createKeydownObserver = ({\n  target,\n  inlineEditor,\n  onUpdateQuery,\n  onMove,\n  onConfirm,\n  onEsc,\n  interceptor = (_, next) => next(),\n  abortController,\n}: {\n  target: HTMLElement;\n  inlineEditor: InlineEditor;\n  onUpdateQuery: (val: string) => void;\n  onMove: (step: 1 | -1) => void;\n  onConfirm: () => void;\n  onEsc?: () => void;\n  interceptor?: (e: KeyboardEvent, next: () => void) => void;\n  abortController: AbortController;\n}) => {\n  let query = '';\n  const startIndex = inlineEditor?.getInlineRange()?.index ?? 0;\n\n  const updateQuery = async () => {\n    // Wait for text update\n    await sleep(0);\n    const range = getCurrentNativeRange();\n    if (!range) {\n      abortController.abort();\n      return;\n    }\n    if (range.startContainer !== range.endContainer) {\n      console.warn(\n        'Failed to parse query! Current range is not collapsed.',\n        range\n      );\n      abortController.abort();\n      return;\n    }\n    const textNode = range.startContainer;\n    if (textNode.nodeType !== Node.TEXT_NODE) {\n      console.warn(\n        'Failed to parse query! Current range is not a text node.',\n        range\n      );\n      abortController.abort();\n      return;\n    }\n    const curIndex = inlineEditor.getInlineRange()?.index ?? 0;\n    const text = inlineEditor.yText.toString();\n    const previousQuery = query;\n    query = text.slice(startIndex, curIndex);\n\n    if (query !== previousQuery) {\n      onUpdateQuery(query);\n    }\n  };\n\n  const keyDownListener = (e: KeyboardEvent) => {\n    if (e.defaultPrevented) return;\n\n    if (isControlledKeyboardEvent(e)) {\n      const isOnlyCmd = (e.ctrlKey || e.metaKey) && !e.altKey && !e.shiftKey;\n      // Ctrl/Cmd + alphabet key\n      if (isOnlyCmd && e.key.length === 1) {\n        switch (e.key) {\n          // Previous command\n          case 'p': {\n            onMove(-1);\n            e.stopPropagation();\n            e.preventDefault();\n            return;\n          }\n          // Next command\n          case 'n': {\n            onMove(1);\n            e.stopPropagation();\n            e.preventDefault();\n            return;\n          }\n        }\n      }\n\n      // Pressing **only** modifier key is allowed and will be ignored\n      // Because we don't know the user's intention\n      // Aborting here will cause the above hotkeys to not work\n      if (e.key === 'Control' || e.key === 'Meta' || e.key === 'Alt') {\n        e.stopPropagation();\n        return;\n      }\n\n      // Abort when press modifier key + any other key to avoid weird behavior\n      // e.g. press ctrl + a to select all or press ctrl + v to paste\n      abortController.abort();\n      return;\n    }\n\n    e.stopPropagation();\n\n    if (\n      // input abc, 123, etc.\n      (!isControlledKeyboardEvent(e) && e.key.length === 1) ||\n      e.isComposing\n    ) {\n      updateQuery().catch(console.error);\n      return;\n    }\n\n    switch (e.key) {\n      case 'Escape': {\n        abortController.abort();\n        return;\n      }\n      case 'Backspace': {\n        if (!query.length) {\n          abortController.abort();\n        }\n        updateQuery().catch(console.error);\n        return;\n      }\n      case 'Enter': {\n        if (e.shiftKey) {\n          abortController.abort();\n          return;\n        }\n        onConfirm();\n        e.preventDefault();\n        return;\n      }\n      case 'Tab': {\n        if (e.shiftKey) {\n          onMove(-1);\n        } else {\n          onMove(1);\n        }\n        e.preventDefault();\n        return;\n      }\n      case 'ArrowUp': {\n        if (e.shiftKey) {\n          abortController.abort();\n          return;\n        }\n        onMove(-1);\n        e.preventDefault();\n        return;\n      }\n      case 'ArrowDown': {\n        if (e.shiftKey) {\n          abortController.abort();\n          return;\n        }\n        onMove(1);\n        e.preventDefault();\n        return;\n      }\n      case 'ArrowLeft':\n      case 'ArrowRight': {\n        abortController.abort();\n        return;\n      }\n      default:\n        // Other control keys\n        return;\n    }\n  };\n\n  target.addEventListener(\n    'keydown',\n    (e: KeyboardEvent) => interceptor(e, () => keyDownListener(e)),\n    {\n      // Workaround: Use capture to prevent the event from triggering the keyboard bindings action\n      capture: true,\n      signal: abortController.signal,\n    }\n  );\n\n  // Fix composition input\n  target.addEventListener(\n    'input',\n    () => {\n      updateQuery().catch(console.error);\n    },\n    {\n      signal: abortController.signal,\n    }\n  );\n\n  if (onEsc) {\n    const escListener = (e: KeyboardEvent) => {\n      if (e.key === 'Escape') {\n        onEsc();\n      }\n    };\n    window.addEventListener('keydown', escListener, {\n      signal: abortController.signal,\n    });\n  }\n};\n\n/**\n * Remove specified text from the current range.\n */\nexport function cleanSpecifiedTail(\n  editorHost: EditorHost,\n  inlineEditorOrModel: AffineInlineEditor | BlockModel,\n  str: string\n) {\n  if (!str) {\n    console.warn('Failed to clean text! Unexpected empty string');\n    return;\n  }\n  const inlineEditor =\n    inlineEditorOrModel instanceof BlockModel\n      ? getInlineEditorByModel(editorHost, inlineEditorOrModel)\n      : inlineEditorOrModel;\n  assertExists(inlineEditor, 'Inline editor not found');\n\n  const inlineRange = inlineEditor.getInlineRange();\n  assertExists(inlineRange);\n  const idx = inlineRange.index - str.length;\n  const textStr = inlineEditor.yText.toString().slice(idx, idx + str.length);\n  if (textStr !== str) {\n    console.warn(\n      `Failed to clean text! Text mismatch expected: ${str} but actual: ${textStr}`\n    );\n    return;\n  }\n  inlineEditor.deleteText({ index: idx, length: str.length });\n  inlineEditor.setInlineRange({\n    index: idx,\n    length: 0,\n  });\n}\n\n/**\n * You should add a container before the scrollbar style to prevent the style pollution of the whole doc.\n */\nexport const scrollbarStyle = (container: string) => {\n  if (!container)\n    throw new Error(\n      'To prevent style pollution of the whole doc, you must add a container before the scrollbar style.'\n    );\n\n  // sanitize container name\n  if (\n    container.length > 50 ||\n    container.includes('{') ||\n    container.includes('}')\n  )\n    throw new Error('Invalid container name!');\n\n  return css`\n    ${unsafeCSS(container)} {\n      scrollbar-gutter: stable;\n    }\n    ${unsafeCSS(container)}::-webkit-scrollbar {\n      -webkit-appearance: none;\n      width: 4px;\n    }\n    ${unsafeCSS(container)}::-webkit-scrollbar-thumb {\n      border-radius: 2px;\n      background-color: #b1b1b1;\n    }\n    ${unsafeCSS(container)}::-webkit-scrollbar-corner {\n      display: none;\n    }\n  `;\n};\n"]}