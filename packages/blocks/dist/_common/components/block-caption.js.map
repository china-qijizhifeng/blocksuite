{"version":3,"file":"block-caption.js","sourceRoot":"","sources":["../../../src/_common/components/block-caption.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockElement } from '@blocksuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport type { BlockModel } from '@blocksuite/store';\nimport { Text } from '@blocksuite/store';\nimport { css, html, nothing } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\n\nimport { stopPropagation } from '../utils/event.js';\nimport { asyncFocusRichText } from '../utils/selection.js';\n\nexport interface BlockCaptionProps {\n  caption: string | null | undefined;\n}\n\n@customElement('block-caption-editor')\nexport class BlockCaptionEditor<\n  Model extends BlockModel<BlockCaptionProps> = BlockModel<BlockCaptionProps>,\n> extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    .block-caption-editor {\n      display: inline-table;\n      resize: none;\n      width: 100%;\n      outline: none;\n      border: 0;\n      background: transparent;\n      color: var(--affine-icon-color);\n      font-size: var(--affine-font-sm);\n      font-family: inherit;\n      text-align: center;\n    }\n    .block-caption-editor::placeholder {\n      color: var(--affine-placeholder-color);\n    }\n  `;\n\n  private _focus = false;\n\n  @property({ attribute: false })\n  accessor block!: BlockElement<Model> & { isInSurface?: boolean };\n\n  @state()\n  accessor display = false;\n\n  @state()\n  accessor caption: string | null | undefined = undefined;\n\n  @query('.block-caption-editor')\n  accessor input!: HTMLInputElement;\n\n  private _onInputChange(e: InputEvent) {\n    const target = e.target as HTMLInputElement;\n    this.caption = target.value;\n    this.block.doc.updateBlock(this.block.model, {\n      caption: this.caption,\n    });\n  }\n\n  private _onInputFocus() {\n    this._focus = true;\n  }\n\n  private _onInputBlur() {\n    this._focus = false;\n    this.display = !!this.caption?.length;\n  }\n\n  private _onCaptionKeydown(event: KeyboardEvent) {\n    event.stopPropagation();\n\n    if (this.block.isInSurface || event.isComposing) {\n      return;\n    }\n\n    if (event.key === 'Enter') {\n      event.preventDefault();\n      const doc = this.block.doc;\n      const target = event.target as HTMLInputElement;\n      const start = target.selectionStart;\n      if (start === null) {\n        return;\n      }\n\n      const model = this.block.model;\n      const parent = doc.getParent(model);\n      if (!parent) {\n        return;\n      }\n\n      const value = target.value;\n      const caption = value.slice(0, start);\n      doc.updateBlock(model, { caption });\n\n      const nextBlockText = value.slice(start);\n      const index = parent.children.indexOf(model);\n      const id = doc.addBlock(\n        'affine:paragraph',\n        { text: new Text(nextBlockText) },\n        parent,\n        index + 1\n      );\n\n      asyncFocusRichText(this.block.host, id)?.catch(console.error);\n    }\n  }\n\n  show = () => {\n    this.display = true;\n    this.updateComplete.then(() => this.input.focus()).catch(console.error);\n  };\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    this.caption = this.block.model.caption;\n\n    this.disposables.add(\n      this.block.model.propsUpdated.on(({ key }) => {\n        if (key === 'caption') {\n          this.caption = this.block.model.caption;\n          if (!this._focus) {\n            this.display = !!this.caption?.length;\n          }\n        }\n      })\n    );\n  }\n\n  override render() {\n    if (!this.display && !this.caption) {\n      return nothing;\n    }\n\n    return html`<textarea\n      .disabled=${this.block.doc.readonly}\n      placeholder=\"Write a caption\"\n      class=\"block-caption-editor\"\n      .value=${this.caption ?? ''}\n      @input=${this._onInputChange}\n      @focus=${this._onInputFocus}\n      @blur=${this._onInputBlur}\n      @pointerdown=${stopPropagation}\n      @click=${stopPropagation}\n      @dblclick=${stopPropagation}\n      @cut=${stopPropagation}\n      @copy=${stopPropagation}\n      @paste=${stopPropagation}\n      @keydown=${this._onCaptionKeydown}\n      @keyup=${stopPropagation}\n    ></textarea>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'block-caption-editor': BlockCaptionEditor;\n  }\n}\n"]}