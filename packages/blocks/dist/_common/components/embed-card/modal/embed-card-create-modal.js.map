{"version":3,"file":"embed-card-create-modal.js","sourceRoot":"","sources":["../../../../../src/_common/components/embed-card/modal/embed-card-create-modal.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport type { BlockModel } from '@blocksuite/store';\nimport { html } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\n\nimport type { EdgelessRootBlockComponent } from '../../../../root-block/edgeless/edgeless-root-block.js';\nimport { Bound } from '../../../../surface-block/utils/bound.js';\nimport { Vec } from '../../../../surface-block/utils/vec.js';\nimport { EMBED_CARD_HEIGHT, EMBED_CARD_WIDTH } from '../../../consts.js';\nimport type { EmbedCardStyle } from '../../../types.js';\nimport { getRootByEditorHost } from '../../../utils/query.js';\nimport { isValidUrl } from '../../../utils/url.js';\nimport { toast } from '../../toast.js';\nimport { embedCardModalStyles } from './styles.js';\n\n@customElement('embed-card-create-modal')\nexport class EmbedCardCreateModal extends WithDisposable(ShadowlessElement) {\n  static override styles = embedCardModalStyles;\n\n  @state()\n  private accessor _linkInputValue = '';\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor titleText!: string;\n\n  @property({ attribute: false })\n  accessor descriptionText!: string;\n\n  @property({ attribute: false })\n  accessor createOptions!:\n    | {\n        mode: 'page';\n        parentModel: BlockModel | string;\n        index?: number;\n      }\n    | {\n        mode: 'edgeless';\n      };\n\n  @property({ attribute: false })\n  accessor onConfirm!: () => void;\n\n  @query('input')\n  accessor input!: HTMLInputElement;\n\n  private _handleInput(e: InputEvent) {\n    const target = e.target as HTMLInputElement;\n    this._linkInputValue = target.value;\n  }\n\n  private _onDocumentKeydown = (e: KeyboardEvent) => {\n    e.stopPropagation();\n    if (e.key === 'Enter' && !e.isComposing) {\n      this._onConfirm();\n    }\n    if (e.key === 'Escape') {\n      this.remove();\n    }\n  };\n\n  private _onConfirm = () => {\n    const url = this.input.value;\n\n    if (!isValidUrl(url)) {\n      toast(this.host, 'Invalid link');\n      return;\n    }\n\n    const rootService = this.host.spec.getService('affine:page');\n\n    const embedOptions = rootService.getEmbedBlockOptions(url);\n\n    const { mode } = this.createOptions;\n    if (mode === 'page') {\n      const { parentModel, index } = this.createOptions;\n      let flavour = 'affine:bookmark';\n\n      if (embedOptions) {\n        flavour = embedOptions.flavour;\n      }\n\n      this.host.doc.addBlock(\n        flavour as never,\n        {\n          url,\n        },\n        parentModel,\n        index\n      );\n    } else if (mode === 'edgeless') {\n      let flavour = 'affine:bookmark',\n        targetStyle: EmbedCardStyle = 'vertical';\n\n      if (embedOptions) {\n        flavour = embedOptions.flavour;\n        targetStyle = embedOptions.styles[0];\n      }\n\n      const edgelessRoot = getRootByEditorHost(\n        this.host\n      ) as EdgelessRootBlockComponent | null;\n      assertExists(edgelessRoot);\n\n      const surface = edgelessRoot.surface;\n      const center = Vec.toVec(surface.renderer.center);\n      edgelessRoot.service.addBlock(\n        flavour,\n        {\n          url,\n          xywh: Bound.fromCenter(\n            center,\n            EMBED_CARD_WIDTH[targetStyle],\n            EMBED_CARD_HEIGHT[targetStyle]\n          ).serialize(),\n          style: targetStyle,\n        },\n        surface.model\n      );\n\n      edgelessRoot.tools.setEdgelessTool({\n        type: 'default',\n      });\n    }\n    this.onConfirm();\n    this.remove();\n  };\n\n  private _onCancel = () => {\n    this.remove();\n  };\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.updateComplete\n      .then(() => {\n        requestAnimationFrame(() => {\n          this.input.focus();\n        });\n      })\n      .catch(console.error);\n    this.disposables.addFromEvent(this, 'keydown', this._onDocumentKeydown);\n  }\n\n  override render() {\n    return html`<div class=\"embed-card-modal\">\n      <div class=\"embed-card-modal-mask\" @click=${this._onCancel}></div>\n      <div class=\"embed-card-modal-wrapper\">\n        <div class=\"embed-card-modal-title\">${this.titleText}</div>\n\n        <div class=\"embed-card-modal-content\">\n          <div class=\"embed-card-modal-content-text\">\n            ${this.descriptionText}\n          </div>\n\n          <input\n            class=\"embed-card-modal-input link\"\n            tabindex=\"0\"\n            type=\"text\"\n            placeholder=\"Input in https://...\"\n            value=${this._linkInputValue}\n            @input=${this._handleInput}\n          />\n        </div>\n\n        <div class=\"embed-card-modal-action\">\n          <div\n            class=\"embed-card-modal-button cancel\"\n            tabindex=\"0\"\n            @click=${() => this.remove()}\n          >\n            Cancel\n          </div>\n\n          <div\n            class=${classMap({\n              'embed-card-modal-button': true,\n              confirm: true,\n              disabled: !isValidUrl(this._linkInputValue),\n            })}\n            tabindex=\"0\"\n            @click=${this._onConfirm}\n          >\n            Confirm\n          </div>\n        </div>\n      </div>\n    </div>`;\n  }\n}\n\nexport async function toggleEmbedCardCreateModal(\n  host: EditorHost,\n  titleText: string,\n  descriptionText: string,\n  createOptions:\n    | {\n        mode: 'page';\n        parentModel: BlockModel | string;\n        index?: number;\n      }\n    | {\n        mode: 'edgeless';\n      }\n): Promise<void> {\n  host.selection.clear();\n\n  const embedCardCreateModal = new EmbedCardCreateModal();\n  embedCardCreateModal.host = host;\n  embedCardCreateModal.titleText = titleText;\n  embedCardCreateModal.descriptionText = descriptionText;\n  embedCardCreateModal.createOptions = createOptions;\n\n  document.body.append(embedCardCreateModal);\n\n  return new Promise(resolve => {\n    embedCardCreateModal.onConfirm = () => resolve();\n  });\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'embed-card-create-modal': EmbedCardCreateModal;\n  }\n}\n"]}