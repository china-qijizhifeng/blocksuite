{"version":3,"file":"attachment-block.js","sourceRoot":"","sources":["../../src/attachment-block/attachment-block.ts"],"names":[],"mappings":"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","sourcesContent":["import { flip, offset } from '@floating-ui/dom';\nimport { html, nothing } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { ref } from 'lit/directives/ref.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport {\n  BlockComponent,\n  HoverController,\n} from '../_common/components/index.js';\nimport { EMBED_CARD_HEIGHT, EMBED_CARD_WIDTH } from '../_common/consts.js';\nimport {\n  AttachmentIcon16,\n  getAttachmentFileIcons,\n} from '../_common/icons/index.js';\nimport { ThemeObserver } from '../_common/theme/theme-observer.js';\nimport { humanFileSize } from '../_common/utils/math.js';\nimport { getEmbedCardIcons } from '../_common/utils/url.js';\nimport { Bound } from '../surface-block/utils/bound.js';\nimport {\n  type AttachmentBlockModel,\n  AttachmentBlockStyles,\n} from './attachment-model.js';\nimport type { AttachmentBlockService } from './attachment-service.js';\nimport { AttachmentOptionsTemplate } from './components/options.js';\nimport { renderEmbedView } from './embed.js';\nimport { styles } from './styles.js';\nimport { checkAttachmentBlob, downloadAttachmentBlob } from './utils.js';\n\n@customElement('affine-attachment')\nexport class AttachmentBlockComponent extends BlockComponent<\n  AttachmentBlockModel,\n  AttachmentBlockService\n> {\n  get isInSurface() {\n    return this._isInSurface;\n  }\n\n  get edgeless() {\n    if (!this._isInSurface) {\n      return null;\n    }\n    return this.host.querySelector('affine-edgeless-root');\n  }\n\n  private get _embedView() {\n    if (this.isInSurface || !this.model.embed || !this.blobUrl) return;\n    return renderEmbedView(this.model, this.blobUrl, this.service.maxFileSize);\n  }\n\n  static override styles = styles;\n\n  @state()\n  private accessor _showOverlay = true;\n\n  private _isSelected = false;\n\n  private _isDragging = false;\n\n  private _isResizing = false;\n\n  private readonly _themeObserver = new ThemeObserver();\n\n  private _isInSurface = false;\n\n  private _whenHover = new HoverController(this, ({ abortController }) => {\n    const selection = this.host.selection;\n    const textSelection = selection.find('text');\n    if (\n      !!textSelection &&\n      (!!textSelection.to || !!textSelection.from.length)\n    ) {\n      return null;\n    }\n\n    const blockSelections = selection.filter('block');\n    if (\n      blockSelections.length > 1 ||\n      (blockSelections.length === 1 &&\n        blockSelections[0].blockId !== this.blockId)\n    ) {\n      return null;\n    }\n\n    return {\n      template: AttachmentOptionsTemplate({\n        anchor: this,\n        model: this.model,\n        showCaption: () => this.captionEditor.show(),\n        downloadAttachment: this.download,\n        abortController,\n      }),\n      computePosition: {\n        referenceElement: this,\n        placement: 'top-start',\n        middleware: [flip(), offset(4)],\n        autoUpdate: true,\n      },\n    };\n  });\n\n  override accessor useCaptionEditor = true;\n\n  @property({ attribute: false })\n  accessor loading = false;\n\n  @property({ attribute: false })\n  accessor error = false;\n\n  @property({ attribute: false })\n  accessor downloading = false;\n\n  @property({ attribute: false })\n  accessor blobUrl: string | undefined = undefined;\n\n  @property({ attribute: false })\n  accessor allowEmbed = false;\n\n  private _selectBlock() {\n    const selectionManager = this.host.selection;\n    const blockSelection = selectionManager.create('block', {\n      blockId: this.blockId,\n    });\n    selectionManager.setGroup('note', [blockSelection]);\n  }\n\n  private _handleClick(event: MouseEvent) {\n    event.stopPropagation();\n    if (!this.isInSurface) {\n      this._selectBlock();\n    }\n  }\n\n  private _handleDoubleClick(event: MouseEvent) {\n    event.stopPropagation();\n    if (this.allowEmbed) {\n      this.open();\n    } else {\n      this.download();\n    }\n  }\n\n  open = () => {\n    if (!this.blobUrl) {\n      return;\n    }\n    window.open(this.blobUrl, '_blank');\n  };\n\n  download = () => {\n    downloadAttachmentBlob(this);\n  };\n\n  refreshData = () => {\n    checkAttachmentBlob(this).catch(console.error);\n  };\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.refreshData();\n\n    this.contentEditable = 'false';\n\n    const parent = this.host.doc.getParent(this.model);\n    this._isInSurface = parent?.flavour === 'affine:surface';\n\n    if (!this.model.style) {\n      this.doc.withoutTransact(() => {\n        this.doc.updateBlock(this.model, {\n          style: AttachmentBlockStyles[1],\n        });\n      });\n    }\n\n    this.model.propsUpdated.on(({ key }) => {\n      if (key === 'sourceId') {\n        // Reset the blob url when the sourceId is changed\n        if (this.blobUrl) {\n          URL.revokeObjectURL(this.blobUrl);\n          this.blobUrl = undefined;\n        }\n        this.refreshData();\n      }\n    });\n\n    // Workaround for https://github.com/toeverything/blocksuite/issues/4724\n    this._themeObserver.observe(document.documentElement);\n    this._themeObserver.on(() => this.requestUpdate());\n    this.disposables.add(() => this._themeObserver.dispose());\n\n    // this is required to prevent iframe from capturing pointer events\n    this.disposables.add(\n      this.std.selection.slots.changed.on(() => {\n        this._isSelected =\n          !!this.selected?.is('block') || !!this.selected?.is('surface');\n\n        this._showOverlay =\n          this._isResizing || this._isDragging || !this._isSelected;\n      })\n    );\n    // this is required to prevent iframe from capturing pointer events\n    this.handleEvent('pointerMove', ctx => {\n      this._isDragging = ctx.get('pointerState').dragging;\n      this._showOverlay =\n        this._isResizing || this._isDragging || !this._isSelected;\n    });\n\n    if (this.isInSurface) {\n      this.edgeless?.slots.elementResizeStart.on(() => {\n        this._isResizing = true;\n        this._showOverlay = true;\n      });\n\n      this.edgeless?.slots.elementResizeEnd.on(() => {\n        this._isResizing = false;\n        this._showOverlay =\n          this._isResizing || this._isDragging || !this._isSelected;\n      });\n    }\n  }\n\n  override disconnectedCallback() {\n    if (this.blobUrl) {\n      URL.revokeObjectURL(this.blobUrl);\n    }\n    super.disconnectedCallback();\n  }\n\n  override renderBlock() {\n    const { name, size, style } = this.model;\n    const cardStyle = style ?? AttachmentBlockStyles[1];\n\n    const { LoadingIcon } = getEmbedCardIcons();\n\n    const titleIcon = this.loading ? LoadingIcon : AttachmentIcon16;\n    const titleText = this.loading ? 'Loading...' : name;\n    const infoText = this.error ? 'File loading failed.' : humanFileSize(size);\n\n    const fileType = name.split('.').pop() ?? '';\n    const FileTypeIcon = getAttachmentFileIcons(fileType);\n\n    let containerStyleMap = styleMap({\n      position: 'relative',\n      width: '100%',\n      margin: '18px 0px',\n    });\n    if (this.isInSurface) {\n      const width = EMBED_CARD_WIDTH[cardStyle];\n      const height = EMBED_CARD_HEIGHT[cardStyle];\n      const bound = Bound.deserialize(\n        (this.edgeless?.service.getElementById(this.model.id) ?? this.model)\n          .xywh\n      );\n      const scaleX = bound.w / width;\n      const scaleY = bound.h / height;\n      containerStyleMap = styleMap({\n        width: `${width}px`,\n        height: `${height}px`,\n        transform: `scale(${scaleX}, ${scaleY})`,\n        transformOrigin: '0 0',\n      });\n    }\n\n    const embedView = this._embedView;\n\n    return html`\n      <div\n        ${this.isInSurface ? nothing : ref(this._whenHover.setReference)}\n        class=\"affine-attachment-container\"\n        style=${containerStyleMap}\n      >\n        ${embedView\n          ? html`<div\n              class=\"affine-attachment-embed-container\"\n              @click=${this._handleClick}\n              @dblclick=${this._handleDoubleClick}\n            >\n              ${embedView}\n\n              <div\n                class=${classMap({\n                  'affine-attachment-iframe-overlay': true,\n                  hide: !this._showOverlay,\n                })}\n              ></div>\n            </div>`\n          : html`<div\n              class=${classMap({\n                'affine-attachment-card': true,\n                [cardStyle]: true,\n                loading: this.loading,\n                error: this.error,\n                unsynced: false,\n              })}\n              @click=${this._handleClick}\n              @dblclick=${this._handleDoubleClick}\n            >\n              <div class=\"affine-attachment-content\">\n                <div class=\"affine-attachment-content-title\">\n                  <div class=\"affine-attachment-content-title-icon\">\n                    ${titleIcon}\n                  </div>\n\n                  <div class=\"affine-attachment-content-title-text\">\n                    ${titleText}\n                  </div>\n                </div>\n\n                <div class=\"affine-attachment-content-info\">${infoText}</div>\n              </div>\n\n              <div class=\"affine-attachment-banner\">${FileTypeIcon}</div>\n            </div>`}\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-attachment': AttachmentBlockComponent;\n  }\n}\n"]}